# 6碼郵遞區號資料庫實施計畫

## 目標

為現有系統新增6碼郵遞區號驗證功能，透過建立新的 `ZIPCODE6` 資料表，支援使用者輸入6碼郵遞區號時的驗證與自動帶出縣市區名稱。

---

## 一、現況分析

### 1.1 現有架構

```
┌─────────────────────────────────────────────────────────────┐
│  Frontend (New.cshtml / Edit1.cshtml)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ #ADDR_CODE (input) → blur事件 → doADDRNameGet()     │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ AJAX POST /Ajax/GetCityTown                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  Backend (AJAXController.cs)                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ GetCityTown(string CODE)                             │   │
│  │   → MyKeyMapDAO.GetCityTownName(CODE)                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  Database (SQL Server)                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ZIPCODE 表 (僅含5碼資料)                              │   │
│  │ - ZIP_CO (NVARCHAR(5)) ← 目前只有5碼                  │   │
│  │ - CITYNM (縣市)                                       │   │
│  │ - TOWNNM (鄉鎮市區)                                   │   │
│  │ - ROADNM (路段)                                       │   │
│  │ - ROUND (範圍)                                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 問題根因

- 使用者輸入6碼郵遞區號 (如 `115204`)
- `GetCityTownName()` 查詢 `WHERE ZIP_CO = '115204'`
- ZIPCODE 表內只有5碼資料，查詢回傳 `null`
- 前端顯示「查無該郵遞區號」錯誤

---

## 二、解決方案設計

### 2.1 方案選擇：新增 ZIPCODE6 資料表

**優點**：
- ✅ 不影響現有5碼驗證功能
- ✅ 向下相容，5碼/6碼都能正常運作
- ✅ 資料獨立管理，易於維護更新
- ✅ 可獨立備份與還原
- ✅ Production部署風險低

**設計原則**：
- 新表 `ZIPCODE6` 專門存放6碼郵遞區號
- 修改 `GetCityTownName()` 根據輸入長度選擇查詢來源
- 保留原 `ZIPCODE` 表不做任何修改

### 2.2 新表結構設計

```sql
CREATE TABLE ZIPCODE6 (
    ZIP_CO      NVARCHAR(6)   NOT NULL,  -- 6碼郵遞區號 (Primary Key)
    ZIP3        NVARCHAR(3)   NOT NULL,  -- 3碼郵遞區號 (對應舊制)
    CITYNM      NVARCHAR(20)  NOT NULL,  -- 縣市名稱
    TOWNNM      NVARCHAR(20)  NOT NULL,  -- 鄉鎮市區名稱
    ROADNM      NVARCHAR(100) NULL,      -- 範例路名 (選填)
    CREATE_DT   DATETIME      NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UPDATE_DT   DATETIME      NULL,      -- 更新時間
    CONSTRAINT PK_ZIPCODE6 PRIMARY KEY (ZIP_CO)
);

-- 建立索引加速查詢
CREATE INDEX IX_ZIPCODE6_ZIP3 ON ZIPCODE6(ZIP3);
CREATE INDEX IX_ZIPCODE6_CITYNM ON ZIPCODE6(CITYNM);
```

### 2.3 資料來源

中華郵政 3+3 郵遞區號簿（2024年5月版）：
- **來源檔案**: 
  - `3+3郵遞區號簿_2504A.xls` (65,534 筆)
  - `3+3郵遞區號簿_2504B.xls` (14,327 筆)
- **記錄總數**: 79,861 筆 (1:N 關係，同一郵遞區號對應多個地址)
- **唯一6碼數量**: 約 12,982 筆
- **SQL 匯入腳本**: `insert_zipcode6_full.sql`

---

## 三、環境與部署策略

### 3.1 環境分層

```
┌─────────────────────────────────────────────────────────────┐
│  1. DEV (Docker 本機開發環境)                                │
│     └─ 用於開發測試，可隨意重建                              │
├─────────────────────────────────────────────────────────────┤
│  2. STAGING (模擬正式環境)                                   │
│     └─ 驗證 Migration Script，模擬正式部署流程               │
├─────────────────────────────────────────────────────────────┤
│  3. PRODUCTION (正式環境)                                    │
│     └─ 需經過完整測試後才能部署                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 部署流程

```
Phase 1: DEV 開發驗證
    │
    ├─ 1.1 建立 ZIPCODE6 表
    ├─ 1.2 匯入測試資料
    ├─ 1.3 修改 DAO 查詢邏輯
    ├─ 1.4 功能測試
    │
    ▼
Phase 2: STAGING 模擬部署
    │
    ├─ 2.1 備份現有資料庫
    ├─ 2.2 執行 Migration Script
    ├─ 2.3 驗證資料完整性
    ├─ 2.4 執行回歸測試
    ├─ 2.5 驗證 Rollback 程序
    │
    ▼
Phase 3: PRODUCTION 正式部署
    │
    ├─ 3.1 排定維護時段
    ├─ 3.2 完整備份
    ├─ 3.3 執行 Migration Script
    ├─ 3.4 驗證並監控
    └─ 3.5 保留 Rollback 能力 (72小時)
```

---

## 四、實施步驟

### Phase 1: DEV 開發驗證

#### 步驟 1.1: 建立 ZIPCODE6 資料表

```sql
-- 檔案: scripts/migration/001_create_zipcode6_table.sql

USE eservice_new;
GO

-- 檢查表是否已存在
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ZIPCODE6')
BEGIN
    CREATE TABLE ZIPCODE6 (
        ZIP_CO      NVARCHAR(6)   NOT NULL,
        ZIP3        NVARCHAR(3)   NOT NULL,
        CITYNM      NVARCHAR(20)  NOT NULL,
        TOWNNM      NVARCHAR(20)  NOT NULL,
        ROADNM      NVARCHAR(100) NULL,
        CREATE_DT   DATETIME      NOT NULL DEFAULT GETDATE(),
        UPDATE_DT   DATETIME      NULL,
        CONSTRAINT PK_ZIPCODE6 PRIMARY KEY (ZIP_CO)
    );

    CREATE INDEX IX_ZIPCODE6_ZIP3 ON ZIPCODE6(ZIP3);
    CREATE INDEX IX_ZIPCODE6_CITYNM ON ZIPCODE6(CITYNM);

    PRINT 'Table ZIPCODE6 created successfully';
END
ELSE
BEGIN
    PRINT 'Table ZIPCODE6 already exists';
END
GO
```

#### 步驟 1.2: 從 DBF 匯入資料到 SQL Server

**方法 A: 使用 Python 腳本直接匯入**

```python
# 檔案: scripts/migration/import_zipcode6.py

import pyodbc
from dbfread import DBF

# SQL Server 連線設定
conn_str = (
    "DRIVER={ODBC Driver 17 for SQL Server};"
    "SERVER=localhost,1433;"
    "DATABASE=eservice_new;"
    "UID=sa;"
    "PWD=YourPassword;"
)

# 讀取 DBF 檔案
dbf_path = "documents/Zip33U/DBF/rall1.dbf"
table = DBF(dbf_path, encoding='cp950', char_decode_errors='ignore')

# 收集唯一的6碼郵遞區號
postal_codes = {}
for record in table:
    zipcode = record.get('ZIPCODE', '')
    if zipcode and len(str(zipcode)) == 6 and zipcode not in postal_codes:
        postal_codes[zipcode] = {
            'ZIP_CO': zipcode,
            'ZIP3': record.get('ZIP3A', ''),
            'CITYNM': record.get('CITY', ''),
            'TOWNNM': record.get('AREA', ''),
            'ROADNM': record.get('ROAD', '')
        }

# 匯入 SQL Server
conn = pyodbc.connect(conn_str)
cursor = conn.cursor()

insert_sql = """
    INSERT INTO ZIPCODE6 (ZIP_CO, ZIP3, CITYNM, TOWNNM, ROADNM)
    VALUES (?, ?, ?, ?, ?)
"""

for code, data in postal_codes.items():
    cursor.execute(insert_sql, (
        data['ZIP_CO'],
        data['ZIP3'],
        data['CITYNM'],
        data['TOWNNM'],
        data['ROADNM']
    ))

conn.commit()
cursor.close()
conn.close()

print(f"Imported {len(postal_codes)} records")
```

**方法 B: 使用 SQL Server BULK INSERT (從 CSV)**

```sql
-- 先將 Excel 轉換為 CSV，然後使用 BULK INSERT
BULK INSERT ZIPCODE6
FROM 'C:\path\to\zipcode6_data.csv'
WITH (
    FIRSTROW = 2,
    FIELDTERMINATOR = ',',
    ROWTERMINATOR = '\n',
    CODEPAGE = '65001',  -- UTF-8
    TABLOCK
);
```

#### 步驟 1.3: 修改 DAO 查詢邏輯

```csharp
// 檔案: ES/DataLayers/MyKeyMapDAO.cs
// 修改 GetCityTownName 方法

public KeyMapModel GetCityTownName(string CODE)
{
    KeyMapModel result = null;
    var parameters = new DynamicParameters();
    string _sql;

    if (!string.IsNullOrEmpty(CODE))
    {
        // 根據輸入長度選擇查詢來源
        if (CODE.Length == 6)
        {
            // 6碼：查詢 ZIPCODE6 表
            _sql = @"SELECT ZIP_CO AS CODE, (CITYNM + TOWNNM) AS TEXT
                     FROM ZIPCODE6
                     WHERE ZIP_CO = @ZIP_CO";
        }
        else
        {
            // 5碼或其他：查詢原 ZIPCODE 表
            _sql = @"SELECT ZIP_CO AS CODE, (CITYNM + TOWNNM) AS TEXT
                     FROM ZIPCODE
                     WHERE ZIP_CO = @ZIP_CO";
        }

        parameters.Add("ZIP_CO", CODE);

        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();
            result = conn.Query<KeyMapModel>(_sql, parameters).FirstOrDefault();
        }
    }

    return result;
}
```

#### 步驟 1.4: 新增 Entity 類別

```csharp
// 檔案: ES/Models/Entities/ZIPCODE6.cs

using System;
using System.ComponentModel.DataAnnotations;

namespace ES.Models.Entities
{
    /// <summary>
    /// 6碼郵遞區號
    /// </summary>
    public class TblZIPCODE6
    {
        /// <summary>
        /// 6碼郵遞區號
        /// </summary>
        [Key]
        [StringLength(6)]
        public string ZIP_CO { get; set; }

        /// <summary>
        /// 3碼郵遞區號
        /// </summary>
        [StringLength(3)]
        public string ZIP3 { get; set; }

        /// <summary>
        /// 縣市
        /// </summary>
        [StringLength(20)]
        public string CITYNM { get; set; }

        /// <summary>
        /// 鄉鎮市區
        /// </summary>
        [StringLength(20)]
        public string TOWNNM { get; set; }

        /// <summary>
        /// 範例路名
        /// </summary>
        [StringLength(100)]
        public string ROADNM { get; set; }

        /// <summary>
        /// 建立時間
        /// </summary>
        public DateTime CREATE_DT { get; set; }

        /// <summary>
        /// 更新時間
        /// </summary>
        public DateTime? UPDATE_DT { get; set; }
    }
}
```

### Phase 2: STAGING 模擬部署

#### 步驟 2.1: 建立完整 Migration Script

```sql
-- 檔案: scripts/migration/ZIPCODE6_Migration_Full.sql
-- 適用於 STAGING 和 PRODUCTION 環境

/*
=====================================================
  ZIPCODE6 資料表 Migration Script
  版本: 1.0
  日期: 2024-12-04
  說明: 新增6碼郵遞區號驗證資料表
=====================================================
*/

SET NOCOUNT ON;
SET XACT_ABORT ON;

BEGIN TRY
    BEGIN TRANSACTION;

    PRINT '========================================';
    PRINT 'Starting ZIPCODE6 Migration';
    PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
    PRINT '========================================';

    -- Step 1: 檢查並建立資料表
    IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ZIPCODE6')
    BEGIN
        PRINT 'Creating ZIPCODE6 table...';

        CREATE TABLE ZIPCODE6 (
            ZIP_CO      NVARCHAR(6)   NOT NULL,
            ZIP3        NVARCHAR(3)   NOT NULL,
            CITYNM      NVARCHAR(20)  NOT NULL,
            TOWNNM      NVARCHAR(20)  NOT NULL,
            ROADNM      NVARCHAR(100) NULL,
            CREATE_DT   DATETIME      NOT NULL DEFAULT GETDATE(),
            UPDATE_DT   DATETIME      NULL,
            CONSTRAINT PK_ZIPCODE6 PRIMARY KEY (ZIP_CO)
        );

        CREATE INDEX IX_ZIPCODE6_ZIP3 ON ZIPCODE6(ZIP3);
        CREATE INDEX IX_ZIPCODE6_CITYNM ON ZIPCODE6(CITYNM);

        PRINT 'ZIPCODE6 table created successfully';
    END
    ELSE
    BEGIN
        PRINT 'ZIPCODE6 table already exists - skipping creation';
    END

    -- Step 2: 記錄 Migration 資訊
    IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'DB_MIGRATION_LOG')
    BEGIN
        CREATE TABLE DB_MIGRATION_LOG (
            ID INT IDENTITY(1,1) PRIMARY KEY,
            MIGRATION_NAME NVARCHAR(100) NOT NULL,
            APPLIED_DT DATETIME NOT NULL DEFAULT GETDATE(),
            DESCRIPTION NVARCHAR(500) NULL
        );
    END

    INSERT INTO DB_MIGRATION_LOG (MIGRATION_NAME, DESCRIPTION)
    VALUES ('ZIPCODE6_V1.0', '新增6碼郵遞區號驗證資料表');

    COMMIT TRANSACTION;

    PRINT '========================================';
    PRINT 'Migration completed successfully';
    PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
    PRINT '========================================';

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;

    PRINT '========================================';
    PRINT 'Migration FAILED!';
    PRINT 'Error: ' + ERROR_MESSAGE();
    PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
    PRINT '========================================';

    THROW;
END CATCH
GO
```

#### 步驟 2.2: Rollback Script

```sql
-- 檔案: scripts/migration/ZIPCODE6_Rollback.sql
-- 緊急回滾用

/*
=====================================================
  ZIPCODE6 Rollback Script
  警告: 此腳本會刪除 ZIPCODE6 資料表及其所有資料
=====================================================
*/

SET NOCOUNT ON;

PRINT '========================================';
PRINT 'Starting ZIPCODE6 Rollback';
PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '========================================';

-- 刪除索引
IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_ZIPCODE6_ZIP3')
    DROP INDEX IX_ZIPCODE6_ZIP3 ON ZIPCODE6;

IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_ZIPCODE6_CITYNM')
    DROP INDEX IX_ZIPCODE6_CITYNM ON ZIPCODE6;

-- 刪除資料表
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'ZIPCODE6')
BEGIN
    -- 先備份資料 (如果需要)
    -- SELECT * INTO ZIPCODE6_BACKUP_ROLLBACK FROM ZIPCODE6;

    DROP TABLE ZIPCODE6;
    PRINT 'ZIPCODE6 table dropped';
END

-- 記錄 Rollback
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'DB_MIGRATION_LOG')
BEGIN
    INSERT INTO DB_MIGRATION_LOG (MIGRATION_NAME, DESCRIPTION)
    VALUES ('ZIPCODE6_ROLLBACK', 'Rolled back ZIPCODE6 migration');
END

PRINT '========================================';
PRINT 'Rollback completed';
PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '========================================';
GO
```

#### 步驟 2.3: 驗證腳本

```sql
-- 檔案: scripts/migration/ZIPCODE6_Verify.sql

PRINT '========================================';
PRINT 'ZIPCODE6 Verification Report';
PRINT '========================================';

-- 1. 檢查表是否存在
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'ZIPCODE6')
    PRINT '✓ Table ZIPCODE6 exists'
ELSE
    PRINT '✗ Table ZIPCODE6 NOT FOUND';

-- 2. 檢查記錄數量
DECLARE @count INT;
SELECT @count = COUNT(*) FROM ZIPCODE6;
PRINT '✓ Total records: ' + CAST(@count AS VARCHAR);

-- 3. 檢查索引
IF EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_ZIPCODE6_ZIP3')
    PRINT '✓ Index IX_ZIPCODE6_ZIP3 exists'
ELSE
    PRINT '✗ Index IX_ZIPCODE6_ZIP3 NOT FOUND';

-- 4. 抽樣驗證資料
PRINT '';
PRINT 'Sample data (first 5 records):';
SELECT TOP 5 ZIP_CO, ZIP3, CITYNM, TOWNNM FROM ZIPCODE6 ORDER BY ZIP_CO;

-- 5. 驗證特定郵遞區號 (衛福部地址)
PRINT '';
PRINT 'Verification: 115204 (衛福部地址)';
SELECT * FROM ZIPCODE6 WHERE ZIP_CO = '115204';

PRINT '========================================';
GO
```

### Phase 3: PRODUCTION 部署

#### 3.1 部署檢查清單

```markdown
## Production 部署檢查清單

### 部署前
- [ ] STAGING 測試全部通過
- [ ] DBA 審核 Migration Script
- [ ] 確認維護時段 (建議: 非營業時間)
- [ ] 通知相關人員
- [ ] 準備 Rollback 計畫

### 備份
- [ ] 完整資料庫備份完成
- [ ] 備份驗證通過 (RESTORE VERIFYONLY)
- [ ] 備份檔案已複製到安全位置

### 執行
- [ ] 執行 Migration Script
- [ ] 驗證表結構正確
- [ ] 匯入資料完成
- [ ] 驗證資料筆數正確 (12,963 筆)
- [ ] 驗證關鍵郵遞區號可查詢

### 部署後
- [ ] 應用程式重新部署 (含 DAO 修改)
- [ ] 功能測試通過
- [ ] 監控錯誤日誌 (24小時)
- [ ] 確認無異常後關閉 Rollback 窗口
```

#### 3.2 Production 備份命令

```sql
-- 部署前執行
BACKUP DATABASE eservice_new
TO DISK = 'D:\Backup\eservice_new_pre_zipcode6_20241204.bak'
WITH FORMAT, INIT,
     NAME = 'Pre-ZIPCODE6 Migration Backup',
     COMPRESSION;

-- 驗證備份
RESTORE VERIFYONLY
FROM DISK = 'D:\Backup\eservice_new_pre_zipcode6_20241204.bak';
```

---

## 五、測試計畫

### 5.1 單元測試案例

| 測試案例 | 輸入 | 預期結果 |
|---------|------|---------|
| TC01 | 5碼: `10001` | 返回「台北市中正區」(從 ZIPCODE 表) |
| TC02 | 6碼: `115204` | 返回「台北市南港區」(從 ZIPCODE6 表) |
| TC03 | 6碼: `100001` | 返回「台北市中正區」(從 ZIPCODE6 表) |
| TC04 | 無效: `99999` | 返回 null |
| TC05 | 無效: `ABC123` | 返回 null |
| TC06 | 空值: `` | 返回 null |

### 5.2 整合測試案例

| 測試案例 | 操作 | 預期結果 |
|---------|------|---------|
| IT01 | 會員註冊填寫6碼郵遞區號 | 自動帶出縣市區名稱，表單可提交 |
| IT02 | 會員資料修改6碼郵遞區號 | 驗證通過，可儲存 |
| IT03 | 使用郵遞區號查詢彈窗 | 可選擇6碼郵遞區號 |

---

## 六、檔案交付清單

```
scripts/
├── migration/
│   ├── 001_create_zipcode6_table.sql    # 建立資料表
│   ├── 002_import_zipcode6_data.py      # Python 匯入腳本
│   ├── ZIPCODE6_Migration_Full.sql      # 完整 Migration
│   ├── ZIPCODE6_Rollback.sql            # Rollback 腳本
│   └── ZIPCODE6_Verify.sql              # 驗證腳本
│
├── data/
│   ├── zipcode6_data.csv                # 6碼郵遞區號資料 (CSV)
│   └── Taiwan_6digit_PostalCodes.xlsx   # 6碼郵遞區號資料 (Excel)
│
└── code-changes/
    ├── ZIPCODE6.cs                      # 新 Entity 類別
    └── MyKeyMapDAO.cs.patch             # DAO 修改差異
```

---

## 七、時程規劃

| 階段 | 任務 | 預計時間 |
|------|------|---------|
| Phase 1 | DEV 開發與測試 | - |
| Phase 2 | STAGING 模擬部署 | - |
| Phase 3 | Production 部署 | - |

> 註：時程由團隊根據實際情況安排

---

## 八、風險評估

| 風險 | 影響程度 | 緩解措施 |
|------|---------|---------|
| 資料匯入失敗 | 中 | 使用交易控制，失敗自動回滾 |
| 查詢效能下降 | 低 | 已建立適當索引 |
| 6碼資料不完整 | 中 | 使用官方 Zip33U 資料來源 |
| 部署時系統中斷 | 低 | 新增表不影響現有功能 |

---

## 九、維護計畫

### 9.1 資料更新

中華郵政每季更新郵遞區號資料，建議：
- 每季檢查 Zip33U 是否有新版本
- 更新流程：下載新版 → 比對差異 → 更新 ZIPCODE6 表

### 9.2 更新腳本範例

```sql
-- 增量更新範例
MERGE INTO ZIPCODE6 AS target
USING (SELECT * FROM #TempNewData) AS source
ON target.ZIP_CO = source.ZIP_CO
WHEN MATCHED THEN
    UPDATE SET
        CITYNM = source.CITYNM,
        TOWNNM = source.TOWNNM,
        ROADNM = source.ROADNM,
        UPDATE_DT = GETDATE()
WHEN NOT MATCHED THEN
    INSERT (ZIP_CO, ZIP3, CITYNM, TOWNNM, ROADNM)
    VALUES (source.ZIP_CO, source.ZIP3, source.CITYNM, source.TOWNNM, source.ROADNM);
```

---

## 附錄 A: 相關文件

- `郵遞區號6碼驗證修復計畫.md` - 問題分析與初步方案
- `Taiwan_6digit_PostalCodes.xlsx` - 6碼郵遞區號資料
- 中華郵政 3+3郵遞區號查詢系統: https://www.post.gov.tw/

---

**文件版本**: 1.0
**建立日期**: 2024-12-04
**維護人員**: Development Team
