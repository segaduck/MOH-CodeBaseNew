<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Commons"
xmlns="http://ibatis.apache.org/mapping"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <resultMaps>
  </resultMaps>

  <cacheModel id="ROW-cache" implementation="MEMORY" >
    <flushInterval hours="1"/>
    <property name="Type" value="WEAK"/>
  </cacheModel>

  <!-- 
  這個檔案專門用來配合 DBAction: getRow(), Insert(), Update(), Delete() 等 api,
  其他 sql statement 不要放到這個檔案中
  -->
  <statements>

    <sql id="whereCond">
      <iterate property="WHERE_LIST" prepend="AND" conjunction="AND">
        $WHERE_LIST[].COLUMN_NAME$ $WHERE_LIST[].OPERATOR$ #WHERE_LIST[].VALUE#
      </iterate>
      <iterate property="RAW_WHERE_LIST" prepend="AND" conjunction="AND">
        $RAW_WHERE_LIST[].COLUMN_NAME$  $RAW_WHERE_LIST[].OPERATOR$  $RAW_WHERE_LIST[].VALUE$
      </iterate>
    </sql>
    

    <select id="getRow"
            parameterClass="Turbo.DataLayer.DBReadModel"
            resultClass="Hashtable"
            cacheModel="EECOnline-cache">
      <![CDATA[
      SELECT * FROM $TABLE_NAME$
      ]]>
      <iterate property="WHERE_LIST" prepend="WHERE" conjunction="AND">
        $WHERE_LIST[].COLUMN_NAME$ = #WHERE_LIST[].VALUE#
      </iterate>
    </select>

    <select id="isTargetTableExistInDB"
           parameterClass="Hashtable"
           resultClass="Hashtable"
           cacheModel="EECOnline-cache">
      <![CDATA[
      SELECT table_name FROM information_schema.tables WHERE  TABLE_NAME = #tableName# + '_LOG'
      ]]>
    </select>

    <select id="isTargetColumnExistInTable"
           parameterClass="Hashtable"
           resultClass="Hashtable"
           cacheModel="EECOnline-cache">
      <![CDATA[
      select name from syscolumns 
      where id=(select id from sysobjects where name=#tableName# + '_LOG') and name=#columnName#
      ]]>
    </select>

    <update id="updateRecord" parameterClass="Turbo.DataLayer.DBUpdateModel">
      <![CDATA[
          UPDATE $TABLE_NAME$
      ]]>

      <iterate property="FIELD_LIST" prepend="SET" conjunction=",">
        $FIELD_LIST[].COLUMN_NAME$ = #FIELD_LIST[].VALUE#
      </iterate>

      <iterate property="WHERE_LIST" prepend="WHERE" conjunction="AND ">
        $WHERE_LIST[].COLUMN_NAME$ = #WHERE_LIST[].VALUE#
      </iterate>
    </update>

   

    <update id="CreateRecord" parameterClass="Turbo.DataLayer.DBUpdateModel">
      <![CDATA[
          CREATE TABLE $TABLE_NAME$
          (
      ]]>

      <iterate property="FIELD_LIST" prepend="" conjunction=",">
        $FIELD_LIST[].COLUMN_NAME$ VARCHAR(MAX)
      </iterate>
      <![CDATA[
          )
      ]]>
    </update>

    <update id="AlterRecord" parameterClass="Turbo.DataLayer.DBUpdateModel">
      <![CDATA[
          ALTER TABLE $TABLE_NAME$
          ADD 
      ]]>

      <iterate property="FIELD_LIST" prepend="" conjunction=",">
        $FIELD_LIST[].COLUMN_NAME$ VARCHAR(MAX)
      </iterate>
    </update>
    
    <!--MSSQL 專用-->
    <insert id="insertRecord" parameterClass="Turbo.DataLayer.DBInsertModel" resultClass="int" >
     
      <![CDATA[ INSERT INTO $TABLE_NAME$ ]]>
      (
      <dynamic prepend="">
        <iterate property="NAME_LIST" open="" close="" conjunction=",">
          $NAME_LIST[]$
        </iterate>
      </dynamic>
      )
      <![CDATA[ VALUES ]]>
      (
      <dynamic prepend="">
        <iterate property="VALUE_LIST" open="" close="" conjunction=",">
          #VALUE_LIST[]#
        </iterate>
      </dynamic>
      )
      <![CDATA[;]]>
      <!-- selectKey 自動編號(不能包在 dynamic 裡面) -->
      <selectKey resultClass="int" type="post" property="SEQUENCE_FIELD_VALUE" >
        <dynamic prepend="">
          <!-- Oracle Sequence 判斷及取值-->
          <isNotEmpty prepend="" property="SEQUENCE_FIELD">
            SELECT @@IDENTITY AS VALUE
          </isNotEmpty>
          <!--
          <isEmpty prepend="" property="SEQUENCE_FIELD">
            SELECT TO_NUMBER(0) AS VALUE FROM DUAL
          </isEmpty>
          -->
        </dynamic>
      </selectKey>
    </insert>

    <!--ORACLE使用-->
    <!--<insert id="insertRecord" parameterClass="Turbo.DataLayer.DBInsertModel" resultClass="int" >
      
      -->
    <!-- selectKey 自動編號(不能包在 dynamic 裡面) -->
    <!--
      <selectKey resultClass="int" type="pre" property="SEQUENCE_FIELD_VALUE" >
        <dynamic prepend="">
          -->
    <!-- Oracle Sequence 判斷及取值-->
    <!--
          <isNotEmpty prepend="" property="SEQUENCE_FIELD">
            SELECT $SEQUENCE_NAME$.NEXTVAL AS VALUE FROM DUAL
          </isNotEmpty>
          -->
    <!--
          <isEmpty prepend="" property="SEQUENCE_FIELD">
            SELECT TO_NUMBER(0) AS VALUE FROM DUAL
          </isEmpty>
          -->
    <!--
        </dynamic>
      </selectKey>
      
      <![CDATA[ INSERT INTO $TABLE_NAME$ ]]>
      (
      -->
    <!-- Oracle Sequence 自動編號欄位判斷-->
    <!--
      <isNotEmpty prepend="" property="SEQUENCE_FIELD">
        $SEQUENCE_FIELD$,
      </isNotEmpty>
      <dynamic prepend="">
        <iterate property="NAME_LIST" open="" close="" conjunction=",">
          $NAME_LIST[]$
        </iterate>
      </dynamic>
      )
      <![CDATA[ VALUES ]]>
      (
      <dynamic prepend="">
        <isNotEmpty prepend="" property="SEQUENCE_FIELD">
          #SEQUENCE_FIELD_VALUE#,
        </isNotEmpty>
        <iterate property="VALUE_LIST" open="" close="" conjunction=",">
          #VALUE_LIST[]#
        </iterate>
      </dynamic>
      )
    </insert>-->

    <delete id="deleteRecord"
      parameterClass="Turbo.DataLayer.DBDeleteModel"
      resultClass="int" >
      <![CDATA[ DELETE FROM $TABLE_NAME$ WHERE ]]>
      <dynamic prepend="">
        <iterate property="WHERE_LIST" prepend="" conjunction="AND ">
          $WHERE_LIST[].COLUMN_NAME$ = #WHERE_LIST[].VALUE#
        </iterate>
      </dynamic>
    </delete>

    <select id="getRowEx"
            parameterClass="Turbo.DataLayer.DBReadModelEx"
            resultClass="Hashtable"
            cacheModel="EECOnline-cache">
      <![CDATA[  SELECT * FROM $TABLE_NAME$ WHERE 1=1  ]]>
      <include refid="whereCond" />
      <iterate property="ORDER_LIST" prepend="ORDER BY" conjunction=",">
        $ORDER_LIST[].COLUMN_NAME$ $ORDER_LIST[].VALUE$
      </iterate>
    </select>


    <select id="getRowCountEx"
        parameterClass="Turbo.DataLayer.DBReadModelEx"
        resultClass="Hashtable"
        cacheModel="EECOnline-cache">
      <![CDATA[
        SELECT count(*) as CNT
        FROM
          (SELECT * FROM $TABLE_NAME$ WHERE 1=1
      ]]>
      <include refid="whereCond" />
      <iterate property="ORDER_LIST" prepend="ORDER BY" conjunction=",">
        $ORDER_LIST[].COLUMN_NAME$ $ORDER_LIST[].VALUE$
      </iterate>
      <![CDATA[
        ) a
      ]]>
    </select>

    <select id="getAggregateEx"
            parameterClass="Turbo.DataLayer.DBReadModelEx"
            resultClass="Hashtable"
            cacheModel="EECOnline-cache">
      <![CDATA[ SELECT ]]>
      <iterate property="AGGREGATE_LIST" prepend="" conjunction=",">
        $AGGREGATE_LIST[].OPERATOR$($AGGREGATE_LIST[].COLUMN_NAME$) as $AGGREGATE_LIST[].VALUE$
      </iterate>
      <![CDATA[ FROM $TABLE_NAME$ WHERE 1=1 ]]>
      <include refid="whereCond" />
    </select>

    <update id="updateRecordEx" parameterClass="Turbo.DataLayer.DBUpdateModelEx">
      <![CDATA[  UPDATE $TABLE_NAME$  ]]>
      <iterate property="SET_LIST" prepend="SET" conjunction=",">
        $SET_LIST[].COLUMN_NAME$ = #SET_LIST[].VALUE#
      </iterate>
      <![CDATA[  WHERE 1=1  ]]>
      <include refid="whereCond"/>
    </update>

    <delete id="deleteRecordEx"
      parameterClass="Turbo.DataLayer.DBReadModelEx"
      resultClass="int" >
      <![CDATA[ DELETE FROM $TABLE_NAME$ WHERE 1=1 ]]>
      <dynamic prepend="">
        <include refid="whereCond" />
      </dynamic>
    </delete>

  </statements>
</sqlMap>
