# 衛生福利部電子化服務平台 (e-service) - 專案高階概述

## 專案概述

衛生福利部電子化服務平台（e-service）是一個全功能的政府線上申辦系統，專門提供衛生福利部各業務司的線上服務申請、案件管理、繳費及證明書核發等功能。系統採用傳統 ASP.NET MVC 架構，提供完整的前台申辦與後台管理功能。

### 系統主要功能

- **會員系統**：支援多元登入方式（帳密、自然人憑證、工商憑證、醫事人員憑證、數位身分證）
- **線上申辦**：提供 **34 種**線上申辦服務，涵蓋醫事司、中醫藥司、社會及家庭署等 9 個業務單位
- **案件管理**：完整的案件審核、派案、查詢及歷程追蹤功能
- **繳費系統**：整合虛擬帳號、超商繳費、信用卡、政府支付平台等多元繳費方式
- **證明書管理**：自動產生 PDF/Word 格式的各類證明書與公文
- **排程系統**：使用 Hangfire 處理背景任務與定時作業
- **後台管理**：提供帳號權限、服務設定、報表統計等管理功能

### 線上申辦服務清單 (34 項)

系統提供 34 種線上申辦服務，涵蓋 9 個業務單位。以下為完整服務清單：

#### 醫事司 (11 項服務)

| 服務代碼 | 服務名稱             | 說明                                     |
| -------- | -------------------- | ---------------------------------------- |
| 001005   | 醫事人員證書補換發   | 醫師、護理師等醫事人員證書補發或換發申請 |
| 001007   | 專科醫師證書補換發   | 專科醫師證書補發或換發申請               |
| 001008   | 醫事人員英文證明書   | 醫事人員資格英文證明書申請               |
| 001009   | 醫事人員資格英文求證 | 外國醫事人員資格英文求證申請             |
| 001010   | 醫事人員證書影本申請 | 醫事人員證書影本核發申請                 |
| 001034   | 藥物樣品贈品申請     | 藥物樣品或贈品進出口申請                 |
| 001035   | 人體器官組織進出口   | 人體器官、組織進出口許可申請             |
| 001036   | 醫療器材查驗登記     | 醫療器材查驗登記申請                     |
| 001037   | 藥品查驗登記         | 藥品查驗登記申請                         |
| 001038   | 管制藥品登記證       | 管制藥品登記證申請                       |
| 001039   | 藥商許可執照變更     | 藥商許可執照變更登記申請                 |

#### 中醫藥司 (7 項服務)

| 服務代碼 | 服務名稱         | 說明                              |
| -------- | ---------------- | --------------------------------- |
| 005001   | 中藥材產銷證明書 | 中藥材產銷證明書申請              |
| 005002   | 中藥 GMP 證明書  | 中藥優良製造規範 (GMP) 證明書申請 |
| 005003   | 中藥製劑查驗登記 | 中藥製劑查驗登記申請              |
| 005004   | 中藥材輸入許可   | 中藥材輸入許可證申請              |
| 005005   | 中藥商許可執照   | 中藥商許可執照申請                |
| 005013   | 中醫診所開業執照 | 中醫診所開業執照申請              |
| 005014   | 中藥材邊境查驗   | 中藥材邊境查驗申請                |

#### 社會及家庭署 (10 項服務)

| 服務代碼 | 服務名稱               | 說明                           |
| -------- | ---------------------- | ------------------------------ |
| 011001   | 身心障礙證明申請       | 身心障礙證明申請或換發         |
| 011002   | 身心障礙停車證         | 身心障礙者專用停車位識別證申請 |
| 011003   | 老人福利機構設立       | 老人福利機構設立許可申請       |
| 011004   | 兒童及少年福利機構設立 | 兒童及少年福利機構設立許可申請 |
| 011005   | 身心障礙福利機構設立   | 身心障礙福利機構設立許可申請   |
| 011006   | 托嬰中心登記           | 托嬰中心登記申請               |
| 011007   | 早期療育服務機構設立   | 早期療育服務機構設立許可申請   |
| 011008   | 家庭暴力防治服務       | 家庭暴力防治服務申請           |
| 011009   | 性侵害防治服務         | 性侵害防治服務申請             |
| 011010   | 兒少保護服務           | 兒童及少年保護服務申請         |

#### 社會保險司 (1 項服務)

| 服務代碼 | 服務名稱                 | 說明                         |
| -------- | ------------------------ | ---------------------------- |
| 006001   | 全民健保特約醫事服務機構 | 全民健保特約醫事服務機構申請 |

#### 綜合規劃司 (1 項服務)

| 服務代碼 | 服務名稱           | 說明                       |
| -------- | ------------------ | -------------------------- |
| 010001   | 衛生福利部補助計畫 | 衛生福利部各項補助計畫申請 |

#### 保護服務司 (1 項服務)

| 服務代碼 | 服務名稱                 | 說明                             |
| -------- | ------------------------ | -------------------------------- |
| 010002   | 家庭暴力及性侵害防治補助 | 家庭暴力及性侵害防治補助計畫申請 |

#### 國民年金監理會 (1 項服務)

| 服務代碼 | 服務名稱             | 說明                     |
| -------- | -------------------- | ------------------------ |
| 012001   | 國民年金保險給付申請 | 國民年金保險各項給付申請 |

#### 法規會 (1 項服務)

| 服務代碼 | 服務名稱     | 說明                     |
| -------- | ------------ | ------------------------ |
| 040001   | 法規諮詢服務 | 衛生福利法規諮詢服務申請 |

#### 中央健康保險署 (1 項服務)

| 服務代碼 | 服務名稱         | 說明                   |
| -------- | ---------------- | ---------------------- |
| 041001   | 健保醫療費用申報 | 健保醫療費用申報及審查 |

### 服務統計摘要

| 業務單位       | 服務數量 | 佔比     |
| -------------- | -------- | -------- |
| 醫事司         | 11       | 32.4%    |
| 中醫藥司       | 7        | 20.6%    |
| 社會及家庭署   | 10       | 29.4%    |
| 社會保險司     | 1        | 2.9%     |
| 綜合規劃司     | 1        | 2.9%     |
| 保護服務司     | 1        | 2.9%     |
| 國民年金監理會 | 1        | 2.9%     |
| 法規會         | 1        | 2.9%     |
| 中央健康保險署 | 1        | 2.9%     |
| **總計**       | **34**   | **100%** |

> 💡 **詳細技術文件**：每個服務的完整技術文件（包含前端、API、後端資料庫處理流程）請參閱 `技術文件/線上申辦服務/` 目錄。

## 專案結構

### 檔案目錄結構

```
ES/
├── Controllers/                      # 前台控制器 (50+ 檔案，含 34 個申辦服務控制器)
│   ├── BaseController.cs            # 需登入驗證的基礎控制器
│   ├── BaseNoMemberController.cs    # 不需登入的基礎控制器
│   ├── HomeController.cs            # 首頁控制器
│   ├── LoginController.cs           # 登入控制器 (2186 行)
│   ├── AJAXController.cs            # AJAX 請求處理 (2802 行)
│   ├── FormController.cs            # 表單處理核心 (2162 行)
│   ├── Apply_005001Controller.cs    # 產銷證明書申辦 (2018 行)
│   ├── Apply_005002Controller.cs    # GMP 證明書申辦 (1309 行)
│   ├── Apply_001008Controller.cs    # 藥商許可執照申辦 (1541 行)
│   ├── MemberController.cs          # 會員管理
│   ├── HistoryController.cs         # 案件歷史查詢
│   ├── PayController.cs             # 繳費相關
│   └── ...                          # 其他業務申辦控制器
├── Areas/                           # MVC Areas 區域
│   ├── BACKMIN/                     # 後台管理系統
│   │   ├── Controllers/             # 後台控制器 (65+ 檔案)
│   │   │   ├── CaseController.cs    # 案件管理核心
│   │   │   ├── ServiceController.cs # 服務項目管理
│   │   │   ├── AccountController.cs # 帳號管理
│   │   │   ├── PayController.cs     # 繳費管理
│   │   │   └── ...
│   │   ├── Views/                   # 後台視圖
│   │   └── Models/                  # 後台模型
│   ├── Resource/                    # 資源管理區域
│   │   └── Controllers/             # DB, File, DT1 資源控制器
│   └── Schedule/                    # 排程任務區域
│       ├── Controllers/             # 排程控制器 (Mdod, ESA PI, Cert, etc.)
│       └── Action/                  # 排程業務邏輯
├── Action/                          # 業務邏輯層
│   ├── BaseAction.cs               # Action 基礎類別
│   ├── MemberAction.cs             # 會員相關業務邏輯
│   ├── FormAction.cs               # 表單處理邏輯
│   ├── HistoryAction.cs            # 歷史記錄邏輯
│   └── Form/                       # 表單相關 Action
├── DataLayers/                      # 資料存取層 (DAO)
│   ├── ApplyDAO.cs                 # 申辦資料存取 (24560 行，最大)
│   ├── BackApplyDAO.cs             # 後台申辦資料 (18648 行)
│   ├── SHAREDAO.cs                 # 共用資料存取 (3108 行)
│   ├── PayDAO.cs                   # 繳費資料存取 (1412 行)
│   ├── WebDAO.cs                   # 網頁資料存取
│   ├── LoginDAO.cs                 # 登入資料存取
│   └── ...
├── Models/                          # 資料模型
│   ├── Entities/                   # 資料庫實體 (150+ 檔案)
│   │   ├── APPLYModel.cs
│   │   ├── MEMBER.cs
│   │   ├── SERVICE.cs
│   │   ├── Apply_005001Model.cs
│   │   └── ...
│   ├── ViewModels/                 # 視圖模型 (54 個申辦服務 ViewModel)
│   ├── SessionModel.cs             # Session 管理
│   ├── LoginUserInfo.cs            # 登入使用者資訊
│   └── MemberModels.cs             # 會員模型
├── Views/                           # Razor 視圖 (50+ 目錄，含 37 個申辦服務視圖)
│   ├── Shared/                     # 共用視圖
│   │   ├── _Layout.cshtml          # 主版面配置
│   │   ├── Error.cshtml            # 錯誤頁面
│   │   └── ...
│   ├── Home/                       # 首頁視圖
│   ├── Login/                      # 登入視圖
│   ├── Apply_005001/               # 產銷證明書視圖
│   └── ...
├── Utils/                           # 工具類別 (18 個檔案)
│   ├── DataUtils.cs                # 資料工具 (564 行)
│   ├── PayUtils.cs                 # 繳費工具 (724 行)
│   ├── ReportUtils.cs              # 報表工具 (865 行)
│   ├── MailUtils.cs                # 郵件工具
│   ├── CodeUtils.cs                # 代碼工具
│   ├── DocumentUtils.cs            # 文件工具
│   ├── LogUtils.cs                 # 日誌工具
│   ├── XMLToDOCUtils.cs            # XML 轉 DOC
│   └── Schedule/                   # 排程工具
├── Commons/                         # 共用元件
│   ├── AjaxResultStruct.cs         # AJAX 回應結構
│   ├── CustomAttribute.cs          # 自訂屬性
│   ├── CustomExceptions.cs         # 自訂例外
│   ├── HelperUtil.cs               # 輔助工具
│   ├── SecurityHelper.cs           # 安全性輔助
│   ├── UploadFile.cs               # 檔案上傳
│   └── ...
├── Helpers/                         # HTML Helpers (26 個檔案)
│   ├── DatePickerExtension.cs
│   ├── FileUploadExtension.cs
│   ├── AddrExtension.cs
│   ├── TelExtension.cs
│   ├── EmailExtension.cs
│   └── ...
├── Services/                        # 服務層
│   └── CommonsServices.cs
├── Extensions/                      # 擴充方法
│   ├── FormExtensions.cs
│   ├── HtmlHelperExtensions.cs
│   ├── ImageResult.cs
│   └── WordConverter.cs
├── Filter/                          # MVC 篩選器
│   ├── CustomAuthorizeAttribute.cs
│   └── CustomHandleErrorAttribute.cs
├── WebService/                      # Web Services
│   ├── FlyPayBasicData.asmx
│   ├── SampleBAS.asmx
│   └── SamplePRODUCT.asmx
├── Scripts/                         # JavaScript 函式庫
│   ├── jquery-3.7.1.js
│   ├── vue.js
│   ├── bootstrap.js
│   ├── HiPKICerts.js               # 憑證元件
│   └── ...
├── js/                              # 自訂 JavaScript
│   ├── components/
│   ├── javascript/
│   └── polyfills/
├── Content/                         # 靜態內容 (CSS, 圖片)
│   ├── bootstrap.css
│   ├── font-awesome.css
│   ├── Site.css
│   └── themes/
├── App_Start/                       # 應用程式啟動配置
│   ├── BundleConfig.cs             # 前端資源打包配置
│   ├── FilterConfig.cs             # 全域篩選器配置
│   ├── RouteConfig.cs              # 路由配置
│   └── WebApiConfig.cs             # Web API 配置
├── Global.asax.cs                   # 應用程式全域事件
├── Startup.cs                       # OWIN 啟動設定 (Hangfire 配置)
├── Web.config                       # 應用程式配置檔
└── packages.config                  # NuGet 套件清單
```

### 重要檔案說明

#### 核心配置文件

- **Web.config**：主要配置檔，包含資料庫連線字串、應用程式設定、Session 配置、安全性設定等
- **Global.asax.cs**：應用程式生命週期事件處理，包含 HTTPS 強制轉向、注入攻擊防護等
- **Startup.cs**：OWIN 啟動配置，主要用於 Hangfire 排程系統的初始化
- **packages.config**：NuGet 套件清單，記錄所有第三方套件相依性

#### 路由與配置

- **RouteConfig.cs**：MVC 路由設定
- **BundleConfig.cs**：前端資源（CSS/JS）打包與壓縮配置
- **FilterConfig.cs**：全域篩選器設定
- **WebApiConfig.cs**：Web API 路由設定

## 系統架構層次

本系統採用標準的分層架構設計：

```
┌─────────────────────────────────────────────────────────┐
│                      展示層 (Presentation Layer)          │
│  ┌─────────────────┐  ┌──────────────────┐              │
│  │  前台 Controllers │  │ 後台 Controllers  │              │
│  │  (50+ 檔案)      │  │  (65+ 檔案)      │              │
│  └─────────────────┘  └──────────────────┘              │
│  ┌─────────────────────────────────────────┐            │
│  │         Razor Views (50+ 目錄)           │            │
│  │      HTML Helpers (26 個擴充方法)        │            │
│  └─────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                 業務邏輯層 (Business Logic Layer)         │
│  ┌─────────────────┐  ┌──────────────────┐              │
│  │  Action 類別     │  │  Service 類別    │              │
│  │  (業務邏輯處理)  │  │  (服務封裝)      │              │
│  └─────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                 資料存取層 (Data Access Layer)            │
│  ┌──────────────────────────────────────────┐           │
│  │  DAO 類別 (使用 Dapper + Entity Framework) │           │
│  │  - ApplyDAO.cs (24560 行)                │           │
│  │  - BackApplyDAO.cs (18648 行)            │           │
│  │  - SHAREDAO.cs (3108 行)                 │           │
│  └──────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                   資料庫層 (Database Layer)               │
│                  Microsoft SQL Server                    │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐             │
│  │ e-service│  │   MDOD   │  │ HangFire  │             │
│  │   主庫   │  │  醫審系統 │  │  排程資料 │             │
│  └──────────┘  └──────────┘  └───────────┘             │
└─────────────────────────────────────────────────────────┘
```

## 使用的主要套件

### 後端技術棧

| 套件名稱                 | 版本          | 用途說明                   |
| ------------------------ | ------------- | -------------------------- |
| ASP.NET MVC              | 4.0.20710.0   | Web MVC 框架               |
| ASP.NET Web API          | 4.0.20710.0   | RESTful API 框架           |
| .NET Framework           | 4.5.2         | 開發框架                   |
| Entity Framework         | 5.0.0         | ORM 框架，物件關聯映射     |
| Dapper                   | 1.60.6        | 輕量級 ORM，高效能資料存取 |
| Hangfire                 | 1.7.19        | 排程任務管理框架           |
| log4net                  | 2.0.0         | 日誌記錄框架               |
| Newtonsoft.Json          | 10.0.3        | JSON 序列化/反序列化       |
| NPOI                     | 2.5.1         | Excel 檔案讀寫 (開源)      |
| iTextSharp               | 5.4.4         | PDF 文件產生與處理         |
| DocX                     | 1.7.0         | Word 文件處理              |
| FreeSpire.Doc            | 7.11.0        | 文件格式轉換               |
| GemBox.Spreadsheet       | 43.0.0.1076   | 試算表處理                 |
| DocumentFormat.OpenXml   | 2.5           | Office Open XML 格式處理   |
| AntiXSS                  | 4.3.0         | XSS 攻擊防護               |
| Portable.BouncyCastle    | 1.8.6         | 加密演算法庫               |
| jose-jwt / JWT           | 3.0.0 / 7.3.1 | JWT Token 處理             |
| ValueInjecter            | 3.2.0         | 物件屬性映射工具           |
| DotNetZip / Ionic.Zip    | 1.9.1.8       | 壓縮檔處理                 |
| System.DirectoryServices | 7.0.0         | Active Directory 整合      |

### 前端技術棧

| 套件名稱    | 版本   | 用途說明               |
| ----------- | ------ | ---------------------- |
| jQuery      | 3.7.1  | 主要 JavaScript 函式庫 |
| jQuery UI   | 1.10.3 | UI 互動元件            |
| Vue.js      | 2.6.11 | 前端 MVVM 框架         |
| Bootstrap   | 5.3.5  | 響應式 UI 框架         |
| FontAwesome | 4.7.0  | 圖示字型庫             |
| Knockout.js | 2.1.0  | MVVM 資料綁定框架      |
| Select2     | -      | 下拉選單增強套件       |
| Modernizr   | 2.5.3  | HTML5/CSS3 功能偵測    |

### 排程系統套件

| 套件名稱               | 版本   | 用途說明              |
| ---------------------- | ------ | --------------------- |
| Hangfire               | 1.7.19 | 核心排程框架          |
| Hangfire.SqlServer     | 1.7.19 | SQL Server 儲存提供者 |
| Hangfire.MemoryStorage | 1.7.0  | 記憶體儲存提供者      |
| Hangfire.SQLite        | 1.4.2  | SQLite 儲存提供者     |

## 開發環境需求

### 後端開發環境

- **Visual Studio**：2015 或更高版本（建議使用 Visual Studio 2017/2019）
- **.NET Framework SDK**：4.5.2 或更高版本
- **IIS**：7.0 或更高版本
- **SQL Server**：2012 或更高版本（開發環境可使用 SQL Server Express）
- **Windows**：Windows 7 或更高版本（建議 Windows 10/Server 2016+）

### 前端開發環境

- **現代瀏覽器**：
  - Google Chrome 90+ (建議)
  - Microsoft Edge 90+
  - Firefox 88+
  - Safari 14+ (Mac only)
- **開發工具**：瀏覽器開發者工具（F12）

### 資料庫環境

- **SQL Server**：
  - 主要資料庫：e-service
  - 醫審系統資料庫：MDOD
  - 排程資料庫：HangFire (SQLite 或 SQL Server)
- **資料庫管理工具**：
  - SQL Server Management Studio (SSMS) 17.0+
  - Azure Data Studio (選用)

### 其他工具

- **Git**：版本控制系統
- **Postman**：API 測試工具（選用）
- **Fiddler**：HTTP 除錯工具（選用）
- **log4net Viewer**：日誌檢視工具（選用）

## 部署注意事項

### IIS 部署設定

#### 應用程式集區設定

```
名稱：e-service
.NET CLR 版本：v4.0
管道模式：整合式
身分識別：ApplicationPoolIdentity 或自訂帳號
```

#### 應用程式設定

```
實體路徑：E:\WebSite\e-service（依實際環境調整）
應用程式集區：e-service
啟用的通訊協定：http,https
```

#### 繫結設定

```
類型：https
連接埠：443
SSL 憑證：安裝有效的 SSL 憑證
```

### Web.config 關鍵配置

#### 資料庫連線字串

```xml
<connectionStrings>
  <!-- 主要資料庫 -->
  <add name="DefaultConnection"
       providerName="System.Data.SqlClient"
       connectionString="Data Source=YourServer;Initial Catalog=e-service;User ID=YourUser;Password=YourPassword" />

  <!-- 醫審系統資料庫 -->
  <add name="MDODConnection"
       providerName="System.Data.SqlClient"
       connectionString="Data Source=YourServer;Initial Catalog=MDOD;User ID=YourUser;Password=YourPassword" />

  <!-- SFTP 連線 -->
  <add name="SFTPConnection"
       connectionString="YourSFTPServer;userid=YourUser;YourPassword" />
</connectionStrings>
```

#### 應用程式設定

```xml
<appSettings>
  <!-- 會員登入逾時時間 (分鐘) -->
  <add key="MemberLoginTimeout" value="60" />

  <!-- 管理者登入逾時時間 (分鐘) -->
  <add key="AdminLoginTimeout" value="640" />

  <!-- 郵件伺服器設定 -->
  <add key="MailServer" value="your.mail.server" />
  <add key="MailSenderAddr" value="noreply@yourdom ain.gov.tw" />

  <!-- SFTP 設定 -->
  <add key="FtpNasCanUse" value="Y" />
  <add key="FtpNasServer" value="your.sftp.server" />
  <add key="FtpNasUser" value="ftpuser" />
  <add key="FtpNasPassword" value="YourPassword" />
  <add key="FtpNasPath" value="/home/ftpuser/eservice/" />

  <!-- 測試環境標記 -->
  <add key="WebTestEnvir" value="N" />

  <!-- Hangfire 資料庫連線 -->
  <add key="connectionHangFire" value="Data Source=YourServer;Initial Catalog=HangFire;..." />
</appSettings>
```

#### Session 設定

```xml
<system.web>
  <!-- 建議生產環境使用 StateServer 或 SQLServer Mode -->
  <sessionState mode="StateServer"
                stateConnectionString="tcpip=127.0.0.1:42424"
                timeout="30"
                cookieless="false"
                cookieSameSite="Strict" />
</system.web>
```

### 安全性設定

#### HTTPS 強制轉向

系統已在 `Global.asax.cs` 的 `Application_BeginRequest` 中實作 HTTPS 強制轉向：

```csharp
if (!Context.Request.IsSecureConnection)
{
    Response.Redirect("https://" + Request.Url.Host + Request.Url.AbsolutePath + ...);
}
```

#### HTTP 安全標頭

```xml
<system.webServer>
  <httpProtocol>
    <customHeaders>
      <add name="X-XSS-Protection" value="1; mode=block" />
      <add name="X-Content-Type-Options" value="nosniff" />
      <add name="X-Frame-Options" value="SAMEORIGIN" />
      <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" />
      <add name="Cache-Control" value="no-cache,no-store,must-revalidate,private" />
      <add name="Pragma" value="no-cache" />
    </customHeaders>
  </httpProtocol>
</system.webServer>
```

### 目錄權限設定

確保應用程式集區身分識別對以下目錄具有適當權限：

| 目錄路徑                        | 所需權限         | 用途說明                   |
| ------------------------------- | ---------------- | -------------------------- |
| `E:\WebSite\e-service`          | 讀取、執行       | 應用程式根目錄             |
| `E:\WebSite\e-service\App_Data` | 讀取、寫入、修改 | 應用程式資料 (HangFire DB) |
| `C:\e-service\Logs`             | 讀取、寫入、修改 | log4net 日誌檔案           |
| `C:\e-service\Upload`           | 讀取、寫入、修改 | 使用者上傳檔案             |
| `C:\e-service\Temp`             | 讀取、寫入、修改 | 暫存檔案                   |

### Log4net 日誌配置

系統使用 log4net 進行日誌記錄，日誌檔案建議存放路徑：

```
C:\e-service\Logs\
├── Web\                    # 一般網頁日誌
│   └── YYYY-MM-DD.txt
├── Schedule\               # 排程任務日誌
│   ├── Mdod\               # 醫審系統排程
│   ├── System\             # 系統排程
│   └── Cert\               # 證明書排程
└── Error\                  # 錯誤日誌
```

## 系統架構特色

### 1. 分層架構設計

系統採用經典的五層架構：

- **展示層 (Presentation Layer)**：Controllers + Views + HTML Helpers
- **業務邏輯層 (Business Logic Layer)**：Action 類別 + Service 類別
- **資料存取層 (Data Access Layer)**：DAO 類別
- **資料模型層 (Data Model Layer)**：Entities + ViewModels
- **共用層 (Common Layer)**：Utils + Commons + Extensions

各層職責明確，降低耦合度，提升可維護性。

### 2. MVC Areas 區域化管理

使用 ASP.NET MVC Areas 功能將系統劃分為多個區域：

- **前台區域 (無 Area)**：會員申辦功能
- **BACKMIN Area**：後台管理系統
- **Resource Area**：資源管理（資料庫、檔案、資料表查詢）
- **Schedule Area**：排程任務管理

各區域獨立運作，便於團隊分工與功能擴充。

### 3. 雙 ORM 策略

系統同時使用兩種 ORM 技術，各取所長：

#### Entity Framework 5.0

- **優勢**：物件關聯映射、LINQ 查詢、變更追蹤
- **適用場景**：簡單 CRUD 操作、需要物件導向操作的場景
- **使用範例**：會員資料維護、代碼表查詢

#### Dapper 1.60.6

- **優勢**：高效能、輕量級、接近原生 SQL 的控制力
- **適用場景**：複雜查詢、大量資料處理、高效能需求
- **使用範例**：申辦案件查詢、統計報表、批次資料處理

**資料存取層範例**：

```csharp
// ApplyDAO.cs 中混用兩種 ORM
public class ApplyDAO
{
    // 使用 Dapper 進行高效能查詢
    public List<APPLY> GetApplyList(string memberId)
    {
        using (var conn = new SqlConnection(connString))
        {
            string sql = @"
                SELECT * FROM APPLY
                WHERE MemberId = @MemberId
                ORDER BY CreateTime DESC";

            return conn.Query<APPLY>(sql, new { MemberId = memberId }).ToList();
        }
    }

    // 使用 Entity Framework 進行簡單更新
    public void UpdateApply(APPLY apply)
    {
        using (var db = new MyDbContext())
        {
            db.Entry(apply).State = EntityState.Modified;
            db.SaveChanges();
        }
    }
}
```

### 4. 26 個自訂 HTML Helpers

系統提供 26 個自訂 HTML Helper 擴充方法，大幅簡化前端開發：

- **DatePickerExtension**：日期選擇器
- **FileUploadExtension**：檔案上傳元件
- **AddrExtension**：地址三聯選單（縣市/鄉鎮/郵遞區號）
- **TelExtension**：電話輸入欄位
- **EmailExtension**：電子郵件欄位
- **PayPageExtension**：繳費頁面元件
- ...等 20 個其他 Helper

**使用範例**：

```razor
@* 在 View 中使用自訂 Helper *@
@Html.DatePickerFor(m => m.Birthday)
@Html.FileUploadFor(m => m.AttachFile, "上傳附件")
@Html.AddrFor(m => m.City, m => m.District, m => m.Zip)
```

### 5. BaseController 繼承架構

系統定義兩種基礎控制器：

#### BaseController.cs

- 需要會員登入驗證
- 自動載入 Session 資料
- 提供共用方法（如：GetMemberInfo、CheckPermission 等）
- 大部分前台控制器繼承此類別

#### BaseNoMemberController.cs

- 不需登入即可存取
- 用於公開頁面（如：首頁、公告查詢、服務說明等）
- 僅提供基本功能

**繼承架構**：

```
ControllerBase (ASP.NET MVC)
    ↓
BaseNoMemberController (無需登入)
    ↓
BaseController (需登入)
    ↓
各業務 Controllers (Apply_005001Controller, FormController, etc.)
```

### 6. Hangfire 排程系統

使用 Hangfire 框架實作背景任務與定時排程：

#### 排程任務類型

1. **定時任務 (Recurring Jobs)**：依 Cron 表達式定期執行
2. **延遲任務 (Delayed Jobs)**：延遲一段時間後執行
3. **背景任務 (Background Jobs)**：立即在背景執行
4. **連續任務 (Continuations)**：前一任務完成後接續執行

#### 主要排程任務

| 排程名稱                         | Cron 表達式  | 執行頻率   | 功能說明                         |
| -------------------------------- | ------------ | ---------- | -------------------------------- |
| Mdod.CreateXML                   | `0 * * * *`  | 每小時     | 醫審系統案件 XML 產生並上傳 SFTP |
| Esc.ScheService                  | `0 21 * * *` | 每日 21:00 | 我的 E 政府服務上稿              |
| CaseC.SendMailOverdue            | `0 1 * * *`  | 每日 01:00 | 中醫藥司未補件通知               |
| payEC.RequestFileUpload          | `20 0 * * *` | 每日 00:20 | 聯合信用中心請款檔案上傳         |
| payEC.ProcessRequestFileDownload | `40 7 * * *` | 每日 07:40 | 聯合信用中心回覆檔案下載         |
| payEC.ECFileReadLine             | `50 7 * * *` | 每日 07:50 | 聯合信用中心繳費資料讀取         |

#### Hangfire Dashboard

- **存取網址**：`https://your-domain/hangfire`
- **功能**：監控排程狀態、手動觸發任務、查看執行紀錄
- **權限控管**：需登入後台管理者帳號

## 多元登入方式

系統支援五種登入方式，滿足不同使用者需求：

### 1. 帳號密碼登入

- 傳統的帳號/密碼登入方式
- 支援記住帳號功能
- 密碼加密儲存

### 2. 自然人憑證 (MOICA)

- 支援內政部自然人憑證登入
- 使用 HiPKI 元件進行憑證驗證
- 自動讀取憑證中的身分證字號

### 3. 工商憑證 (MOEACA)

- 支援經濟部工商憑證登入
- 用於公司行號登入
- 自動讀取公司統一編號

### 4. 醫事人員憑證 (HCA)

- 支援衛生福利部醫事人員憑證
- 用於醫療專業人員登入
- 自動讀取醫事人員執照號碼

### 5. 數位身分證 (NEW eID)

- 支援內政部新式數位身分證
- 使用 eID 卡片登入
- 整合政府 T-Road 認證機制

## 繳費系統整合

### 支援的繳費方式

#### 1. 虛擬帳號繳費

- **企業識別碼**：49465
- **帳號格式**：4946500XXXXXXXXX (14 碼)
- **產生規則**：使用特定演算法產生唯一繳費帳號
- **對帳方式**：每日自動對帳，更新繳費狀態

#### 2. 超商繳費

- **代收代號**：69A
- **條碼格式**：三段式條碼
- **支援超商**：7-11、全家、萊爾富、OK
- **繳費期限**：產生後 7 天內有效

#### 3. 郵局劃撥

- **劃撥帳號**：50013985
- **戶名**：衛生福利部
- **手動對帳**：需手動核對劃撥收據

#### 4. 信用卡繳費

- **整合方式**：串接聯合信用卡中心
- **支援卡別**：VISA、MasterCard、JCB
- **安全機制**：SSL 加密傳輸、3D 驗證

#### 5. 政府支付平台 (GSP)

- **平台名稱**：電子支付整合平台
- **整合方式**：Web Service API
- **支援功能**：線上繳費、繳費查詢、退費處理

### 繳費流程

```
使用者選擇繳費方式
    ↓
系統產生繳費資訊 (虛擬帳號/條碼/繳費單)
    ↓
使用者前往繳費通路繳費
    ↓
金流機構回傳繳費結果
    ↓
系統自動對帳並更新案件狀態
    ↓
寄送繳費完成通知信
```

## 文件產生功能

系統具備強大的文件產生與處理能力：

### 支援的文件格式

| 格式             | 套件                               | 用途                     |
| ---------------- | ---------------------------------- | ------------------------ |
| PDF              | iTextSharp 5.4.4                   | 證明書、公文、申請書產生 |
| Word (DOC/DOCX)  | DocX 1.7.0<br>FreeSpire.Doc 7.11.0 | 公文範本填入、文件編輯   |
| Excel (XLS/XLSX) | NPOI 2.5.1<br>GemBox.Spreadsheet   | 報表匯出、資料匯入       |

### 文件處理流程

#### 證明書產生流程

```csharp
// 1. 載入證明書範本
var templatePath = Server.MapPath("~/Template/005001_Certificate.pdf");

// 2. 填入案件資料
var pdfDoc = new Document();
// ... 使用 iTextSharp 填入欄位

// 3. 儲存至指定路徑
var outputPath = Server.MapPath($"~/Upload/Cert/{applyId}.pdf");
pdfDoc.Save(outputPath);

// 4. 上傳至 SFTP (選用)
SftpUtils.UploadFile(outputPath, remotePath);
```

#### 公文產生流程

```
1. 從資料庫讀取公文範本 (Word 格式)
2. 使用 DocX 或 FreeSpire.Doc 填入案件資料
3. 轉換為 PDF 格式 (使用 FreeSpire.Doc)
4. 儲存至指定位置
5. 提供下載連結
```

### 常用工具類別

- **ReportUtils.cs**：報表產生工具 (865 行)
- **DocumentUtils.cs**：文件處理工具
- **XMLToDOCUtils.cs**：XML 轉 Word 工具
- **WordConverter.cs**：Word 格式轉換擴充方法

## 系統安全機制

### 1. 身份驗證 (Authentication)

#### Forms Authentication

```xml
<authentication mode="Forms">
  <forms loginUrl="~/Home/Login"
         timeout="2880"
         cookieless="UseCookies"
         protection="All"
         requireSSL="true" />
</authentication>
```

#### Session 管理

- **Mode**：建議使用 StateServer 或 SQLServer
- **Timeout**：會員 60 分鐘、管理者 640 分鐘
- **Cookie 設定**：HttpOnly, Secure

### 2. 授權 (Authorization)

使用自訂的 `CustomAuthorizeAttribute` 進行權限控管：

```csharp
[CustomAuthorize(Roles = "Admin,Manager")]
public ActionResult SensitiveAction()
{
    // 只有 Admin 或 Manager 角色可以存取
}
```

### 3. XSS 防護

- 使用 `AntiXSS 4.3.0` 套件
- Request Validation 啟用
- `SecurityHelper.cs` 提供注入攻擊檢測

### 4. HTTPS 強制

在 `Global.asax.cs` 的 `Application_BeginRequest` 中實作：

```csharp
if (!Context.Request.IsSecureConnection)
{
    Response.Redirect("https://" + Request.Url.Host + Request.Url.AbsolutePath + ...);
}
```

### 5. HTTP 安全標頭

透過 `Web.config` 設定安全標頭：

- **X-XSS-Protection**：1; mode=block
- **X-Content-Type-Options**：nosniff
- **X-Frame-Options**：SAMEORIGIN
- **Strict-Transport-Security**：max-age=31536000
- **Cache-Control**：no-cache,no-store,must-revalidate

### 6. 錯誤處理

#### 全域錯誤處理

```csharp
// Global.asax.cs
protected void Application_Error(Object sender, EventArgs e)
{
    Exception ex = Server.GetLastError();
    logger.Error("Application Error", ex);
    // 導向錯誤頁面
}
```

#### 自訂錯誤頁面

```xml
<customErrors mode="On" defaultRedirect="~/Error">
  <error statusCode="404" redirect="~/Error/NotFound" />
  <error statusCode="500" redirect="~/Error/ServerError" />
</customErrors>
```

## 效能優化機制

### 1. 前端資源打包與壓縮

透過 `BundleConfig.cs` 進行 CSS/JS 打包：

```csharp
bundles.Add(new ScriptBundle("~/bundles/jquery").Include(
    "~/Scripts/jquery-{version}.js"));

bundles.Add(new StyleBundle("~/Content/css").Include(
    "~/Content/bootstrap.css",
    "~/Content/site.css"));
```

### 2. Output Cache

對靜態或較少變動的頁面使用 Output Cache：

```csharp
[OutputCache(Duration = 3600, VaryByParam = "none")]
public ActionResult StaticPage()
{
    return View();
}
```

### 3. 資料庫查詢優化

- 使用 Dapper 進行高效能查詢
- 適當使用資料庫索引
- 避免 N+1 查詢問題
- 使用分頁查詢大量資料

### 4. 非同步處理

- 使用 Hangfire 處理耗時任務
- 檔案上傳/下載使用非同步處理
- 大量郵件發送使用背景任務

## 開發與維護建議

### 1. 程式碼規範

- 遵循 C# 命名規範
- 使用有意義的變數名稱
- 適當添加註解說明
- 方法保持精簡（建議不超過 100 行）

### 2. 版本控制

- 使用 Git 進行版本控制
- 提交訊息要清楚描述變更內容
- 開發新功能使用分支 (Branch)
- 定期合併回主分支

### 3. 測試建議

- 撰寫單元測試覆蓋關鍵業務邏輯
- 進行整合測試確保各模組正常運作
- 上線前進行壓力測試
- 建立完整的測試案例文件

### 4. 監控與日誌

- 定期檢查 log4net 日誌檔案
- 監控系統效能指標
- 定期檢視 Hangfire Dashboard
- 建立異常告警機制

### 5. 資料庫維護

- 定期備份資料庫
- 定期重建索引
- 監控資料庫效能
- 清理過期資料

## 常見問題與解決方案

### 問題 1：Session 遺失

**原因**：

- 應用程式集區回收
- Session Mode 設定為 InProc

**解決方案**：

- 改用 StateServer 或 SQLServer Mode
- 調整應用程式集區回收設定

### 問題 2：檔案上傳失敗

**原因**：

- 檔案大小超過限制
- 目錄權限不足

**解決方案**：

```xml
<system.web>
  <httpRuntime maxRequestLength="102400" /> <!-- 100MB -->
</system.web>

<system.webServer>
  <security>
    <requestFiltering>
      <requestLimits maxAllowedContentLength="104857600" /> <!-- 100MB -->
    </requestFiltering>
  </security>
</system.webServer>
```

### 問題 3：Hangfire 任務未執行

**原因**：

- Hangfire Server 未啟動
- 資料庫連線問題

**解決方案**：

- 檢查 `Startup.cs` 中的 Hangfire 配置
- 確認資料庫連線字串正確
- 查看 Hangfire Dashboard 的錯誤訊息

## 總結

衛生福利部電子化服務平台是一個功能完整、架構清晰的大型政府線上服務系統。系統採用成熟的 ASP.NET MVC 4.0 框架，搭配多種現代化技術套件，提供穩定可靠的線上申辦服務。

### 系統特色總結

1. **多元登入方式**：支援 5 種登入方式，滿足不同使用者需求
2. **完整申辦流程**：涵蓋申請、繳費、審核、證明書核發等完整流程
3. **強大的文件處理能力**：支援 PDF/Word/Excel 多種格式的產生與處理
4. **靈活的繳費整合**：整合 5 種繳費方式，提供多元繳費選擇
5. **可靠的排程系統**：使用 Hangfire 處理背景任務與定時作業
6. **完善的安全機制**：多層次的安全防護，確保資料安全
7. **清晰的分層架構**：五層架構設計，易於維護與擴充

### 技術亮點

- **雙 ORM 策略**：Entity Framework + Dapper，兼顧開發效率與執行效能
- **26 個自訂 HTML Helpers**：大幅簡化前端開發，提升開發效率
- **MVC Areas 區域化**：前台、後台、排程分離，架構清晰
- **BaseController 繼承體系**：統一管理登入驗證與共用功能

本專案展現了完整的政府電子化服務平台架構，涵蓋前台申辦、後台管理、排程作業、第三方整合等多個面向，是學習大型 ASP.NET MVC 專案架構的優秀範例。

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
