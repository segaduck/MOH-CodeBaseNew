# 001039 醫師赴國外訓練英文保證函 - 完整技術文件

## 服務基本資訊

| 項目             | 內容                                                     |
| ---------------- | -------------------------------------------------------- |
| **服務代碼**     | 001039                                                   |
| **服務名稱**     | 醫師赴國外訓練英文保證函                                 |
| **業務單位**     | 醫事司                                                   |
| **是否需繳費**   | 否                                                       |
| **Controller**   | `ES/Controllers/Apply_001039Controller.cs` (336 行)      |
| **ViewModel**    | `ES/Models/ViewModels/Apply_001039ViewModel.cs` (477 行) |
| **Entity Model** | `ES/Models/Entities/Apply_001039Model.cs` (226 行)       |
| **主要資料表**   | APPLY, APPLY_001039, APPLY_FILE                          |
| **檔案數量**     | 10 個固定檔案上傳欄位（可選）                            |

---

## 服務特色

### 與其他服務的差異

| 項目             | 001008 英文證明書 | 001037 無懲戒紀錄證明 | **001039 醫師赴國外訓練英文保證函** |
| ---------------- | ----------------- | --------------------- | ----------------------------------- |
| **服務性質**     | 英文證明書        | 無懲戒紀錄證明        | **醫師赴國外訓練英文保證函**        |
| **繳費方式**     | 無                | 5 種                  | **無**                              |
| **固定檔案上傳** | 無                | 3 個                  | **10 個（可選）**                   |
| **檔案合併選項** | 無                | 有                    | **有**                              |
| **複雜度**       | ⭐⭐⭐⭐ 高       | ⭐⭐⭐⭐ 高           | **⭐⭐⭐⭐ 高**                     |

### 核心功能

1. **申請人基本資料**

   - 中文姓名（與護照相同）
   - 英文姓名（與護照相同）
   - 身分證字號
   - 性別
   - 出生年月日

2. **訓練資訊**

   - E.C.F.M.G.及格證書字號
   - 訓練醫院及科別（請用英文填寫）
   - 前往國家（中、英文）
   - 事由

3. **聯絡資訊**

   - 聯絡人姓名
   - 聯絡人電話（區碼 + 號碼 + 分機）
   - 聯絡人行動電話
   - 聯絡人 E-MAIL（帳號 + 網域）
   - 聯絡人傳真（區碼 + 號碼 + 分機）

4. **郵寄資訊**

   - 本求證表郵寄地址（含國別及收件者）

5. **檢附文件管理**（10 個固定檔案，可選）

   - 我國評鑑合格醫院保證函
   - 申請人自行提出書面保證函
   - 醫師證書影本
   - 國外契約或接受文件
   - E.C.F.M.G.及格證書影本
   - 國民身分證正面影本
   - 國民身分證反面影本
   - 護照影本或有關部會許可出國文件影本
   - 個人執業發展規劃書
   - 醫師赴國外訓練英文保證函申請表

6. **檔案合併選項**
   - 可選擇是否將所有檔案合併為一個 PDF

---

## 系統架構

### 架構圖

```
使用者 → Controller → DAO → Database
         ↓
      ViewModel
         ↓
      Razor View
```

**說明：**

- 使用者透過瀏覽器填寫表單
- Controller 接收請求並處理業務邏輯
- ViewModel 負責資料驗證和格式轉換
- DAO 負責資料庫操作
- Razor View 負責頁面呈現

### 資料流程圖

```
1. 申請流程：
   使用者填寫基本資料 → 填寫訓練資訊 → 填寫聯絡資訊 →
   填寫郵寄地址 → 上傳檢附文件（10 個檔案，可選） →
   選擇是否合併檔案 → 預覽 → 送出 → 完成

2. 儲存流程：
   Controller.Apply() → DAO.SaveApply001039() →
   INSERT APPLY → INSERT APPLY_001039 → INSERT APPLY_FILE →
   寄送通知郵件 → 顯示完成頁面

3. 補件流程：
   Controller.AppDoc() → DAO.QueryApply001039() →
   顯示原申請資料 → 上傳補件檔案 →
   Controller.AppDocSave() → DAO.SaveAppDoc001039() →
   更新資料 → 寄送補件完成郵件
```

---

## 資料庫結構

### 1. APPLY 資料表（主表）

**說明：** 所有申辦案件的主表

**主要欄位：**

- `APP_ID` (PK)：案件編號
- `SRV_ID`：服務代碼（001039）
- `ACC_NO`：申請人帳號
- `NAME`：申請人姓名
- `IDN`：申請人身分證字號
- `FLOW_CD`：流程狀態（1:申請中, 2:補件中, 3:補件完成）
- `UNIT_CD`：業務單位
- `APP_TIME`：申請時間
- `APP_EXT_DATE`：展延日期

### 2. APPLY_001039 資料表（服務明細表）

**說明：** 001039 服務的詳細資料

**主要欄位：**

| 欄位名稱                                      | 資料型別 | 長度 | NULL | 說明                                       | 範例值                          |
| --------------------------------------------- | -------- | ---- | ---- | ------------------------------------------ | ------------------------------- |
| `APP_ID`                                      | varchar  | 50   | NO   | 案件編號（PK）                             | 001039202501130001              |
| `APPLY_DATE`                                  | datetime | -    | YES  | 申辦日期                                   | 2025-01-13                      |
| `CNAME`                                       | varchar  | 100  | YES  | 申請人中文姓名（與護照相同）               | 王小明                          |
| `PID`                                         | varchar  | 50   | YES  | 申請人身分證字號                           | A123456789                      |
| `ENAME`                                       | varchar  | 100  | YES  | 申請人英文姓名（與護照相同）               | Wang Xiao Ming                  |
| `GENDER`                                      | varchar  | 10   | YES  | 申請人性別                                 | M                               |
| `BIRTHDAY`                                    | datetime | -    | YES  | 申請人出生年月日                           | 1990-01-01                      |
| `ECFMG`                                       | varchar  | 100  | YES  | E.C.F.M.G.及格證書字號                     | ECFMG123456                     |
| `HOSPITAL_DIVISION`                           | varchar  | 200  | YES  | 訓練醫院及科別（請用英文填寫）             | ABC Hospital, Internal Medicine |
| `COUNTRY`                                     | varchar  | 100  | YES  | 前往國家（中、英文）                       | 美國 USA                        |
| `CAUSE`                                       | varchar  | 500  | YES  | 事由                                       | 赴美進修內科專科訓練            |
| `MAIL_ADDRESS`                                | varchar  | 500  | YES  | 本求證表郵寄地址（含國別及收件者）         | 美國加州...                     |
| `CONTACT_NAME`                                | varchar  | 100  | YES  | 聯絡人姓名                                 | 李小華                          |
| `CONTACT_TEL`                                 | varchar  | 50   | YES  | 聯絡人電話                                 | 02-12345678                     |
| `CONTACT_TEL_EXT`                             | varchar  | 10   | YES  | 電話分機                                   | 123                             |
| `CONTACT_MOBILE`                              | varchar  | 50   | YES  | 聯絡人行動電話                             | 0912345678                      |
| `E_MAIL`                                      | varchar  | 100  | YES  | 聯絡人 E-MAIL                              | test@example.com                |
| `CONTACT_FAX`                                 | varchar  | 50   | YES  | 聯絡人傳真                                 | 02-87654321                     |
| `CONTACT_FAX_EXT`                             | varchar  | 10   | YES  | 傳真分機                                   | 456                             |
| `IS_MERGE_FILE`                               | varchar  | 1    | YES  | 佐證文件採合併檔案（Y/N）                  | Y                               |
| `ATTH1`                                       | varchar  | 200  | YES  | 我國評鑑合格醫院保證函檔案名稱             | file1.pdf                       |
| `ATTH2`                                       | varchar  | 200  | YES  | 申請人自行提出書面保證函檔案名稱           | file2.pdf                       |
| `ATTH3`                                       | varchar  | 200  | YES  | 醫師證書影本檔案名稱                       | file3.pdf                       |
| `ATTH4`                                       | varchar  | 200  | YES  | 國外契約或接受文件檔案名稱                 | file4.pdf                       |
| `ATTH5`                                       | varchar  | 200  | YES  | E.C.F.M.G.及格證書影本檔案名稱             | file5.pdf                       |
| `ATTH6`                                       | varchar  | 200  | YES  | 國民身分證正面影本檔案名稱                 | file6.pdf                       |
| `ATTH7`                                       | varchar  | 200  | YES  | 國民身分證反面影本檔案名稱                 | file7.pdf                       |
| `ATTH8`                                       | varchar  | 200  | YES  | 護照影本或有關部會許可出國文件影本檔案名稱 | file8.pdf                       |
| `ATTH9`                                       | varchar  | 200  | YES  | 個人執業發展規劃書檔案名稱                 | file9.pdf                       |
| `ATTH10`                                      | varchar  | 200  | YES  | 醫師赴國外訓練英文保證函申請表檔案名稱     | file10.pdf                      |
| `MAIL_DATE`                                   | datetime | -    | YES  | 郵寄日期                                   | 2025-01-15                      |
| `MAIL_BARCODE`                                | varchar  | 50   | YES  | 掛號條碼                                   | 1234567890                      |
| **標準欄位**                                  |          |      |      |                                            |                                 |
| `ADD_TIME`, `ADD_FUN_CD`, `ADD_ACC`           |          |      |      | 新增資訊                                   |                                 |
| `UPD_TIME`, `UPD_FUN_CD`, `UPD_ACC`           |          |      |      | 更新資訊                                   |                                 |
| `DEL_MK`, `DEL_TIME`, `DEL_FUN_CD`, `DEL_ACC` |          |      |      | 刪除資訊                                   |                                 |

### 3. APPLY_FILE 資料表（附件檔案表）

**說明：** 儲存所有案件的附件檔案

**主要欄位：**

- `APP_ID` (PK)：案件編號
- `FILE_NO` (PK)：檔案編號（0~9）
- `FILENAME`：實際檔案名稱（儲存在伺服器）
- `SRC_FILENAME`：原始檔案名稱
- `SRC_NO`：檔案來源編號（0~9）

---

## ViewModel 結構

### Apply_001039FormModel

**繼承：** Apply_001039Model

**主要屬性：**

```csharp
public class Apply_001039FormModel : Apply_001039Model
{
    // 基本資訊
    [Required]
    [Display(Name = "申請人中文姓名")]
    public string CNAME { get; set; }  // 申請人中文姓名（與護照相同）

    [Required]
    [Display(Name = "身分證編號/外僑居留證號")]
    public string PID { get; set; }  // 申請人身分證字號

    [Required]
    [Display(Name = "申請人英文姓名")]
    public string ENAME { get; set; }  // 申請人英文姓名（與護照相同）

    [Required]
    [Display(Name = "申請人性別")]
    public string GENDER { get; set; }  // 申請人性別

    [Required]
    [Display(Name = "申請人出生年月日")]
    public string BIRTHDAY_STR { get; set; }  // 申請人出生年月日（字串）

    // 訓練資訊
    [Required]
    [Display(Name = "E.C.F.M.G.及格證書字號")]
    public string ECFMG { get; set; }  // E.C.F.M.G.及格證書字號

    [Required]
    [Display(Name = "訓練醫院及科別")]
    public string HOSPITAL_DIVISION { get; set; }  // 訓練醫院及科別（請用英文填寫）

    [Required]
    [Display(Name = "前往國家")]
    public string COUNTRY { get; set; }  // 前往國家（中、英文）

    [Required]
    [Display(Name = "事由")]
    public string CAUSE { get; set; }  // 事由

    // 郵寄資訊
    [Required]
    [Display(Name = "本求證表郵寄地址")]
    public string MAIL_ADDRESS { get; set; }  // 本求證表郵寄地址（含國別及收件者）

    // 聯絡資訊
    [Required]
    [Display(Name = "聯絡人姓名")]
    public string CONTACT_NAME { get; set; }  // 聯絡人姓名

    [Required]
    [Display(Name = "聯絡人行動電話")]
    public string CONTACT_MOBILE { get; set; }  // 聯絡人行動電話

    public string APPLY_DATE_STR { get; set; }  // 申辦日期（字串）

    // 聯絡人電話（分段）
    [Display(Name = "聯絡人電話")]
    public string CONTACT_TEL_0 { get; set; }  // 聯絡人電話_區碼

    [Display(Name = "聯絡人電話")]
    public string CONTACT_TEL_1 { get; set; }  // 聯絡人電話_號碼

    public string CONTACT_TEL_2 { get; set; }  // 聯絡人電話_分機

    // 聯絡人E-MAIL（分段）
    [Required]
    [Display(Name = "聯絡人E_MAIL")]
    public string E_MAIL_1 { get; set; }  // 聯絡人E_MAIL_帳號

    [Display(Name = "聯絡人E_MAIL")]
    public string E_MAIL_2 { get; set; }  // 聯絡人E_MAIL_網域

    public string E_MAIL_3 { get; set; }  // 聯絡人E_MAIL_網域選單

    // 聯絡人傳真（分段）
    public string CONTACT_FAX_0 { get; set; }  // 聯絡人傳真_區碼
    public string CONTACT_FAX_1 { get; set; }  // 聯絡人傳真_號碼
    public string CONTACT_FAX_2 { get; set; }  // 聯絡人傳真_分機

    // 檢附文件（10 個檔案，可選）
    public HttpPostedFileBase FILE0 { get; set; }  // 我國評鑑合格醫院保證函
    public string FILE0_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE1 { get; set; }  // 申請人自行提出書面保證函
    public string FILE1_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE2 { get; set; }  // 醫師證書影本
    public string FILE2_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE3 { get; set; }  // 國外契約或接受文件
    public string FILE3_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE4 { get; set; }  // E.C.F.M.G.及格證書影本
    public string FILE4_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE5 { get; set; }  // 國民身分證正面影本
    public string FILE5_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE6 { get; set; }  // 國民身分證反面影本
    public string FILE6_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE7 { get; set; }  // 護照影本或有關部會許可出國文件影本
    public string FILE7_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE8 { get; set; }  // 個人執業發展規劃書
    public string FILE8_TEXT { get; set; }  // 檔案名稱

    public HttpPostedFileBase FILE9 { get; set; }  // 醫師赴國外訓練英文保證函申請表
    public string FILE9_TEXT { get; set; }  // 檔案名稱
}
```

---

## 技術重點

### 1. 10 個固定檔案上傳欄位（可選）

**10 種檢附文件類型：**

1. **FILE0（ATTH1）**：我國評鑑合格醫院保證函（向本部保證申請人如期學成返國時，將聘僱為該科相當職位之醫師）
2. **FILE1（ATTH2）**：申請人自行提出書面保證函（保證學業完成如期返國）
3. **FILE2（ATTH3）**：醫師證書影本
4. **FILE3（ATTH4）**：國外契約或接受文件（正本或影本）
5. **FILE4（ATTH5）**：E.C.F.M.G.及格證書影本
6. **FILE5（ATTH6）**：國民身分證正面影本
7. **FILE6（ATTH7）**：國民身分證反面影本
8. **FILE7（ATTH8）**：護照影本或有關部會許可出國文件影本
9. **FILE8（ATTH9）**：個人執業發展規劃書
10. **FILE9（ATTH10）**：醫師赴國外訓練英文保證函申請表

**實作方式：**

- 所有檔案都是可選的（非必填）
- 使用 HttpPostedFileBase 接收檔案上傳
- 每個檔案都有對應的 FILE{N}\_TEXT 欄位儲存檔案名稱
- 檔案上傳後儲存在伺服器，檔案名稱儲存在 APPLY_001039 資料表的 ATTH{N} 欄位

**JavaScript 控制：**

```javascript
// 檔案上傳控制
function handleFileUpload(fileInput) {
  var file = fileInput.files[0];
  if (file) {
    // 檢查檔案大小（不超過 5MB）
    if (file.size > 5 * 1024 * 1024) {
      alert("檔案大小不可超過 5MB");
      fileInput.value = "";
      return false;
    }

    // 檢查檔案格式（只接受 PDF）
    var fileName = file.name;
    var fileExt = fileName
      .substring(fileName.lastIndexOf(".") + 1)
      .toLowerCase();
    if (fileExt != "pdf") {
      alert("只接受 PDF 格式檔案");
      fileInput.value = "";
      return false;
    }

    // 顯示檔案名稱
    var fileTextId = fileInput.id.replace("FILE", "FILE") + "_TEXT";
    $("#" + fileTextId).val(fileName);
  }
}
```

### 2. 檔案合併選項

**特點：**

- 可選擇是否將所有檔案合併為一個 PDF（IS_MERGE_FILE）
- 合併後的檔案會儲存在伺服器
- 合併功能使用 PDF 合併工具

**實作方式：**

```csharp
// Controller 端處理
if (model.IS_MERGE_FILE == "Y")
{
    // 合併所有上傳的檔案
    List<string> filePaths = new List<string>();
    if (model.FILE0 != null) filePaths.Add(SaveFile(model.FILE0));
    if (model.FILE1 != null) filePaths.Add(SaveFile(model.FILE1));
    // ... 其他檔案

    // 使用 PDF 合併工具合併檔案
    string mergedFilePath = MergePDFFiles(filePaths);

    // 儲存合併後的檔案路徑
    model.ATTH1 = mergedFilePath;
}
```

### 3. 聯絡資訊分段輸入

**特點：**

- 電話：區碼 + 號碼 + 分機（CONTACT_TEL_0, CONTACT_TEL_1, CONTACT_TEL_2）
- E-MAIL：帳號 + 網域（E_MAIL_1, E_MAIL_2, E_MAIL_3）
- 傳真：區碼 + 號碼 + 分機（CONTACT_FAX_0, CONTACT_FAX_1, CONTACT_FAX_2）

**實作方式：**

```csharp
// Controller 端組合完整資訊
model.CONTACT_TEL = model.CONTACT_TEL_0 + "-" + model.CONTACT_TEL_1;
if (!string.IsNullOrEmpty(model.CONTACT_TEL_2))
{
    model.CONTACT_TEL += "#" + model.CONTACT_TEL_2;
}

model.E_MAIL = model.E_MAIL_1 + "@" + model.E_MAIL_2;

model.CONTACT_FAX = model.CONTACT_FAX_0 + "-" + model.CONTACT_FAX_1;
if (!string.IsNullOrEmpty(model.CONTACT_FAX_2))
{
    model.CONTACT_FAX += "#" + model.CONTACT_FAX_2;
}
```

### 4. E.C.F.M.G.及格證書字號

**特點：**

- E.C.F.M.G.（Educational Commission for Foreign Medical Graduates）
- 美國外國醫學畢業生教育委員會及格證書
- 必填欄位

**實作方式：**

- 使用文字輸入框
- 前端驗證：必填
- 後端驗證：必填

### 5. 訓練醫院及科別（請用英文填寫）

**特點：**

- 必須使用英文填寫
- 包含醫院名稱和科別

**實作方式：**

- 使用文字輸入框
- 前端驗證：必填
- 後端驗證：必填

---

## 相關檔案清單

### 前端檔案

- `ES/Controllers/Apply_001039Controller.cs` (336 行) - 控制器
- `ES/Models/ViewModels/Apply_001039ViewModel.cs` (477 行) - 視圖模型
- `ES/Views/Apply_001039/Prompt001039.cshtml` - 說明事項頁面
- `ES/Views/Apply_001039/Index.cshtml` - 申請表單
- `ES/Views/Apply_001039/PreView.cshtml` - 預覽頁面
- `ES/Views/Apply_001039/Done.cshtml` - 完成頁面
- `ES/Views/Apply_001039/AppDoc.cshtml` - 補件頁面

### 後端檔案

- `ES/DataLayers/ApplyDAO.cs` - 資料存取層（包含 SaveApply001039, QueryApply001039, SaveAppDoc001039 方法）
- `ES/DataLayers/ShareDAO.cs` - 共用資料存取層
- `ES/Models/Entities/Apply_001039Model.cs` (226 行) - 實體模型
- `ES/Models/Entities/APPLYModel.cs` - APPLY 實體

### 資料庫資料表

- `SERVICE` - 服務定義表
- `APPLY` - 申請主表
- `APPLY_001039` - 服務明細表
- `APPLY_FILE` - 附件檔案表
- `CODE_CD` - 代碼表

---

## 注意事項

### 1. 申請人基本資料

- 中文姓名和英文姓名必須與護照相同
- 身分證字號為必填
- 性別為必填（M:男, F:女）
- 出生年月日為必填

### 2. 訓練資訊

- E.C.F.M.G.及格證書字號為必填
- 訓練醫院及科別必須使用英文填寫
- 前往國家需填寫中、英文
- 事由為必填

### 3. 聯絡資訊

- 聯絡人姓名為必填
- 聯絡人行動電話為必填
- 聯絡人 E-MAIL 為必填
- 電話和傳真的區碼、號碼、分機需分段輸入

### 4. 郵寄資訊

- 本求證表郵寄地址為必填
- 需包含國別及收件者

### 5. 檢附文件

- 所有檔案都是可選的（非必填）
- 只接受 PDF 格式
- 每個檔案大小不超過 5MB
- 可選擇是否將所有檔案合併為一個 PDF

### 6. 補件功能

- 只有流程狀態為「補件中」的案件才能補件
- 補件有期限限制
- 補件完成後流程狀態會更新為「補件完成」

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
