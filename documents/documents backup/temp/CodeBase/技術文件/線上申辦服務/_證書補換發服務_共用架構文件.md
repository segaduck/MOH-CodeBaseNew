# 證書補(換)發服務 - 共用架構與技術文件

## 文件說明

本文件說明所有證書補(換)發類服務的共用架構、技術模式和實作方法。適用於以下服務：

- **001005** - 醫事人員或公共衛生師證書補(換)發
- **001007** - 專科醫師證書補(換)發
- **001036** - 專科護理師證書補(換)發
- 其他類似的證書補換發服務

### 如何使用本文件

1. **閱讀本文件**：了解共用的系統架構、技術模式、流程設計
2. **參考服務專屬文件**：查看特定服務的獨特欄位、業務規則、驗證邏輯
3. **結合使用**：本文件 + 服務專屬文件 = 完整技術規格

---

## 系統架構層次

所有證書補(換)發服務都採用相同的分層架構：

```
前端 Razor Views + jQuery
    ↓ HTTP POST/GET 請求
後端 ASP.NET MVC Controller
    ↓ 業務邏輯處理
資料存取層 (DAO - Dapper)
    ↓ SQL 查詢/異動
SQL Server 資料庫
```

### 架構說明

1. **前端層 (Presentation Layer)**

   - 使用 Razor View Engine 產生 HTML
   - jQuery 處理前端互動邏輯
   - AJAX 實現非同步資料更新
   - Bootstrap 提供響應式 UI

2. **控制層 (Controller Layer)**

   - 繼承 `BaseController` 提供登入驗證
   - 處理 HTTP 請求和回應
   - 協調 ViewModel 和 DAO 之間的資料流
   - 實作業務邏輯和流程控制

3. **資料存取層 (Data Access Layer)**

   - 使用 Dapper ORM 進行資料庫操作
   - 封裝 SQL 查詢和異動邏輯
   - 提供 Transaction 支援
   - 記錄資料變更歷程

4. **資料庫層 (Database Layer)**
   - SQL Server 儲存業務資料
   - 標準化的資料表結構
   - 外鍵關聯確保資料完整性

---

## 1. 前端實作共用模式

### 1.1 Razor View 標準結構

所有證書補換發服務的 View 都遵循以下結構：

```cshtml
@using ES.Models.Entities
@using ES.Models
@using ES.Commons;
@model ES.Models.ViewModels.Apply_{服務代碼}ViewModel
@{
    // 設定主版面配置
    Layout = "~/Views/Shared/_MainLayout.cshtml";

    // 設定頁面標題
    ViewBag.Title = "{服務名稱}";

    // 建立共用代碼清單模型
    ShareCodeListModel srcList = new ShareCodeListModel();
}

<!-- 引入 JavaScript 工具函式庫 -->
<script type="text/javascript" src="~/Scripts/utility.js"></script>

<!-- 表單主體 -->
@using (Html.BeginForm("PreView{服務代碼}", "Apply_{服務代碼}", FormMethod.Post,
    new { id = "main_form", @class = "form-horizontal", enctype = "multipart/form-data" }))
{
    <!-- 麵包屑導航 -->
    <div class="breadlink">...</div>

    <!-- 申辦步驟指示器 -->
    <div class="step_map">
        <ul>
            <li id="Apply_Tab" class="active">填寫申報表件並上傳檔案</li>
            <li id="PreView_Tab">預覽申辦表件</li>
            <li id="Pay_Tab">繳費</li>
            <li>完成申報</li>
        </ul>
    </div>

    <!-- 表單內容 -->
    <div class="tab-content">...</div>
}
```

### 1.2 共用表單欄位

所有服務都包含以下共用欄位：

#### 基本資訊區塊

- **申辦項目**：唯讀顯示服務名稱
- **申辦日期**：自動帶入當前日期（民國年格式）
- **申請人姓名**：從會員資料自動帶入
- **身分證字號**：從會員資料自動帶入
- **出生年月日**：從會員資料自動帶入（民國年格式）

#### 聯絡資訊區塊

- **行動電話**：10 碼手機號碼
- **電話**：區碼 + 號碼 + 分機
- **Email**：帳號 + 網域（支援常用網域下拉選單）
- **通訊地址**：縣市鄉鎮（下拉選單）+ 詳細地址

#### 證書資訊區塊（服務專屬）

- **補換發類型**：補發 / 換發（單選）
- **證書類別**：依服務不同而異（下拉選單）
- **證書字號**：字 + 號
- **核發日期**：民國年格式
- **補換發原因**：遺失 / 毀損 / 污損 / 變更姓名 / 其他
- **其他原因說明**：當選擇「其他」時必填

#### 附件上傳區塊

- **必要附件**：依服務不同而異
- **檔案格式限制**：PDF, JPG, PNG
- **檔案大小限制**：每個檔案最大 5MB

### 1.3 JavaScript 共用邏輯

#### 表單驗證

```javascript
// 必填欄位檢查
function validateForm() {
  // 檢查申請人資訊
  if (!$("#APPLY_NAME").val()) {
    alert("請輸入申請人姓名");
    return false;
  }

  // 檢查聯絡資訊
  if (!$("#MOBILE").val() && !$("#TEL_NO").val()) {
    alert("請至少填寫一種聯絡電話");
    return false;
  }

  // 檢查 Email 格式
  var email = $("#MAIL").val();
  if (!validateEmail(email)) {
    alert("Email 格式不正確");
    return false;
  }

  // 檢查證書資訊（服務專屬）
  // ...

  return true;
}
```

#### 檔案上傳處理

```javascript
// 檔案大小檢查
function checkFileSize(fileInput, maxSize) {
  var file = fileInput.files[0];
  if (file && file.size > maxSize * 1024 * 1024) {
    alert("檔案大小不可超過 " + maxSize + "MB");
    fileInput.value = "";
    return false;
  }
  return true;
}

// 檔案格式檢查
function checkFileType(fileInput, allowedTypes) {
  var file = fileInput.files[0];
  if (file) {
    var ext = file.name.split(".").pop().toLowerCase();
    if (allowedTypes.indexOf(ext) === -1) {
      alert("只接受 " + allowedTypes.join(", ") + " 格式");
      fileInput.value = "";
      return false;
    }
  }
  return true;
}
```

#### Email 網域處理

```javascript
// Email 網域下拉選單變更
$("#DOMAINList").change(function () {
  var domain = "";
  switch ($(this).val()) {
    case "1":
      domain = "gmail.com";
      break;
    case "2":
      domain = "yahoo.com.tw";
      break;
    case "3":
      domain = "outlook.com";
      break;
    case "0":
      domain = "";
      break;
  }
  $("#MAIL_DOMAIN").val(domain);
  updateEmail();
});

// 更新完整 Email
function updateEmail() {
  var account = $("#MAIL_ACCOUNT").val();
  var domain = $("#MAIL_DOMAIN").val();
  if (account && domain) {
    $("#MAIL").val(account + "@" + domain);
  }
}
```

#### 地址選擇處理

```javascript
// 縣市鄉鎮選擇
$("#CITY_CODE").change(function () {
  var selectedText = $(this).find("option:selected").text();
  $("#CITY_TEXT").val(selectedText);
});
```

---

## 2. 後端 Controller 共用模式

### 2.1 Controller 標準結構

所有證書補換發服務的 Controller 都包含以下標準結構：

```csharp
using System;
using System.Web.Mvc;
using ES.Models.ViewModels;
using ES.Commons;
using ES.DataLayers;
using ES.Action.Form;

namespace ES.Controllers
{
    /// <summary>
    /// {服務名稱}控制器
    /// 繼承 BaseController：提供登入驗證、Session 管理等基礎功能
    /// </summary>
    public class Apply_{服務代碼}Controller : BaseController
    {
        // 服務代碼：用於識別此服務
        public static string s_SRV_ID = "{服務代碼}";

        // 服務名稱：顯示在頁面標題和通知信件中
        public static string s_SRV_NAME = "{服務名稱}";

        // 標準 Action Methods
        public ActionResult Prompt() { ... }
        public ActionResult Index() { ... }
        public ActionResult Apply() { ... }
        public ActionResult PreView{服務代碼}() { ... }
        public ActionResult Pay{服務代碼}() { ... }
        public ActionResult SaveAndPay{服務代碼}() { ... }
        public ActionResult QueryBack{服務代碼}() { ... }
        public ActionResult SaveBack{服務代碼}() { ... }
    }
}
```

### 2.2 標準 Action Methods

#### Prompt() - 服務說明頁面

```csharp
/// <summary>
/// 顯示服務說明頁面
/// 使用者必須先閱讀並同意說明事項，才能進入申辦頁面
/// </summary>
public ActionResult Prompt()
{
    SessionModel sm = SessionModel.Get();
    string s_msg_1A = "請先閱讀 「{0}說明事項」點選同意後，再進入申辦頁面 !";
    sm.LastErrorMessage = string.Format(s_msg_1A, s_SRV_NAME);
    return View("Prompt{服務代碼}");
}
```

#### Apply() - 申請表單初始化

```csharp
/// <summary>
/// 申請頁面：初始化申辦表單
/// 從會員資料自動帶入申請人資訊
/// </summary>
public ActionResult Apply(Apply_{服務代碼}ViewModel model)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    // 從會員資料帶入基本資訊
    model.APPLY_NAME = sm.NAME;
    model.APPLY_PID = sm.IDN;
    model.BIRTHDAY_AC = sm.BIRTHDAY_AC;
    model.APPLY_DATE = DateTime.Now.ToTaiwanDate("yyy/MM/dd");

    // 帶入聯絡資訊
    model.MOBILE = sm.MOBILE;
    model.TEL_SEC = sm.TEL_SEC;
    model.TEL_NO = sm.TEL_NO;
    model.TEL_EXT = sm.TEL_EXT;
    model.MAIL = sm.MAIL;

    // 帶入地址資訊
    model.CITY_CODE = sm.CITY_CODE;
    model.CITY_TEXT = sm.CITY_TEXT;
    model.CITY_DETAIL = sm.CITY_DETAIL;

    return View("Apply", model);
}
```

#### PreView() - 預覽功能

```csharp
/// <summary>
/// 預覽功能：顯示使用者填寫的資料供確認
/// </summary>
[HttpPost]
public ActionResult PreView{服務代碼}(Apply_{服務代碼}ViewModel model)
{
    SessionModel sm = SessionModel.Get();

    // 驗證必填欄位
    if (string.IsNullOrEmpty(model.APPLY_NAME))
    {
        sm.LastErrorMessage = "申請人姓名為必填";
        return View("Apply", model);
    }

    // 組合完整 Email
    if (!string.IsNullOrEmpty(model.MAIL_ACCOUNT) && !string.IsNullOrEmpty(model.MAIL_DOMAIN))
    {
        model.MAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN;
    }

    // 組合完整地址
    model.ADDRESS = model.CITY_TEXT + model.CITY_DETAIL;

    // 處理檔案上傳
    // ...

    return View("PreView", model);
}
```

#### Pay() - 繳費頁面

```csharp
/// <summary>
/// 繳費頁面：顯示繳費資訊和繳費方式選擇
/// </summary>
[HttpPost]
public ActionResult Pay{服務代碼}(Apply_{服務代碼}ViewModel model)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    // 取得繳費金額設定
    var payConfig = dao.GetPayConfig(s_SRV_ID);
    model.PAY_AMOUNT = payConfig.AMOUNT;
    model.PAY_DEADLINE = payConfig.DEADLINE;

    return View("Pay", model);
}
```

#### SaveAndPay() - 儲存並繳費

```csharp
/// <summary>
/// 儲存申請資料並導向繳費
/// </summary>
[HttpPost]
public ActionResult SaveAndPay{服務代碼}(Apply_{服務代碼}ViewModel model)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    using (SqlConnection conn = new SqlConnection(connectionString))
    {
        conn.Open();
        using (SqlTransaction trans = conn.BeginTransaction())
        {
            try
            {
                // 1. 產生申請案號
                string appId = dao.GenerateAppId(s_SRV_ID);
                model.APP_ID = appId;

                // 2. 儲存 APPLY 主表
                dao.InsertApply(model, sm, trans);

                // 3. 儲存服務明細表 APPLY_{服務代碼}
                dao.InsertApply{服務代碼}(model, trans);

                // 4. 儲存附件資料 APPLY_FILE
                dao.InsertApplyFiles(model.Files, appId, trans);

                // 5. 建立繳費記錄 APPLY_PAY
                dao.InsertApplyPay(appId, model.PAY_AMOUNT, trans);

                // 6. 寄送通知信
                dao.SendMail_New(sm.NAME, sm.MAIL, appId, s_SRV_NAME, s_SRV_ID);

                // 7. 提交交易
                trans.Commit();

                // 8. 導向繳費頁面
                return RedirectToPaymentGateway(appId);
            }
            catch (Exception ex)
            {
                trans.Rollback();
                logger.Error(ex);
                sm.LastErrorMessage = "儲存失敗：" + ex.Message;
                return View("Apply", model);
            }
        }
    }
}
```

#### QueryBack() - 補件查詢

```csharp
/// <summary>
/// 補件查詢：查詢需要補件的申請案
/// </summary>
public ActionResult QueryBack{服務代碼}(string appId)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    // 查詢申請案資料
    var model = dao.QueryApply_{服務代碼}(appId);

    // 檢查權限：只能查詢自己的案件
    if (model.ACC_NO != sm.ACC_NO)
    {
        sm.LastErrorMessage = "您無權限查看此申請案";
        return RedirectToAction("Index", "Service");
    }

    // 檢查案件狀態：只有「待補件」狀態才能補件
    if (model.FLOW_CD != "03")
    {
        sm.LastErrorMessage = "此案件目前不需要補件";
        return RedirectToAction("Index", "Service");
    }

    return View("ApplyBack", model);
}
```

#### SaveBack() - 儲存補件

```csharp
/// <summary>
/// 儲存補件資料
/// </summary>
[HttpPost]
public ActionResult SaveBack{服務代碼}(Apply_{服務代碼}ViewModel model)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    using (SqlConnection conn = new SqlConnection(connectionString))
    {
        conn.Open();
        using (SqlTransaction trans = conn.BeginTransaction())
        {
            try
            {
                // 1. 更新服務明細表
                dao.UpdateApply{服務代碼}(model, trans);

                // 2. 儲存新上傳的附件
                dao.InsertApplyFiles(model.NewFiles, model.APP_ID, trans);

                // 3. 更新案件狀態為「補件完成」
                dao.UpdateApplyStatus(model.APP_ID, "04", trans);

                // 4. 寄送補件完成通知信
                dao.SendMail_Update(sm.NAME, sm.MAIL, model.APP_ID, s_SRV_NAME, s_SRV_ID, "1");

                // 5. 提交交易
                trans.Commit();

                sm.LastSuccessMessage = "補件完成";
                return RedirectToAction("Index", "Service");
            }
            catch (Exception ex)
            {
                trans.Rollback();
                logger.Error(ex);
                sm.LastErrorMessage = "補件失敗：" + ex.Message;
                return View("ApplyBack", model);
            }
        }
    }
}
```

---

## 3. 資料存取層 (DAO) 共用模式

### 3.1 查詢申請案資料

所有服務都使用類似的查詢方法：

```csharp
/// <summary>
/// 查詢申請案資料（含主表和明細表）
/// </summary>
public Apply_{服務代碼}ViewModel QueryApply_{服務代碼}(string appId)
{
    string sql = @"
        SELECT
            a.*,
            d.*
        FROM APPLY a
        INNER JOIN APPLY_{服務代碼} d ON a.APP_ID = d.APP_ID
        WHERE a.APP_ID = @APP_ID
          AND a.DEL_MK = 'N'
    ";

    using (var conn = new SqlConnection(connectionString))
    {
        var result = conn.Query<Apply_{服務代碼}ViewModel>(sql, new { APP_ID = appId }).FirstOrDefault();

        // 查詢附件清單
        if (result != null)
        {
            result.Files = QueryApplyFiles(appId);
        }

        return result;
    }
}
```

### 3.2 儲存申請資料

#### 儲存主表 (APPLY)

```csharp
/// <summary>
/// 新增申請案主表資料
/// </summary>
public void InsertApply(Apply_{服務代碼}ViewModel model, SessionModel sm, SqlTransaction trans)
{
    string sql = @"
        INSERT INTO APPLY (
            APP_ID, SRV_ID, ACC_NO, IDN, NAME, BIRTHDAY,
            MOBILE, TEL_SEC, TEL_NO, TEL_EXT, EMAIL,
            CITY_CODE, CITY_TEXT, CITY_DETAIL, ADDRESS,
            FLOW_CD, APPLY_DATE, IP,
            ADD_TIME, ADD_FUN_CD, ADD_ACC
        ) VALUES (
            @APP_ID, @SRV_ID, @ACC_NO, @IDN, @NAME, @BIRTHDAY,
            @MOBILE, @TEL_SEC, @TEL_NO, @TEL_EXT, @EMAIL,
            @CITY_CODE, @CITY_TEXT, @CITY_DETAIL, @ADDRESS,
            '01', @APPLY_DATE, @IP,
            GETDATE(), 'WEB-APPLY', @ACC_NO
        )
    ";

    trans.Connection.Execute(sql, new
    {
        APP_ID = model.APP_ID,
        SRV_ID = s_SRV_ID,
        ACC_NO = sm.ACC_NO,
        IDN = model.APPLY_PID,
        NAME = model.APPLY_NAME,
        BIRTHDAY = model.BIRTHDAY_AC,
        MOBILE = model.MOBILE,
        TEL_SEC = model.TEL_SEC,
        TEL_NO = model.TEL_NO,
        TEL_EXT = model.TEL_EXT,
        EMAIL = model.MAIL,
        CITY_CODE = model.CITY_CODE,
        CITY_TEXT = model.CITY_TEXT,
        CITY_DETAIL = model.CITY_DETAIL,
        ADDRESS = model.ADDRESS,
        APPLY_DATE = model.APPLY_DATE,
        IP = GetClientIP()
    }, trans);
}
```

#### 儲存明細表 (APPLY\_{服務代碼})

```csharp
/// <summary>
/// 新增服務明細表資料
/// 此方法在各服務的 DAO 中實作，欄位依服務而異
/// </summary>
public void InsertApply{服務代碼}(Apply_{服務代碼}ViewModel model, SqlTransaction trans)
{
    // 服務專屬實作
    // 參考各服務的專屬文件
}
```

#### 儲存附件資料 (APPLY_FILE)

```csharp
/// <summary>
/// 儲存附件檔案資料
/// </summary>
public void InsertApplyFiles(List<ApplyFileModel> files, string appId, SqlTransaction trans)
{
    string sql = @"
        INSERT INTO APPLY_FILE (
            APP_ID, FILE_SEQ, FILE_TYPE, FILE_NAME, FILE_PATH, FILE_SIZE,
            ADD_TIME, ADD_FUN_CD, ADD_ACC
        ) VALUES (
            @APP_ID, @FILE_SEQ, @FILE_TYPE, @FILE_NAME, @FILE_PATH, @FILE_SIZE,
            GETDATE(), 'WEB-APPLY', @ADD_ACC
        )
    ";

    foreach (var file in files)
    {
        trans.Connection.Execute(sql, new
        {
            APP_ID = appId,
            FILE_SEQ = file.FILE_SEQ,
            FILE_TYPE = file.FILE_TYPE,
            FILE_NAME = file.FILE_NAME,
            FILE_PATH = file.FILE_PATH,
            FILE_SIZE = file.FILE_SIZE,
            ADD_ACC = file.ADD_ACC
        }, trans);
    }
}
```

---

## 4. 資料庫結構共用模式

### 4.1 APPLY 資料表（申請案主表）

**用途：** 儲存所有線上申辦服務的共用資料，每個申請案一筆記錄。

**共用欄位結構：**

| 欄位名稱    | 資料型別 | 長度 | NULL     | 說明                 | 範例值                  |
| ----------- | -------- | ---- | -------- | -------------------- | ----------------------- |
| APP_ID      | varchar  | 20   | NOT NULL | 申請案號（PK）       | 001005202501130001      |
| SRV_ID      | varchar  | 6    | NOT NULL | 服務代碼             | 001005                  |
| ACC_NO      | varchar  | 20   | NULL     | 會員帳號             | M000001234              |
| IDN         | varchar  | 10   | NULL     | 身分證字號           | A123456789              |
| NAME        | nvarchar | 50   | NULL     | 申請人姓名           | 王小明                  |
| BIRTHDAY    | varchar  | 7    | NULL     | 出生年月日（民國年） | 0800101                 |
| MOBILE      | varchar  | 10   | NULL     | 行動電話             | 0912345678              |
| TEL_SEC     | varchar  | 4    | NULL     | 電話區碼             | 02                      |
| TEL_NO      | varchar  | 10   | NULL     | 電話號碼             | 12345678                |
| TEL_EXT     | varchar  | 6    | NULL     | 電話分機             | 123                     |
| EMAIL       | varchar  | 100  | NULL     | Email                | test@gmail.com          |
| CITY_CODE   | varchar  | 5    | NULL     | 縣市鄉鎮代碼         | 100                     |
| CITY_TEXT   | nvarchar | 50   | NULL     | 縣市鄉鎮名稱         | 台北市中正區            |
| CITY_DETAIL | nvarchar | 200  | NULL     | 詳細地址             | 中山路 1 號             |
| ADDRESS     | nvarchar | 250  | NULL     | 完整地址             | 台北市中正區中山路 1 號 |
| FLOW_CD     | varchar  | 2    | NULL     | 案件狀態代碼         | 01                      |
| APPLY_DATE  | varchar  | 10   | NULL     | 申請日期（民國年）   | 114/01/13               |
| IP          | varchar  | 50   | NULL     | 申請人 IP 位址       | 192.168.1.1             |
| DEL_MK      | varchar  | 1    | NULL     | 刪除標記             | N                       |
| DEL_TIME    | datetime | -    | NULL     | 刪除時間             | NULL                    |
| DEL_FUN_CD  | varchar  | 20   | NULL     | 刪除功能代碼         | NULL                    |
| DEL_ACC     | varchar  | 20   | NULL     | 刪除帳號             | NULL                    |
| UPD_TIME    | datetime | -    | NULL     | 更新時間             | 2025-01-13 10:30:00     |
| UPD_FUN_CD  | varchar  | 20   | NULL     | 更新功能代碼         | WEB-APPLY               |
| UPD_ACC     | varchar  | 20   | NULL     | 更新帳號             | M000001234              |
| ADD_TIME    | datetime | -    | NOT NULL | 新增時間             | 2025-01-13 10:30:00     |
| ADD_FUN_CD  | varchar  | 20   | NULL     | 新增功能代碼         | WEB-APPLY               |
| ADD_ACC     | varchar  | 20   | NULL     | 新增帳號             | M000001234              |

**案件狀態代碼 (FLOW_CD)：**

| 代碼 | 說明       | 備註                   |
| ---- | ---------- | ---------------------- |
| 01   | 待繳費     | 申請完成，等待繳費     |
| 02   | 審核中     | 已繳費，承辦人審核中   |
| 03   | 待補件     | 需要補件               |
| 04   | 補件完成   | 補件完成，重新審核     |
| 05   | 審核通過   | 審核通過，準備核發證書 |
| 06   | 審核不通過 | 審核不通過             |
| 07   | 已結案     | 案件完成               |

### 4.2 APPLY\_{服務代碼} 資料表（服務明細表）

**用途：** 儲存各服務專屬的資料，每個服務有自己的明細表。

**共用欄位模式：**

| 欄位名稱    | 資料型別 | 說明               | 備註                     |
| ----------- | -------- | ------------------ | ------------------------ |
| APP_ID      | varchar  | 申請案號（PK, FK） | 關聯到 APPLY.APP_ID      |
| ACTION_TYPE | varchar  | 補換發類型         | 1=補發, 2=換發           |
| ISSUE_DATE  | datetime | 證書發證日期       | 原證書的發證日期         |
| LIC_CD      | varchar  | 證書字號（字）     | 如：醫師、專醫           |
| LIC_NUM     | varchar  | 證書字號（號）     | 數字編號                 |
| ACTION_RES  | varchar  | 補換發原因         | 01=遺失, 02=毀損, 等     |
| OTHER_RES   | nvarchar | 其他原因說明       | 當 ACTION_RES=其他時填寫 |
| EMAIL       | varchar  | Email              | 申請人 Email             |
| DEL_MK      | varchar  | 刪除標記           | Y/N                      |
| DEL_TIME    | datetime | 刪除時間           | -                        |
| DEL_FUN_CD  | varchar  | 刪除功能代碼       | -                        |
| DEL_ACC     | varchar  | 刪除帳號           | -                        |
| UPD_TIME    | datetime | 更新時間           | -                        |
| UPD_FUN_CD  | varchar  | 更新功能代碼       | -                        |
| UPD_ACC     | varchar  | 更新帳號           | -                        |
| ADD_TIME    | datetime | 新增時間           | -                        |
| ADD_FUN_CD  | varchar  | 新增功能代碼       | -                        |
| ADD_ACC     | varchar  | 新增帳號           | -                        |

**服務專屬欄位：** 參考各服務的專屬文件

### 4.3 APPLY_PAY 資料表（繳費資訊表）

**用途：** 儲存申請案的繳費資訊。

| 欄位名稱     | 資料型別 | 長度 | NULL     | 說明               | 範例值              |
| ------------ | -------- | ---- | -------- | ------------------ | ------------------- |
| APP_ID       | varchar  | 20   | NOT NULL | 申請案號（PK, FK） | 001005202501130001  |
| PAY_AMOUNT   | int      | -    | NULL     | 繳費金額           | 200                 |
| PAY_STATUS   | varchar  | 2    | NULL     | 繳費狀態           | 01=未繳, 02=已繳    |
| PAY_DATE     | datetime | -    | NULL     | 繳費日期           | 2025-01-13 11:00:00 |
| PAY_METHOD   | varchar  | 2    | NULL     | 繳費方式           | 01=信用卡, 02=ATM   |
| PAY_DEADLINE | datetime | -    | NULL     | 繳費期限           | 2025-01-20 23:59:59 |
| TRADE_NO     | varchar  | 50   | NULL     | 交易序號           | T20250113110000001  |
| ADD_TIME     | datetime | -    | NOT NULL | 新增時間           | 2025-01-13 10:30:00 |
| ADD_FUN_CD   | varchar  | 20   | NULL     | 新增功能代碼       | WEB-APPLY           |
| ADD_ACC      | varchar  | 20   | NULL     | 新增帳號           | M000001234          |

### 4.4 APPLY_FILE 資料表（附件檔案表）

**用途：** 儲存申請案的附件檔案資訊。

| 欄位名稱   | 資料型別 | 長度 | NULL     | 說明               | 範例值                      |
| ---------- | -------- | ---- | -------- | ------------------ | --------------------------- |
| APP_ID     | varchar  | 20   | NOT NULL | 申請案號（PK, FK） | 001005202501130001          |
| FILE_SEQ   | int      | -    | NOT NULL | 檔案序號（PK）     | 1                           |
| FILE_TYPE  | varchar  | 2    | NULL     | 檔案類型代碼       | 01=身分證, 02=證書, 03=其他 |
| FILE_NAME  | nvarchar | 200  | NULL     | 檔案名稱           | 身分證正面.jpg              |
| FILE_PATH  | varchar  | 500  | NULL     | 檔案路徑           | /uploads/2025/01/xxx.jpg    |
| FILE_SIZE  | int      | -    | NULL     | 檔案大小（bytes）  | 1024000                     |
| ADD_TIME   | datetime | -    | NOT NULL | 新增時間           | 2025-01-13 10:30:00         |
| ADD_FUN_CD | varchar  | 20   | NULL     | 新增功能代碼       | WEB-APPLY                   |
| ADD_ACC    | varchar  | 20   | NULL     | 新增帳號           | M000001234                  |

---

## 5. 完整流程圖

### 5.1 申請流程圖

```
使用者登入
    ↓
閱讀服務說明（Prompt）
    ↓
填寫申請表單（Apply）
    ↓
預覽申請資料（PreView）
    ↓
選擇繳費方式（Pay）
    ↓
儲存資料並繳費（SaveAndPay）
    ↓
導向繳費閘道
    ↓
繳費完成回傳
    ↓
更新繳費狀態
    ↓
寄送申請完成通知信
    ↓
案件進入審核流程
```

### 5.2 補件流程圖

```
使用者登入
    ↓
查詢待補件案件（QueryBack）
    ↓
檢查權限（是否為申請人）
    ↓
檢查案件狀態（是否為待補件）
    ↓
顯示補件表單
    ↓
填寫補件資料
    ↓
上傳補件附件
    ↓
儲存補件資料（SaveBack）
    ↓
更新案件狀態為「補件完成」
    ↓
寄送補件完成通知信
    ↓
案件重新進入審核流程
```

### 5.3 資料流程圖

```
前端表單
    ↓ (POST)
Controller.PreView()
    ↓ (驗證資料)
Controller.Pay()
    ↓ (選擇繳費方式)
Controller.SaveAndPay()
    ↓ (開始 Transaction)
DAO.InsertApply() → APPLY 資料表
    ↓
DAO.InsertApply{服務代碼}() → APPLY_{服務代碼} 資料表
    ↓
DAO.InsertApplyFiles() → APPLY_FILE 資料表
    ↓
DAO.InsertApplyPay() → APPLY_PAY 資料表
    ↓
DAO.SendMail_New() → 寄送通知信
    ↓ (Commit Transaction)
導向繳費閘道
```

### 5.4 案件狀態轉換圖

```
[申請完成] → 01 待繳費
    ↓ (繳費完成)
02 審核中
    ↓ (需要補件)
03 待補件
    ↓ (補件完成)
04 補件完成 → 02 審核中
    ↓ (審核通過)
05 審核通過
    ↓ (核發證書)
07 已結案

或

02 審核中
    ↓ (審核不通過)
06 審核不通過 → 07 已結案
```

---

## 6. ViewModel 與 Entity 共用模式

### 6.1 ViewModel 標準結構

所有服務的 ViewModel 都繼承自對應的 Entity Model，並擴充前端顯示所需的屬性：

```csharp
/// <summary>
/// {服務名稱} ViewModel
/// 繼承自 Apply_{服務代碼}Model (Entity)，並擴充前端顯示所需的屬性
/// </summary>
public class Apply_{服務代碼}ViewModel : Apply_{服務代碼}Model
{
    #region 基本資料（從會員資料帶入）

    public string APPLY_NAME { get; set; }      // 申請人姓名
    public string APPLY_PID { get; set; }       // 身分證字號
    public string BIRTHDAY_AC { get; set; }     // 出生年月日（民國年）
    public string APPLY_DATE { get; set; }      // 申請日期（民國年）

    #endregion

    #region 聯絡資訊

    public string MOBILE { get; set; }          // 行動電話
    public string TEL_SEC { get; set; }         // 電話區碼
    public string TEL_NO { get; set; }          // 電話號碼
    public string TEL_EXT { get; set; }         // 電話分機

    #endregion

    #region Email 處理

    public string MAIL_ACCOUNT { get; set; }    // Email 帳號
    public string MAIL_DOMAIN { get; set; }     // Email 網域
    public string DOMAINList { get; set; }      // Email 網域下拉選單值
    public string MAIL { get; set; }            // 完整 Email

    #endregion

    #region 地址資訊

    public string CITY_CODE { get; set; }       // 縣市鄉鎮代碼
    public string CITY_TEXT { get; set; }       // 縣市鄉鎮名稱
    public string CITY_DETAIL { get; set; }     // 詳細地址
    public string ADDRESS { get; set; }         // 完整地址

    #endregion

    #region 附件資訊

    public List<ApplyFileModel> Files { get; set; }     // 附件清單
    public HttpPostedFileBase File1 { get; set; }       // 上傳檔案1
    public HttpPostedFileBase File2 { get; set; }       // 上傳檔案2
    // ... 更多檔案欄位

    #endregion

    #region 繳費資訊

    public int PAY_AMOUNT { get; set; }         // 繳費金額
    public DateTime PAY_DEADLINE { get; set; }  // 繳費期限
    public string PAY_METHOD { get; set; }      // 繳費方式

    #endregion

    #region 服務專屬欄位

    // 參考各服務的專屬文件

    #endregion
}
```

### 6.2 Entity Model 標準結構

Entity Model 對應資料庫的 APPLY\_{服務代碼} 資料表：

```csharp
/// <summary>
/// {服務名稱} Entity Model
/// 對應資料表：APPLY_{服務代碼}
/// </summary>
public class Apply_{服務代碼}Model
{
    public string APP_ID { get; set; }          // 申請案號（PK, FK）
    public string ACTION_TYPE { get; set; }     // 補換發類型
    public DateTime? ISSUE_DATE { get; set; }   // 證書發證日期
    public string LIC_CD { get; set; }          // 證書字號（字）
    public string LIC_NUM { get; set; }         // 證書字號（號）
    public string ACTION_RES { get; set; }      // 補換發原因
    public string OTHER_RES { get; set; }       // 其他原因說明
    public string EMAIL { get; set; }           // Email

    // 服務專屬欄位
    // ...

    // 標準欄位
    public string DEL_MK { get; set; }
    public DateTime? DEL_TIME { get; set; }
    public string DEL_FUN_CD { get; set; }
    public string DEL_ACC { get; set; }
    public DateTime? UPD_TIME { get; set; }
    public string UPD_FUN_CD { get; set; }
    public string UPD_ACC { get; set; }
    public DateTime ADD_TIME { get; set; }
    public string ADD_FUN_CD { get; set; }
    public string ADD_ACC { get; set; }
}
```

---

## 7. 技術重點總結

### 7.1 安全性機制

1. **登入驗證**

   - 繼承 `BaseController`，自動檢查使用者登入狀態
   - 支援多種登入方式：帳號密碼、自然人憑證、工商憑證、醫事憑證
   - Session 管理：使用 `SessionModel` 儲存使用者資訊

2. **權限控管**

   - 補件功能檢查申請人身份：比對 `ACC_NO`（會員帳號）
   - 防止他人查看或修改非本人的申請案

3. **資料驗證**

   - 前端驗證：JavaScript 檢查必填欄位、格式正確性
   - 後端驗證：使用 Data Annotations 進行二次驗證
   - SQL Injection 防護：使用參數化查詢

4. **交易安全**
   - 記錄使用者 IP 位址：用於安全稽核
   - 信用卡資訊加密：敏感資訊不儲存明碼
   - HTTPS 加密傳輸：保護資料傳輸安全

### 7.2 資料一致性

1. **Transaction 處理**

   - 使用 `SqlTransaction` 確保資料一致性
   - 多表更新時，全部成功或全部失敗
   - 錯誤時自動 Rollback，避免資料不一致

2. **歷程記錄**

   - 使用 `Update2()` 方法自動記錄資料變更歷程
   - 記錄變更時間、功能代碼、人員帳號
   - 便於追蹤資料變更軌跡

3. **資料完整性**
   - 外鍵關聯：APPLY\_{服務代碼}.APP_ID → APPLY.APP_ID
   - 必填欄位檢查：確保重要資料不為空
   - 資料格式驗證：確保資料符合規範

### 7.3 使用者體驗

1. **自動帶入資料**

   - 從會員資料自動填入申請人資訊
   - 減少使用者輸入，提升便利性
   - 降低輸入錯誤的機率

2. **即時回饋**

   - AJAX 技術：不重新載入頁面即可更新內容
   - 即時驗證：填寫時即時檢查欄位正確性
   - 錯誤提示：明確的錯誤訊息，協助使用者修正

3. **流程引導**

   - 分步驟進行：填寫 → 預覽 → 繳費 → 完成
   - 預覽功能：送出前確認資料正確性
   - 進度提示：清楚顯示目前進度

4. **通知機制**
   - Email 通知：申請完成、補件完成自動寄送通知信
   - 案件狀態查詢：隨時查詢案件處理進度

### 7.4 效能優化

1. **資料庫存取**

   - 使用 Dapper ORM：比 Entity Framework 更輕量、效能更好
   - 參數化查詢：提升查詢效能，防止 SQL Injection
   - 適當的索引：在主鍵、外鍵欄位建立索引

2. **前端優化**

   - PartialView：只更新部分頁面，減少資料傳輸
   - AJAX 非同步請求：不阻塞使用者操作
   - 快取機制：常用資料（如下拉選單）使用快取

3. **程式碼優化**
   - ValueInjecter：自動複製物件屬性，減少程式碼
   - Extension Methods：擴充方法提升程式碼可讀性
   - 適當的錯誤處理：避免程式崩潰

### 7.5 維護性

1. **程式碼結構**

   - 分層架構：Presentation → Controller → DAO → Database
   - 職責分離：每層負責特定功能，易於維護
   - 命名規範：統一的命名規則，易於理解

2. **註解文件**

   - XML 註解：詳細說明類別、方法、屬性的用途
   - 程式碼註解：關鍵邏輯加上註解說明
   - 技術文件：完整的系統文件，便於交接

3. **錯誤處理**

   - 統一的錯誤處理機制
   - 詳細的錯誤日誌：使用 logger 記錄錯誤
   - 友善的錯誤訊息：提供使用者明確的錯誤說明

4. **可擴充性**
   - 模組化設計：新增服務時可重用現有程式碼
   - 設定檔管理：重要參數使用設定檔，易於調整
   - 版本控管：使用 Git 進行版本控管

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
