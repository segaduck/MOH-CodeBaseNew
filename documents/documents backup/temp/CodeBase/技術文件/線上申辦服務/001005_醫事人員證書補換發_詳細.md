# 001005 - 醫事人員或公共衛生師證書補(換)發 - 全端功能詳細說明

## 功能概述

本文以「醫事人員或公共衛生師證書補(換)發（001005）」為例，詳細說明從前端到後端的完整全端開發流程。此功能涵蓋了證書補換發申請的建立、預覽、繳費、補件等完整業務流程。

### 服務基本資訊

| 項目         | 內容                                                     |
| ------------ | -------------------------------------------------------- |
| 服務代碼     | 001005                                                   |
| 服務名稱     | 醫事人員或公共衛生師證書補(換)發                         |
| 業務單位     | 醫事司                                                   |
| 是否需繳費   | 是                                                       |
| 申請對象     | 已取得醫事人員或公共衛生師證書者                         |
| Controller   | `ES/Controllers/Apply_001005Controller.cs` (368 行)      |
| ViewModel    | `ES/Models/ViewModels/Apply_001005ViewModel.cs` (216 行) |
| Entity Model | `ES/Models/Entities/Apply_001005Model.cs` (121 行)       |
| DAO 方法     | `ApplyDAO.QueryApply_001005()`, `SaveAppDoc001005()`     |
| 主要資料表   | `APPLY`, `APPLY_001005`, `APPLY_FILE`, `APPLY_PAY`       |

## 系統架構層次

```
前端 Razor Views + jQuery
    ↓ HTTP POST/GET 請求
後端 ASP.NET MVC Controller
    ↓ 業務邏輯處理
資料存取層 (DAO - Dapper)
    ↓ SQL 查詢/異動
SQL Server 資料庫
```

## 1. 前端實作詳解

### 1.1 Razor View 結構

**檔案位置：** `ES/Views/Apply_001005/Apply.cshtml` (512 行)

```cshtml
@using ES.Models.Entities
@using ES.Models
@using ES.Commons;
@model ES.Models.ViewModels.Apply_001005ViewModel
@{
    // 設定主版面配置：使用共用的主版面
    Layout = "~/Views/Shared/_MainLayout.cshtml";

    // 設定頁面標題：顯示在瀏覽器標籤頁
    ViewBag.Title = "醫事人員或公共衛生師證書補(換)發";

    // 建立共用代碼清單模型：用於下拉選單資料來源
    ShareCodeListModel srcList = new ShareCodeListModel();
}

<!-- 引入 JavaScript 工具函式庫 -->
<script type="text/javascript" src="~/Scripts/utility.js"></script>

<!-- 使用 Html.BeginForm 建立表單 -->
<!-- FormMethod.Post：使用 POST 方法送出 -->
<!-- enctype="multipart/form-data"：支援檔案上傳 -->
@using (Html.BeginForm("PreView001005", "Apply_001005", FormMethod.Post,
    new { id = "main_form", @class = "form-horizontal", enctype = "multipart/form-data" }))
{
    <div class="container">
        <div class="col-sm-12">
            <!-- 麵包屑導航：顯示當前頁面在網站結構中的位置 -->
            <div class="breadlink">
                <i class="fas fa-home"></i>
                <a href="@(Url.Action("Index", "Login"))">首頁</a> ／
                <a href="@(Url.Action("Index", "Service"))">申辦服務</a> ／
                <a href="#">醫事人員或公共衛生師證書補(換)發</a>
            </div>

            <!-- 申辦步驟指示器：顯示當前在哪個步驟 -->
            <div class="step_map">
                <ul>
                    <li id="Apply_Tab" class="active">填寫申報表件並上傳檔案</li>
                    <li id="PreView_Tab">預覽申辦表件</li>
                    <li id="Pay_Tab">繳費</li>
                    <li>完成申報</li>
                </ul>
            </div>

            <!-- 表單內容區域 -->
            <div class="tab-content" id="myTabContent">
                <div id="ApplyForm" class="tab-pane fade active in">
                    <h1 class="form-title title-bg-y">申辦表件填寫</h1>
                    <div class="form-set">
                        <!-- 申辦項目：唯讀顯示 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">申辦項目</label>
                            <div class="col-sm-10">
                                <p class="form-control-static">醫事人員或公共衛生師證書補(換)發</p>
                            </div>
                        </div>

                        <!-- 申辦日期：從 Model 取得，唯讀顯示 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">申辦日期</label>
                            <div class="col-sm-4">
                                <p class="form-control-static">@Model.APPLY_DATE</p>
                                <!-- 使用 HiddenFor 保存資料，供後續送出使用 -->
                                @Html.HiddenFor(x => x.APPLY_DATE, new { @Value = @Model.APPLY_DATE })
                            </div>
                        </div>

                        <!-- 申請人資訊：從會員資料自動帶入，唯讀 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">
                                <span style="color:red;">*</span>申請人
                            </label>
                            <div class="col-sm-4">
                                <!-- TextBoxFor：產生文字輸入框，綁定到 Model.APPLY_NAME -->
                                <!-- readonly：設為唯讀，使用者無法修改 -->
                                @Html.TextBoxFor(x => x.APPLY_NAME,
                                    new { @class = "form-control",
                                          @placeholder = "請輸入申請人姓名",
                                          @readonly = "readonly" })
                                @Html.HiddenFor(x => x.APPLY_NAME)
                            </div>

                            <label class="step-label col-sm-2" for="">
                                <span style="color:red;">*</span>身分證編號/居留證號
                            </label>
                            <div class="col-sm-4">
                                @Html.TextBoxFor(x => x.APPLY_PID,
                                    new { @class = "form-control",
                                          @placeholder = "請輸入身分證編號/居留證號",
                                          @readonly = "readonly" })
                                @Html.HiddenFor(x => x.APPLY_PID)
                            </div>
                        </div>

                        <!-- 出生年月日：使用自訂的 DatePickerTWFor Helper -->
                        <!-- DatePickerTWFor：產生民國年日期選擇器 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">
                                <span style="color:red;">*</span>出生年月日
                            </label>
                            <div class="col-sm-4">
                                @Html.DatePickerTWFor(x => x.BIRTHDAY_AC,
                                    new { size = "10", @disabled = "disabled", @readonly = true })
                                @Html.HiddenFor(x => x.BIRTHDAY_AC)
                            </div>
                        </div>

                        <!-- 補(換)發選項：使用 Radio Button -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">
                                <span style="color:red;">*</span>補(換)發
                            </label>
                            <div class="col-sm-4" style="margin-top:10px">
                                <!-- Radio Button：補發/換發二選一 -->
                                <input type='radio' id="ActionTyp1" name='ActionTyp1' value='1' checked> 補發
                                <input type='radio' id="ActionTyp2" name='ActionTyp2' value='2'> 換發
                                <!-- 隱藏欄位：儲存選擇的值 -->
                                @Html.HiddenFor(x => x.ACTION_TYPE)
                                @Html.HiddenFor(x => x.ACTION_TYPE_TEXT)
                            </div>

                            <!-- 核發單位：下拉選單 -->
                            <label class="step-label col-sm-2" for="">核發單位</label>
                            <div class="col-sm-4">
                                <!-- DropDownListFor：產生下拉選單 -->
                                <!-- GetLicIssueDeptList：從 ShareCodeListModel 取得核發單位清單 -->
                                @Html.DropDownListFor(x => x.ISSUE_DEPT,
                                    srcList.GetLicIssueDeptList,
                                    new { @class = "form-control" })
                                @Html.HiddenFor(x => x.ISSUE_DEPT_TEXT)
                            </div>
                        </div>

                        <!-- 核發日期與證書類別 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">核發日期</label>
                            <div class="col-sm-4">
                                @Html.DatePickerTWFor(x => x.ISSUE_DATE_AC, new { size = "10" })
                            </div>

                            <label class="step-label col-sm-2" for="">
                                <span style="color:red;">*</span>證書類別
                            </label>
                            <div class="col-sm-4">
                                <!-- 證書類別下拉選單：排除專科護理師 (33, 34, 35) -->
                                @Html.DropDownListFor(x => x.DIVISION,
                                    srcList.GetLicNumCertMDList.Where(m =>
                                        m.Value != "33" && m.Value != "34" && m.Value != "35"),
                                    new { @class = "form-control" })
                                @Html.HiddenFor(x => x.DIVISION_TEXT)
                            </div>
                        </div>

                        <!-- 證書字號：動態下拉選單 + 文字輸入 -->
                        <div class="form-group">
                            <label class="step-label col-sm-2" for="">證書字號</label>
                            <div class="col-sm-10 form-inline">
                                <!-- 證書字號前綴：與證書類別連動 -->
                                @Html.DropDownListFor(x => x.LIC_CD,
                                    new List<SelectListItem>(),
                                    new { @class = "form-control" })
                                字第
                                <!-- 證書號碼：限制最多 6 位數字 -->
                                @Html.TextBoxFor(x => x.LIC_NUM,
                                    new { @class = "form-normal",
                                          @placeholder = "",
                                          maxlength = "6" })
                                號
                                @Html.HiddenFor(x => x.LIC_CD_TEXT)
                                @Html.HiddenFor(x => x.LIC_TYPE)
                            </div>
                        </div>
```

**程式碼說明：**

1. **Razor 語法**：使用 `@` 符號嵌入 C# 程式碼到 HTML 中
2. **Model 綁定**：透過 `@model` 指令指定頁面使用的 ViewModel 類型
3. **HTML Helper**：使用 `Html.TextBoxFor`、`Html.DropDownListFor` 等 Helper 方法產生表單元素
4. **自訂 Helper**：`Html.DatePickerTWFor` 是自訂的民國年日期選擇器
5. **資料綁定**：使用 Lambda 表達式 `x => x.APPLY_NAME` 綁定 Model 屬性
6. **唯讀欄位**：會員資料欄位設為 `readonly`，防止使用者修改
7. **隱藏欄位**：使用 `HiddenFor` 保存資料，供表單送出時使用

### 1.2 JavaScript 互動邏輯

**檔案位置：** `ES/Views/Apply_001005/Apply.cshtml` (JavaScript 區段)

```javascript
<script type="text/javascript">
    $(document).ready(function () {
        // 頁面載入完成後執行的初始化邏輯

        // 1. 證書類別變更事件：當使用者選擇證書類別時，動態載入對應的證書字號選項
        $("#DIVISION").change(function () {
            // 取得選擇的證書類別代碼
            var divisionCode = $(this).val();

            // 清空證書字號下拉選單
            $("#LIC_CD").empty();

            // 根據證書類別，透過 AJAX 取得對應的證書字號選項
            $.ajax({
                url: '@Url.Action("GetLicCdList", "AJAX")',  // API 端點
                type: 'POST',                                 // HTTP 方法
                data: { division: divisionCode },             // 送出的資料
                dataType: 'json',                             // 預期回應格式
                success: function (data) {
                    // 成功取得資料後，填入下拉選單
                    $.each(data, function (index, item) {
                        $("#LIC_CD").append(
                            $('<option></option>').val(item.Value).html(item.Text)
                        );
                    });
                },
                error: function (xhr, status, error) {
                    // 錯誤處理
                    alert('載入證書字號選項失敗：' + error);
                }
            });
        });

        // 2. 補(換)發選項變更事件
        $("input[name='ActionTyp1'], input[name='ActionTyp2']").change(function () {
            // 取得選擇的值：1=補發, 2=換發
            var actionType = $(this).val();

            // 更新隱藏欄位的值
            $("#ACTION_TYPE").val(actionType);

            // 更新文字說明
            if (actionType == '1') {
                $("#ACTION_TYPE_TEXT").val('補發');
            } else {
                $("#ACTION_TYPE_TEXT").val('換發');
            }
        });

        // 3. 表單驗證：送出前檢查必填欄位
        $("#btnSubmit").click(function (e) {
            e.preventDefault();  // 阻止預設的表單送出行為

            // 檢查必填欄位
            var isValid = true;
            var errorMsg = '';

            // 檢查證書類別
            if ($("#DIVISION").val() == '' || $("#DIVISION").val() == null) {
                isValid = false;
                errorMsg += '請選擇證書類別\n';
            }

            // 檢查證書字號
            if ($("#LIC_NUM").val() == '' || $("#LIC_NUM").val() == null) {
                isValid = false;
                errorMsg += '請輸入證書號碼\n';
            }

            // 檢查補換發原因
            if ($("#ACTION_RES").val() == '' || $("#ACTION_RES").val() == null) {
                isValid = false;
                errorMsg += '請選擇補(換)發原因\n';
            }

            // 如果驗證失敗，顯示錯誤訊息
            if (!isValid) {
                alert(errorMsg);
                return false;
            }

            // 驗證通過，送出表單到預覽頁面
            $("#main_form").attr('action', '@Url.Action("PreView", "Apply_001005")');
            $("#main_form").submit();
        });
    });
</script>
```

**程式碼說明：**

1. **jQuery 選擇器**：使用 `$()` 選取 DOM 元素
2. **事件綁定**：使用 `.change()` 和 `.click()` 綁定事件處理函式
3. **AJAX 呼叫**：使用 `$.ajax()` 向後端 API 請求資料，不重新載入頁面
4. **動態更新**：根據使用者選擇，動態更新下拉選單選項
5. **表單驗證**：在送出前檢查必填欄位，提供即時回饋
6. **事件阻止**：使用 `e.preventDefault()` 阻止預設行為，自訂送出邏輯

## 2. 後端 Controller 實作

### 2.1 Controller 結構

**檔案位置：** `ES/Controllers/Apply_001005Controller.cs` (368 行)

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using ES.Models;
using ES.Models.Entities;
using ES.Models.ViewModels;
using ES.Commons;
using ES.Services;
using System.ComponentModel;
using ES.DataLayers;
using Omu.ValueInjecter;
using System.Net.Mail;
using ES.Action;
using ES.Extensions;
using System.Data.SqlClient;
using ES.Action.Form;
using ES.Utils;
using HppApi;

namespace ES.Controllers
{
    /// <summary>
    /// 醫事人員或公共衛生師證書補(換)發控制器
    /// 繼承 BaseController：提供登入驗證、Session 管理等基礎功能
    /// </summary>
    public class Apply_001005Controller : BaseController
    {
        // 服務代碼：用於識別此服務
        public static string s_SRV_ID = "001005";

        // 服務名稱：顯示在頁面標題和通知信件中
        public static string s_SRV_NAME = "醫事人員或公共衛生師證書補(換)發";

        /// <summary>
        /// 顯示服務說明頁面
        /// 使用者必須先閱讀並同意說明事項，才能進入申辦頁面
        /// </summary>
        /// <returns>說明頁面 View</returns>
        public ActionResult Prompt()
        {
            // 從 Session 取得 SessionModel
            SessionModel sm = SessionModel.Get();

            // 設定提示訊息
            string s_msg_1A = "請先閱讀 「{0}說明事項」點選同意後，再進入申辦頁面 !";
            sm.LastErrorMessage = string.Format(s_msg_1A, s_SRV_NAME);

            // 回傳說明頁面 View
            return View("Prompt001005");
        }

        /// <summary>
        /// 首頁：顯示申辦表單
        /// </summary>
        /// <param name="model">ViewModel</param>
        /// <returns>申辦表單 View</returns>
        public ActionResult Index(Apply_001005ViewModel model)
        {
            return View();
        }

        /// <summary>
        /// 申請頁面：初始化申辦表單
        /// 從會員資料自動帶入申請人資訊
        /// </summary>
        /// <param name="agree">是否同意說明事項：1=同意, 其他=未同意</param>
        /// <returns>申辦表單 View 或登入頁面</returns>
        [DisplayName("Apply_001005_申請")]
        public ActionResult Apply(string agree)
        {
            // 建立 DAO 物件：用於資料存取
            ApplyDAO dao = new ApplyDAO();

            // 取得 Session 資料
            SessionModel sm = SessionModel.Get();

            // 建立 ViewModel
            Apply_001005ViewModel form = new Apply_001005ViewModel();

            // 預設回傳申辦表單頁面
            ActionResult rtn = View("Index", form);

            // 檢查使用者是否已登入
            if (sm == null || sm.UserInfo == null)
            {
                // 未登入：導向登入頁面
                rtn = RedirectToAction("Index", "Login");
                return rtn;
            }

            // 取得會員資料
            ClamMember mem = sm.UserInfo.Member;
            if (mem == null)
            {
                // 會員資料不存在：導向登入頁面
                rtn = RedirectToAction("Index", "Login");
                return rtn;
            }

            // 檢查是否同意說明事項
            // agree: 1=同意新增 / other=請先閱讀規章
            if (string.IsNullOrEmpty(agree)) { agree = "0"; }
            if (agree != null && !agree.Equals("1"))
            {
                // 未同意：顯示說明頁面
                return Prompt();
            }

            #region 從會員資料自動帶入申請人資訊

            if (sm.UserInfo != null)
            {
                // 申請人姓名：從會員資料取得
                form.APPLY_NAME = sm.UserInfo.Member.NAME;

                // 身分證字號：從會員資料取得
                form.APPLY_PID = sm.UserInfo.Member.IDN;

                // 出生年月日：轉換為民國年格式
                form.BIRTHDAY_AC = HelperUtil.DateTimeToString(sm.UserInfo.Member.BIRTHDAY);

                // 行動電話：從會員資料取得
                form.MOBILE = sm.UserInfo.Member.MOBILE;

                // 地址處理：查詢郵遞區號對應的縣市鄉鎮
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = sm.UserInfo.Member.TOWN_CD;
                var address = dao.GetRow(zip);
                form.CITY_CODE = sm.UserInfo.Member.TOWN_CD;

                if (address != null && !string.IsNullOrEmpty(address.TOWNNM))
                {
                    // 縣市鄉鎮名稱
                    form.CITY_TEXT = address.TOWNNM;

                    // 詳細地址：移除縣市鄉鎮名稱，只保留街道門牌
                    form.CITY_DETAIL = sm.UserInfo.Member.ADDR
                        .TONotNullString()
                        .Replace(address.CITYNM + address.TOWNNM, "");
                }
                else
                {
                    form.CITY_TEXT = string.Empty;
                    form.CITY_DETAIL = sm.UserInfo.Member.ADDR;
                }

                // 電話處理：分割區碼、號碼、分機
                if (sm.UserInfo.Member.TEL.TONotNullString().Trim() != "")
                {
                    // 分割電話號碼：格式為 "區碼-號碼#分機"
                    string[] tel = sm.UserInfo.Member.TEL.TONotNullString().Split('-');
                    form.TEL_SEC = tel[0];  // 區碼
                    form.TEL_NO = tel[1].ToSplit('#')[0];  // 號碼

                    // 如果有分機號碼
                    if (sm.UserInfo.Member.TEL.IndexOf('#') > 0)
                    {
                        form.TEL_EXT = sm.UserInfo.Member.TEL.Split('#')[1];  // 分機
                    }
                }

                // Email 處理：分割帳號和網域
                if (sm.UserInfo.Member.MAIL.TONotNullString().Trim() != "")
                {
                    form.MAIL_ACCOUNT = sm.UserInfo.Member.MAIL.Split('@')[0];  // 帳號
                    form.MAIL_DOMAIN = sm.UserInfo.Member.MAIL.Split('@')[1];   // 網域

                    // 根據常用 Email 網域設定下拉選單預設值
                    switch (sm.UserInfo.Member.MAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            form.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            form.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            form.DOMAINList = "3";
                            break;
                        default:
                            form.DOMAINList = "0";  // 其他
                            break;
                    }
                }
            }
            else
            {
                // Session 中沒有使用者資訊：導向登入頁面
                return RedirectToAction("Index", "Login");
            }

            #endregion

            // 設定申辦日期：當前日期，轉換為民國年格式
            form.APPLY_DATE = HelperUtil.DateTimeToTwString(DateTime.Now);

            // 回傳申辦表單頁面
            return View(form);
        }
```

**程式碼說明：**

1. **繼承 BaseController**：自動提供登入驗證、Session 管理等功能
2. **DisplayName 屬性**：用於日誌記錄和權限管理
3. **Session 管理**：使用 `SessionModel.Get()` 取得使用者 Session 資料
4. **資料自動帶入**：從會員資料自動填入申請人資訊，減少使用者輸入
5. **資料轉換**：將資料庫格式轉換為前端顯示格式（如：DateTime → 民國年字串）
6. **錯誤處理**：檢查登入狀態、會員資料，確保資料完整性
7. **業務邏輯**：檢查是否同意說明事項，未同意則導向說明頁面

### 2.2 預覽功能實作

```csharp
/// <summary>
/// 預覽申辦表件
/// 使用者填寫完表單後，顯示預覽頁面供確認
/// </summary>
/// <param name="model">使用者填寫的表單資料</param>
/// <returns>預覽頁面 PartialView</returns>
[DisplayName("Apply_001005_預覽")]
[HttpPost]  // 只接受 POST 請求
public ActionResult PreView(Apply_001005ViewModel model)
{
    // 建立 ShareDAO 物件：用於共用資料存取
    ShareDAO dao = new ShareDAO();

    // 建立預覽用的 ViewModel
    // 使用 ValueInjecter 套件將 model 的屬性值複製到 PreView 物件
    model.PreView = new Apply_001005ViewModel();
    model.PreView.InjectFrom(model);  // 自動複製所有同名屬性

    // 回傳預覽頁面的 PartialView
    // PartialView：不包含完整頁面結構，只有內容區塊
    return PartialView("PreView001005", model);
}
```

**程式碼說明：**

1. **HttpPost 屬性**：限制只能透過 POST 方法呼叫，防止 GET 請求
2. **ValueInjecter**：使用第三方套件自動複製物件屬性，避免手動逐一賦值
3. **PartialView**：回傳部分視圖，用於 AJAX 更新頁面區塊
4. **資料驗證**：在預覽階段再次確認資料完整性

### 2.3 繳費功能實作

```csharp
/// <summary>
/// 繳費頁面
/// 顯示繳費金額和繳費方式選項
/// </summary>
/// <param name="model">申辦表單資料</param>
/// <returns>繳費頁面 PartialView</returns>
[DisplayName("Apply_001005_繳費")]
[HttpPost]
public ActionResult Pay(Apply_001005ViewModel model)
{
    // 建立 ApplyDAO 物件
    ApplyDAO dao = new ApplyDAO();

    // 建立預覽用的 ViewModel
    model.PreView = new Apply_001005ViewModel();
    model.PreView.InjectFrom(model);

    // 從資料庫取得此服務的繳費金額
    // GetApplyFee()：查詢 SERVICE 資料表的 APP_FEE 欄位
    model.PAY_A_FEE = dao.GetApplyFee("001005");

    // 初始化繳費方式為空，由使用者選擇
    model.PAY_METHOD = "";

    // 回傳繳費頁面
    return PartialView("Pay", model);
}
```

**程式碼說明：**

1. **繳費金額查詢**：從資料庫動態取得，便於調整費用
2. **繳費方式**：支援多種繳費方式（信用卡、匯票、劃撥、臨櫃、超商）
3. **資料保留**：使用 PreView 保留使用者填寫的資料

### 2.4 儲存與繳費處理

```csharp
/// <summary>
/// 完成申報：儲存資料並處理繳費
/// 根據使用者選擇的繳費方式，執行對應的繳費流程
/// </summary>
/// <param name="model">完整的申辦表單資料</param>
/// <returns>完成頁面 View</returns>
[DisplayName("Apply_001005_完成申報")]
[HttpPost]
public ActionResult Save(Apply_001005ViewModel model)
{
    // 取得 Session 和 DAO
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();

    // 取得申請人姓名和 Email（優先使用表單填寫的，否則使用會員資料）
    var memberName = string.IsNullOrWhiteSpace(model.APPLY_NAME)
        ? sm.UserInfo.Member.NAME
        : model.APPLY_NAME;
    var memberEmail = string.IsNullOrWhiteSpace(model.MAIL)
        ? sm.UserInfo.Member.MAIL
        : model.MAIL;

    // 根據繳費方式執行不同的處理邏輯
    switch (model.PAY_METHOD)
    {
        // C = 信用卡線上刷卡（電子化政府網路付費服務）
        case "C":
            // 產生申請案號
            model.APP_ID = dao.GetApp_ID("001005");

            // 取得使用者 IP 位址：用於交易記錄
            model.CLIENT_IP = GetClientIP();

            // 檢查是否啟用聯合信用卡中心
            model.ISEC = DataUtils.GetConfig("PAY_EC_OPEN"); // Y=啟用

            // 執行信用卡交易
            // RunCreditCardTranx()：呼叫信用卡金流 API，建立交易
            if (!dao.RunCreditCardTranx(model))
            {
                // 交易失敗：刪除已建立的空白申請案
                dao.DeleteApplyEmptyRow(model.APP_ID);
                break;
            }
            else
            {
                // 交易成功：寄送通知信
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID,
                    "醫事人員或公共衛生師證書補(換)發", "001005");
            }
            break;

        // D = 匯票（抬頭：衛生福利部）
        case "D":
            // 執行匯票繳費交易
            // RunPayTranx()：建立申請案、儲存繳費資訊
            if (!dao.RunPayTranx(model))
            {
                model.ErrorCode = "-1";
                model.ErrorMessage = "匯票繳費執行失敗!!";
                break;
            }
            else
            {
                // 成功：寄送通知信
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID,
                    "醫事人員或公共衛生師證書補(換)發", "001005");
            }
            model.ErrorCode = "0000";  // 成功代碼
            break;

        // T = 劃撥
        case "T":
            if (!dao.RunPayTranx(model))
            {
                model.ErrorCode = "-1";
                model.ErrorMessage = "劃撥繳費執行失敗!!";
                break;
            }
            else
            {
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID,
                    "醫事人員或公共衛生師證書補(換)發", "001005");
            }
            model.ErrorCode = "0000";
            break;

        // B = 臨櫃（現金）
        case "B":
            if (!dao.RunPayTranx(model))
            {
                model.ErrorCode = "-1";
                model.ErrorMessage = "臨櫃繳費執行失敗!!";
                break;
            }
            else
            {
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID,
                    "醫事人員或公共衛生師證書補(換)發", "001005");
            }
            model.ErrorCode = "0000";
            break;

        // S = 超商繳費
        case "S":
            if (!dao.RunPayTranx(model))
            {
                model.ErrorCode = "-1";
                model.ErrorMessage = "超商繳費執行失敗!!";
                break;
            }
            else
            {
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID,
                    "醫事人員或公共衛生師證書補(換)發", "001005");
            }
            model.ErrorCode = "0000";
            break;
    }

    // 回傳完成頁面
    return View("Save", model);
}
```

**程式碼說明：**

1. **繳費方式分流**：使用 switch 語句根據不同繳費方式執行對應邏輯
2. **案號產生**：`GetApp_ID()` 產生唯一的申請案號（格式：001005YYYYMMDD0001）
3. **交易處理**：
   - 信用卡：呼叫金流 API，即時扣款
   - 其他方式：建立繳費資訊，等待使用者繳費
4. **錯誤處理**：交易失敗時刪除已建立的空白申請案，避免資料不一致
5. **通知機制**：成功後自動寄送通知信給申請人
6. **IP 記錄**：記錄使用者 IP 位址，用於安全稽核

### 2.5 補件查詢功能

```csharp
/// <summary>
/// 補件查詢
/// 當案件被退件時，申請人可以查詢並上傳補件資料
/// </summary>
/// <param name="APP_ID">申請案號</param>
/// <returns>補件頁面 View 或錯誤頁面</returns>
[DisplayName("Apply_001005_補件查詢")]
public ActionResult AppDoc(string APP_ID)
{
    // 建立 DAO 和取得 Session
    ApplyDAO dao = new ApplyDAO();
    SessionModel sm = SessionModel.Get();
    Apply_001005ViewModel model = new Apply_001005ViewModel();

    // 設定申請案號
    model.APP_ID = APP_ID;

    // 從資料庫查詢申請案資料
    model = dao.QueryApply_001005(model);

    // 查詢案件基本資訊
    ApplyModel apply = new ApplyModel();
    apply.APP_ID = APP_ID;
    var applyData = dao.GetRow(apply);

    try
    {
        // 取得當前登入的使用者資訊
        var userInfo = sm.UserInfo.Member;

        // 權限檢查：判斷是否為該案件的申請人
        // ACC_NO：會員帳號，用於識別申請人身份
        if (applyData.ACC_NO == userInfo.ACC_NO)
        {
            ShareDAO shareDAO = new ShareDAO();
            model.IsNotice = "Y";  // 預設允許補件

            // 檢查補件期限
            // FLOW_CD == "2"：案件狀態為「退件」
            // CalculationDocDate()：計算是否超過補件期限
            if (applyData.FLOW_CD == "2" &&
                shareDAO.CalculationDocDate("001005", model.APP_ID))
            {
                // 超過補件期限：顯示錯誤訊息
                sm.LastErrorMessage = "已過可補件時間，請聯絡承辦單位!!";
                model.IsNotice = "N";  // 不允許補件
            }

            // 回傳補件頁面
            return View("AppDoc", model);
        }
        else
        {
            // 非案件申請人：拋出例外
            throw new Exception("非案件申請人無法瀏覽次案件 !");
        }
    }
    catch (Exception ex)
    {
        // 錯誤處理
        if (model == null)
        {
            // 案件不存在或尚未分派承辦人
            sm.LastErrorMessage = "案件編號﹕" + APP_ID + "，尚未分派承辦人員，暫無法查詢!!";
            return RedirectToAction("Index", "History");
        }
        else
        {
            // 其他錯誤：導向登入頁面
            sm.LastErrorMessage = ex.Message;
            return RedirectToAction("Index", "Login");
        }
    }
}
```

**程式碼說明：**

1. **權限控管**：檢查是否為案件申請人，防止他人查看
2. **補件期限檢查**：計算是否超過補件期限，超過則不允許補件
3. **案件狀態檢查**：只有「退件」狀態的案件才能補件
4. **錯誤處理**：區分不同錯誤情況，提供適當的錯誤訊息
5. **安全性**：使用 ACC_NO（會員帳號）驗證身份，確保資料安全

### 2.6 補件儲存功能

```csharp
/// <summary>
/// 補件存檔
/// 儲存使用者上傳的補件資料
/// </summary>
/// <param name="model">補件表單資料</param>
/// <returns>完成頁面 View</returns>
[DisplayName("Apply_001005_補件存檔")]
[HttpPost]
public ActionResult AppDocSave(Apply_001005ViewModel model)
{
    // 建立 DAO 和取得 Session
    ApplyDAO dao = new ApplyDAO();
    SessionModel sm = SessionModel.Get();

    // 取得申請人資訊
    var memberName = string.IsNullOrWhiteSpace(model.APPLY_NAME)
        ? sm.UserInfo.Member.NAME
        : model.APPLY_NAME;
    var memberEmail = string.IsNullOrWhiteSpace(model.MAIL)
        ? sm.UserInfo.Member.MAIL
        : model.MAIL;

    try
    {
        // 呼叫 DAO 儲存補件資料
        // SaveAppDoc001005()：更新 APPLY 和 APPLY_001005 資料表
        if (dao.SaveAppDoc001005(model))
        {
            // 儲存成功：寄送補件完成通知信
            // "-1" 表示補件通知
            dao.SendMail_Update(memberName, memberEmail, model.APP_ID,
                "醫事人員或公共衛生師證書補（換）發", "001005", "-1");

            // 設定成功訊息
            sm.LastResultMessage = "存檔成功!!";

            // 更新案件狀態為「補件完成」
            model.Apply.FLOW_CD = "3";
        }
        else
        {
            // 儲存失敗：設定錯誤訊息
            sm.LastErrorMessage = "存檔失敗!!";
        }
    }
    catch (Exception ex)
    {
        // 例外處理：記錄錯誤日誌
        logger.Error("001005_AppDocSave failed:" + ex.TONotNullString());
        sm.LastErrorMessage = "存檔失敗!!";
    }

    // 回傳完成頁面
    return View("Done", model);
}
```

**程式碼說明：**

1. **Transaction 處理**：DAO 層使用 SqlTransaction 確保資料一致性
2. **狀態更新**：補件完成後，將案件狀態從「退件(2)」更新為「補件完成(3)」
3. **通知機制**：補件完成後自動寄送通知信給申請人和承辦人
4. **錯誤日誌**：使用 logger 記錄錯誤，便於問題追蹤
5. **使用者回饋**：透過 Session 傳遞成功/失敗訊息給前端顯示

## 3. 資料存取層 (DAO) 實作

### 3.1 查詢申請案資料

**檔案位置：** `ES/DataLayers/ApplyDAO.cs` (第 2365-2982 行)

```csharp
/// <summary>
/// 取得醫事人員證書補(換)發申請案資料
/// 查詢 APPLY_001005、APPLY、APPLY_PAY 三個資料表的資料
/// </summary>
/// <param name="parm">查詢參數，包含 APP_ID</param>
/// <returns>完整的申請案資料</returns>
public Apply_001005ViewModel QueryApply_001005(Apply_001005ViewModel parm)
{
    // 建立回傳物件
    Apply_001005ViewModel result = new Apply_001005ViewModel();
    result.Apply = new ApplyModel();

    // 準備查詢參數：使用 Dictionary 建立參數集合
    var dictionary = new Dictionary<string, object>
    {
        { "@APP_ID", parm.APP_ID }  // 申請案號
    };

    // 使用 Dapper 的 DynamicParameters 包裝參數
    var parameters = new DynamicParameters(dictionary);

    // 建立資料庫連線
    using (SqlConnection conn = DataUtils.GetConnection())
    {
        try
        {
            // 第一步：查詢 APPLY_001005 資料表（服務明細資料）
            string _sql = @"
                SELECT APP_ID, ACTION_TYPE, ISSUE_DEPT, ISSUE_DATE, LIC_TYPE,
                       LIC_CD, LIC_NUM, ACTION_RES, OTHER_RES, DEL_MK, DEL_TIME,
                       DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC,
                       ADD_TIME, ADD_FUN_CD, ADD_ACC, EMAIL, DIVISION
                FROM APPLY_001005
                WHERE 1 = 1";
            _sql += " AND APP_ID = @APP_ID";

            // 使用 Dapper 的 QueryFirst 方法：查詢單筆資料
            // 如果查無資料會拋出例外
            result = conn.QueryFirst<Apply_001005ViewModel>(_sql, parameters);

            // 第二步：查詢 APPLY 資料表（申請案主表）
            _sql = @"
                SELECT APP_ID, SRV_ID, SRC_SRV_ID, UNIT_CD, ACC_NO, IDN, SEX_CD,
                       BIRTHDAY, NAME, ENAME, CNT_NAME, CNT_ENAME, CHR_NAME, CHR_ENAME,
                       TEL, FAX, CNT_TEL, ADDR_CODE, ADDR, EADDR, CARD_IDN, APP_TIME,
                       PAY_POINT, PAY_METHOD, PAY_BACK_MK, PAY_BACK_DATE, PAY_A_FEE,
                       PAY_A_FEEBK, PAY_A_PAID, PAY_C_FEE, PAY_C_FEEBK, PAY_C_PAID,
                       CHK_MK, ATM_VNO, API_MK, PRINT_MK, TRANS_ID, MOHW_CASE_NO,
                       FLOW_CD, TO_MIS_MK, TO_ARCHIVE_MK, APP_STR_DATE, APP_EXT_DATE,
                       APP_ACT_DATE, APP_DEFER_MK, APP_DEFER_TIME_S, APP_DEFER_TIME_E,
                       APP_DEFER_DAYS, APP_DEFER_TIMES, APP_DISP_ACC, APP_DISP_MK,
                       PRO_ACC, PRO_UNIT_CD, CLOSE_MK, APP_GRADE, APP_GRADE_TIME,
                       APP_GRADE_LOG, NOTIFY_COUNT, NOTIFY_TYPE, CASE_BACK_MK,
                       CASE_BACK_TIME, DIGITAL, LOGIN_TYPE, DEL_MK, DEL_TIME,
                       DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME,
                       ADD_FUN_CD, ADD_ACC, MARITAL_CD, CERT_SN, MOBILE, ISMODIFY,
                       NOTICE_NOTE, MAILBODY
                FROM APPLY
                WHERE 1 = 1";
            _sql += " AND APP_ID = @APP_ID";

            // 查詢並填入 Apply 屬性
            result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

            // 第三步：查詢 APPLY_PAY 資料表（繳費資訊）
            _sql = @"
                SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME,
                       PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK,
                       PAY_RET_CD, PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO,
                       INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET,
                       SESSION_KEY, AUTH_DATE, AUTH_NO, SETTLE_DATE, OTHER, ROC_ID,
                       CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC,
                       UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                FROM APPLY_PAY
                WHERE 1 = 1";
            _sql += " AND APP_ID = @APP_ID";

            // 查詢並填入 ApplyPay 屬性
            result.ApplyPay = conn.QueryFirst<APPLY_PAY>(_sql, parameters);
        }
        catch (Exception ex)
        {
            // 錯誤處理：記錄日誌
            logger.Error("QueryApply_001005 failed: " + ex.Message, ex);
            throw;
        }
    }

    return result;
}
```

**程式碼說明：**

1. **Dapper ORM**：使用 Dapper 進行資料查詢，比 Entity Framework 更輕量、效能更好
2. **參數化查詢**：使用 `@APP_ID` 參數，防止 SQL Injection 攻擊
3. **QueryFirst 方法**：查詢單筆資料，如果查無資料會拋出例外
4. **多表查詢**：分別查詢三個資料表，組合成完整的 ViewModel
5. **Using 語句**：自動釋放資料庫連線資源
6. **錯誤處理**：捕捉例外並記錄日誌，便於問題追蹤

### 3.2 儲存補件資料

**檔案位置：** `ES/DataLayers/ApplyDAO.cs` (第 2984-3166 行)

```csharp
/// <summary>
/// 儲存補件資料
/// 更新 APPLY 和 APPLY_001005 資料表，並記錄歷程
/// </summary>
/// <param name="model">補件表單資料</param>
/// <returns>true=成功, false=失敗</returns>
public bool SaveAppDoc001005(Apply_001005ViewModel model)
{
    bool result = false;

    // 建立 ShareDAO 和取得 Session
    ShareDAO shareDao = new ShareDAO();
    SessionModel sm = SessionModel.Get();
    ClamMember UserInfo = sm.UserInfo.Member;

    // 建立資料庫連線
    using (SqlConnection conn = DataUtils.GetConnection())
    {
        conn.Open();

        // 開始 Transaction：確保資料一致性
        // 如果任何一個步驟失敗，所有變更都會回復
        SqlTransaction tran = conn.BeginTransaction();

        try
        {
            // 設定 DAO 使用此 Transaction
            this.Tran(conn, tran);

            model.APP_ID = model.Apply.APP_ID;

            // 準備歷程記錄參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "001005");
            dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

            // 檢查是否需要修改基本資料
            if (model.Apply.ISMODIFY == "Y")
            {
                // 更新 APPLY 資料表（申請案主表）
                ApplyModel applyWhere = new ApplyModel();
                applyWhere.APP_ID = model.APP_ID;
                ApplyModel apply = new ApplyModel();

                // 設定要更新的欄位
                apply.APP_ID = model.APP_ID;
                apply.NAME = model.APPLY_NAME;  // 申請人姓名
                apply.IDN = model.APPLY_PID;    // 身分證字號
                apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);  // 出生年月日
                apply.ADDR_CODE = model.CITY_CODE;  // 地址代碼
                apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;  // 完整地址

                // 組合電話號碼：區碼-號碼#分機
                apply.TEL = model.TEL_SEC.TONotNullString() != "" &&
                           model.TEL_NO.TONotNullString() != "" ?
                    (model.TEL_EXT.TONotNullString() != "" ?
                        model.TEL_SEC.TONotNullString() + "-" +
                        model.TEL_NO.TONotNullString() + "#" +
                        model.TEL_EXT.TONotNullString() :
                        model.TEL_SEC.TONotNullString() + "-" +
                        model.TEL_NO.TONotNullString()) : "";

                apply.FLOW_CD = "3";  // 案件狀態：3=補件完成
                apply.ISMODIFY = "A";  // 修改標記：A=已修改
                apply.UPD_TIME = DateTime.Now;  // 更新時間
                apply.UPD_FUN_CD = "WEB-APPLY";  // 更新功能代碼

                // 執行更新並記錄歷程
                // Update2()：更新資料並自動記錄歷程
                this.Update2(apply, applyWhere, dict2);

                // 更新 APPLY_001005 資料表（服務明細表）
                Apply_001005Model apply001005Where = new Apply_001005Model();
                apply001005Where.APP_ID = model.APP_ID;
                Apply_001005Model apply001005 = new Apply_001005Model();

                // 設定要更新的欄位
                apply001005.APP_ID = model.APP_ID;
                apply001005.DIVISION = model.DIVISION;  // 證書類別

                // 組合 Email：帳號@網域
                apply001005.EMAIL = model.MAIL_ACCOUNT + "@" +
                    model.MAIL_DOMAIN.TONotNullString().Replace("@", "");

                apply001005.ACTION_RES = model.ACTION_RES;  // 補換發原因
                apply001005.OTHER_RES = model.OTHER_RES;    // 其他原因說明
                apply001005.UPD_TIME = DateTime.Now;
                apply001005.UPD_FUN_CD = "WEB-APPLY";

                // 執行更新
                this.Update(apply001005, apply001005Where);
            }

            // 處理附件上傳
            if (model.ATTACH_FILE != null && model.ATTACH_FILE.ContentLength > 0)
            {
                // 儲存附件檔案
                // UploadFile()：將檔案儲存到伺服器，並記錄到 APPLY_FILE 資料表
                string filePath = shareDao.UploadFile(
                    model.ATTACH_FILE,
                    model.APP_ID,
                    "001005",
                    "補件附件"
                );
            }

            // 提交 Transaction：所有變更生效
            tran.Commit();
            result = true;
        }
        catch (Exception ex)
        {
            // 發生錯誤：回復所有變更
            logger.Warn(ex.Message, ex);
            tran.Rollback();
            result = false;
            throw new Exception("SaveAppDoc001005 failed:" + ex.Message, ex);
        }
        finally
        {
            // 關閉連線
            conn.Close();
            conn.Dispose();
        }
    }

    return result;
}
```

**程式碼說明：**

1. **Transaction 處理**：使用 `SqlTransaction` 確保資料一致性，全部成功或全部失敗
2. **歷程記錄**：使用 `Update2()` 方法自動記錄資料變更歷程
3. **條件更新**：只有當 `ISMODIFY == "Y"` 時才更新基本資料
4. **資料組合**：將前端分開的欄位（如電話區碼、號碼、分機）組合成單一欄位儲存
5. **附件處理**：檢查是否有上傳附件，有則儲存到伺服器並記錄到資料庫
6. **錯誤回復**：發生錯誤時自動回復所有變更，確保資料完整性
7. **資源釋放**：使用 `finally` 確保連線一定會被關閉

## 4. 資料庫結構

### 4.1 APPLY 資料表（申請案主表）

**用途：** 儲存所有線上申辦服務的共用資料，包含申請人資訊、繳費資訊、案件狀態等。

| 欄位名稱         | 資料型別 | 長度 | 允許 NULL | 說明                                                       | 範例值                    |
| ---------------- | -------- | ---- | --------- | ---------------------------------------------------------- | ------------------------- |
| APP_ID           | varchar  | 20   | NO        | 申請案號（PK）                                             | 00100520250113000 1       |
| SRV_ID           | varchar  | 6    | NO        | 服務代碼                                                   | 001005                    |
| SRC_SRV_ID       | varchar  | 6    | YES       | 來源服務代碼                                               | NULL                      |
| UNIT_CD          | varchar  | 10   | YES       | 承辦單位代碼                                               | 001                       |
| ACC_NO           | varchar  | 20   | NO        | 會員帳號                                                   | M000001234                |
| IDN              | varchar  | 10   | NO        | 身分證字號                                                 | A123456789                |
| SEX_CD           | varchar  | 1    | YES       | 性別代碼（1=男, 2=女）                                     | 1                         |
| BIRTHDAY         | datetime | -    | YES       | 出生年月日                                                 | 1980-01-01                |
| NAME             | nvarchar | 50   | NO        | 申請人姓名                                                 | 王小明                    |
| ENAME            | varchar  | 100  | YES       | 英文姓名                                                   | WANG, HSIAO-MING          |
| CNT_NAME         | nvarchar | 50   | YES       | 聯絡人姓名                                                 | 王小明                    |
| CNT_ENAME        | varchar  | 100  | YES       | 聯絡人英文姓名                                             | NULL                      |
| CHR_NAME         | nvarchar | 50   | YES       | 負責人姓名                                                 | NULL                      |
| CHR_ENAME        | varchar  | 100  | YES       | 負責人英文姓名                                             | NULL                      |
| TEL              | varchar  | 20   | YES       | 電話號碼                                                   | 02-12345678#123           |
| FAX              | varchar  | 20   | YES       | 傳真號碼                                                   | 02-12345679               |
| CNT_TEL          | varchar  | 20   | YES       | 聯絡電話                                                   | 0912345678                |
| ADDR_CODE        | varchar  | 10   | YES       | 地址代碼（郵遞區號）                                       | 100                       |
| ADDR             | nvarchar | 200  | YES       | 地址                                                       | 台北市中正區忠孝東路 1 號 |
| EADDR            | varchar  | 200  | YES       | 英文地址                                                   | NULL                      |
| CARD_IDN         | varchar  | 10   | YES       | 憑證身分證字號                                             | A123456789                |
| APP_TIME         | datetime | -    | NO        | 申請時間                                                   | 2025-01-13 10:30:00       |
| PAY_POINT        | varchar  | 10   | YES       | 繳費點                                                     | NULL                      |
| PAY_METHOD       | varchar  | 1    | YES       | 繳費方式（C=信用卡, D=匯票, T=劃撥, B=臨櫃, S=超商）       | C                         |
| PAY_BACK_MK      | varchar  | 1    | YES       | 退費標記（Y=已退費）                                       | N                         |
| PAY_BACK_DATE    | datetime | -    | YES       | 退費日期                                                   | NULL                      |
| PAY_A_FEE        | int      | -    | YES       | 應繳費用                                                   | 200                       |
| PAY_A_FEEBK      | int      | -    | YES       | 應退費用                                                   | 0                         |
| PAY_A_PAID       | int      | -    | YES       | 已繳費用                                                   | 200                       |
| PAY_C_FEE        | int      | -    | YES       | 審查費                                                     | 0                         |
| PAY_C_FEEBK      | int      | -    | YES       | 審查退費                                                   | 0                         |
| PAY_C_PAID       | int      | -    | YES       | 已繳審查費                                                 | 0                         |
| CHK_MK           | varchar  | 1    | YES       | 檢核標記                                                   | Y                         |
| ATM_VNO          | varchar  | 16   | YES       | ATM 虛擬帳號                                               | NULL                      |
| API_MK           | varchar  | 1    | YES       | API 標記                                                   | N                         |
| PRINT_MK         | varchar  | 1    | YES       | 列印標記                                                   | N                         |
| TRANS_ID         | varchar  | 50   | YES       | 交易序號                                                   | NULL                      |
| MOHW_CASE_NO     | varchar  | 50   | YES       | 衛福部案號                                                 | NULL                      |
| FLOW_CD          | varchar  | 2    | YES       | 案件狀態（1=新申請, 2=退件, 3=補件完成, 4=審核中, 5=結案） | 1                         |
| TO_MIS_MK        | varchar  | 1    | YES       | 轉 MIS 標記                                                | N                         |
| TO_ARCHIVE_MK    | varchar  | 1    | YES       | 歸檔標記                                                   | N                         |
| APP_STR_DATE     | datetime | -    | YES       | 案件開始日期                                               | 2025-01-13                |
| APP_EXT_DATE     | datetime | -    | YES       | 案件到期日期                                               | 2025-02-13                |
| APP_ACT_DATE     | datetime | -    | YES       | 案件實際完成日期                                           | NULL                      |
| APP_DEFER_MK     | varchar  | 1    | YES       | 展延標記                                                   | N                         |
| APP_DEFER_TIME_S | datetime | -    | YES       | 展延開始時間                                               | NULL                      |
| APP_DEFER_TIME_E | datetime | -    | YES       | 展延結束時間                                               | NULL                      |
| APP_DEFER_DAYS   | int      | -    | YES       | 展延天數                                                   | 0                         |
| APP_DEFER_TIMES  | int      | -    | YES       | 展延次數                                                   | 0                         |
| APP_DISP_ACC     | varchar  | 20   | YES       | 派案帳號                                                   | NULL                      |
| APP_DISP_MK      | varchar  | 1    | YES       | 派案標記                                                   | N                         |
| PRO_ACC          | varchar  | 20   | YES       | 承辦人帳號                                                 | NULL                      |
| PRO_UNIT_CD      | varchar  | 10   | YES       | 承辦單位代碼                                               | NULL                      |
| CLOSE_MK         | varchar  | 1    | YES       | 結案標記                                                   | N                         |
| APP_GRADE        | varchar  | 1    | YES       | 案件評分                                                   | NULL                      |
| APP_GRADE_TIME   | datetime | -    | YES       | 評分時間                                                   | NULL                      |
| APP_GRADE_LOG    | nvarchar | 500  | YES       | 評分意見                                                   | NULL                      |
| NOTIFY_COUNT     | int      | -    | YES       | 通知次數                                                   | 0                         |
| NOTIFY_TYPE      | varchar  | 10   | YES       | 通知類型                                                   | NULL                      |
| CASE_BACK_MK     | varchar  | 1    | YES       | 退件標記                                                   | N                         |
| CASE_BACK_TIME   | datetime | -    | YES       | 退件時間                                                   | NULL                      |
| DIGITAL          | varchar  | 1    | YES       | 數位標記                                                   | Y                         |
| LOGIN_TYPE       | varchar  | 2    | YES       | 登入方式（01=帳密, 02=自然人憑證, 03=工商憑證）            | 01                        |
| DEL_MK           | varchar  | 1    | YES       | 刪除標記                                                   | N                         |
| DEL_TIME         | datetime | -    | YES       | 刪除時間                                                   | NULL                      |
| DEL_FUN_CD       | varchar  | 20   | YES       | 刪除功能代碼                                               | NULL                      |
| DEL_ACC          | varchar  | 20   | YES       | 刪除帳號                                                   | NULL                      |
| UPD_TIME         | datetime | -    | YES       | 更新時間                                                   | 2025-01-13 10:30:00       |
| UPD_FUN_CD       | varchar  | 20   | YES       | 更新功能代碼                                               | WEB-APPLY                 |
| UPD_ACC          | varchar  | 20   | YES       | 更新帳號                                                   | M000001234                |
| ADD_TIME         | datetime | -    | NO        | 新增時間                                                   | 2025-01-13 10:30:00       |
| ADD_FUN_CD       | varchar  | 20   | YES       | 新增功能代碼                                               | WEB-APPLY                 |
| ADD_ACC          | varchar  | 20   | YES       | 新增帳號                                                   | M000001234                |
| MARITAL_CD       | varchar  | 1    | YES       | 婚姻狀況代碼                                               | NULL                      |
| CERT_SN          | varchar  | 50   | YES       | 憑證序號                                                   | NULL                      |
| MOBILE           | varchar  | 20   | YES       | 行動電話                                                   | 0912345678                |
| ISMODIFY         | varchar  | 1    | YES       | 修改標記（Y=允許修改, N=不允許, A=已修改）                 | N                         |
| NOTICE_NOTE      | nvarchar | 500  | YES       | 通知備註                                                   | NULL                      |
| MAILBODY         | nvarchar | MAX  | YES       | 郵件內容                                                   | NULL                      |

**主鍵：** APP_ID
**索引：**

- IX_APPLY_SRV_ID (SRV_ID)
- IX_APPLY_ACC_NO (ACC_NO)
- IX_APPLY_IDN (IDN)
- IX_APPLY_FLOW_CD (FLOW_CD)
- IX_APPLY_APP_TIME (APP_TIME)

### 4.2 APPLY_001005 資料表（服務明細表）

**用途：** 儲存醫事人員證書補(換)發服務的專屬資料。

| 欄位名稱    | 資料型別 | 長度 | 允許 NULL | 說明                                            | 範例值              |
| ----------- | -------- | ---- | --------- | ----------------------------------------------- | ------------------- |
| APP_ID      | varchar  | 20   | NO        | 申請案號（PK, FK）                              | 001005202501130001  |
| ACTION_TYPE | varchar  | 1    | YES       | 補換發類型（1=補發, 2=換發）                    | 1                   |
| ISSUE_DEPT  | varchar  | 10   | YES       | 核發單位代碼                                    | 001                 |
| ISSUE_DATE  | varchar  | 7    | YES       | 核發日期（民國年 YYYMMDD）                      | 1090101             |
| LIC_TYPE    | varchar  | 2    | YES       | 證書類型                                        | 01                  |
| LIC_CD      | varchar  | 10   | YES       | 證書字號前綴                                    | 醫師                |
| LIC_NUM     | varchar  | 10   | YES       | 證書號碼                                        | 123456              |
| ACTION_RES  | varchar  | 2    | YES       | 補換發原因代碼（01=遺失, 02=毀損, 03=變更姓名） | 01                  |
| OTHER_RES   | nvarchar | 200  | YES       | 其他原因說明                                    | NULL                |
| DEL_MK      | varchar  | 1    | YES       | 刪除標記                                        | N                   |
| DEL_TIME    | datetime | -    | YES       | 刪除時間                                        | NULL                |
| DEL_FUN_CD  | varchar  | 20   | YES       | 刪除功能代碼                                    | NULL                |
| DEL_ACC     | varchar  | 20   | YES       | 刪除帳號                                        | NULL                |
| UPD_TIME    | datetime | -    | YES       | 更新時間                                        | 2025-01-13 10:30:00 |
| UPD_FUN_CD  | varchar  | 20   | YES       | 更新功能代碼                                    | WEB-APPLY           |
| UPD_ACC     | varchar  | 20   | YES       | 更新帳號                                        | M000001234          |
| ADD_TIME    | datetime | -    | NO        | 新增時間                                        | 2025-01-13 10:30:00 |
| ADD_FUN_CD  | varchar  | 20   | YES       | 新增功能代碼                                    | WEB-APPLY           |
| ADD_ACC     | varchar  | 20   | YES       | 新增帳號                                        | M000001234          |
| EMAIL       | varchar  | 100  | YES       | Email                                           | test@gmail.com      |
| DIVISION    | varchar  | 2    | YES       | 證書類別代碼                                    | 01                  |

**主鍵：** APP_ID
**外鍵：** APP_ID → APPLY.APP_ID

### 4.3 APPLY_PAY 資料表（繳費資訊表）

**用途：** 儲存申請案的繳費交易資訊。

| 欄位名稱      | 資料型別 | 長度 | 允許 NULL | 說明                                                 | 範例值                  |
| ------------- | -------- | ---- | --------- | ---------------------------------------------------- | ----------------------- |
| APP_ID        | varchar  | 20   | NO        | 申請案號（PK, FK）                                   | 001005202501130001      |
| PAY_ID        | varchar  | 20   | NO        | 繳費序號（PK）                                       | PAY202501130001         |
| PAY_MONEY     | int      | -    | YES       | 繳費金額                                             | 200                     |
| PAY_PROFEE    | int      | -    | YES       | 手續費                                               | 0                       |
| PAY_ACT_TIME  | datetime | -    | YES       | 實際繳費時間                                         | 2025-01-13 10:35:00     |
| PAY_EXT_TIME  | datetime | -    | YES       | 繳費期限                                             | 2025-01-20              |
| PAY_INC_TIME  | datetime | -    | YES       | 入帳時間                                             | 2025-01-13 10:35:00     |
| PAY_METHOD    | varchar  | 1    | YES       | 繳費方式（C=信用卡, D=匯票, T=劃撥, B=臨櫃, S=超商） | C                       |
| PAY_STATUS_MK | varchar  | 1    | YES       | 繳費狀態（Y=已繳費, N=未繳費）                       | Y                       |
| PAY_RET_CD    | varchar  | 10   | YES       | 繳費回應代碼                                         | 0000                    |
| PAY_RET_MSG   | nvarchar | 200  | YES       | 繳費回應訊息                                         | 交易成功                |
| BATCH_NO      | varchar  | 20   | YES       | 批次號碼                                             | NULL                    |
| APPROVAL_CD   | varchar  | 20   | YES       | 授權碼                                               | 123456                  |
| PAY_RET_NO    | varchar  | 50   | YES       | 繳費回傳序號                                         | NULL                    |
| INVOICE_NO    | varchar  | 20   | YES       | 發票號碼                                             | NULL                    |
| PAY_DESC      | nvarchar | 200  | YES       | 繳費說明                                             | 醫事人員證書補發        |
| CARD_NO       | varchar  | 20   | YES       | 信用卡號（遮罩）                                     | 1234-\***\*-\*\***-5678 |
| HOST_TIME     | varchar  | 14   | YES       | 主機時間                                             | 20250113103500          |
| TRANS_RET     | varchar  | 10   | YES       | 交易回應                                             | 0000                    |
| SESSION_KEY   | varchar  | 100  | YES       | Session Key                                          | NULL                    |
| AUTH_DATE     | varchar  | 8    | YES       | 授權日期                                             | 20250113                |
| AUTH_NO       | varchar  | 20   | YES       | 授權號碼                                             | 123456                  |
| SETTLE_DATE   | varchar  | 8    | YES       | 請款日期                                             | 20250113                |
| OTHER         | nvarchar | 500  | YES       | 其他資訊                                             | NULL                    |
| ROC_ID        | varchar  | 10   | YES       | 身分證字號                                           | A123456789              |
| CLIENT_IP     | varchar  | 50   | YES       | 客戶端 IP                                            | 192.168.1.100           |
| OID           | varchar  | 50   | YES       | 訂單編號                                             | NULL                    |
| SID           | varchar  | 50   | YES       | 商店代號                                             | NULL                    |
| DEL_MK        | varchar  | 1    | YES       | 刪除標記                                             | N                       |
| DEL_TIME      | datetime | -    | YES       | 刪除時間                                             | NULL                    |
| DEL_FUN_CD    | varchar  | 20   | YES       | 刪除功能代碼                                         | NULL                    |
| DEL_ACC       | varchar  | 20   | YES       | 刪除帳號                                             | NULL                    |
| UPD_TIME      | datetime | -    | YES       | 更新時間                                             | 2025-01-13 10:35:00     |
| UPD_FUN_CD    | varchar  | 20   | YES       | 更新功能代碼                                         | WEB-PAY                 |
| UPD_ACC       | varchar  | 20   | YES       | 更新帳號                                             | M000001234              |
| ADD_TIME      | datetime | -    | NO        | 新增時間                                             | 2025-01-13 10:35:00     |
| ADD_FUN_CD    | varchar  | 20   | YES       | 新增功能代碼                                         | WEB-PAY                 |
| ADD_ACC       | varchar  | 20   | YES       | 新增帳號                                             | M000001234              |

**主鍵：** APP_ID, PAY_ID
**外鍵：** APP_ID → APPLY.APP_ID

### 4.4 APPLY_FILE 資料表（附件檔案表）

**用途：** 儲存申請案上傳的附件檔案資訊。

| 欄位名稱   | 資料型別 | 長度 | 允許 NULL | 說明                                 | 範例值                     |
| ---------- | -------- | ---- | --------- | ------------------------------------ | -------------------------- |
| FILE_ID    | varchar  | 20   | NO        | 檔案編號（PK）                       | FILE202501130001           |
| APP_ID     | varchar  | 20   | NO        | 申請案號（FK）                       | 001005202501130001         |
| SRV_ID     | varchar  | 6    | NO        | 服務代碼                             | 001005                     |
| FILE_TYPE  | varchar  | 10   | YES       | 檔案類型（01=申請附件, 02=補件附件） | 01                         |
| FILE_NAME  | nvarchar | 200  | NO        | 檔案名稱                             | 身分證影本.pdf             |
| FILE_PATH  | varchar  | 500  | NO        | 檔案路徑                             | /Upload/001005/2025/01/... |
| FILE_SIZE  | int      | -    | YES       | 檔案大小（bytes）                    | 1024000                    |
| FILE_EXT   | varchar  | 10   | YES       | 副檔名                               | pdf                        |
| FILE_DESC  | nvarchar | 200  | YES       | 檔案說明                             | 身分證影本                 |
| DEL_MK     | varchar  | 1    | YES       | 刪除標記                             | N                          |
| DEL_TIME   | datetime | -    | YES       | 刪除時間                             | NULL                       |
| DEL_FUN_CD | varchar  | 20   | YES       | 刪除功能代碼                         | NULL                       |
| DEL_ACC    | varchar  | 20   | YES       | 刪除帳號                             | NULL                       |
| UPD_TIME   | datetime | -    | YES       | 更新時間                             | NULL                       |
| UPD_FUN_CD | varchar  | 20   | YES       | 更新功能代碼                         | NULL                       |
| UPD_ACC    | varchar  | 20   | YES       | 更新帳號                             | NULL                       |
| ADD_TIME   | datetime | -    | NO        | 新增時間                             | 2025-01-13 10:30:00        |
| ADD_FUN_CD | varchar  | 20   | YES       | 新增功能代碼                         | WEB-APPLY                  |
| ADD_ACC    | varchar  | 20   | YES       | 新增帳號                             | M000001234                 |

**主鍵：** FILE_ID
**外鍵：** APP_ID → APPLY.APP_ID

## 5. 完整流程圖

### 5.1 申請流程圖

```mermaid
flowchart TD
    Start([使用者登入系統]) --> CheckLogin{是否已登入?}
    CheckLogin -->|否| Login[導向登入頁面]
    CheckLogin -->|是| ShowPrompt[顯示服務說明頁面]

    ShowPrompt --> AgreeCheck{是否同意說明事項?}
    AgreeCheck -->|否| ShowPrompt
    AgreeCheck -->|是| LoadForm[載入申辦表單<br/>Apply()]

    LoadForm --> AutoFill[自動帶入會員資料<br/>姓名、身分證、地址等]
    AutoFill --> UserFill[使用者填寫表單<br/>證書類別、字號、補換發原因等]

    UserFill --> Validate{前端驗證}
    Validate -->|失敗| ShowError[顯示錯誤訊息]
    ShowError --> UserFill
    Validate -->|成功| Preview[預覽頁面<br/>PreView()]

    Preview --> ConfirmPreview{確認資料?}
    ConfirmPreview -->|否| UserFill
    ConfirmPreview -->|是| PayPage[繳費頁面<br/>Pay()]

    PayPage --> SelectPayMethod[選擇繳費方式<br/>信用卡/匯票/劃撥/臨櫃/超商]
    SelectPayMethod --> Save[儲存申請案<br/>Save()]

    Save --> PayMethodCheck{繳費方式?}

    PayMethodCheck -->|信用卡| GenAppID[產生申請案號<br/>GetApp_ID]
    GenAppID --> CreditCard[呼叫信用卡金流API<br/>RunCreditCardTranx]
    CreditCard --> CreditSuccess{交易成功?}
    CreditSuccess -->|否| DeleteApp[刪除空白申請案]
    DeleteApp --> ErrorPage[顯示錯誤頁面]
    CreditSuccess -->|是| SendMail1[寄送通知信<br/>SendMail_Proc]
    SendMail1 --> CompletePage[完成頁面]

    PayMethodCheck -->|其他方式| RunPayTranx[建立申請案與繳費資訊<br/>RunPayTranx]
    RunPayTranx --> PaySuccess{建立成功?}
    PaySuccess -->|否| ErrorPage
    PaySuccess -->|是| SendMail2[寄送通知信<br/>SendMail_Proc]
    SendMail2 --> CompletePage

    CompletePage --> End([結束])
    Login --> End
    ErrorPage --> End
```

### 5.2 補件流程圖

```mermaid
flowchart TD
    Start([使用者查詢案件]) --> AppDoc[補件查詢<br/>AppDoc]

    AppDoc --> QueryData[查詢申請案資料<br/>QueryApply_001005]
    QueryData --> CheckOwner{是否為申請人?}

    CheckOwner -->|否| AccessDenied[顯示權限錯誤]
    AccessDenied --> End([結束])

    CheckOwner -->|是| CheckStatus{案件狀態?}
    CheckStatus -->|非退件| NoNeedDoc[不需補件]
    NoNeedDoc --> End

    CheckStatus -->|退件| CheckDeadline{是否超過補件期限?}
    CheckDeadline -->|是| Expired[顯示期限已過訊息]
    Expired --> End

    CheckDeadline -->|否| ShowDocForm[顯示補件表單]
    ShowDocForm --> UserUpload[使用者上傳補件資料]

    UserUpload --> AppDocSave[儲存補件<br/>AppDocSave]
    AppDocSave --> BeginTran[開始 Transaction]

    BeginTran --> CheckModify{是否修改基本資料?}
    CheckModify -->|是| UpdateApply[更新 APPLY 資料表<br/>Update2]
    UpdateApply --> UpdateDetail[更新 APPLY_001005 資料表<br/>Update]

    CheckModify -->|否| CheckFile{是否有附件?}
    UpdateDetail --> CheckFile

    CheckFile -->|是| UploadFile[儲存附件檔案<br/>UploadFile]
    UploadFile --> CommitTran[提交 Transaction]

    CheckFile -->|否| CommitTran
    CommitTran --> UpdateFlow[更新案件狀態為「補件完成」]

    UpdateFlow --> SendNotify[寄送補件完成通知<br/>SendMail_Update]
    SendNotify --> Success[顯示成功訊息]
    Success --> End

    BeginTran --> Error{發生錯誤?}
    Error -->|是| Rollback[回復 Transaction]
    Rollback --> ShowError[顯示錯誤訊息]
    ShowError --> End
```

### 5.3 資料流程圖

```mermaid
flowchart LR
    subgraph Frontend["前端層 (Razor View + jQuery)"]
        View[Apply.cshtml<br/>申辦表單]
        Preview[PreView.cshtml<br/>預覽頁面]
        Pay[Pay.cshtml<br/>繳費頁面]
        Done[Done.cshtml<br/>完成頁面]
    end

    subgraph Controller["控制器層 (MVC Controller)"]
        ApplyAction[Apply<br/>載入表單]
        PreViewAction[PreView<br/>預覽]
        PayAction[Pay<br/>繳費]
        SaveAction[Save<br/>儲存]
        AppDocAction[AppDoc<br/>補件查詢]
        AppDocSaveAction[AppDocSave<br/>補件儲存]
    end

    subgraph DAO["資料存取層 (DAO)"]
        QueryDAO[QueryApply_001005<br/>查詢申請案]
        SaveDAO[SaveAppDoc001005<br/>儲存補件]
        PayDAO[RunPayTranx<br/>繳費交易]
        CreditDAO[RunCreditCardTranx<br/>信用卡交易]
        MailDAO[SendMail_Proc<br/>寄送通知]
    end

    subgraph Database["資料庫層 (SQL Server)"]
        APPLY[(APPLY<br/>申請案主表)]
        APPLY_001005[(APPLY_001005<br/>服務明細表)]
        APPLY_PAY[(APPLY_PAY<br/>繳費資訊表)]
        APPLY_FILE[(APPLY_FILE<br/>附件檔案表)]
    end

    View -->|POST| ApplyAction
    ApplyAction -->|ViewModel| Preview
    Preview -->|POST| PreViewAction
    PreViewAction -->|ViewModel| Pay
    Pay -->|POST| PayAction
    PayAction -->|ViewModel| SaveAction
    SaveAction -->|繳費| PayDAO
    SaveAction -->|信用卡| CreditDAO
    SaveAction -->|通知| MailDAO
    SaveAction -->|完成| Done

    View -->|補件| AppDocAction
    AppDocAction -->|查詢| QueryDAO
    QueryDAO -->|資料| AppDocAction
    AppDocAction -->|ViewModel| View
    View -->|POST| AppDocSaveAction
    AppDocSaveAction -->|儲存| SaveDAO
    AppDocSaveAction -->|通知| MailDAO
    AppDocSaveAction -->|完成| Done

    QueryDAO -->|SELECT| APPLY
    QueryDAO -->|SELECT| APPLY_001005
    QueryDAO -->|SELECT| APPLY_PAY

    PayDAO -->|INSERT| APPLY
    PayDAO -->|INSERT| APPLY_001005
    PayDAO -->|INSERT| APPLY_PAY

    SaveDAO -->|UPDATE| APPLY
    SaveDAO -->|UPDATE| APPLY_001005
    SaveDAO -->|INSERT| APPLY_FILE
```

### 5.4 案件狀態轉換圖

```mermaid
stateDiagram-v2
    [*] --> 新申請: 使用者送出申請<br/>FLOW_CD=1

    新申請 --> 審核中: 承辦人開始審核<br/>FLOW_CD=4

    審核中 --> 退件: 資料不齊全<br/>FLOW_CD=2
    審核中 --> 結案: 審核通過<br/>FLOW_CD=5

    退件 --> 補件完成: 使用者補件<br/>FLOW_CD=3
    補件完成 --> 審核中: 承辦人重新審核<br/>FLOW_CD=4

    退件 --> 逾期: 超過補件期限

    結案 --> [*]: 案件完成
    逾期 --> [*]: 案件關閉

    note right of 新申請
        使用者完成申請並繳費
        系統自動寄送通知信
    end note

    note right of 退件
        承辦人退件並說明原因
        使用者收到補件通知
        補件期限：7天
    end note

    note right of 補件完成
        使用者上傳補件資料
        系統更新案件狀態
        寄送補件完成通知
    end note

    note right of 結案
        承辦人核發證書
        系統寄送結案通知
        案件歸檔
    end note
```

## 6. ViewModel 與 Entity 詳解

### 6.1 Apply_001005ViewModel

**檔案位置：** `ES/Models/ViewModels/Apply_001005ViewModel.cs` (216 行)

**用途：** 用於前端與後端之間的資料傳遞，包含 UI 顯示所需的所有欄位。

```csharp
/// <summary>
/// 醫事人員證書補(換)發 ViewModel
/// 繼承自 Apply_001005Model (Entity)，並擴充 UI 所需的額外屬性
/// </summary>
public class Apply_001005ViewModel : Apply_001005Model
{
    // === 申請人基本資料 ===

    /// <summary>申請人姓名</summary>
    public string APPLY_NAME { get; set; }

    /// <summary>申請人身分證字號</summary>
    public string APPLY_PID { get; set; }

    /// <summary>申請日期（民國年格式）</summary>
    public string APPLY_DATE { get; set; }

    /// <summary>出生年月日（民國年格式）</summary>
    public string BIRTHDAY_AC { get; set; }

    // === 聯絡資訊 ===

    /// <summary>行動電話</summary>
    public string MOBILE { get; set; }

    /// <summary>電話區碼</summary>
    public string TEL_SEC { get; set; }

    /// <summary>電話號碼</summary>
    public string TEL_NO { get; set; }

    /// <summary>電話分機</summary>
    public string TEL_EXT { get; set; }

    // === Email 處理 ===

    /// <summary>Email 帳號（@之前）</summary>
    public string MAIL_ACCOUNT { get; set; }

    /// <summary>Email 網域（@之後）</summary>
    public string MAIL_DOMAIN { get; set; }

    /// <summary>Email 網域下拉選單值（1=gmail, 2=yahoo, 3=outlook, 0=其他）</summary>
    public string DOMAINList { get; set; }

    /// <summary>完整 Email</summary>
    public string MAIL { get; set; }

    // === 地址資訊 ===

    /// <summary>縣市鄉鎮代碼（郵遞區號）</summary>
    public string CITY_CODE { get; set; }

    /// <summary>縣市鄉鎮名稱</summary>
    public string CITY_TEXT { get; set; }

    /// <summary>詳細地址（街道門牌）</summary>
    public string CITY_DETAIL { get; set; }

    // === 證書資訊（文字說明） ===

    /// <summary>補換發類型文字（補發/換發）</summary>
    public string ACTION_TYPE_TEXT { get; set; }

    /// <summary>核發單位名稱</summary>
    public string ISSUE_DEPT_TEXT { get; set; }

    /// <summary>核發日期（民國年格式）</summary>
    public string ISSUE_DATE_AC { get; set; }

    /// <summary>證書類別名稱</summary>
    public string DIVISION_TEXT { get; set; }

    /// <summary>證書字號前綴文字</summary>
    public string LIC_CD_TEXT { get; set; }

    /// <summary>補換發原因文字</summary>
    public string ACTION_RES_TEXT { get; set; }

    // === 檔案上傳 ===

    /// <summary>上傳的附件檔案</summary>
    public HttpPostedFileBase ATTACH_FILE { get; set; }

    // === 繳費資訊 ===

    /// <summary>繳費方式（C=信用卡, D=匯票, T=劃撥, B=臨櫃, S=超商）</summary>
    public string PAY_METHOD { get; set; }

    /// <summary>應繳費用</summary>
    public int PAY_A_FEE { get; set; }

    /// <summary>客戶端 IP 位址</summary>
    public string CLIENT_IP { get; set; }

    /// <summary>是否啟用聯合信用卡中心（Y/N）</summary>
    public string ISEC { get; set; }

    // === 錯誤處理 ===

    /// <summary>錯誤代碼（0000=成功, -1=失敗）</summary>
    public string ErrorCode { get; set; }

    /// <summary>錯誤訊息</summary>
    public string ErrorMessage { get; set; }

    // === 巢狀物件 ===

    /// <summary>預覽用 ViewModel（用於顯示預覽頁面）</summary>
    public Apply_001005ViewModel PreView { get; set; }

    /// <summary>輔助 ViewModel（用於其他用途）</summary>
    public Apply_001005ViewModel AuxView { get; set; }

    /// <summary>申請案主表資料</summary>
    public ApplyModel Apply { get; set; }

    /// <summary>繳費資訊</summary>
    public APPLY_PAY ApplyPay { get; set; }

    /// <summary>附件檔案資訊</summary>
    public Apply_FileModel File { get; set; }

    // === 補件相關 ===

    /// <summary>是否允許補件（Y=允許, N=不允許）</summary>
    public string IsNotice { get; set; }
}
```

**設計說明：**

1. **繼承 Entity**：繼承 `Apply_001005Model`，擁有所有資料庫欄位
2. **UI 擴充欄位**：新增 UI 顯示所需的額外欄位（如：文字說明、分割欄位）
3. **資料分割**：將單一欄位分割為多個（如：電話分為區碼、號碼、分機）
4. **巢狀物件**：包含其他相關的 Model（如：Apply、ApplyPay）
5. **檔案上傳**：使用 `HttpPostedFileBase` 處理檔案上傳
6. **錯誤處理**：包含錯誤代碼和訊息欄位

### 6.2 Apply_001005Model (Entity)

**檔案位置：** `ES/Models/Entities/Apply_001005Model.cs` (121 行)

**用途：** 對應資料庫 `APPLY_001005` 資料表，用於 ORM 映射。

```csharp
/// <summary>
/// 醫事人員證書補(換)發 Entity
/// 對應資料庫 APPLY_001005 資料表
/// </summary>
[Table("APPLY_001005")]
public class Apply_001005Model
{
    /// <summary>申請案號（主鍵）</summary>
    [Key]
    [StringLength(20)]
    public string APP_ID { get; set; }

    /// <summary>補換發類型（1=補發, 2=換發）</summary>
    [StringLength(1)]
    public string ACTION_TYPE { get; set; }

    /// <summary>核發單位代碼</summary>
    [StringLength(10)]
    public string ISSUE_DEPT { get; set; }

    /// <summary>核發日期（民國年 YYYMMDD）</summary>
    [StringLength(7)]
    public string ISSUE_DATE { get; set; }

    /// <summary>證書類型</summary>
    [StringLength(2)]
    public string LIC_TYPE { get; set; }

    /// <summary>證書字號前綴</summary>
    [StringLength(10)]
    public string LIC_CD { get; set; }

    /// <summary>證書號碼</summary>
    [StringLength(10)]
    public string LIC_NUM { get; set; }

    /// <summary>補換發原因代碼</summary>
    [StringLength(2)]
    public string ACTION_RES { get; set; }

    /// <summary>其他原因說明</summary>
    [StringLength(200)]
    public string OTHER_RES { get; set; }

    /// <summary>Email</summary>
    [StringLength(100)]
    public string EMAIL { get; set; }

    /// <summary>證書類別代碼</summary>
    [StringLength(2)]
    public string DIVISION { get; set; }

    // === 系統欄位 ===

    /// <summary>刪除標記（Y=已刪除, N=未刪除）</summary>
    [StringLength(1)]
    public string DEL_MK { get; set; }

    /// <summary>刪除時間</summary>
    public DateTime? DEL_TIME { get; set; }

    /// <summary>刪除功能代碼</summary>
    [StringLength(20)]
    public string DEL_FUN_CD { get; set; }

    /// <summary>刪除帳號</summary>
    [StringLength(20)]
    public string DEL_ACC { get; set; }

    /// <summary>更新時間</summary>
    public DateTime? UPD_TIME { get; set; }

    /// <summary>更新功能代碼</summary>
    [StringLength(20)]
    public string UPD_FUN_CD { get; set; }

    /// <summary>更新帳號</summary>
    [StringLength(20)]
    public string UPD_ACC { get; set; }

    /// <summary>新增時間</summary>
    [Required]
    public DateTime ADD_TIME { get; set; }

    /// <summary>新增功能代碼</summary>
    [StringLength(20)]
    public string ADD_FUN_CD { get; set; }

    /// <summary>新增帳號</summary>
    [StringLength(20)]
    public string ADD_ACC { get; set; }
}
```

**設計說明：**

1. **Table 屬性**：指定對應的資料表名稱
2. **Key 屬性**：標記主鍵欄位
3. **StringLength 屬性**：限制字串長度，對應資料庫欄位長度
4. **Required 屬性**：標記必填欄位
5. **Nullable 型別**：使用 `DateTime?` 表示可為 NULL 的欄位
6. **系統欄位**：包含新增、更新、刪除的時間和帳號，用於稽核

## 7. 技術重點總結

### 7.1 安全性機制

1. **登入驗證**：繼承 `BaseController`，自動檢查登入狀態
2. **權限控管**：檢查 `ACC_NO` 確認是否為案件申請人
3. **參數化查詢**：使用 Dapper 參數化查詢，防止 SQL Injection
4. **IP 記錄**：記錄使用者 IP 位址，用於安全稽核
5. **憑證登入**：支援自然人憑證、工商憑證、醫事人員憑證登入

### 7.2 資料一致性

1. **Transaction 處理**：使用 `SqlTransaction` 確保資料一致性
2. **錯誤回復**：發生錯誤時自動回復所有變更
3. **歷程記錄**：使用 `Update2()` 方法自動記錄資料變更歷程
4. **狀態管理**：透過 `FLOW_CD` 管理案件狀態轉換

### 7.3 使用者體驗

1. **資料自動帶入**：從會員資料自動填入申請人資訊
2. **即時驗證**：前端 JavaScript 驗證，提供即時回饋
3. **步驟指示**：顯示申辦步驟，讓使用者了解進度
4. **預覽功能**：送出前可預覽資料，減少錯誤
5. **Email 通知**：各階段自動寄送通知信

### 7.4 效能優化

1. **Dapper ORM**：使用輕量級 ORM，效能優於 Entity Framework
2. **索引設計**：在常用查詢欄位建立索引（SRV_ID, ACC_NO, IDN, FLOW_CD）
3. **PartialView**：使用部分視圖，減少頁面重新載入
4. **AJAX 更新**：使用 AJAX 更新頁面區塊，提升使用者體驗

### 7.5 維護性

1. **程式碼註解**：完整的 XML 註解，說明每個方法的用途
2. **錯誤日誌**：使用 logger 記錄錯誤，便於問題追蹤
3. **設定檔管理**：繳費金額、期限等參數儲存在資料庫，便於調整
4. **模組化設計**：DAO 層獨立，便於重複使用和測試

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
