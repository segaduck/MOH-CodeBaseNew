# 001005 - 醫事人員或公共衛生師證書補(換)發 - 服務專屬文件

## 文件說明

本文件說明 **001005 醫事人員或公共衛生師證書補(換)發** 服務的專屬特性和差異。

**閱讀順序：**
1. 先閱讀 `_證書補換發服務_共用架構文件.md` 了解共用架構
2. 再閱讀本文件了解 001005 服務的專屬特性

---

## 服務基本資訊

| 項目         | 內容                                                     |
| ------------ | -------------------------------------------------------- |
| 服務代碼     | 001005                                                   |
| 服務名稱     | 醫事人員或公共衛生師證書補(換)發                         |
| 業務單位     | 醫事司                                                   |
| 是否需繳費   | 是                                                       |
| 申請對象     | 已取得醫事人員或公共衛生師證書者                         |
| Controller   | `ES/Controllers/Apply_001005Controller.cs` (368 行)      |
| ViewModel    | `ES/Models/ViewModels/Apply_001005ViewModel.cs` (216 行) |
| Entity Model | `ES/Models/Entities/Apply_001005Model.cs` (121 行)       |
| View         | `ES/Views/Apply_001005/Apply.cshtml` (512 行)            |
| DAO 方法     | `ApplyDAO.QueryApply_001005()`, `SaveAppDoc001005()`     |
| 主要資料表   | `APPLY`, `APPLY_001005`, `APPLY_FILE`, `APPLY_PAY`       |

---

## 服務專屬欄位

### APPLY_001005 資料表專屬欄位

除了共用欄位外，APPLY_001005 資料表還包含以下專屬欄位：

| 欄位名稱    | 資料型別 | 長度 | NULL | 說明                                            | 範例值 |
| ----------- | -------- | ---- | ---- | ----------------------------------------------- | ------ |
| ISSUE_DEPT  | varchar  | 10   | YES  | 核發單位代碼                                    | 001    |
| LIC_TYPE    | varchar  | 2    | YES  | 證書類型                                        | 01     |
| DIVISION    | varchar  | 2    | YES  | 證書類別代碼（醫事人員類別）                    | 01     |

**欄位說明：**

1. **ISSUE_DEPT**：核發單位代碼
   - 用於記錄原證書的核發單位
   - 例如：001=衛生福利部

2. **LIC_TYPE**：證書類型
   - 用於區分不同類型的證書
   - 例如：01=醫師證書, 02=護理師證書

3. **DIVISION**：證書類別代碼（醫事人員類別）
   - **這是 001005 的關鍵專屬欄位**
   - 用於儲存醫事人員的類別
   - 與 001007 的 `LIC_TYPE` 欄位功能類似，但代碼值不同

**證書類別代碼 (DIVISION) 對照表：**

| 代碼 | 類別名稱       | 說明                   |
| ---- | -------------- | ---------------------- |
| 01   | 醫師           | 醫師證書               |
| 02   | 護理師         | 護理師證書             |
| 03   | 藥師           | 藥師證書               |
| 04   | 醫事檢驗師     | 醫事檢驗師證書         |
| 05   | 醫事放射師     | 醫事放射師證書         |
| 06   | 物理治療師     | 物理治療師證書         |
| 07   | 職能治療師     | 職能治療師證書         |
| 08   | 呼吸治療師     | 呼吸治療師證書         |
| 09   | 營養師         | 營養師證書             |
| 10   | 臨床心理師     | 臨床心理師證書         |
| 11   | 諮商心理師     | 諮商心理師證書         |
| 12   | 語言治療師     | 語言治療師證書         |
| 13   | 聽力師         | 聽力師證書             |
| 14   | 牙體技術師     | 牙體技術師證書         |
| 15   | 驗光師         | 驗光師證書             |
| 16   | 公共衛生師     | 公共衛生師證書         |

---

## ViewModel 專屬屬性

### Apply_001005ViewModel 專屬屬性

```csharp
/// <summary>
/// 醫事人員證書補(換)發 ViewModel
/// </summary>
public class Apply_001005ViewModel : Apply_001005Model
{
    // === 共用屬性（參考共用架構文件）===
    // ...
    
    // === 服務專屬屬性 ===
    
    /// <summary>核發單位代碼</summary>
    public string ISSUE_DEPT { get; set; }
    
    /// <summary>核發單位名稱（用於顯示）</summary>
    public string ISSUE_DEPT_NAME { get; set; }
    
    /// <summary>證書類型代碼</summary>
    public string LIC_TYPE { get; set; }
    
    /// <summary>證書類型名稱（用於顯示）</summary>
    public string LIC_TYPE_NAME { get; set; }
    
    /// <summary>證書類別代碼（醫事人員類別）</summary>
    [Display(Name = "證書類別")]
    [Required(ErrorMessage = "請選擇證書類別")]
    public string DIVISION { get; set; }
    
    /// <summary>證書類別名稱（用於顯示）</summary>
    public string DIVISION_NAME { get; set; }
    
    /// <summary>證書類別下拉選單資料來源</summary>
    public List<SelectListItem> DivisionList { get; set; }
}
```

---

## Entity Model 專屬屬性

### Apply_001005Model 專屬屬性

```csharp
/// <summary>
/// 醫事人員證書補(換)發 Entity Model
/// 對應資料表：APPLY_001005
/// </summary>
public class Apply_001005Model
{
    // === 共用屬性（參考共用架構文件）===
    public string APP_ID { get; set; }
    public string ACTION_TYPE { get; set; }
    public DateTime? ISSUE_DATE { get; set; }
    public string LIC_CD { get; set; }
    public string LIC_NUM { get; set; }
    public string ACTION_RES { get; set; }
    public string OTHER_RES { get; set; }
    public string EMAIL { get; set; }
    
    // === 服務專屬屬性 ===
    
    /// <summary>核發單位代碼</summary>
    public string ISSUE_DEPT { get; set; }
    
    /// <summary>證書類型</summary>
    public string LIC_TYPE { get; set; }
    
    /// <summary>證書類別代碼（醫事人員類別）</summary>
    public string DIVISION { get; set; }
    
    // === 標準欄位 ===
    public string DEL_MK { get; set; }
    public DateTime? DEL_TIME { get; set; }
    public string DEL_FUN_CD { get; set; }
    public string DEL_ACC { get; set; }
    public DateTime? UPD_TIME { get; set; }
    public string UPD_FUN_CD { get; set; }
    public string UPD_ACC { get; set; }
    public DateTime ADD_TIME { get; set; }
    public string ADD_FUN_CD { get; set; }
    public string ADD_ACC { get; set; }
}
```

---

## View 專屬欄位

### 證書資訊區塊（服務專屬）

```cshtml
<!-- 證書類別：下拉選單 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="DIVISION">
        <span class="text-danger">*</span>證書類別
    </label>
    <div class="col-sm-10">
        @Html.DropDownListFor(m => m.DIVISION, 
            Model.DivisionList ?? new List<SelectListItem>(), 
            "請選擇證書類別", 
            new { @class = "form-control", required = "required" })
        @Html.ValidationMessageFor(m => m.DIVISION, "", new { @class = "text-danger" })
    </div>
</div>

<!-- 核發單位：下拉選單 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="ISSUE_DEPT">核發單位</label>
    <div class="col-sm-10">
        @Html.DropDownListFor(m => m.ISSUE_DEPT, 
            srcList.GetCodeList("ISSUE_DEPT"), 
            "請選擇核發單位", 
            new { @class = "form-control" })
    </div>
</div>

<!-- 證書類型：下拉選單 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="LIC_TYPE">證書類型</label>
    <div class="col-sm-10">
        @Html.DropDownListFor(m => m.LIC_TYPE, 
            srcList.GetCodeList("LIC_TYPE_001005"), 
            "請選擇證書類型", 
            new { @class = "form-control" })
    </div>
</div>

<!-- 補換發類型：單選按鈕 -->
<div class="form-group">
    <label class="step-label col-sm-2">
        <span class="text-danger">*</span>補換發類型
    </label>
    <div class="col-sm-10">
        <label class="radio-inline">
            @Html.RadioButtonFor(m => m.ACTION_TYPE, "1", new { required = "required" })
            補發（證書遺失、毀損）
        </label>
        <label class="radio-inline">
            @Html.RadioButtonFor(m => m.ACTION_TYPE, "2", new { required = "required" })
            換發（變更姓名等）
        </label>
    </div>
</div>

<!-- 證書字號 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="LIC_CD">
        <span class="text-danger">*</span>證書字號
    </label>
    <div class="col-sm-10">
        <div class="row">
            <div class="col-sm-3">
                @Html.TextBoxFor(m => m.LIC_CD, new { 
                    @class = "form-control", 
                    placeholder = "字（如：醫師）",
                    required = "required",
                    maxlength = "10"
                })
            </div>
            <div class="col-sm-1 text-center" style="padding-top: 7px;">字第</div>
            <div class="col-sm-4">
                @Html.TextBoxFor(m => m.LIC_NUM, new { 
                    @class = "form-control", 
                    placeholder = "號（如：123456）",
                    required = "required",
                    maxlength = "10"
                })
            </div>
            <div class="col-sm-1 text-center" style="padding-top: 7px;">號</div>
        </div>
    </div>
</div>

<!-- 核發日期 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="ISSUE_DATE">核發日期</label>
    <div class="col-sm-10">
        @Html.TextBoxFor(m => m.ISSUE_DATE, "{0:yyy/MM/dd}", new { 
            @class = "form-control datepicker", 
            placeholder = "民國年格式（如：109/01/01）",
            maxlength = "10"
        })
        <span class="help-block">請輸入原證書的核發日期（民國年格式）</span>
    </div>
</div>

<!-- 補換發原因 -->
<div class="form-group">
    <label class="step-label col-sm-2" for="ACTION_RES">
        <span class="text-danger">*</span>補換發原因
    </label>
    <div class="col-sm-10">
        @Html.DropDownListFor(m => m.ACTION_RES, 
            new List<SelectListItem> {
                new SelectListItem { Value = "01", Text = "遺失" },
                new SelectListItem { Value = "02", Text = "毀損" },
                new SelectListItem { Value = "03", Text = "變更姓名" },
                new SelectListItem { Value = "99", Text = "其他" }
            }, 
            "請選擇補換發原因", 
            new { @class = "form-control", required = "required", id = "ACTION_RES" })
    </div>
</div>

<!-- 其他原因說明：當選擇「其他」時顯示 -->
<div class="form-group" id="OTHER_RES_DIV" style="display:none;">
    <label class="step-label col-sm-2" for="OTHER_RES">
        <span class="text-danger">*</span>其他原因說明
    </label>
    <div class="col-sm-10">
        @Html.TextAreaFor(m => m.OTHER_RES, new { 
            @class = "form-control", 
            rows = "3",
            placeholder = "請詳細說明補換發原因",
            maxlength = "200"
        })
    </div>
</div>
```

### JavaScript 專屬驗證邏輯

```javascript
<script type="text/javascript">
$(document).ready(function() {
    // 補換發原因變更時，顯示/隱藏「其他原因說明」欄位
    $("#ACTION_RES").change(function() {
        if ($(this).val() == "99") {
            $("#OTHER_RES_DIV").show();
            $("#OTHER_RES").attr("required", "required");
        } else {
            $("#OTHER_RES_DIV").hide();
            $("#OTHER_RES").removeAttr("required");
            $("#OTHER_RES").val("");
        }
    });
    
    // 證書類別變更時，更新證書字號的預設值
    $("#DIVISION").change(function() {
        var divisionText = $("#DIVISION option:selected").text();
        // 自動帶入證書字號的「字」部分
        if (divisionText && divisionText != "請選擇證書類別") {
            $("#LIC_CD").val(divisionText);
        }
    });
    
    // 表單送出前驗證
    $("#main_form").submit(function(e) {
        // 驗證證書類別
        if (!$("#DIVISION").val()) {
            alert("請選擇證書類別");
            $("#DIVISION").focus();
            return false;
        }
        
        // 驗證補換發類型
        if (!$("input[name='ACTION_TYPE']:checked").val()) {
            alert("請選擇補換發類型");
            return false;
        }
        
        // 驗證證書字號
        if (!$("#LIC_CD").val() || !$("#LIC_NUM").val()) {
            alert("請輸入完整的證書字號");
            return false;
        }
        
        // 驗證補換發原因
        if (!$("#ACTION_RES").val()) {
            alert("請選擇補換發原因");
            $("#ACTION_RES").focus();
            return false;
        }
        
        // 如果選擇「其他」，必須填寫說明
        if ($("#ACTION_RES").val() == "99" && !$("#OTHER_RES").val()) {
            alert("請填寫其他原因說明");
            $("#OTHER_RES").focus();
            return false;
        }
        
        return true;
    });
});
</script>
```

---

## DAO 方法專屬實作

### QueryApply_001005() - 查詢申請案

```csharp
/// <summary>
/// 查詢 001005 申請案資料
/// </summary>
public Apply_001005ViewModel QueryApply_001005(string appId)
{
    string sql = @"
        SELECT 
            a.APP_ID, a.SRV_ID, a.ACC_NO, a.IDN, a.NAME, a.BIRTHDAY,
            a.MOBILE, a.TEL_SEC, a.TEL_NO, a.TEL_EXT, a.EMAIL,
            a.CITY_CODE, a.CITY_TEXT, a.CITY_DETAIL, a.ADDRESS,
            a.FLOW_CD, a.APPLY_DATE, a.IP,
            d.ACTION_TYPE, d.ISSUE_DEPT, d.ISSUE_DATE, d.LIC_TYPE,
            d.LIC_CD, d.LIC_NUM, d.ACTION_RES, d.OTHER_RES, d.DIVISION
        FROM APPLY a
        INNER JOIN APPLY_001005 d ON a.APP_ID = d.APP_ID
        WHERE a.APP_ID = @APP_ID
          AND a.DEL_MK = 'N'
    ";
    
    using (var conn = new SqlConnection(connectionString))
    {
        var result = conn.Query<Apply_001005ViewModel>(sql, new { APP_ID = appId }).FirstOrDefault();
        
        // 查詢附件清單
        if (result != null)
        {
            result.Files = QueryApplyFiles(appId);
        }
        
        return result;
    }
}
```

### InsertApply001005() - 新增申請案明細

```csharp
/// <summary>
/// 新增 APPLY_001005 明細資料
/// </summary>
public void InsertApply001005(Apply_001005ViewModel model, SqlTransaction trans)
{
    string sql = @"
        INSERT INTO APPLY_001005 (
            APP_ID, ACTION_TYPE, ISSUE_DEPT, ISSUE_DATE, LIC_TYPE,
            LIC_CD, LIC_NUM, ACTION_RES, OTHER_RES, EMAIL, DIVISION,
            ADD_TIME, ADD_FUN_CD, ADD_ACC
        ) VALUES (
            @APP_ID, @ACTION_TYPE, @ISSUE_DEPT, @ISSUE_DATE, @LIC_TYPE,
            @LIC_CD, @LIC_NUM, @ACTION_RES, @OTHER_RES, @EMAIL, @DIVISION,
            GETDATE(), 'WEB-APPLY', @ADD_ACC
        )
    ";
    
    trans.Connection.Execute(sql, new
    {
        APP_ID = model.APP_ID,
        ACTION_TYPE = model.ACTION_TYPE,
        ISSUE_DEPT = model.ISSUE_DEPT,
        ISSUE_DATE = model.ISSUE_DATE,
        LIC_TYPE = model.LIC_TYPE,
        LIC_CD = model.LIC_CD,
        LIC_NUM = model.LIC_NUM,
        ACTION_RES = model.ACTION_RES,
        OTHER_RES = model.OTHER_RES,
        EMAIL = model.MAIL,
        DIVISION = model.DIVISION,  // 關鍵專屬欄位
        ADD_ACC = model.ADD_ACC
    }, trans);
}
```

---

## 與其他服務的差異

### 與 001007（專科醫師證書補換發）的差異

| 項目           | 001005                     | 001007                 |
| -------------- | -------------------------- | ---------------------- |
| 服務名稱       | 醫事人員證書補(換)發       | 專科醫師證書補(換)發   |
| 證書類別欄位   | `DIVISION`                 | `LIC_TYPE`             |
| 證書類別內容   | 醫事人員類別（醫師、護理師等） | 專科醫師類別（內科、外科等） |
| 核發單位欄位   | `ISSUE_DEPT`               | 無                     |
| 證書類型欄位   | `LIC_TYPE`                 | 無                     |
| 申請對象       | 所有醫事人員               | 僅限專科醫師           |

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
