# 001037 醫事人員或公共衛生師請領無懲戒紀錄證明申請書 - 完整技術文件

## 服務基本資訊

| 項目             | 內容                                                     |
| ---------------- | -------------------------------------------------------- |
| **服務代碼**     | 001037                                                   |
| **服務名稱**     | 醫事人員或公共衛生師請領無懲戒紀錄證明申請書             |
| **業務單位**     | 醫事司（UNIT_CD = 4）                                    |
| **是否需繳費**   | 是                                                       |
| **Controller**   | `ES/Controllers/Apply_001037Controller.cs` (367 行)      |
| **ViewModel**    | `ES/Models/ViewModels/Apply_001037ViewModel.cs` (234 行) |
| **Entity Model** | `ES/Models/Entities/Apply_001037Model.cs` (202 行)       |
| **主要資料表**   | APPLY, APPLY_001037, APPLY_FILE, APPLY_PAY               |
| **檔案數量**     | 3 個檔案上傳欄位（可選）                                 |

---

## 服務特色

### 與其他服務的差異

| 項目         | 001005 證書補換發 | 001008 英文證明書 | 001037 無懲戒紀錄證明 |
| ------------ | ----------------- | ----------------- | --------------------- |
| **服務性質** | 證書補換發        | 英文證明書        | **無懲戒紀錄證明**    |
| **繳費方式** | 5 種              | 無                | **5 種**              |
| **申請份數** | 1 份              | 1 份              | **可選擇份數**        |
| **申請理由** | 補換發原因        | 無                | **5 種申請理由**      |
| **郵寄地址** | 戶籍地址          | 無                | **可選擇郵寄地址**    |
| **附件上傳** | 1 個檔案          | 無                | **3 個檔案（可選）**  |
| **複雜度**   | ⭐⭐⭐ 中         | ⭐⭐⭐⭐ 高       | **⭐⭐⭐⭐ 高**       |

### 核心功能

1. **申請理由選擇**

   - 申請移民
   - 出國使用
   - 前往國外
   - 國內使用
   - 其他

2. **申請份數選擇**

   - 可選擇申請份數
   - 自動計算總金額

3. **郵寄地址選擇**

   - 可選擇郵寄地址（戶籍地址或其他地址）
   - 支援國外郵寄

4. **附件上傳**

   - 3 個檔案上傳欄位（可選）
   - 支援 PDF 格式

5. **繳費方式**
   - 信用卡線上刷卡
   - 匯票
   - 劃撥
   - 臨櫃
   - 超商

---

## 系統架構

### 架構圖

```
使用者 → Controller → DAO → Database
         ↓
      ViewModel
         ↓
      Razor View
```

**說明：**

- 使用者透過瀏覽器填寫表單
- Controller 接收請求並處理業務邏輯
- ViewModel 負責資料驗證和格式轉換
- DAO 負責資料庫操作
- Razor View 負責頁面呈現

### 資料流程圖

```
1. 申請流程：
   使用者填寫表單 → 選擇申請理由 → 選擇申請份數 → 選擇郵寄地址 → 上傳附件 → 預覽 → 選擇繳費方式 → 繳費 → 完成

2. 儲存流程：
   Controller.Save() → DAO.RunCreditCardTranx() / RunPayTranx() →
   INSERT APPLY → INSERT APPLY_001037 → INSERT APPLY_FILE → INSERT APPLY_PAY →
   寄送通知郵件 → 顯示完成頁面

3. 補件流程：
   Controller.AppDoc() → DAO.QueryApply_001037() →
   顯示原申請資料 → 上傳補件檔案 →
   Controller.AppDocSave() → DAO.SaveAppDoc001037() →
   更新資料 → 寄送補件完成郵件
```

---

## 資料庫結構

### 1. APPLY 資料表（主表）

**說明：** 所有申辦案件的主表

**主要欄位：**

- `APP_ID` (PK)：案件編號
- `SRV_ID`：服務代碼（001037）
- `ACC_NO`：申請人帳號
- `NAME`：申請人姓名
- `IDN`：申請人身分證字號
- `FLOW_CD`：流程狀態（1:申請中, 2:補件中, 3:補件完成）
- `UNIT_CD`：業務單位（4:醫事司）
- `APP_TIME`：申請時間
- `APP_EXT_DATE`：展延日期

### 2. APPLY_001037 資料表（服務明細表）

**說明：** 001037 服務的詳細資料

**主要欄位：**

| 欄位名稱                                      | 資料型別 | 長度 | NULL | 說明                | 範例值             |
| --------------------------------------------- | -------- | ---- | ---- | ------------------- | ------------------ |
| `APP_ID`                                      | varchar  | 50   | NO   | 案件編號（PK）      | 001037202501130001 |
| `LIC_CD`                                      | varchar  | 10   | YES  | 證書類別代碼        | 01                 |
| `LIC_NUM`                                     | varchar  | 50   | YES  | 證書字號            | 醫字第 123456 號   |
| `ISSUE_DATE`                                  | datetime | -    | YES  | 發證日期            | 2020-01-01         |
| `COPIES`                                      | int      | -    | YES  | 申請份數            | 2                  |
| `TOTAL`                                       | int      | -    | YES  | 總金額              | 400                |
| `MAIL_REC`                                    | varchar  | 100  | YES  | 收件人              | 王小明             |
| `MAIL_ADDR`                                   | varchar  | 200  | YES  | 郵寄地址            | 台北市中正區...    |
| `MAIL_COUNTRY`                                | varchar  | 50   | YES  | 郵寄國家            | 台灣               |
| `REASON_1`                                    | varchar  | 1    | YES  | 申請移民（Y/N）     | Y                  |
| `REASON_2`                                    | varchar  | 1    | YES  | 出國使用（Y/N）     | N                  |
| `REASON_2_DESC`                               | varchar  | 200  | YES  | 出國使用說明        | -                  |
| `REASON_3`                                    | varchar  | 1    | YES  | 前往國外（Y/N）     | N                  |
| `REASON_3_DESC`                               | varchar  | 200  | YES  | 前往國外說明        | -                  |
| `REASON_4`                                    | varchar  | 1    | YES  | 國內使用（Y/N）     | N                  |
| `REASON_4_DESC`                               | varchar  | 200  | YES  | 國內使用說明        | -                  |
| `REASON_5`                                    | varchar  | 1    | YES  | 其他（Y/N）         | N                  |
| `REASON_5_DESC`                               | varchar  | 200  | YES  | 其他說明            | -                  |
| `ATTACH_1`                                    | varchar  | 200  | YES  | 附件檔案名稱 1      | file1.pdf          |
| `ATTACH_2`                                    | varchar  | 200  | YES  | 附件檔案名稱 2      | file2.pdf          |
| `MAIL_DATE`                                   | datetime | -    | YES  | 郵寄日期            | 2025-01-15         |
| `MAIL_BARCODE`                                | varchar  | 50   | YES  | 郵寄條碼            | 1234567890         |
| `IS_MERGE_FILE`                               | varchar  | 1    | YES  | 是否合併檔案（Y/N） | Y                  |
| `EMAIL`                                       | varchar  | 100  | YES  | Email               | test@example.com   |
| `ADDR_CODE`                                   | varchar  | 10   | YES  | 郵寄地址代碼        | 100                |
| `IS_FILE1`                                    | varchar  | 1    | YES  | 檔案上傳一（Y/N）   | Y                  |
| `IS_FILE2`                                    | varchar  | 1    | YES  | 檔案上傳二（Y/N）   | N                  |
| `IS_FILE3`                                    | varchar  | 1    | YES  | 檔案上傳三（Y/N）   | N                  |
| **標準欄位**                                  |          |      |      |                     |                    |
| `ADD_TIME`, `ADD_FUN_CD`, `ADD_ACC`           |          |      |      | 新增資訊            |                    |
| `UPD_TIME`, `UPD_FUN_CD`, `UPD_ACC`           |          |      |      | 更新資訊            |                    |
| `DEL_MK`, `DEL_TIME`, `DEL_FUN_CD`, `DEL_ACC` |          |      |      | 刪除資訊            |                    |

### 3. APPLY_FILE 資料表（附件檔案表）

**說明：** 儲存所有案件的附件檔案

**主要欄位：**

- `APP_ID` (PK)：案件編號
- `FILE_NO` (PK)：檔案編號（1~3）
- `FILENAME`：實際檔案名稱（儲存在伺服器）
- `SRC_FILENAME`：原始檔案名稱
- `SRC_NO`：檔案來源編號（1~3）

### 4. APPLY_PAY 資料表（繳費資料表）

**說明：** 儲存所有案件的繳費資料

**主要欄位：**

- `APP_ID` (PK)：案件編號
- `PAY_ID`：繳費編號
- `PAY_MONEY`：繳費金額
- `PAY_METHOD`：繳費方式（C:信用卡, D:匯票, T:劃撥, B:臨櫃, S:超商）
- `PAY_STATUS_MK`：繳費狀態
- `PAY_RET_CD`：繳費回傳代碼
- `PAY_RET_MSG`：繳費回傳訊息

---

## ViewModel 結構

### Apply_001037ViewModel

**繼承：** Apply_001037Model

**主要屬性：**

```csharp
public class Apply_001037ViewModel : Apply_001037Model
{
    // 基本資訊
    public string APP_ID { get; set; }
    public string APPLY_NAME { get; set; }  // 申請人姓名
    public string APPLY_PID { get; set; }  // 申請人身分證字號
    public string APPLY_DATE { get; set; }  // 申請日期（民國年）
    public string APP_EXT_DATE { get; set; }  // 展延日期
    public string MOBILE { get; set; }  // 手機號碼

    // 電話資訊
    public string TEL { get; set; }  // 電話號碼（完整）
    public string TEL_SEC { get; set; }  // 電話區碼
    public string TEL_NO { get; set; }  // 電話號碼
    public string TEL_EXT { get; set; }  // 電話分機

    // Email 資訊
    public string MAIL { get; set; }  // Email（完整）
    public string MAIL_ACCOUNT { get; set; }  // Email 帳號
    public string MAIL_DOMAIN { get; set; }  // Email 網域
    public string DOMAINList { get; set; }  // Email 網域選單

    // 戶籍地址
    public string FULL_ADDRESS { get; set; }  // 完整地址
    public string CITY_CODE { get; set; }  // 地址代碼
    public string CITY_TEXT { get; set; }  // 縣市鄉鎮
    public string CITY_DETAIL { get; set; }  // 詳細地址

    // 郵寄地址
    public string MAIL_FULL_ADDRESS { get; set; }  // 完整郵寄地址
    public string MAIL_CITY_CODE { get; set; }  // 郵寄地址代碼
    public string MAIL_CITY_TEXT { get; set; }  // 郵寄縣市鄉鎮
    public string MAIL_CITY_DETAIL { get; set; }  // 郵寄詳細地址

    // 附件檔案
    public HttpPostedFileBase FILE1 { get; set; }  // 附件檔案 1
    public string FILE1_NAME { get; set; }  // 附件檔案名稱 1
    public string FILE1_CHECK { get; set; }  // 附件檔案勾選 1

    public HttpPostedFileBase FILE2 { get; set; }  // 附件檔案 2
    public string FILE2_NAME { get; set; }  // 附件檔案名稱 2
    public string FILE2_CHECK { get; set; }  // 附件檔案勾選 2

    public HttpPostedFileBase FILE3 { get; set; }  // 附件檔案 3
    public string FILE3_NAME { get; set; }  // 附件檔案名稱 3
    public string FILE3_CHECK { get; set; }  // 附件檔案勾選 3

    // 繳費資訊
    public string PAY_METHOD { get; set; }  // 繳費方式
    public int? PAY_A_FEE { get; set; }  // 繳費金額
    public string CARD_IDN { get; set; }  // 信用卡身分證字號
    public string CLIENT_IP { get; set; }  // 客戶端 IP
    public string ISEC { get; set; }  // 是否啟用電子化政府

    // 控制欄位
    public ApplyModel Apply { get; set; }  // APPLY 實體
    public APPLY_PAY ApplyPay { get; set; }  // APPLY_PAY 實體
    public Apply_001037ViewModel PreView { get; set; }  // 預覽資料
    public string IsNotice { get; set; }  // 是否顯示補件通知
    public string ErrorCode { get; set; }  // 錯誤代碼
    public string ErrorMessage { get; set; }  // 錯誤訊息
}
```

---

## Controller 實作

### Apply_001037Controller

**檔案位置：** `ES/Controllers/Apply_001037Controller.cs`

**繼承：** BaseController

**主要方法：**

#### 1. Prompt() - 說明事項頁面

```csharp
public ActionResult Prompt()
{
    SessionModel sm = SessionModel.Get();
    string s_msg_1A = "請先閱讀 「{0}說明事項」點選同意後，再進入申辦頁面 !";
    sm.LastErrorMessage = string.Format(s_msg_1A, s_SRV_NAME);
    return View("Prompt001037");
}
```

#### 2. Apply() - 申請表單頁面

```csharp
[DisplayName("Apply_001037_申請")]
public ActionResult Apply(string agree)
{
    ApplyDAO dao = new ApplyDAO();
    SessionModel sm = SessionModel.Get();
    Apply_001037ViewModel form = new Apply_001037ViewModel();

    // 檢查登入狀態
    if (sm == null || sm.UserInfo == null || sm.UserInfo.Member == null)
    {
        return RedirectToAction("Index", "Login");
    }

    // 檢查是否同意說明事項
    if (string.IsNullOrEmpty(agree)) { agree = "0"; }
    if (agree != null && !agree.Equals("1")) { return Prompt(); }

    // 帶入會員資訊
    form.APPLY_NAME = sm.UserInfo.Member.NAME;
    form.APPLY_PID = sm.UserInfo.Member.IDN;
    form.BIRTHDAY_AC = HelperUtil.DateTimeToString(sm.UserInfo.Member.BIRTHDAY);
    form.MOBILE = sm.UserInfo.Member.MOBILE;
    form.Apply = new ApplyModel();
    form.Apply.ENAME = sm.UserInfo.Member.ENAME;

    // 帶入地址、電話、Email 資訊（省略詳細程式碼）

    form.APPLY_DATE = HelperUtil.DateTimeToTwString(DateTime.Now);
    return View(form);
}
```

#### 3. PreView() - 預覽申請內容

```csharp
[DisplayName("Apply_001037_預覽")]
[HttpPost]
public ActionResult PreView(Apply_001037ViewModel model)
{
    ShareDAO dao = new ShareDAO();
    model.PreView = new Apply_001037ViewModel();
    model.PreView.InjectFrom(model);

    return PartialView("PreView001037", model);
}
```

#### 4. Pay() - 繳費頁面

```csharp
[DisplayName("Apply_001037_繳費")]
[HttpPost]
public ActionResult Pay(Apply_001037ViewModel model)
{
    ApplyDAO dao = new ApplyDAO();
    model.PreView = new Apply_001037ViewModel();
    model.PreView.InjectFrom(model);
    model.PAY_A_FEE = model.TOTAL;  // 使用總金額作為繳費金額
    model.PAY_METHOD = "";
    return PartialView("Pay", model);
}
```

#### 5. Save() - 完成申報

```csharp
[DisplayName("Apply_001037_完成申報")]
[HttpPost]
public ActionResult Save(Apply_001037ViewModel model)
{
    SessionModel sm = SessionModel.Get();
    ApplyDAO dao = new ApplyDAO();
    var memberName = string.IsNullOrWhiteSpace(model.APPLY_NAME) ? sm.UserInfo.Member.NAME : model.APPLY_NAME;
    var memberEmail = string.IsNullOrWhiteSpace(model.MAIL) ? sm.UserInfo.Member.MAIL : model.MAIL;

    switch (model.PAY_METHOD)
    {
        case "C":  // 信用卡線上刷卡
            model.APP_ID = dao.GetApp_ID("001037");
            model.CLIENT_IP = GetClientIP();
            model.ISEC = DataUtils.GetConfig("PAY_EC_OPEN");

            if (!dao.RunCreditCardTranx(model))
            {
                dao.DeleteApplyEmptyRow(model.APP_ID);
                break;
            }
            else
            {
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID, "醫事人員或公共衛生師請領無懲戒紀錄證明", "001037");
            }
            break;

        case "D":  // 匯票
        case "T":  // 劃撥
        case "B":  // 臨櫃
        case "S":  // 超商
            if (!dao.RunPayTranx(model))
            {
                model.ErrorCode = "-1";
                model.ErrorMessage = "繳費執行失敗!!";
                break;
            }
            else
            {
                dao.SendMail_Proc(memberName, memberEmail, model.APP_ID, "醫事人員或公共衛生師請領無懲戒紀錄證明", "001037");
            }
            model.ErrorCode = "0000";
            break;
    }

    return View("Save", model);
}
```

#### 6. AppDoc() - 補件查詢

```csharp
[DisplayName("Apply_001037_補件查詢")]
public ActionResult AppDoc(string APP_ID)
{
    ApplyDAO dao = new ApplyDAO();
    SessionModel sm = SessionModel.Get();
    Apply_001037ViewModel model = new Apply_001037ViewModel();
    model.APP_ID = APP_ID;
    model = dao.QueryApply_001037(model);

    // 案件基本資訊
    ApplyModel apply = new ApplyModel();
    apply.APP_ID = APP_ID;
    var applyData = dao.GetRow(apply);

    try
    {
        var userInfo = sm.UserInfo.Member;

        // 判斷是否為該案件申請人
        if (applyData.ACC_NO == userInfo.ACC_NO)
        {
            model.IsNotice = "Y";
            ShareDAO shareDAO = new ShareDAO();

            // 檢查是否過補件期限
            if (applyData.FLOW_CD == "2" && shareDAO.CalculationDocDate("001037", model.APP_ID))
            {
                sm.LastErrorMessage = "已過可補件時間，請聯絡承辦單位!!";
                model.IsNotice = "N";
            }

            return View("AppDoc", model);
        }
        else
        {
            throw new Exception("非案件申請人無法瀏覽次案件 !");
        }
    }
    catch (Exception ex)
    {
        if (model == null)
        {
            sm.LastErrorMessage = "案件編號﹕" + APP_ID + "，尚未分派承辦人員，暫無法查詢!!";
            return RedirectToAction("Index", "History");
        }
        else
        {
            sm.LastErrorMessage = ex.Message;
            return RedirectToAction("Index", "Login");
        }
    }
}
```

#### 7. AppDocSave() - 補件存檔

```csharp
[DisplayName("Apply_001037_補件存檔")]
[HttpPost]
public ActionResult AppDocSave(Apply_001037ViewModel model)
{
    ApplyDAO dao = new ApplyDAO();
    SessionModel sm = SessionModel.Get();
    var memberName = string.IsNullOrWhiteSpace(model.APPLY_NAME) ? sm.UserInfo.Member.NAME : model.APPLY_NAME;
    var memberEmail = string.IsNullOrWhiteSpace(model.MAIL) ? sm.UserInfo.Member.MAIL : model.MAIL;

    try
    {
        if (dao.SaveAppDoc001037(model))
        {
            dao.SendMail_Update(memberName, memberEmail, model.APP_ID, "醫事人員或公共衛生師請領無懲戒紀錄證明", "001037", "-1");
            sm.LastResultMessage = "存檔成功!!";
            model.Apply.FLOW_CD = "3";
        }
        else
        {
            sm.LastErrorMessage = "存檔失敗!!";
        }
    }
    catch (Exception ex)
    {
        logger.Error("Apply_001037_補件存檔__AppDoc failed:" + ex.TONotNullString());
        sm.LastErrorMessage = "存檔失敗!!";
    }

    return View("Done", model);
}
```

#### 8. PayPDF() - 匯出繳費單 PDF

```csharp
public ActionResult PayPDF(string id)
{
    ApplyDAO dao = new ApplyDAO();
    return File(dao.ExportPayPDF(id), "application/pdf", "Pay" + id + ".pdf");
}
```

---

## 技術重點

### 1. 申請理由選擇

**5 種申請理由：**

1. **申請移民（REASON_1）**
2. **出國使用（REASON_2）** - 需填寫說明（REASON_2_DESC）
3. **前往國外（REASON_3）** - 需填寫說明（REASON_3_DESC）
4. **國內使用（REASON_4）** - 需填寫說明（REASON_4_DESC）
5. **其他（REASON_5）** - 需填寫說明（REASON_5_DESC）

**實作方式：**

- 使用勾選框選擇申請理由
- 可複選
- 部分理由需填寫說明

### 2. 申請份數與金額計算

**特點：**

- 可選擇申請份數（COPIES）
- 自動計算總金額（TOTAL）
- 每份金額固定（由系統設定）

**實作方式：**

```javascript
// 計算總金額
function calculateTotal() {
  var copies = $("#COPIES").val();
  var unitPrice = 200; // 每份金額
  var total = copies * unitPrice;
  $("#TOTAL").val(total);
}
```

### 3. 郵寄地址選擇

**特點：**

- 可選擇郵寄地址（戶籍地址或其他地址）
- 支援國外郵寄（MAIL_COUNTRY）
- 需填寫收件人（MAIL_REC）

**實作方式：**

- 使用單選按鈕選擇地址類型
- 根據選擇顯示/隱藏地址輸入欄位

### 4. 附件上傳

**特點：**

- 3 個檔案上傳欄位（可選）
- 支援 PDF 格式
- 檔案大小限制（10MB）

**實作方式：**

- 使用勾選框控制是否上傳
- 勾選後才顯示檔案上傳欄位

### 5. 繳費方式

**5 種繳費方式：**

1. **信用卡線上刷卡（C）** - 使用電子化政府網路付費服務
2. **匯票（D）** - 抬頭：衛生福利部
3. **劃撥（T）** - 郵政劃撥
4. **臨櫃（B）** - 現金繳費
5. **超商（S）** - 超商繳費

---

## 相關檔案清單

### 前端檔案

- `ES/Controllers/Apply_001037Controller.cs` (367 行) - 控制器
- `ES/Models/ViewModels/Apply_001037ViewModel.cs` (234 行) - 視圖模型
- `ES/Views/Apply_001037/Prompt001037.cshtml` - 說明事項頁面
- `ES/Views/Apply_001037/Index.cshtml` - 申請表單
- `ES/Views/Apply_001037/PreView001037.cshtml` - 預覽頁面
- `ES/Views/Apply_001037/Pay.cshtml` - 繳費頁面
- `ES/Views/Apply_001037/Save.cshtml` - 完成頁面
- `ES/Views/Apply_001037/AppDoc.cshtml` - 補件頁面
- `ES/Views/Apply_001037/Done.cshtml` - 補件完成頁面

### 後端檔案

- `ES/DataLayers/ApplyDAO.cs` - 資料存取層（包含 QueryApply_001037, SaveAppDoc001037, RunCreditCardTranx, RunPayTranx 方法）
- `ES/DataLayers/ShareDAO.cs` - 共用資料存取層
- `ES/Models/Entities/Apply_001037Model.cs` (202 行) - 實體模型
- `ES/Models/Entities/APPLYModel.cs` - APPLY 實體
- `ES/Models/Entities/APPLY_PAY.cs` - APPLY_PAY 實體

### 資料庫資料表

- `SERVICE` - 服務定義表
- `APPLY` - 申請主表
- `APPLY_001037` - 服務明細表
- `APPLY_FILE` - 附件檔案表
- `APPLY_PAY` - 繳費資料表
- `CODE_CD` - 代碼表

---

## 注意事項

### 1. 申請理由

- 至少需選擇一個申請理由
- 部分理由需填寫說明
- 可複選

### 2. 申請份數

- 必須選擇申請份數
- 份數必須大於 0
- 總金額會自動計算

### 3. 郵寄地址

- 必須填寫郵寄地址
- 需填寫收件人
- 支援國外郵寄

### 4. 附件檔案

- 附件檔案為可選
- 只接受 PDF 格式
- 檔案大小不超過 10MB

### 5. 繳費方式

- 信用卡繳費需要有效的信用卡資訊
- 其他繳費方式需要後續處理
- 繳費完成後才會寄送通知郵件

### 6. 補件功能

- 只有流程狀態為「補件中」的案件才能補件
- 補件有期限限制
- 補件完成後流程狀態會更新為「補件完成」

---

**版本：** 1.0
**日期：** 2025-10-20
**作者：** 柏通股份有限公司
