# MIT 微笑標章管理系統 - 全端功能詳細範例：數據統計分析報表

## 功能概述

本文以「MIT 申請案件統計分析功能」為例，詳細說明從前端數據查詢到後端統計計算的完整全端開發流程。此功能涵蓋了複雜條件查詢、數據聚合統計、圖表視覺化、Excel 匯出等數據分析機制，與第三個文件的文檔型報表形成對比。

## 系統架構層次

```
前端 Vue.js 應用
    ↓ HTTP API 呼叫（統計查詢）
後端 ASP.NET Core API
    ↓ 業務邏輯處理
服務層 (Service Layer)
    ↓ 統計查詢工具
數據統計分析工具 (StatisticsUtil)
    ↓ SQL 聚合查詢
SQL Server 資料庫 (GROUP BY, COUNT, SUM)
    ↓ 數據處理
統計結果計算與格式化
    ↓ 前端展示
圖表視覺化 + Excel 匯出
```

## 1. 前端統計查詢實作

### 1.1 統計查詢條件設定

**檔案位置：** `MITAP2024/mitap2024.client/src/mitf/mit02/MIT0201.vue`

```typescript
// 統計查詢的主要函數
// 這個函數負責觸發後端的統計分析流程
const doStatisticsQuery = (): void => {
  // 第一步：檢查使用者登入狀態
  // 確保使用者已登入才能執行統計查詢功能
  if (CommonUtilApi().mitf_CheckIsLogin() == false) {
    return; // 如果未登入，直接返回不執行後續操作
  }

  // 清除之前的警告訊息和統計結果
  alert_message.value = "";
  statistics_result.value = null;

  // 設定載入狀態為 true，顯示載入動畫給使用者
  loading.value = true;

  // 準備要送到後端的統計查詢資料物件
  let statisticsData = {
    jwtkey: SessionApi().getToken(), // JWT Token 用於身份驗證
    startDate: query_data.q_startDate, // 統計開始日期
    endDate: query_data.q_endDate, // 統計結束日期
    formType: query_data.q_formType, // 申請類型篩選條件
    formProcess: query_data.q_formProcess, // 申請狀態篩選條件
    groupBy: query_data.q_groupBy, // 統計分組方式（按日期、類型、狀態等）
    statisticsType: query_data.q_statisticsType // 統計類型（數量、通過率、平均處理時間等）
  };

  // 呼叫後端 API 進行統計分析
  // 使用封裝好的 mitf_doFetch 函數發送 HTTP 請求
  CommonUtilApi().mitf_doFetch(
    // API 端點：組合根路徑和統計分析的 API 路徑
    CommonUtilApi().rootrul() + "api/mitf/mit02/MIT0201/GetStatistics",
    statisticsData, // 要送出的統計查詢條件
    afterStatisticsQuery, // 成功時的回調函數
    setAlert // 失敗時的錯誤處理函數
  );
};

// 統計查詢成功後的處理函數
// 接收後端回傳的統計結果並進行前端展示
const afterStatisticsQuery = (json: any): void => {
  // 第一步：關閉載入動畫
  loading.value = false;

  // 第二步：檢查 API 回應是否成功
  if (json.isSuccess) {
    // 將統計結果儲存到響應式變數中
    statistics_result.value = json.data;

    // 第三步：根據統計結果類型進行不同的處理
    if (statistics_result.value.chartData) {
      // 如果有圖表資料，初始化圖表顯示
      initializeChart(statistics_result.value.chartData);
    }

    if (statistics_result.value.summaryData) {
      // 如果有摘要資料，更新摘要區塊
      updateSummaryDisplay(statistics_result.value.summaryData);
    }

    // 第四步：顯示成功訊息
    showSuccessMessage("統計分析完成");
  } else {
    // API 回應失敗，顯示錯誤訊息
    setAlert(json.message || "統計查詢失敗");
  }
};

// 初始化圖表顯示的函數
// 使用 Chart.js 或類似的圖表庫來顯示統計結果
const initializeChart = (chartData: any): void => {
  // 第一步：取得圖表容器元素
  const chartCanvas = document.getElementById(
    "statisticsChart"
  ) as HTMLCanvasElement;

  if (chartCanvas) {
    // 第二步：設定圖表配置
    const chartConfig = {
      type: chartData.type || "bar", // 圖表類型：長條圖、圓餅圖、折線圖等
      data: {
        labels: chartData.labels, // X 軸標籤
        datasets: [
          {
            label: chartData.datasetLabel || "統計數據",
            data: chartData.values, // Y 軸數值
            backgroundColor: [
              // 圖表顏色配置
              "rgba(54, 162, 235, 0.6)",
              "rgba(255, 99, 132, 0.6)",
              "rgba(255, 205, 86, 0.6)",
              "rgba(75, 192, 192, 0.6)",
              "rgba(153, 102, 255, 0.6)"
            ],
            borderColor: [
              "rgba(54, 162, 235, 1)",
              "rgba(255, 99, 132, 1)",
              "rgba(255, 205, 86, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(153, 102, 255, 1)"
            ],
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true, // 響應式設計
        plugins: {
          title: {
            display: true,
            text: chartData.title || "MIT 申請案件統計分析"
          },
          legend: {
            display: true,
            position: "top"
          }
        },
        scales: {
          y: {
            beginAtZero: true, // Y 軸從 0 開始
            title: {
              display: true,
              text: chartData.yAxisLabel || "數量"
            }
          },
          x: {
            title: {
              display: true,
              text: chartData.xAxisLabel || "分類"
            }
          }
        }
      }
    };

    // 第三步：建立圖表實例
    // 如果已存在圖表，先銷毀再重新建立
    if (chart_instance.value) {
      chart_instance.value.destroy();
    }

    chart_instance.value = new Chart(chartCanvas, chartConfig);
  }
};

// Excel 匯出功能
// 將統計結果匯出為 Excel 檔案供使用者下載
const exportToExcel = (): void => {
  // 第一步：檢查是否有統計結果可以匯出
  if (!statistics_result.value) {
    setAlert("請先執行統計查詢");
    return;
  }

  // 第二步：設定載入狀態
  loading.value = true;

  // 準備匯出請求資料
  let exportData = {
    jwtkey: SessionApi().getToken(),
    statisticsData: statistics_result.value, // 統計結果資料
    exportFormat: "excel", // 匯出格式
    fileName: `MIT申請案件統計_${new Date().toISOString().split("T")[0]}.xlsx`
  };

  // 呼叫後端 API 進行 Excel 匯出
  CommonUtilApi().mitf_doFetch(
    CommonUtilApi().rootrul() + "api/mitf/mit02/MIT0201/ExportStatistics",
    exportData,
    afterExportExcel, // 成功時的回調函數
    setAlert // 失敗時的錯誤處理函數
  );
};

// Excel 匯出成功後的處理函數
const afterExportExcel = (json: any): void => {
  loading.value = false;

  if (json.isSuccess) {
    // 使用通用的檔案下載函數下載 Excel 檔案
    const fileName = json.data.fileName || "MIT申請案件統計.xlsx";
    CommonUtilApi().downloadFile(
      CommonUtilApi().rootrul() + "api/COM0105/Downloadfile",
      {
        jwtkey: SessionApi().getToken(),
        targetType: "statistics",
        fileName: fileName,
        targetGuid: json.data.fileGuid
      },
      fileName
    );

    showSuccessMessage("Excel 檔案匯出成功");
  } else {
    setAlert(json.message || "Excel 匯出失敗");
  }
};
```

**程式碼說明：**

1. **條件設定**：提供多維度的統計查詢條件，包括時間範圍、申請類型、狀態等
2. **圖表整合**：使用 Chart.js 進行數據視覺化，支援多種圖表類型
3. **響應式設計**：圖表和統計結果都採用響應式設計，適應不同螢幕尺寸
4. **匯出功能**：提供 Excel 匯出功能，方便使用者進行進一步分析
5. **錯誤處理**：完整的錯誤處理機制，確保使用者體驗良好

### 1.2 統計結果展示介面

```vue
<template>
  <div class="container-fluid">
    <PageTitle :title="'MIT 申請案件統計分析(MIT0201S)'" />

    <!-- 統計查詢條件區域 -->
    <div class="card">
      <div class="card-header">
        <h5>統計查詢條件</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-3">
            <InputDatePick
              :title="'統計開始日期'"
              v-model:data="query_data.q_startDate"
              :isRequire="true" />
          </div>
          <div class="col-3">
            <InputDatePick
              :title="'統計結束日期'"
              v-model:data="query_data.q_endDate"
              :isRequire="true" />
          </div>
          <div class="col-3">
            <SelectSysCode
              :title="'申請類型'"
              :kind="'FORMTYPE'"
              v-model:code="query_data.q_formType"
              :isRequire="false" />
          </div>
          <div class="col-3">
            <SelectSysCode
              :title="'申請狀態'"
              :kind="'FORMPROCESS'"
              v-model:code="query_data.q_formProcess"
              :isRequire="false" />
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-3">
            <SelectSysCode
              :title="'統計分組'"
              :kind="'STATISTICS_GROUP'"
              v-model:code="query_data.q_groupBy"
              :isRequire="true" />
          </div>
          <div class="col-3">
            <SelectSysCode
              :title="'統計類型'"
              :kind="'STATISTICS_TYPE'"
              v-model:code="query_data.q_statisticsType"
              :isRequire="true" />
          </div>
        </div>
      </div>
      <div class="card-footer">
        <button
          type="button"
          class="btn btn-primary"
          @click="doStatisticsQuery"
          :disabled="loading">
          <span
            v-if="loading"
            class="spinner-border spinner-border-sm me-2"></span>
          執行統計分析
        </button>
        <button
          type="button"
          class="btn btn-success ms-2"
          @click="exportToExcel"
          :disabled="!statistics_result || loading">
          <FontAwesomeIcon :icon="faFileExcel" class="me-1" />
          匯出 Excel
        </button>
      </div>
    </div>

    <!-- 統計摘要區域 -->
    <div
      class="card mt-4"
      v-if="statistics_result && statistics_result.summaryData">
      <div class="card-header">
        <h5>統計摘要</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-3">
            <div class="card bg-primary text-white">
              <div class="card-body text-center">
                <h3>{{ statistics_result.summaryData.totalCount }}</h3>
                <p>總申請案件數</p>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <h3>{{ statistics_result.summaryData.approvedCount }}</h3>
                <p>已核准案件數</p>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="card bg-warning text-white">
              <div class="card-body text-center">
                <h3>{{ statistics_result.summaryData.pendingCount }}</h3>
                <p>審核中案件數</p>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="card bg-info text-white">
              <div class="card-body text-center">
                <h3>{{ statistics_result.summaryData.approvalRate }}%</h3>
                <p>核准通過率</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 圖表顯示區域 -->
    <div
      class="card mt-4"
      v-if="statistics_result && statistics_result.chartData">
      <div class="card-header">
        <h5>統計圖表</h5>
      </div>
      <div class="card-body">
        <canvas id="statisticsChart" width="400" height="200"></canvas>
      </div>
    </div>

    <!-- 詳細統計資料表格 -->
    <div
      class="card mt-4"
      v-if="statistics_result && statistics_result.detailData">
      <div class="card-header">
        <h5>詳細統計資料</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-dark">
              <tr>
                <th>分類</th>
                <th>申請數量</th>
                <th>核准數量</th>
                <th>駁回數量</th>
                <th>審核中數量</th>
                <th>通過率</th>
                <th>平均處理天數</th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="item in statistics_result.detailData"
                :key="item.category">
                <td>{{ item.categoryName }}</td>
                <td>{{ item.totalCount }}</td>
                <td>{{ item.approvedCount }}</td>
                <td>{{ item.rejectedCount }}</td>
                <td>{{ item.pendingCount }}</td>
                <td>{{ item.approvalRate }}%</td>
                <td>{{ item.avgProcessDays }} 天</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</template>
```

**程式碼說明：**

1. **多層次展示**：包含查詢條件、統計摘要、圖表視覺化、詳細資料表格
2. **響應式卡片**：使用 Bootstrap 卡片組件進行資料分區展示
3. **視覺化指標**：使用不同顏色的卡片展示關鍵統計指標
4. **互動式圖表**：整合 Chart.js 提供互動式的統計圖表
5. **資料表格**：提供詳細的統計資料供使用者查看

## 2. 後端統計分析 API 實作

### 2.1 統計查詢控制器

**檔案位置：** `MITAP2024/MITAP2024.Server/MITF/MIT02/Controller/MIT0201Controller.cs`

```csharp
/// <summary>
/// 統計分析的 API 端點
/// 接收前端統計查詢條件，執行複雜的數據聚合分析
/// </summary>
[HttpPost("GetStatistics")]  // HTTP POST 方法，完整路徑：api/mitf/mit02/MIT0201/GetStatistics
public async Task<ActionResult<PagedQueryResult>> GetStatistics([FromBody] MIT0201StatisticsQueryModel model)
{
    // 宣告 Session 資料變數，用於存放使用者登入資訊
    MitfSessionDataModel? sessiondata = null;

    // 執行身份驗證和權限檢查
    // 確保只有已登入且有權限的使用者才能執行統計查詢
    var checkResult = _homeService.CheckIsLoginAndAuth(model.jwtkey, ref sessiondata, GetFuncCode());

    if (checkResult == ConstMsg.SUC_CODE_00001)  // 驗證成功
    {
        // 呼叫服務層的統計分析方法
        // 使用 await 確保非同步操作完成後才回傳結果
        return await _service.GetStatistics(model, sessiondata);
    }
    else  // 驗證失敗
    {
        // 回傳錯誤結果
        return new PagedQueryResult()
        {
            jwtkey = model.jwtkey,
            IsSuccess = false,
            message = checkResult == ConstMsg.ERR_NOTLOGIN ? "請重新登入" : "權限不足"
        };
    }
}

/// <summary>
/// 統計結果匯出的 API 端點
/// 將統計分析結果匯出為 Excel 檔案
/// </summary>
[HttpPost("ExportStatistics")]  // HTTP POST 方法，完整路徑：api/mitf/mit02/MIT0201/ExportStatistics
public async Task<ActionResult<PagedQueryResult>> ExportStatistics([FromBody] MIT0201ExportModel model)
{
    // 宣告 Session 資料變數
    MitfSessionDataModel? sessiondata = null;

    // 執行身份驗證和權限檢查
    var checkResult = _homeService.CheckIsLoginAndAuth(model.jwtkey, ref sessiondata, GetFuncCode());

    if (checkResult == ConstMsg.SUC_CODE_00001)  // 驗證成功
    {
        // 呼叫服務層的匯出方法
        return await _service.ExportStatistics(model, sessiondata);
    }
    else  // 驗證失敗
    {
        // 回傳錯誤結果
        return new PagedQueryResult()
        {
            jwtkey = model.jwtkey,
            IsSuccess = false,
            message = checkResult == ConstMsg.ERR_NOTLOGIN ? "請重新登入" : "權限不足"
        };
    }
}
```

**程式碼說明：**

1. **統計查詢端點**：專門處理統計分析請求的 API 端點
2. **匯出功能端點**：處理統計結果匯出為 Excel 的 API 端點
3. **身份驗證**：確保只有授權使用者才能執行統計分析
4. **非同步處理**：使用非同步方法處理可能耗時的統計計算
5. **錯誤處理**：提供完整的錯誤回饋機制

### 2.2 統計分析服務層實作

**檔案位置：** `MITAP2024/MITAP2024.Server/MITF/MIT02/Service/MIT0201Service.cs`

```csharp
/// <summary>
/// 統計分析的核心業務邏輯方法
/// 執行複雜的 SQL 聚合查詢，計算各種統計指標
/// </summary>
/// <param name="model">統計查詢條件模型</param>
/// <param name="sessiondata">使用者 Session 資料</param>
/// <returns>包含統計結果的回應物件</returns>
public async Task<ActionResult<PagedQueryResult>> GetStatistics(MIT0201StatisticsQueryModel model, MitfSessionDataModel? sessiondata)
{
    return await Task.Run(() =>
    {
        // 初始化回傳結果物件
        PagedQueryResult result = new PagedQueryResult()
        {
            jwtkey = model.jwtkey,
            IsSuccess = false,
            Data = new MIT0201StatisticsResultModel()
        };

        try
        {
            // 第一步：建立統計結果物件
            var statisticsResult = new MIT0201StatisticsResultModel();

            // 第二步：執行摘要統計查詢
            // 計算總申請案件數、核准數、駁回數、審核中數量等基本統計
            var summaryData = GetSummaryStatistics(model, sessiondata);
            statisticsResult.SummaryData = summaryData;

            // 第三步：根據分組方式執行詳細統計查詢
            var detailData = GetDetailStatistics(model, sessiondata);
            statisticsResult.DetailData = detailData;

            // 第四步：準備圖表資料
            var chartData = PrepareChartData(detailData, model.StatisticsType);
            statisticsResult.ChartData = chartData;

            // 第五步：設定回傳結果
            result.Data = statisticsResult;
            result.IsSuccess = true;
            result.message = "統計分析完成";
        }
        catch (Exception e)
        {
            // 記錄錯誤並回傳失敗結果
            result.message = TextUtils.GenErrmsgWithNum(logger, "統計分析失敗", e);
            result.IsSuccess = false;
        }

        return result;
    });
}

/// <summary>
/// 取得摘要統計資料的私有方法
/// 執行基本的統計查詢，計算總數、通過率等關鍵指標
/// </summary>
/// <param name="model">查詢條件</param>
/// <param name="sessiondata">使用者 Session</param>
/// <returns>摘要統計資料</returns>
private MIT0201SummaryDataModel GetSummaryStatistics(MIT0201StatisticsQueryModel model, MitfSessionDataModel? sessiondata)
{
    var summaryData = new MIT0201SummaryDataModel();

    // 建立摘要統計的 SQL 查詢語句
    // 使用 CASE WHEN 進行條件統計，一次查詢取得所有摘要數據
    var summaryQuery = @"
SELECT
    COUNT(*) as TotalCount,                                    -- 總申請案件數
    SUM(CASE WHEN af.FormProcess = 'C' THEN 1 ELSE 0 END) as ApprovedCount,    -- 已核准案件數
    SUM(CASE WHEN af.FormProcess = 'F' THEN 1 ELSE 0 END) as RejectedCount,    -- 已駁回案件數
    SUM(CASE WHEN af.FormProcess IN ('T','B','U','M') THEN 1 ELSE 0 END) as PendingCount,  -- 審核中案件數
    AVG(CASE
        WHEN af.FormProcess = 'C' AND af.ModifyDate IS NOT NULL
        THEN DATEDIFF(day, af.CreateDate, af.ModifyDate)
        ELSE NULL
    END) as AvgProcessDays                                     -- 平均處理天數（僅計算已完成案件）
FROM ApplyForm af
    INNER JOIN SysCode sc ON af.FormType = sc.Code AND sc.Kind = 'FORMTYPE'
    INNER JOIN SysCode sc2 ON af.FormProcess = sc2.Code AND sc2.Kind = 'FORMPROCESS'
    INNER JOIN ComMan cm ON cm.Guid = af.ComManGuid
WHERE af.IsDelete = 0
    AND af.ComId = @comid                                      -- 限制查詢使用者所屬公司的資料
    AND af.CreateDate >= @startdate                            -- 統計開始日期條件
    AND af.CreateDate <= @enddate                              -- 統計結束日期條件
    AND (@formtype IS NULL OR af.FormType = @formtype)        -- 申請類型篩選條件（可選）
    AND (@formprocess IS NULL OR af.FormProcess = @formprocess) -- 申請狀態篩選條件（可選）
";

    // 執行 SQL 查詢
    using (var conn = new SqlConnection(AppSettingReader.GetMitDbConnStr()))
    {
        conn.Open();
        using (var cmd = new SqlCommand(summaryQuery, conn))
        {
            // 設定查詢參數
            cmd.Parameters.AddWithValue("@comid", sessiondata.ComId);
            cmd.Parameters.AddWithValue("@startdate", DateTime.Parse(model.StartDate));
            cmd.Parameters.AddWithValue("@enddate", DateTime.Parse(model.EndDate));
            cmd.Parameters.AddWithValue("@formtype", string.IsNullOrEmpty(model.FormType) ? DBNull.Value : model.FormType);
            cmd.Parameters.AddWithValue("@formprocess", string.IsNullOrEmpty(model.FormProcess) ? DBNull.Value : model.FormProcess);

            using (var reader = cmd.ExecuteReader())
            {
                if (reader.Read())
                {
                    // 讀取查詢結果並填入摘要資料物件
                    summaryData.TotalCount = reader.GetInt32("TotalCount");
                    summaryData.ApprovedCount = reader.GetInt32("ApprovedCount");
                    summaryData.RejectedCount = reader.GetInt32("RejectedCount");
                    summaryData.PendingCount = reader.GetInt32("PendingCount");

                    // 計算核准通過率（避免除以零的錯誤）
                    summaryData.ApprovalRate = summaryData.TotalCount > 0
                        ? Math.Round((double)summaryData.ApprovedCount / summaryData.TotalCount * 100, 2)
                        : 0;

                    // 取得平均處理天數（可能為 NULL）
                    summaryData.AvgProcessDays = reader.IsDBNull("AvgProcessDays")
                        ? 0
                        : Math.Round(reader.GetDouble("AvgProcessDays"), 1);
                }
            }
        }
    }

    return summaryData;
}

/// <summary>
/// 取得詳細統計資料的私有方法
/// 根據指定的分組方式執行聚合查詢，產生詳細的統計分析結果
/// </summary>
/// <param name="model">查詢條件</param>
/// <param name="sessiondata">使用者 Session</param>
/// <returns>詳細統計資料清單</returns>
private List<MIT0201DetailDataModel> GetDetailStatistics(MIT0201StatisticsQueryModel model, MitfSessionDataModel? sessiondata)
{
    var detailDataList = new List<MIT0201DetailDataModel>();

    // 根據分組方式建立不同的 SQL 查詢語句
    string detailQuery = "";
    string groupByClause = "";
    string selectClause = "";

    switch (model.GroupBy)
    {
        case "FORMTYPE":  // 按申請類型分組
            selectClause = "sc.CodeName as CategoryName, af.FormType as Category";
            groupByClause = "GROUP BY af.FormType, sc.CodeName";
            break;
        case "FORMPROCESS":  // 按申請狀態分組
            selectClause = "sc2.CodeName as CategoryName, af.FormProcess as Category";
            groupByClause = "GROUP BY af.FormProcess, sc2.CodeName";
            break;
        case "MONTH":  // 按月份分組
            selectClause = "FORMAT(af.CreateDate, 'yyyy-MM') as CategoryName, FORMAT(af.CreateDate, 'yyyy-MM') as Category";
            groupByClause = "GROUP BY FORMAT(af.CreateDate, 'yyyy-MM')";
            break;
        case "QUARTER":  // 按季度分組
            selectClause = "CONCAT(YEAR(af.CreateDate), '-Q', DATEPART(QUARTER, af.CreateDate)) as CategoryName, CONCAT(YEAR(af.CreateDate), '-Q', DATEPART(QUARTER, af.CreateDate)) as Category";
            groupByClause = "GROUP BY YEAR(af.CreateDate), DATEPART(QUARTER, af.CreateDate)";
            break;
        default:  // 預設按申請類型分組
            selectClause = "sc.CodeName as CategoryName, af.FormType as Category";
            groupByClause = "GROUP BY af.FormType, sc.CodeName";
            break;
    }

    // 組合完整的詳細統計查詢語句
    detailQuery = $@"
SELECT
    {selectClause},
    COUNT(*) as TotalCount,                                    -- 該分類的總申請案件數
    SUM(CASE WHEN af.FormProcess = 'C' THEN 1 ELSE 0 END) as ApprovedCount,    -- 該分類的已核准案件數
    SUM(CASE WHEN af.FormProcess = 'F' THEN 1 ELSE 0 END) as RejectedCount,    -- 該分類的已駁回案件數
    SUM(CASE WHEN af.FormProcess IN ('T','B','U','M') THEN 1 ELSE 0 END) as PendingCount,  -- 該分類的審核中案件數
    AVG(CASE
        WHEN af.FormProcess = 'C' AND af.ModifyDate IS NOT NULL
        THEN DATEDIFF(day, af.CreateDate, af.ModifyDate)
        ELSE NULL
    END) as AvgProcessDays                                     -- 該分類的平均處理天數
FROM ApplyForm af
    INNER JOIN SysCode sc ON af.FormType = sc.Code AND sc.Kind = 'FORMTYPE'
    INNER JOIN SysCode sc2 ON af.FormProcess = sc2.Code AND sc2.Kind = 'FORMPROCESS'
    INNER JOIN ComMan cm ON cm.Guid = af.ComManGuid
WHERE af.IsDelete = 0
    AND af.ComId = @comid
    AND af.CreateDate >= @startdate
    AND af.CreateDate <= @enddate
    AND (@formtype IS NULL OR af.FormType = @formtype)
    AND (@formprocess IS NULL OR af.FormProcess = @formprocess)
{groupByClause}
ORDER BY TotalCount DESC                                       -- 按總數量降序排列
";

    // 執行詳細統計查詢
    using (var conn = new SqlConnection(AppSettingReader.GetMitDbConnStr()))
    {
        conn.Open();
        using (var cmd = new SqlCommand(detailQuery, conn))
        {
            // 設定查詢參數
            cmd.Parameters.AddWithValue("@comid", sessiondata.ComId);
            cmd.Parameters.AddWithValue("@startdate", DateTime.Parse(model.StartDate));
            cmd.Parameters.AddWithValue("@enddate", DateTime.Parse(model.EndDate));
            cmd.Parameters.AddWithValue("@formtype", string.IsNullOrEmpty(model.FormType) ? DBNull.Value : model.FormType);
            cmd.Parameters.AddWithValue("@formprocess", string.IsNullOrEmpty(model.FormProcess) ? DBNull.Value : model.FormProcess);

            using (var reader = cmd.ExecuteReader())
            {
                while (reader.Read())
                {
                    // 建立詳細統計資料物件
                    var detailData = new MIT0201DetailDataModel()
                    {
                        Category = reader.GetString("Category"),
                        CategoryName = reader.GetString("CategoryName"),
                        TotalCount = reader.GetInt32("TotalCount"),
                        ApprovedCount = reader.GetInt32("ApprovedCount"),
                        RejectedCount = reader.GetInt32("RejectedCount"),
                        PendingCount = reader.GetInt32("PendingCount"),
                        AvgProcessDays = reader.IsDBNull("AvgProcessDays")
                            ? 0
                            : Math.Round(reader.GetDouble("AvgProcessDays"), 1)
                    };

                    // 計算該分類的核准通過率
                    detailData.ApprovalRate = detailData.TotalCount > 0
                        ? Math.Round((double)detailData.ApprovedCount / detailData.TotalCount * 100, 2)
                        : 0;

                    detailDataList.Add(detailData);
                }
            }
        }
    }

    return detailDataList;
}

/// <summary>
/// 準備圖表資料的私有方法
/// 將統計結果轉換為前端圖表所需的資料格式
/// </summary>
/// <param name="detailData">詳細統計資料</param>
/// <param name="statisticsType">統計類型</param>
/// <returns>圖表資料物件</returns>
private MIT0201ChartDataModel PrepareChartData(List<MIT0201DetailDataModel> detailData, string statisticsType)
{
    var chartData = new MIT0201ChartDataModel();

    if (detailData != null && detailData.Count > 0)
    {
        // 設定圖表標籤（X 軸）
        chartData.Labels = detailData.Select(x => x.CategoryName).ToArray();

        // 根據統計類型設定圖表數值（Y 軸）和相關屬性
        switch (statisticsType)
        {
            case "COUNT":  // 數量統計
                chartData.Values = detailData.Select(x => x.TotalCount).ToArray();
                chartData.DatasetLabel = "申請案件數量";
                chartData.YAxisLabel = "案件數量";
                chartData.Title = "各分類申請案件數量統計";
                chartData.Type = "bar";  // 長條圖
                break;
            case "APPROVAL_RATE":  // 通過率統計
                chartData.Values = detailData.Select(x => (int)x.ApprovalRate).ToArray();
                chartData.DatasetLabel = "核准通過率 (%)";
                chartData.YAxisLabel = "通過率 (%)";
                chartData.Title = "各分類核准通過率統計";
                chartData.Type = "line";  // 折線圖
                break;
            case "PROCESS_TIME":  // 處理時間統計
                chartData.Values = detailData.Select(x => (int)x.AvgProcessDays).ToArray();
                chartData.DatasetLabel = "平均處理天數";
                chartData.YAxisLabel = "天數";
                chartData.Title = "各分類平均處理時間統計";
                chartData.Type = "bar";  // 長條圖
                break;
            default:  // 預設為數量統計
                chartData.Values = detailData.Select(x => x.TotalCount).ToArray();
                chartData.DatasetLabel = "申請案件數量";
                chartData.YAxisLabel = "案件數量";
                chartData.Title = "各分類申請案件數量統計";
                chartData.Type = "bar";
                break;
        }

        // 設定 X 軸標籤
        chartData.XAxisLabel = "分類";
    }

    return chartData;
}
```

**程式碼說明：**

1. **分層統計查詢**：分別執行摘要統計和詳細統計，提供不同層次的數據分析
2. **SQL 聚合函數**：使用 COUNT、SUM、AVG、CASE WHEN 等進行複雜的統計計算
3. **動態查詢條件**：根據使用者選擇的條件動態組合 SQL 查詢語句
4. **多維度分組**：支援按申請類型、狀態、時間等不同維度進行分組統計
5. **圖表資料準備**：將統計結果轉換為前端圖表庫所需的資料格式
6. **效能優化**：使用單一查詢取得多個統計指標，減少資料庫存取次數

## 3. Excel 匯出功能實作

### 3.1 Excel 匯出服務層邏輯

```csharp
/// <summary>
/// 統計結果匯出為 Excel 的核心方法
/// 使用 NPOI 函式庫產生 Excel 檔案，包含統計摘要和詳細資料
/// </summary>
/// <param name="model">匯出請求模型</param>
/// <param name="sessiondata">使用者 Session 資料</param>
/// <returns>包含檔案資訊的回應物件</returns>
public async Task<ActionResult<PagedQueryResult>> ExportStatistics(MIT0201ExportModel model, MitfSessionDataModel? sessiondata)
{
    return await Task.Run(() =>
    {
        PagedQueryResult result = new PagedQueryResult()
        {
            jwtkey = model.jwtkey,
            IsSuccess = false
        };

        try
        {
            // 第一步：建立 Excel 工作簿
            var workbook = new XSSFWorkbook(); // 使用 XLSX 格式

            // 第二步：建立摘要工作表
            CreateSummarySheet(workbook, model.StatisticsData.SummaryData);

            // 第三步：建立詳細資料工作表
            CreateDetailSheet(workbook, model.StatisticsData.DetailData);

            // 第四步：建立圖表工作表（可選）
            if (model.IncludeChart)
            {
                CreateChartSheet(workbook, model.StatisticsData.ChartData);
            }

            // 第五步：儲存檔案到暫存目錄
            var fileName = model.FileName ?? $"MIT申請案件統計_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            var tempPath = Path.Combine(FormUtils.GetTempPath(), fileName);

            using (var fileStream = new FileStream(tempPath, FileMode.Create))
            {
                workbook.Write(fileStream);
            }

            // 第六步：回傳檔案資訊
            result.Data = new MIT0201ExportResultModel()
            {
                FileName = fileName,
                FilePath = tempPath,
                FileGuid = Guid.NewGuid().ToString(), // 用於後續下載識別
                ExportDate = DateTime.Now
            };

            result.IsSuccess = true;
            result.message = "Excel 匯出成功";
        }
        catch (Exception e)
        {
            result.message = TextUtils.GenErrmsgWithNum(logger, "Excel 匯出失敗", e);
            result.IsSuccess = false;
        }

        return result;
    });
}

/// <summary>
/// 建立統計摘要工作表的私有方法
/// 在 Excel 中建立包含關鍵統計指標的摘要頁面
/// </summary>
/// <param name="workbook">Excel 工作簿</param>
/// <param name="summaryData">摘要統計資料</param>
private void CreateSummarySheet(XSSFWorkbook workbook, MIT0201SummaryDataModel summaryData)
{
    // 建立摘要工作表
    var summarySheet = workbook.CreateSheet("統計摘要");

    // 設定標題樣式
    var titleStyle = workbook.CreateCellStyle();
    var titleFont = workbook.CreateFont();
    titleFont.FontHeightInPoints = 16;
    titleFont.IsBold = true;
    titleStyle.SetFont(titleFont);
    titleStyle.Alignment = HorizontalAlignment.Center;

    // 設定標頭樣式
    var headerStyle = workbook.CreateCellStyle();
    var headerFont = workbook.CreateFont();
    headerFont.IsBold = true;
    headerStyle.SetFont(headerFont);
    headerStyle.FillForegroundColor = IndexedColors.LightBlue.Index;
    headerStyle.FillPattern = FillPattern.SolidForeground;

    // 第一行：標題
    var titleRow = summarySheet.CreateRow(0);
    var titleCell = titleRow.CreateCell(0);
    titleCell.SetCellValue("MIT 申請案件統計摘要");
    titleCell.CellStyle = titleStyle;
    summarySheet.AddMergedRegion(new CellRangeAddress(0, 0, 0, 3)); // 合併儲存格

    // 第三行：統計指標標頭
    var headerRow = summarySheet.CreateRow(2);
    headerRow.CreateCell(0).SetCellValue("統計項目");
    headerRow.CreateCell(1).SetCellValue("數值");
    headerRow.CreateCell(2).SetCellValue("單位");
    headerRow.CreateCell(3).SetCellValue("說明");

    // 套用標頭樣式
    for (int i = 0; i < 4; i++)
    {
        headerRow.GetCell(i).CellStyle = headerStyle;
    }

    // 第四行開始：統計資料
    int rowIndex = 3;

    // 總申請案件數
    var totalRow = summarySheet.CreateRow(rowIndex++);
    totalRow.CreateCell(0).SetCellValue("總申請案件數");
    totalRow.CreateCell(1).SetCellValue(summaryData.TotalCount);
    totalRow.CreateCell(2).SetCellValue("件");
    totalRow.CreateCell(3).SetCellValue("統計期間內的所有申請案件");

    // 已核准案件數
    var approvedRow = summarySheet.CreateRow(rowIndex++);
    approvedRow.CreateCell(0).SetCellValue("已核准案件數");
    approvedRow.CreateCell(1).SetCellValue(summaryData.ApprovedCount);
    approvedRow.CreateCell(2).SetCellValue("件");
    approvedRow.CreateCell(3).SetCellValue("已通過審核的申請案件");

    // 已駁回案件數
    var rejectedRow = summarySheet.CreateRow(rowIndex++);
    rejectedRow.CreateCell(0).SetCellValue("已駁回案件數");
    rejectedRow.CreateCell(1).SetCellValue(summaryData.RejectedCount);
    rejectedRow.CreateCell(2).SetCellValue("件");
    rejectedRow.CreateCell(3).SetCellValue("未通過審核的申請案件");

    // 審核中案件數
    var pendingRow = summarySheet.CreateRow(rowIndex++);
    pendingRow.CreateCell(0).SetCellValue("審核中案件數");
    pendingRow.CreateCell(1).SetCellValue(summaryData.PendingCount);
    pendingRow.CreateCell(2).SetCellValue("件");
    pendingRow.CreateCell(3).SetCellValue("正在審核流程中的申請案件");

    // 核准通過率
    var approvalRateRow = summarySheet.CreateRow(rowIndex++);
    approvalRateRow.CreateCell(0).SetCellValue("核准通過率");
    approvalRateRow.CreateCell(1).SetCellValue(summaryData.ApprovalRate);
    approvalRateRow.CreateCell(2).SetCellValue("%");
    approvalRateRow.CreateCell(3).SetCellValue("已核准案件數 / 總申請案件數");

    // 平均處理天數
    var avgDaysRow = summarySheet.CreateRow(rowIndex++);
    avgDaysRow.CreateCell(0).SetCellValue("平均處理天數");
    avgDaysRow.CreateCell(1).SetCellValue(summaryData.AvgProcessDays);
    avgDaysRow.CreateCell(2).SetCellValue("天");
    avgDaysRow.CreateCell(3).SetCellValue("從申請到核准的平均處理時間");

    // 自動調整欄寬
    for (int i = 0; i < 4; i++)
    {
        summarySheet.AutoSizeColumn(i);
    }
}

/// <summary>
/// 建立詳細統計資料工作表的私有方法
/// 在 Excel 中建立包含分類統計資料的詳細頁面
/// </summary>
/// <param name="workbook">Excel 工作簿</param>
/// <param name="detailData">詳細統計資料清單</param>
private void CreateDetailSheet(XSSFWorkbook workbook, List<MIT0201DetailDataModel> detailData)
{
    // 建立詳細資料工作表
    var detailSheet = workbook.CreateSheet("詳細統計資料");

    // 設定標題樣式
    var titleStyle = workbook.CreateCellStyle();
    var titleFont = workbook.CreateFont();
    titleFont.FontHeightInPoints = 16;
    titleFont.IsBold = true;
    titleStyle.SetFont(titleFont);
    titleStyle.Alignment = HorizontalAlignment.Center;

    // 設定標頭樣式
    var headerStyle = workbook.CreateCellStyle();
    var headerFont = workbook.CreateFont();
    headerFont.IsBold = true;
    headerStyle.SetFont(headerFont);
    headerStyle.FillForegroundColor = IndexedColors.LightGreen.Index;
    headerStyle.FillPattern = FillPattern.SolidForeground;

    // 第一行：標題
    var titleRow = detailSheet.CreateRow(0);
    var titleCell = titleRow.CreateCell(0);
    titleCell.SetCellValue("MIT 申請案件詳細統計資料");
    titleCell.CellStyle = titleStyle;
    detailSheet.AddMergedRegion(new CellRangeAddress(0, 0, 0, 6)); // 合併儲存格

    // 第三行：欄位標頭
    var headerRow = detailSheet.CreateRow(2);
    string[] headers = { "分類", "申請數量", "核准數量", "駁回數量", "審核中數量", "通過率(%)", "平均處理天數" };

    for (int i = 0; i < headers.Length; i++)
    {
        var cell = headerRow.CreateCell(i);
        cell.SetCellValue(headers[i]);
        cell.CellStyle = headerStyle;
    }

    // 第四行開始：詳細資料
    int rowIndex = 3;
    foreach (var item in detailData)
    {
        var dataRow = detailSheet.CreateRow(rowIndex++);
        dataRow.CreateCell(0).SetCellValue(item.CategoryName);
        dataRow.CreateCell(1).SetCellValue(item.TotalCount);
        dataRow.CreateCell(2).SetCellValue(item.ApprovedCount);
        dataRow.CreateCell(3).SetCellValue(item.RejectedCount);
        dataRow.CreateCell(4).SetCellValue(item.PendingCount);
        dataRow.CreateCell(5).SetCellValue(item.ApprovalRate);
        dataRow.CreateCell(6).SetCellValue(item.AvgProcessDays);
    }

    // 新增總計行
    if (detailData.Count > 0)
    {
        var totalRow = detailSheet.CreateRow(rowIndex + 1);
        totalRow.CreateCell(0).SetCellValue("總計");
        totalRow.CreateCell(1).SetCellValue(detailData.Sum(x => x.TotalCount));
        totalRow.CreateCell(2).SetCellValue(detailData.Sum(x => x.ApprovedCount));
        totalRow.CreateCell(3).SetCellValue(detailData.Sum(x => x.RejectedCount));
        totalRow.CreateCell(4).SetCellValue(detailData.Sum(x => x.PendingCount));

        // 計算整體通過率
        var totalApproved = detailData.Sum(x => x.ApprovedCount);
        var totalCount = detailData.Sum(x => x.TotalCount);
        var overallApprovalRate = totalCount > 0 ? Math.Round((double)totalApproved / totalCount * 100, 2) : 0;
        totalRow.CreateCell(5).SetCellValue(overallApprovalRate);

        // 計算整體平均處理天數
        var avgProcessDays = detailData.Where(x => x.AvgProcessDays > 0).Average(x => x.AvgProcessDays);
        totalRow.CreateCell(6).SetCellValue(Math.Round(avgProcessDays, 1));

        // 套用總計行樣式
        var totalStyle = workbook.CreateCellStyle();
        var totalFont = workbook.CreateFont();
        totalFont.IsBold = true;
        totalStyle.SetFont(totalFont);
        totalStyle.FillForegroundColor = IndexedColors.LightYellow.Index;
        totalStyle.FillPattern = FillPattern.SolidForeground;

        for (int i = 0; i < 7; i++)
        {
            totalRow.GetCell(i).CellStyle = totalStyle;
        }
    }

    // 自動調整欄寬
    for (int i = 0; i < 7; i++)
    {
        detailSheet.AutoSizeColumn(i);
    }
}
```

**程式碼說明：**

1. **NPOI 函式庫**：使用 NPOI 產生 Excel 檔案，支援複雜的格式設定
2. **多工作表結構**：分別建立摘要和詳細資料工作表，提供不同層次的資訊
3. **樣式設定**：設定標題、標頭、資料的不同樣式，提升可讀性
4. **自動計算**：在詳細資料表中自動計算總計和平均值
5. **欄寬調整**：自動調整欄寬以適應內容長度
6. **錯誤處理**：完整的異常處理機制，確保匯出過程穩定

## 4. 完整資料流程圖

```
數據統計分析完整流程：

前端統計查詢流程：
1. 使用者設定統計查詢條件（時間範圍、分組方式、統計類型）
2. 前端驗證查詢條件的完整性
3. 顯示載入動畫，提升使用者體驗
4. 呼叫 API：POST /api/mitf/mit02/MIT0201/GetStatistics

後端統計分析流程：
5. 控制器接收統計查詢請求
6. 驗證 JWT Token 與使用者權限
7. 呼叫服務層統計分析方法
8. 執行摘要統計查詢（總數、通過率、平均處理時間）
9. 執行詳細統計查詢（按分組方式聚合資料）
10. 準備圖表資料格式轉換
11. 回傳統計分析結果

前端資料展示流程：
12. 接收統計分析結果
13. 關閉載入動畫
14. 更新統計摘要卡片顯示
15. 初始化 Chart.js 圖表展示
16. 填充詳細統計資料表格
17. 啟用 Excel 匯出按鈕

Excel 匯出流程：
18. 使用者點擊「匯出 Excel」按鈕
19. 前端發送匯出請求：POST /api/mitf/mit02/MIT0201/ExportStatistics
20. 後端使用 NPOI 建立 Excel 工作簿
21. 建立統計摘要工作表（關鍵指標）
22. 建立詳細資料工作表（分類統計）
23. 套用樣式格式和自動計算
24. 儲存 Excel 檔案到暫存目錄
25. 回傳檔案下載資訊

檔案下載流程：
26. 前端接收檔案資訊
27. 呼叫通用下載 API：POST /api/COM0105/Downloadfile
28. 後端驗證檔案存在性和使用者權限
29. 讀取 Excel 檔案內容
30. 設定正確的 MIME 類型（application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）
31. 回傳檔案資料流

前端檔案處理流程：
32. 接收 Excel 檔案 Blob 資料
33. 建立臨時下載 URL
34. 觸發瀏覽器下載行為
35. 清理臨時資源和記憶體
```

## 5. 數據模型定義

### 5.1 統計查詢條件模型

```csharp
/// <summary>
/// 統計查詢條件的資料模型
/// 定義前端傳送給後端的統計分析參數
/// </summary>
public class MIT0201StatisticsQueryModel : BaseQueryModel
{
    /// <summary>
    /// 統計開始日期
    /// </summary>
    public string StartDate { get; set; }

    /// <summary>
    /// 統計結束日期
    /// </summary>
    public string EndDate { get; set; }

    /// <summary>
    /// 申請類型篩選條件（可選）
    /// 對應 SysCode 中 Kind='FORMTYPE' 的代碼
    /// </summary>
    public string? FormType { get; set; }

    /// <summary>
    /// 申請狀態篩選條件（可選）
    /// 對應 SysCode 中 Kind='FORMPROCESS' 的代碼
    /// </summary>
    public string? FormProcess { get; set; }

    /// <summary>
    /// 統計分組方式
    /// FORMTYPE: 按申請類型分組
    /// FORMPROCESS: 按申請狀態分組
    /// MONTH: 按月份分組
    /// QUARTER: 按季度分組
    /// </summary>
    public string GroupBy { get; set; }

    /// <summary>
    /// 統計類型
    /// COUNT: 數量統計
    /// APPROVAL_RATE: 通過率統計
    /// PROCESS_TIME: 處理時間統計
    /// </summary>
    public string StatisticsType { get; set; }
}

/// <summary>
/// 統計結果的資料模型
/// 包含摘要資料、詳細資料和圖表資料
/// </summary>
public class MIT0201StatisticsResultModel
{
    /// <summary>
    /// 統計摘要資料
    /// </summary>
    public MIT0201SummaryDataModel SummaryData { get; set; }

    /// <summary>
    /// 詳細統計資料清單
    /// </summary>
    public List<MIT0201DetailDataModel> DetailData { get; set; }

    /// <summary>
    /// 圖表資料
    /// </summary>
    public MIT0201ChartDataModel ChartData { get; set; }
}

/// <summary>
/// 統計摘要資料模型
/// 包含關鍵統計指標
/// </summary>
public class MIT0201SummaryDataModel
{
    /// <summary>
    /// 總申請案件數
    /// </summary>
    public int TotalCount { get; set; }

    /// <summary>
    /// 已核准案件數
    /// </summary>
    public int ApprovedCount { get; set; }

    /// <summary>
    /// 已駁回案件數
    /// </summary>
    public int RejectedCount { get; set; }

    /// <summary>
    /// 審核中案件數
    /// </summary>
    public int PendingCount { get; set; }

    /// <summary>
    /// 核准通過率（百分比）
    /// </summary>
    public double ApprovalRate { get; set; }

    /// <summary>
    /// 平均處理天數
    /// </summary>
    public double AvgProcessDays { get; set; }
}

/// <summary>
/// 詳細統計資料模型
/// 包含分類統計的詳細資訊
/// </summary>
public class MIT0201DetailDataModel
{
    /// <summary>
    /// 分類代碼
    /// </summary>
    public string Category { get; set; }

    /// <summary>
    /// 分類名稱
    /// </summary>
    public string CategoryName { get; set; }

    /// <summary>
    /// 該分類的總申請案件數
    /// </summary>
    public int TotalCount { get; set; }

    /// <summary>
    /// 該分類的已核准案件數
    /// </summary>
    public int ApprovedCount { get; set; }

    /// <summary>
    /// 該分類的已駁回案件數
    /// </summary>
    public int RejectedCount { get; set; }

    /// <summary>
    /// 該分類的審核中案件數
    /// </summary>
    public int PendingCount { get; set; }

    /// <summary>
    /// 該分類的核准通過率（百分比）
    /// </summary>
    public double ApprovalRate { get; set; }

    /// <summary>
    /// 該分類的平均處理天數
    /// </summary>
    public double AvgProcessDays { get; set; }
}

/// <summary>
/// 圖表資料模型
/// 提供前端圖表庫所需的資料格式
/// </summary>
public class MIT0201ChartDataModel
{
    /// <summary>
    /// 圖表類型（bar, line, pie 等）
    /// </summary>
    public string Type { get; set; }

    /// <summary>
    /// 圖表標題
    /// </summary>
    public string Title { get; set; }

    /// <summary>
    /// X 軸標籤陣列
    /// </summary>
    public string[] Labels { get; set; }

    /// <summary>
    /// Y 軸數值陣列
    /// </summary>
    public int[] Values { get; set; }

    /// <summary>
    /// 資料集標籤
    /// </summary>
    public string DatasetLabel { get; set; }

    /// <summary>
    /// X 軸標題
    /// </summary>
    public string XAxisLabel { get; set; }

    /// <summary>
    /// Y 軸標題
    /// </summary>
    public string YAxisLabel { get; set; }
}
```

**程式碼說明：**

1. **分層資料模型**：清楚定義查詢條件、統計結果、摘要資料等不同層次的資料結構
2. **型別安全**：使用強型別定義，避免資料傳遞錯誤
3. **文件化註解**：詳細的 XML 註解說明每個屬性的用途和格式
4. **彈性設計**：支援多種統計類型和分組方式的擴展
5. **前端整合**：圖表資料模型直接對應前端圖表庫的需求格式

## 6. 開發與維護指南

### 6.1 新增統計維度的步驟

當需要新增不同的統計維度時，可以按照以下步驟進行：

1. **擴展分組選項**

   ```csharp
   // 在 GetDetailStatistics 方法中新增分組邏輯
   case "DEPARTMENT":  // 按部門分組
       selectClause = "d.Name as CategoryName, af.DeptId as Category";
       groupByClause = "GROUP BY af.DeptId, d.Name";
       // 需要額外 JOIN Departments 表
       break;
   ```

2. **更新前端選項**

   ```vue
   <!-- 在統計分組下拉選單中新增選項 -->
   <SelectSysCode
     :title="'統計分組'"
     :kind="'STATISTICS_GROUP'"
     v-model:code="query_data.q_groupBy"
     :isRequire="true" />
   ```

3. **新增系統代碼**
   ```sql
   -- 在 SysCode 表中新增統計分組選項
   INSERT INTO SysCode (Kind, Code, CodeName, SortNum)
   VALUES ('STATISTICS_GROUP', 'DEPARTMENT', '按部門分組', 5);
   ```

### 6.2 效能優化建議

1. **索引優化**

   ```sql
   -- 為統計查詢建立複合索引
   CREATE INDEX IX_ApplyForm_Statistics
   ON ApplyForm (ComId, CreateDate, FormType, FormProcess, IsDelete);
   ```

2. **查詢快取**

   ```csharp
   // 對於相同條件的統計查詢，可以考慮快取結果
   public async Task<MIT0201StatisticsResultModel> GetCachedStatistics(string cacheKey, MIT0201StatisticsQueryModel model)
   {
       var cachedResult = _cache.Get<MIT0201StatisticsResultModel>(cacheKey);
       if (cachedResult != null)
       {
           return cachedResult;
       }

       var result = await GetStatistics(model);
       _cache.Set(cacheKey, result, TimeSpan.FromMinutes(15)); // 快取 15 分鐘
       return result;
   }
   ```

3. **分頁處理**
   ```csharp
   // 對於大量統計資料，考慮實作分頁機制
   public async Task<PagedQueryResult> GetPagedDetailStatistics(MIT0201StatisticsQueryModel model, int pageSize = 50)
   {
       // 實作分頁邏輯
   }
   ```

### 6.3 圖表類型擴展

1. **新增圓餅圖支援**

   ```typescript
   case "pie":  // 圓餅圖
       chartConfig.type = 'pie';
       chartConfig.options.plugins.legend.position = 'right';
       // 圓餅圖特殊配置
       break;
   ```

2. **新增堆疊長條圖**
   ```typescript
   case "stackedBar":  // 堆疊長條圖
       chartConfig.type = 'bar';
       chartConfig.options.scales.x.stacked = true;
       chartConfig.options.scales.y.stacked = true;
       break;
   ```

### 6.4 Excel 匯出格式擴展

1. **新增圖表匯出**

   ```csharp
   // 在 Excel 中嵌入圖表
   private void CreateChartSheet(XSSFWorkbook workbook, MIT0201ChartDataModel chartData)
   {
       var chartSheet = workbook.CreateSheet("統計圖表");
       // 使用 NPOI 的圖表功能建立 Excel 圖表
   }
   ```

2. **新增 CSV 匯出選項**

   ```csharp
   public async Task<string> ExportToCsv(MIT0201StatisticsResultModel statisticsData)
   {
       var csv = new StringBuilder();
       csv.AppendLine("分類,申請數量,核准數量,駁回數量,審核中數量,通過率,平均處理天數");

       foreach (var item in statisticsData.DetailData)
       {
           csv.AppendLine($"{item.CategoryName},{item.TotalCount},{item.ApprovedCount},{item.RejectedCount},{item.PendingCount},{item.ApprovalRate},{item.AvgProcessDays}");
       }

       return csv.ToString();
   }
   ```

這個數據統計分析報表系統展示了完整的數據處理流程，從前端複雜的查詢條件設定到後端高效的 SQL 聚合查詢，涵蓋了統計計算、圖表視覺化、Excel 匯出等各個面向。與第三個文件的文檔型報表相比，此系統更注重數據的分析和視覺化展示，提供了豐富的統計維度和互動式的數據探索功能，為管理者提供了強大的決策支援工具。
