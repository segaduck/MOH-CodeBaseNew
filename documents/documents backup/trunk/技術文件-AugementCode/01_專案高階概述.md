# 電子病歷申請系統 (EECOnline) - 專案高階概述

## 專案概述

電子病歷申請系統（EECOnline）是一個全端 Web 應用程式，專門用於提供民眾線上申請電子病歷服務。系統採用 ASP.NET MVC 5 架構，整合多家醫院的病歷系統，提供完整的病歷申請、審核、繳費及管理功能。

### 系統主要功能
- **線上病歷申請**：民眾可透過自然人憑證或健保卡線上申請電子病歷
- **醫院整合系統**：與多家醫院系統整合，自動取得病歷資料
- **病歷格式轉換**：將醫院提供的 XML 格式病歷轉換為 HTML 供民眾查看
- **繳費整合系統**：整合線上繳費功能，支援信用卡等多種繳費方式
- **醫院管理系統**：提供醫院端管理介面，管理病歷申請案件
- **API 整合服務**：提供 API 介面與醫院系統進行資料交換
- **排程任務系統**：自動化處理郵件發送、請款檔產生等背景任務
- **系統管理功能**：使用者、角色、權限、代碼等系統基礎設定

## 與 109_e-service 的關係與差異

### 相似之處

兩個系統都是衛福部相關的線上申辦系統，具有以下共同特點：

1. **技術架構相似**
   - 都採用 ASP.NET MVC 框架
   - 都使用 Areas 進行模組化設計
   - 都整合 Hangfire 排程系統
   - 都使用 SQL Server 資料庫

2. **功能模式相似**
   - 都有申請案件管理功能
   - 都有繳費系統整合
   - 都有後台審核管理
   - 都有報表產製功能
   - 都有權限控制機制

3. **安全性設計相似**
   - 都支援憑證登入
   - 都有 HTTPS 強制使用
   - 都有 Cookie 安全設定
   - 都有防注入攻擊機制

### 主要差異

| 項目 | 109_e-service | EECOnline |
|------|---------------|-----------|
| **系統名稱** | 衛福部人民線上申辦系統 | 電子病歷申請系統 |
| **業務領域** | 多種業務申辦（醫事人員證書、執照等） | 專注於電子病歷申請 |
| **MVC 版本** | ASP.NET MVC 4 | ASP.NET MVC 5 |
| **.NET 版本** | .NET Framework 4.0 | .NET Framework 4.5.2 |
| **ORM 技術** | Dapper | IBatis.NET |
| **資料庫** | e-service | EECOnline |
| **主要使用者** | 一般民眾、醫事人員 | 一般民眾、醫院 |
| **核心功能** | 多種證書/執照申辦 | 病歷申請與查詢 |
| **外部整合** | 醫審系統 (MDOD)、我的E政府 | 醫院系統 API |
| **特殊功能** | 多元憑證登入、SFTP 上傳 | 病歷格式轉換、醫院 API 整合 |

### 系統定位

- **109_e-service**：通用型線上申辦平台，支援多種業務申辦流程
- **EECOnline**：專業型病歷申請系統，專注於電子病歷的申請與管理

## 專案結構

### 檔案目錄結構

```
trunk/
├── App_Data/                    # 應用程式資料目錄
├── App_Start/                   # 應用程式啟動設定
│   ├── BundleConfig.cs         # 前端資源打包設定
│   ├── FilterConfig.cs         # 全域過濾器設定
│   └── RouteConfig.cs          # 路由設定
├── Areas/                       # MVC Areas 模組化區域
│   ├── A1/                     # 功能模組 A1
│   ├── A2/                     # 功能模組 A2
│   ├── A3/                     # 功能模組 A3
│   ├── A4/                     # 功能模組 A4
│   ├── A5/                     # 功能模組 A5
│   ├── A6/                     # 功能模組 A6
│   ├── A7/                     # 功能模組 A7
│   ├── A8/                     # 功能模組 A8
│   ├── BackApply/              # 後台申請管理
│   ├── Login/                  # 登入模組
│   ├── Resource/               # 資源管理
│   └── SHARE/                  # 共用功能
├── Commons/                     # 共用類別庫
│   ├── StaticCodeMap.cs        # 靜態代碼對應
│   └── StaticCodeMap_TableName.cs  # 資料表名稱對應
├── Controllers/                 # 主要控制器
│   ├── AjaxController.cs       # Ajax 請求控制器
│   ├── BaseController.cs       # 基礎控制器
│   ├── EBaseController.cs      # 擴充基礎控制器
│   ├── HomeController.cs       # 首頁控制器
│   └── ExportController.cs     # 匯出控制器
├── DataLayers/                  # 資料存取層
│   ├── BaseDAO.cs              # 基礎 DAO
│   ├── FrontDAO.cs             # 前台 DAO
│   ├── BackApplyDAO.cs         # 後台申請 DAO
│   ├── LoginDAO.cs             # 登入 DAO
│   ├── AMDAO.cs                # 權限管理 DAO
│   ├── SHAREDAO.cs             # 共用 DAO
│   └── A1DAO.cs ~ A8DAO.cs     # 各模組 DAO
├── Models/                      # 資料模型
│   ├── Entities/               # 實體模型（對應資料表）
│   │   ├── EEC_Apply.cs        # 申請主檔
│   │   ├── EEC_ApplyDetail.cs  # 申請明細
│   │   ├── EEC_Hospital.cs     # 醫院主檔
│   │   ├── EEC_User.cs         # 使用者主檔
│   │   ├── CODE.cs             # 代碼主檔
│   │   └── ...                 # 其他實體
│   └── base/                   # 基礎模型
├── Services/                    # 服務層
├── Utils/                       # 工具類別
│   └── Hospital_Common_Api.cs  # 醫院共用 API
├── Views/                       # 視圖檔案
├── SqlMaps/                     # IBatis SQL 對應檔
├── Template/                    # 報表模板
├── Uploads/                     # 上傳檔案目錄
├── Global.asax.cs              # 全域應用程式設定
├── Startup.cs                  # Hangfire 啟動設定
├── HangfireBootstrapper.cs     # Hangfire 啟動器
├── Web.config                  # 網站設定檔
├── SqlMap.config               # IBatis 設定檔
└── packages.config             # NuGet 套件設定
```

### Areas 模組說明

系統使用 MVC Areas 進行功能模組化，主要模組包括：

- **A1-A8**：8 個功能模組區域（具體功能待確認）
- **BackApply**：後台申請管理模組
- **Login**：登入認證模組
- **Resource**：資源管理模組（包含病歷查詢等功能）
- **SHARE**：共用功能模組

## 技術堆疊

### 後端技術

| 技術 | 版本 | 用途 |
|------|------|------|
| ASP.NET MVC | 5.2.3 | Web 應用程式框架 |
| .NET Framework | 4.5.2 | 執行環境 |
| C# | 6.0 | 程式語言 |
| IBatis.NET | 1.6.2 | ORM 框架 |
| Hangfire | 1.6.x | 背景任務排程 |
| Log4Net | 2.0.x | 日誌記錄 |
| Newtonsoft.Json | 12.0.x | JSON 序列化 |

### 前端技術

| 技術 | 版本 | 用途 |
|------|------|------|
| jQuery | 3.x | JavaScript 函式庫 |
| Bootstrap | 3.x | UI 框架 |
| Razor | 3.0 | 視圖引擎 |

### 資料庫

| 技術 | 版本 | 用途 |
|------|------|------|
| SQL Server | 2016+ | 主要資料庫 |

### 開發工具

| 工具 | 版本 | 用途 |
|------|------|------|
| Visual Studio | 2015+ | 開發環境 |
| IIS | 8.0+ | Web 伺服器 |

## 核心功能模組

### 1. 病歷申請模組

**功能說明：**
- 民眾透過自然人憑證或健保卡登入
- 填寫病歷申請表單
- 選擇申請的醫院與病歷類型
- 線上繳費
- 查詢申請進度

**主要資料表：**
- EEC_Apply：申請主檔
- EEC_ApplyDetail：申請明細
- EEC_ApplyDetailPrice：申請價格明細
- EEC_User：使用者資料

### 2. 醫院管理模組

**功能說明：**
- 醫院帳號管理
- 病歷申請案件查詢
- 病歷上傳與管理
- 價格設定
- 權限管理

**主要資料表：**
- EEC_Hospital：醫院主檔
- EEC_Hospital_SetPrice：醫院價格設定
- EEC_Hospital_Api：醫院 API 設定
- AMGRP_Hosp：醫院群組
- AMUROLE_Hosp：醫院角色權限

### 3. API 整合模組

**功能說明：**
- 提供 API 介面供醫院系統呼叫
- 取得病歷資料（XML 格式）
- 病歷格式轉換（XML → HTML）
- API Token 管理
- API 使用記錄

**主要資料表：**
- EEC_Api_User：API 使用者
- EEC_Api_Token：API Token
- EEC_ApplyDetailPrice_ApiData：API 資料

**核心 API 功能：**
1. 登入取得 Token
2. 查詢申請案件
3. 上傳病歷資料
4. 下載病歷報告

### 4. 繳費系統模組

**功能說明：**
- 線上信用卡繳費
- 繳費狀態查詢
- 繳費記錄管理
- 請款檔產生

### 5. 排程任務模組

**使用 Hangfire 實作的排程任務：**

```csharp
// 每天凌晨 4 點執行
RecurringJob.AddOrUpdate(() => aj.CheckProvideDataStatus_Or_SendMailToEECHosp(), 
    "00 04 * * *", TimeZoneInfo.Local);

// 每天凌晨 4 點執行（檢查亞東醫院資料）
RecurringJob.AddOrUpdate(() => aj.CheckDataIsGot_Or_SendEmailTo_FarEastern(), 
    "00 04 * * *", TimeZoneInfo.Local);

// 每天晚上 8:20 執行（匯出請款檔）
RecurringJob.AddOrUpdate(() => aj.ExportDat_GO("1131010011H"), 
    "20 00 * * *", TimeZoneInfo.Local);

// 每天早上 7:40 執行（處理請款檔下載）
RecurringJob.AddOrUpdate(() => aj.ProcessRequestFileDownloadSchedule("1131010011H"), 
    "40 7 * * *", TimeZoneInfo.Local);

// 每天早上 7:50 執行（匯入請款檔）
RecurringJob.AddOrUpdate(() => aj.ImportDat_Go("1131010011H"), 
    "50 7 * * *", TimeZoneInfo.Local);
```

### 6. 權限管理模組

**功能說明：**
- 使用者管理
- 角色管理
- 功能權限設定
- 選單權限控制

**主要資料表：**
- AMFUNCM：功能主檔
- AMGRP：群組主檔
- AMUROLE：使用者角色
- AMGMAPM：群組功能對應

## 資料庫架構概覽

### 主要資料表分類

1. **申請系統資料表**
   - EEC_Apply：申請主檔
   - EEC_ApplyDetail：申請明細
   - EEC_ApplyDetailPrice：申請價格明細
   - EEC_ApplyDetailPrice_ApiData：API 資料
   - EEC_ApplyDetailUploadLog：上傳記錄

2. **醫院系統資料表**
   - EEC_Hospital：醫院主檔
   - EEC_Hospital_SetPrice：醫院價格設定
   - EEC_Hospital_Api：醫院 API 設定
   - EEC_Hospital_PWDLOG：密碼變更記錄
   - EEC_Hospital_CHANGEPWD_GUID：密碼變更 GUID

3. **使用者系統資料表**
   - EEC_User：使用者主檔
   - EEC_UserOperation：使用者操作記錄

4. **API 系統資料表**
   - EEC_Api_User：API 使用者
   - EEC_Api_Token：API Token

5. **權限管理資料表**
   - AMFUNCM：功能主檔
   - AMGRP：群組主檔
   - AMUROLE：使用者角色
   - AMGMAPM：群組功能對應
   - AMGRP_Hosp：醫院群組
   - AMUROLE_Hosp：醫院角色權限

6. **系統管理資料表**
   - CODE：代碼主檔
   - SETUP：系統參數
   - UNIT：單位主檔
   - LOGINLOG：登入記錄
   - MAILLOG：郵件記錄
   - VISIT_RECORD：訪問記錄

7. **內容管理資料表**
   - ENEWS：最新消息
   - EFAQ：常見問題
   - ELINKS：相關連結
   - EFILE：檔案管理

## 系統架構特色

### 1. 醫院整合架構

系統與多家醫院進行整合，透過 API 介面取得病歷資料：

- **API 認證機制**：使用 Token 進行身份驗證
- **資料格式轉換**：XML → HTML
- **XSLT 轉換**：使用 XSLT 樣式表進行格式轉換
- **資料快取**：將轉換後的 HTML 儲存於資料庫

### 2. 病歷格式轉換流程

```
1. 民眾提出申請
   ↓
2. 系統呼叫醫院 API 取得 Token
   ↓
3. 使用 Token 下載病歷資料（XML 格式，Base64 編碼）
   ↓
4. 將 Base64 解碼並儲存至資料庫
   ↓
5. 使用 XSLT 將 XML 轉換為 HTML
   ↓
6. 將 HTML 儲存至資料庫供民眾查看
```

### 3. 排程任務架構

使用 Hangfire 實作背景任務排程：

- **定時檢查**：檢查醫院是否已提供病歷資料
- **郵件通知**：自動發送通知郵件給醫院或民眾
- **請款處理**：自動產生請款檔並進行匯入/匯出
- **資料同步**：定時同步醫院資料

## 開發與部署

### 開發環境設定

1. **安裝 Visual Studio 2015 或更新版本**
2. **安裝 SQL Server 2016 或更新版本**
3. **還原 NuGet 套件**
4. **設定資料庫連線字串**（Web.config）
5. **建立資料庫**（執行 SQL 腳本）
6. **設定 IIS Express 或 IIS**

### 設定檔說明

#### Web.config 主要設定

```xml
<connectionStrings>
  <add name="connectionEUSERVICE" 
       connectionString="Data Source=...;initial catalog=EECOnline;..." />
</connectionStrings>

<appSettings>
  <!-- 主機環境角色設定: 1.內網環境, 2.外網環境 -->
  <add key="NetID" value="1" />
  
  <!-- 停用權限檢核（測試用） -->
  <add key="DisableAuthorize" value="1" />
  
  <!-- 檔案上傳路徑 -->
  <add key="UpLoadFile" value="/Uploads" />
  
  <!-- 系統暫存路徑 -->
  <add key="TempPath" value="/App_Data/Temp" />
</appSettings>
```

#### SqlMap.config（IBatis 設定）

```xml
<sqlMapConfig>
  <settings>
    <setting useStatementNamespaces="true"/>
    <setting cacheModelsEnabled="true"/>
  </settings>
  
  <database>
    <provider name="sqlServer2.0"/>
    <dataSource name="EECOnline" 
                connectionString="connectionEUSERVICE"/>
  </database>
  
  <sqlMaps>
    <sqlMap resource="SqlMaps/Front.xml"/>
    <sqlMap resource="SqlMaps/BackApply.xml"/>
    <!-- 其他 SQL Map 檔案 -->
  </sqlMaps>
</sqlMapConfig>
```

## 系統特色總結

1. **專業化設計**：專注於電子病歷申請，功能深入且完整
2. **醫院整合**：與多家醫院系統整合，自動化取得病歷資料
3. **格式轉換**：支援 XML 到 HTML 的病歷格式轉換
4. **API 架構**：提供完整的 API 介面供醫院系統整合
5. **自動化排程**：使用 Hangfire 實作多種背景任務
6. **安全性設計**：支援憑證登入、HTTPS、防注入攻擊等安全機制
7. **模組化架構**：使用 Areas 進行功能模組化，易於維護與擴充

## 後續文件說明

本文件為專案高階概述，詳細的技術實作請參考以下文件：

- 02_全端功能詳細範例_病歷申請管理
- 03_全端功能詳細範例_報表產生系統
- 04_全端功能詳細範例_數據統計分析報表
- 05_資料庫存取方法詳細範例_IBatis與DirectSQL對應
- 06_身份驗證與授權機制詳細範例_Authentication與Authorization
- 07_側邊選單權限控制詳細範例_Menu與Permission設計
- 08_統一代碼系統詳細範例_CodeKind與CodeItem
- 09_統一安全設計詳細範例_OWASP防護機制與驗證
- 10_資料庫架構與CRUD操作詳細範例

