# 衛福部人民線上申辦系統 - 全端功能詳細範例：數據統計分析報表

## 功能概述

本文詳細說明 e-service 系統中的數據統計分析報表功能，包含申辦統計、登入統計、熱門申辦統計、書表下載統計、繳費方式統計等多種統計報表，以及使用 Hangfire 實作的背景排程任務系統。

## 統計報表架構

```
統計報表系統架構：

前端查詢介面
    ↓
控制器接收查詢條件
    ↓
Action 層執行統計查詢
    ↓
資料庫聚合查詢（GROUP BY、SUM、COUNT）
    ↓
資料處理與格式化
    ↓
回傳統計結果
    ├─→ 網頁顯示（圖表、表格）
    └─→ Excel 匯出
```

## 1. 申辦統計報表

### 1.1 控制器實作

**檔案位置：** `ES/Areas/BACKMIN/Controllers/ReportController.cs`

#### 1.1.1 申辦統計查詢

```csharp
/// <summary>
/// 申辦統計報表控制器
/// 提供各種統計報表的查詢與匯出功能
/// </summary>
[Authorize(Roles = "Admin")]  // 限制只有管理員可存取
public class ReportController : BaseController
{
    /// <summary>
    /// 申辦統計查詢頁面（GET）
    /// </summary>
    [HttpGet]
    public ActionResult CaseSum()
    {
        CaseSumModel model = new CaseSumModel();
        // 預設查詢當天資料
        model.Sdate = DateTime.Now.ToString("yyyy/MM/dd");
        model.Fdate = DateTime.Now.ToString("yyyy/MM/dd");
        ViewBag.CallFunc = "";

        // 記錄訪問記錄
        this.SetVisitRecord("Report", "CaseSum", "申辦統計");

        return View(model);
    }

    /// <summary>
    /// 申辦統計查詢（POST）
    /// </summary>
    [HttpPost]
    public ActionResult CaseSum(CaseSumModel model)
    {
        ViewBag.CallFunc = "classpage();";  // 執行前端分頁函數
        return View(model);
    }

    /// <summary>
    /// 產生申辦統計報表
    /// </summary>
    public ActionResult CaseSumReport(string Sdate, string Fdate)
    {
        CaseSumModel model = new CaseSumModel();
        model.Fdate = Fdate;
        model.Sdate = Sdate;

        // 呼叫 Action 層取得統計資料
        ReportAction action = new ReportAction();
        ViewBag.List = action.GetCaseSumReport(model);

        return View(model);
    }
}
```

**程式碼說明：**

1. **角色授權**：使用 `[Authorize(Roles = "Admin")]` 限制只有管理員可存取
2. **預設日期**：查詢頁面預設顯示當天日期
3. **訪問記錄**：使用 `SetVisitRecord` 記錄使用者操作
4. **分離關注點**：控制器負責接收請求，Action 層負責業務邏輯

### 1.2 業務邏輯層實作

**檔案位置：** `ES/Areas/BACKMIN/Action/ReportAction.cs`

#### 1.2.1 申辦統計查詢邏輯

```csharp
/// <summary>
/// 取得申辦統計報表資料
/// 統計各服務的申請案件數量
/// </summary>
/// <param name="model">查詢條件模型</param>
/// <returns>統計結果列表</returns>
public List<CaseSumViewModel> GetCaseSumReport(CaseSumModel model)
{
    List<CaseSumViewModel> list = new List<CaseSumViewModel>();

    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            // 統計 SQL 查詢
            string sql = @"
                SELECT
                    S.SRV_ID,                    -- 服務代碼
                    S.NAME AS SRV_NAME,          -- 服務名稱
                    S.UNIT_CD,                   -- 單位代碼
                    U.NAME AS UNIT_NAME,         -- 單位名稱
                    COUNT(A.APP_ID) AS APP_COUNT -- 申請案件數
                FROM SERVICE S
                    LEFT JOIN APPLY A ON S.SRV_ID = A.SRV_ID
                        AND A.APPLY_DATE >= @Sdate
                        AND A.APPLY_DATE < @Fdate
                        AND A.DEL_MK = 'N'
                    LEFT JOIN UNIT U ON S.UNIT_CD = U.UNIT_CD
                WHERE S.DEL_MK = 'N'
                GROUP BY S.SRV_ID, S.NAME, S.UNIT_CD, U.NAME
                ORDER BY S.UNIT_CD, S.SRV_ID";

            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                // 加入查詢參數
                cmd.Parameters.AddWithValue("@Sdate", model.Sdate);
                cmd.Parameters.AddWithValue("@Fdate",
                    Convert.ToDateTime(model.Fdate).AddDays(1));

                using (SqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        CaseSumViewModel item = new CaseSumViewModel
                        {
                            SRV_ID = DataUtils.GetDBString(reader, "SRV_ID"),
                            SRV_NAME = DataUtils.GetDBString(reader, "SRV_NAME"),
                            UNIT_CD = DataUtils.GetDBString(reader, "UNIT_CD"),
                            UNIT_NAME = DataUtils.GetDBString(reader, "UNIT_NAME"),
                            APP_COUNT = DataUtils.GetDBInt(reader, "APP_COUNT")
                        };
                        list.Add(item);
                    }
                }
            }

            conn.Close();
        }
    }
    catch (Exception ex)
    {
        logger.Error("取得申辦統計失敗", ex);
        throw;
    }

    return list;
}
```

**程式碼說明：**

1. **GROUP BY 聚合**：使用 GROUP BY 統計各服務的申請數量
2. **LEFT JOIN**：確保沒有申請案件的服務也會顯示（數量為 0）
3. **日期範圍**：結束日期加 1 天以包含當天的所有資料
4. **參數化查詢**：防止 SQL Injection
5. **資料讀取**：使用 DataUtils 工具類別安全讀取資料

## 2. 登入統計報表

### 2.1 登入統計查詢

**檔案位置：** `ES/Areas/BACKMIN/Controllers/ReportController.cs`

```csharp
/// <summary>
/// 登入統計查詢頁面（GET）
/// </summary>
[HttpGet]
public ActionResult StatisticsLogin()
{
    StatisticsLoginModel model = new StatisticsLoginModel();
    model.Sdate = DateTime.Now.ToString("yyyy/MM/dd");
    model.Fdate = DateTime.Now.ToString("yyyy/MM/dd");

    this.SetVisitRecord("Report", "StatisticsLogin", "登入統計");

    return View(model);
}

/// <summary>
/// 登入統計查詢（POST）
/// </summary>
[HttpPost]
public ActionResult StatisticsLogin(StatisticsLoginModel model)
{
    ReportAction action = new ReportAction();
    ViewBag.Map = action.GetLoginReport(model);
    return View(model);
}
```

### 2.2 登入統計業務邏輯

**檔案位置：** `ES/Areas/BACKMIN/Action/ReportAction.cs`

```csharp
/// <summary>
/// 取得登入統計資料
/// 統計各種登入方式的使用次數
/// </summary>
/// <param name="model">查詢條件模型</param>
/// <returns>統計結果字典</returns>
public Dictionary<string, int> GetLoginReport(StatisticsLoginModel model)
{
    Dictionary<string, int> map = new Dictionary<string, int>();

    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            using (SqlCommand dbc = conn.CreateCommand())
            {
                // 統計各種登入方式的次數
                dbc.CommandText = @"
                    SELECT
                        SUM(member) AS member,      -- 一般會員登入
                        SUM(moica) AS moica,        -- 自然人憑證登入
                        SUM(moeaca) AS moeaca,      -- 工商憑證登入
                        SUM(hca0) AS hca0,          -- 醫事人員憑證登入（舊）
                        SUM(hca1) AS hca1,          -- 醫事人員憑證登入（新）
                        SUM(NEWEID) AS NEWEID       -- 數位身分證登入
                    FROM LOGIN_STATISTICS
                    WHERE LOGIN_DATE >= @Sdate
                        AND LOGIN_DATE <= @Fdate";

                dbc.Parameters.Clear();
                DataUtils.AddParameters(dbc, "Sdate", model.Sdate);
                DataUtils.AddParameters(dbc, "Fdate",
                    Convert.ToDateTime(model.Fdate).AddDays(1));

                using (SqlDataReader sda = dbc.ExecuteReader())
                {
                    if (sda.Read())
                    {
                        map.Add("member", DataUtils.GetDBInt(sda, 0));
                        map.Add("moica", DataUtils.GetDBInt(sda, 1));
                        map.Add("moeaca", DataUtils.GetDBInt(sda, 2));
                        map.Add("hca0", DataUtils.GetDBInt(sda, 3));
                        map.Add("hca1", DataUtils.GetDBInt(sda, 4));
                        map.Add("NEWEID", DataUtils.GetDBInt(sda, 5));
                    }
                    sda.Close();
                }
            }

            conn.Close();
        }
    }
    catch (Exception ex)
    {
        logger.Error("取得登入統計失敗", ex);
        throw;
    }

    return map;
}
```

**程式碼說明：**

1. **SUM 聚合**：使用 SUM 函數統計各登入方式的總次數
2. **多欄位統計**：一次查詢取得所有登入方式的統計
3. **Dictionary 回傳**：使用字典結構方便前端取值
4. **NULL 處理**：SUM 函數自動處理 NULL 值

## 3. 熱門申辦統計

### 3.1 熱門申辦查詢

```csharp
/// <summary>
/// 熱門申辦統計查詢頁面（GET）
/// </summary>
[HttpGet]
public ActionResult StatisticsHot()
{
    StatisticsHotModel model = new StatisticsHotModel();
    model.Sdate = DateTime.Now.ToString("yyyy/MM/dd");
    model.Fdate = DateTime.Now.ToString("yyyy/MM/dd");

    this.SetVisitRecord("Report", "StatisticsHot", "熱門申辦統計");

    return View(model);
}

/// <summary>
/// 熱門申辦統計查詢（POST）
/// </summary>
[HttpPost]
public ActionResult StatisticsHot(StatisticsHotModel model)
{
    ReportAction action = new ReportAction();
    ViewBag.List = action.GetHotReport(model);
    return View(model);
}
```

### 3.2 熱門申辦業務邏輯

```csharp
/// <summary>
/// 取得熱門申辦統計資料
/// 依申請數量排序，顯示最熱門的服務
/// </summary>
/// <param name="model">查詢條件模型</param>
/// <returns>統計結果列表</returns>
public List<HotServiceViewModel> GetHotReport(StatisticsHotModel model)
{
    List<HotServiceViewModel> list = new List<HotServiceViewModel>();

    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            string sql = @"
                SELECT TOP 20
                    S.SRV_ID,
                    S.NAME AS SRV_NAME,
                    U.NAME AS UNIT_NAME,
                    COUNT(A.APP_ID) AS APP_COUNT,
                    -- 計算百分比
                    CAST(COUNT(A.APP_ID) * 100.0 /
                        (SELECT COUNT(*) FROM APPLY
                         WHERE APPLY_DATE >= @Sdate
                           AND APPLY_DATE < @Fdate
                           AND DEL_MK = 'N')
                    AS DECIMAL(5,2)) AS PERCENTAGE
                FROM SERVICE S
                    INNER JOIN APPLY A ON S.SRV_ID = A.SRV_ID
                    LEFT JOIN UNIT U ON S.UNIT_CD = U.UNIT_CD
                WHERE A.APPLY_DATE >= @Sdate
                    AND A.APPLY_DATE < @Fdate
                    AND A.DEL_MK = 'N'
                GROUP BY S.SRV_ID, S.NAME, U.NAME
                ORDER BY APP_COUNT DESC";  // 依申請數量降冪排序

            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Sdate", model.Sdate);
                cmd.Parameters.AddWithValue("@Fdate",
                    Convert.ToDateTime(model.Fdate).AddDays(1));

                using (SqlDataReader reader = cmd.ExecuteReader())
                {
                    int rank = 1;
                    while (reader.Read())
                    {
                        HotServiceViewModel item = new HotServiceViewModel
                        {
                            RANK = rank++,  // 排名
                            SRV_ID = DataUtils.GetDBString(reader, "SRV_ID"),
                            SRV_NAME = DataUtils.GetDBString(reader, "SRV_NAME"),
                            UNIT_NAME = DataUtils.GetDBString(reader, "UNIT_NAME"),
                            APP_COUNT = DataUtils.GetDBInt(reader, "APP_COUNT"),
                            PERCENTAGE = DataUtils.GetDBDecimal(reader, "PERCENTAGE")
                        };
                        list.Add(item);
                    }
                }
            }

            conn.Close();
        }
    }
    catch (Exception ex)
    {
        logger.Error("取得熱門申辦統計失敗", ex);
        throw;
    }

    return list;
}
```

**程式碼說明：**

1. **TOP 20**：只取前 20 名最熱門的服務
2. **百分比計算**：使用子查詢計算各服務佔總申請數的百分比
3. **ORDER BY DESC**：依申請數量降冪排序
4. **排名處理**：在程式中加入排名欄位

## 4. Hangfire 背景排程系統

### 4.1 Hangfire 設定

**檔案位置：** `ES/Startup.cs`

#### 4.1.1 OWIN 啟動設定

```csharp
/// <summary>
/// OWIN 啟動類別
/// 設定 Hangfire 背景任務排程系統
/// </summary>
[assembly: OwinStartup(typeof(ES.Startup))]

namespace ES
{
    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            // 使用記憶體儲存（開發環境）
            // 生產環境建議使用 SQL Server 儲存
            GlobalConfiguration.Configuration.UseMemoryStorage();

            // 設定背景任務伺服器選項
            var options = new BackgroundJobServerOptions
            {
                ServerCheckInterval = TimeSpan.FromMinutes(20),      // 伺服器檢查間隔
                HeartbeatInterval = TimeSpan.FromMinutes(20),        // 心跳間隔
                CancellationCheckInterval = TimeSpan.FromMinutes(20) // 取消檢查間隔
            };
            app.UseHangfireServer(options);

            // 設定 Hangfire Dashboard（監控介面）
            app.UseHangfireDashboard("/EserviceHangFire",
                new DashboardOptions
                {
                    Authorization = new[] { new DashboardAccessAuthFilter() }
                });

            // 註冊定期執行的任務
            RegisterRecurringJobs();
        }

        /// <summary>
        /// 註冊定期執行的任務
        /// </summary>
        private void RegisterRecurringJobs()
        {
            // 醫審系統：案件上傳至 SFTP（每小時執行）
            MdodController Mdod = new MdodController();
            RecurringJob.AddOrUpdate(
                () => Mdod.CreateXML(),
                "0 * * * *",              // Cron 表達式：每小時的第 0 分鐘
                TimeZoneInfo.Local
            );

            // 我的 E 政府：API 管理案件（每天 21:00 執行）
            ESAPIController Esc = new ESAPIController();
            RecurringJob.AddOrUpdate(
                () => Esc.ScheService(),
                "0 21 * * *",             // Cron 表達式：每天 21:00
                TimeZoneInfo.Local
            );

            // 中醫藥司：3 天未補件發送通知（每天 01:00 執行）
            CaseController CaseC = new CaseController();
            RecurringJob.AddOrUpdate(
                () => CaseC.SendMailOverdue(),
                "0 1 * * *",              // Cron 表達式：每天 01:00
                TimeZoneInfo.Local
            );

            // 信用卡繳費：產生請款檔（每天 00:20 執行）
            PayECController payEC = new PayECController();
            RecurringJob.AddOrUpdate(
                () => payEC.RequestFileUploadSchedule(),
                "20 0 * * *",             // Cron 表達式：每天 00:20
                TimeZoneInfo.Local
            );

            // 信用卡繳費：處理請款回覆檔（每天 07:40 執行）
            RecurringJob.AddOrUpdate(
                () => payEC.ProcessRequestFileDownloadSchedule(),
                "40 7 * * *",             // Cron 表達式：每天 07:40
                TimeZoneInfo.Local
            );

            // 信用卡繳費：回寫資料表（每天 07:50 執行）
            RecurringJob.AddOrUpdate(
                () => payEC.ECFileReadLineSchedule(),
                "50 7 * * *",             // Cron 表達式：每天 07:50
                TimeZoneInfo.Local
            );
        }
    }
}
```

**程式碼說明：**

1. **記憶體儲存**：開發環境使用 MemoryStorage，生產環境建議使用 SQL Server
2. **Cron 表達式**：使用標準 Cron 格式設定執行時間
3. **時區設定**：使用 `TimeZoneInfo.Local` 確保使用本地時區
4. **Dashboard 授權**：使用自訂授權過濾器控制存取權限

### 4.2 Dashboard 授權過濾器

```csharp
/// <summary>
/// Hangfire Dashboard 授權過濾器
/// 控制誰可以存取 Hangfire 監控介面
/// </summary>
public class DashboardAccessAuthFilter : IDashboardAuthorizationFilter
{
    public bool Authorize(DashboardContext context)
    {
        // 取得客戶端 IP
        var clientIp = context.Request.RemoteIpAddress;
        var owinCtx = new OwinContext(context.GetOwinEnvironment());
        var ipAddr = owinCtx.Request.LocalIpAddress;
        var isLogin = false;

        // 本機存取（開發環境）
        if (ipAddr == "::1" || clientIp == "::1")
        {
            isLogin = true;
        }
        // IP 白名單檢查
        else if (!string.IsNullOrEmpty(ipAddr) || !string.IsNullOrEmpty(clientIp))
        {
            var hangs = DataUtils.GetConfig("HANGFIREIP");

            // 檢查 IP 是否在白名單中
            if (hangs.Contains(ipAddr) || hangs.Contains(clientIp))
            {
                isLogin = true;
            }
        }

        return isLogin;
    }
}
```

**程式碼說明：**

1. **IP 白名單**：只允許特定 IP 存取 Dashboard
2. **本機存取**：開發環境允許本機存取
3. **設定檔管理**：IP 白名單從設定檔讀取，便於維護

### 4.3 排程任務範例

#### 4.3.1 逾期未補件通知

**檔案位置：** `ES/Controllers/CaseController.cs`

```csharp
/// <summary>
/// 發送逾期未補件通知信
/// 每天凌晨 01:00 由 Hangfire 自動執行
/// </summary>
public void SendMailOverdue()
{
    try
    {
        logger.Info("開始執行逾期未補件通知排程");

        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            // 查詢 3 天前要求補件但尚未補件的案件
            string sql = @"
                SELECT
                    A.APP_ID,
                    A.SRV_ID,
                    S.NAME AS SRV_NAME,
                    A.NAME AS APPLICANT_NAME,
                    A.EMAIL,
                    AD.ACC_NO AS ADMIN_ACC_NO,
                    AD.NAME AS ADMIN_NAME,
                    AD.EMAIL AS ADMIN_EMAIL,
                    A.REMARK
                FROM APPLY A
                    INNER JOIN SERVICE S ON A.SRV_ID = S.SRV_ID
                    INNER JOIN ADMIN AD ON S.UNIT_CD = AD.UNIT_CD
                WHERE A.APP_STATUS = 'R'  -- 要求補件狀態
                    AND A.REMARK_DATE <= DATEADD(DAY, -3, GETDATE())
                    AND A.DEL_MK = 'N'
                    AND AD.DEL_MK = 'N'";

            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                using (SqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        string appId = DataUtils.GetDBString(reader, "APP_ID");
                        string adminEmail = DataUtils.GetDBString(reader, "ADMIN_EMAIL");
                        string adminName = DataUtils.GetDBString(reader, "ADMIN_NAME");
                        string srvName = DataUtils.GetDBString(reader, "SRV_NAME");

                        // 發送通知信給承辦人
                        SendOverdueNotification(appId, adminEmail, adminName, srvName);
                    }
                }
            }

            conn.Close();
        }

        logger.Info("逾期未補件通知排程執行完成");
    }
    catch (Exception ex)
    {
        logger.Error("逾期未補件通知排程執行失敗", ex);
    }
}

/// <summary>
/// 發送逾期通知信
/// </summary>
private void SendOverdueNotification(string appId, string email,
    string adminName, string srvName)
{
    try
    {
        string subject = $"【逾期未補件通知】{srvName} - {appId}";
        string body = $@"
            <html>
            <body>
                <p>{adminName} 您好：</p>
                <p>以下案件已逾期 3 天未補件，請協助追蹤處理：</p>
                <ul>
                    <li>案件編號：{appId}</li>
                    <li>服務名稱：{srvName}</li>
                </ul>
                <p>請登入系統查看詳細資訊。</p>
            </body>
            </html>";

        MailUtils.SendMail(email, subject, body);
        logger.Info($"已發送逾期通知信：{appId} -> {email}");
    }
    catch (Exception ex)
    {
        logger.Error($"發送逾期通知信失敗：{appId}", ex);
    }
}
```

**程式碼說明：**

1. **定期檢查**：每天凌晨 01:00 自動執行
2. **日期計算**：使用 `DATEADD(DAY, -3, GETDATE())` 查詢 3 天前的資料
3. **批次處理**：一次查詢所有逾期案件，逐一發送通知
4. **錯誤處理**：個別案件發送失敗不影響其他案件
5. **日誌記錄**：記錄執行過程與結果

## 5. 統計報表前端顯示

### 5.1 圖表顯示（使用 Chart.js）

**檔案位置：** `ES/Areas/BACKMIN/Views/Report/StatisticsLogin.cshtml`

```html
@model ES.Areas.Admin.Models.StatisticsLoginModel

<div class="container">
  <h2>登入統計</h2>

  <!-- 查詢條件 -->
  <form method="post">
    <div class="form-group">
      <label>開始日期：</label>
      <input type="text" name="Sdate" value="@Model.Sdate" class="datepicker" />
    </div>
    <div class="form-group">
      <label>結束日期：</label>
      <input type="text" name="Fdate" value="@Model.Fdate" class="datepicker" />
    </div>
    <button type="submit" class="btn btn-primary">查詢</button>
  </form>

  @if (ViewBag.Map != null) {
  <!-- 統計數據表格 -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>登入方式</th>
        <th>次數</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>一般會員</td>
        <td>@ViewBag.Map["member"]</td>
      </tr>
      <tr>
        <td>自然人憑證</td>
        <td>@ViewBag.Map["moica"]</td>
      </tr>
      <tr>
        <td>工商憑證</td>
        <td>@ViewBag.Map["moeaca"]</td>
      </tr>
      <tr>
        <td>醫事人員憑證</td>
        <td>@(ViewBag.Map["hca0"] + ViewBag.Map["hca1"])</td>
      </tr>
      <tr>
        <td>數位身分證</td>
        <td>@ViewBag.Map["NEWEID"]</td>
      </tr>
    </tbody>
  </table>

  <!-- 圓餅圖 -->
  <canvas id="loginChart" width="400" height="400"></canvas>

  <script>
    var ctx = document.getElementById('loginChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['一般會員', '自然人憑證', '工商憑證', '醫事人員憑證', '數位身分證'],
            datasets: [{
                data: [
                    @ViewBag.Map["member"],
                    @ViewBag.Map["moica"],
                    @ViewBag.Map["moeaca"],
                    @(ViewBag.Map["hca0"] + ViewBag.Map["hca1"]),
                    @ViewBag.Map["NEWEID"]
                ],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: '登入方式統計'
            }
        }
    });
  </script>
  }
</div>
```

**程式碼說明：**

1. **表格顯示**：使用 Bootstrap 表格顯示統計數據
2. **圓餅圖**：使用 Chart.js 繪製圓餅圖
3. **動態資料**：從 ViewBag 取得統計資料
4. **響應式設計**：圖表自動適應螢幕大小

## 6. 統計報表匯出

### 6.1 Excel 匯出功能

```csharp
/// <summary>
/// 匯出申辦統計為 Excel
/// </summary>
[HttpPost]
public ActionResult ExportCaseSum(CaseSumModel model)
{
    try
    {
        ReportAction action = new ReportAction();
        List<CaseSumViewModel> list = action.GetCaseSumReport(model);

        // 轉換為 DataTable
        DataTable dt = new DataTable();
        dt.Columns.Add("服務代碼");
        dt.Columns.Add("服務名稱");
        dt.Columns.Add("單位名稱");
        dt.Columns.Add("申請數量");

        foreach (var item in list)
        {
            DataRow row = dt.NewRow();
            row["服務代碼"] = item.SRV_ID;
            row["服務名稱"] = item.SRV_NAME;
            row["單位名稱"] = item.UNIT_NAME;
            row["申請數量"] = item.APP_COUNT;
            dt.Rows.Add(row);
        }

        // 產生 Excel
        string title = $"申辦統計報表 ({model.Sdate} ~ {model.Fdate})";
        MemoryStream ms = ReportUtils.RenderDataTableToExcel(dt, title);

        // 回傳檔案
        string fileName = $"申辦統計_{DateTime.Now:yyyyMMdd}.xls";
        return File(ms, "application/vnd.ms-excel", fileName);
    }
    catch (Exception ex)
    {
        logger.Error("匯出申辦統計失敗", ex);
        return Content("匯出失敗：" + ex.Message);
    }
}
```

## 7. 統計報表最佳實務

### 7.1 效能優化

```csharp
// 1. 使用索引加速查詢
// 在 APPLY 表的 APPLY_DATE 欄位建立索引
CREATE INDEX IX_APPLY_APPLY_DATE ON APPLY(APPLY_DATE)
WHERE DEL_MK = 'N';

// 2. 避免在 WHERE 子句中使用函數
// 不好的寫法
WHERE YEAR(APPLY_DATE) = 2024

// 好的寫法
WHERE APPLY_DATE >= '2024-01-01' AND APPLY_DATE < '2025-01-01'

// 3. 使用 WITH (NOLOCK) 避免鎖定（僅限查詢）
SELECT COUNT(*) FROM APPLY WITH (NOLOCK)
WHERE APPLY_DATE >= @Sdate
```

### 7.2 快取機制

```csharp
/// <summary>
/// 使用快取提升統計報表效能
/// </summary>
public List<CaseSumViewModel> GetCaseSumReportWithCache(CaseSumModel model)
{
    string cacheKey = $"CaseSum_{model.Sdate}_{model.Fdate}";

    // 嘗試從快取取得
    var cached = HttpRuntime.Cache[cacheKey] as List<CaseSumViewModel>;
    if (cached != null)
    {
        logger.Info($"從快取取得統計資料：{cacheKey}");
        return cached;
    }

    // 快取不存在，執行查詢
    var result = GetCaseSumReport(model);

    // 存入快取（10 分鐘）
    HttpRuntime.Cache.Insert(
        cacheKey,
        result,
        null,
        DateTime.Now.AddMinutes(10),
        Cache.NoSlidingExpiration
    );

    return result;
}
```

### 7.3 大量資料處理

```csharp
/// <summary>
/// 分批處理大量統計資料
/// </summary>
public void ExportLargeReport(DateTime startDate, DateTime endDate)
{
    int batchSize = 10000;
    int offset = 0;
    bool hasMore = true;

    while (hasMore)
    {
        string sql = @"
            SELECT *
            FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY APPLY_DATE) AS RowNum, *
                FROM APPLY
                WHERE APPLY_DATE >= @StartDate AND APPLY_DATE < @EndDate
            ) AS T
            WHERE RowNum > @Offset AND RowNum <= @Offset + @BatchSize";

        // 處理這批資料
        var batch = ExecuteQuery(sql, offset, batchSize);

        if (batch.Count < batchSize)
        {
            hasMore = false;
        }

        ProcessBatch(batch);
        offset += batchSize;
    }
}
```

## 8. 總結

e-service 系統的數據統計分析報表功能提供了完整的統計分析能力：

### 8.1 統計報表特色

- 多維度統計分析（申辦、登入、熱門、書表下載、繳費方式）
- 圖表視覺化呈現
- Excel 匯出功能
- 日期範圍查詢

### 8.2 Hangfire 排程特色

- 自動化背景任務
- Cron 表達式靈活排程
- Dashboard 監控介面
- 錯誤處理與重試機制

### 8.3 效能優化特色

- 資料庫索引優化
- 快取機制
- 分批處理大量資料
- 非同步處理

這套統計分析系統為管理者提供了完整的數據洞察能力，協助決策與系統優化。
