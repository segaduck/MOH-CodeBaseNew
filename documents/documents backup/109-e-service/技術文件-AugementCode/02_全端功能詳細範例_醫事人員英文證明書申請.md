# 衛福部人民線上申辦系統 - 全端功能詳細範例：醫事人員英文證明書申請

## 功能概述

本文以「醫事人員或公共衛生師請領英文證明書（001008）」為例，詳細說明從前端到後端的完整全端開發流程。此功能涵蓋了申請案件的建立、編輯、送審、繳費、報表產生等完整業務流程。

## 系統架構層次

```
前端 ASP.NET MVC Razor 視圖
    ↓ HTTP POST/GET 請求
後端 ASP.NET MVC Controller
    ↓ 業務邏輯處理
資料存取層 (DAO Layer)
    ↓ 資料庫操作
SQL Server 資料庫
```

## 1. 前端實作詳解

### 1.1 控制器結構

**檔案位置：** `ES/Controllers/Apply_001008Controller.cs`

#### 1.1.1 控制器基本結構

```csharp
/// <summary>
/// 醫事人員或公共衛生師請領英文證明書控制器
/// 繼承 BaseController 以獲得基礎功能（登入檢查、資料庫連線等）
/// </summary>
public class Apply_001008Controller : BaseController
{
    // 服務名稱常數
    public static string s_SRV_NAME = "醫事人員或公共衛生師請領英文證明書";

    /// <summary>
    /// 顯示警語畫面
    /// 在使用者進入申辦頁面前，必須先閱讀並同意說明事項
    /// </summary>
    [HttpGet]
    public ActionResult Prompt()
    {
        SessionModel sm = SessionModel.Get();
        Apply_001008FormModel model = new Apply_001008FormModel();

        string s_msg_1A = "請先閱讀 「{0}說明事項」點選同意後，再進入申辦頁面 !";
        sm.LastErrorMessage = string.Format(s_msg_1A, s_SRV_NAME);

        return View("Prompt001008", model);
    }

    /// <summary>
    /// 新申辦案件（空白表單填寫頁）
    /// </summary>
    /// <param name="agree">是否同意說明事項（1=同意）</param>
    [DisplayName("Apply_001008_申請")]
    [HttpGet]
    public ActionResult Apply(string agree)
    {
        SessionModel sm = SessionModel.Get();
        Apply_001008FormModel model = new Apply_001008FormModel();
        ActionResult rtn = View("Index", model);

        // 設定申請日期為當前日期
        model.APPLY_DATE = Commons.HelperUtil.DateTimeToString(DateTime.Now);
        model.FlowMode = "1";  // 流程模式：1=填寫申報表件

        // 檢查使用者是否已登入
        if (sm == null || sm.UserInfo == null)
        {
            rtn = RedirectToAction("Index", "Login");
            return rtn;
        }

        var UsIn = sm.UserInfo.Member;

        if (UsIn != null)
        {
            // 檢查是否同意說明事項
            if (string.IsNullOrEmpty(agree)) { agree = "0"; }
            if (agree != null && !agree.Equals("1"))
            {
                return Prompt();  // 未同意則顯示警語畫面
            }

            // 帶入會員基本資料
            ShareDAO dao = new ShareDAO();
            model.ACC_NO = UsIn.ACC_NO;
            model.SRV_ID = "001008";
            model.SRC_SRV_ID = "001008";
            model.UNIT_CD = dao.GetServiceUnitCD(model.SRV_ID);

            model.NAME = UsIn.NAME;
            model.IDN = UsIn.IDN;
            model.ENAME = UsIn.ENAME;
            model.TEL = UsIn.TEL;
            model.MOBILE = UsIn.MOBILE;
            model.EMAIL = UsIn.MAIL;

            // 處理地址資訊
            TblZIPCODE zip = new TblZIPCODE();
            zip.ZIP_CO = sm.UserInfo.Member.TOWN_CD;
            var address = dao.GetRow(zip);

            model.ADDR_ZIP = sm.UserInfo.Member.TOWN_CD;
            if (address != null && !string.IsNullOrEmpty(address.TOWNNM))
            {
                model.ADDR_ZIP_ADDR = address.TOWNNM;
                model.ADDR_ZIP_DETAIL = sm.UserInfo.Member.ADDR
                    .TONotNullString()
                    .Replace(address.CITYNM + address.TOWNNM, "");
            }
            else
            {
                model.ADDR_ZIP_ADDR = string.Empty;
                model.ADDR_ZIP_DETAIL = sm.UserInfo.Member.ADDR;
            }

            // 初始化申請筆數
            model.RowCount = 1;
            model.MERGEYN = "N";
        }
        else
        {
            rtn = RedirectToAction("Index", "Login");
        }

        return rtn;
    }
}
```

**程式碼說明：**

1. **繼承 BaseController**：取得基礎功能如登入檢查、資料庫連線等
2. **Session 管理**：透過 `SessionModel.Get()` 取得使用者登入資訊
3. **同意機制**：使用者必須先同意說明事項才能進入申辦頁面
4. **資料預填**：自動帶入會員基本資料，減少使用者輸入負擔
5. **地址處理**：透過郵遞區號查詢完整地址資訊

### 1.2 資料模型定義

**檔案位置：** `ES/Models/ViewModels/Apply_001008ViewModel.cs`

#### 1.2.1 表單模型結構

```csharp
/// <summary>
/// 醫事人員英文證明書申請表單模型
/// 包含主表單資料和多個動態 Grid 子表單
/// </summary>
public class Apply_001008FormModel : Apply_001008Model
{
    public Apply_001008FormModel()
    {
        // 醫事人員資料 Grid
        ME = new GoodsDynamicGrid<Apply_001008_MeViewModel>();
        ME.APP_ID = this.APP_ID;
        ME.model = new Apply_001008_MeViewModel();
        ME.GetGoodsList();
        ME.SourceModelName = "ME";
        ME.IsReadOnly = false;
        ME.IsNewOpen = true;
        ME.IsDeleteOpen = true;

        // 專門人員資料 Grid
        PR = new GoodsDynamicGrid<Apply_001008_PrViewModel>();
        PR.APP_ID = this.APP_ID;
        PR.model = new Apply_001008_PrViewModel();
        PR.GetGoodsList();
        PR.SourceModelName = "PR";
        PR.IsReadOnly = false;
        PR.IsNewOpen = true;
        PR.IsDeleteOpen = true;

        // 國內轉入資料 Grid
        TRANS = new GoodsDynamicGrid<Apply_001008_TransViewModel>();
        TRANS.APP_ID = this.APP_ID;
        TRANS.model = new Apply_001008_TransViewModel();
        TRANS.GetGoodsList();
        TRANS.SourceModelName = "TRANS";
        TRANS.IsReadOnly = false;
        TRANS.IsNewOpen = true;
        TRANS.IsDeleteOpen = true;

        // 國外轉入資料 Grid
        TRANSF = new GoodsDynamicGrid<Apply_001008_TransFViewModel>();
        TRANSF.APP_ID = this.APP_ID;
        TRANSF.model = new Apply_001008_TransFViewModel();
        TRANSF.GetGoodsList();
        TRANSF.SourceModelName = "TRANSF";
        TRANSF.IsReadOnly = false;
        TRANSF.IsNewOpen = true;
        TRANSF.IsDeleteOpen = true;

        this.IsNew = true;
    }

    // 動態 Grid 屬性
    public GoodsDynamicGrid<Apply_001008_MeViewModel> ME { get; set; }
    public GoodsDynamicGrid<Apply_001008_PrViewModel> PR { get; set; }
    public GoodsDynamicGrid<Apply_001008_TransViewModel> TRANS { get; set; }
    public GoodsDynamicGrid<Apply_001008_TransFViewModel> TRANSF { get; set; }

    // 流程控制屬性
    public string FlowMode { get; set; }  // 1=填寫 2=預覽 3=繳費 4=完成
    public bool IsNew { get; set; }
    public int RowCount { get; set; }
    public string MERGEYN { get; set; }
}
```

**程式碼說明：**

1. **動態 Grid 設計**：使用 `GoodsDynamicGrid<T>` 泛型類別處理多筆明細資料
2. **多表單結構**：一個主表單包含多個子表單（醫事人員、專門人員、轉入資料等）
3. **權限控制**：透過 `IsReadOnly`、`IsNewOpen`、`IsDeleteOpen` 控制 Grid 的操作權限
4. **資料綁定**：每個 Grid 都有對應的 ViewModel 和資料來源

### 1.3 核心業務邏輯

#### 1.3.1 儲存草稿功能

```csharp
/// <summary>
/// 儲存草稿
/// 將使用者填寫的資料暫存到資料庫，但不送審
/// </summary>
[HttpPost]
public ActionResult SaveDraft(Apply_001008FormModel model)
{
    SessionModel sm = SessionModel.Get();
    JsonResultModel result = new JsonResultModel();

    try
    {
        // 驗證模型資料
        if (!ModelState.IsValid)
        {
            result.status = false;
            result.message = "資料驗證失敗，請檢查輸入內容";
            return Content(result.Serialize(), "application/json");
        }

        // 取得資料存取物件
        ApplyDAO dao = new ApplyDAO();

        // 設定案件狀態為草稿
        model.APP_STATUS = "D";  // D=草稿
        model.ACC_NO = sm.UserInfo.Member.ACC_NO;

        // 儲存主表單資料
        string APP_ID = dao.SaveApply_001008(model);

        if (!string.IsNullOrEmpty(APP_ID))
        {
            // 儲存子表單資料
            dao.SaveApply_001008_Me(model.ME.GoodsList, APP_ID);
            dao.SaveApply_001008_Pr(model.PR.GoodsList, APP_ID);
            dao.SaveApply_001008_Trans(model.TRANS.GoodsList, APP_ID);
            dao.SaveApply_001008_TransF(model.TRANSF.GoodsList, APP_ID);

            result.status = true;
            result.message = "草稿儲存成功";
            result.data = APP_ID;
        }
        else
        {
            result.status = false;
            result.message = "草稿儲存失敗";
        }
    }
    catch (Exception ex)
    {
        logger.Error("儲存草稿失敗", ex);
        result.status = false;
        result.message = "系統錯誤：" + ex.Message;
    }

    return Content(result.Serialize(), "application/json");
}
```

**程式碼說明：**

1. **模型驗證**：使用 `ModelState.IsValid` 檢查資料完整性
2. **狀態管理**：草稿狀態設為 "D"，送審後會改為其他狀態
3. **交易處理**：先儲存主表單，成功後再儲存子表單
4. **錯誤處理**：使用 try-catch 捕捉異常並記錄日誌
5. **JSON 回應**：統一使用 JSON 格式回傳結果

#### 1.3.2 送出申請功能

```csharp
/// <summary>
/// 送出申請
/// 將草稿送審，並進行繳費流程
/// </summary>
[HttpPost]
public ActionResult Submit(Apply_001008FormModel model)
{
    SessionModel sm = SessionModel.Get();
    JsonResultModel result = new JsonResultModel();

    try
    {
        ApplyDAO dao = new ApplyDAO();

        // 檢查案件是否存在
        var apply = dao.GetApply_001008(model.APP_ID);
        if (apply == null)
        {
            result.status = false;
            result.message = "案件不存在";
            return Content(result.Serialize(), "application/json");
        }

        // 檢查案件狀態
        if (apply.APP_STATUS != "D")
        {
            result.status = false;
            result.message = "只有草稿狀態的案件才能送出";
            return Content(result.Serialize(), "application/json");
        }

        // 更新案件狀態為待審核
        apply.APP_STATUS = "P";  // P=待審核
        apply.APPLY_DATE = DateTime.Now;
        dao.UpdateApply_001008(apply);

        // 產生申請書
        string pdfPath = GenerateApplicationForm(model.APP_ID);

        // 發送通知郵件
        SendNotificationEmail(apply, sm.UserInfo.Member);

        result.status = true;
        result.message = "申請已送出，案件編號：" + model.APP_ID;
        result.data = new { APP_ID = model.APP_ID, PDF_PATH = pdfPath };
    }
    catch (Exception ex)
    {
        logger.Error("送出申請失敗", ex);
        result.status = false;
        result.message = "系統錯誤：" + ex.Message;
    }

    return Content(result.Serialize(), "application/json");
}
```

**程式碼說明：**

1. **狀態檢查**：確保只有草稿狀態的案件才能送出
2. **狀態更新**：送出後將狀態改為待審核（P）
3. **報表產生**：自動產生 PDF 格式的申請書
4. **通知機制**：發送郵件通知申請人和承辦人
5. **回傳資訊**：包含案件編號和 PDF 路徑供前端使用

## 2. 後端資料存取層實作

### 2.1 DAO 層結構

**檔案位置：** `ES/DataLayers/ApplyDAO.cs`

#### 2.1.1 儲存申請案件主檔

```csharp
/// <summary>
/// 儲存 001008 申請案件主檔
/// </summary>
/// <param name="model">申請表單模型</param>
/// <returns>案件編號</returns>
public string SaveApply_001008(Apply_001008FormModel model)
{
    string APP_ID = string.Empty;

    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            // 檢查是否為新增或更新
            if (string.IsNullOrEmpty(model.APP_ID))
            {
                // 新增案件：產生案件編號
                APP_ID = GenerateAppId("001008");
                model.APP_ID = APP_ID;

                string sql = @"
                    INSERT INTO APPLY (
                        APP_ID, SRV_ID, SRC_SRV_ID, UNIT_CD, ACC_NO,
                        IDN, NAME, ENAME, TEL, MOBILE, EMAIL,
                        ADDR_ZIP, ADDR_ZIP_ADDR, ADDR_ZIP_DETAIL,
                        APP_STATUS, APPLY_DATE, CRE_TIME, CRE_FUN_CD
                    ) VALUES (
                        @APP_ID, @SRV_ID, @SRC_SRV_ID, @UNIT_CD, @ACC_NO,
                        @IDN, @NAME, @ENAME, @TEL, @MOBILE, @EMAIL,
                        @ADDR_ZIP, @ADDR_ZIP_ADDR, @ADDR_ZIP_DETAIL,
                        @APP_STATUS, @APPLY_DATE, GETDATE(), '001008'
                    )";

                SqlCommand cmd = new SqlCommand(sql, conn);
                AddParameters(cmd, model);
                cmd.ExecuteNonQuery();
            }
            else
            {
                // 更新案件
                APP_ID = model.APP_ID;

                string sql = @"
                    UPDATE APPLY SET
                        NAME = @NAME, ENAME = @ENAME,
                        TEL = @TEL, MOBILE = @MOBILE, EMAIL = @EMAIL,
                        ADDR_ZIP = @ADDR_ZIP,
                        ADDR_ZIP_ADDR = @ADDR_ZIP_ADDR,
                        ADDR_ZIP_DETAIL = @ADDR_ZIP_DETAIL,
                        APP_STATUS = @APP_STATUS,
                        UPD_TIME = GETDATE(),
                        UPD_FUN_CD = '001008'
                    WHERE APP_ID = @APP_ID";

                SqlCommand cmd = new SqlCommand(sql, conn);
                AddParameters(cmd, model);
                cmd.ExecuteNonQuery();
            }

            conn.Close();
        }
    }
    catch (Exception ex)
    {
        logger.Error("儲存申請案件失敗", ex);
        throw;
    }

    return APP_ID;
}
```

**程式碼說明：**

1. **新增/更新判斷**：根據 APP_ID 是否為空判斷是新增或更新
2. **案件編號產生**：新增時自動產生唯一的案件編號
3. **參數化查詢**：使用 SqlParameter 防止 SQL Injection
4. **審計欄位**：記錄建立時間、更新時間、操作功能代碼
5. **交易管理**：使用 using 確保連線正確關閉

#### 2.1.2 儲存子表單資料（醫事人員資料）

```csharp
/// <summary>
/// 儲存醫事人員資料明細
/// </summary>
/// <param name="list">醫事人員資料清單</param>
/// <param name="APP_ID">案件編號</param>
public void SaveApply_001008_Me(List<Apply_001008_MeViewModel> list, string APP_ID)
{
    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            conn.Open();

            // 先刪除舊資料
            string deleteSql = "DELETE FROM Apply_001008_Me WHERE APP_ID = @APP_ID";
            SqlCommand deleteCmd = new SqlCommand(deleteSql, conn);
            deleteCmd.Parameters.AddWithValue("@APP_ID", APP_ID);
            deleteCmd.ExecuteNonQuery();

            // 新增資料
            foreach (var item in list)
            {
                string insertSql = @"
                    INSERT INTO Apply_001008_Me (
                        APP_ID, ITEM, ME_TYPE, ME_NO, ME_NAME,
                        ME_ENAME, ME_DATE, ME_PLACE, CRE_TIME
                    ) VALUES (
                        @APP_ID, @ITEM, @ME_TYPE, @ME_NO, @ME_NAME,
                        @ME_ENAME, @ME_DATE, @ME_PLACE, GETDATE()
                    )";

                SqlCommand cmd = new SqlCommand(insertSql, conn);
                cmd.Parameters.AddWithValue("@APP_ID", APP_ID);
                cmd.Parameters.AddWithValue("@ITEM", item.ITEM);
                cmd.Parameters.AddWithValue("@ME_TYPE", item.ME_TYPE ?? "");
                cmd.Parameters.AddWithValue("@ME_NO", item.ME_NO ?? "");
                cmd.Parameters.AddWithValue("@ME_NAME", item.ME_NAME ?? "");
                cmd.Parameters.AddWithValue("@ME_ENAME", item.ME_ENAME ?? "");
                cmd.Parameters.AddWithValue("@ME_DATE", item.ME_DATE ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@ME_PLACE", item.ME_PLACE ?? "");
                cmd.ExecuteNonQuery();
            }

            conn.Close();
        }
    }
    catch (Exception ex)
    {
        logger.Error("儲存醫事人員資料失敗", ex);
        throw;
    }
}
```

**程式碼說明：**

1. **先刪後增策略**：先刪除該案件的所有明細，再重新新增
2. **批次處理**：使用迴圈處理多筆明細資料
3. **NULL 處理**：使用 `??` 運算子和 `DBNull.Value` 處理空值
4. **序號管理**：使用 ITEM 欄位記錄明細序號

### 2.2 使用 Dapper 進行複雜查詢

#### 2.2.1 查詢案件列表

```csharp
/// <summary>
/// 查詢使用者的申請案件列表
/// 使用 Dapper 進行高效能查詢
/// </summary>
/// <param name="ACC_NO">會員帳號</param>
/// <param name="SRV_ID">服務代碼</param>
/// <returns>案件列表</returns>
public List<ApplyViewModel> GetApplyList(string ACC_NO, string SRV_ID)
{
    List<ApplyViewModel> result = new List<ApplyViewModel>();

    try
    {
        using (SqlConnection conn = DataUtils.GetConnection())
        {
            string sql = @"
                SELECT
                    A.APP_ID, A.SRV_ID, A.APP_STATUS,
                    A.NAME, A.APPLY_DATE, A.CRE_TIME,
                    S.NAME AS SRV_NAME,
                    C.CODE_DESC AS STATUS_NAME
                FROM APPLY A
                    INNER JOIN SERVICE S ON A.SRV_ID = S.SRV_ID
                    LEFT JOIN CODE_CD C ON C.CODE_KIND = 'APP_STATUS'
                        AND C.CODE_CD = A.APP_STATUS
                WHERE A.ACC_NO = @ACC_NO
                    AND A.SRV_ID = @SRV_ID
                    AND A.DEL_MK = 'N'
                ORDER BY A.CRE_TIME DESC";

            var parameters = new DynamicParameters();
            parameters.Add("@ACC_NO", ACC_NO);
            parameters.Add("@SRV_ID", SRV_ID);

            result = conn.Query<ApplyViewModel>(sql, parameters).ToList();
        }
    }
    catch (Exception ex)
    {
        logger.Error("查詢案件列表失敗", ex);
        throw;
    }

    return result;
}
```

**程式碼說明：**

1. **Dapper 查詢**：使用 Dapper 的 `Query<T>` 方法自動映射結果
2. **多表關聯**：JOIN SERVICE 和 CODE_CD 取得服務名稱和狀態名稱
3. **動態參數**：使用 `DynamicParameters` 管理查詢參數
4. **效能優化**：Dapper 比 Entity Framework 更適合複雜查詢

## 3. 報表產製系統

### 3.1 Word 模板套表

#### 3.1.1 產生申請書 PDF

```csharp
/// <summary>
/// 產生申請書 PDF
/// 使用 DocX 處理 Word 模板，再轉換為 PDF
/// </summary>
/// <param name="APP_ID">案件編號</param>
/// <returns>PDF 檔案路徑</returns>
private string GenerateApplicationForm(string APP_ID)
{
    string pdfPath = string.Empty;

    try
    {
        // 取得案件資料
        ApplyDAO dao = new ApplyDAO();
        var apply = dao.GetApply_001008(APP_ID);
        var meList = dao.GetApply_001008_MeList(APP_ID);

        // 載入 Word 模板
        string templatePath = Server.MapPath("~/Sample/apply001008.docx");
        string tempPath = Server.MapPath("~/Temp/");
        string fileName = APP_ID + "_" + DateTime.Now.ToString("yyyyMMddHHmmss");
        string docxPath = tempPath + fileName + ".docx";
        pdfPath = tempPath + fileName + ".pdf";

        using (DocX doc = DocX.Load(templatePath))
        {
            // 替換主表單欄位
            doc.ReplaceText("$APP_ID$", apply.APP_ID);
            doc.ReplaceText("$NAME$", apply.NAME);
            doc.ReplaceText("$ENAME$", apply.ENAME);
            doc.ReplaceText("$IDN$", apply.IDN);
            doc.ReplaceText("$TEL$", apply.TEL);
            doc.ReplaceText("$EMAIL$", apply.EMAIL);
            doc.ReplaceText("$ADDR$", apply.ADDR_ZIP_ADDR + apply.ADDR_ZIP_DETAIL);

            // 處理日期格式（民國年）
            if (apply.APPLY_DATE.HasValue)
            {
                string twDate = Commons.HelperUtil.TransAdToTwYear(
                    apply.APPLY_DATE.Value.ToString("yyyy/MM/dd"));
                doc.ReplaceText("$APPLY_DATE$", twDate);
            }

            // 處理醫事人員資料表格
            if (meList != null && meList.Count > 0)
            {
                var table = doc.Tables[0];  // 假設第一個表格是醫事人員資料

                for (int i = 0; i < meList.Count; i++)
                {
                    var row = table.InsertRow();
                    row.Cells[0].Paragraphs[0].Append((i + 1).ToString());
                    row.Cells[1].Paragraphs[0].Append(meList[i].ME_TYPE);
                    row.Cells[2].Paragraphs[0].Append(meList[i].ME_NO);
                    row.Cells[3].Paragraphs[0].Append(meList[i].ME_NAME);
                    row.Cells[4].Paragraphs[0].Append(meList[i].ME_ENAME);
                }
            }

            // 儲存 Word 檔案
            doc.SaveAs(docxPath);
        }

        // 使用 Spire.Doc 轉換為 PDF
        Spire.Doc.Document document = new Spire.Doc.Document();
        document.LoadFromFile(docxPath);
        document.SaveToFile(pdfPath, Spire.Doc.FileFormat.PDF);

        // 刪除暫存的 Word 檔案
        if (System.IO.File.Exists(docxPath))
        {
            System.IO.File.Delete(docxPath);
        }
    }
    catch (Exception ex)
    {
        logger.Error("產生申請書失敗", ex);
        throw;
    }

    return pdfPath;
}
```

**程式碼說明：**

1. **模板處理**：使用 DocX 載入 Word 模板並替換佔位符
2. **動態表格**：根據資料筆數動態新增表格列
3. **日期轉換**：將西元年轉換為民國年格式
4. **PDF 轉換**：使用 Spire.Doc 將 Word 轉換為 PDF
5. **暫存清理**：轉換完成後刪除暫存的 Word 檔案

### 3.2 Excel 報表匯出

#### 3.2.1 匯出案件清單

```csharp
/// <summary>
/// 匯出案件清單為 Excel
/// 使用 NPOI 產生 Excel 檔案
/// </summary>
[HttpPost]
public ActionResult ExportExcel(string startDate, string endDate)
{
    try
    {
        ApplyDAO dao = new ApplyDAO();
        var list = dao.GetApplyListByDate("001008", startDate, endDate);

        // 建立 DataTable
        DataTable dt = new DataTable();
        dt.Columns.Add("案件編號");
        dt.Columns.Add("申請人姓名");
        dt.Columns.Add("身分證號");
        dt.Columns.Add("申請日期");
        dt.Columns.Add("案件狀態");

        foreach (var item in list)
        {
            DataRow row = dt.NewRow();
            row["案件編號"] = item.APP_ID;
            row["申請人姓名"] = item.NAME;
            row["身分證號"] = item.IDN;
            row["申請日期"] = item.APPLY_DATE?.ToString("yyyy/MM/dd");
            row["案件狀態"] = item.STATUS_NAME;
            dt.Rows.Add(row);
        }

        // 使用 ReportUtils 產生 Excel
        MemoryStream ms = ReportUtils.RenderDataTableToExcel(dt, "案件清單");

        return File(ms, "application/vnd.ms-excel",
            "案件清單_" + DateTime.Now.ToString("yyyyMMdd") + ".xls");
    }
    catch (Exception ex)
    {
        logger.Error("匯出 Excel 失敗", ex);
        return Content("匯出失敗：" + ex.Message);
    }
}
```

**程式碼說明：**

1. **DataTable 建構**：將查詢結果轉換為 DataTable
2. **NPOI 處理**：使用 ReportUtils 封裝的 NPOI 功能產生 Excel
3. **檔案下載**：使用 File() 方法回傳檔案供下載
4. **檔名處理**：加上日期時間避免檔名重複

## 4. 完整資料流程圖

```
申辦流程：

1. 使用者登入系統
   ↓
2. 選擇「醫事人員英文證明書」服務
   ↓
3. 閱讀並同意說明事項
   ↓
4. 填寫申請表單
   - 系統自動帶入會員基本資料
   - 填寫醫事人員資料
   - 填寫專門人員資料
   - 填寫轉入資料
   ↓
5. 儲存草稿（可選）
   - 資料暫存到資料庫
   - 狀態設為 "D"（草稿）
   ↓
6. 預覽申請內容
   ↓
7. 送出申請
   - 更新狀態為 "P"（待審核）
   - 產生申請書 PDF
   - 發送通知郵件
   ↓
8. 線上繳費（如需要）
   - 導向信用卡繳費頁面
   - 完成繳費後更新狀態
   ↓
9. 等待審核
   - 承辦人員審查
   - 可能需要補件
   ↓
10. 審核完成
    - 核准：核發證書
    - 退件：通知原因
```

## 5. 安全性機制

### 5.1 登入檢查

```csharp
/// <summary>
/// BaseController 中的登入檢查機制
/// 所有繼承 BaseController 的控制器都會自動檢查登入狀態
/// </summary>
protected override void OnActionExecuting(ActionExecutingContext filterContext)
{
    // 檢查是否已登入
    if (!Request.IsAuthenticated)
    {
        filterContext.Result = RedirectToAction("Index", "Login");
        return;
    }

    // 檢查 Session 是否有效
    SessionModel sm = SessionModel.Get();
    if (sm == null || sm.UserInfo == null)
    {
        filterContext.Result = RedirectToAction("Index", "Login");
        return;
    }

    base.OnActionExecuting(filterContext);
}
```

### 5.2 SQL Injection 防護

```csharp
// 使用參數化查詢防止 SQL Injection
SqlCommand cmd = new SqlCommand(sql, conn);
cmd.Parameters.AddWithValue("@APP_ID", APP_ID);
cmd.Parameters.AddWithValue("@ACC_NO", ACC_NO);
cmd.ExecuteNonQuery();

// 或使用 Dapper 的參數化查詢
var parameters = new DynamicParameters();
parameters.Add("@APP_ID", APP_ID);
var result = conn.Query<T>(sql, parameters);
```

### 5.3 檔案上傳安全檢查

```csharp
/// <summary>
/// 檔案上傳安全檢查
/// </summary>
private bool ValidateUploadFile(HttpPostedFileBase file)
{
    // 檢查檔案大小（限制 10MB）
    if (file.ContentLength > 10 * 1024 * 1024)
    {
        return false;
    }

    // 檢查檔案類型
    string[] allowedExtensions = { ".pdf", ".jpg", ".jpeg", ".png", ".doc", ".docx" };
    string extension = Path.GetExtension(file.FileName).ToLower();

    if (!allowedExtensions.Contains(extension))
    {
        return false;
    }

    return true;
}
```

## 6. 錯誤處理與日誌

### 6.1 全域錯誤處理

```csharp
// Global.asax.cs 中的錯誤處理
protected void Application_Error(object sender, EventArgs e)
{
    Exception objErr = Server.GetLastError();
    string err = "Application_Error event:\n"
        + "Error in: " + Request.Url.ToString()
        + "\nError Message:" + objErr.Message.ToString();

    logger.Error(err, objErr);

    // 非本機環境顯示友善錯誤頁面
    if (!Request.IsLocal)
    {
        Server.ClearError();
        Response.StatusCode = 404;
        Response.End();
    }
}
```

### 6.2 操作日誌記錄

```csharp
/// <summary>
/// 記錄操作日誌
/// </summary>
private void LogOperation(string action, string APP_ID, string result)
{
    try
    {
        SessionModel sm = SessionModel.Get();

        string logMessage = string.Format(
            "使用者：{0}，操作：{1}，案件編號：{2}，結果：{3}",
            sm.UserInfo.Member.ACC_NO,
            action,
            APP_ID,
            result
        );

        logger.Info(logMessage);
    }
    catch (Exception ex)
    {
        logger.Error("記錄操作日誌失敗", ex);
    }
}
```

## 7. 總結

這個範例展示了完整的全端開發流程：

### 7.1 前端特色

- MVC 架構清晰分離關注點
- 動態 Grid 處理複雜表單
- 多步驟流程控制
- 友善的使用者體驗

### 7.2 後端特色

- DAO 模式封裝資料存取
- Entity Framework 和 Dapper 混合使用
- 完整的交易處理
- 統一的錯誤處理

### 7.3 安全性特色

- 登入狀態檢查
- SQL Injection 防護
- 檔案上傳安全檢查
- 操作日誌記錄

### 7.4 報表特色

- Word 模板套表
- PDF 自動產生
- Excel 報表匯出
- 多種文件格式支援

這個功能為團隊提供了完整的開發參考範本，涵蓋了政府線上申辦系統的核心功能與最佳實務。
