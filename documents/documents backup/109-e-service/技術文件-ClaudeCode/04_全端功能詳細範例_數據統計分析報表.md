# 數據統計分析報表全端範例（年度趨勢與類型分布）

## 功能概述
- 後台首頁（Areas/BACKMIN/Views/Main/Index.cshtml:1）整合待辦、公告與可視化儀表板，協助承辦掌握年度案件趨勢與申辦類型占比。
- 儀表板使用 D3.js 在前端渲染長條圖與圓餅圖，資料由控制器注入的 JSON 字串驅動（Areas/BACKMIN/Views/Main/Index.cshtml:46）。
- CaseSearch 與 CaseSearchDetail 提供互動式查詢，可依時間區間檢視各月份通報量並查看明細名單（Areas/BACKMIN/Views/Main/CaseSearch.cshtml:17）。

## 後端資料流程
- MainController.Index 取得使用者資訊後呼叫 BackApplyDAO 生成 barChartData、pieChartData，並寫入模型供 View 使用（Areas/BACKMIN/Controllers/MainController.cs:65）。
- GetBarChartData 以年度為條件計算 12 個月份的案件數量，依 UNIT_CD 決定是否篩選單位，最後序列化為 JSON（DataLayers/BackApplyDAO.cs:2071）。
- GetPieChartData 彙整年度內各服務類別的案件數量，並標記 ONLINE_N_MK 為啟用的服務，作為圓餅圖資料來源（DataLayers/BackApplyDAO.cs:2263）。
- CaseSearchQuery 使用 BackApplyDAO.GetCaseList 依民國年月與單位統計筆數；CaseSearchDetail 則呼叫 GetCaseDetailList 取得申請人、案件狀態與服務名稱等欄位（Areas/BACKMIN/Controllers/MainController.cs:101；DataLayers/BackApplyDAO.cs:2346）。

## 前端視覺化實作
- 頁面引用 d3.v6.min.js 並在 DOM Ready 後執行 barChart 與 pieChart 函式，解析隱藏欄位中的 JSON 字串（Areas/BACKMIN/Views/Main/Index.cshtml:46）。
- HiddenFor 標籤儲存 barChartData 與 pieChartData，避免頁面載入時再次呼叫伺服器（Areas/BACKMIN/Views/Main/Index.cshtml:116）。
- 長條圖顯示年度線上申辦情形，以月份為 X 軸、案件數為 Y 軸；圓餅圖呈現線上申辦類型分布，搭配 tooltip 顯示服務名稱與比率。
- CaseSearch 使用民國日期輸入元件 DatePickerTW，查詢結果以表格呈現並提供「看明細」連結跳轉至 CaseSearchDetail（Areas/BACKMIN/Views/Main/CaseSearch.cshtml:21）。
- CaseSearchDetail 提供遮罩開關 myonoffswitch，預設將身分證與姓名局部隱藏，兼顧資訊安全；切換時以 jQuery 在畫面上還原資料（Areas/BACKMIN/Views/Main/CaseSearchDetail.cshtml:31）。

## 資料結構與模型
- MainModel 定義 barChartData、pieChartData、CaseList 與 VisitRecords 等屬性，集中儀表板與統計查詢的輸出來源（Areas/BACKMIN/Models/MainModel.cs:18）。
- BackApplyDAO 產出的 JSON 將欄位名稱 STAT_MONTH、CASE_COUNT 置換成 name、value，方便前端繪圖函式直接消費（Areas/BACKMIN/Controllers/MainController.cs:68）。
- CaseSearch 與 CaseSearchDetail 使用 DataTable 與 DataRow 直接繪製表格；若未來需要 API，可包裝成 DTO 再由前端框架使用。

## 安全考量
- CaseSearchDetail 的遮罩機制僅在前端顯示上處理，但後端仍提供完整資料給授權人員下載（Areas/BACKMIN/Views/Main/CaseSearchDetail.cshtml:59）。
- MainController 標註 [Authorize(Roles = "Admin")]，限制只有 Admin 角色能查看統計報表，避免未授權者掌握全量數據（Areas/BACKMIN/Controllers/MainController.cs:17）。
- 所有統計查詢皆過濾 DEL_MK='N'，確保只計入有效案件，避免刪除資料干擾分析（DataLayers/BackApplyDAO.cs:2108）。

## 擴充與維運建議
- 若需新增其他圖表，可在 BackApplyDAO 擴充統計方法並於 View 增加對應的 D3 繪圖邏輯，建議集中在單一 JS 模組維護。
- 當需要比較跨年度資料，可將目前的年度常數改為參數或表單欄位，並在前端增加年份切換元件。
- 建議建立排程將統計結果快取至資料表或 Redis，於高峰期減少即時計算的 SQL 負載。
- 若需匯出統計結果，可結合 ReportUtils 產出 Excel 或 CSV，延伸現有匯出流程（Utils/ReportUtils.cs:769）。
