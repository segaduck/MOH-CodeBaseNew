# 衛福部線上申辦系統 - 系統安全防護與稽核設計

## 輸入防護措施
- Global.asax.Application_BeginRequest 會攔截未經授權的靜態資源請求並強制轉址至 HTTPS，降低目錄探勘與中間人攻擊風險（Global.asax.cs:28）。
- SecurityHelper 提供 Injection 檢查，覆蓋 QueryString、Form、Cookie 參數，並針對常見 SQL/XSS/LDAP 攻擊建立正則黑名單（Commons/SecurityHelper.cs:31）。
- ShareDAO.checkApply 等共用驗證針對身份證、電話、Email 與附件格式進行正則檢查，避免不合法資料寫入（DataLayers/SHAREDAO.cs:108）。

## 驗證與授權
- BaseController.OnActionExecuting 確保未登入使用者無法呼叫受保護控制器，若 Session 缺失便導向登入頁（Controllers/BaseController.cs:139）。
- FormsAuthenticationTicket 儲存角色資訊，於 Application_AuthenticateRequest 解析後建立 GenericPrincipal 供 [Authorize] 屬性判斷（Global.asax.cs:85）。
- BACKMIN Area 控制器僅授權 Admin 角色使用，前後台完全隔離，降低權限提升風險（Areas/BACKMIN/Controllers/MainController.cs:17）。

## 錯誤處理與稽核
- CustomHandleErrorAttribute 擴充 MVC 預設錯誤處理，記錄完整錯誤訊息並在逾時時建立 reset.okgo 供運維偵測（Filter/CustomHandleErrorAttribute.cs:14）。
- Global.asax.Application_Error 會將錯誤 URL、例外訊息寫入 log4net，非本機環境則回傳 404 以避免洩漏堆疊資訊（Global.asax.cs:102）。
- LoginController 與 BACKMIN/LoginController 皆將登入結果寫入 LOGIN_LOG，記錄時間、IP 與狀態，供事後稽核（Controllers/LoginController.cs:170；Areas/BACKMIN/Controllers/LoginController.cs:78）。

## Cookie 與傳輸安全
- Application_EndRequest 將所有回應 Cookie 標記為 Secure 與 HttpOnly，避免被前端腳本讀取（Global.asax.cs:165）。
- 站台預設強制 HTTPS，若接收到 HTTP 請求會重新導向，確保認證與金流資料不以明文傳輸（Global.asax.cs:51）。
- Hangfire 儀表板以 DashboardAccessAuthFilter 限制來源 IP，防止未授權人員操作排程（Startup.cs:36）。

## 設定與敏感資料
- DataUtils.GetConfig 於伺服器端快取設定，避免頻繁存取資料庫，同時可集中控管密碼或 FTP 參數（Utils/DataUtils.cs:13）。
- PayUtils 與 DataUtils.GetPayAccount 會讀取加密帳密後於記憶體使用，程式碼中不留明文帳號（Utils/DataUtils.cs:115；Utils/PayUtils.cs:34）。
- FTP、金流與 API 密碼建議定期更新並搭配 ClearConfig 重新載入快取，確保環境設定一致。

## 日誌與監控
- 系統全面採 log4net 記錄操作，包括排程、金流、登入與錯誤，維運可透過不同 Logger Channel 分析（Startup.cs:24；Areas/Schedule/Controllers/ESAPIController.cs:61）。
- CaseController.SendMailOverdue、PayEC 排程等會將執行結果寫入排程日誌，便於確認批次是否成功（Areas/BACKMIN/Controllers/CaseController.cs:699；Areas/BACKMIN/Controllers/PayECController.cs:445）。
- MAIL_LOG 記錄所有寄信結果，包含補件與服務信箱訊息，可作為客服查詢與稽核依據（DataLayers/ApplyDAO.cs:111）。

## 維護建議
- 定期檢視 log4net 日誌與 LOGIN_LOG，掌握是否有異常登入或大量錯誤。
- 於 Web.config 開啟自訂錯誤頁面，並搭配 CustomHandleErrorAttribute，確保例外資訊不暴露給使用者。
- 安排資安掃描後可依需求調整 SecurityHelper 黑名單或新增特定過濾邏輯，維持防護強度。
