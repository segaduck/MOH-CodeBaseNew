# 產銷證明書（SRV_ID 005001）申請案件管理全端範例

## 功能需求與流程摘要
- 申請人登入後需完成「產銷證明書」線上填報、預覽、繳費與完成確認四個步驟（Views/Apply_005001/Index.cshtml:20）。
- 表單需支援藥品許可證資料自動帶入、外銷名檢核、附件上傳與金額即時計算，並於送出後寄發收件通知（Controllers/Apply_005001Controller.cs:374）。
- 承辦端（BACKMIN）可在 CaseController 中依 SRV_ID=005001 查閱案件、補件並進行後續審查（Areas/BACKMIN/Controllers/CaseController.cs:640）。

## 前端頁面與互動
- 導覽頁面 `Index.cshtml` 採多分頁步驟 UI，分別載入填報、預覽、繳費與完成的 Partial View（Views/Apply_005001/Index.cshtml:28）。
- 申辦主表單 `Apply.cshtml` 透過 Html Helper 與自訂元件呈現必填欄位、付款計算與動態欄位控制（Views/Apply_005001/Apply.cshtml:12）。
- JavaScript 事件在載入時綁定日期、郵遞區號查詢、自動帶入與計價邏輯，並可透過 `search()` 呼叫後端取得 GMP 資料（Views/Apply_005001/Index.cshtml:45）。
- 預覽畫面 `PreView005001.cshtml` 將表單轉為唯讀模式，搭配 `Form.DI.IsReadOnly` 等旗標防止再次修改（Controllers/Apply_005001Controller.cs:363）。

## 後端控制器流程
- GET `Apply`：檢查 Session 與同意條件，預填申請時間、預設費用與預覽旗標（Controllers/Apply_005001Controller.cs:41）。
- POST `Apply(Apply_005001FormModel form)`：執行 ModelState 驗證與多組 Regex 檢核，回傳 AjaxResultStruct 供前端顯示錯誤（Controllers/Apply_005001Controller.cs:72）。
- POST `PreView`：將表單切換預覽模式、暫存附件並回傳預覽頁面（Controllers/Apply_005001Controller.cs:360）。
- POST `Save`：呼叫 ApplyDAO.AppendApply005001 建立案件與子表，寄送收件通知後顯示完成頁面（Controllers/Apply_005001Controller.cs:374）。

## 資料存取與交易
- `AppendApply005001` 先產生 APP_ID，再於交易內寫入 APPLY 主檔、APPLY_005001 子表與繳費資料（DataLayers/ApplyDAO.cs:9096）。
- APPLY 主檔會紀錄登入帳號、付款資訊、申請時間與流程節點等欄位（DataLayers/ApplyDAO.cs:9110）。
- 子表 `Apply_005001Model` 保存證照、製造廠、劑型與附件資訊，並依旗標決定是否保留外銷名與濃縮比例欄位（DataLayers/ApplyDAO.cs:9153）。
- 交易成功後建立 APPLY_PAY、APPLY_NOTICE 等相關資料並觸發郵件通知；失敗時記錄 log 並回滾（DataLayers/ApplyDAO.cs:9199）。

## 重要模型與驗證
- ViewModel `Apply_005001FormModel` 匯集所有欄位、附件與旗標，並內建 DI/PC 子集合供多列輸入（Models/ViewModels/Apply_005001FormModel.cs:1）。
- 共用驗證 `ShareDAO.checkApply` 檢查身份證、電話、Email 等，讓所有服務共享一致規則（DataLayers/SHAREDAO.cs:108）。
- 控制器使用多個 Regex 驗證英文、數字與結尾符號，確保輸入符合藥證填寫標準（Controllers/Apply_005001Controller.cs:132）。

## 外部服務整合
- 前端 `search()` 透過 Ajax 呼叫 `Ajax/GetCityTownZip` 與後端服務取得製造廠資料，並將結果回填至表單欄位（Views/Apply_005001/Index.cshtml:72）。
- `FlyPayController` 支援線上付款與匯款查詢，申請完成後可導流至金流頁面繳納規費（Controllers/FlyPayController.cs:35）。
- AppendApply 後會寄送提醒信件給申請人，內容包含繳費與寄件注意事項（Controllers/Apply_005001Controller.cs:381）。

## 後台與補件流程
- CaseController 可依案件編號導向 `Apply_005001` 後台控制器，承辦人可進行補件、審核與文件下載（Areas/BACKMIN/Controllers/CaseController.cs:646）。
- BackApplyDAO 取得補件狀態並提供逾期寄信功能，確保申請人按時補正資料（Areas/BACKMIN/Controllers/CaseController.cs:699）。
- 補件完成後承辦可使用 FormRptController 套印申請書與相關表件（Controllers/FormRptController.cs:30）。

## 測試與維運建議
- 自動化測試可涵蓋：表單必填驗證、Ajax 自動帶入、預覽模式、交易成功/失敗回滾與郵件內容。
- 建議定期檢視 LOG（log4net）、MAIL_LOG 與 Hangfire 排程結果，以掌握案件匯出與補件通知是否正常。
- 若新增相似服務，可複製此控制器與 DAO 方法，並調整 SRV_ID、欄位驗證與郵件模板，以降低開發成本。

