# 衛福部線上申辦系統 - 金流與捐款整合流程

## 金流架構概述
- 系統支援超商條碼、郵局條碼、虛擬帳號與信用卡等多種繳費方式，核心邏輯集中於 PayUtils（Utils/PayUtils.cs:16）。
- 金流資料表包含 PAY_ACCOUNT、PAY_SERIAL、PAY_STORE_SERIAL 等，對應 DAO 為 PayDAO 與 BackApplyDAO。
- 前台繳費流程透過 ApplyDAO、PayDAO 與 CommonsServices 串接，後台由 PayECController 與 CaseController 管理對帳與請款。

## 虛擬帳號與條碼產生
- PayUtils.GetVirtualAccount 依衛福部識別碼與金額產生檢核碼，確保虛擬帳號唯一且可於銀行端驗證（Utils/PayUtils.cs:34）。
- GetStore 與 GetPost 提供超商與郵局條碼字串，包含檢核位與金額資訊，後續可輸出至繳費單或 PDF（Utils/PayUtils.cs:74）。
- 報表或繳費單可透過 ReportUtils 將條碼與案件資料輸出成 Excel 或 PDF（Utils/ReportUtils.cs:769）。

## 前台金流流程
- FlyPayController 提供防疫旅館繳費入口，支援查詢、訂單建立與玉山銀行信用卡付款（Controllers/FlyPayController.cs:35）。
- 控制器會記錄登入者 IP、檢查護照與生日資訊，並依是否為試營運設定不同的銀行參數（Controllers/FlyPayController.cs:120）。
- PayFileULController 允許申請人上傳繳費憑證，系統會驗證登入身分並寄送通知給承辦人（Controllers/PayFileULController.cs:13）。

## 後台請款與對帳
- PayECController.RequestFileUploadSchedule 每日產出聯合信用中心請款檔，並呼叫批次程式上傳（Areas/BACKMIN/Controllers/PayECController.cs:372）。
- 回覆檔透過 ProcessRequestFileDownloadSchedule 下載，再由 ECFileReadLineSchedule 解析並回寫資料庫狀態（Areas/BACKMIN/Controllers/PayECController.cs:494）。
- CaseController 搭配 BackApplyDAO 查詢案件付款狀態與補件情況，必要時更新流程節點（Areas/BACKMIN/Controllers/CaseController.cs:360；DataLayers/BackApplyDAO.cs:214）。

## 捐款與特殊專案
- ApplyDonateController 與 ApplyDonateDAO 處理捐款流程，包含專案清單、金額設定與感謝信寄送（Controllers/ApplyDonateController.cs:1；DataLayers/ApplyDonateDAO.cs:1）。
- FlyPayAction 支援防疫旅館與專案房型費用計算，並記錄入住人數以計算應繳金額（Controllers/FlyPayController.cs:169）。
- 專案繳費資訊可透過 ServiceAction 或 BackApplyDAO 匯出，供主管機關統計使用（Areas/BACKMIN/Controllers/ReportController.cs:1）。

## 安全與稽核
- 所有金流流程皆透過 DataUtils.GetPayAccount 取得加密帳密，避免將敏感資訊寫死於程式碼（Utils/DataUtils.cs:115）。
- 金流操作與批次執行皆寫入 log4net，遇到錯誤時可追蹤執行的檔案名稱與參數（Areas/BACKMIN/Controllers/PayECController.cs:445）。
- 前台上傳檔案會檢查大小與格式，防止惡意上傳或覆寫其他案件的付款記錄（Controllers/PayFileULController.cs:36）。

## 維運建議
- 定期檢查銀行或聯合信用中心提供的批次程式與連線參數是否過期，必要時更新 SETUP 值。
- 建議建立監控機制，確認每日請款與回覆流程是否成功執行，可透過 Hangfire 儀表板或日誌分析。
- 金流資料屬敏感資訊，資料庫備份與權限應採最小化原則，並記錄所有異動歷程以配合稽核。
