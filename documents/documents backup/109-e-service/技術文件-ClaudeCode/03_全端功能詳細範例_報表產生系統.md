# 報表產生系統全端範例（PDF/Word/Excel 匯出）

## 功能概要
- 後台承辦可在 FormRptController 產出 PDF 申請書、套印 Word 公文及匯出其他附件，提供審查與歸檔（Controllers/FormRptController.cs:30）。
- DocumentExportController 提供批次匯出與 SFTP 上傳介面，集中處理尚未匯出的中醫藥司公文（Areas/BACKMIN/Controllers/DocumentExportController.cs:26）。
- ReportUtils 與 DocumentUtils 為報表核心工具，負責 Excel 報表與壓縮檔處理（Utils/ReportUtils.cs:769；Utils/DocumentUtils.cs:45）。

## 控制器與流程
- FormRptController 依 SRV_ID 呼叫不同 FormAction，取得資料後以 PDF 或 Word 形式輸出（Controllers/FormRptController.cs:30）。
- `Apply001005`/`Apply001007` 等動作會開啟資料庫連線、透過 Form001005Action.GetData 取得欄位並使用 iTextSharp 套入樣版（Controllers/FormRptController.cs:56）。
- `Apply001009` 使用 DocX 模板，載入 Word 檔後以 ValueInjecter 填入欄位並透過 HttpResponse 下載（Controllers/FormRptController.cs:143）。
- DocumentExportController.Index 顯示下載路徑、郵件設定與待匯出數量，並記錄存取足跡（Areas/BACKMIN/Controllers/DocumentExportController.cs:28）。
- Export 動作呼叫 Schedule 內的 DocSftpController.Export，以確保批次邏輯與排程共用（Areas/BACKMIN/Controllers/DocumentExportController.cs:54）。

## FormAction 與樣版
- Form001005Action 於 `GetData` 中透過 SQL JOIN 取得 APPLY 與 APPLY_005001 欄位，並轉換成 Dictionary（Action/Form/Form001005Action.cs:28）。
- `GetApplyPDF` 讀取 Sample 目錄下的 PDF 樣版，使用 iTextSharp 將欄位寫入指定座標並回傳檔案串流（Action/Form/Form001005Action.cs:56）。
- 針對多筆資料（例如成分列表）採用 ColumnText 與動態表格輸出，確保欄位自動換行（Action/Form/Form001005Action.cs:140）。
- 若需 Word 或 Excel 輸出，可參考其他 FormAction（如 Form005001Action.GetApplyWord）搭配 DocumentUtils 轉換成 docx 或 xlsx（Areas/BACKMIN/Controllers/DocumentExportController.cs:111）。

## 工具層設計
- DocumentUtils 讀取 `DOWNLOAD_DOCUMENT_PATH` 設定，提供圖片、Word、XML 與壓縮檔下載方法（Utils/DocumentUtils.cs:18）。
- `GetDI_ZIP` 會將申請書、附件與 DI 檔案打包成 Zip，常用於中醫藥司公文匯出（Utils/DocumentUtils.cs:180）。
- ReportUtils 的 `RenderDataTableToExcelPayEC` 可將資料表格式化為 Excel，含標題樣式與欄寬設定（Utils/ReportUtils.cs:769）。
- 共用工具使用 log4net 記錄異常，失敗時會保留檔案路徑與錯誤訊息便於除錯（Utils/DocumentUtils.cs:37）。

## 資料來源與 DAO
- DocumentExportAction 取得尚未匯出的案件、附件路徑與公文編號，並在匯出成功後更新 FLAG（Areas/BACKMIN/Controllers/DocumentExportController.cs:32）。
- BackApplyDAO 提供追加的案件資料與附件查詢，供 FormAction 套印時使用（DataLayers/BackApplyDAO.cs:32）。
- ApplyDAO、ShareDAO 則提供案件主檔與附件資訊，確保套印與匯出使用的資料與前台一致（DataLayers/ApplyDAO.cs:9096）。

## 前端與使用者介面
- FormRptController 導出的 PDF/Word 透過 `return File` 回傳，瀏覽器會直接下載檔案；若需 inline 預覽可調整 Content-Disposition（Controllers/FormRptController.cs:44）。
- BACKMIN 匯出頁面會顯示待匯出件數、下載路徑與歷史訊息，並利用 TempData 顯示成功或錯誤結果（Areas/BACKMIN/Controllers/DocumentExportController.cs:33）。
- 若需前台提供申請人下載，可將相同 FormAction 封裝為 API 並控制授權。

## 排程與批次整合
- Schedule/DocSftpController 及 MdodController 會定時將匯出檔案上傳 SFTP，挂帳於 Hangfire 中執行（Areas/Schedule/Controllers/DocSftpController.cs:1；Startup.cs:42）。
- 排程使用 isLock 旗標避免重入，並於 log4net 中記錄執行結果與檔案名稱（Areas/Schedule/Controllers/MdodController.cs:42）。
- 若匯出失敗，DocumentExportController 可手動重試，並透過 TempData 提示失敗原因。

## 測試與維運建議
- 測試應涵蓋：資料庫假資料、PDF/Word 內容正確性、附件多筆輸出與 Zip 案件解壓是否完整。
- 建議在 UAT 伺服器安裝樣版字型（如標楷體）並確認路徑權限，避免 iTextSharp 無法寫入（Action/Form/Form001005Action.cs:64）。
- 監控 Hangfire 儀表板與排程日誌，確保每日匯出數量與 SFTP 傳輸成功，必要時可自動寄送結果摘要。

