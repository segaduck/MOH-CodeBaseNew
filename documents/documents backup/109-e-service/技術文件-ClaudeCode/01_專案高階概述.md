# 衛福部線上申辦系統 - 專案高階概述

## 專案概述
- 本專案為衛生福利部人民線上申辦平台，提供民眾與承辦人處理申請、查詢與金流等作業（參見 Views/Shared/_Layout.cshtml:10）。
- 前台採 ASP.NET MVC 4.0 搭配 Razor View 與 jQuery，後台則以 Area 分區提供承辦人作業（參見 Areas/BACKMIN/Controllers/MainController.cs:17）。
- 系統核心以 .NET Framework 4.8 為基礎，整合 Hangfire 排程、Dapper 資料存取與多種檔案/報表元件（參見 ES.csproj:16 與 packages.config:5）。

### 系統主要功能
- **申請案件受理與表單驗證**：每個服務代碼對應獨立控制器與檢核流程，例如藥政「產銷證明書」流程（Controllers/Apply_005001Controller.cs:29）。
- **會員與憑證登入**：支援自然人憑證/工商憑證/醫事憑證等登入流程並記錄操作軌跡（Controllers/LoginController.cs:65）。
- **後台案件審查與統計**：行政 Area 內含案件查詢、統計圖表與權限控管（Areas/BACKMIN/Controllers/MainController.cs:65）。
- **跨機關資料交換**：排程將案件資料產製 XML 並透過 FTP 上傳至外部系統（Areas/Schedule/Controllers/MdodController.cs:50）。
- **金流與繳費**：整合超商條碼、郵局條碼與玉山金流，提供案件繳費與慈善捐款（Utils/PayUtils.cs:19 與 Areas/BACKMIN/Controllers/PayECController.cs:372）。

## 專案結構
- **Controllers**：前台入口控制器，含登入、申請與檔案下載等流程，並以 BaseController 定義共用驗證（Controllers/BaseController.cs:17）。
- **Areas**：以 BACKMIN、Schedule 等 Area 區隔後台與排程 API（Areas/BACKMIN/Controllers/MainController.cs:17；Areas/Schedule/Controllers/ESAPIController.cs:19）。
- **Action 與 DataLayers**：Action 封裝商業邏輯，DAO 透過 Dapper/ADO.NET 操作資料庫，例如 ApplyDAO 管理申辦流程（DataLayers/ApplyDAO.cs:58）。
- **Models 與 ViewModels**：集中資料模型與 ViewModel 包含 SessionModel、Entities 與後台輸出格式（Models/SessionModel.cs:15）。
- **Utils 與 Commons**：提供設定、檔案、排程、安全檢核等工具程式（Utils/DataUtils.cs:13；Commons/SecurityHelper.cs:17）。
- **Views**：Razor View 呈現使用者介面與共用版面（Views/Shared/_Layout.cshtml:1）。

## 核心設定與啟動流程
- Global.asax 啟動 MVC、WebApi、路由、Bundling 並強制 HTTP 轉 HTTPS（Global.asax.cs:67 與 Global.asax.cs:51）。
- Application_AuthenticateRequest 萃取 FormsAuthentication 角色資訊供整體授權判斷（Global.asax.cs:85）。
- Startup 透過 OWIN 啟動 Hangfire Server 與儀表板，並排程多項背景工作（Startup.cs:24）。
- Application_EndRequest 將所有回傳 Cookie 標記為 Secure/HttpOnly 確保安全（Global.asax.cs:165）。

## 技術棧與相依
- .NET Framework 4.8 / ASP.NET MVC 4（ES.csproj:16）。
- Dapper、Entity Framework、Hangfire、DocX、iTextSharp、NPOI、GemBox、log4net 等元件（packages.config:5、packages.config:14、packages.config:20、packages.config:57）。
- OWIN、Microsoft.Owin.Host.SystemWeb 與 JWT/Jose 支援排程與 API 驗章（ES.csproj:152；packages.config:26）。
- 前端採 jQuery、Bootstrap 5、FontAwesome 與 Knockout.js（packages.config:4、packages.config:11、packages.config:27）。

## 執行環境需求
- Windows Server + IIS 搭配 .NET Framework 4.8 執行網站模組（ES.csproj:18）。
- 需配置 SQL Server 資料庫與帳號密碼供 DataUtils 讀取連線字串（Utils/DataUtils.cs:25）。
- 排程服務需設定 Hangfire 儀表板允許的來源 IP（Startup.cs:95）。
- 前端建議安裝 Node.js 供靜態資源編譯/管理（packages.config:4）。

## 部署重點
- 設定 Web.config 連線字串與 appSettings 供 DataUtils 快取系統參數（Utils/DataUtils.cs:33）。
- 確認 IIS 強制 HTTPS 或依 Global.asax 轉址設定，避免回圈轉址（Global.asax.cs:51）。
- 需安排 Windows 工作排程或常駐服務啟動網站以維持 Hangfire 背景工作執行（Startup.cs:24）。
- 若使用資料檔輸出/FTP，需配置 DOWNLOAD_DOCUMENT_PATH 與 SFTP 帳號密碼（Utils/DocumentUtils.cs:18；Areas/Schedule/Controllers/MdodController.cs:61）。

## 架構特色
- **前後台分區**：以 Area 隔離民眾與承辦人功能，搭配自訂權限過濾器（Areas/BACKMIN/Controllers/MainController.cs:17）。
- **表單驅動設計**：每個服務代碼對應專屬控制器、ViewModel 與檢核邏輯（Controllers/Apply_005001Controller.cs:29；DataLayers/SHAREDAO.cs:108）。
- **排程整合**：Hangfire 結合排程控制器處理 API 上稿、FTP、金流請款與逾期通知（Startup.cs:42；Areas/BACKMIN/Controllers/CaseController.cs:699；Areas/Schedule/Controllers/ESAPIController.cs:24）。
- **安全防護**：應用程式層提供注入偵測與錯誤處理記錄，同時鎖定 Cookie 與強制 HTTPS（Commons/SecurityHelper.cs:31；Global.asax.cs:102）。
