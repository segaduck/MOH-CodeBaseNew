# æª”æ¡ˆä¸Šå‚³å®‰å…¨æ€§æ”¹å–„è¨ˆç•«

> **å»ºç«‹æ—¥æœŸ**: 2025-12-06  
> **ç‹€æ…‹**: è¦åŠƒä¸­  
> **ç›®çš„**: é˜²ç¯„ Webshell ä¸Šå‚³æ”»æ“Šï¼Œå…¨é¢å¼·åŒ–æª”æ¡ˆä¸Šå‚³åŠŸèƒ½çš„å®‰å…¨æ€§  
> **åƒè€ƒæ–‡ä»¶**: `H08S11401103_1.è¡›ç”Ÿç¦åˆ©éƒ¨è³‡å®‰äº‹ä»¶èª¿æŸ¥å ±å‘Š-EECPD_Webshell_1141030.pdf`

---

## ä¸€ã€èƒŒæ™¯èªªæ˜

### 1.1 å•é¡Œæè¿°

æ ¹æ“šè³‡å®‰äº‹ä»¶èª¿æŸ¥å ±å‘Šï¼Œç³»çµ±å­˜åœ¨ Webshell ä¸Šå‚³é¢¨éšªã€‚ç¶“éå…¨é¢åˆ†æï¼Œç™¼ç¾ç³»çµ±ä¸­å…±æœ‰ **6 å€‹æª”æ¡ˆä¸Šå‚³ç«¯é»**ï¼Œå­˜åœ¨ä»¥ä¸‹å®‰å…¨å¼±é»ï¼š

| å¼±é»é¡å‹ | é¢¨éšªç­‰ç´š | å—å½±éŸ¿ç«¯é»æ•¸ |
|---------|:--------:|:----------:|
| ç¼ºä¹ MIME é¡å‹é©—è­‰ | ğŸ”´ é«˜ | 6/6 (100%) |
| ç¼ºä¹æª”æ¡ˆå…§å®¹é©—è­‰ï¼ˆMagic Bytesï¼‰ | ğŸ”´ é«˜ | 6/6 (100%) |
| é†«é™¢ API ç„¡æª”æ¡ˆé¡å‹é™åˆ¶ | ğŸ”´ é«˜ | 3/6 (50%) |
| ç¼ºä¹ CSRF ä¿è­· | ğŸŸ  ä¸­ | 1/6 (17%) |
| ç¼ºä¹ç—…æ¯’æƒæ | ğŸŸ  ä¸­ | 6/6 (100%) |
| å®¢æˆ¶ç«¯é©—è­‰å¯ç¹é | ğŸŸ¡ ä½ | éƒ¨åˆ†å…ƒä»¶ |

### 1.2 å—å½±éŸ¿çš„æª”æ¡ˆä¸Šå‚³ç«¯é»æ¸…å–®

| # | ç«¯é» | æ§åˆ¶å™¨ | æª”æ¡ˆè·¯å¾‘ | æ¥å—é¡å‹ | å„²å­˜ä½ç½® |
|:-:|------|--------|----------|---------|---------|
| 1 | `UploadFile` | AjaxController | `Controllers/AjaxController.cs:110` | 20ç¨®æ–‡ä»¶æ ¼å¼ | è‡¨æ™‚è³‡æ–™å¤¾ |
| 2 | `SaveUpload` | A2/C102MController | `Areas/A2/Controllers/C102MController.cs:72` | 6ç¨®åœ–ç‰‡/PDF | è³‡æ–™åº«(Base64) |
| 3 | `ImportDat_Go` | A3/C101MController | `Areas/A3/Controllers/C101MController.cs:267` | .rsp æª”æ¡ˆ | `~/Uploads/RSP_Files/` |
| 4 | `Api_A2_2` | AjaxController | `Controllers/AjaxController.cs:370` | **ä¸é™** (Base64) | é†«é™¢è·¯å¾‘ |
| 5 | `Api_A2_2_csh` | AjaxController | `Controllers/AjaxController.cs:518` | **ä¸é™** (Base64) | é†«é™¢è·¯å¾‘ |
| 6 | `Api_A2_2_cmuh` | AjaxController | `Controllers/AjaxController.cs:666` | **ä¸é™** (Base64) | é†«é™¢è·¯å¾‘ |

**å…±ç”¨å·¥å…·æ–¹æ³•** (ç„¡å…§å»ºé©—è­‰):
- `SHAREDAO.PutFile()` at `DataLayers/SHAREDAO.cs:108, 157`

---

## äºŒã€æ”¹å–„ç­–ç•¥èˆ‡éšæ®µè¦åŠƒ

### ç¸½é«”ç­–ç•¥ï¼šåˆ†éšæ®µæ¼¸é€²å¼æ”¹å–„

```
Phase 1 (ç·Šæ€¥)     Phase 2 (é‡è¦)     Phase 3 (å¼·åŒ–)     Phase 4 (æœ€ä½³åŒ–)
   åŸºç¤é©—è­‰    â†’    é˜²ç¦¦åŠ å›º      â†’    ç›£æ§å¯©è¨ˆ      â†’     é•·æœŸç¶­è­·
  [1-2 é€±]         [2-3 é€±]          [1-2 é€±]           [æŒçºŒé€²è¡Œ]
```

---

## ä¸‰ã€Phase 1: åŸºç¤é©—è­‰å¼·åŒ–ï¼ˆç·Šæ€¥ï¼Œ1-2 é€±ï¼‰

> **ç›®æ¨™**: ç«‹å³é˜»æ­¢æœ€å¸¸è¦‹çš„ Webshell ä¸Šå‚³æ”»æ“Šæ‰‹æ³•  
> **å„ªå…ˆç´š**: ğŸ”´ æœ€é«˜

### 3.1 å»ºç«‹é›†ä¸­å¼æª”æ¡ˆé©—è­‰å·¥å…·é¡

#### 3.1.1 å»ºç«‹ FileSecurityHelper.cs

**æª”æ¡ˆè·¯å¾‘**: `trunk/Commons/FileSecurityHelper.cs` (æ–°å¢)

**åŠŸèƒ½éœ€æ±‚**:

| æ–¹æ³• | åŠŸèƒ½ | èªªæ˜ |
|------|------|------|
| `ValidateFileExtension()` | å‰¯æª”åç™½åå–®é©—è­‰ | å¤§å°å¯«ä¸æ•æ„Ÿï¼Œé˜²æ­¢é›™é‡å‰¯æª”å |
| `ValidateFileMimeType()` | MIME é¡å‹é©—è­‰ | æª¢æŸ¥ Content-Type Header |
| `ValidateFileMagicBytes()` | æª”æ¡ˆé ­é©—è­‰ï¼ˆMagic Bytesï¼‰ | è®€å–æª”æ¡ˆå‰ 20 bytes é©—è­‰çœŸå¯¦é¡å‹ |
| `ValidateFileSize()` | æª”æ¡ˆå¤§å°é™åˆ¶ | å¯è¨­å®šæœ€å¤§ / æœ€å°å€¼ |
| `SanitizeFileName()` | æª”æ¡ˆåç¨±æ¸…ç† | ç§»é™¤ç‰¹æ®Šå­—å…ƒã€è·¯å¾‘ç©¿è¶Šå­—å…ƒ |
| `GenerateSecureFileName()` | å®‰å…¨æª”åç”Ÿæˆ | GUID + æ™‚é–“æˆ³ + å‰¯æª”å |
| `IsBlacklistedExtension()` | å±éšªå‰¯æª”åæª¢æ¸¬ | é»‘åå–®: .aspx, .ashx, .asmx, .cer, .config, .exe, .dll, .bat, .cmd, .ps1, .vbs |

**Magic Bytes å°ç…§è¡¨** (ç¯„ä¾‹):

```csharp
private static readonly Dictionary<string, byte[][]> MagicBytesMap = new Dictionary<string, byte[][]>
{
    { ".pdf", new[] { new byte[] { 0x25, 0x50, 0x44, 0x46 } } }, // %PDF
    { ".jpg", new[] { 
        new byte[] { 0xFF, 0xD8, 0xFF, 0xE0 },  // JFIF
        new byte[] { 0xFF, 0xD8, 0xFF, 0xE1 }   // Exif
    }},
    { ".png", new[] { new byte[] { 0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A } } },
    { ".gif", new[] { 
        new byte[] { 0x47, 0x49, 0x46, 0x38, 0x37, 0x61 },  // GIF87a
        new byte[] { 0x47, 0x49, 0x46, 0x38, 0x39, 0x61 }   // GIF89a
    }},
    { ".bmp", new[] { new byte[] { 0x42, 0x4D } } },
    { ".xlsx", new[] { new byte[] { 0x50, 0x4B, 0x03, 0x04 } } },  // ZIP based
    { ".docx", new[] { new byte[] { 0x50, 0x4B, 0x03, 0x04 } } },  // ZIP based
    // ... å…¶ä»–æ ¼å¼
};
```

#### 3.1.2 å»ºç«‹ FileUploadResult è¿”å›é¡å‹

```csharp
public class FileUploadValidationResult
{
    public bool IsValid { get; set; }
    public string ErrorMessage { get; set; }
    public List<string> ValidationErrors { get; set; }
    public string SafeFileName { get; set; }
    public string DetectedMimeType { get; set; }
}
```

### 3.2 ä¿®æ”¹ç¾æœ‰ä¸Šå‚³ç«¯é»ï¼ˆåŠ å…¥é©—è­‰ï¼‰

#### 3.2.1 AjaxController.UploadFile() å¼·åŒ–

**æª”æ¡ˆè·¯å¾‘**: `trunk/Controllers/AjaxController.cs`  
**è¡Œè™Ÿ**: 110-189

**ä¿®æ”¹å…§å®¹**:

```csharp
[HttpPost]
[ValidateAntiForgeryToken]  // âœ… æ–°å¢ CSRF ä¿è­·
public ActionResult UploadFile(DynamicEFileGrid Upload)
{
    SessionModel sm = SessionModel.Get();
    
    if (Request.Files.AllKeys.Any())
    {
        var httpPostedFile = Request.Files[0];
        
        // âœ… ä½¿ç”¨æ–°çš„é›†ä¸­å¼é©—è­‰
        var validationResult = FileSecurityHelper.ValidateUploadedFile(
            httpPostedFile,
            allowedExtensions: Upload.GetAcceptFileTypes().Select(t => t.Extension).ToList(),
            maxSizeBytes: 10485760  // 10MB
        );
        
        if (!validationResult.IsValid)
        {
            Upload.ErrorMsg = validationResult.ErrorMessage;
            return PartialView("DynamicEFileGrid", Upload);
        }
        
        // âœ… ä½¿ç”¨å®‰å…¨çš„æª”å
        string safeFileName = validationResult.SafeFileName;
        
        // ... å…¶é¤˜å„²å­˜é‚è¼¯
    }
}
```

**è®Šæ›´æ‘˜è¦**:
- âœ… æ–°å¢ `[ValidateAntiForgeryToken]` å±¬æ€§
- âœ… èª¿ç”¨ `FileSecurityHelper.ValidateUploadedFile()`
- âœ… é©—è­‰ MIME é¡å‹
- âœ… é©—è­‰ Magic Bytes
- âœ… ä½¿ç”¨å®‰å…¨æª”åï¼ˆGUID-basedï¼‰

#### 3.2.2 é†«é™¢ API ç«¯é»å¼·åŒ–ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰

**æª”æ¡ˆè·¯å¾‘**: `trunk/Controllers/AjaxController.cs`  
**å—å½±éŸ¿æ–¹æ³•**: `Api_A2_2()`, `Api_A2_2_csh()`, `Api_A2_2_cmuh()`

**å•é¡Œ**: ç›®å‰é€™äº›ç«¯é»æ¥å— Base64 ç·¨ç¢¼æª”æ¡ˆï¼Œ**å®Œå…¨æ²’æœ‰æª”æ¡ˆé¡å‹é©—è­‰**

**ä¿®æ”¹æ–¹æ¡ˆ**:

```csharp
[HttpPost, ValidateInput(false)]
public ActionResult Api_A2_2(Hospital_FarEastern_Api.Api_A2_2_ParamsModel model)
{
    // ... å‰ç½®æª¢æŸ¥
    
    if (row.ec_fileBase64.TONotNullString() != "")
    {
        // âœ… è§£ç¢¼å‰å…ˆé©—è­‰ Base64 æ ¼å¼
        if (!FileSecurityHelper.IsValidBase64(row.ec_fileBase64))
        {
            tmpRes.ec_success = "å¤±æ•—";
            tmpRes.ec_reason = "æª”æ¡ˆæ ¼å¼éŒ¯èª¤";
            continue;
        }
        
        byte[] fileBytes = Convert.FromBase64String(row.ec_fileBase64);
        
        // âœ… é©—è­‰æª”æ¡ˆå…§å®¹ï¼ˆMagic Bytesï¼‰
        string detectedExtension = FileSecurityHelper.DetectFileTypeFromBytes(fileBytes);
        string expectedExtension = Path.GetExtension(findRow.FirstOrDefault().ec_fileName);
        
        if (detectedExtension != expectedExtension)
        {
            tmpRes.ec_success = "å¤±æ•—";
            tmpRes.ec_reason = $"æª”æ¡ˆé¡å‹ä¸ç¬¦ï¼Œé æœŸ {expectedExtension}ï¼Œå¯¦éš›ç‚º {detectedExtension}";
            LOG.Warn($"File type mismatch detected: expected {expectedExtension}, got {detectedExtension}");
            continue;
        }
        
        // âœ… æª¢æŸ¥æ˜¯å¦ç‚ºå±éšªæª”æ¡ˆé¡å‹
        if (FileSecurityHelper.IsBlacklistedExtension(expectedExtension))
        {
            tmpRes.ec_success = "å¤±æ•—";
            tmpRes.ec_reason = "ä¸å…è¨±çš„æª”æ¡ˆé¡å‹";
            LOG.Error($"Blacklisted file type upload attempted: {expectedExtension}");
            continue;
        }
        
        // âœ… æª”æ¡ˆå¤§å°é™åˆ¶ (20MB)
        if (fileBytes.Length > 20 * 1024 * 1024)
        {
            tmpRes.ec_success = "å¤±æ•—";
            tmpRes.ec_reason = "æª”æ¡ˆå¤§å°è¶…é 20MB é™åˆ¶";
            continue;
        }
        
        // ... åŸå„²å­˜é‚è¼¯
    }
}
```

**å¥—ç”¨åˆ°**:
- `Api_A2_2()` (äºæ±é†«é™¢) - Line 370
- `Api_A2_2_csh()` (ä¸­å±±é†«é™¢) - Line 518
- `Api_A2_2_cmuh()` (ä¸­åœ‹é†«è—¥) - Line 666

#### 3.2.3 å…¶ä»–ç«¯é»å¼·åŒ–

| æ§åˆ¶å™¨ | æ–¹æ³• | æª”æ¡ˆè·¯å¾‘ | æ–°å¢é©—è­‰é …ç›® |
|--------|------|----------|-------------|
| A2/C102MController | `SaveUpload()` | `Areas/A2/Controllers/C102MController.cs:72` | MIME + Magic Bytes |
| A3/C101MController | `ImportDat_Go()` | `Areas/A3/Controllers/C101MController.cs:267` | MIME + Magic Bytes |
| SHAREDAO | `PutFile()` | `DataLayers/SHAREDAO.cs:108,157` | å®Œæ•´é©—è­‰é‚è¼¯ |

### 3.3 Web.config å®‰å…¨è¨­å®š

**æª”æ¡ˆè·¯å¾‘**: `trunk/Web.config`

```xml
<system.web>
  <!-- âœ… é™åˆ¶ä¸Šå‚³æª”æ¡ˆå¤§å°ç‚º 20MB -->
  <httpRuntime maxRequestLength="20480" executionTimeout="300" />
  
  <!-- âœ… é˜²æ­¢ .config æª”æ¡ˆè¢«ç€è¦½ -->
  <compilation debug="true" targetFramework="4.5.2" />
</system.web>

<system.webServer>
  <!-- âœ… é˜»æ­¢å±éšªå‰¯æª”åè¢«åŸ·è¡Œ -->
  <security>
    <requestFiltering>
      <fileExtensions>
        <add fileExtension=".aspx" allowed="false" />
        <add fileExtension=".ashx" allowed="false" />
        <add fileExtension=".asmx" allowed="false" />
        <add fileExtension=".cer" allowed="false" />
        <add fileExtension=".config" allowed="false" />
        <add fileExtension=".exe" allowed="false" />
        <add fileExtension=".dll" allowed="false" />
        <add fileExtension=".bat" allowed="false" />
        <add fileExtension=".cmd" allowed="false" />
        <add fileExtension=".ps1" allowed="false" />
      </fileExtensions>
      <requestLimits maxAllowedContentLength="20971520" /> <!-- 20MB in bytes -->
    </requestFiltering>
  </security>
</system.webServer>
```

### 3.4 Phase 1 æª”æ¡ˆè®Šæ›´æ¸…å–®

| # | æª”æ¡ˆè·¯å¾‘ | å‹•ä½œ | èªªæ˜ |
|:-:|---------|:----:|------|
| 1 | `trunk/Commons/FileSecurityHelper.cs` | **æ–°å¢** | é›†ä¸­å¼æª”æ¡ˆé©—è­‰å·¥å…·é¡ |
| 2 | `trunk/Controllers/AjaxController.cs` | ä¿®æ”¹ | UploadFile() + 3å€‹é†«é™¢APIç«¯é» |
| 3 | `trunk/Areas/A2/Controllers/C102MController.cs` | ä¿®æ”¹ | SaveUpload() é©—è­‰å¼·åŒ– |
| 4 | `trunk/Areas/A3/Controllers/C101MController.cs` | ä¿®æ”¹ | ImportDat_Go() é©—è­‰å¼·åŒ– |
| 5 | `trunk/DataLayers/SHAREDAO.cs` | ä¿®æ”¹ | PutFile() é©—è­‰å¼·åŒ– |
| 6 | `trunk/Web.config` | ä¿®æ”¹ | å®‰å…¨è¨­å®š + å‰¯æª”åéæ¿¾ |
| 7 | `trunk/Views/Shared/EditorTemplates/DynamicEFileGrid.cshtml` | ä¿®æ”¹ | åŠ å…¥ @Html.AntiForgeryToken() |

**ç¸½è¨ˆ**: 1 å€‹æ–°å¢ + 6 å€‹ä¿®æ”¹ = 7 å€‹æª”æ¡ˆ

### 3.5 Phase 1 æ¸¬è©¦è¨ˆç•«

| æ¸¬è©¦é …ç›® | æ¸¬è©¦æ–¹æ³• | é æœŸçµæœ |
|---------|---------|---------|
| æ­£å¸¸ä¸Šå‚³ PDF | ä¸Šå‚³çœŸå¯¦ PDF æª”æ¡ˆ | âœ… æˆåŠŸ |
| å½é€  PDF (æ”¹å‰¯æª”å) | å°‡ .txt æ”¹åç‚º .pdf | âŒ Magic Bytes é©—è­‰å¤±æ•— |
| ä¸Šå‚³ .aspx Webshell | ä¸Šå‚³æƒ¡æ„ .aspx æª”æ¡ˆ | âŒ é»‘åå–®æ””æˆª |
| é›™é‡å‰¯æª”å | ä¸Šå‚³ shell.aspx.jpg | âŒ å‰¯æª”åé©—è­‰å¤±æ•— |
| CSRF æ”»æ“Š | ç„¡ AntiForgeryToken è«‹æ±‚ | âŒ 403 Forbidden |
| è¶…å¤§æª”æ¡ˆ | ä¸Šå‚³ 50MB æª”æ¡ˆ | âŒ å¤§å°é™åˆ¶æ‹’çµ• |
| é†«é™¢ API Base64 é©—è­‰ | ä¸Šå‚³ Base64 ç·¨ç¢¼çš„ .aspx | âŒ é¡å‹æª¢æ¸¬å¤±æ•— |

---

## å››ã€Phase 2: é˜²ç¦¦åŠ å›ºï¼ˆé‡è¦ï¼Œ2-3 é€±ï¼‰

> **ç›®æ¨™**: å»ºç«‹ç¸±æ·±é˜²ç¦¦æ©Ÿåˆ¶ï¼Œéš”é›¢ä¸Šå‚³æª”æ¡ˆ  
> **å„ªå…ˆç´š**: ğŸŸ  é«˜

### 4.1 æª”æ¡ˆéš”é›¢èˆ‡å­˜æ”¾å®‰å…¨

#### 4.1.1 èª¿æ•´æª”æ¡ˆå„²å­˜ä½ç½®

**å•é¡Œ**: ç›®å‰æª”æ¡ˆå„²å­˜åœ¨ Web æ ¹ç›®éŒ„ä¸‹ï¼Œå¯èƒ½è¢«ç›´æ¥è¨ªå•åŸ·è¡Œ

**è§£æ±ºæ–¹æ¡ˆ**: å°‡ä¸Šå‚³æª”æ¡ˆç§»è‡³ Web æ ¹ç›®éŒ„å¤–

```
åŸæ¶æ§‹:
F:\AITest\MOH-CodeBaseNew\trunk\Uploads\  âŒ åœ¨ Web Root å…§

æ–°æ¶æ§‹:
F:\AITest\MOH-CodeBaseNew\file-storage\   âœ… åœ¨ Web Root å¤–
  â”œâ”€ quarantine\        # éš”é›¢å€ï¼ˆç­‰å¾…æƒæï¼‰
  â”œâ”€ approved\          # å·²æ ¸å‡†æª”æ¡ˆ
  â”‚   â”œâ”€ 2025\
  â”‚   â”‚   â”œâ”€ 12\
  â”‚   â”‚   â”‚   â”œâ”€ [GUID].[ext]
  â”œâ”€ rejected\          # è¢«æ‹’çµ•æª”æ¡ˆï¼ˆä¿ç•™è­‰æ“šï¼‰
  â””â”€ temp\              # è‡¨æ™‚æª”æ¡ˆï¼ˆ24å°æ™‚å¾Œè‡ªå‹•æ¸…é™¤ï¼‰
```

**Web.config è¨­å®š**:

```xml
<appSettings>
  <!-- æª”æ¡ˆå„²å­˜æ ¹ç›®éŒ„ï¼ˆWeb Root å¤–ï¼‰ -->
  <add key="FileStorage_RootPath" value="F:\AITest\MOH-CodeBaseNew\file-storage\" />
  <add key="FileStorage_QuarantinePath" value="quarantine\" />
  <add key="FileStorage_ApprovedPath" value="approved\" />
  <add key="FileStorage_RejectedPath" value="rejected\" />
</appSettings>
```

#### 4.1.2 å»ºç«‹æª”æ¡ˆä¸‹è¼‰æ§åˆ¶å™¨

**å•é¡Œ**: æª”æ¡ˆåœ¨ Web Root å¤–ï¼Œä½¿ç”¨è€…ç„¡æ³•ç›´æ¥è¨ªå•

**è§£æ±ºæ–¹æ¡ˆ**: å»ºç«‹å°ˆç”¨ä¸‹è¼‰æ§åˆ¶å™¨ï¼ŒåŠ å…¥æ¬Šé™æª¢æŸ¥

**æª”æ¡ˆè·¯å¾‘**: `trunk/Controllers/SecureFileController.cs` (æ–°å¢)

```csharp
public class SecureFileController : BaseController
{
    [HttpGet]
    [LoginRequired]
    public ActionResult Download(string fileId)
    {
        // âœ… é©—è­‰ä½¿ç”¨è€…æ¬Šé™
        if (!HasPermissionToDownload(fileId, CurrentUser))
        {
            return new HttpStatusCodeResult(403, "ç„¡æ¬Šé™ä¸‹è¼‰æ­¤æª”æ¡ˆ");
        }
        
        // âœ… å¾è³‡æ–™åº«å–å¾—æª”æ¡ˆè³‡è¨Š
        var fileInfo = dao.GetFileInfo(fileId);
        if (fileInfo == null) return HttpNotFound();
        
        // âœ… æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å·²é€šéå®‰å…¨æƒæ
        if (fileInfo.Status != "APPROVED")
        {
            return new HttpStatusCodeResult(403, "æª”æ¡ˆå°šæœªé€šéå®‰å…¨æª¢æŸ¥");
        }
        
        // âœ… è®€å–æª”æ¡ˆï¼ˆå¾ Web Root å¤–ï¼‰
        string filePath = Path.Combine(
            ConfigModel.FileStorage_ApprovedPath,
            fileInfo.StoredFileName
        );
        
        // âœ… è¨˜éŒ„ä¸‹è¼‰æ—¥èªŒ
        LogFileAccess(fileId, CurrentUser, "DOWNLOAD");
        
        return File(filePath, fileInfo.MimeType, fileInfo.OriginalFileName);
    }
}
```

### 4.2 æª”æ¡ˆä¸Šå‚³æµç¨‹æ”¹é€ ï¼ˆå…©éšæ®µæ¨¡å¼ï¼‰

**æ–°æµç¨‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: ä¸Šå‚³èˆ‡åˆæ­¥é©—è­‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ¥æ”¶æª”æ¡ˆ                                                   â”‚
â”‚ 2. åŸºç¤é©—è­‰ (å‰¯æª”å / MIME / Magic Bytes / å¤§å°)              â”‚
â”‚ 3. å„²å­˜è‡³éš”é›¢å€ (quarantine/)                                 â”‚
â”‚ 4. å¯«å…¥è³‡æ–™åº« (ç‹€æ…‹: QUARANTINE)                              â”‚
â”‚ 5. è§¸ç™¼èƒŒæ™¯æƒæä»»å‹™                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: èƒŒæ™¯æƒæèˆ‡å¯©æ ¸ (Hangfire Job)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. æ·±åº¦å…§å®¹æƒæ (Optional: æ•´åˆé˜²æ¯’è»Ÿé«”)                       â”‚
â”‚ 7. äºŒæ¬¡ Magic Bytes é©—è­‰                                      â”‚
â”‚ 8. æª¢æŸ¥åµŒå…¥å¼æƒ¡æ„ç¨‹å¼ç¢¼ (Office Macros, PDF JavaScript)        â”‚
â”‚ 9. æƒæé€šé â†’ ç§»è‡³ approved/ (ç‹€æ…‹: APPROVED)                 â”‚
â”‚ 10. æƒæå¤±æ•— â†’ ç§»è‡³ rejected/ (ç‹€æ…‹: REJECTED)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¦ä½œæª”æ¡ˆ**: `trunk/Services/FileQuarantineService.cs` (æ–°å¢)

```csharp
public class FileQuarantineService
{
    public async Task ProcessQuarantinedFile(string fileId)
    {
        var fileInfo = dao.GetFileInfo(fileId);
        string quarantinePath = GetQuarantinePath(fileInfo);
        
        try
        {
            // âœ… äºŒæ¬¡é©—è­‰ Magic Bytes
            if (!FileSecurityHelper.ValidateFileMagicBytes(quarantinePath, fileInfo.Extension))
            {
                await RejectFile(fileId, "Magic Bytes é©—è­‰å¤±æ•—");
                return;
            }
            
            // âœ… æƒæç‰¹å®šæ ¼å¼çš„å±éšªå…§å®¹
            if (await ContainsMaliciousContent(quarantinePath, fileInfo.Extension))
            {
                await RejectFile(fileId, "åµæ¸¬åˆ°å¯ç–‘å…§å®¹");
                return;
            }
            
            // âœ… (Optional) å‘¼å«é˜²æ¯’è»Ÿé«” API
            // var scanResult = await AntivirusService.ScanFile(quarantinePath);
            
            // âœ… é€šéæª¢æŸ¥ï¼Œç§»è‡³ approved
            await ApproveFile(fileId);
        }
        catch (Exception ex)
        {
            LOG.Error($"æª”æ¡ˆæƒæå¤±æ•—: {fileId}", ex);
            await RejectFile(fileId, "æƒæéç¨‹ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    private async Task<bool> ContainsMaliciousContent(string filePath, string ext)
    {
        // é‡å°ä¸åŒæª”æ¡ˆé¡å‹é€²è¡Œç‰¹å®šæª¢æŸ¥
        switch (ext.ToLower())
        {
            case ".pdf":
                return await ScanPdfForJavaScript(filePath);
            case ".docx":
            case ".xlsx":
            case ".pptx":
                return await ScanOfficeForMacros(filePath);
            default:
                return false;
        }
    }
}
```

### 4.3 è³‡æ–™è¡¨çµæ§‹èª¿æ•´

**æ–°å¢æ¬„ä½è‡³ TblEFILE**:

```sql
ALTER TABLE [dbo].[TblEFILE] ADD
    [security_status] NVARCHAR(20) DEFAULT 'QUARANTINE',  
    -- å®‰å…¨ç‹€æ…‹: QUARANTINE / APPROVED / REJECTED
    
    [security_scan_time] NVARCHAR(20),
    -- æƒææ™‚é–“
    
    [security_scan_result] NVARCHAR(500),
    -- æƒæçµæœè¨Šæ¯
    
    [stored_filename] NVARCHAR(255),
    -- å¯¦éš›å„²å­˜æª”å (GUID-based)
    
    [mime_type] NVARCHAR(100),
    -- MIME é¡å‹
    
    [file_hash] NVARCHAR(64);
    -- SHA256 æª”æ¡ˆé›œæ¹Š (ç”¨æ–¼å»é‡èˆ‡å®Œæ•´æ€§é©—è­‰)
```

### 4.4 Hangfire èƒŒæ™¯ä»»å‹™è¨­å®š

**æª”æ¡ˆè·¯å¾‘**: `trunk/Startup.cs`

```csharp
public void Configuration(IAppBuilder app)
{
    // ... ç¾æœ‰è¨­å®š
    
    // âœ… æ–°å¢æª”æ¡ˆæƒæä»»å‹™ (æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡)
    RecurringJob.AddOrUpdate(
        "scan-quarantined-files",
        () => FileQuarantineService.ScanPendingFiles(),
        "*/5 * * * *",  // Cron: æ¯ 5 åˆ†é˜
        TimeZoneInfo.Local
    );
    
    // âœ… æ¸…ç†éæœŸè‡¨æ™‚æª”æ¡ˆ (æ¯æ—¥å‡Œæ™¨ 2 é»)
    RecurringJob.AddOrUpdate(
        "cleanup-temp-files",
        () => FileQuarantineService.CleanupTempFiles(),
        "0 2 * * *",
        TimeZoneInfo.Local
    );
}
```

### 4.5 Phase 2 æª”æ¡ˆè®Šæ›´æ¸…å–®

| # | æª”æ¡ˆè·¯å¾‘ | å‹•ä½œ | èªªæ˜ |
|:-:|---------|:----:|------|
| 1 | `trunk/Services/FileQuarantineService.cs` | **æ–°å¢** | æª”æ¡ˆéš”é›¢èˆ‡æƒææœå‹™ |
| 2 | `trunk/Controllers/SecureFileController.cs` | **æ–°å¢** | å®‰å…¨æª”æ¡ˆä¸‹è¼‰æ§åˆ¶å™¨ |
| 3 | `trunk/Models/base/ConfigModel.cs` | ä¿®æ”¹ | æ–°å¢æª”æ¡ˆå„²å­˜è·¯å¾‘è¨­å®š |
| 4 | `trunk/Web.config` | ä¿®æ”¹ | æ–°å¢ FileStorage è¨­å®šé … |
| 5 | `trunk/Startup.cs` | ä¿®æ”¹ | è¨»å†Š Hangfire æƒæä»»å‹™ |
| 6 | `scripts/migration/005_alter_efile_security.sql` | **æ–°å¢** | è³‡æ–™è¡¨æ¬„ä½æ–°å¢ |
| 7 | `trunk/Controllers/AjaxController.cs` | ä¿®æ”¹ | æ”¹ç”¨å…©éšæ®µä¸Šå‚³æ¨¡å¼ |

**ç¸½è¨ˆ**: 3 å€‹æ–°å¢ + 4 å€‹ä¿®æ”¹ = 7 å€‹æª”æ¡ˆ

---

## äº”ã€Phase 3: ç›£æ§èˆ‡å¯©è¨ˆï¼ˆ1-2 é€±ï¼‰

> **ç›®æ¨™**: å»ºç«‹å®Œæ•´çš„ä¸Šå‚³è¡Œç‚ºç›£æ§èˆ‡æ—¥èªŒè¨˜éŒ„  
> **å„ªå…ˆç´š**: ğŸŸ¡ ä¸­

### 5.1 å®‰å…¨äº‹ä»¶æ—¥èªŒç³»çµ±

#### 5.1.1 å»ºç«‹å®‰å…¨æ—¥èªŒè³‡æ–™è¡¨

```sql
-- æ–°å»ºæª”æ¡ˆä¸Šå‚³å®‰å…¨æ—¥èªŒè¡¨
CREATE TABLE [dbo].[TblFileUploadSecurityLog]
(
    [log_id] BIGINT IDENTITY(1,1) PRIMARY KEY,
    [event_time] NVARCHAR(20) NOT NULL,
    [event_type] NVARCHAR(50) NOT NULL,  
    -- UPLOAD_ATTEMPT / VALIDATION_FAILED / SCAN_FAILED / SUSPICIOUS_ACTIVITY
    
    [user_no] NVARCHAR(50),
    [user_idno] NVARCHAR(20),
    [ip_address] NVARCHAR(50),
    [user_agent] NVARCHAR(500),
    
    [file_id] NVARCHAR(50),
    [original_filename] NVARCHAR(255),
    [claimed_extension] NVARCHAR(10),
    [detected_extension] NVARCHAR(10),
    [file_size] BIGINT,
    [file_hash] NVARCHAR(64),
    
    [endpoint] NVARCHAR(200),  -- ä¸Šå‚³ç«¯é» (Controller/Action)
    [validation_errors] NVARCHAR(MAX),
    [risk_level] NVARCHAR(20),  -- LOW / MEDIUM / HIGH / CRITICAL
    
    [created_time] DATETIME DEFAULT GETDATE()
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX IX_FileUploadSecurityLog_EventTime ON TblFileUploadSecurityLog(event_time DESC);
CREATE INDEX IX_FileUploadSecurityLog_RiskLevel ON TblFileUploadSecurityLog(risk_level);
CREATE INDEX IX_FileUploadSecurityLog_UserNo ON TblFileUploadSecurityLog(user_no);
```

#### 5.1.2 è¨˜éŒ„å®‰å…¨äº‹ä»¶

**ç¯„ä¾‹ï¼šåœ¨ FileSecurityHelper ä¸­è¨˜éŒ„é©—è­‰å¤±æ•—**

```csharp
public static FileUploadValidationResult ValidateUploadedFile(
    HttpPostedFileBase file, 
    List<string> allowedExtensions, 
    long maxSizeBytes)
{
    var result = new FileUploadValidationResult 
    { 
        IsValid = true, 
        ValidationErrors = new List<string>() 
    };
    
    // ... å„ç¨®é©—è­‰
    
    if (!result.IsValid)
    {
        // âœ… è¨˜éŒ„é©—è­‰å¤±æ•—äº‹ä»¶
        SecurityLogService.LogUploadValidationFailure(
            file.FileName,
            result.ValidationErrors,
            riskLevel: DetermineRiskLevel(result.ValidationErrors)
        );
    }
    
    return result;
}

private static string DetermineRiskLevel(List<string> errors)
{
    if (errors.Any(e => e.Contains("é»‘åå–®") || e.Contains("Webshell")))
        return "CRITICAL";
    if (errors.Any(e => e.Contains("Magic Bytes")))
        return "HIGH";
    if (errors.Any(e => e.Contains("MIME")))
        return "MEDIUM";
    return "LOW";
}
```

### 5.2 å³æ™‚å‘Šè­¦æ©Ÿåˆ¶

#### 5.2.1 å»ºç«‹å‘Šè­¦æœå‹™

**æª”æ¡ˆè·¯å¾‘**: `trunk/Services/SecurityAlertService.cs` (æ–°å¢)

```csharp
public class SecurityAlertService
{
    /// <summary>
    /// åµæ¸¬ç•°å¸¸ä¸Šå‚³è¡Œç‚ºä¸¦ç™¼é€å‘Šè­¦
    /// </summary>
    public static async Task MonitorSuspiciousActivity()
    {
        var dao = new BaseDAO();
        
        // âœ… æª¢æŸ¥æ˜¯å¦æœ‰çŸ­æ™‚é–“å…§å¤§é‡ä¸Šå‚³å¤±æ•—
        var recentFailures = dao.ExecuteQuery<SecurityLogCount>(@"
            SELECT user_no, COUNT(*) as failure_count
            FROM TblFileUploadSecurityLog
            WHERE event_type = 'VALIDATION_FAILED'
              AND DATEDIFF(MINUTE, created_time, GETDATE()) <= 15
            GROUP BY user_no
            HAVING COUNT(*) >= 5
        ");
        
        foreach (var user in recentFailures)
        {
            await SendSecurityAlert(
                $"ä½¿ç”¨è€… {user.user_no} åœ¨ 15 åˆ†é˜å…§ä¸Šå‚³å¤±æ•— {user.failure_count} æ¬¡ï¼Œç–‘ä¼¼æƒææ”»æ“Š",
                AlertLevel.HIGH
            );
        }
        
        // âœ… æª¢æŸ¥æ˜¯å¦æœ‰ CRITICAL ç­‰ç´šäº‹ä»¶
        var criticalEvents = dao.GetRowList<TblFileUploadSecurityLog>(
            new TblFileUploadSecurityLog 
            { 
                risk_level = "CRITICAL" 
            },
            limit: 10,
            orderBy: "created_time DESC"
        );
        
        if (criticalEvents.Any())
        {
            await SendSecurityAlert(
                $"åµæ¸¬åˆ° {criticalEvents.Count} å€‹é«˜å±éšªä¸Šå‚³å˜—è©¦",
                AlertLevel.CRITICAL,
                criticalEvents
            );
        }
    }
    
    private static async Task SendSecurityAlert(string message, AlertLevel level, object details = null)
    {
        // âœ… ç™¼é€ Email çµ¦ç³»çµ±ç®¡ç†å“¡
        var mailTo = ConfigModel.SecurityAlertEmail;
        var subject = $"[{level}] EECOnline æª”æ¡ˆä¸Šå‚³å®‰å…¨å‘Šè­¦";
        var body = $@"
            <h3>å®‰å…¨å‘Šè­¦</h3>
            <p><strong>å‘Šè­¦ç­‰ç´šï¼š</strong>{level}</p>
            <p><strong>å‘Šè­¦è¨Šæ¯ï¼š</strong>{message}</p>
            <p><strong>æ™‚é–“ï¼š</strong>{DateTime.Now:yyyy/MM/dd HH:mm:ss}</p>
            <hr/>
            <pre>{JsonConvert.SerializeObject(details, Formatting.Indented)}</pre>
        ";
        
        await CommonsServices.SendMail(
            CommonsServices.NewMail(ConfigModel.MailSenderAddr, mailTo, subject, body)
        );
        
        // âœ… è¨˜éŒ„åˆ°ç³»çµ±æ—¥èªŒ
        LOG.Warn($"[SecurityAlert] {message}");
    }
}
```

#### 5.2.2 Hangfire æ’ç¨‹ç›£æ§

**æª”æ¡ˆè·¯å¾‘**: `trunk/Startup.cs`

```csharp
// âœ… æ¯ 15 åˆ†é˜ç›£æ§å¯ç–‘æ´»å‹•
RecurringJob.AddOrUpdate(
    "monitor-suspicious-uploads",
    () => SecurityAlertService.MonitorSuspiciousActivity(),
    "*/15 * * * *",
    TimeZoneInfo.Local
);
```

### 5.3 ç®¡ç†å¾Œå°ç›£æ§å„€è¡¨æ¿

#### 5.3.1 å»ºç«‹å®‰å…¨ç›£æ§é é¢

**æª”æ¡ˆè·¯å¾‘**: `trunk/Areas/AM/Controllers/SecurityMonitorController.cs` (æ–°å¢)

**åŠŸèƒ½éœ€æ±‚**:

| åŠŸèƒ½æ¨¡çµ„ | èªªæ˜ |
|---------|------|
| å³æ™‚çµ±è¨ˆ | ä»Šæ—¥ä¸Šå‚³ç¸½æ•¸ / æˆåŠŸç‡ / å¤±æ•—ç‡ / æ””æˆªæ•¸ |
| é¢¨éšªç­‰ç´šåˆ†ä½ˆåœ– | LOW / MEDIUM / HIGH / CRITICAL æ¯”ä¾‹ |
| æœ€è¿‘æ””æˆªè¨˜éŒ„ | æœ€è¿‘ 50 ç­†è¢«æ””æˆªçš„ä¸Šå‚³å˜—è©¦ |
| ä½¿ç”¨è€…é»‘åå–® | æ¨™è¨˜ç•°å¸¸ä¸Šå‚³è¡Œç‚ºçš„å¸³è™Ÿ |
| æª”æ¡ˆé¡å‹çµ±è¨ˆ | å„é¡å‹æª”æ¡ˆä¸Šå‚³æ•¸é‡ |

**ç¯„ä¾‹ View**: `trunk/Areas/AM/Views/SecurityMonitor/Index.cshtml`

```html
<div class="row">
    <div class="col-md-3">
        <div class="info-box bg-green">
            <span class="info-box-icon"><i class="fa fa-check"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">ä»Šæ—¥æˆåŠŸä¸Šå‚³</span>
                <span class="info-box-number">@Model.TodaySuccessCount</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box bg-red">
            <span class="info-box-icon"><i class="fa fa-ban"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">ä»Šæ—¥æ””æˆªæ•¸</span>
                <span class="info-box-number">@Model.TodayBlockedCount</span>
            </div>
        </div>
    </div>
    <!-- ... å…¶ä»–çµ±è¨ˆå¡ç‰‡ -->
</div>

<div class="row">
    <div class="col-md-12">
        <div class="box box-danger">
            <div class="box-header">
                <h3 class="box-title">æœ€è¿‘æ””æˆªè¨˜éŒ„</h3>
            </div>
            <div class="box-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>ä½¿ç”¨è€…</th>
                            <th>æª”æ¡ˆåç¨±</th>
                            <th>æ””æˆªåŸå› </th>
                            <th>é¢¨éšªç­‰ç´š</th>
                            <th>IPä½å€</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.RecentBlocked)
                        {
                            <tr class="@GetRiskLevelClass(log.risk_level)">
                                <td>@log.event_time</td>
                                <td>@log.user_no</td>
                                <td>@log.original_filename</td>
                                <td>@log.validation_errors</td>
                                <td><span class="label label-@GetRiskLevelLabel(log.risk_level)">@log.risk_level</span></td>
                                <td>@log.ip_address</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
```

### 5.4 Phase 3 æª”æ¡ˆè®Šæ›´æ¸…å–®

| # | æª”æ¡ˆè·¯å¾‘ | å‹•ä½œ | èªªæ˜ |
|:-:|---------|:----:|------|
| 1 | `scripts/migration/006_create_security_log_table.sql` | **æ–°å¢** | å»ºç«‹å®‰å…¨æ—¥èªŒè¡¨ |
| 2 | `trunk/Services/SecurityLogService.cs` | **æ–°å¢** | å®‰å…¨æ—¥èªŒè¨˜éŒ„æœå‹™ |
| 3 | `trunk/Services/SecurityAlertService.cs` | **æ–°å¢** | å‘Šè­¦æœå‹™ |
| 4 | `trunk/Areas/AM/Controllers/SecurityMonitorController.cs` | **æ–°å¢** | ç›£æ§å„€è¡¨æ¿æ§åˆ¶å™¨ |
| 5 | `trunk/Areas/AM/Views/SecurityMonitor/Index.cshtml` | **æ–°å¢** | ç›£æ§é é¢ |
| 6 | `trunk/Startup.cs` | ä¿®æ”¹ | è¨»å†Šç›£æ§æ’ç¨‹ä»»å‹™ |
| 7 | `trunk/Web.config` | ä¿®æ”¹ | æ–°å¢ SecurityAlertEmail è¨­å®š |

**ç¸½è¨ˆ**: 5 å€‹æ–°å¢ + 2 å€‹ä¿®æ”¹ = 7 å€‹æª”æ¡ˆ

---

## å…­ã€Phase 4: é•·æœŸç¶­è­·èˆ‡æœ€ä½³åŒ–ï¼ˆæŒçºŒé€²è¡Œï¼‰

> **ç›®æ¨™**: å»ºç«‹é•·æœŸå®‰å…¨ç¶­è­·æ©Ÿåˆ¶  
> **å„ªå…ˆç´š**: ğŸŸ¢ ä¸­ä½

### 6.1 å®šæœŸå®‰å…¨æª¢æŸ¥æ¸…å–®

| æª¢æŸ¥é …ç›® | é »ç‡ | è² è²¬äºº | æª¢æŸ¥å…§å®¹ |
|---------|:----:|-------|---------|
| æª”æ¡ˆç™½åå–®å¯©æŸ¥ | æ¯å­£ | ç³»çµ±ç®¡ç†å“¡ | ç¢ºèªå…è¨±çš„æª”æ¡ˆé¡å‹æ˜¯å¦ä»ç¬¦åˆæ¥­å‹™éœ€æ±‚ |
| é»‘åå–®æ›´æ–° | æ¯æœˆ | è³‡å®‰äººå“¡ | æ ¹æ“šæœ€æ–°å¨è„…æƒ…å ±æ›´æ–°å±éšªå‰¯æª”åæ¸…å–® |
| æ—¥èªŒåˆ†æ | æ¯é€± | ç¶­é‹äººå“¡ | åˆ†æå®‰å…¨æ—¥èªŒï¼Œè­˜åˆ¥ç•°å¸¸æ¨¡å¼ |
| å„²å­˜ç©ºé–“æª¢æŸ¥ | æ¯æœˆ | ç³»çµ±ç®¡ç†å“¡ | æª¢æŸ¥ quarantine/rejected è³‡æ–™å¤¾å¤§å° |
| æ¬Šé™å¯©è¨ˆ | æ¯å­£ | è³‡å®‰äººå“¡ | ç¢ºèªæª”æ¡ˆå­˜å–æ¬Šé™è¨­å®šæ­£ç¢º |

### 6.2 æ•ˆèƒ½æœ€ä½³åŒ–

#### 6.2.1 éåŒæ­¥è™•ç†å¤§æª”æ¡ˆ

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<ActionResult> UploadLargeFile(DynamicEFileGrid Upload)
{
    if (Request.Files.AllKeys.Any())
    {
        var file = Request.Files[0];
        
        // âœ… å¤§æª”æ¡ˆä½¿ç”¨ Stream è™•ç†ï¼Œé¿å…è¨˜æ†¶é«”æº¢å‡º
        if (file.ContentLength > 5 * 1024 * 1024)  // > 5MB
        {
            using (var stream = file.InputStream)
            {
                await SaveFileStreamAsync(stream, file.FileName);
            }
        }
    }
}
```

#### 6.2.2 æª”æ¡ˆé›œæ¹Šå»é‡

```csharp
public async Task<string> SaveFileWithDeduplication(HttpPostedFileBase file)
{
    // âœ… è¨ˆç®—æª”æ¡ˆ SHA256
    string fileHash = await ComputeSHA256(file.InputStream);
    
    // âœ… æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå…§å®¹çš„æª”æ¡ˆ
    var existingFile = dao.GetRow(new TblEFILE { file_hash = fileHash });
    
    if (existingFile != null && existingFile.security_status == "APPROVED")
    {
        // æª”æ¡ˆå…§å®¹ç›¸åŒï¼Œç›´æ¥è¤‡ç”¨ï¼Œç¯€çœç©ºé–“
        LOG.Info($"æª”æ¡ˆå»é‡: {file.FileName} èˆ‡ {existingFile.filename} å…§å®¹ç›¸åŒ");
        return existingFile.filekey;
    }
    
    // æ–°æª”æ¡ˆï¼Œæ­£å¸¸å„²å­˜æµç¨‹
    return await SaveNewFile(file, fileHash);
}
```

### 6.3 å¨è„…æƒ…å ±æ•´åˆï¼ˆé€²éšï¼‰

#### 6.3.1 æ•´åˆ VirusTotal API (Optional)

```csharp
public class VirusTotalService
{
    private const string API_KEY = "YOUR_API_KEY";
    
    public async Task<VirusTotalResult> ScanFileHash(string sha256Hash)
    {
        // âœ… æŸ¥è©¢æª”æ¡ˆé›œæ¹Šæ˜¯å¦å·²çŸ¥ç‚ºæƒ¡æ„
        var client = new HttpClient();
        var response = await client.GetAsync(
            $"https://www.virustotal.com/api/v3/files/{sha256Hash}"
        );
        
        // ... è§£æå›æ‡‰
    }
}
```

### 6.4 æ–‡ä»¶èˆ‡åŸ¹è¨“

#### 6.4.1 å»ºç«‹æ“ä½œæ‰‹å†Š

**æª”æ¡ˆè·¯å¾‘**: `documents/plans/æª”æ¡ˆä¸Šå‚³å®‰å…¨æ“ä½œæ‰‹å†Š.md` (å»ºè­°æ–°å¢)

**å…§å®¹åŒ…å«**:
- å„éšæ®µé©—è­‰æ©Ÿåˆ¶èªªæ˜
- ç•°å¸¸è™•ç†æµç¨‹
- å¸¸è¦‹æ”»æ“Šæ‰‹æ³•èˆ‡é˜²ç¦¦æ–¹å¼
- ç·Šæ€¥æ‡‰è®Šæªæ–½

#### 6.4.2 é–‹ç™¼è€…å®‰å…¨ç·¨ç¢¼æŒ‡å—

**æ–°å¢åˆ° AGENTS.md**:

```markdown
## æª”æ¡ˆä¸Šå‚³å®‰å…¨è¦ç¯„

### å¼·åˆ¶è¦æ±‚
1. âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ `Request.Files` æœªç¶“é©—è­‰å³å„²å­˜
2. âœ… å¿…é ˆä½¿ç”¨ `FileSecurityHelper.ValidateUploadedFile()` é€²è¡Œé©—è­‰
3. âœ… æ‰€æœ‰ä¸Šå‚³ Action å¿…é ˆåŠ ä¸Š `[ValidateAntiForgeryToken]`
4. âœ… æª”æ¡ˆå¿…é ˆå„²å­˜è‡³éš”é›¢å€ï¼Œç­‰å¾…æƒæé€šé

### ç¯„ä¾‹ä»£ç¢¼
\`\`\`csharp
[HttpPost, ValidateAntiForgeryToken]
public ActionResult Upload(HttpPostedFileBase file)
{
    var validation = FileSecurityHelper.ValidateUploadedFile(file, allowedExts, maxSize);
    if (!validation.IsValid) return Error(validation.ErrorMessage);
    
    // å„²å­˜è‡³éš”é›¢å€
    await FileQuarantineService.QuarantineFile(file);
}
\`\`\`
```

---

## ä¸ƒã€å¯¦æ–½æ™‚ç¨‹è¦åŠƒ

### ç¸½æ™‚ç¨‹æ¦‚è¦½

```
Week 1-2: Phase 1 (åŸºç¤é©—è­‰)
  â”œâ”€ Week 1: å»ºç«‹ FileSecurityHelper + ä¿®æ”¹ AjaxController
  â””â”€ Week 2: ä¿®æ”¹å…¶ä»–æ§åˆ¶å™¨ + Web.config + æ¸¬è©¦

Week 3-5: Phase 2 (é˜²ç¦¦åŠ å›º)
  â”œâ”€ Week 3: æª”æ¡ˆéš”é›¢æ¶æ§‹ + SecureFileController
  â”œâ”€ Week 4: å…©éšæ®µæƒææµç¨‹ + Hangfire ä»»å‹™
  â””â”€ Week 5: æ•´åˆæ¸¬è©¦ + è³‡æ–™åº«é·ç§»

Week 6-7: Phase 3 (ç›£æ§å¯©è¨ˆ)
  â”œâ”€ Week 6: å®‰å…¨æ—¥èªŒ + å‘Šè­¦ç³»çµ±
  â””â”€ Week 7: ç›£æ§å„€è¡¨æ¿ + æ•´åˆæ¸¬è©¦

Week 8+: Phase 4 (æŒçºŒç¶­è­·)
  â””â”€ æ–‡ä»¶æ’°å¯« + åŸ¹è¨“ + æ•ˆèƒ½èª¿æ ¡
```

### å„éšæ®µå®Œæˆæ¨™æº–

| éšæ®µ | å®Œæˆæ¨™æº– | é©—è­‰æ–¹å¼ |
|-----|---------|---------|
| Phase 1 | æ‰€æœ‰ä¸Šå‚³ç«¯é»é€šéå®‰å…¨æ¸¬è©¦ | ä½¿ç”¨ OWASP ZAP æƒæ + æ‰‹å‹•æ»²é€æ¸¬è©¦ |
| Phase 2 | æª”æ¡ˆéš”é›¢æ©Ÿåˆ¶ä¸Šç·šé‹ä½œ | ä¸Šå‚³æ¸¬è©¦æª”æ¡ˆï¼Œç¢ºèªé€šéæƒææµç¨‹ |
| Phase 3 | ç›£æ§å„€è¡¨æ¿æ­£å¸¸é¡¯ç¤ºæ•¸æ“š | è§¸ç™¼å‘Šè­¦äº‹ä»¶ï¼Œç¢ºèªæ”¶åˆ°é€šçŸ¥ |
| Phase 4 | æ“ä½œæ‰‹å†Šå®Œæˆ + é–‹ç™¼è€…åŸ¹è¨“ | æ–°é€²äººå“¡èƒ½ç¨ç«‹å®Œæˆå®‰å…¨ä¸Šå‚³åŠŸèƒ½ |

---

## å…«ã€é¢¨éšªè©•ä¼°èˆ‡æ‡‰è®Šè¨ˆç•«

### 8.1 æ½›åœ¨é¢¨éšª

| é¢¨éšªé …ç›® | å½±éŸ¿ç­‰ç´š | ç™¼ç”Ÿæ©Ÿç‡ | æ‡‰å°ç­–ç•¥ |
|---------|:-------:|:-------:|---------|
| æ•ˆèƒ½ä¸‹é™ | ä¸­ | ä¸­ | éåŒæ­¥è™•ç† + å¿«å– + æ•ˆèƒ½æ¸¬è©¦ |
| å„²å­˜ç©ºé–“ä¸è¶³ | ä½ | ä½ | è‡ªå‹•æ¸…ç† + å„²å­˜ç©ºé–“ç›£æ§ |
| èª¤åˆ¤æ­£å¸¸æª”æ¡ˆ | ä¸­ | ä¸­ | æä¾›äººå·¥å¯©æ ¸æ©Ÿåˆ¶ |
| é˜²æ¯’è»Ÿé«”æ•´åˆå¤±æ•— | ä½ | ä½ | Phase 2 é˜²æ¯’æƒæè¨­ç‚º Optional |

### 8.2 å›é€€è¨ˆç•«

å¦‚æœ Phase 2/3 å¯¦æ–½å¾Œå‡ºç¾åš´é‡å•é¡Œï¼Œå¯å›é€€åˆ° Phase 1:

1. é—œé–‰æª”æ¡ˆéš”é›¢åŠŸèƒ½ (`Web.config` è¨­å®šé–‹é—œ)
2. æ¢å¾©ç›´æ¥å„²å­˜æ¨¡å¼
3. ä¿ç•™åŸºç¤é©—è­‰æ©Ÿåˆ¶ (Phase 1)

---

## ä¹ã€æˆåŠŸæŒ‡æ¨™ (KPI)

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬é‡æ–¹å¼ |
|-----|:------:|---------|
| Webshell æ””æˆªç‡ | 100% | æ¨¡æ“¬æ”»æ“Šæ¸¬è©¦ |
| æ­£å¸¸æª”æ¡ˆèª¤åˆ¤ç‡ | < 1% | æ¯æœˆçµ±è¨ˆ |
| ä¸Šå‚³æ•ˆèƒ½å½±éŸ¿ | < 500ms å»¶é² | APM ç›£æ§ |
| å®‰å…¨äº‹ä»¶éŸ¿æ‡‰æ™‚é–“ | < 15 åˆ†é˜ | å‘Šè­¦ç³»çµ±ç´€éŒ„ |
| å®‰å…¨æ—¥èªŒå®Œæ•´æ€§ | 100% | ç¨½æ ¸æª¢æŸ¥ |

---

## åã€ç¸½çµ

### æ ¸å¿ƒæ”¹å–„é …ç›®

âœ… **Phase 1 (ç·Šæ€¥)**: å»ºç«‹é›†ä¸­å¼é©—è­‰æ©Ÿåˆ¶ï¼Œé˜²æ­¢åŸºæœ¬ Webshell ä¸Šå‚³  
âœ… **Phase 2 (é‡è¦)**: æª”æ¡ˆéš”é›¢ + å…©éšæ®µæƒæï¼Œç¸±æ·±é˜²ç¦¦  
âœ… **Phase 3 (å¼·åŒ–)**: å®Œæ•´ç›£æ§èˆ‡å‘Šè­¦ï¼Œå¿«é€Ÿç™¼ç¾ç•°å¸¸  
âœ… **Phase 4 (ç¶­è­·)**: é•·æœŸå®‰å…¨ç¶­è­·æ©Ÿåˆ¶

### é æœŸæ•ˆç›Š

| æ•ˆç›Š | èªªæ˜ |
|-----|------|
| ğŸ”’ **å®‰å…¨æ€§æå‡** | å¾ 0 é˜²è­· â†’ å¤šå±¤æ¬¡é©—è­‰ + éš”é›¢ + ç›£æ§ |
| ğŸ“Š **å¯è¦–åŒ–** | é€éç›£æ§å„€è¡¨æ¿å³æ™‚æŒæ¡ä¸Šå‚³ç‹€æ³ |
| âš¡ **å¿«é€ŸéŸ¿æ‡‰** | 15 åˆ†é˜å…§ç™¼ç¾ä¸¦å‘Šè­¦ç•°å¸¸è¡Œç‚º |
| ğŸ“š **å¯ç¶­è­·æ€§** | é›†ä¸­å¼å·¥å…·é¡ + å®Œæ•´æ–‡ä»¶ |

---

## é™„éŒ„ A: åƒè€ƒè³‡æ–™

- [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [CWE-434: Unrestricted Upload of File with Dangerous Type](https://cwe.mitre.org/data/definitions/434.html)
- [NIST SP 800-53 Security Controls](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)

## é™„éŒ„ B: æª”æ¡ˆæ ¼å¼ Magic Bytes å®Œæ•´å°ç…§è¡¨

| æ ¼å¼ | Magic Bytes (Hex) | èªªæ˜ |
|-----|------------------|------|
| PDF | `25 50 44 46` | %PDF |
| JPEG | `FF D8 FF E0` æˆ– `FF D8 FF E1` | JFIF / Exif |
| PNG | `89 50 4E 47 0D 0A 1A 0A` | PNG header |
| GIF | `47 49 46 38 37 61` æˆ– `47 49 46 38 39 61` | GIF87a / GIF89a |
| BMP | `42 4D` | BM |
| ZIP | `50 4B 03 04` | PK (Office 2007+ ä¹Ÿæ˜¯æ­¤æ ¼å¼) |
| DOC | `D0 CF 11 E0 A1 B1 1A E1` | OLE2 |
| XLS | `D0 CF 11 E0 A1 B1 1A E1` | OLE2 |

---

_æ–‡ä»¶å»ºç«‹æ—¥æœŸ: 2025-12-06_  
_é è¨ˆé–‹å§‹å¯¦æ–½: 2025-12-09_  
_é è¨ˆå®Œæˆæ—¥æœŸ: 2026-01-31_
