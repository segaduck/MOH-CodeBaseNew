# Mock 登入模式實施計畫

> **建立日期**: 2025-12-06  
> **狀態**: 實施中  
> **目的**: 在本機開發環境建立 Mock 登入功能，繞過外部身份驗證服務進行測試

---

## 一、背景說明

### 1.1 問題描述

EECOnline 系統提供三種一般使用者登入方式：

| login_type | 登入方式 | 外部依賴 |
|:----------:|----------|----------|
| 1 | 自然人憑證登入 | HiPKI 本機元件 + 讀卡機 + IC卡 |
| 2 | 行動自然人憑證 (TW FidO) | 內政部 TW FidO 服務 |
| 3 | 身分證字號＋健保卡 | 政府入口網 + 讀卡機 + 健保卡 |

這三種登入方式在純 Docker 本機開發環境下**都無法完整測試**，因為：
- 需要實體硬體 (讀卡機 + IC卡/健保卡)
- 外部服務回調 URL 需要公開網址
- 需要與政府機關正式 API 對接

### 1.2 解決方案

建立「Mock 登入模式」，允許開發者在本機環境繞過外部驗證，直接使用資料庫中的真實使用者資料模擬登入成功。

---

## 二、設計規格

### 2.1 功能需求

| 項目 | 說明 |
|------|------|
| 使用者資料來源 | 使用 SQL Server 資料庫中的真實使用者 (`TblEEC_User`) |
| 登入方式選擇 | 可選擇模擬 3 種登入方式 (login_type 1/2/3) |
| 目標功能選擇 | 可選擇進入「線上申請電子病歷」或「查詢申請進度」 |
| 連結顯示位置 | 僅在 Login.cshtml 登入頁面顯示 |

### 2.2 安全機制

| 機制 | 說明 |
|------|------|
| 雙重開關 | 必須 `DevMode=1` 且 `DevMode_AllowMockLogin=1` 才能使用 |
| 管理員驗證 | 進入 Mock 登入頁面前需輸入後台管理員帳號密碼 |
| 非開發模式行為 | 自動重導向到正常登入頁 (非 404) |
| 日誌記錄 | 不記錄到 `EEC_UserOperation` 日誌表 |

### 2.3 Mock 登入流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 0: 管理員身份驗證                                          │
├─────────────────────────────────────────────────────────────────┤
│  輸入後台管理員帳號密碼 → 驗證成功後進入 Mock 登入頁面            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Mock 登入頁面 (/Home/MockLogin)                                 │
├─────────────────────────────────────────────────────────────────┤
│  Step 1: 輸入身分證字號 → 查詢使用者                              │
│  Step 2: 顯示使用者資訊 (姓名、出生日期、Email)                    │
│  Step 3: 選擇登入方式 (自然人憑證/TW FidO/健保卡)                 │
│  Step 4: 選擇目標功能 (申請/查詢)                                 │
│  Step 5: 點擊「模擬登入」                                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
         ┌────────────────────┴────────────────────┐
         ↓                                         ↓
┌─────────────────────────�──┐               ┌─────────────────────┐
│ 線上申請電子病歷     │               │ 查詢申請進度         │
│ (ProcessStep = 2)   │               │ (SearchApply 頁面)  │
└─────────────────────────┘               └─────────────────────┘
```

---

## 三、檔案變更清單

| 檔案路徑 | 動作 | 說明 |
|----------|:----:|------|
| `trunk/Web.config` | 修改 | 新增 DevMode 設定項 |
| `trunk/Models/base/ConfigModel.cs` | 修改 | 新增 DevMode 靜態屬性 |
| `trunk/Controllers/HomeController.cs` | 修改 | 新增 MockLogin Actions (含管理員驗證) |
| `trunk/Views/Home/MockLogin.cshtml` | **新增** | Mock 登入頁面 (含管理員驗證表單) |
| `trunk/Views/Home/Login.cshtml` | 修改 | 顯示 Mock 登入連結 |

**總計: 4 個修改 + 1 個新增 = 5 個檔案**

---

## 四、測試計畫

| 測試項目 | 預期結果 |
|----------|----------|
| 訪問 `/Home/Login` (DevMode=1) | 顯示黃色警告條 + Mock 登入連結 |
| 訪問 `/Home/MockLogin` 未驗證 | 顯示管理員登入表單 |
| 輸入正確管理員帳號密碼 | 進入 Mock 登入主頁面 |
| 輸入錯誤管理員帳號密碼 | 顯示錯誤訊息 |
| 輸入有效身分證字號並查詢 | 顯示使用者資訊 + 登入選項 |
| Mock 登入 → 申請流程 | 進入申請說明頁面 (ProcessStep=2) |
| Mock 登入 → 查詢流程 | 進入查詢頁面，顯示使用者申請記錄 |
| 訪問 `/Home/MockLogin` (DevMode=0) | 自動重導向到 `/Home/Login` |

---

## 五、部署注意事項

⚠️ **正式環境部署時，請確保**：

```xml
<!-- 正式環境必須關閉 -->
<add key="DevMode" value="0" />
<add key="DevMode_AllowMockLogin" value="0" />
```

---

## 六、實施預估

| 階段 | 工作項目 | 預估時間 |
|:----:|----------|:--------:|
| 1 | 修改 Web.config + ConfigModel.cs | 7 分鐘 |
| 2 | 修改 HomeController.cs | 15 分鐘 |
| 3 | 建立 MockLogin.cshtml + 修改 Login.cshtml | 13 分鐘 |
| 4 | 測試驗證 | 10 分鐘 |
| | **總計** | **~45 分鐘** |
