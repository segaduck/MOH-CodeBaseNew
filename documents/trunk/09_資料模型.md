# EECOnline 資料模型

## 1. 概述

本文件說明 EECOnline 系統的資料模型設計，包含實體類別（Entity）、資料表結構及其關聯。

### 1.1 資料模型架構

```mermaid
graph TB
    subgraph "Models 目錄結構"
        MODELS[Models/]
        
        BASE[base/<br/>基礎模型]
        ENTITIES[Entities/<br/>實體類別]
        VIEW_MODELS[ViewModel<br/>視圖模型]
        
        MODELS --> BASE
        MODELS --> ENTITIES
        MODELS --> VIEW_MODELS
    end
```

---

## 2. 核心實體類別

### 2.1 使用者相關

#### TblAMDBUSM - 管理者帳號

```mermaid
erDiagram
    TblAMDBUSM {
        string USER_ID PK "使用者ID"
        string ACCOUNT "帳號"
        string PASSWORD "密碼(SHA512)"
        string USER_NAME "姓名"
        string EMAIL "電子郵件"
        string PHONE "電話"
        string STATUS "狀態(0:停用/1:啟用)"
        int FAIL_COUNT "登入失敗次數"
        datetime LAST_LOGIN "最後登入時間"
        string PWD_CHANGE_REQ "需變更密碼"
        datetime CREATE_DATE "建立日期"
        string CREATE_USER "建立者"
        datetime UPDATE_DATE "更新日期"
        string UPDATE_USER "更新者"
    }
```

```csharp
// Models/Entities/TblAMDBUSM.cs
public class TblAMDBUSM : IDBRow
{
    [IdentityDBField]
    public string USER_ID { get; set; }
    public string ACCOUNT { get; set; }
    public string PASSWORD { get; set; }
    public string USER_NAME { get; set; }
    public string EMAIL { get; set; }
    public string PHONE { get; set; }
    public string STATUS { get; set; }
    public int? FAIL_COUNT { get; set; }
    public DateTime? LAST_LOGIN { get; set; }
    public string PWD_CHANGE_REQ { get; set; }
    public DateTime? CREATE_DATE { get; set; }
    public string CREATE_USER { get; set; }
    public DateTime? UPDATE_DATE { get; set; }
    public string UPDATE_USER { get; set; }
    
    public string GetTableName()
    {
        return "AMDBUSM";
    }
}
```

#### TblEEC_User - 民眾帳號

```mermaid
erDiagram
    TblEEC_User {
        string USER_ID PK "使用者ID"
        string IDN "身分證字號"
        string USER_NAME "姓名"
        string PHONE "電話"
        string EMAIL "電子郵件"
        string ADDRESS "地址"
        string ZIP_CODE "郵遞區號"
        datetime FIRST_LOGIN "首次登入"
        datetime LAST_LOGIN "最後登入"
        datetime CREATE_DATE "建立日期"
        datetime UPDATE_DATE "更新日期"
    }
```

### 2.2 權限相關

```mermaid
erDiagram
    TblAMROLEM ||--o{ TblAMUROLE : "角色指派"
    TblAMDBUSM ||--o{ TblAMUROLE : "使用者角色"
    TblAMGRPM ||--o{ TblAMGMAPM : "群組權限"
    TblAMFUNCM ||--o{ TblAMGMAPM : "功能權限"
    TblAMROLEM }o--|| TblAMGRPM : "角色群組"
    
    TblAMROLEM {
        string ROLE_ID PK
        string ROLE_NAME
        string GRP_ID FK
        string ROLE_DESC
    }
    
    TblAMGRPM {
        string GRP_ID PK
        string GRP_NAME
        string GRP_DESC
    }
    
    TblAMFUNCM {
        string FUNC_ID PK
        string FUNC_NAME
        string PARENT_ID
        int FUNC_LEVEL
        string FUNC_URL
        string ICON
        int SORT_ORDER
    }
    
    TblAMGMAPM {
        string GRP_ID FK
        string FUNC_ID FK
        string CAN_READ
        string CAN_WRITE
        string CAN_DELETE
    }
    
    TblAMUROLE {
        string USER_ID FK
        string ROLE_ID FK
    }
```

```csharp
// Models/Entities/TblAMFUNCM.cs
public class TblAMFUNCM : IDBRow
{
    public string FUNC_ID { get; set; }
    public string FUNC_NAME { get; set; }
    public string PARENT_ID { get; set; }
    public int? FUNC_LEVEL { get; set; }
    public string FUNC_URL { get; set; }
    public string ICON { get; set; }
    public int? SORT_ORDER { get; set; }
    public string STATUS { get; set; }
    
    public string GetTableName() => "AMFUNCM";
}

// Models/Entities/TblAMGMAPM.cs
public class TblAMGMAPM : IDBRow
{
    public string GRP_ID { get; set; }
    public string FUNC_ID { get; set; }
    public string CAN_READ { get; set; }
    public string CAN_WRITE { get; set; }
    public string CAN_DELETE { get; set; }
    
    public string GetTableName() => "AMGMAPM";
}
```

### 2.3 醫院相關

```mermaid
erDiagram
    TblEEC_Hospital ||--o{ TblEEC_HospitalPrice : "收費設定"
    TblEEC_Hospital ||--o{ TblEEC_Apply : "申請案件"
    TblEEC_RecordType ||--o{ TblEEC_HospitalPrice : "病歷類型"
    
    TblEEC_Hospital {
        string HOSPITAL_CODE PK "醫院代碼"
        string HOSPITAL_NAME "醫院名稱"
        string HOSPITAL_ADDR "地址"
        string ZIP_CODE "郵遞區號"
        string PHONE "電話"
        string FAX "傳真"
        string EMAIL "電子郵件"
        string CONTACT_NAME "聯絡人"
        string CONTACT_PHONE "聯絡電話"
        string API_URL "API 網址"
        string API_KEY "API 金鑰"
        string STATUS "狀態"
        datetime CREATE_DATE "建立日期"
        datetime UPDATE_DATE "更新日期"
    }
    
    TblEEC_RecordType {
        string RECORD_TYPE_CODE PK "類型代碼"
        string RECORD_TYPE_NAME "類型名稱"
        string CATEGORY "分類"
        string DESCRIPTION "說明"
        int SORT_ORDER "排序"
        string STATUS "狀態"
    }
    
    TblEEC_HospitalPrice {
        string HOSPITAL_CODE FK "醫院代碼"
        string RECORD_TYPE_CODE FK "類型代碼"
        decimal PRICE "價格"
        date EFFECTIVE_DATE "生效日期"
        date END_DATE "結束日期"
        string STATUS "狀態"
    }
```

```csharp
// Models/Entities/TblEEC_Hospital.cs
public class TblEEC_Hospital : IDBRow
{
    public string HOSPITAL_CODE { get; set; }
    public string HOSPITAL_NAME { get; set; }
    public string HOSPITAL_ADDR { get; set; }
    public string ZIP_CODE { get; set; }
    public string PHONE { get; set; }
    public string FAX { get; set; }
    public string EMAIL { get; set; }
    public string CONTACT_NAME { get; set; }
    public string CONTACT_PHONE { get; set; }
    public string API_URL { get; set; }
    public string API_KEY { get; set; }
    public string STATUS { get; set; }
    public DateTime? CREATE_DATE { get; set; }
    public string CREATE_USER { get; set; }
    public DateTime? UPDATE_DATE { get; set; }
    public string UPDATE_USER { get; set; }
    
    public string GetTableName() => "EEC_Hospital";
}
```

### 2.4 申請相關

```mermaid
erDiagram
    TblEEC_Apply ||--o{ TblEEC_ApplyDetail : "申請明細"
    TblEEC_Apply ||--o| TblEEC_Payment : "付款資訊"
    TblEEC_ApplyDetail ||--o| TblEEC_ApplyDetailFile : "檔案"
    
    TblEEC_Apply {
        string APPLY_NO PK "申請編號"
        string USER_ID FK "使用者ID"
        string IDN "身分證字號"
        string USER_NAME "申請人姓名"
        string PHONE "電話"
        string EMAIL "電子郵件"
        string ADDRESS "地址"
        string HOSPITAL_CODE FK "醫院代碼"
        string STATUS "狀態"
        decimal TOTAL_FEE "總金額"
        string PAY_STATUS "付款狀態"
        datetime APPLY_DATE "申請日期"
        datetime CREATE_DATE "建立日期"
        datetime UPDATE_DATE "更新日期"
    }
    
    TblEEC_ApplyDetail {
        string DETAIL_ID PK "明細ID"
        string APPLY_NO FK "申請編號"
        string RECORD_TYPE_CODE "病歷類型"
        string RECORD_TYPE_NAME "類型名稱"
        decimal PRICE "價格"
        string STATUS "狀態"
        string FILE_PATH "檔案路徑"
        datetime UPLOAD_DATE "上傳日期"
        string UPLOAD_USER "上傳者"
    }
    
    TblEEC_Payment {
        string PAYMENT_ID PK "付款ID"
        string APPLY_NO FK "申請編號"
        string TRANS_KEY "交易序號"
        decimal AMOUNT "金額"
        string PAY_TYPE "付款方式"
        string PAY_STATUS "付款狀態"
        string AUTH_CODE "授權碼"
        datetime PAY_DATE "付款日期"
        string RESPONSE_CODE "回應碼"
        string RESPONSE_MSG "回應訊息"
    }
```

```csharp
// Models/Entities/TblEEC_Apply.cs
public class TblEEC_Apply : IDBRow
{
    [IdentityDBField]
    public string APPLY_NO { get; set; }
    public string USER_ID { get; set; }
    public string IDN { get; set; }
    public string USER_NAME { get; set; }
    public string PHONE { get; set; }
    public string EMAIL { get; set; }
    public string ADDRESS { get; set; }
    public string HOSPITAL_CODE { get; set; }
    public string STATUS { get; set; }
    public decimal? TOTAL_FEE { get; set; }
    public string PAY_STATUS { get; set; }
    public DateTime? APPLY_DATE { get; set; }
    public DateTime? CREATE_DATE { get; set; }
    public DateTime? UPDATE_DATE { get; set; }
    
    public string GetTableName() => "EEC_Apply";
}

// Models/Entities/TblEEC_ApplyDetail.cs
public class TblEEC_ApplyDetail : IDBRow
{
    [IdentityDBField]
    public string DETAIL_ID { get; set; }
    public string APPLY_NO { get; set; }
    public string RECORD_TYPE_CODE { get; set; }
    public string RECORD_TYPE_NAME { get; set; }
    public decimal? PRICE { get; set; }
    public string STATUS { get; set; }
    public string FILE_PATH { get; set; }
    public DateTime? UPLOAD_DATE { get; set; }
    public string UPLOAD_USER { get; set; }
    
    public string GetTableName() => "EEC_ApplyDetail";
}
```

---

## 3. 系統管理實體

### 3.1 公告管理

```mermaid
erDiagram
    TblENEWS {
        string NEWS_ID PK "公告ID"
        string NEWS_TITLE "標題"
        string NEWS_CONTENT "內容"
        string NEWS_TYPE "類型"
        date START_DATE "開始日期"
        date END_DATE "結束日期"
        string IS_TOP "是否置頂"
        int SORT_ORDER "排序"
        string STATUS "狀態"
        datetime CREATE_DATE "建立日期"
        string CREATE_USER "建立者"
    }
```

### 3.2 郵遞區號

```mermaid
erDiagram
    TblZIPCODE {
        string ZIP_CODE PK "郵遞區號"
        string CITY_CODE "縣市代碼"
        string CITY_NAME "縣市名稱"
        string DISTRICT_CODE "區域代碼"
        string DISTRICT_NAME "區域名稱"
        string STATUS "狀態"
    }
```

### 3.3 代碼對照

```mermaid
erDiagram
    TblCODEKIND ||--o{ TblCODENAME : "代碼項目"
    
    TblCODEKIND {
        string CODE_KIND PK "代碼類別"
        string KIND_NAME "類別名稱"
        string DESCRIPTION "說明"
    }
    
    TblCODENAME {
        string CODE_KIND FK "代碼類別"
        string CODE_VALUE PK "代碼值"
        string CODE_NAME "代碼名稱"
        int SORT_ORDER "排序"
        string STATUS "狀態"
    }
```

---

## 4. 日誌相關實體

### 4.1 日誌表結構

```mermaid
erDiagram
    TblLOGIN_LOG {
        string LOG_ID PK "日誌ID"
        string USER_ID "使用者ID"
        string IDN "身分證字號"
        string LOGIN_TYPE "登入類型"
        datetime LOGIN_TIME "登入時間"
        string IP_ADDRESS "IP位址"
        string USER_AGENT "瀏覽器資訊"
    }
    
    TblOPERATION_LOG {
        string LOG_ID PK "日誌ID"
        string USER_ID "使用者ID"
        string FUNC_ID "功能ID"
        string ACTION "操作類型"
        string DESCRIPTION "說明"
        string OLD_VALUE "舊值"
        string NEW_VALUE "新值"
        datetime LOG_TIME "記錄時間"
        string IP_ADDRESS "IP位址"
    }
    
    TblERROR_LOG {
        string LOG_ID PK "日誌ID"
        string ERROR_TYPE "錯誤類型"
        string ERROR_MESSAGE "錯誤訊息"
        string STACK_TRACE "堆疊追蹤"
        string URL "請求URL"
        string USER_ID "使用者ID"
        datetime LOG_TIME "記錄時間"
    }
```

---

## 5. 視圖模型 (ViewModel)

### 5.1 Session 模型

```csharp
// Models/SessionModel.cs
public class SessionModel
{
    public LoginUserInfo LoginUserInfo { get; set; }
    public List<ClamRoleFunc> RoleFuncs { get; set; }
    public string LastActionFunc { get; set; }
    public string ErrorMessage { get; set; }
    public string ResultMessage { get; set; }
}

// Models/LoginUserInfo.cs
public class LoginUserInfo
{
    public string UserID { get; set; }
    public string UserName { get; set; }
    public string Account { get; set; }
    public string IDN { get; set; }
    public string RoleType { get; set; }
    public string HospitalCode { get; set; }
    public string HospitalName { get; set; }
    public DateTime LoginTime { get; set; }
    public string LoginIP { get; set; }
    public string LoginType { get; set; }
}

// Models/ClamRoleFunc.cs
public class ClamRoleFunc
{
    public string FuncID { get; set; }
    public string FuncName { get; set; }
    public string ParentID { get; set; }
    public int FuncLevel { get; set; }
    public string FuncUrl { get; set; }
    public string Icon { get; set; }
    public bool CanRead { get; set; }
    public bool CanWrite { get; set; }
    public bool CanDelete { get; set; }
}
```

### 5.2 查詢表單模型

```csharp
// Models/base/PagingFormModel.cs
public class PagingFormModel
{
    public int PageIndex { get; set; } = 1;
    public int PageSize { get; set; } = 20;
}

// Areas/A1/Models/C101MFormModel.cs
public class C101MFormModel : PagingFormModel
{
    [Display(Name = "醫院代碼")]
    public string HospitalCode { get; set; }
    
    [Display(Name = "醫院名稱")]
    public string HospitalName { get; set; }
    
    [Display(Name = "狀態")]
    public string Status { get; set; }
}

// Areas/A2/Models/ApplyQueryFormModel.cs
public class ApplyQueryFormModel : PagingFormModel
{
    [Display(Name = "申請編號")]
    public string ApplyNo { get; set; }
    
    [Display(Name = "醫院")]
    public string HospitalCode { get; set; }
    
    [Display(Name = "申請日期起")]
    public DateTime? StartDate { get; set; }
    
    [Display(Name = "申請日期迄")]
    public DateTime? EndDate { get; set; }
    
    [Display(Name = "狀態")]
    public string Status { get; set; }
}
```

### 5.3 列表模型

```csharp
// Areas/A1/Models/C101MGridModel.cs
public class C101MGridModel
{
    public string HOSPITAL_CODE { get; set; }
    public string HOSPITAL_NAME { get; set; }
    public string HOSPITAL_ADDR { get; set; }
    public string PHONE { get; set; }
    public string STATUS { get; set; }
    public string STATUS_NAME { get; set; }
    public DateTime? CREATE_DATE { get; set; }
}

// Areas/A2/Models/ApplyGridModel.cs
public class ApplyGridModel
{
    public string APPLY_NO { get; set; }
    public string USER_NAME { get; set; }
    public string IDN { get; set; }
    public string HOSPITAL_NAME { get; set; }
    public DateTime? APPLY_DATE { get; set; }
    public string STATUS { get; set; }
    public string STATUS_NAME { get; set; }
    public decimal? TOTAL_FEE { get; set; }
    public string PAY_STATUS { get; set; }
    public string PAY_STATUS_NAME { get; set; }
}
```

---

## 6. 資料表關聯圖

### 6.1 完整 ER 圖

```mermaid
erDiagram
    %% 使用者與權限
    AMDBUSM ||--o{ AMUROLE : "has"
    AMROLEM ||--o{ AMUROLE : "assigned"
    AMROLEM }o--|| AMGRPM : "belongs"
    AMGRPM ||--o{ AMGMAPM : "has"
    AMFUNCM ||--o{ AMGMAPM : "permission"
    
    %% 醫院與申請
    EEC_Hospital ||--o{ EEC_Apply : "receives"
    EEC_Hospital ||--o{ EEC_HospitalPrice : "has"
    EEC_RecordType ||--o{ EEC_HospitalPrice : "priced"
    EEC_User ||--o{ EEC_Apply : "submits"
    EEC_Apply ||--o{ EEC_ApplyDetail : "contains"
    EEC_Apply ||--o| EEC_Payment : "paid"
    
    %% 實體定義
    AMDBUSM {
        string USER_ID PK
        string ACCOUNT
        string PASSWORD
        string USER_NAME
    }
    
    EEC_Hospital {
        string HOSPITAL_CODE PK
        string HOSPITAL_NAME
        string STATUS
    }
    
    EEC_Apply {
        string APPLY_NO PK
        string USER_ID FK
        string HOSPITAL_CODE FK
        string STATUS
        decimal TOTAL_FEE
    }
    
    EEC_ApplyDetail {
        string DETAIL_ID PK
        string APPLY_NO FK
        string RECORD_TYPE_CODE
        decimal PRICE
    }
```

---

## 7. 代碼對照表

### 7.1 申請狀態

| 代碼 | 名稱 | 說明 |
|------|------|------|
| 01 | 待付款 | 申請已提交，等待付款 |
| 02 | 處理中 | 已付款，醫院處理中 |
| 03 | 無法提供 | 醫院無法提供病歷 |
| 04 | 已完成 | 病歷已上傳 |
| 05 | 已下載 | 民眾已下載 |
| 09 | 已取消 | 申請已取消 |

### 7.2 付款狀態

| 代碼 | 名稱 |
|------|------|
| 0 | 未付款 |
| 1 | 已付款 |
| 2 | 付款失敗 |
| 3 | 已退款 |

### 7.3 使用者狀態

| 代碼 | 名稱 |
|------|------|
| 0 | 停用 |
| 1 | 啟用 |
| 2 | 鎖定 |

### 7.4 登入類型

| 代碼 | 名稱 |
|------|------|
| CERT | 自然人憑證 |
| FIDO | 行動自然人憑證 |
| HCA | 健保卡 |
| PWD | 帳號密碼 |

---

## 8. 實體類別介面

### 8.1 IDBRow 介面

```csharp
// Models/base/IDBRow.cs
public interface IDBRow
{
    /// <summary>
    /// 取得資料表名稱
    /// </summary>
    string GetTableName();
}
```

### 8.2 IdentityDBField 屬性

```csharp
// Models/base/IdentityDBFieldAttribute.cs
[AttributeUsage(AttributeTargets.Property)]
public class IdentityDBFieldAttribute : Attribute
{
    /// <summary>
    /// 標示此欄位為識別欄位（主鍵/自動編號）
    /// </summary>
}
```

---

## 9. 命名規範

### 9.1 資料表命名

| 前綴 | 用途 | 範例 |
|------|------|------|
| AM | 管理模組 | AMDBUSM, AMROLEM |
| EEC_ | 電子病歷 | EEC_Hospital, EEC_Apply |
| LOG_ | 日誌表 | LOGIN_LOG, ERROR_LOG |
| CODE | 代碼表 | CODEKIND, CODENAME |

### 9.2 欄位命名

| 後綴 | 用途 | 範例 |
|------|------|------|
| _ID | 主鍵/外鍵 | USER_ID, APPLY_NO |
| _CODE | 代碼 | HOSPITAL_CODE |
| _NAME | 名稱 | USER_NAME |
| _DATE | 日期 | CREATE_DATE |
| _USER | 操作者 | CREATE_USER |
| _STATUS | 狀態 | PAY_STATUS |

---

本文件說明 EECOnline 系統的資料模型設計，包含核心實體類別、資料表結構、關聯關係及代碼對照表。
