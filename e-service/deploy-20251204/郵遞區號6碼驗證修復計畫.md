# 郵遞區號6碼驗證修復計畫

## 問題描述

將郵遞區號從5碼更新為6碼後，使用者輸入正確的6碼郵遞區號時，系統仍然顯示驗證錯誤。

## 根本原因分析

經過代碼審查，發現問題的根本原因如下：

### 1. 資料庫 ZIPCODE 表只包含5碼資料

**檔案**: `ES/DataLayers/MyKeyMapDAO.cs` (第976-1000行)

```csharp
public KeyMapModel GetCityTownName(string CODE)
{
    string _sql = @"SELECT ZIP_CO AS CODE,(CITYNM + TOWNNM) AS TEXT
                    FROM ZIPCODE
                    WHERE 1 = 1 ";
    if (!string.IsNullOrEmpty(CODE))
    {
        parameters.Add("ZIP_CO", CODE);
        _sql += " and ZIP_CO = @ZIP_CO";
    }
    // ...
}
```

**問題**:
- ZIPCODE 資料表的 `ZIP_CO` 欄位目前只存放5碼郵遞區號
- 當使用者輸入6碼郵遞區號時，`GetCityTownName()` 查詢返回 `null`
- 前端 JavaScript (`New.cshtml` 第449-465行) 的 `doADDRNameGet()` 函數會清空欄位並顯示「查無該郵遞區號」

### 2. 前端驗證邏輯

**檔案**: `ES/Views/Login/New.cshtml` (第419-465行)

```javascript
function doADDRSelect() {
    var url = '/ZIP_CO';
    var title = '郵遞區號查詢';
    popupWindow({ 'width': -1 }, url, title, null, function (retData, doc) {
        if (retData != null) {
            $('#ADDR_CODE').val(retData.Id);
            $('#ADDR_TEXT').val(retData.Name);
        }
    });
}

function doADDRNameGet() {
    var code = $('#ADDR_CODE');
    var data = {
        'url': '/Ajax/GetCityTown',
        'msg': '查無該郵遞區號!!',
        'arg': { 'CODE': code.val().toUpperCase() },
        'box': $('#ADDR_TEXT'),
        'add': $('#ADDR_CODE')
    };
    if ($.trim(data.arg.CODE) == '') data.box.val('');
    else {
        loadDialogADDRCodeMapName(data);  // 呼叫 AJAX 驗證
    }
}
```

**問題**:
- `#ADDR_CODE` 欄位的 `blur` 事件會觸發 `doADDRNameGet()`
- 該函數呼叫 `/Ajax/GetCityTown` API 進行驗證
- API 查詢 ZIPCODE 表，找不到6碼資料時返回空值
- 前端收到空值後會清空欄位並顯示錯誤訊息

### 3. 驗證流程圖

```
使用者輸入6碼郵遞區號
         ↓
前端 blur 事件觸發 doADDRNameGet()
         ↓
呼叫 /Ajax/GetCityTown API
         ↓
AJAXController.GetCityTown()
         ↓
MyKeyMapDAO.GetCityTownName(CODE)
         ↓
查詢 ZIPCODE 表 WHERE ZIP_CO = '6碼值'
         ↓
❌ 找不到資料 (表內只有5碼)
         ↓
返回 null → 前端顯示「查無該郵遞區號」
```

## 影響範圍

以下頁面/功能會受到影響：

| 頁面 | 檔案路徑 | 說明 |
|------|----------|------|
| 會員註冊 | `Views/Login/New.cshtml` | 個人/公司會員註冊 |
| 會員編輯 | `Views/Login/Edit1.cshtml` | 會員資料修改 |
| 郵遞區號查詢彈窗 | `Views/ZIP_CO/Index.cshtml` | 郵遞區號選擇器 |
| 其他申請表單 | 多個 Apply_xxx 頁面 | 使用相同的郵遞區號元件 |

## 修復方案

### 方案一：更新 ZIPCODE 資料表 (推薦)

**優點**: 一次性修復，不需修改程式碼
**步驟**:

1. **取得最新6碼郵遞區號資料**
   - 來源：中華郵政官方資料
   - 下載地址：https://www.post.gov.tw/post/internet/Download/index.jsp?ID=2201

2. **更新 ZIPCODE 資料表**
   ```sql
   -- 備份原有資料
   SELECT * INTO ZIPCODE_BACKUP FROM ZIPCODE;

   -- 擴展 ZIP_CO 欄位長度 (如需要)
   ALTER TABLE ZIPCODE ALTER COLUMN ZIP_CO NVARCHAR(6);

   -- 匯入新的6碼郵遞區號資料
   -- (使用 BULK INSERT 或其他方式匯入)
   ```

3. **驗證修復**
   - 測試輸入6碼郵遞區號
   - 確認 ADDR_TEXT 正確顯示地區名稱

### 方案二：修改查詢邏輯支援5碼相容

**優點**: 不需更新資料庫，向下相容
**步驟**:

修改 `MyKeyMapDAO.cs` 的 `GetCityTownName` 方法：

```csharp
public KeyMapModel GetCityTownName(string CODE)
{
    KeyMapModel result = null;
    var parameters = new DynamicParameters();
    string _sql = @"SELECT ZIP_CO AS CODE,(CITYNM + TOWNNM) AS TEXT
                    FROM ZIPCODE
                    WHERE 1 = 1 ";
    if (!string.IsNullOrEmpty(CODE))
    {
        // 如果是6碼，嘗試用前5碼查詢
        string searchCode = CODE;
        if (CODE.Length == 6)
        {
            searchCode = CODE.Substring(0, 5);
        }
        parameters.Add("ZIP_CO", searchCode);
        _sql += " and ZIP_CO = @ZIP_CO";
    }
    _sql += " order by ZIP_CO";

    using (SqlConnection conn = DataUtils.GetConnection())
    {
        conn.Open();
        result = conn.Query<KeyMapModel>(_sql, parameters).ToList().FirstOrDefault();
        conn.Close();
        conn.Dispose();
    }

    return result;
}
```

### 方案三：前端跳過驗證 (暫時方案)

**優點**: 快速修復，不需後端變更
**缺點**: 失去郵遞區號自動帶出地區名稱功能

修改 `New.cshtml` 和 `Edit1.cshtml` 中的 JavaScript：

```javascript
function doADDRNameGet() {
    var code = $('#ADDR_CODE');
    var code_text = $('#ADDR_TEXT');

    // 暫時跳過6碼驗證
    if (code.val().length == 6) {
        // 6碼時不進行 API 驗證
        return;
    }

    // 原有的5碼驗證邏輯...
}
```

## 建議優先順序

1. **短期**: 採用方案三，先讓功能可以正常使用
2. **中期**: 採用方案二，修改後端支援6碼
3. **長期**: 採用方案一，更新 ZIPCODE 資料表為完整6碼資料

## 需要修改的檔案清單

| 方案 | 檔案 | 修改內容 |
|------|------|----------|
| 方案一 | ZIPCODE 資料表 | 更新為6碼資料 |
| 方案二 | `DataLayers/MyKeyMapDAO.cs` | 修改 GetCityTownName 方法 |
| 方案三 | `Views/Login/New.cshtml` | 修改 doADDRNameGet 函數 |
| 方案三 | `Views/Login/Edit1.cshtml` | 修改 doADDRNameGet 函數 |

## 相關資料表結構

### ZIPCODE 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| ZIP_CO | NVARCHAR(5) | 郵遞區號 (目前為5碼) |
| CITYNM | NVARCHAR(?) | 縣市名稱 |
| TOWNNM | NVARCHAR(?) | 鄉鎮市區名稱 |
| ROADNM | NVARCHAR(?) | 路段名稱 |
| ROUND | NVARCHAR(?) | 範圍 |

### MEMBER 表相關欄位

| 欄位 | 類型 | 說明 |
|------|------|------|
| CITY_CD | NVARCHAR(?) | 郵遞區號 (對應 ADDR_CODE) |
| TOWN_CD | NVARCHAR(?) | 郵遞區號 (對應 ADDR_CODE) |

## 測試案例

修復後應通過以下測試：

1. ✅ 輸入5碼郵遞區號 (如 10001) → 正確顯示地區名稱
2. ✅ 輸入6碼郵遞區號 (如 115204) → 正確顯示地區名稱或不報錯
3. ✅ 使用郵遞區號查詢彈窗選擇 → 正確帶入值
4. ✅ 表單提交 → 成功儲存會員資料

## 備註

- 郵遞區號6碼制度由中華郵政於2020年3月3日開始實施
- 新制6碼格式：前3碼為原郵遞區號，後3碼為投遞區段碼
- 例如：台北市南港區 115 → 115204
