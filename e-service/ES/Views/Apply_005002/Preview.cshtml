@model ES.Models.ViewModels.Apply_005002ViewModel
@using ES.Commons
@using ES.DataLayers

@{
    Layout = null;
    ViewBag.Title = "Preview";
    ShareDAO dao = new ShareDAO();
}

<div class="col-sm-12">
    <h1 class="form-title title-bg-y">申辦表件預覽</h1>
    <div class="form-set">
        <form class="form-horizontal" action="/action_page.php">
            <div class="form-group">
                <label class="step-label col-sm-2" for="">申辦項目</label>
                <div class="col-sm-4">
                    <p class="form-control-static">外銷證明書</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">申請日期</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Apply.APP_TIME.HasValue)
                        {
                            @Model.Apply.APP_TIME.Value.ToString("yyyy/MM/dd");
                        }
                        else
                        {
                            @DateTime.Now.ToString("yyyy/MM/dd")
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">申辦份數</label>
                <div class="col-sm-4" id="paycount">
                    <p class="form-control-static">@Model.Detail.MF_COPIES</p>
                </div>
                <label class="step-label col-sm-2" for="">繳費金額</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Pay.PAY_MONEY == null)
                        {
                            if (Model.Detail.MF_COPIES.HasValue)
                            {
                                @(Model.Detail.MF_COPIES * 1500)
                            }
                        }
                        else
                        {
                            @Model.Pay.PAY_MONEY
                        }
                    </p>
                </div>
            </div>

            <h2 class="second-title">申請基本資料</h2>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">公司名稱</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Apply.NAME</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">聯絡人</label>
                <div class="col-sm-4">
                    <p class="form-control-static">@Model.Apply.CNT_NAME</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">電話</label>
                <div class="col-sm-10">
                    <p class="form-control-static">
                        @{
                            if (!string.IsNullOrEmpty(Model.Apply.TEL) && Model.Apply.TEL != "-#")
                            {
                                @Model.Apply.TEL
                            }
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">傳真</label>
                <div class="col-sm-10">
                    <p class="form-control-static">
                        @{
                            if (!string.IsNullOrEmpty(Model.Apply.FAX) && Model.Apply.FAX != "-#")
                            {
                                @Model.Apply.FAX
                            }
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">E-MAIL</label>
                <div class="col-sm-10">
                    <p class="form-control-static">
                        @{
                            if (!string.IsNullOrEmpty(Model.Detail.EMAIL) && Model.Detail.EMAIL != "@" && Model.Detail.EMAIL != "@0")
                            {
                                @Model.Detail.EMAIL.Replace("@0", @"@")
                            }
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">藥品許可證字號(中文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static"> @Model.Detail.LIC_CD @Model.Detail.LIC_NUM 號 </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">藥品許可證字號(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.LIC_CD_E @Model.Detail.LIC_NUM_E </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">製造廠名稱(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.MF_CNT_NAME</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">製造廠名稱(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.MF_CNT_NAME_E</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">製造廠地址(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.MF_ADDR </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">製造廠地址(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.MF_ADDR_E </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">藥品名稱(中文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static"> @Model.Detail.DRUG_NAME </p>
                </div>
                <label class="step-label col-sm-2" for="">藥品名稱(英文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static"> @Model.Detail.DRUG_NAME_E </p>
                </div>
            </div>

            <div class="form-group">
                <label class="step-label col-sm-2" for="">外銷品名</label>
                <div class="col-sm-10">
                    <table class="table table-bordered">
                        <tr>
                            <th>外銷品名(中)</th>
                            <th>外銷品名(英)</th>
                        </tr>
                        @foreach (var item in Model.DosageFormList)
                        {
                            <tr>
                                <td>@item.DOSAGE_FROM</td>
                                <td>@item.DOSAGE_FROM_E</td>
                            </tr>
                        }
                    </table>
                </div>
            </div>


            @*<div class="form-group">
                    <label class="step-label col-sm-2" for="">登載外銷品名</label>
                    <div class="col-sm-10">
                        <p class="form-control-static"> </p>
                    </div>
                </div>
                <div class="form-group" id="choseProduct">
                    <label class="step-label col-sm-2" for="">勾選外銷品名</label>
                    <div class="col-sm-10">
                        <p class="form-control-static"></p>
                    </div>
                </div>
                <div class="form-group" id="choseProduct1">
                    <label class="step-label col-sm-2" for="">外銷品名(中文)</label>
                    <div class="col-sm-10">
                        <p class="form-control-static"></p>
                    </div>
                </div>
                <div class="form-group" id="choseProduct2">
                    <label class="step-label col-sm-2" for="">外銷品名(英文)</label>
                    <div class="col-sm-10">
                        <p class="form-control-static"></p>
                    </div>
                </div>*@


            <div class="form-group">
                <label class="step-label col-sm-2" for="">劑型(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.DOSAGE_FORM </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">劑型(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.DOSAGE_FORM_E </p>
                </div>
            </div>

            <div class="form-group">
                <label class="step-label col-sm-2" for="">核准日期(中文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Detail.ISSUE_DATE.HasValue)
                        {
                            @(Model.Detail.ISSUE_DATE.Value.Year - 1911)@Model.Detail.ISSUE_DATE.Value.ToString("/MM/dd")
                        }
                    </p>
                </div>
                <label class="step-label col-sm-2" for="">核准日期(英文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Detail.ISSUE_DATE.HasValue)
                        {
                            @Model.Detail.ISSUE_DATE.Value.ToString("yyyy/MM/dd")
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">顯示有效日期</label>
                <div class="col-sm-10">
                    <p class="form-control-static">刊載藥品許可證有效日期</p>
                </div>
            </div>
            <div class="form-group" id="choseDate">
                <label class="step-label col-sm-2" for="">有效日期(中文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Detail.EXPIR_DATE.HasValue)
                        {
                            @(Model.Detail.EXPIR_DATE.Value.Year - 1911)@Model.Detail.EXPIR_DATE.Value.ToString("/MM/dd")
                        }
                    </p>
                </div>
                <label class="step-label col-sm-2" for="">有效日期(英文)</label>
                <div class="col-sm-4">
                    <p class="form-control-static">
                        @if (Model.Detail.EXPIR_DATE.HasValue)
                        {
                            @Model.Detail.EXPIR_DATE.Value.ToString("yyyy/MM/dd")
                        }
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">處方說明(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.MF_CONT </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">處方說明(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static"> @Model.Detail.MF_CONT_E</p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">成分內容</label>
                <div class="col-sm-10">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                @*<th>上下</th>*@
                                <th>成分內容(中文)</th>
                                <th>生藥名</th>
                                <th>份量</th>
                                <th>單位</th>
                                @*<th>刪除</th>*@
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.IngredientList != null)
                            {
                                foreach (var item in Model.IngredientList)
                                {
                                    <tr>
                                        @*<td></td>*@
                                        <td>@item.DI_NAME</td>
                                        <td>@item.DI_ENAME</td>
                                        <td>@item.DI_CONT</td>
                                        <td>@item.DI_UNIT</td>
                                        @*<td></td>*@
                                    </tr>
                                }
                            }
                            @*<tr><td></td><td><input type="text" class="form-control" value="厚  朴"></td><td><input type="text" class="form-control" value="Magnoliae Cortex"></td><td><input type="text" class="form-control" value="4.5"></td><td><input type="text" class="form-control" value="g"></td><td></td></tr>
                                <tr><td></td><td><input type="text" class="form-control" value="茯  苓"></td><td><input type="text" class="form-control" value="Poria"></td><td><input type="text" class="form-control" value="6.0"></td><td><input type="text" class="form-control" value="g"></td><td></td></tr>
                                <tr><td></td><td><input type="text" class="form-control" value="生  薑"></td><td><input type="text" class="form-control" value="Zingiberis Rhizoma Recens"></td><td><input type="text" class="form-control" value="7.5"></td><td><input type="text" class="form-control" value="g"></td><td></td></tr>
                                <tr><td></td><td><input type="text" class="form-control" value="紫蘇葉"></td><td><input type="text" class="form-control" value="Perillae Folium"></td><td><input type="text" class="form-control" value="3.0"></td><td><input type="text" class="form-control" value="g"></td><td></td></tr>*@
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">是否為濃縮製劑</label>
                <div class="col-sm-10">
                    @*<input type="checkbox" class="form-normal" id="" checked="" disabled="">是*@
                    @{
                        bool isScale = !string.IsNullOrEmpty(Model.Detail.PC_SCALE_1);
                    }
                    @(isScale ? "是" : "否")
                </div>
            </div>

            @if (isScale)
            {
                <div class="form-group">
                    <label class="step-label col-sm-2" for="">生藥與浸膏比例(中文)</label>
                    <div class="col-sm-10">
                        @*<input type="text" class="form-control" id="" value="以上生藥製成浸膏3.8g(生藥與浸膏比例29:3.8=7.6:1)">*@
                        @string.Format("以上生藥製成浸膏{0}{1}(生藥與浸膏比例{2}:{3}={4}:{5})",
                            Model.Detail.PC_SCALE_1,
                            Model.Detail.PC_SCALE_1E,
                            Model.Detail.PC_SCALE_21,
                            Model.Detail.PC_SCALE_22,
                            Model.Detail.PC_SCALE_23,
                            Model.Detail.PC_SCALE_24
                        )
                    </div>
                </div>
                <div class="form-group">
                    <label class="step-label col-sm-2" for="">生藥與浸膏比例(英文)</label>
                    <div class="col-sm-10">
                        @*<input type="text" class="form-control" id="" value="Above raw herbs equivalent to 3.8g herbal extract.(Ratio of raw herbs and extract 29:3.8=7.6:1)">*@
                        @string.Format("Above raw herbs equivalent to {0}{1} herbal extract.(Ratio of raw herbs and extract {2}:{3}={4}:{5})",
                            Model.Detail.PC_SCALE_1,
                            Model.Detail.PC_SCALE_2E,
                            Model.Detail.PC_SCALE_21,
                            Model.Detail.PC_SCALE_22,
                            Model.Detail.PC_SCALE_23,
                            Model.Detail.PC_SCALE_24
                        )
                    </div>
                </div>
                <div class="form-group">
                    <label class="step-label col-sm-2" for="">賦形劑</label>
                    <div class="col-sm-10">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>成分內容(中文)</th>
                                    <th>生藥名</th>
                                    <th>份量</th>
                                    <th>單位</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.ExcipientList != null)
                                {
                                    foreach (var item in Model.ExcipientList)
                                    {
                                        <tr>
                                            <td>@item.PC_NAME</td>
                                            <td>@item.PC_ENAME</td>
                                            <td>@item.PC_CONT</td>
                                            <td>@item.PC_UNIT</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <div class="form-group">
                <label class="step-label col-sm-2" for="">登載效能、適應症</label>
                <div class="col-sm-10">
                    <p class="form-control-static">1.效能 2.適應症</p>
                </div>
            </div>

            <div class="form-group" id="choseA1">
                <label class="step-label col-sm-2" for="">效能(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.EFFICACY</p>
                </div>
            </div>
            <div class="form-group" id="choseA2">
                <label class="step-label col-sm-2" for="">效能(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.EFFICACY_E</p>
                </div>
            </div>

            <div class="form-group" id="choseB1">
                <label class="step-label col-sm-2" for="">適應症(中文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">@Model.Detail.INDIOCATION</p>
                </div>
            </div>
            <div class="form-group" id="choseB2">
                <label class="step-label col-sm-2" for="">適應症(英文)</label>
                <div class="col-sm-10">
                    <p class="form-control-static">
                        @Model.Detail.INDIOCATION_E
                    </p>
                </div>
            </div>

            <h2 class="second-title">佐證文件檔案上傳</h2>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">
                    佐證文件採合併檔案
                </label>
                <div class="col-sm-10">
                    <p class="form-control-static">
                        @(Model.Detail.MERGE_YN == "Y" ? "是" : "否")
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">外銷專用藥品許可證(正面)</label>
                <div class="col-sm-10">
                    <div>
                        @{
                            string filebase641 = null;
                            if (Model.UploadFile_1 != null)
                            {
                                Model.UploadFile_1.InputStream.Position = 0;
                                filebase641 = MyCommonUtil.StreamToBase64(Model.UploadFile_1.InputStream);
                            }
                        }
                        @if (Model.UploadFile_1 != null)
                        {
                            @RenderDownloadField(filebase641, Model.UploadFile_1.ContentType, Model.ApplyFile_1.FILENAME)
                        }
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">外銷專用藥品許可證(反面)</label>
                <div class="col-sm-10">
                    <div>
                        @{
                            string filebase642 = null;
                            if (Model.UploadFile_2 != null)
                            {
                                Model.UploadFile_2.InputStream.Position = 0;
                                filebase642 = MyCommonUtil.StreamToBase64(Model.UploadFile_2.InputStream);
                            }
                        }
                        @if (Model.UploadFile_2 != null)
                        {
                            @RenderDownloadField(filebase642, Model.UploadFile_2.ContentType, Model.ApplyFile_2.FILENAME)
                        }
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="step-label col-sm-2" for="">處方之中藥材中英文對照表</label>
                <div class="col-sm-10">
                    <div>
                        @{
                            string filebase643 = null;
                            if (Model.UploadFile_3 != null)
                            {
                                Model.UploadFile_3.InputStream.Position = 0;
                                filebase643 = MyCommonUtil.StreamToBase64(Model.UploadFile_3.InputStream);
                            }
                        }
                        @if (Model.UploadFile_3 != null)
                        {
                            @RenderDownloadField(filebase643, Model.UploadFile_3.ContentType, Model.ApplyFile_3.FILENAME)
                        }
                    </div>
                </div>
            </div>

            <script type="text/javascript">
                $(document).ready(function () {
                    $('#paycount').change(function () {
                        var amount = $('#paycount option:selected').val() * 1500;
                        $('#payamount').val(amount);
                    });

                    $('input[id="addProduct"]').change(function () {
                        if ($('input[id="addProduct"]').is(':checked') == true) {
                            $('#choseProduct').show();
                            $('#choseProduct1').show();
                            $('#choseProduct2').show();
                        } else {
                            $('#choseProduct').hide();
                            $('#choseProduct1').hide();
                            $('#choseProduct2').hide();
                        };
                    });

                    $('input[id="addDate"]').change(function () {
                        if ($('input[id="addDate"]').is(':checked') == true) {
                            $('#choseDate').show();
                        } else {
                            $('#choseDate').hide();
                        };
                    });

                    $('input[id="addA"]').change(function () {
                        if ($('input[id="addA"]').is(':checked') == true) {
                            $('#choseA1').show();
                            $('#choseA2').show();
                        } else {
                            $('#choseA1').hide();
                            $('#choseA2').hide();
                        };
                    });
                    $('input[id="addB"]').change(function () {
                        if ($('input[id="addB"]').is(':checked') == true) {
                            $('#choseB1').show();
                            $('#choseB2').show();
                        } else {
                            $('#choseB1').hide();
                            $('#choseB2').hide();
                        };
                    });
                });
            </script>
        </form>
    </div>
</div>

@helper RenderDownloadField(string base64, string contentType, string filename)
{
    bool isImg = true;
    bool isPdf = true;
    var fileExt = Path.GetExtension(filename).ToLower();
    string shortFilename = Path.GetFileName(filename);

    byte[] ba = System.Text.Encoding.UTF8.GetBytes(filename); ;
    string base64filename = Convert.ToBase64String(ba);
    string urlAttch = Url.Action("DownloadFileFromPath", "Apply_005002", new { area = "", filepath = base64filename });
    string urlInline = Url.Action("DownloadFileFromPath", "Apply_005002", new { area = "", filepath = base64filename, downloadtype = "inline" });

    switch (fileExt)
    {
        case ".jpg":
        case ".jpeg":
        case ".bmp":
        case ".png":
        case ".gif":
            isImg = true;
            isPdf = false;
            break;
        case ".pdf":
            isImg = false;
            isPdf = true;
            break;
        default:
            isImg = false;
            isPdf = false;
            break;
    }

    if (isImg)
    {
        <div class="col-sm-6">
            <a href="@urlAttch" download>@shortFilename</a>
            <a href="@urlInline" target="_blank">
                <img src="data:@(contentType);base64,@(base64)" style="width:100px" />
            </a>
        </div>
    }
    else if (isPdf)
    {
        <div class="col-sm-10 form-control-static">
            <a href="@urlAttch" class="form-control-static" download>@shortFilename</a>
            <a href="@urlInline" class="btn btn-default" target="_blank">預覽</a>
        </div>
    }
    else
    {
        <div class="col-sm-10 form-control-static">
            <a href="@urlAttch" class="form-control-static" download>@shortFilename</a>
        </div>
    }
}

