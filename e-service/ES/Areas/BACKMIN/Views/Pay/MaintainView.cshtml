@using ES.Utils;
@model ES.Areas.Admin.Models.PayModel
<script src="../../Scripts/View/Maintain.js" type="text/javascript"></script>
<script type="text/javascript">
    function RebackSearch() {
        $('#ActionType').val('Reback');
    }
</script>
@{
    Layout = "~/Areas/BACKMIN/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "繳費維護（詳細）";
    ViewBag.FunctionTitle = "繳費維護（詳細）";
}
<div class="bread">
    <i class="fas fa-home"></i>首頁 / 帳務管理 / @ViewBag.FunctionTitle
</div>
<div class="col-sm-12 content">
    <h1 class="main-title"><i class="fas fa-edit"></i>@ViewBag.Title</h1>
    <div class="table-responsive">
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table-typeA table">
            <thead>
                <tr>
                    <th colspan="2">案件內容</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td width="20%">
                        <div align="center">申辦編號：</div>
                    </td>
                    <td width="80%">
                        @Html.HiddenFor(m => m.viewModel.SRV_ID)
                        @Html.HiddenFor(m => m.viewModel.APP_ID)
                        @Html.DisplayFor(m => m.viewModel.SRV_ID)<br />
                        @Html.DisplayFor(m => m.viewModel.APP_ID)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">案件名稱：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.SRV_NAME)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">會員姓名：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.NAME)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">會員ID/統編：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.IDN)
                        @if (this.Model.viewModel.PAY_WAY.Equals("C"))
                        {
                            <div>持卡人身份證字號:</div>
                            if (Model.viewModel.CARD_IDN != null)
                            {
                                @Html.DisplayFor(m => m.viewModel.CARD_IDN)
                            }
                            else
                            {
                                <div>與申請者相同</div>
                            }
                        }
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">申請時間：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.APP_TIME)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">處理起算日：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.APP_STR_DATE)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">繳費時機：</div>
                    </td>
                    <td>
                        @{
                            int a = this.Model.viewModel.PAY_A_FEE.HasValue ? this.Model.viewModel.PAY_A_FEE.Value : 0;
                            int c = this.Model.viewModel.PAY_C_FEE.HasValue ? this.Model.viewModel.PAY_C_FEE.Value : 0;
                            @Html.Raw(WebUtils.GetMaintainView_Paypoint(this.Model.viewModel.PAY_POINT, a, c))
                        }
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">公文文號：</div>
                    </td>
                    <td>
                        @Html.HiddenFor(m => m.viewModel.MOHW_CASE_NO)
                        @Html.DisplayFor(m => m.viewModel.MOHW_CASE_NO)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">以案案號：</div>
                    </td>
                    <td>
                        @Html.HiddenFor(m => m.viewModel.SESSION_KEY)
                        @Html.DisplayFor(m => m.viewModel.SESSION_KEY)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">案件進度：</div>
                    </td>
                    <td>
                        @Html.DisplayFor(m => m.viewModel.FLOW_NAME)
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center">案件狀態：</div>
                    </td>
                    <td>
                        @{
                            int ap = this.Model.viewModel.PAY_A_PAID.HasValue ? this.Model.viewModel.PAY_A_PAID.Value : 0;
                            int cp = this.Model.viewModel.PAY_C_PAID.HasValue ? this.Model.viewModel.PAY_C_PAID.Value : 0;
                            String PAYSTATUS = "";
                            @Html.Raw(WebUtils.GetMaintainView_PaidStatus(this.Model.viewModel.PAY_POINT, a, c, ap, cp, this.Model.viewModel.CASE_BACK_MK, this.Model.viewModel.PAY_BACK_MK, out PAYSTATUS))
                        }

                        @if (this.Model.viewModel.PAY_WAY.Equals("C") @*&& PAYSTATUS.Equals("未繳費")*@)
                        {
                            <input type="button" value="檢查信用卡繳費狀態" onclick="CheckCardStatus('@this.Model.APP_ID');" />
                        }
                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <div align="center"> 結案狀態：</div>
                    </td>
                    <td>
                        @Html.Raw(this.Model.viewModel.CLOSE_MK.Equals("Y") ? "已結案" : "未結案")
                    </td>
                </tr>
                @{
                    if ((this.Model.viewModel.PAY_WAY.Equals("S") || this.Model.viewModel.PAY_WAY.Equals("C")) & PAYSTATUS.Equals("已繳費"))
                    {
                        <tr>
                            <td align="center">
                                <div align="center">繳費狀態：</div>
                            </td>
                            <td>
                                @{
                                    if (this.Model.viewModel.SETTLE_DATE.HasValue)
                                    {
                                        @Html.Raw("已入帳")
                                    }
                                    else
                                    {
                                        <input type="checkbox" name="chb_app_id" value="@this.Model.APP_ID" />@Html.Raw("已入帳 &nbsp; &nbsp;")

                                        <input type="button" name="submit" value="確定" onclick="if(confirm('確定要入帳?')){UpdateTime()}" />
                                    }
                                }
                            </td>
                        </tr>
                                    }
                }
            </tbody>
        </table>
    </div>

    <hr width="100%" size="1" noshade="noshade" />

    @using (Html.BeginForm("MaintainViewUpdate", "Pay", FormMethod.Post, new { ID = "ActionForm_Detail" }))
    {
        @*紀錄查詢條件；返回使用*@
        @Html.HiddenFor(x => x.ActionType)
        @Html.HiddenFor(x => x.queryModel.APP_ID_BEGIN)
        @Html.HiddenFor(x => x.queryModel.APP_ID_END)
        @Html.HiddenFor(x => x.queryModel.APP_TIME_BEGIN)
        @Html.HiddenFor(x => x.queryModel.APP_TIME_END)
        @Html.HiddenFor(x => x.queryModel.CLOSE_MK)
        @Html.HiddenFor(x => x.queryModel.IDN)
        @Html.HiddenFor(x => x.queryModel.NowPage)
        @Html.HiddenFor(x => x.queryModel.OderByCol)
        @Html.HiddenFor(x => x.queryModel.PAY_STATUS)
        @Html.HiddenFor(x => x.queryModel.PAY_WAY)
        @Html.HiddenFor(x => x.queryModel.SC_PID)
        @Html.HiddenFor(x => x.queryModel.SortAZ)
        @Html.HiddenFor(x => x.queryModel.SRV_ID)
        @Html.HiddenFor(x => x.queryModel.UNIT_TYPE)
        <h2 class="second-title">@Html.Raw("案件申請時繳費維護（總共應繳金額：" + this.Model.viewModel.PAY_A_FEE + "元整）")</h2>
        <input type="hidden" name="app_id" value="@this.Model.viewModel.APP_ID" />
        <input type="hidden" name="service_uid_db" value="@this.Model.viewModel.SRV_ID" />
        <input type="hidden" name="pay_cexpect_db" value="@this.Model.viewModel.PAY_A_FEE" />
        <div class="table-responsive">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table-typeA table">
                @{
                    if (this.Model.viewModel.PAY_POINT.Equals("B") || this.Model.viewModel.PAY_POINT.Equals("D"))
                    {
                        <thead>
                            <tr>
                                <th>
                                    已繳費
                                </th>
                                <th>
                                    繳費方式
                                </th>
                                <th>
                                    匯(支)票/銷帳號碼
                                </th>
                                <th>
                                    申辦日期
                                </th>
                                <th>
                                    繳費金額
                                </th>
                                <th>
                                    交易金額
                                </th>
                                <th>
                                    交易狀態
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int paymoney = 0;
                                foreach (ES.Areas.Admin.Models.Map map in ViewBag.List)
                                {
                                    string paymethod = map.GetString("PAY_METHOD");
                                    paymoney += map.GetInt("PAY_MONEY");
                                    if (map.GetString("PAY_STATUS_MK").Equals("Y"))
                                    {

                                        <tr>
                                            <td align="center"></td>
                                            <td align="center">
                                                @WebUtils.GetPay_Method(paymethod)
                                            </td>
                                            <td align="center">
                                                @{
                                                    switch (paymethod)
                                                    {
                                                        case "C":
                                                            @Html.Raw(map.GetString("SESSION_KEY"))
                                                            break;
                                                        case "S":
                                                            @Html.Raw(map.GetString("PAY_ID"))
                                                            break;
                                                    }
                                                }
                                            </td>
                                            <td align="center">
                                                @Html.Raw(map.GetDateTime("PAY_ACT_TIME").HasValue ? map.GetDateTime("PAY_ACT_TIME").Value.ToString("yyyy/MM/dd") : "")
                                            </td>
                                            <td align="center">
                                                @Html.Raw(map.GetInt("PAY_MONEY"))
                                            </td>
                                            <td align="center">
                                                @Html.Raw(map.GetInt("PAY_MONEY"))
                                            </td>
                                            <td align="center">
                                                @{
                                                    if (PAYSTATUS.Equals("已繳費"))
                                                    {
                                                        @Html.Raw("已交易且交易成功")
                                                    }
                                                    else
                                                    {
                                                        @Html.Raw(map.GetString("PAY_DESC"))
                                                    }
                                                }
                                            </td>
                                        </tr>
                                                    }
                                                    else
                                                    {
                                                        <tr>
                                                            <td align="center">
                                                                <input type="checkbox" name="tx_id_org" value="@Html.Raw(map.GetString("PAY_ID") + "-" + map.GetInt("PAY_MONEY"))" />
                                                            </td>
                                                            <td align="center">
                                                                <select name="paymethod_org">
                                                                    <option value="@Html.Raw(map.GetString("PAY_ID") + "-D")">匯(支)票</option>
                                                                    <option value="@Html.Raw(map.GetString("PAY_ID") + "-T")">劃撥</option>
                                                                    <option value="@Html.Raw(map.GetString("PAY_ID") + "-B")">臨櫃</option>
                                                                    @{
                                                                        if (paymethod.Equals("S"))
                                                                        {
                                                                            <option value="@Html.Raw(map.GetString("PAY_ID") + "-S")" selected>超商</option>
                                                                        }
                                                                    }
                                                                </select>
                                                            </td>
                                                            <td align="center">
                                                                @Html.Raw(map.GetString("PAY_DESC"))
                                                            </td>
                                                            <td align="center">
                                                                @Html.Raw(map.GetDateTime("PAY_ACT_TIME").HasValue ? map.GetDateTime("PAY_ACT_TIME").Value.ToString("yyyy/MM/dd") : "")
                                                            </td>
                                                            <td align="center">
                                                                @Html.Raw(map.GetInt("PAY_MONEY"))
                                                            </td>
                                                            <td align="center">
                                                                @Html.Raw(map.GetInt("PAY_MONEY"))
                                                            </td>
                                                            <td align="center">
                                                                未交易
                                                            </td>
                                                        </tr>
                                                        <tr />
                                                                            }
                                                                        }
                                                                        if (this.Model.viewModel.PAY_A_FEE.Value != paymoney & this.Model.viewModel.PAY_BACK_MK.Equals("Y"))
                                                                        {
                                                                            int diff_pay = this.Model.viewModel.PAY_A_FEE.Value - paymoney;
                                                                            <tr>
                                                                                <td align="center">
                                                                                    <input type="checkbox" name="tx_id_new" value="newtx" />
                                                                                </td>
                                                                                <td align="center">
                                                                                    <select name="paymethod_new">
                                                                                        @{
                                                                                            if (diff_pay > 0)
                                                                                            {
                                                                                                <option value="D">匯(支)票</option>
                                                                                                <option value="T">劃撥</option>
                                                                                            }
                                                                                            else
                                                                                            {

                                                                                            }
                                                                                        }
                                                                                        <option value="B">臨櫃</option>
                                                                                    </select>
                                                                                </td>
                                                                                <td align="center">
                                                                                    &nbsp;
                                                                                </td>
                                                                                <td align="center">
                                                                                    &nbsp;
                                                                                </td>
                                                                                <td align="center">
                                                                                    @diff_pay
                                                                                </td>
                                                                                <td align="center">
                                                                                    @{
                                                                                        if (diff_pay > 0)
                                                                                        {
                                                                                            @Html.Raw("補繳金額：");
                                                                                            <input type="text" name="pay_money_new" value="@diff_pay" size="10" />
                                                                                            <input type="hidden" name="pay_money_chk" value="@diff_pay" />
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            @Html.Raw("退費金額：" + diff_pay);
                                                                                            <input type="hidden" name="pay_money_new" value="@diff_pay">
                                                                                            <input type="hidden" name="pay_money_chk" value="@diff_pay">
                                                                                        }
                                                                                    }
                                                                                </td>
                                                                                <td align="center">
                                                                                    &nbsp;
                                                                                </td>
                                                                            </tr>
                                                                                        }
                                                                                        else if (this.Model.viewModel.PAY_A_FEE.Value == paymoney && this.Model.viewModel.PAY_A_PAID.Value > 0 && this.Model.viewModel.PAY_BACK_MK.Equals("Y"))
                                                                                        {
                                                                                            int diff_pay = this.Model.viewModel.PAY_A_FEE.Value - this.Model.viewModel.PAY_A_PAID.Value;
                                                                                            <tr>
                                                                                                <td align="center">
                                                                                                    <input type="checkbox" name="tx_id_new" value="nontx" />
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    &nbsp;
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    &nbsp;
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    &nbsp;
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    @this.Model.viewModel.PAY_A_FEE.Value
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    @Html.Raw("退費金額：" + diff_pay)
                                                                                                    <input type="hidden" name="pay_money_new" value="@diff_pay" />
                                                                                                    <input type="hidden" name="pay_money_chk" value="@diff_pay" />
                                                                                                </td>
                                                                                                <td align="center">
                                                                                                    &nbsp;
                                                                                                </td>
                                                                                            </tr>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <tr>
                                                                                                <td colspan="7">
                                                                                                    <input type="hidden" name="pay_money_new" value="0" />
                                                                                                    <input type="hidden" name="pay_money_chk" value="0" />
                                                                                                </td>
                                                                                            </tr>
                                                                                        }
                            }
                        </tbody>
                                                                                        }
                                                                                        if (this.Model.viewModel.PAY_POINT.Equals("C") || this.Model.viewModel.PAY_POINT.Equals("D"))
                                                                                        {
                                                                                            int diff_pay = this.Model.viewModel.PAY_C_FEE.Value - this.Model.viewModel.PAY_C_PAID.Value;
                                                                                            <thead>
                                                                                                <tr>
                                                                                                    <td align="center">
                                                                                                        <strong>&nbsp;</strong>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                <tr>
                                                                                                    <td align="center">
                                                                                                        <strong>案件審核後繳費維護</strong>
                                                                                                    </td>
                                                                                                </tr>
                                                                                            </thead>
                                                                                            <tbody>
                                                                                                <tr>
                                                                                                    <td width="200" align="right">
                                                                                                        <font color="#009900">應繳金額：</font>
                                                                                                    </td>
                                                                                                    <td align="center">
                                                                                                        @this.Model.viewModel.PAY_C_FEE.Value
                                                                                                    </td>
                                                                                                </tr>
                                                                                                @{
                                                                                                    if (diff_pay > 0)
                                                                                                    {
                                                                                                        <tr>
                                                                                                            <td width="200" align="right">
                                                                                                                <font color="#009900">已繳金額：</font>
                                                                                                            </td>
                                                                                                            <td align="center">
                                                                                                                <input type="checkbox" name="pay_cactual_new" value="1" />@Html.Raw("已繳清" + this.Model.viewModel.PAY_C_FEE.Value + "元")
                                                                                                                @{
                                                                                                                    if (this.Model.viewModel.PAY_POINT.Equals("C"))
                                                                                                                    {
                                                                                                                        <input type="hidden" name="pay_money_new" value="0" />
                                                                                                                        <input type="hidden" name="pay_money_chk" value="0" />
                                                                                                                    }
                                                                                                                }
                                                                                                            </td>
                                                                                                        </tr>
                                                                                                                    }
                                                                                                }
                                                                                            </tbody>
                                                                                                                    }
                }
            </table>
        </div>
        <div class="btnbar">
            @{
                if (this.Model.viewModel.CASE_BACK_MK.Equals("Y") && this.Model.viewModel.PAY_BACK_MK.Equals("N"))
                {
                    <div style="text-align: center">
                        <font color="red"><b>不處理退件不退費的案件</b></font>
                        <input type="submit" class="btn btn-gray" value="返回" onclick="RebackSearch();" />
                    </div>
                }
                else
                {
                    <div style="text-align: center">
                        <input class="btn btn-save" type="submit" name="Submit" value="確定" />
                        <input type="submit" class="btn btn-gray" value="返回" onclick="RebackSearch();" />
                    </div>
                }
            }
        </div>
                }
</div>