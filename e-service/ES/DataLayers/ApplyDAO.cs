using CTCB.Crypto;
using Dapper;
using ES.Action;
using ES.Commons;
using ES.Models;
using ES.Models.ChineseMedicineAPI;
using ES.Models.Entities;
using ES.Models.ViewModels;
using ES.Service.GSP1;
using ES.Services;
using ES.Utils;
using Omu.ValueInjecter;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Net.Mail;
using System.Reflection;
using System.Threading;
using System.Web;
using System.Web.Mvc;
using HppApi;
using Apply_001005ViewModel = ES.Models.ViewModels.Apply_001005ViewModel;
using Apply_001007ViewModel = ES.Models.ViewModels.Apply_001007ViewModel;
using Apply_001008FileModel = ES.Models.ViewModels.Apply_001008FileModel;
using Apply_001008FormModel = ES.Models.ViewModels.Apply_001008FormModel;
using Apply_001009ViewModel = ES.Models.ViewModels.Apply_001009ViewModel;
using Apply_001010ViewModel = ES.Models.ViewModels.Apply_001010ViewModel;
using Apply_001034_GoodsViewModel = ES.Models.ViewModels.Apply_001034_GoodsViewModel;
using Apply_001034ViewModel = ES.Models.ViewModels.Apply_001034ViewModel;
using Apply_001035FormModel = ES.Models.ViewModels.Apply_001035FormModel;
using Apply_001036ViewModel = ES.Models.ViewModels.Apply_001036ViewModel;
using Apply_001037ViewModel = ES.Models.ViewModels.Apply_001037ViewModel;
using Apply_001038FormModel = ES.Models.ViewModels.Apply_001038FormModel;
using Apply_001039FormModel = ES.Models.ViewModels.Apply_001039FormModel;
using Apply_010001FormModel = ES.Models.ViewModels.Apply_010001FormModel;
using Apply_010002AppDocModel = ES.Models.ViewModels.Apply_010002AppDocModel;
using Apply_010002FormModel = ES.Models.ViewModels.Apply_010002FormModel;
using Apply_011001FormModel = ES.Models.ViewModels.Apply_011001FormModel;
using Apply_011002FormModel = ES.Models.ViewModels.Apply_011002FormModel;
using Apply_011003FILEModel = ES.Models.ViewModels.Apply_011003FILEModel;
using Apply_011003FormModel = ES.Models.ViewModels.Apply_011003FormModel;
using Apply_011003SRVLSTModel = ES.Models.ViewModels.Apply_011003SRVLSTModel;
using Apply_011004FormModel = ES.Models.ViewModels.Apply_011004FormModel;
using Apply_011005FormModel = ES.Models.ViewModels.Apply_011005FormModel;
using Apply_011006FormModel = ES.Models.ViewModels.Apply_011006FormModel;
using Apply_011007FormModel = ES.Models.ViewModels.Apply_011007FormModel;
using Apply_011008FormModel = ES.Models.ViewModels.Apply_011008FormModel;
using Apply_011009FormModel = ES.Models.ViewModels.Apply_011009FormModel;
using Apply_012001FormModel = ES.Models.ViewModels.Apply_012001FormModel;
using System.ServiceModel.Dispatcher;
using DocumentFormat.OpenXml.EMMA;

namespace ES.DataLayers
{
    public class ApplyDAO : BaseAction
    {
        //protected static readonly ILog logger = LogUtils.GetLogger();

        private List<Apply_FileModel> fileList { get; set; }

        public int? GetApplyFee(string serviceId)
        {
            int? fee = 0;

            try
            {
                using (SqlConnection conn = DataUtils.GetConnection())
                {
                    var dictionary = new Dictionary<string, object>
                    {
                        { "@SRV_ID",serviceId }
                    };
                    var parameters = new DynamicParameters(dictionary);

                    string _sql = @"SELECT APP_FEE FROM SERVICE WHERE SRV_ID = @SRV_ID ";

                    var result = conn.Query<TblSERVICE>(_sql, parameters).FirstOrDefault();

                    fee = result.APP_FEE;
                    conn.Close();
                    conn.Dispose();
                }
            }
            catch (Exception ex)
            {
                logger.Warn(ex.Message, ex);
                throw new Exception("GetApp_ID failed:" + ex.Message, ex);
            }

            return fee;

        }

        #region 服務信箱

        /// <summary>
        /// 服務信箱        
        /// </summary>
        public void SendOpenMail(string phone, string email, string content, string service)
        {
            SessionModel sm = SessionModel.Get();

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                this.conn = conn;
                conn.Open();
                // 寄信LOG
                TblMAIL_LOG log2 = new TblMAIL_LOG();
                log2.MAIL = email;
                log2.SUBJECT = DateTime.Now.ToString("yyyyMMddHHmmss") + "衛福部人民線上系統服務(系統郵件)";
                log2.BODY =
                    "此封信為人民線上網站服務信箱，請勿直接回覆" +
                    "<br/>聯絡電話：" + phone +
                    "<br/>聯絡信箱：" + email +
                    "<br/>申辦服務分類：" + service +
                    "<br/>聯絡內容：" + content;
                log2.SEND_TIME = DateTime.Now;
                log2.SRV_ID = "000000";
                log2.Ref_Project = service;
                try
                {
                    if (ConfigModel.MailRevTest == "1")
                    {
                        MailMessage mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, log2.SUBJECT, log2.BODY);
                        mailMessage.IsBodyHtml = true;
                        CommonsServices.SendMail(mailMessage);
                        if (ConfigModel.MailRevIsTwo == "1")
                        {
                            var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                            foreach (var rec in recList)
                            {
                                MailMessage mailMessage2 = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, log2.SUBJECT, log2.BODY);
                                mailMessage2.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage2);
                            }
                        }
                    }
                    else
                    {
                        var mailrev = DataUtils.GetConfig("SERVICEMAIL"); // 系統收信服務信箱
                        if (!string.IsNullOrEmpty(mailrev))
                        {
                            foreach (var mailer in mailrev.ToSplit(','))
                            {
                                MailMessage mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, mailer, log2.SUBJECT, log2.BODY);
                                mailMessage.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage);
                                logger.Debug("SendOpenMail:" + mailer);
                                Thread.Sleep(100);//延遲0.1秒
                            }
                        }
                    }
                    sm.LastResultMessage = "寄信成功，再請等待處理，謝謝!";
                    // 寄信成功
                    log2.RESULT_MK = "Y";
                    Insert(log2);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    // 寄信失敗
                    sm.LastErrorMessage = "寄信失敗，請聯絡管理員";
                    log2.RESULT_MK = "N";
                    Insert(log2);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }
        #endregion

        public ApplyModel GetNewApplyEmptyRow(string SERVICE_ID, int UNIT_CD)
        {
            string APP_ID = GetApp_ID(SERVICE_ID);
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            ApplyModel result = null;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();

                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel apply = new ApplyModel();
                    apply.APP_ID = APP_ID;
                    apply.SRV_ID = SERVICE_ID;
                    apply.SRC_SRV_ID = SERVICE_ID;
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.IDN = UserInfo.IDN;
                    apply.UNIT_CD = UNIT_CD;
                    apply.FLOW_CD = "1";
                    apply.APP_EXT_DATE = this.GetNTFD(SERVICE_ID);
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    base.Insert(apply);
                    tran.Commit();

                    apply = new ApplyModel();
                    apply.APP_ID = APP_ID;
                    result = GetRow(apply);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("GetNewApplyEmptyRow failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public void DeleteApplyEmptyRow(string APP_ID)
        {
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();

                    this.Tran(conn, tran);
                    ApplyModel applyWhere = new ApplyModel();
                    applyWhere.APP_ID = APP_ID;
                    ApplyModel apply = new ApplyModel();
                    apply.DEL_MK = "Y";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update(apply, applyWhere);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("DeleteApplyEmptyRow failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        #region Tran
        /// <summary>
        /// 資料庫連線
        /// </summary>
        /// <param name="conn"></param>
        /// <param name="tran"></param>
        public void Tran(SqlConnection conn, SqlTransaction tran)
        {
            this.conn = conn;
            this.tran = tran;
        }
        #endregion

        #region 取號

        /// <summary>
        /// 修正序號不合問題
        /// </summary>
        /// <param name="SRV_ID"></param>
        /// <param name="dr1"></param>
        /// <param name="conn"></param>
        /// <param name="tran"></param>
        public void GetApp_ID_Fix(string SRV_ID, DataRow dr1, SqlConnection conn, SqlTransaction tran)
        {
            //s_Cmd3b.Parameters.Add("SRV_DATE", SqlDbType.VarChar).Value = dr1["SRV_DATE"]; //yyyyMMdd(112)
            //s_Cmd3b.Parameters.Add("SRL_NO", SqlDbType.Int).Value = iSRL_NO;
            int iSRL_NO = Int32.Parse(dr1["SRL_NO"].ToString());
            string s_SQL_3c = @"SELECT SRV_ID,CONVERT(varchar, SRV_DATE, 112) SRV_DATE, SRL_NO FROM APPLY_SERIAL2 WHERE SRV_ID = @SRV_ID "; //取得目前資料
            SqlCommand s_Cmd3c = new SqlCommand(s_SQL_3c, conn, tran);
            s_Cmd3c.Parameters.Clear();
            s_Cmd3c.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = dr1["SRV_ID"];
            DataTable dt3c = new DataTable();
            dt3c.Load(s_Cmd3c.ExecuteReader());
            if (dt3c.Rows.Count > 0)
            {
                //有資料，修改
                string u_SQL = @"UPDATE APPLY_SERIAL2 SET SRV_DATE= CONVERT(DATE, @SRV_DATE, 112) ,SRL_NO=@SRL_NO, MTIME=GETDATE() WHERE SRV_ID = @SRV_ID";
                SqlCommand u_Cmd = new SqlCommand(u_SQL, conn, tran);
                u_Cmd.Parameters.Clear();
                u_Cmd.Parameters.Add("SRV_DATE", SqlDbType.VarChar).Value = dr1["SRV_DATE"].ToString();
                u_Cmd.Parameters.Add("SRL_NO", SqlDbType.Int).Value = iSRL_NO;
                u_Cmd.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                u_Cmd.ExecuteNonQuery();
            }
            else
            {
                //沒資料，新增
                string i_SQL = @"INSERT INTO APPLY_SERIAL2 (SRV_ID, SRV_DATE, SRL_NO, MTIME) VALUES (@SRV_ID, CONVERT(DATE, @SRV_DATE, 112), @SRL_NO ,GETDATE())";
                SqlCommand i_Cmd = new SqlCommand(i_SQL, conn, tran);
                i_Cmd.Parameters.Clear();
                i_Cmd.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                i_Cmd.Parameters.Add("SRV_DATE", SqlDbType.VarChar).Value = dr1["SRV_DATE"].ToString();
                i_Cmd.Parameters.Add("SRL_NO", SqlDbType.Int).Value = iSRL_NO;
                i_Cmd.ExecuteNonQuery();
            }
        }

        /// <summary>
        /// 取得序號
        /// </summary>
        /// <param name="SRV_ID"></param>
        /// <returns></returns>
        public string GetApp_ID(string SRV_ID)
        {
            string app_id = null;
            //string s_SrvDate = DateTime.Now.ToString("yyyyMMdd");
            DataRow dr1 = null;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();

                    //修正取新序號問題，舊資料判斷 (舊資料最大值)
                    bool flag_ok = false;
                    string s_SQL_3 = @"SELECT top 1 SRV_ID ,substring(app_id,1,8) SRV_DATE ,substring(app_id,15,4) SRL_NO FROM APPLY where SRV_ID=@SRV_ID order by 2 desc,3 desc";
                    SqlCommand s_Cmd3 = new SqlCommand(s_SQL_3, conn, tran);
                    s_Cmd3.Parameters.Clear();
                    s_Cmd3.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                    DataTable dt3 = new DataTable();
                    dt3.Load(s_Cmd3.ExecuteReader());
                    if (dt3.Rows.Count > 0)
                    {
                        //有資料
                        dr1 = dt3.Rows[0];
                        int iSRL_NO = Int32.Parse(dr1["SRL_NO"].ToString());
                        string s_SQL_3b = @"SELECT 'X' FROM APPLY_SERIAL2 WHERE SRV_DATE = convert(date,@SRV_DATE,112) AND SRV_ID = @SRV_ID AND SRL_NO=@SRL_NO";
                        SqlCommand s_Cmd3b = new SqlCommand(s_SQL_3b, conn, tran);
                        s_Cmd3b.Parameters.Clear();
                        s_Cmd3b.Parameters.Add("SRV_DATE", SqlDbType.VarChar).Value = dr1["SRV_DATE"]; //yyyyMMdd(112)
                        s_Cmd3b.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = dr1["SRV_ID"];
                        s_Cmd3b.Parameters.Add("SRL_NO", SqlDbType.Int).Value = iSRL_NO;
                        DataTable dt3b = new DataTable();
                        dt3b.Load(s_Cmd3b.ExecuteReader());
                        //合理-為同一筆資料
                        if (dt3b.Rows.Count > 0) { flag_ok = true; }
                        //異常-進行修正
                        if (!flag_ok) { GetApp_ID_Fix(SRV_ID, dr1, conn, tran); }
                    }

                    //當日有序號
                    string u_SQL_lock1 = @"UPDATE APPLY_SERIAL2 SET MTIME=GETDATE() WHERE SRV_DATE = CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                    SqlCommand u_Cmd_lock1 = new SqlCommand(u_SQL_lock1, conn, tran);
                    u_Cmd_lock1.Parameters.Clear();
                    u_Cmd_lock1.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                    u_Cmd_lock1.ExecuteNonQuery();
                    //當日有序號
                    string s_SQL_1 = @"SELECT SRL_NO,CONVERT(varchar, GETDATE(), 112) SRV_DATE FROM APPLY_SERIAL2 WHERE SRV_DATE = CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                    SqlCommand s_Cmd1 = new SqlCommand(s_SQL_1, conn, tran);
                    s_Cmd1.Parameters.Clear();
                    s_Cmd1.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                    DataTable dt1 = new DataTable();
                    dt1.Load(s_Cmd1.ExecuteReader());
                    if (dt1.Rows.Count > 0)
                    {
                        //計算序號+1
                        string u_SQL_1 = @"UPDATE APPLY_SERIAL2 SET SRL_NO = SRL_NO + 1 WHERE SRV_DATE = CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                        SqlCommand u_Cmd1 = new SqlCommand(u_SQL_1, conn, tran);
                        u_Cmd1.Parameters.Clear();
                        u_Cmd1.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                        u_Cmd1.ExecuteNonQuery();
                        //(重新取得)
                        DataTable dt1b = new DataTable();
                        dt1b.Load(s_Cmd1.ExecuteReader());
                        dr1 = dt1b.Rows[0];
                        app_id = string.Format("{0}{1}{2}", dr1["SRV_DATE"], SRV_ID, ((int)dr1["SRL_NO"]).ToString("D4"));
                        tran.Commit();
                    }
                    if (string.IsNullOrEmpty(app_id))
                    {
                        //非當日有序號
                        string u_SQL_lock2 = @"UPDATE APPLY_SERIAL2 SET MTIME=GETDATE() WHERE SRV_DATE != CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                        SqlCommand u_Cmd_lock2 = new SqlCommand(u_SQL_lock2, conn, tran);
                        u_Cmd_lock2.Parameters.Clear();
                        u_Cmd_lock2.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                        u_Cmd_lock2.ExecuteNonQuery();
                        //非當日有序號
                        string s_SQL_2 = @"SELECT SRL_NO,CONVERT(varchar, GETDATE(), 112) SRV_DATE FROM APPLY_SERIAL2 WHERE SRV_DATE != CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                        SqlCommand s_Cmd2 = new SqlCommand(s_SQL_2, conn, tran);
                        s_Cmd2.Parameters.Clear();
                        s_Cmd2.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                        DataTable dt2 = new DataTable();
                        dt2.Load(s_Cmd2.ExecuteReader());
                        if (dt2.Rows.Count > 0)
                        {
                            //換日重新計算,序號歸1
                            string u_SQL_2 = @"UPDATE APPLY_SERIAL2 SET SRL_NO=1,SRV_DATE=CONVERT(DATE, GETDATE()) WHERE SRV_DATE != CONVERT(DATE, GETDATE()) AND SRV_ID = @SRV_ID";
                            SqlCommand u_Cmd2 = new SqlCommand(u_SQL_2, conn, tran);
                            u_Cmd2.Parameters.Clear();
                            u_Cmd2.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                            u_Cmd2.ExecuteNonQuery();
                            //(重新取得)
                            DataTable dt1b = new DataTable();
                            dt1b.Load(s_Cmd1.ExecuteReader());
                            dr1 = dt1b.Rows[0];
                            app_id = string.Format("{0}{1}{2}", dr1["SRV_DATE"], SRV_ID, ((int)dr1["SRL_NO"]).ToString("D4"));
                            tran.Commit();
                        }
                    }
                    if (string.IsNullOrEmpty(app_id))
                    {
                        //完全無序號-新增一筆 
                        string i_SQL = @"INSERT INTO APPLY_SERIAL2 (SRV_ID, SRV_DATE, SRL_NO, MTIME) VALUES (@SRV_ID, CONVERT(DATE, GETDATE()), 1 ,GETDATE())";
                        SqlCommand i_Cmd = new SqlCommand(i_SQL, conn, tran);
                        i_Cmd.Parameters.Clear();
                        i_Cmd.Parameters.Add("SRV_ID", SqlDbType.VarChar).Value = SRV_ID;
                        i_Cmd.ExecuteNonQuery();
                        //(重新取得)
                        DataTable dt1c = new DataTable();
                        dt1c.Load(s_Cmd1.ExecuteReader());
                        dr1 = dt1c.Rows[0];
                        app_id = string.Format("{0}{1}{2}", dr1["SRV_DATE"], SRV_ID, ((int)dr1["SRL_NO"]).ToString("D4"));
                        tran.Commit();
                    }
                }
                catch (Exception ex)
                {
                    logger.Error(string.Concat("#GetApp_ID failed:", ex.Message), ex);
                    tran.Rollback();
                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return app_id;
        }

        /// <summary>
        /// 取得序號
        /// </summary>
        /// <param name="SRV_ID"></param>
        /// <returns></returns>
        [Obsolete]
        public string GetApp_ID_OLD1(string SRV_ID)
        {
            string App_ID = "";
            string APP_TIME = DateTime.Now.ToString("yyyyMMdd"); //時間
            App_ID = APP_TIME + SRV_ID + "0001"; //初始值
            //try {} catch (Exception ex) { throw new Exception("GetApp_ID failed:" + ex.Message, ex); }
            var dictionary = new Dictionary<string, object>
                    {
                        { "@SRV_ID", SRV_ID },
                        { "@APP_TIME",APP_TIME }
                    };
            var parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select max(APP_ID) as APP_ID 
    from  APPLY 
    where 1 = 1 
    and SRV_ID = @SRV_ID
    and convert(varchar, APP_TIME, 112) = @APP_TIME ";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                ApplyModel result = conn.Query<ApplyModel>(_sql, parameters).FirstOrDefault();
                //查無值
                if (result == null) { return App_ID; }
                //查無值
                if (result.APP_ID.TONotNullString() == "") { return App_ID; }
                //有值+1
                App_ID = (result.APP_ID.TOInt64() + 1).ToString();
                conn.Close();
                conn.Dispose();
            }
            return App_ID;
        }

        #endregion

        #region 取檔案流水號

        public int GetFileNo(string APP_ID)
        {
            int fileNo = 1; //初始值

            //try { } catch (Exception ex) { throw new Exception("GetFileNo failed:" + ex.Message, ex); }

            var dictionary = new Dictionary<string, object>
                {
                    { "@APP_ID", APP_ID }
                };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"SELECT MAX(FILE_NO) AS FILE_NO
                                    FROM   APPLY_FILE
                                    WHERE  APP_ID=@APP_ID";
                var result = conn.Query<Apply_FileModel>(_sql, parameters).FirstOrDefault();
                //查無值
                if (result == null) { return fileNo; }
                //查無值
                if (!result.FILE_NO.HasValue) { return fileNo; }
                //有值 + 1
                fileNo = (result.FILE_NO.Value + 1);
                conn.Close();
                conn.Dispose();
            }
            return fileNo;
        }

        #endregion

        #region 新收案件寄信通知

        /// <summary>
        /// 新收案件寄信通知        
        /// </summary>
        /// <param name="ACC_NAM">申請人姓名</param>
        /// <param name="Mail">信箱</param>
        /// <param name="APP_ID">案件編號</param>
        /// <param name="Srv_Nam">申請案件名稱</param>
        /// <param name="Srv_ID">申請案件編號</param>
        /// <param name="ISSEND">預設true，是否通知承辦人</param>
        public void SendMail_New(string ACC_NAM, string Mail, string APP_ID, string Srv_Nam, string Srv_ID, string CustomMailBody = "", bool ISSEND = true)
        {
            ShareDAO dao = new ShareDAO();
            MailMessage mailMessage;
            var Url = new UrlHelper(HttpContext.Current.Request.RequestContext);

            string notReplyMsg = string.Empty;
            string notReplyMsg2 = string.Empty;
            if (Srv_ID == "006001")
            {
                notReplyMsg = "P.S.本郵件係系統自動發信，請勿直接回信；如有相關疑問，請於平日上午9時至下午5時，逕向本部國民年金監理會洽詢（電話：02-3343-7136）。";
            }
            else if (Srv_ID == "041001")
            {
                notReplyMsg = "P.S.本郵件係系統自動發信，請勿直接回信；如有相關疑問，請於平日上午9時至下午5時，逕向本部全民健康保險爭議審議會洽詢（電話：02-8590-7222）。";
            }
            else if (Srv_ID == "040001")
            {
                notReplyMsg = "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部法規會洽詢。";
            }
            else
            {
                notReplyMsg = "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。";
            }
            #region 申請人
            string urlBefore = string.Empty;
            string urlAfter = string.Empty;
            // 信件標題
            string subject = Srv_Nam + "申請作業，案件編號﹕" + APP_ID + " 申請通知";
            // 信件內容
            string MailBody = "<table align=\"left\" style=\"width:90%;\">";
            if (Srv_ID == "040001")
            {
                MailBody += " <tr><th align=\"left\">" + ACC_NAM + "先生/女士，您好:</th></tr>";
            }
            else
            {
                MailBody += " <tr><th align=\"left\">" + ACC_NAM + "，您好:</th></tr>";
            }
            // 客製化信件內容
            switch (Srv_ID)
            {
                #region 社工司
                case "011002":
                    //信封title不同
                    MailBody += " <tr><td>　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += " 本項目尚有1件紙本文件需要繳交（包括郵局匯票500元１紙，戶名：衛生福利部。）";
                    MailBody += "，提醒您於1週內以掛號郵遞方式寄至「衛生福利部社會救助及社工司」(地址：115204 臺北市南港區忠孝東路六段488號)，並於信封左下角註明「申請核發專科社會工作師證書」、申請人姓名及連絡電話。俟本部收訖後將據以辦理您的申請案件。</td> </tr>";
                    break;
                case "011004":
                    //信封title不同
                    MailBody += " <tr><td>　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    //MailBody += " 本項目尚有1件紙本文件需要繳交（包括郵局匯票500元１紙，戶名：衛生福利部。）";
                    //MailBody += "，提醒您於5個工作天以掛號郵遞方式寄至「衛生福利部社會救助及社工司」(地址：115204 臺北市南港區忠孝東路六段488號)待收訖紙本文件後，將會據以辦理您的申請案件，謝謝。</td> </tr>";
                    MailBody += "，將會據以辦理您的申請案件，謝謝。</td> </tr>";
                    MailBody += "<tr><td>";
                    MailBody += "衛生福利部社會救助及社工司";
                    MailBody += "</td></tr>";
                    break;
                case "011005":
                    MailBody += " <tr><td>　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += " 本項目尚有1件紙本文件需要繳交（包括郵局匯票500元１紙，戶名：衛生福利部。）";
                    MailBody += "，提醒您於1週內以掛號郵遞方式寄至「衛生福利部社會救助及社工司」(地址：115204 臺北市南港區忠孝東路六段488號)，並於信封左下角註明「申請補發專科社會工作師證書」、申請人姓名及連絡電話。俟本部收訖後將據以辦理您的申請案件。</td> </tr>";
                    break;
                case "011006":
                    MailBody += " <tr><td>　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += " 本項目尚有1件紙本文件需要繳交（包括郵局匯票500元１紙，戶名：衛生福利部。）";
                    MailBody += "，提醒您於1週內以掛號郵遞方式寄至「衛生福利部社會救助及社工司」(地址：115204 臺北市南港區忠孝東路六段488號)，並於信封左下角註明「申請換發專科社會工作師證書」、申請人姓名及連絡電話。俟本部收訖後將據以辦理您的申請案件。</td> </tr>";
                    break;

                case "011007":
                    MailBody += "<tr><td>";
                    MailBody += "　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += "本項目尚有1件紙本資料需要繳交（包括郵局匯票新臺幣500元１紙，戶名：衛生福利部）";
                    MailBody += "，提醒您於五個工作天以掛號郵遞方式寄至「衛生福利部社會救助及社工司」";
                    MailBody += "(地址：115204 臺北市南港區忠孝東路六段488號)。待收訖紙本文件後，將會據以辦理您的申請案件，謝謝。";
                    MailBody += "</td></tr>";
                    MailBody += "<tr><td>";
                    MailBody += "衛生福利部社會救助及社工司";
                    MailBody += "</td></tr>";
                    break;
                case "011008":
                    MailBody += "<tr><td>";
                    MailBody += "　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += "本項目尚有2件紙本資料需要繳交（包括1.郵局匯票新臺幣500元１紙，戶名：衛生福利部。2.社會工作師證書正本）";
                    MailBody += "，提醒您於5個工作天以掛號郵遞方式寄至「衛生福利部社會救助及社工司」";
                    MailBody += "(地址：115204 臺北市南港區忠孝東路六段488號)。待收訖紙本文件後，將會據以辦理您的申請案件，謝謝。";
                    MailBody += "</td></tr>";
                    MailBody += "<tr><td>";
                    MailBody += "衛生福利部社會救助及社工司";
                    MailBody += "</td></tr>";
                    break;
                case "011009":
                    MailBody += "<tr><td>";
                    MailBody += "　　您所提交的" + Srv_Nam + "申請，已完成系統資料填答及上傳流程。";
                    MailBody += "本項目尚有1件紙本資料需要繳交（包括郵局匯票新臺幣500元１紙，戶名：衛生福利部）";
                    MailBody += "，提醒您於5個工作天以掛號郵遞方式寄至「衛生福利部社會救助及社工司」";
                    MailBody += "(地址：115204 臺北市南港區忠孝東路六段488號)。待收訖紙本文件後，將會據以辦理您的申請案件，謝謝。";
                    MailBody += "</td></tr>";
                    MailBody += "<tr><td>";
                    MailBody += "衛生福利部社會救助及社工司";
                    MailBody += "</td></tr>";
                    break;

                #endregion

                #region 醫事司
                case "001005":
                    MailBody += " <tr><td>您醫事人員或公共衛生師證書補(換)發，已完成系統資料填答及上傳流程，繳納規費後，將盡速辦理您的申辦案件，謝謝。</td> </tr>";
                    break;
                case "001007":
                    MailBody += " <tr><td>您專科醫師證書補(換)發，已完成系統資料填答及上傳流程，繳納規費後，將盡速辦理您的申辦案件，謝謝。</td> </tr>";
                    break;
                case "001008":
                    MailBody += string.Format(" <tr><td>您{0}，已完成系統資料填答及上傳流程，繳納規費後，將盡速辦理您的申辦案件，謝謝。</td> </tr>", Srv_Nam);
                    break;
                case "001036":
                    MailBody += "<tr><td>您於" + DateTime.Now.ToTwNowDate() + "申辦之" + Srv_Nam + "</td></tr>";
                    MailBody += "<tr><td>案件申請編號：" + APP_ID + "</td></tr>";
                    MailBody += "<tr><td>現在進度為'新收案件'</td></tr>";
                    MailBody += "<tr><td>特此通知。感謝您使用衛生福利部線上申辦系統 </td></tr>";
                    break;
                case "001035":
                    var today = HelperUtil.DateTimeToTwString(DateTime.Now);
                    string url = ConfigModel.NoticeMailUrl;
                    MailBody += "<tr><td>您於民國" + today.Substring(0, 3) + "年" + today.Substring(4, 2) + "月" + today.Substring(7, 2) + "日申辦之非感染性人體器官、組織及細胞進出口申請作業</td> </tr>";
                    MailBody += "<tr><td>申請編號：<a href='" + url + "/Apply_001035/AppDoc?APP_ID=" + APP_ID + "'>" + APP_ID + "</a><br/>現在進度為'新收案件'</td> </tr>";
                    MailBody += "<tr><td>特此通知。感謝您使用衛生福利部線上申辦系統</td> </tr>";
                    MailBody += "<tr><td>衛生福利部醫事司敬上</td> </tr>";
                    //MailBody += "<tr><td>PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。</td> </tr>";
                    MailBody += "<tr><td>※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000</td> </tr>";
                    MailBody += "<tr><td>115209 臺北市南港區昆陽街161-2號</td> </tr>";
                    MailBody += "<tr><td>※移植目的承辦單位：衛生福利部醫事司(02)8590-6666</td> </tr>";
                    MailBody += "<tr><td>115204 臺北市南港區忠孝東路六段488號</td> </tr>";

                    //backDao.SendMail(string.IsNullOrWhiteSpace(form.TAX_ORG_EMAIL) ? sm.UserInfo.Member.MAIL : form.TAX_ORG_EMAIL, subject, MailBody);
                    //MailBody += "<tr><td>您於" + DateTime.Now.ToTwNowDate() + "申辦之" + Srv_Nam + "</td></tr>";
                    //MailBody += "<tr><td>案件申請編號：" + APP_ID + "</td></tr>";
                    //MailBody += "<tr><td>現在進度為'新收案件'</td></tr>";
                    //MailBody += "<tr><td>特此通知。感謝您使用衛生福利部線上申辦系統 </td></tr>";
                    break;

                #endregion

                #region 中醫藥司

                #endregion

                #region 檔案應用申請
                case "010001":
                    urlBefore = HttpContext.Current.Request.Url.Scheme + @"://" + HttpContext.Current.Request.Url.Authority;
                    urlAfter = Url.Action("Check", new { controller = "EMailCheck", APP_ID });
                    MailBody += " <tr><td>您所提交的檔案應用申請，已完成系統資料填答及上傳流程，請點選確認申辦回覆連結後(連結有效期限為24小時)，將儘速辦理您的申請案件，謝謝。</td> </tr>";
                    //MailBody += " <tr><td>確認申辦連結為:" + System.Web.HttpUtility.UrlEncode(urlBefore + urlAfter.Substring(1, urlAfter.Length - 1)) + "</td> </tr>";
                    MailBody += " <tr><td>確認申辦連結為:<a href=\"" + urlBefore + urlAfter + "\">請點選</a></td> </tr>";
                    MailBody += " <tr><td>國民健康署秘書室敬上</td> </tr>";
                    break;
                case "012001":
                    urlBefore = HttpContext.Current.Request.Url.Scheme + @"://" + HttpContext.Current.Request.Url.Authority;
                    urlAfter = Url.Action("Check", new { controller = "EMailCheck", APP_ID });
                    MailBody += " <tr><td>您所提交的檔案應用申請，已完成系統資料填答及上傳流程，請點選確認申辦回覆連結後(連結有效期限為24小時)，將儘速辦理您的申請案件，謝謝。</td> </tr>";
                    //MailBody += " <tr><td>確認申辦連結為:" + System.Web.HttpUtility.UrlEncode(urlBefore + urlAfter.Substring(1, urlAfter.Length - 1)) + "</td> </tr>";
                    MailBody += " <tr><td>確認申辦連結為:<a href=\"" + urlBefore + urlAfter + "\">請點選</a></td> </tr>";
                    MailBody += " <tr><td>衛生福利部秘書處敬上</td> </tr>";
                    break;
                #endregion
                case "040001":
                    MailBody += " <tr><td>您申請" + Srv_Nam + "，已完成系統資料填寫及上傳程序。</td> </tr>";
                    break;
                case "041001":
                    MailBody += " <tr><td>您申請「" + Srv_Nam + "」服務，已完成資料填寫及相關文件上傳，本部將儘速完成案件申請程序，謝謝。</td> </tr>";
                    break;
                case "006001":
                    MailBody += " <tr><td>您申請「" + Srv_Nam + "」服務，已完成資料填寫及相關文件上傳，本部將儘速完成案件申請程序，謝謝。</td> </tr>";
                    break;
                default:
                    MailBody += " <tr><td>您申請" + Srv_Nam + "，已完成系統資料填答及上傳程序，將儘速辦理您的申請案件，謝謝。</td> </tr>";
                    break;
            }

            //補加系統自動發信，請勿直接回覆訊息文字
            MailBody += "   <tr><td><br>" + notReplyMsg + "</td></tr>";
            MailBody += "</table>";

            // 中醫藥司會取代此段
            if (CustomMailBody != "")
            {
                MailBody = CustomMailBody;
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                this.conn = conn;
                conn.Open();

                // 寄信LOG
                TblMAIL_LOG log = new TblMAIL_LOG();
                log.MAIL = Mail;
                log.SUBJECT = subject;
                log.BODY = MailBody;
                log.SEND_TIME = DateTime.Now;
                log.SRV_ID = Srv_ID;

                try
                {
                    if (ConfigModel.MailRevTest == "1")
                    {
                        mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, subject, MailBody);
                        mailMessage.IsBodyHtml = true;
                        CommonsServices.SendMail(mailMessage);
                        if (ConfigModel.MailRevIsTwo == "1")
                        {
                            var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                            foreach (var rec in recList)
                            {
                                mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, subject, MailBody);
                                mailMessage.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage);
                            }
                        }
                    }
                    else
                    {
                        mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, Mail, subject, MailBody);
                        mailMessage.IsBodyHtml = true;
                        CommonsServices.SendMail(mailMessage);
                    }

                    // 寄信成功
                    log.RESULT_MK = "Y";
                    Insert(log);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    logger.Error("SendMail_New failed:" + ex.TONotNullString());
                    // 寄信失敗
                    log.RESULT_MK = "N";
                    Insert(log);
                }

                #endregion

                if (ISSEND)
                {
                    #region 承辦人

                    IList<SpecialistMailModel> mailList = dao.getSpecialist(Srv_ID);
                    if (mailList == null) { return; }
                    foreach (SpecialistMailModel item in mailList)
                    {
                        string s_subject_1A = "{0}申請作業，案件編號﹕{1} 申請通知";
                        string s_Mail_1A = string.Empty;
                        subject = string.Format(s_subject_1A, Srv_Nam, APP_ID);
                        if (Srv_ID == "040001")
                        {
                            MailBody = string.Format("{0}先生/女士，您好：<br/>", item.NAME);
                        }
                        else
                        {
                            MailBody = string.Format("{0} 您好：<br/>", item.NAME);
                        }

                        // 客製化信件內容
                        switch (Srv_ID)
                        {
                            // 國民年金、全民健康
                            case "006001":
                                s_Mail_1A = "您有{0}申請，案件編號﹕{1}，請儘速處理!!<br/>";
                                MailBody += string.Format(s_Mail_1A, Srv_Nam, APP_ID);
                                break;
                            case "041001":
                                s_Mail_1A = "您有「{0}」線上申辧案件，案件編號：{1}，請儘速處理!!<br/>";
                                MailBody += string.Format(s_Mail_1A, Srv_Nam, APP_ID);
                                break;
                            case "040001":
                                s_Mail_1A = "您有{0}，案件編號：{1}，待處理!!<br/>";
                                MailBody += string.Format(s_Mail_1A, Srv_Nam, APP_ID);
                                break;
                            default:
                                s_Mail_1A = "您有{0}申請，案件編號﹕{1}，待處理!!<br/>";
                                MailBody += string.Format(s_Mail_1A, Srv_Nam, APP_ID);
                                break;
                        }
                        if (Srv_ID == "040001")
                        {
                            notReplyMsg2 = "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部資訊處洽詢。";
                        }
                        else
                        {
                            notReplyMsg2 = "P.S.本郵件係系統自動發信，請勿直接回信。";
                        }

                        MailBody += string.Format("<br/>{0}<br/>", notReplyMsg2);

                        // 寄信LOG
                        TblMAIL_LOG log2 = new TblMAIL_LOG();
                        log2.MAIL = item.EMAIL;
                        log2.SUBJECT = subject;
                        log2.BODY = MailBody;
                        log2.SEND_TIME = DateTime.Now;
                        log2.SRV_ID = Srv_ID;
                        try
                        {
                            if (ConfigModel.MailRevTest == "1")
                            {
                                mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, subject, MailBody);
                                mailMessage.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage);
                                if (ConfigModel.MailRevIsTwo == "1")
                                {
                                    var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                                    foreach (var rec in recList)
                                    {
                                        mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, subject, MailBody);
                                        mailMessage.IsBodyHtml = true;
                                        CommonsServices.SendMail(mailMessage);
                                    }
                                }
                            }
                            else
                            {
                                mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, item.EMAIL, subject, MailBody);
                                mailMessage.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage);
                            }

                            // 寄信成功
                            log2.RESULT_MK = "Y";
                            Insert(log2);
                        }
                        catch (Exception ex)
                        {
                            logger.Warn(ex.Message, ex);
                            // 寄信失敗
                            log2.RESULT_MK = "N";
                            Insert(log2);
                        }
                    }
                    #endregion
                }

                conn.Close();
                conn.Dispose();
            }
        }
        #endregion

        #region 新收案件寄信通知(承辦人)

        /// <summary>
        /// 新收案件寄信通知        
        /// </summary>
        /// <param name="ACC_NAM">申請人姓名</param>
        /// <param name="Mail">信箱</param>
        /// <param name="APP_ID">案件編號</param>
        /// <param name="Srv_Nam">申請案件名稱</param>
        /// <param name="Srv_ID">申請案件編號</param>
        /// <param name="ISSEND">預設true，是否通知承辦人</param>
        public void SendMail_Proc(string ACC_NAM, string Mail, string APP_ID, string Srv_Nam, string Srv_ID, string CustomMailBody = "", bool ISSEND = true)
        {
            ShareDAO dao = new ShareDAO();
            MailMessage mailMessage;
            var Url = new UrlHelper(HttpContext.Current.Request.RequestContext);

            string notReplyMsg = "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。";
            string subject = "";
            string MailBody = "";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                this.conn = conn;
                conn.Open();

                IList<SpecialistMailModel> mailList = dao.getSpecialist(Srv_ID);
                if (mailList == null) { return; }
                foreach (SpecialistMailModel item in mailList)
                {
                    string s_subject_1A = "{0}申請作業，案件編號﹕{1} 申請通知";
                    subject = string.Format(s_subject_1A, Srv_Nam, APP_ID);

                    MailBody = string.Format("{0} 您好：<br/>", item.NAME);
                    // 客製化信件內容
                    switch (Srv_ID)
                    {
                        default:
                            string s_Mail_1A = "您有{0}申請，案件編號﹕{1}，待處理!!<br/>";
                            MailBody += string.Format(s_Mail_1A, Srv_Nam, APP_ID);
                            break;
                    }

                    MailBody += string.Format("<br/>{0}<br/>", notReplyMsg);

                    // 寄信LOG
                    TblMAIL_LOG log2 = new TblMAIL_LOG();
                    log2.MAIL = item.EMAIL;
                    log2.SUBJECT = subject;
                    log2.BODY = MailBody;
                    log2.SEND_TIME = DateTime.Now;
                    log2.SRV_ID = Srv_ID;
                    try
                    {
                        if (ConfigModel.MailRevTest == "1")
                        {
                            mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, subject, MailBody);
                            mailMessage.IsBodyHtml = true;
                            CommonsServices.SendMail(mailMessage);
                            if (ConfigModel.MailRevIsTwo == "1")
                            {
                                var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                                foreach (var rec in recList)
                                {
                                    mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, subject, MailBody);
                                    mailMessage.IsBodyHtml = true;
                                    CommonsServices.SendMail(mailMessage);
                                }
                            }
                        }
                        else
                        {
                            mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, item.EMAIL, subject, MailBody);
                            mailMessage.IsBodyHtml = true;
                            CommonsServices.SendMail(mailMessage);
                        }

                        // 寄信成功
                        log2.RESULT_MK = "Y";
                        Insert(log2);
                    }
                    catch (Exception ex)
                    {
                        logger.Warn(ex.Message, ex);
                        // 寄信失敗
                        log2.RESULT_MK = "N";
                        Insert(log2);
                    }
                }
                conn.Close();
                conn.Dispose();
            }

        }

        #endregion 

        #region 補件案件寄信通知

        /// <summary>
        /// 補件案件寄信通知        
        /// </summary>
        /// <param name="ACC_NAM">申請人姓名</param>
        /// <param name="Mail">信箱</param>
        /// <param name="APP_ID">案件編號</param>
        /// <param name="Srv_Nam">申請案件名稱</param>
        /// <param name="Srv_ID">申請案件編號</param>
        /// <param name="Count">件數</param>
        /// <param name="ISSEND">預設true，是否通知承辦人</param>
        /// <param name="CustomMailBody">中醫藥司會取代此段</param>
        public void SendMail_Update(string ACC_NAM, string Mail, string APP_ID, string Srv_Nam, string Srv_ID, string Count, string CustomMailBody = "", bool ISSEND = true, bool ISBACK = false)
        {
            ShareDAO dao = new ShareDAO();
            MailMessage mailMessage;
            string notReplyMsg = "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。";

            #region 申請人

            // 信件標題
            string subject = Srv_Nam + "申請作業，案件編號﹕" + APP_ID + " 補件完成通知";
            // 信件內容
            string MailBody = "<table align=\"left\" style=\"width:90%;\">";
            MailBody += " <tr><th align=\"left\">" + ACC_NAM + "，您好:</th></tr>";
            // 客製化信件內容
            switch (Srv_ID)
            {
                #region 社工司
                case "011002":
                case "011005":
                case "011006":
                    MailBody += " <tr><td>您申請" + Srv_Nam + "，已完成資料補件，將盡速辦理您的申辦案件，謝謝。</td> </tr>";
                    break;
                #endregion

                #region 醫藥司
                case "001005":
                case "001007":
                case "001009":
                case "001010":
                case "001036":
                    MailBody += " <tr><td>您申請" + Srv_Nam + "，已完成資料補件，將盡速辦理您的申辦案件，謝謝。</td> </tr>";
                    break;
                #endregion

                default:
                    MailBody += " <tr><td>您申請" + Srv_Nam + "，已完成資料補件，將盡速辦理您的申辦案件，謝謝。</td> </tr>";
                    break;
            }
            switch (Srv_ID)
            {
                case "001036":
                    MailBody += "<tr><td>衛生福利部護理及健康照護司敬上<br/><br/></td> </tr>";
                    break;
                case "005001":
                case "005002":
                case "005003":
                case "005004":
                case "005005":
                case "005013":
                case "005014":
                    MailBody += "<tr><td>衛生福利部中醫藥司敬上<br/><br/></td></tr>";
                    break;
                case "010001":
                case "010002":
                    MailBody += "<tr><td>衛生福利部國民健康署敬上<br/><br/></td> </tr>";
                    break;
                case "011001":
                case "011002":
                case "011003":
                case "011004":
                case "011005":
                case "011006":
                case "011007":
                case "011008":
                case "011009":
                    MailBody += "<tr><td>衛生福利部社會救助及社工司<br/><br/></td></tr>";
                    break;
                case "012001":
                    MailBody += "<tr><td>衛生福利部秘書處敬上<br/><br/></td></tr>";
                    break;
                default:
                    MailBody += "<tr><td>衛生福利部醫事司敬上<br/><br/></td></tr>";
                    break;
            }
            MailBody += " <tr><td><br>" + notReplyMsg + "</td></tr>";
            MailBody += "</table>";

            // 中醫藥司會取代此段
            if (CustomMailBody != "")
            {
                MailBody = CustomMailBody;
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                this.conn = conn;
                conn.Open();
                // 寄信LOG
                TblMAIL_LOG log = new TblMAIL_LOG();
                log.MAIL = Mail;
                log.SUBJECT = subject;
                log.BODY = MailBody;
                log.SEND_TIME = DateTime.Now;
                log.SRV_ID = Srv_ID;

                try
                {
                    if (ConfigModel.MailRevTest == "1")
                    {
                        mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, subject, MailBody);
                        mailMessage.IsBodyHtml = true;
                        CommonsServices.SendMail(mailMessage);
                        if (ConfigModel.MailRevIsTwo == "1")
                        {
                            var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                            foreach (var rec in recList)
                            {
                                mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, subject, MailBody);
                                mailMessage.IsBodyHtml = true;
                                CommonsServices.SendMail(mailMessage);
                            }
                        }
                    }
                    else
                    {
                        mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, Mail, subject, MailBody);
                        mailMessage.IsBodyHtml = true;
                        CommonsServices.SendMail(mailMessage);
                    }

                    // 寄信成功
                    log.RESULT_MK = "Y";
                    Insert(log);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    // 寄信失敗
                    log.RESULT_MK = "N";
                    Insert(log);
                }

                #endregion

                if (ISSEND)
                {
                    #region 承辦人
                    IList<SpecialistMailModel> mailList = new List<SpecialistMailModel>();
                    if (ISBACK)
                    {
                        // 中醫藥司 補件收件返回新收案件，重新取得分文承辦人
                        mailList = dao.getSpecialist(Srv_ID);
                        if (mailList == null) { return; }
                    }
                    else
                    {
                        if (Srv_ID.Substring(0, 3) == "011")
                        {
                            mailList = dao.getSpecialist(Srv_ID);
                        }
                        else
                        {
                            ApplyModel app = new ApplyModel();
                            app.APP_ID = APP_ID;
                            var getapp = dao.GetRow(app);

                            AdminModel adm = new AdminModel();
                            adm.ACC_NO = getapp.PRO_ACC.TONotNullString();
                            var getadm = dao.GetRow(adm);
                            mailList.Add(new SpecialistMailModel()
                            {
                                NAME = getadm.NAME,
                                EMAIL = getadm.MAIL
                            });
                        }
                    }
                    if (mailList != null && mailList.Count > 0)
                    {
                        foreach (var item in mailList)
                        {
                            subject = Srv_Nam + "申請作業，案件編號﹕" + APP_ID + " 補件完成通知";
                            MailBody = item.NAME + " 您好：<br/>";
                            // 客製化信件內容
                            switch (Srv_ID)
                            {
                                #region 社工司
                                case "011002":
                                case "011005":
                                case "011006":
                                    MailBody += "您有" + Srv_Nam + "申請，案件編號﹕" + APP_ID + "，待處理，已完成資料補件!!<br/>";
                                    break;
                                #endregion

                                default:
                                    MailBody += "您有" + Srv_Nam + "申請，案件編號﹕" + APP_ID + "，待處理，已完成資料補件!!<br/>";
                                    break;
                            }

                            // 中醫藥司會取代此段
                            if (CustomMailBody != "")
                            {
                                MailBody = CustomMailBody;
                            }

                            MailBody += "<br>" + notReplyMsg + "<br/>";

                            // 寄信LOG
                            TblMAIL_LOG log2 = new TblMAIL_LOG();
                            log2.MAIL = item.EMAIL;
                            log2.SUBJECT = subject;
                            log2.BODY = MailBody;
                            log2.SEND_TIME = DateTime.Now;
                            log2.SRV_ID = Srv_ID;
                            try
                            {
                                if (ConfigModel.MailRevTest == "1")
                                {
                                    mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, ConfigModel.MailRevAddr1, subject, MailBody);
                                    mailMessage.IsBodyHtml = true;
                                    CommonsServices.SendMail(mailMessage);
                                    if (ConfigModel.MailRevIsTwo == "1")
                                    {
                                        var recList = ConfigModel.MailRevAddr2.ToSplit(',');
                                        foreach (var rec in recList)
                                        {
                                            mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, rec, subject, MailBody);
                                            mailMessage.IsBodyHtml = true;
                                            CommonsServices.SendMail(mailMessage);
                                        }
                                    }
                                }
                                else
                                {
                                    mailMessage = CommonsServices.NewMail(ConfigModel.MailSenderAddr, item.EMAIL, subject, MailBody);
                                    mailMessage.IsBodyHtml = true;
                                    CommonsServices.SendMail(mailMessage);
                                }

                                // 寄信成功
                                log2.RESULT_MK = "Y";
                                Insert(log2);
                            }
                            catch (Exception ex)
                            {
                                logger.Error("SendMail_Update failed:" + ex.TONotNullString());
                                // 寄信失敗
                                log2.RESULT_MK = "N";
                                Insert(log2);
                            }
                        }
                    }
                    #endregion
                }
                conn.Close();
                conn.Dispose();
            }
        }

        #endregion

        #region 取得預計完成日期

        /// <summary>
        /// 取得預計完成日期
        /// </summary>
        /// <param name="APP_ID">案號</param>
        /// <returns></returns>
        public DateTime GetNTFD(string SRV_ID)
        {
            DateTime NTFD = DateTime.Now;

            TblSERVICE sv = new TblSERVICE();
            sv.SRV_ID = SRV_ID;
            var data = this.GetRow(sv);
            if (data != null)
            {
                NTFD = DateTime.Now.AddDays(data.PRO_DEADLINE.TOInt32());
            }

            return NTFD;
        }

        #endregion

        #region 取得該申辦案件承辦人(page_maker_id,fix_unit_cd)
        /// <summary>
        /// 取得該申辦案件承辦人
        /// </summary>
        /// <param name="SRV_ID"></param>
        /// <returns></returns>
        public string GetServicePageMakerId(string SRV_ID)
        {
            string PAGE_MAKER_ID = "";

            try
            {
                using (SqlConnection conn = DataUtils.GetConnection())
                {
                    string _sql = @"select PAGE_MAKER_ID FROM SERVICE where 1 = 1 and SRV_ID = '" + SRV_ID + "'";
                    var result = conn.Query<TblSERVICE>(_sql).FirstOrDefault();
                    PAGE_MAKER_ID = result.PAGE_MAKER_ID;
                    conn.Close();
                    conn.Dispose();
                }
            }
            catch (Exception ex)
            {
                logger.Warn(ex.Message, ex);
                throw new Exception("GetServicePageMakerId failed:" + ex.Message, ex);
            }

            return PAGE_MAKER_ID;
        }
        /// <summary>
        /// 案件維護單位
        /// </summary>
        /// <param name="SRV_ID"></param>
        /// <returns></returns>
        public Int32? GetServiceFixUnitCd(string SRV_ID)
        {
            Int32? FIX_UNIT_CD;

            try
            {
                using (SqlConnection conn = DataUtils.GetConnection())
                {
                    string _sql = @"select FIX_UNIT_CD FROM SERVICE where 1 = 1 and SRV_ID = '" + SRV_ID + "'";
                    var result = conn.Query<TblSERVICE>(_sql).FirstOrDefault();
                    FIX_UNIT_CD = result.FIX_UNIT_CD;
                    conn.Close();
                    conn.Dispose();
                }
            }
            catch (Exception ex)
            {
                logger.Warn(ex.Message, ex);
                throw new Exception("GetServiceFixUnitCd failed:" + ex.Message, ex);
            }

            return FIX_UNIT_CD;
        }
        #endregion

        #region Apply_011001 志願服務計畫核備

        public string ChkApply011001(Apply_011001FormModel form)
        {
            string Msg = "";
            TblZIPCODE zip = new TblZIPCODE();
            zip.ZIP_CO = form.ACC_ADDR_CODE;
            var zipdata = GetRow(zip);
            if (zipdata.ZIP_CO == null)
            {
                Msg = "請輸入正確的郵遞區號";
            }

            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply011001(Apply_011001FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011001";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    where.ADDR_CODE = form.ACC_ADDR_CODE;
                    where.ADDR = form.ACC_ADDR;
                    where.TEL = form.ACC_TEL;
                    where.MOBILE = form.ADM_MOBILE;
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011001");
                    where.APP_TIME = DateTime.Now;//申請日期
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    base.Insert(where);

                    // Insert 案件
                    APPLY_011001 app = new APPLY_011001();
                    app.InjectFrom(form);
                    app.APP_ID = APP_ID;
                    app.ACC_ADDR_CODE = form.ACC_ADDR_CODE;
                    app.ACC_ADDR = form.ACC_ADDR;
                    app.ACC_TEL = form.ACC_TEL;
                    app.ACC_SDATE = HelperUtil.TransToDateTime(form.ACC_SDATE);
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";
                    app.ADM_MAIL = form.ADM_MAIL;
                    app.FILE_SERVICE = "1";
                    app.FILE_UNIT = "2";
                    app.FILE_CERTIFICATE = "3";
                    app.FILE_BASIC = "4";

                    base.Insert(app);

                    #region 檔案上傳

                    if (!form.FILE_1_FILENAME.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = form.FILE_1_FILENAME;
                        var FileList = file.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_2_FILENAME.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = form.FILE_2_FILENAME;
                        var FileList = file.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_3_FILENAME.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = form.FILE_3_FILENAME;
                        var FileList = file.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }


                    if (!form.FILE_4_FILENAME.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = form.FILE_4_FILENAME;
                        var FileList = file.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply011001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取得案件詳細資料
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011001FormModel QueryApply_011001(Apply_011001FormModel parm)
        {
            Apply_011001FormModel result = new Apply_011001FormModel();

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql =
                    @"select app.SRV_ID ,(convert(varchar, app.APP_TIME, 111))as APP_TIME ,(convert(varchar, app.APP_EXT_DATE, 111)) as APP_EXT_DATE,
                                ad.NAME as PRO_NAM,app.APP_ID,app.ACC_NO,app.TEL,app.ADDR_CODE,ADDR,a01.ADM_NAM,app.MOBILE as ADM_MOBILE,a01.ADM_MAIL,
                                convert(varchar, a01.ACC_SDATE, 111) as ACC_SDATE,a01.ACC_NUM,a01.MERGEYN,app.NAME as ACC_NAM
                                from apply app
                                left join ADMIN ad on app.PRO_ACC = ad.ACC_NO
                                left join APPLY_011001 a01 on app.APP_ID = a01.APP_ID
                                where 1 = 1";
                _sql += "and app.app_id = '" + parm.APP_ID + "'";

                try
                {
                    result = conn.QueryFirst<Apply_011001FormModel>(_sql);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011001DetailModel GetFile011001(string APP_ID)
        {
            var result = new Apply_011001DetailModel();
            ShareDAO dao = new ShareDAO();
            var file1 = dao.GetFileGridList(APP_ID, "1", "N").FirstOrDefault();
            var file2 = dao.GetFileGridList(APP_ID, "2", "N").FirstOrDefault();
            var file3 = dao.GetFileGridList(APP_ID, "3", "N").FirstOrDefault();
            var file4 = dao.GetFileGridList(APP_ID, "4", "N").FirstOrDefault();
            result.FILE_1_FILENAME = file1 != null ? file1.FILE_NAME_TEXT : string.Empty;
            result.FILE_2_FILENAME = file2 != null ? file2.FILE_NAME_TEXT : string.Empty;
            result.FILE_3_FILENAME = file3 != null ? file3.FILE_NAME_TEXT : string.Empty;
            result.FILE_4_FILENAME = file4 != null ? file4.FILE_NAME_TEXT : string.Empty;

            result.APP_ID = APP_ID;
            return result;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011001DetailModel DetailGetFile011001(string APP_ID)
        {
            var result = new Apply_011001DetailModel();


            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select 
                                (SUBSTRING(fl1.FILENAME, 16,len(fl1.FILENAME))+','+ convert(varchar,fl1.APP_ID)+','+convert(varchar,fl1.FILE_NO)+','+isnull(convert(varchar,fl1.SRC_NO),'0')) as FILE_SERVICE_TEXT,
                                (SUBSTRING(fl2.FILENAME, 16,len(fl2.FILENAME))+','+ convert(varchar,fl2.APP_ID)+','+convert(varchar,fl2.FILE_NO)+','+isnull(convert(varchar,fl2.SRC_NO),'0')) as FILE_UNIT_TEXT,
                                (SUBSTRING(fl3.FILENAME, 16,len(fl3.FILENAME))+','+ convert(varchar,fl3.APP_ID)+','+convert(varchar,fl3.FILE_NO)+','+isnull(convert(varchar,fl3.SRC_NO),'0')) as FILE_CERTIFICATE_TEXT,
                                (SUBSTRING(fl4.FILENAME, 16,len(fl4.FILENAME))+','+ convert(varchar,fl4.APP_ID)+','+convert(varchar,fl4.FILE_NO)+','+isnull(convert(varchar,fl4.SRC_NO),'0')) as FILE_BASIC_TEXT                                                             
                                from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '2' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl2 on app.APP_ID = fl2.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '3' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl3 on app.APP_ID = fl3.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '4' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl4 on app.APP_ID = fl4.APP_ID ";
                _sql += "where 1 = 1";
                _sql += "and app.app_id = '" + APP_ID + "'";

                try
                {
                    result = conn.QueryFirst<Apply_011001DetailModel>(_sql);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011001(Apply_011001DetailModel model)
        {
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "011001");
            dict2.Add("LastMODTIME", LastMODTIME);
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    // 取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N";
                    var getan = GetRowList(an);
                    Count = getan.ToCount();

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.APP_ID = model.APP_ID;
                    andata.ISADDYN = "Y";
                    base.Update(andata, anwhere);

                    #region UpdateApply
                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.APP_ID = model.APP_ID;
                    appdata.MOBILE = model.ADM_MOBILE;
                    appdata.ADDR_CODE = model.ACC_ADDR_CODE;
                    appdata.ADDR = model.ACC_ADDR;
                    appdata.TEL = model.ACC_TEL;
                    appdata.UNIT_CD = 8;
                    appdata.FLOW_CD = "3";
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //base.Update(appdata, appwhere);
                    base.Update2(appdata, appwhere, dict2);

                    APPLY_011001 app011where = new APPLY_011001();
                    app011where.APP_ID = model.APP_ID;
                    // Update 案件
                    APPLY_011001 app011data = new APPLY_011001();
                    app011data.InjectFrom(model);
                    //app011data.ADM_MOBILE = model.ADM_MOBILE;
                    app011data.MERGEYN = model.MERGEYN;
                    app011data.APP_ID = model.APP_ID;
                    app011data.ACC_ADDR_CODE = model.ACC_ADDR_CODE;
                    app011data.ACC_ADDR = model.ACC_ADDR;
                    app011data.ACC_TEL = model.ACC_TEL;
                    app011data.UPD_TIME = DateTime.Now;
                    app011data.UPD_FUN_CD = "WEB-APPLY";
                    app011data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app011data.ACC_SDATE = HelperUtil.TransToDateTime(model.ACC_SDATE);
                    app011data.ADM_MAIL = model.ADM_MAIL;
                    app011data.FILE_SERVICE = "1";
                    app011data.FILE_UNIT = "2";
                    app011data.FILE_CERTIFICATE = "3";
                    app011data.FILE_BASIC = "4";

                    //base.Update(app011data, app011where);
                    base.Update2(app011data, app011where, dict2);

                    #endregion

                    #region 檔案上傳

                    if (!model.FILE_1.TONotNullString().Equals(""))
                    {
                        //Apply_FileModel file = new Apply_FileModel();
                        //file.APP_ID = model.APP_ID;
                        //file.FILE_NO = 1;
                        //var file1 = this.GetRow(file);
                        //if (file1 == null)
                        //{
                        // 新增
                        Apply_FileModel fileIn = new Apply_FileModel();
                        fileIn.APP_ID = model.APP_ID;
                        fileIn.FILE_NO = 1;
                        fileIn.FILENAME = dao.PutFile("011001", model.FILE_1, "1");
                        var FileList = fileIn.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        fileIn.SRC_FILENAME = FileName;
                        fileIn.ADD_TIME = DateTime.Now;
                        fileIn.ADD_FUN_CD = "WEB-APPLY";
                        fileIn.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.UPD_TIME = DateTime.Now;
                        fileIn.UPD_FUN_CD = "WEB-APPLY";
                        fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.DEL_MK = "N";
                        base.Insert(fileIn);
                        //}
                        //else
                        //{
                        //    // 更新
                        //    Apply_FileModel where = new Apply_FileModel();
                        //    where.APP_ID = model.APP_ID;
                        //    where.FILE_NO = 1;
                        //    Apply_FileModel fileIn = new Apply_FileModel();
                        //    fileIn.FILENAME = dao.PutFile("011001", model.FILE_1, "1");
                        //    var FileList = fileIn.FILENAME.ToSplit('/');
                        //    var FileName = FileList[FileList.ToCount() - 1];
                        //    fileIn.SRC_FILENAME = FileName;
                        //    fileIn.UPD_TIME = DateTime.Now;
                        //    fileIn.UPD_FUN_CD = "WEB-APPLY";
                        //    fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    base.Update(fileIn, where);
                        //}
                    }

                    if (!model.FILE_2.TONotNullString().Equals(""))
                    {
                        //Apply_FileModel file = new Apply_FileModel();
                        //file.APP_ID = model.APP_ID;
                        //file.FILE_NO = 2;
                        //var file2 = this.GetRow(file);
                        //if (file2 == null)
                        //{
                        // 新增
                        var fileIn = new Apply_FileModel();
                        fileIn.APP_ID = model.APP_ID;
                        fileIn.FILE_NO = 2;
                        fileIn.FILENAME = dao.PutFile("011001", model.FILE_2, "2");
                        var FileList = fileIn.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        fileIn.SRC_FILENAME = FileName;
                        fileIn.ADD_TIME = DateTime.Now;
                        fileIn.ADD_FUN_CD = "WEB-APPLY";
                        fileIn.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.UPD_TIME = DateTime.Now;
                        fileIn.UPD_FUN_CD = "WEB-APPLY";
                        fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.DEL_MK = "N";
                        base.Insert(fileIn);
                        //}
                        //else
                        //{
                        //    // 更新
                        //    Apply_FileModel where = new Apply_FileModel();
                        //    where.APP_ID = model.APP_ID;
                        //    where.FILE_NO = 2;
                        //    Apply_FileModel fileIn = new Apply_FileModel();
                        //    fileIn.FILENAME = dao.PutFile("011001", model.FILE_2, "2");
                        //    var FileList = fileIn.FILENAME.ToSplit('/');
                        //    var FileName = FileList[FileList.ToCount() - 1];
                        //    fileIn.SRC_FILENAME = FileName;
                        //    fileIn.UPD_TIME = DateTime.Now;
                        //    fileIn.UPD_FUN_CD = "WEB-APPLY";
                        //    fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    base.Update(fileIn, where);
                        //}
                    }

                    if (!model.FILE_3.TONotNullString().Equals(""))
                    {
                        //Apply_FileModel file = new Apply_FileModel();
                        //file.APP_ID = model.APP_ID;
                        //file.FILE_NO = 3;
                        //var file3 = this.GetRow(file);
                        //if (file3 == null)
                        //{
                        // 新增
                        var fileIn = new Apply_FileModel();
                        fileIn.APP_ID = model.APP_ID;
                        fileIn.FILE_NO = 3;
                        fileIn.FILENAME = dao.PutFile("011001", model.FILE_3, "3");
                        var FileList = fileIn.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        fileIn.SRC_FILENAME = FileName;
                        fileIn.ADD_TIME = DateTime.Now;
                        fileIn.ADD_FUN_CD = "WEB-APPLY";
                        fileIn.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.UPD_TIME = DateTime.Now;
                        fileIn.UPD_FUN_CD = "WEB-APPLY";
                        fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.DEL_MK = "N";
                        base.Insert(fileIn);
                        //}
                        //else
                        //{
                        //    // 更新
                        //    Apply_FileModel where = new Apply_FileModel();
                        //    where.APP_ID = model.APP_ID;
                        //    where.FILE_NO = 3;
                        //    Apply_FileModel fileIn = new Apply_FileModel();
                        //    fileIn.FILENAME = dao.PutFile("011001", model.FILE_3, "3");
                        //    var FileList = fileIn.FILENAME.ToSplit('/');
                        //    var FileName = FileList[FileList.ToCount() - 1];
                        //    fileIn.SRC_FILENAME = FileName;
                        //    fileIn.UPD_TIME = DateTime.Now;
                        //    fileIn.UPD_FUN_CD = "WEB-APPLY";
                        //    fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    base.Update(fileIn, where);
                        //}

                    }

                    if (!model.FILE_4.TONotNullString().Equals(""))
                    {
                        //Apply_FileModel file = new Apply_FileModel();
                        //file.APP_ID = model.APP_ID;
                        //file.FILE_NO = 4;
                        //var file4 = this.GetRow(file);
                        //if (file4 == null)
                        //{
                        // 新增
                        var fileIn = new Apply_FileModel();
                        fileIn.APP_ID = model.APP_ID;
                        fileIn.FILE_NO = 4;
                        fileIn.FILENAME = dao.PutFile("011001", model.FILE_4, "4");
                        var FileList = fileIn.FILENAME.ToSplit('/');
                        var FileName = FileList[FileList.ToCount() - 1];
                        fileIn.SRC_FILENAME = FileName;
                        fileIn.ADD_TIME = DateTime.Now;
                        fileIn.ADD_FUN_CD = "WEB-APPLY";
                        fileIn.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.UPD_TIME = DateTime.Now;
                        fileIn.UPD_FUN_CD = "WEB-APPLY";
                        fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        fileIn.DEL_MK = "N";
                        base.Insert(fileIn);
                        //}
                        //else
                        //{
                        //    // 更新
                        //    Apply_FileModel where = new Apply_FileModel();
                        //    where.APP_ID = model.APP_ID;
                        //    where.FILE_NO = 4;
                        //    Apply_FileModel fileIn = new Apply_FileModel();
                        //    fileIn.FILENAME = dao.PutFile("011001", model.FILE_4, "4");
                        //    var FileList = fileIn.FILENAME.ToSplit('/');
                        //    var FileName = FileList[FileList.ToCount() - 1];
                        //    fileIn.SRC_FILENAME = FileName;
                        //    fileIn.UPD_TIME = DateTime.Now;
                        //    fileIn.UPD_FUN_CD = "WEB-APPLY";
                        //    fileIn.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    base.Update(fileIn, where);
                        //}
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("UpdateApply011001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }

        #endregion

        #region Apply_011002 專科社會工作師證書核發

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011002(Apply_011002FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011002";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo("011002");
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    where.ADDR_CODE = form.ADDR_CODE;
                    where.ADDR = form.ADDR;
                    var HTEL = $"{form.H_TEL_0.TONotNullString()}-{form.H_TEL_1.TONotNullString()}";
                    var WTEL = $"{form.W_TEL_0.TONotNullString()}-{form.W_TEL_1.TONotNullString()}";
                    HTEL = string.IsNullOrWhiteSpace(form.H_TEL_2.TONotNullString()) ? HTEL : HTEL + "#" + form.H_TEL_2.TONotNullString();
                    WTEL = string.IsNullOrWhiteSpace(form.W_TEL_2.TONotNullString()) ? WTEL : WTEL + "#" + form.W_TEL_2.TONotNullString();
                    var MOBILE = form.MOBILE.TONotNullString();
                    if (HTEL.TONotNullString() != "") where.TEL = HTEL.TONotNullString();
                    else if (WTEL.TONotNullString() != "") where.TEL = WTEL.TONotNullString();
                    else where.TEL = MOBILE.TONotNullString();
                    where.MOBILE = MOBILE;
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011002");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011002");
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1";
                    base.Insert(where);
                    #endregion
                    // Insert 案件
                    #region Apply_011002
                    Apply_011002Model app = new Apply_011002Model();
                    app.InjectFrom(form);
                    app.H_TEL = HTEL;
                    app.W_TEL = WTEL;
                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.EMAIL = form.EMAIL;
                    app.PRACTICE_PLACE = form.PRACTICE_PLACE;
                    app.SPECIALIST_TYPE = form.SPECIALIST_TYPE;
                    app.TEST_YEAR = form.TEST_YEAR;
                    app.H_EQUAL = form.H_EQUAL;
                    app.MERGEYN = form.MERGEYN;
                    app.APPLY_TYPE = form.APPLY_TYPE;
                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";
                    app.FILE_IDNF = "1";
                    app.FILE_IDNB = "2";
                    app.FILE_PHOTO = "3";
                    app.FILE_HOUSEHOLD = "4";
                    base.Insert(app);
                    #endregion

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";

                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳

                    if (!form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011002", form.FILE_IDNF, "1");
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011002", form.FILE_IDNB, "2");
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011002", form.FILE_PHOTO, "3");
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011002", form.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = form.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply011002 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011002AppDocModel GetFile_011002(string APP_ID)
        {
            var result = new Apply_011002AppDocModel();


            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select 
                                (SUBSTRING(fl1.FILENAME, 16,len(fl1.FILENAME))+','+ convert(nvarchar,fl1.APP_ID)+','+convert(varchar,fl1.FILE_NO)+','+isnull(convert(varchar,fl1.SRC_NO),'0')) as FILE_IDNF_TEXT,
                                (SUBSTRING(fl2.FILENAME, 16,len(fl2.FILENAME))+','+ convert(nvarchar,fl2.APP_ID)+','+convert(varchar,fl2.FILE_NO)+','+isnull(convert(varchar,fl2.SRC_NO),'0')) as FILE_IDNB_TEXT,
                                (SUBSTRING(fl3.FILENAME, 16,len(fl3.FILENAME))+','+ convert(nvarchar,fl3.APP_ID)+','+convert(varchar,fl3.FILE_NO)+','+isnull(convert(varchar,fl3.SRC_NO),'0')) as FILE_PHOTO_TEXT,
                                (SUBSTRING(fl4.FILENAME, 16,len(fl4.FILENAME))+','+ convert(nvarchar,fl4.APP_ID)+','+convert(varchar,fl4.FILE_NO)+','+isnull(convert(varchar,fl4.SRC_NO),'0')) as FILE_HOUSEHOLD_TEXT                                                                
                                from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '2' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl2 on app.APP_ID = fl2.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '3' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl3 on app.APP_ID = fl3.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '4' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl4 on app.APP_ID = fl4.APP_ID ";
                _sql += " where 1 = 1";
                _sql += " and app.app_id = '" + APP_ID + "'";

                try
                {
                    result = conn.QueryFirst<Apply_011002AppDocModel>(_sql);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011002(Apply_011002AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "011002");
            dict2.Add("LastMODTIME", LastMODTIME);
            //var APP_ID = GetApp_ID(CaseNum);
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    var HTEL = $"{model.H_TEL_0.TONotNullString()}-{model.H_TEL_1.TONotNullString()}";
                    var WTEL = $"{model.W_TEL_0.TONotNullString()}-{model.W_TEL_1.TONotNullString()}";
                    HTEL = string.IsNullOrWhiteSpace(model.H_TEL_2.TONotNullString()) ? HTEL : HTEL + "#" + model.H_TEL_2.TONotNullString();
                    WTEL = string.IsNullOrWhiteSpace(model.W_TEL_2.TONotNullString()) ? WTEL : WTEL + "#" + model.W_TEL_2.TONotNullString();
                    var MOBILE = model.MOBILE.TONotNullString();
                    if (HTEL.TONotNullString() != "") appdata.TEL = HTEL.TONotNullString();
                    else if (WTEL.TONotNullString() != "") appdata.TEL = WTEL.TONotNullString();
                    else appdata.TEL = MOBILE.TONotNullString();
                    appdata.MOBILE = MOBILE;
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = model.TEL;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8;
                    appdata.FLOW_CD = "3";
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //base.Update(appdata, appwhere);
                    base.Update2(appdata, appwhere, dict2);

                    Apply_011002Model app011002where = new Apply_011002Model();
                    app011002where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011002Model app011002data = new Apply_011002Model();
                    app011002data.InjectFrom(model);
                    app011002data.H_TEL = HTEL;
                    app011002data.W_TEL = WTEL;
                    app011002data.APP_ID = model.APP_ID;
                    app011002data.UPD_TIME = DateTime.Now;
                    app011002data.UPD_FUN_CD = "WEB-APPLY";
                    app011002data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //app011002data.DEL_MK = "N";
                    app011002data.FILE_IDNF = "1";
                    app011002data.FILE_IDNB = "2";
                    app011002data.FILE_PHOTO = "3";
                    app011002data.FILE_HOUSEHOLD = "4";

                    //Update(app011002data, app011002where);
                    base.Update2(app011002data, app011002where, dict2);

                    #region 檔案上傳

                    if (!model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011002", model.FILE_IDNF, "1");
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011002", model.FILE_IDNB, "2");
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011002", model.FILE_PHOTO, "3");
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011002", model.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = model.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("UpdateApply011002 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }
        #endregion

        #region Apply_001005 醫事人員證書補(換)發

        /// <summary>
        /// 取得醫事人員證書補(換)發
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001005ViewModel QueryApply_001005(Apply_001005ViewModel parm)
        {
            Apply_001005ViewModel result = new Apply_001005ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {

                    string _sql = @"SELECT APP_ID,ACTION_TYPE,ISSUE_DEPT,ISSUE_DATE,LIC_TYPE,LIC_CD,LIC_NUM,ACTION_RES,OTHER_RES,DEL_MK,DEL_TIME,DEL_FUN_CD,
                                    DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,EMAIL,DIVISION
                             FROM APPLY_001005
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001005ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    _sql = @" SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME, PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK, PAY_RET_CD,
                            PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO, INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET, SESSION_KEY, AUTH_DATE,
                            AUTH_NO, SETTLE_DATE, OTHER, ROC_ID, CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                            FROM APPLY_PAY
                            WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.ApplyPay = conn.QueryFirst<APPLY_PAY>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.File = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>().FirstOrDefault();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();

                result.APPLY_NAME = result.Apply.NAME;

                result.APPLY_PID = result.Apply.IDN;

                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                //核發日期
                result.ISSUE_DATE_AC = HelperUtil.DateTimeToString(result.ISSUE_DATE);

                // 電話
                if (result.Apply.TEL.TONotNullString() != "")
                {
                    string[] tel = result.Apply.TEL.Split('-');
                    if (result.Apply.TEL.TONotNullString().Trim() != "")
                    {
                        result.TEL_SEC = tel[0];
                        if (tel.ToCount() > 1)
                        {
                            result.TEL_NO = tel[1];

                            if (result.TEL_NO.Contains("#"))
                            {
                                result.TEL_NO = result.TEL_NO.Split('#')[0];
                            }

                            if (result.Apply.TEL.IndexOf('#') > 0)
                            {
                                result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                            }
                        }

                    }
                }


                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.Apply.ADDR_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                    switch (result.EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                ShareDAO shareDAO = new ShareDAO();
                if (shareDAO.CalculationDocDate("001007", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                {
                    result.IsNotice = "N";
                }
                else
                {
                    result.IsNotice = "Y";
                }

            }

            return result;
        }


        public bool RunCreditCardTranx(Apply_001005ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            conn = null;
            serviceWhere.SRV_ID = "001005";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001005");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_METHOD", "C");
                    data.Put("PAY_CARD_IDN", model.CARD_IDN == null ? "" : model.CARD_IDN);
                    data.Put("PAY_A_FEEBK", "0");
                    data.Put("APP_FEE", model.PAY_A_FEE.ToString());
                    data.Put("PAY_ID", model.APP_ID);
                    data.Put("PAY_CLIENT_IP", model.CLIENT_IP);

                    Dictionary<string, string> pay = DataUtils.GetPayAccount(Convert.ToInt32(form["PAY_ACCOUNT"]));
                    data.Put("PAY_OID", pay["OID"]);
                    data.Put("PAY_SID", pay["SID"]);

                    #region 繳費
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", serviceWhere.SRV_ID);
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();
                    apply.APP_ID = model.APP_ID;
                    apply.InjectFrom(UserInfo);
                    //apply.InjectFrom(model.Apply);               
                    apply.MOBILE = model.MOBILE.TONotNullString() != "" ? model.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = "C";
                    apply.CARD_IDN = model.CARD_IDN;
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.SRV_ID = "001005";
                    apply.SRC_SRV_ID = "001005";
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_EXT_DATE = this.GetNTFD("001005");
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    //this.Update(apply, applyWhere);
                    //this.Update2(apply, applyWhere, dict2);
                    Insert(apply);

                    Apply_001005Model apply001005 = new Apply_001005Model();
                    apply001005.APP_ID = model.APP_ID;
                    apply001005.DIVISION = model.DIVISION;
                    apply001005.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001005.ACTION_RES = model.ACTION_RES;
                    apply001005.OTHER_RES = model.OTHER_RES;
                    apply001005.ACTION_TYPE = model.ACTION_TYPE;
                    apply001005.LIC_CD = model.LIC_CD;
                    apply001005.LIC_TYPE = model.LIC_TYPE;
                    apply001005.LIC_NUM = model.LIC_NUM;
                    apply001005.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001005.ADD_TIME = DateTime.Now;
                    apply001005.ADD_FUN_CD = "WEB-APPLY";
                    apply001005.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001005.UPD_TIME = DateTime.Now;
                    apply001005.UPD_FUN_CD = "WEB-APPLY";
                    apply001005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001005.DEL_MK = "N";
                    this.Insert(apply001005);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001005", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    #endregion

                    if (model.ISEC.ToUpper() == "Y" && DateTime.Now >= Convert.ToDateTime(DataUtils.GetConfig("PAY_EC_SDATE")))
                    {
                        #region 聯合信用卡繳費中心
                        var ECmodel = new CreditHPPModel();
                        ECmodel.EncModel.MerchantID = DataUtils.GetConfig("PAY_EC_MERCHANTID");
                        ECmodel.EncModel.OrderID = "";
                        ECmodel.EncModel.TerminalID = DataUtils.GetConfig("PAY_EC_TRMINALID");
                        ECmodel.EncModel.TransAmt = Convert.ToString(model.PAY_A_FEE);
                        ECmodel.EncModel.TransMode = "0";
                        ECmodel.EncModel.Template = "BOTH";
                        ECmodel.EncModel.CardholderName = "";
                        ECmodel.EncModel.CardholderEmailAddress = "";
                        ECmodel.EncModel.IDNUMBER = Convert.ToString(model.CARD_IDN); //持卡人身份證字號
                        ECmodel.EncModel.PrivateData = "ClientIP=" + model.CLIENT_IP + "&APPID=" + model.APP_ID + "&SRVID=" + serviceWhere.SRV_ID; //自訂資料
                        ECmodel.ECConnetModel.DomainName = DataUtils.GetConfig("PAY_EC_DOMAINNAME");
                        ECmodel.ECConnetModel.RequestURL = DataUtils.GetConfig("PAY_EC_REQUESTURL");
                        //*回應網址
                        ECmodel.EncModel.NotifyURL = DataUtils.GetConfig("PAY_EC_NOTIFYURL");

                        //聯合信用卡
                        ApiClient resEC = CardUtils.GetTransactionKeyEC(ECmodel);
                        if (resEC != null)
                        {
                            model.ErrorCode = resEC.getRESPONSECODE();
                            model.ErrorMessage = resEC.getRESPONSEMSG();
                            if (model.ErrorCode.Equals("00"))
                            {
                                //作業執行成功
                                logger.Debug("SessionTransactionKey: " + resEC.getKEY());

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001005";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = resEC.getKEY();
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                applyPay.PAY_BANK = "EC"; //聯合信用
                                applyPay.ECORDERID = resEC.getORDERID(); // EC datetime.tick
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                                model.SessionTransactionKey = resEC.getKEY();
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + model.ErrorCode + ":" + model.ErrorMessage + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                    else
                    {
                        #region 我的E政府繳費
                        SessionKeyResponse res = CardUtils.GetTransactionKey(data.GetItem(), pay);

                        if (res != null)
                        {
                            model.ErrorCode = res.ResultInfo;
                            model.ErrorMessage = action.GetPayCodeDesc(res.ResultInfo);
                            if (res.ResultInfo.Equals("0000"))
                            {
                                string sessionKey = res.SessionTransactionKey;
                                data.Put("PAY_SESSION_KEY", sessionKey);
                                logger.Debug("SessionTransactionKey: " + sessionKey);
                                model.SessionTransactionKey = sessionKey;

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001005";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = model.SessionTransactionKey;
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + res.ResultInfo + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                    if (result)
                    {
                        BackApplyDAO backDao = new BackApplyDAO();
                        string subject = "醫事人員或公共衛生師證書補(換)發，案件編號﹕" + model.APP_ID + " 申請通知";
                        string MailBody = "";
                        MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                        MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之醫事人員或公共衛生師證書補(換)發案件<br/>";
                        MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001005/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                        MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                        MailBody += "衛生福利部醫事司敬上<br/><br/>";
                        MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                        MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                        MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                        MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                        MailBody += "115204 臺北市南港區忠孝東路六段488號";
                        backDao.SendMail(model.MAIL, subject, MailBody);
                    }
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    model.ErrorCode = "-1";
                    model.ErrorMessage = "連接失敗";
                    model.TempMessage = "取得預約交易代碼失敗(-1)";
                    //throw;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool RunPayTranx(Apply_001005ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001005";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID("001005");

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001005");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }


                    ApplyModel apply = new ApplyModel();

                    apply.InjectFrom(UserInfo);
                    apply.MOBILE = model.MOBILE.TONotNullString() != "" ? model.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.APP_ID = model.APP_ID;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.SRV_ID = "001005";
                    apply.SRC_SRV_ID = "001005";
                    apply.APP_EXT_DATE = this.GetNTFD("001005");
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);

                    Apply_001005Model apply001005 = new Apply_001005Model();
                    apply001005.APP_ID = model.APP_ID;
                    apply001005.DIVISION = model.DIVISION;
                    apply001005.ISSUE_DEPT = model.ISSUE_DEPT;
                    apply001005.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001005.ACTION_RES = model.ACTION_RES;
                    apply001005.OTHER_RES = model.OTHER_RES;
                    apply001005.ACTION_TYPE = model.ACTION_TYPE;
                    apply001005.LIC_CD = model.LIC_CD;
                    apply001005.LIC_TYPE = model.LIC_TYPE;
                    apply001005.LIC_NUM = model.LIC_NUM;
                    apply001005.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001005.ADD_TIME = DateTime.Now;
                    apply001005.ADD_FUN_CD = "WEB-APPLY";
                    apply001005.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001005.UPD_TIME = DateTime.Now;
                    apply001005.UPD_FUN_CD = "WEB-APPLY";
                    apply001005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001005.DEL_MK = "N";
                    this.Insert(apply001005);

                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = model.APP_ID;
                    applyPay.PAY_ID = model.APP_ID;
                    apply.SRV_ID = "001005";
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = "WEB-APPLY";
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = "WEB-APPLY";
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001005", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "醫事人員或公共衛生師證書補(換)發，案件編號﹕" + model.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之醫事人員或公共衛生師證書補(換)發案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001005/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(model.MAIL, subject, MailBody);

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = false;
                    throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool SaveAppDoc001005(Apply_001005ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001005");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    if (model.Apply.ISMODIFY == "Y")
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.NAME = model.APPLY_NAME;
                        apply.IDN = model.APPLY_PID;
                        apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL_SEC.TONotNullString() != "" && model.TEL_NO.TONotNullString() != "" ?
                            (model.TEL_EXT.TONotNullString() != "" ? model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString() + "#" + model.TEL_EXT.TONotNullString() : model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString()) : "";
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                        Apply_001005Model apply001005Where = new Apply_001005Model();
                        apply001005Where.APP_ID = model.APP_ID;
                        Apply_001005Model apply001005 = new Apply_001005Model();

                        apply001005.APP_ID = model.APP_ID;
                        apply001005.DIVISION = model.DIVISION;
                        apply001005.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                        apply001005.ACTION_RES = model.ACTION_RES;
                        apply001005.OTHER_RES = model.OTHER_RES;
                        apply001005.ACTION_TYPE = model.ACTION_TYPE;
                        apply001005.LIC_CD = model.LIC_CD;
                        apply001005.LIC_TYPE = model.LIC_TYPE;
                        apply001005.LIC_NUM = model.LIC_NUM;
                        apply001005.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                        apply001005.UPD_TIME = DateTime.Now;
                        apply001005.UPD_FUN_CD = "WEB-APPLY";
                        apply001005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply001005, apply001005Where);
                        this.Update2(apply001005, apply001005Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.APP_TIME = DateTime.Now;
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                    }

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.File.FILENAME;
                        fileWhere.FILE_NO = model.File.FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();
                        Apply_FileModel latestFile = new Apply_FileModel();
                        latestFile = this.GetRow(fileWhere);
                        int? file_no = 1;

                        if (latestFile.APP_ID != null)
                        {
                            file_no = latestFile.FILE_NO + 1;
                        }

                        file.APP_ID = model.APP_ID;
                        model.File.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001005", model.ATTACH_FILE, "1");
                        model.File.FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        model.File.SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 1;
                        model.File.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001005", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001005", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    model.File.FILE_NO = 1;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}

                    }
                    else
                    {
                        if (model.File.FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.File.FILENAME;
                            fileWhere.FILE_NO = model.File.FILE_NO;

                            model.File = this.GetRow(fileWhere);
                        }

                    }
                    tran.Commit();
                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = false;
                    throw new Exception("SaveAppDoc001005 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        #endregion

        #region Apply_011005 專科社會工作師證書補發（遺失或污損）

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011005(Apply_011005FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011005";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo("011005");
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    #region 基本資料
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.ADDR_CODE = form.ADDR_CODE;
                    where.ADDR = form.ADDR;
                    var HTEL = form.H_TEL_1.TONotNullString().ToTrim() != "" ? form.H_TEL_2.TONotNullString().ToTrim() != "" ? form.H_TEL_0.TONotNullString() + "-" + form.H_TEL_1.TONotNullString() + "#" + form.H_TEL_2.TONotNullString() : form.H_TEL_0.TONotNullString() + "-" + form.H_TEL_1.TONotNullString() : "";
                    var WTEL = form.W_TEL_1.TONotNullString().ToTrim() != "" ? form.W_TEL_2.TONotNullString().ToTrim() != "" ? form.W_TEL_0.TONotNullString() + "-" + form.W_TEL_1.TONotNullString() + "#" + form.W_TEL_2.TONotNullString() : form.W_TEL_0.TONotNullString() + "-" + form.W_TEL_1.TONotNullString() : "";
                    var MOBILE = form.MOBILE.TONotNullString();
                    if (HTEL.TONotNullString() != "") where.TEL = HTEL.TONotNullString();
                    else if (WTEL.TONotNullString() != "") where.TEL = WTEL.TONotNullString();
                    else where.TEL = MOBILE.TONotNullString();
                    where.MOBILE = MOBILE;
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011005");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011005");
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);
                    #endregion
                    #region 案件
                    // Insert 案件
                    Apply_011005Model app = new Apply_011005Model();
                    app.InjectFrom(form);
                    app.H_TEL = HTEL;
                    app.W_TEL = WTEL;
                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.EMAIL = form.EMAIL;
                    app.PRACTICE_PLACE = form.PRACTICE_PLACE;
                    app.SPECIALIST_TYPE = form.SPECIALIST_TYPE;
                    app.TEST_YEAR = form.TEST_YEAR;
                    app.H_EQUAL = form.H_EQUAL;
                    app.MERGEYN = form.MERGEYN;
                    app.APPLY_TYPE = form.APPLY_TYPE;
                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";
                    app.FILE_IDNF = "1";
                    app.FILE_IDNB = "2";
                    app.FILE_PHOTO = "3";
                    app.FILE_HOUSEHOLD = "4";
                    base.Insert(app);
                    #endregion
                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";

                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳

                    if (!form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011005", form.FILE_IDNF, "1");
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011005", form.FILE_IDNB, "2");
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011005", form.FILE_PHOTO, "3");
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011005", form.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = form.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply011005 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011005AppDocModel GetFile_011005(string APP_ID)
        {
            var result = new Apply_011005AppDocModel();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select 
                                (SUBSTRING(fl1.FILENAME, 16,len(fl1.FILENAME))+','+ convert(nvarchar,fl1.APP_ID)+','+convert(varchar,fl1.FILE_NO)+','+isnull(convert(varchar,fl1.SRC_NO),'0')) as FILE_IDNF_TEXT,
                                (SUBSTRING(fl2.FILENAME, 16,len(fl2.FILENAME))+','+ convert(nvarchar,fl2.APP_ID)+','+convert(varchar,fl2.FILE_NO)+','+isnull(convert(varchar,fl2.SRC_NO),'0')) as FILE_IDNB_TEXT,
                                (SUBSTRING(fl3.FILENAME, 16,len(fl3.FILENAME))+','+ convert(nvarchar,fl3.APP_ID)+','+convert(varchar,fl3.FILE_NO)+','+isnull(convert(varchar,fl3.SRC_NO),'0')) as FILE_PHOTO_TEXT,
                                (SUBSTRING(fl4.FILENAME, 16,len(fl4.FILENAME))+','+ convert(nvarchar,fl4.APP_ID)+','+convert(varchar,fl4.FILE_NO)+','+isnull(convert(varchar,fl4.SRC_NO),'0')) as FILE_HOUSEHOLD_TEXT                                                                
                                 from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '2' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl2 on app.APP_ID = fl2.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '3' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl3 on app.APP_ID = fl3.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '4' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl4 on app.APP_ID = fl4.APP_ID ";
                _sql += "where 1 = 1";
                _sql += "and app.app_id = '" + APP_ID + "'";

                try
                {
                    result = conn.QueryFirst<Apply_011005AppDocModel>(_sql);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011005(Apply_011005AppDocModel model)
        {
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "011005");
            dict2.Add("LastMODTIME", LastMODTIME);
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {

                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    var HTEL = model.H_TEL_1.TONotNullString().ToTrim() != "" ? model.H_TEL_2.TONotNullString().ToTrim() != "" ? model.H_TEL_0.TONotNullString() + "-" + model.H_TEL_1.TONotNullString() + "#" + model.H_TEL_2.TONotNullString() : model.H_TEL_0.TONotNullString() + "-" + model.H_TEL_1.TONotNullString() : "";
                    var WTEL = model.W_TEL_1.TONotNullString().ToTrim() != "" ? model.W_TEL_2.TONotNullString().ToTrim() != "" ? model.W_TEL_0.TONotNullString() + "-" + model.W_TEL_1.TONotNullString() + "#" + model.W_TEL_2.TONotNullString() : model.W_TEL_0.TONotNullString() + "-" + model.W_TEL_1.TONotNullString() : "";
                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);
                    //Update2(andata, anwhere, dict2);
                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = HTEL;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8;
                    appdata.FLOW_CD = "3";
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //Update(appdata, appwhere);
                    base.Update2(appdata, appwhere, dict2);

                    Apply_011005Model app011005where = new Apply_011005Model();
                    app011005where.APP_ID = model.APP_ID;

                    // Update 案件
                    Apply_011005Model app011005data = new Apply_011005Model();
                    app011005data.InjectFrom(model);
                    app011005data.H_TEL = HTEL;
                    app011005data.W_TEL = WTEL;
                    app011005data.APP_ID = model.APP_ID;
                    app011005data.UPD_TIME = DateTime.Now;
                    app011005data.UPD_FUN_CD = "WEB-APPLY";
                    app011005data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //app011005data.DEL_MK = "N";
                    app011005data.FILE_IDNF = "1";
                    app011005data.FILE_IDNB = "2";
                    app011005data.FILE_PHOTO = "3";
                    app011005data.FILE_HOUSEHOLD = "4";

                    //Update(app011005data, app011005where);
                    base.Update2(app011005data, app011005where, dict2);

                    #region 檔案上傳

                    if (!model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011005", model.FILE_IDNF, "1");
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011005", model.FILE_IDNB, "2");
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011005", model.FILE_PHOTO, "3");
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011005", model.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = model.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011005 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();
        }
        #endregion

        #region Apply_001009 醫事人員資格英文求證

        /// <summary>
        /// 新增醫事人員資格英文求證案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply001009(Apply_001009ViewModel form)
        {
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "001009";
            var APP_ID = GetApp_ID(CaseNum);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    form.APP_ID = APP_ID;

                    // Insert Apply
                    ApplyModel apply = new ApplyModel();
                    // 帶入基本資料
                    apply.InjectFrom(UserInfo);
                    apply.InjectFrom(form);
                    apply.IDN = form.APPLY_PID;
                    apply.MOBILE = form.MOBILE.TONotNullString() != "" ? form.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.NAME = form.APPLY_NAME;
                    apply.ENAME = form.Apply.ENAME;
                    apply.E_ALIAS_NAME = form.Apply.E_ALIAS_NAME;
                    apply.CNT_NAME = form.Apply.CNT_NAME;
                    apply.BIRTHDAY = HelperUtil.TransToDateTime(form.BIRTHDAY_AC);
                    apply.ADDR_CODE = form.CITY_CODE;
                    apply.ADDR = form.CITY_TEXT + form.CITY_DETAIL;
                    apply.TEL = form.TEL.TONotNullString();
                    apply.CNT_TEL = form.TEL.TONotNullString();
                    apply.FAX = form.FAX.TONotNullString();
                    apply.PAY_POINT = "A";
                    apply.APP_ID = APP_ID;
                    apply.SRV_ID = CaseNum;
                    apply.SRC_SRV_ID = CaseNum;
                    apply.UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(apply);

                    // Insert 醫事人員資格英文求證
                    Apply_001009Model apply001009 = new Apply_001009Model();
                    apply001009.InjectFrom(form);
                    apply001009.EMAIL = form.MAIL;
                    apply001009.CERT_APPROVED_DATE = HelperUtil.TransToDateTime(form.CERT_APPROVED_DATE_AC);
                    apply001009.STUDY_START_YM = form.YEAR1 + form.MONTH1;
                    apply001009.STUDY_END_YM = form.YEAR2 + form.MONTH2;
                    apply001009.MAIL_COUNTRY = form.MAIL_COUNTRY;
                    apply001009.RECEIVER = form.RECEIVER;
                    apply001009.ADD_TIME = DateTime.Now;
                    apply001009.ADD_FUN_CD = "WEB-APPLY";
                    apply001009.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001009.UPD_TIME = DateTime.Now;
                    apply001009.UPD_FUN_CD = "WEB-APPLY";
                    apply001009.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001009.DEL_MK = "N";

                    base.Insert(apply001009);

                    //Insert 檔案
                    ShareDAO shareDao = new ShareDAO();
                    Apply_FileModel file = null;

                    if (form.FILE1 != null)
                    {
                        file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = shareDao.PutFile("001009", form.FILE1, "1");
                        file.SRC_FILENAME = form.FILE1_NAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (form.FILE2 != null)
                    {
                        file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = shareDao.PutFile("001009", form.FILE2, "2");
                        file.SRC_FILENAME = form.FILE2_NAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (form.FILE3 != null)
                    {
                        file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = shareDao.PutFile("001009", form.FILE3, "3");
                        file.SRC_FILENAME = form.FILE3_NAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (form.FILE4 != null)
                    {
                        file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = shareDao.PutFile("001009", form.FILE4, "4");
                        file.SRC_FILENAME = form.FILE4_NAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (form.FILE5 != null)
                    {
                        file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 5;
                        file.FILENAME = shareDao.PutFile("001009", form.FILE5, "5");
                        file.SRC_FILENAME = form.FILE5_NAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "醫事人員或公共衛生師資格英文求證，案件編號﹕" + form.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += UserInfo.NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + (Convert.ToInt32(DateTime.Now.ToString("yyyy")) - 1911).ToString() + "年" + DateTime.Now.ToString("yyyyMMdd").Substring(4, 2) + "月" + DateTime.Now.ToString("yyyyMMdd").Substring(6, 2) + "日申辦之醫事人員或公共衛生師資格英文求證申請作業<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001009/AppDoc?APP_ID=" + form.APP_ID + "'>" + form.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(UserInfo.MAIL, subject, MailBody);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply001009 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 醫事人員資格英文求證
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001009ViewModel QueryApply_001009(Apply_001009ViewModel parm)
        {
            Apply_001009ViewModel result = new Apply_001009ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"SELECT APP_ID,APPLY_CAUSE,APPLY_CAUSE_TEXT,APPLY_CERT_CATE,LIC_TYPE,LIC_CD,LIC_NUM,CERT_APPROVED_DATE,C_SCHOOL_NAME,
	                                  E_SCHOOL_NAME,STUDY_START_YM,STUDY_END_YM,VERIFY_ADDRESS,IS_MERGE_FILE,EMAIL,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,
	                                  UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MAIL_COUNTRY,RECEIVER,VERIFY_NAME
                             FROM APPLY_001009
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001009ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY,NOTIBODY,E_ALIAS_NAME
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                             FROM   APPLY_FILE
                             WHERE  1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    _sql += " order by ADD_TIME DESC";
                    result.FileList = new List<Apply_FileModel>();
                    result.FileList = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>();

                    _sql = @"SELECT APP_ID,Field,Field_NAME,ISADDYN,FREQUENCY,ADD_TIME,DEADLINE,NOTE,SRC_NO,BATCH_INDEX
                            FROM APPLY_NOTICE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID AND ISADDYN='N' ";
                    result.ApplyNoticeList = new List<TblAPPLY_NOTICE>();
                    result.ApplyNoticeList = conn.Query<TblAPPLY_NOTICE>(_sql, parameters).ToList<TblAPPLY_NOTICE>();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();
                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                //核發日期
                result.CERT_APPROVED_DATE_AC = HelperUtil.DateTimeToString(result.CERT_APPROVED_DATE);

                // 電話
                string[] tel = result.Apply.TEL.Split('-');
                if (result.Apply.TEL.TONotNullString().Trim() != "")
                {
                    result.TEL_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.TEL_NO = tel[1];

                        if (result.TEL_NO.Contains("#"))
                        {
                            result.TEL_NO = result.TEL_NO.Split('#')[0];
                        }

                        if (result.Apply.TEL.IndexOf('#') > 0)
                        {
                            result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                        }
                    }
                }

                // 傳真
                string[] fax = result.Apply.FAX.Split('-');
                if (result.Apply.FAX.TONotNullString().Trim() != "")
                {
                    result.FAX_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.FAX_NO = tel[1];

                        if (result.FAX_NO.Contains("#"))
                        {
                            result.FAX_NO = result.FAX_NO.Split('#')[0];
                        }

                        if (result.Apply.FAX.IndexOf('#') > 0)
                        {
                            result.FAX_EXT = result.Apply.FAX.Split('#')[1];
                        }
                    }
                }

                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.Apply.ADDR_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                    switch (result.EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                ShareDAO shareDAO = new ShareDAO();
                if (shareDAO.CalculationDocDate("001009", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                {
                    result.IsNotice = "N";
                }
                else
                {
                    result.IsNotice = "Y";
                }

                result.NoticeList = "";
                if (result.ApplyNoticeList.Count > 0)
                {
                    foreach (var item in result.ApplyNoticeList)
                    {
                        if (result.NoticeList == "")
                        {
                            result.NoticeList = item.Field;
                        }
                        else
                        {
                            result.NoticeList += "," + item.Field;
                        }
                    }

                    result.FREQUENCY = result.ApplyNoticeList[0].FREQUENCY;

                }

                result.YEAR1 = result.STUDY_START_YM.Substring(0, 4);
                result.MONTH1 = result.STUDY_START_YM.Substring(4, 2);
                result.YEAR2 = result.STUDY_END_YM.Substring(0, 4);
                result.MONTH2 = result.STUDY_END_YM.Substring(4, 2);

                if (result.FileList.Count <= 5)
                {
                    int rowCount = 5 - result.FileList.Count;
                    if (rowCount > 0)
                    {
                        for (int i = 0; i < rowCount; i++)
                        {
                            result.FileList.Add(new Apply_FileModel() { APP_ID = parm.APP_ID, FILENAME = "", FILE_NO = -1 });
                        }
                    }
                }

                result.FILE1_CHECK = "Y";
                result.FILE2_CHECK = "Y";
                result.FILE3_CHECK = "Y";
                result.FILE4_CHECK = "Y";
                result.FILE5_CHECK = "Y";

            }

            return result;
        }

        public bool SaveAppDoc001009(Apply_001009ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001009");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    if (model.Apply.ISMODIFY == "Y")
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.IDN = model.Apply.IDN;
                        apply.NAME = model.Apply.NAME;
                        apply.ENAME = model.Apply.ENAME;
                        apply.E_ALIAS_NAME = model.Apply.E_ALIAS_NAME;
                        apply.CNT_NAME = model.Apply.CNT_NAME;
                        apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL.TONotNullString();
                        apply.MOBILE = model.Apply.MOBILE;
                        apply.CNT_TEL = model.TEL.TONotNullString();
                        apply.FAX = model.FAX.TONotNullString();
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                        Apply_001009Model apply001009Where = new Apply_001009Model();
                        apply001009Where.APP_ID = model.APP_ID;
                        Apply_001009Model apply001009 = new Apply_001009Model();

                        apply001009.InjectFrom(model);
                        apply001009.APP_ID = model.APP_ID;
                        apply001009.EMAIL = model.MAIL;
                        apply001009.CERT_APPROVED_DATE = HelperUtil.TransToDateTime(model.CERT_APPROVED_DATE_AC);
                        apply001009.STUDY_START_YM = model.YEAR1 + model.MONTH1;
                        apply001009.STUDY_END_YM = model.YEAR2 + model.MONTH2;
                        apply001009.UPD_TIME = DateTime.Now;
                        apply001009.UPD_FUN_CD = "WEB-APPLY";
                        apply001009.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply001009, apply001009Where);
                        this.Update2(apply001009, apply001009Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        //apply.APP_TIME = DateTime.Now;//案件申辦時間，不可異動
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                    }

                    TblAPPLY_NOTICE noticeWhere = new TblAPPLY_NOTICE();
                    noticeWhere.APP_ID = model.APP_ID;
                    noticeWhere.FREQUENCY = model.FREQUENCY;

                    TblAPPLY_NOTICE notice = new TblAPPLY_NOTICE();
                    notice.APP_ID = model.APP_ID;
                    notice.ISADDYN = "Y";
                    this.Update(notice, noticeWhere);


                    #region 檔案上傳

                    if (model.FILE1 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001009", model.FILE1, "1");
                        file.SRC_FILENAME = model.FILE1.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE2 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001009", model.FILE2, "2");
                        file.SRC_FILENAME = model.FILE2.FileName;
                        file.FILE_NO = 2;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE3 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001009", model.FILE3, "3");
                        file.SRC_FILENAME = model.FILE3.FileName;
                        file.FILE_NO = 3;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                    }

                    if (model.FILE4 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001009", model.FILE4, "4");
                        file.SRC_FILENAME = model.FILE4.FileName;
                        file.FILE_NO = 4;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE5 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001009", model.FILE5, "5");
                        file.SRC_FILENAME = model.FILE5.FileName;
                        file.FILE_NO = 5;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    #endregion

                    model.FILE1_CHECK = "Y";
                    model.FILE2_CHECK = "Y";
                    model.FILE3_CHECK = "Y";
                    model.FILE4_CHECK = "Y";
                    model.FILE5_CHECK = "Y";

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("SaveAppDoc001009 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        #endregion

        #region Apply_001007 專科醫師證書補（換）發

        /// <summary>
        /// 取得專科醫師證書補（換）發
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001007ViewModel QueryApply_001007(Apply_001007ViewModel parm)
        {
            Apply_001007ViewModel result = new Apply_001007ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {

                    string _sql = @"SELECT APP_ID,ACTION_TYPE,ISSUE_DATE,LIC_TYPE,LIC_CD,LIC_NUM,ACTION_RES,OTHER_RES,DEL_MK,
                             DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,DIVISION,EMAIL
                             FROM APPLY_001007
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001007ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    _sql = @" SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME, PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK, PAY_RET_CD,
                            PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO, INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET, SESSION_KEY, AUTH_DATE,
                            AUTH_NO, SETTLE_DATE, OTHER, ROC_ID, CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                            FROM APPLY_PAY
                            WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.ApplyPay = conn.QueryFirst<APPLY_PAY>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.File = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>().FirstOrDefault();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();

                result.APPLY_NAME = result.Apply.NAME;

                result.APPLY_PID = result.Apply.IDN;

                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                //核發日期
                result.ISSUE_DATE_AC = HelperUtil.DateTimeToString(result.ISSUE_DATE);

                // 電話

                if (result.Apply.TEL.TONotNullString().Trim() != "")
                {
                    string[] tel = result.Apply.TEL.Split('-');
                    result.TEL_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.TEL_NO = tel[1];

                        if (result.TEL_NO.Contains("#"))
                        {
                            result.TEL_NO = result.TEL_NO.Split('#')[0];
                        }

                        if (result.Apply.TEL.IndexOf('#') > 0)
                        {
                            result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                        }

                    }
                }

                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.Apply.ADDR_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                    switch (result.EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                ShareDAO shareDAO = new ShareDAO();
                if (shareDAO.CalculationDocDate("001007", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                {
                    result.IsNotice = "N";
                }
                else
                {
                    result.IsNotice = "Y";
                }

            }

            return result;
        }


        public bool RunCreditCardTranx(Apply_001007ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001007";
            conn = null;
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001007");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_METHOD", "C");
                    data.Put("PAY_CARD_IDN", model.CARD_IDN == null ? "" : model.CARD_IDN);
                    data.Put("PAY_A_FEEBK", "0");
                    data.Put("APP_FEE", model.PAY_A_FEE.ToString());
                    data.Put("PAY_ID", model.APP_ID);
                    data.Put("PAY_CLIENT_IP", model.CLIENT_IP);

                    Dictionary<string, string> pay = DataUtils.GetPayAccount(Convert.ToInt32(form["PAY_ACCOUNT"]));
                    data.Put("PAY_OID", pay["OID"]);
                    data.Put("PAY_SID", pay["SID"]);

                    #region 繳費

                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();

                    apply.APP_ID = model.APP_ID;
                    apply.InjectFrom(UserInfo);
                    //apply.InjectFrom(model.Apply);
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.MOBILE = model.MOBILE;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = "C";
                    apply.CARD_IDN = model.CARD_IDN;
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.SRV_ID = "001007";
                    apply.SRC_SRV_ID = "001007";
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_EXT_DATE = this.GetNTFD("001007");
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    Insert(apply);

                    Apply_001007Model apply001007 = new Apply_001007Model();
                    apply001007.APP_ID = model.APP_ID;
                    apply001007.DIVISION = model.DIVISION;
                    apply001007.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001007.ACTION_RES = model.ACTION_RES;
                    apply001007.OTHER_RES = model.OTHER_RES;
                    apply001007.ACTION_TYPE = model.ACTION_TYPE;
                    apply001007.LIC_CD = model.LIC_CD;
                    apply001007.LIC_TYPE = model.LIC_TYPE;
                    apply001007.LIC_NUM = model.LIC_NUM;
                    apply001007.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001007.ADD_TIME = DateTime.Now;
                    apply001007.ADD_FUN_CD = "WEB-APPLY";
                    apply001007.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001007.UPD_TIME = DateTime.Now;
                    apply001007.UPD_FUN_CD = "WEB-APPLY";
                    apply001007.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001007.DEL_MK = "N";
                    this.Insert(apply001007);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001007", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }
                    #endregion

                    if (model.ISEC.ToUpper() == "Y" && DateTime.Now >= Convert.ToDateTime(DataUtils.GetConfig("PAY_EC_SDATE")))
                    {
                        #region 聯合信用卡繳費中心

                        var ECmodel = new CreditHPPModel();
                        ECmodel.EncModel.MerchantID = DataUtils.GetConfig("PAY_EC_MERCHANTID");
                        ECmodel.EncModel.OrderID = "";
                        ECmodel.EncModel.TerminalID = DataUtils.GetConfig("PAY_EC_TRMINALID");
                        ECmodel.EncModel.TransAmt = Convert.ToString(model.PAY_A_FEE);
                        ECmodel.EncModel.TransMode = "0";
                        ECmodel.EncModel.Template = "BOTH";
                        ECmodel.EncModel.CardholderName = "";
                        ECmodel.EncModel.CardholderEmailAddress = "";
                        ECmodel.EncModel.IDNUMBER = Convert.ToString(model.CARD_IDN); //持卡人身份證字號
                        ECmodel.EncModel.PrivateData = "ClientIP=" + model.CLIENT_IP + "&APPID=" + model.APP_ID + "&SRVID=" + serviceWhere.SRV_ID; //自訂資料
                        ECmodel.ECConnetModel.DomainName = DataUtils.GetConfig("PAY_EC_DOMAINNAME");
                        ECmodel.ECConnetModel.RequestURL = DataUtils.GetConfig("PAY_EC_REQUESTURL");
                        //*回應網址
                        ECmodel.EncModel.NotifyURL = DataUtils.GetConfig("PAY_EC_NOTIFYURL");
                        //聯合信用卡
                        ApiClient resEC = CardUtils.GetTransactionKeyEC(ECmodel);
                        if (resEC != null)
                        {
                            model.ErrorCode = resEC.getRESPONSECODE();
                            model.ErrorMessage = resEC.getRESPONSEMSG();
                            if (model.ErrorCode.Equals("00"))
                            {
                                //作業執行成功
                                logger.Debug("SessionTransactionKey: " + resEC.getKEY());

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001007";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = resEC.getKEY();
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                applyPay.PAY_BANK = "EC"; //聯合信用
                                applyPay.ECORDERID = resEC.getORDERID(); // EC datetime.tick
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                                model.SessionTransactionKey = resEC.getKEY();
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + model.ErrorCode + ":" + model.ErrorMessage + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }

                        #endregion
                    }
                    else
                    {
                        #region 我的E政府
                        SessionKeyResponse res = CardUtils.GetTransactionKey(data.GetItem(), pay);

                        if (res != null)
                        {
                            model.ErrorCode = res.ResultInfo;
                            model.ErrorMessage = action.GetPayCodeDesc(res.ResultInfo);
                            if (res.ResultInfo.Equals("0000"))
                            {
                                string sessionKey = res.SessionTransactionKey;
                                data.Put("PAY_SESSION_KEY", sessionKey);
                                logger.Debug("SessionTransactionKey: " + sessionKey);
                                model.SessionTransactionKey = sessionKey;

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001007";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = model.SessionTransactionKey;
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                this.Insert(applyPay);



                                BackApplyDAO backDao = new BackApplyDAO();
                                string subject = "專科醫師證書補（換）發申請作業，案件編號﹕" + model.APP_ID + " 申請通知";
                                string MailBody = "";
                                MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                                MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之專科醫師證書補（換）發案件<br/>";
                                MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001007/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";


                                MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                                MailBody += "衛生福利部醫事司敬上<br/><br/>";
                                MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                                MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                                MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                                MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                                MailBody += "115204 臺北市南港區忠孝東路六段488號";
                                backDao.SendMail(model.MAIL, subject, MailBody);

                                tran.Commit();

                                result = true;
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + res.ResultInfo + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    model.ErrorCode = "-1";
                    model.ErrorMessage = "連接失敗";
                    model.TempMessage = "取得預約交易代碼失敗(-1)";
                    //throw;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool RunPayTranx(Apply_001007ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001007";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID("001007");

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001007");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }


                    ApplyModel apply = new ApplyModel();
                    apply.InjectFrom(UserInfo);
                    apply.MOBILE = model.MOBILE.TONotNullString() != "" ? model.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.APP_ID = model.APP_ID;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.SRV_ID = "001007";
                    apply.SRC_SRV_ID = "001007";
                    apply.APP_EXT_DATE = this.GetNTFD("001007");
                    apply.APP_TIME = HelperUtil.TransTwToDateTime(model.APPLY_DATE);
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);

                    Apply_001007Model apply001007 = new Apply_001007Model();
                    apply001007.APP_ID = model.APP_ID;
                    apply001007.DIVISION = model.DIVISION;
                    apply001007.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001007.ACTION_RES = model.ACTION_RES;
                    apply001007.OTHER_RES = model.OTHER_RES;
                    apply001007.ACTION_TYPE = model.ACTION_TYPE;
                    apply001007.LIC_CD = model.LIC_CD;
                    apply001007.LIC_TYPE = model.LIC_TYPE;
                    apply001007.LIC_NUM = model.LIC_NUM;
                    apply001007.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001007.ADD_TIME = DateTime.Now;
                    apply001007.ADD_FUN_CD = "WEB-APPLY";
                    apply001007.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001007.UPD_TIME = DateTime.Now;
                    apply001007.UPD_FUN_CD = "WEB-APPLY";
                    apply001007.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001007.DEL_MK = "N";
                    this.Insert(apply001007);

                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = model.APP_ID;
                    applyPay.PAY_ID = model.APP_ID;
                    apply.SRV_ID = "001007";
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = "WEB-APPLY";
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = "WEB-APPLY";
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001007", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "專科醫師證書補（換）發申請作業，案件編號﹕" + model.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之專科醫師證書補（換）發案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001007/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(model.MAIL, subject, MailBody);

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = false;
                    throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool SaveAppDoc001007(Apply_001007ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001007");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    if (model.Apply.ISMODIFY == "Y")
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.NAME = model.APPLY_NAME;
                        apply.IDN = model.APPLY_PID;
                        apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL_NO.TONotNullString() != "" && model.TEL_SEC.TONotNullString() != "" ?
                            (model.TEL_EXT.TONotNullString() != "" ? model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString() + "#" + model.TEL_EXT.TONotNullString() : model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString()) : "";
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        apply.MOBILE = model.Apply.MOBILE;
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                        Apply_001007Model apply001007Where = new Apply_001007Model();
                        apply001007Where.APP_ID = model.APP_ID;
                        Apply_001007Model apply001007 = new Apply_001007Model();

                        apply001007.APP_ID = model.APP_ID;
                        apply001007.DIVISION = model.DIVISION;
                        apply001007.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                        apply001007.ACTION_RES = model.ACTION_RES;
                        apply001007.OTHER_RES = model.OTHER_RES;
                        apply001007.ACTION_TYPE = model.ACTION_TYPE;
                        apply001007.LIC_CD = model.LIC_CD;
                        apply001007.LIC_TYPE = model.LIC_TYPE;
                        apply001007.LIC_NUM = model.LIC_NUM;
                        apply001007.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                        apply001007.UPD_TIME = DateTime.Now;
                        apply001007.UPD_FUN_CD = "WEB-APPLY";
                        apply001007.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply001007, apply001007Where);
                        this.Update2(apply001007, apply001007Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.APP_TIME = DateTime.Now;
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                    }

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.File.FILENAME;
                        fileWhere.FILE_NO = model.File.FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        model.File.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001007", model.ATTACH_FILE, "1");
                        model.File.FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        model.File.SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 1;
                        model.File.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001007", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001007", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    model.File.FILE_NO = 1;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}
                    }
                    else
                    {
                        if (model.File.FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.File.FILENAME;
                            fileWhere.FILE_NO = model.File.FILE_NO;

                            model.File = this.GetRow(fileWhere);
                        }

                    }
                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("SaveAppDoc001007 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public byte[] ExportPayPDF(string id)
        {
            Dictionary<string, object> data = null;
            byte[] result;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                FormAction action = new FormAction(conn);
                data = action.GetApplyData(id);
                conn.Close();
                conn.Dispose();
            }

            Dictionary<string, string> dict = new Dictionary<string, string>();

            dict.Add("VirtualAccount", (string)data["SESSION_KEY"]);
            dict.Add("Fee", (Int32.Parse(data["PAY_A_FEE"].ToString()) + Int32.Parse(DataUtils.GetConfig("PAY_STORE_FEE"))).ToString());
            dict.Add("Name", data["NAME"].ToString());
            dict.Add("ServiceName", data["SRV_NAME"].ToString());
            dict.Add("ApplyId", data["APP_ID"].ToString());
            dict.Add("PayDeadline", ((DateTime)data["PAY_DEADLINE"]).ToString("yyyy/MM/dd"));

            DateTime dt = (DateTime)data["PAY_DEADLINE"];

            string[] b1 = PayUtils.GetStore(dt, dict["VirtualAccount"], Int32.Parse(dict["Fee"]));
            string[] b2 = PayUtils.GetPost(dt, dict["VirtualAccount"], Int32.Parse(dict["Fee"]));

            dict.Add("Store1", b1[0]);
            dict.Add("Store2", b1[1]);
            dict.Add("Store3", b1[2]);

            dict.Add("Post1", b2[0]);
            dict.Add("Post2", b2[1]);
            dict.Add("Post3", b2[2]);

            result = PayUtils.GetPDF(dict);

            return result;

        }

        #endregion

        #region Apply_001034 危險性醫療儀器進口申請作業

        /// <summary>
        /// 新增危險性醫療儀器進口申請作業案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply001034(Apply_001034ViewModel form)
        {
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "001034";
            var APP_ID = GetApp_ID(CaseNum);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    form.APP_ID = APP_ID;

                    // Insert Apply
                    ApplyModel apply = new ApplyModel();
                    // 帶入基本資料
                    apply.InjectFrom(UserInfo);
                    apply.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    apply.ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    apply.CNT_TEL = form.TEL_EXT.TONotNullString() != "" ? form.TEL_SEC + "-" + form.TEL_NO + "#" + form.TEL_EXT : form.TEL_SEC + "-" + form.TEL_NO;
                    apply.FAX = form.FAX_EXT.TONotNullString() != "" ? form.FAX_SEC + "-" + form.FAX_NO + "#" + form.FAX_EXT : form.FAX_SEC + "-" + form.FAX_NO;
                    apply.MOBILE = UserInfo.MOBILE.TONotNullString();
                    apply.PAY_POINT = "A";
                    apply.APP_ID = APP_ID;
                    apply.SRV_ID = CaseNum;
                    apply.SRC_SRV_ID = CaseNum;
                    apply.UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(apply);

                    // Insert 危險性醫療儀器進口申請作業案件
                    Apply_001034Model apply001034 = new Apply_001034Model();
                    apply001034.InjectFrom(form);
                    apply001034.APP_ID = APP_ID;
                    apply001034.TAX_ZIP_CODE = form.TAX_ORG_CITY_CODE;
                    apply001034.TAX_ORG_ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    apply001034.TAX_ORG_TEL = form.TEL_EXT.TONotNullString() != "" ? form.TEL_SEC + "-" + form.TEL_NO + "#" + form.TEL_EXT : form.TEL_SEC + "-" + form.TEL_NO;
                    apply001034.TAX_ORG_FAX = form.FAX_EXT.TONotNullString() != "" ? form.FAX_SEC + "-" + form.TEL_NO + "#" + form.FAX_EXT : form.FAX_SEC + "-" + form.FAX_NO;
                    apply001034.TAX_ORG_EMAIL = form.MAIL_ACCOUNT + "@" + form.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001034.IM_EXPORT = "1";
                    apply001034.DATE_S = HelperUtil.TransToDateTime(form.DATE_S_AC);
                    apply001034.DATE_E = HelperUtil.TransToDateTime(form.DATE_E_AC);
                    apply001034.APP_USE = form.APP_USE_TEXT;
                    apply001034.CONF_TYPE = form.CONF_TYPE_TEXT;

                    apply001034.ADD_TIME = DateTime.Now;
                    apply001034.ADD_FUN_CD = "WEB-APPLY";
                    apply001034.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001034.UPD_TIME = DateTime.Now;
                    apply001034.UPD_FUN_CD = "WEB-APPLY";
                    apply001034.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001034.DEL_MK = "N";

                    base.Insert(apply001034);

                    //Insert 危險性醫療儀器進口申請作業 貨品資料
                    ShareDAO shareDao = new ShareDAO();
                    int fileCount = 1;
                    int batchIndex = 1;
                    foreach (var item in form.Goods)
                    {
                        Apply_001034_GoodsModel good = new Apply_001034_GoodsModel();
                        Apply_FileModel file = null;

                        good.InjectFrom(item);
                        good.APP_ID = APP_ID;
                        good.GOODS_TYPE_ID = item.GOODS_TYPE_ID;
                        good.GOODS_TYPE = item.GOODS_TYPE_TEXT;
                        good.GOODS_ID = item.SRL_NO < 10 ? APP_ID + "0" + item.SRL_NO.ToString() : APP_ID + item.SRL_NO.ToString();
                        good.GOODS_NAME = item.GOODS_TYPE;
                        good.GOODS_UNIT = item.GOODS_UNIT_TEXT;

                        #region 檢附文件類型 

                        if (item.DOC_TYP_01_CHK)
                        {
                            good.DOC_TYP_01 = "C11";
                        }
                        else
                        {
                            good.DOC_TYP_01 = "";
                        }

                        if (item.DOC_TYP_02_CHK)
                        {
                            good.DOC_TYP_02 = "C12";
                        }
                        else
                        {
                            good.DOC_TYP_02 = "";
                        }

                        if (item.DOC_TYP_03_CHK)
                        {
                            good.DOC_TYP_03 = "C13";
                        }
                        else
                        {
                            good.DOC_TYP_03 = "";
                        }

                        if (item.DOC_TYP_04_CHK)
                        {
                            good.DOC_TYP_04 = "C14";
                        }
                        else
                        {
                            good.DOC_TYP_04 = "";
                        }

                        if (item.DOC_TYP_05_CHK)
                        {
                            good.DOC_TYP_05 = "C15";
                        }
                        else
                        {
                            good.DOC_TYP_05 = "";
                        }

                        if (item.DOC_TYP_06_CHK)
                        {
                            good.DOC_TYP_06 = "C16";
                        }
                        else
                        {
                            good.DOC_TYP_06 = "";
                        }

                        if (item.DOC_TYP_07_CHK)
                        {
                            good.DOC_TYP_07 = "C17";
                        }
                        else
                        {
                            good.DOC_TYP_07 = "";
                        }

                        if (item.DOC_TYP_08_CHK)
                        {
                            good.DOC_TYP_08 = "C18";
                        }
                        else
                        {
                            good.DOC_TYP_08 = "";
                        }

                        if (item.DOC_TYP_09_CHK)
                        {
                            good.DOC_TYP_09 = "C19";
                        }
                        else
                        {
                            good.DOC_TYP_09 = "";
                        }

                        if (item.DOC_TYP_10_CHK)
                        {
                            good.DOC_TYP_10 = "C21";
                        }
                        else
                        {
                            good.DOC_TYP_10 = "";
                        }

                        if (item.DOC_TYP_11_CHK)
                        {
                            good.DOC_TYP_11 = "C22";
                        }
                        else
                        {
                            good.DOC_TYP_11 = "";
                        }

                        if (item.DOC_TYP_12_CHK)
                        {
                            good.DOC_TYP_12 = "C23";
                        }
                        else
                        {
                            good.DOC_TYP_12 = "";
                        }

                        if (item.DOC_TYP_13_CHK)
                        {
                            good.DOC_TYP_13 = "C24";
                        }
                        else
                        {
                            good.DOC_TYP_13 = "";
                        }

                        if (item.DOC_TYP_14_CHK)
                        {
                            good.DOC_TYP_14 = "C25";
                        }
                        else
                        {
                            good.DOC_TYP_14 = "";
                        }

                        if (item.DOC_TYP_15_CHK)
                        {
                            good.DOC_TYP_15 = "C26";
                        }
                        else
                        {
                            good.DOC_TYP_15 = "";
                        }

                        if (item.DOC_TYP_16_CHK)
                        {
                            good.DOC_TYP_16 = "C31";
                        }
                        else
                        {
                            good.DOC_TYP_16 = "";
                        }

                        if (item.DOC_TYP_17_CHK)
                        {
                            good.DOC_TYP_17 = "C32";
                        }
                        else
                        {
                            good.DOC_TYP_17 = "";
                        }

                        if (item.DOC_TYP_18_CHK)
                        {
                            good.DOC_TYP_18 = "C33";
                        }
                        else
                        {
                            good.DOC_TYP_18 = "";
                        }

                        if (item.DOC_TYP_19_CHK)
                        {
                            good.DOC_TYP_19 = "C91";
                        }
                        else
                        {
                            good.DOC_TYP_19 = "";
                        }

                        #endregion 

                        good.ADD_TIME = DateTime.Now;
                        good.ADD_FUN_CD = "WEB-APPLY";
                        good.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        good.UPD_TIME = DateTime.Now;
                        good.UPD_FUN_CD = "WEB-APPLY";
                        good.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        good.DEL_MK = "N";

                        base.Insert(good);

                        #region 檔案附件 

                        if (!item.DOC_TYP_01_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_01_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_01_FILE_NAME;
                            file.SRC_NO = 1;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_02_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_02_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_02_FILE_NAME;
                            file.SRC_NO = 2;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_03_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_03_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_03_FILE_NAME;
                            file.SRC_NO = 3;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_04_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_04_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_04_FILE_NAME;
                            file.SRC_NO = 4;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_05_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_05_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_05_FILE_NAME;
                            file.SRC_NO = 5;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_06_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_06_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_06_FILE_NAME;
                            file.SRC_NO = 6;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_07_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_07_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_07_FILE_NAME;
                            file.SRC_NO = 7;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_08_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_08_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_08_FILE_NAME;
                            file.SRC_NO = 8;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_09_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_09_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_09_FILE_NAME;
                            file.SRC_NO = 9;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_10_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_10_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_10_FILE_NAME;
                            file.SRC_NO = 10;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_11_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_11_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_11_FILE_NAME;
                            file.SRC_NO = 11;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_12_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_12_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_12_FILE_NAME;
                            file.SRC_NO = 12;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_13_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_13_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_13_FILE_NAME;
                            file.SRC_NO = 13;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_14_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_14_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_14_FILE_NAME;
                            file.SRC_NO = 14;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_15_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_15_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_15_FILE_NAME;
                            file.SRC_NO = 15;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_16_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_16_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_16_FILE_NAME;
                            file.SRC_NO = 16;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_17_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_17_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_17_FILE_NAME;
                            file.SRC_NO = 17;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_18_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_18_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_18_FILE_NAME;
                            file.SRC_NO = 18;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        if (!item.DOC_TYP_19_FILE_NAME.TONotNullString().Equals(""))
                        {
                            file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = fileCount;
                            file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_19_FILE, fileCount.ToString());
                            file.SRC_FILENAME = item.DOC_TYP_19_FILE_NAME;
                            file.SRC_NO = 19;
                            file.BATCH_INDEX = batchIndex;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);

                            fileCount++;
                        }

                        #endregion

                        batchIndex++;

                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "危險性醫療儀器進口申請作業，案件編號﹕" + form.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += UserInfo.NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + (Convert.ToInt32(DateTime.Now.ToString("yyyy")) - 1911).ToString() + "年" + DateTime.Now.ToString("yyyyMMdd").Substring(4, 2) + "月" + DateTime.Now.ToString("yyyyMMdd").Substring(6, 2) + "日申辦之危險性醫療儀器進口申請作業<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001034/AppDoc?APP_ID=" + form.APP_ID + "'>" + form.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(UserInfo.MAIL, subject, MailBody);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply001034 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 取得危險性醫療儀器進口申請案件
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001034ViewModel QueryApply_001034(Apply_001034ViewModel parm)
        {
            Apply_001034ViewModel result = new Apply_001034ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {

                    string _sql = @"SELECT APP_ID, TAX_ORG_ID, TAX_ORG_NAME, TAX_ORG_ENAME, TAX_ZIP_CODE, TAX_ORG_ADDR, TAX_ORG_EADDR, TAX_ORG_MAN, TAX_ORG_TEL, TAX_ORG_EMAIL,
                                TAX_ORG_FAX, IM_EXPORT, DATE_S, DATE_E, DEST_STATE_ID, DEST_STATE, SELL_STATE_ID, SELL_STATE, TRN_PORT_ID, TRN_PORT, BEG_PORT_ID, BEG_PORT,
                                SELL_NAME, SELL_ADDR, APP_USE_ID, APP_USE, USE_MARK, CONF_TYPE_ID, CONF_TYPE, COPIES, MDOD_APPNO, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME,
                                UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                             FROM APPLY_001034
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001034ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                        { "@ACC_NO", result.Apply.ACC_NO }
                    };
                    parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //         WHERE 1 = 1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,SRL_NO,GOODS_TYPE_ID,GOODS_TYPE,GOODS_ID,GOODS_NAME,APPLY_CNT,GOODS_UNIT_ID,GOODS_UNIT,GOODS_MODEL,GOODS_SPEC_1,GOODS_SPEC_2,GOODS_BRAND,
	                           GOODS_DESC,DOC_TYP_01,DOC_COD_01,DOC_TXT_01,DOC_TYP_02,DOC_COD_02,DOC_TXT_02,DOC_TYP_03,DOC_COD_03,DOC_TXT_03,DOC_TYP_04,DOC_COD_04,DOC_TXT_04,
	                           DOC_TYP_05,DOC_COD_05,DOC_TXT_05,DOC_TYP_06,DOC_COD_06,DOC_TXT_06,DOC_TYP_07,DOC_COD_07,DOC_TXT_07,DOC_TYP_08,DOC_COD_08,DOC_TXT_08,DOC_TYP_09,
	                           DOC_COD_09,DOC_TXT_09,DOC_TYP_10,DOC_COD_10,DOC_TXT_10,DOC_TYP_11,DOC_COD_11,DOC_TXT_11,DOC_TYP_12,DOC_COD_12,DOC_TXT_12,DOC_TYP_13,DOC_COD_13,
	                           DOC_TXT_13,DOC_TYP_14,DOC_COD_14,DOC_TXT_14,DOC_TYP_15,DOC_COD_15,DOC_TXT_15,DOC_TYP_16,DOC_COD_16,DOC_TXT_16,DOC_TYP_17,DOC_COD_17,DOC_TXT_17,
	                           DOC_TYP_18,DOC_COD_18,DOC_TXT_18,DOC_TYP_19,DOC_COD_19,DOC_TXT_19,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC
                             FROM APPLY_001034_GOODS 
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Goods = conn.Query<Apply_001034_GoodsViewModel>(_sql, parameters).ToList<Apply_001034_GoodsViewModel>();

                    _sql = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Files = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();

                result.APPLY_NAME = result.Apply.NAME;
                result.APPLY_PID = result.Apply.IDN;

                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                //result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //起始日期
                result.DATE_S_AC = HelperUtil.DateTimeToString(result.DATE_S);

                //終止日期
                result.DATE_E_AC = HelperUtil.DateTimeToString(result.DATE_E);

                //性別
                result.GENDER = result.Apply.SEX_CD == "M" ? "男" : "女";

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                // 電話
                string[] tel = result.TAX_ORG_TEL.Split('-');
                if (result.TAX_ORG_TEL.TONotNullString().Trim() != "")
                {
                    result.TEL_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.TEL_NO = tel[1];

                        if (result.TEL_NO.Contains("#"))
                        {
                            result.TEL_NO = result.TEL_NO.Split('#')[0];
                        }

                        if (result.TAX_ORG_TEL.IndexOf('#') > 0)
                        {
                            result.TEL_EXT = result.TAX_ORG_TEL.Split('#')[1];
                        }
                    }
                }

                // 傳真
                string[] fax = result.TAX_ORG_FAX.Split('-');
                if (result.TAX_ORG_FAX.TONotNullString().Trim() != "")
                {
                    result.FAX_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.FAX_NO = tel[1];

                        if (result.FAX_NO.Contains("#"))
                        {
                            result.FAX_NO = result.FAX_NO.Split('#')[0];
                        }

                        if (result.TAX_ORG_FAX.IndexOf('#') > 0)
                        {
                            result.FAX_EXT = result.TAX_ORG_FAX.Split('#')[1];
                        }
                    }
                }

                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.TAX_ZIP_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.TAX_ORG_ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                // 聯絡地址
                zip = new TblZIPCODE();
                zip.ZIP_CO = result.TAX_ZIP_CODE;
                address = dao.GetRow(zip);
                result.TAX_ORG_CITY_CODE = result.TAX_ZIP_CODE;
                if (address != null)
                {
                    result.TAX_ORG_CITY_TEXT = address.TOWNNM;
                    result.TAX_ORG_CITY_DETAIL = result.TAX_ORG_ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.TAX_ORG_EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.TAX_ORG_EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.TAX_ORG_EMAIL.Split('@')[1];

                    switch (result.TAX_ORG_EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                //檢附文件類型
                foreach (var item in result.Goods)
                {
                    #region doc type check setting

                    if (item.DOC_TYP_01.TONotNullString() == "")
                    {
                        item.DOC_TYP_01_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_01_CHK = true;
                    }

                    if (item.DOC_TYP_02.TONotNullString() == "")
                    {
                        item.DOC_TYP_02_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_02_CHK = true;
                    }

                    if (item.DOC_TYP_03.TONotNullString() == "")
                    {
                        item.DOC_TYP_03_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_03_CHK = true;
                    }

                    if (item.DOC_TYP_04.TONotNullString() == "")
                    {
                        item.DOC_TYP_04_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_04_CHK = true;
                    }

                    if (item.DOC_TYP_05.TONotNullString() == "")
                    {
                        item.DOC_TYP_05_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_05_CHK = true;
                    }

                    if (item.DOC_TYP_06.TONotNullString() == "")
                    {
                        item.DOC_TYP_06_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_06_CHK = true;
                    }

                    if (item.DOC_TYP_07.TONotNullString() == "")
                    {
                        item.DOC_TYP_07_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_07_CHK = true;
                    }

                    if (item.DOC_TYP_08.TONotNullString() == "")
                    {
                        item.DOC_TYP_08_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_08_CHK = true;
                    }

                    if (item.DOC_TYP_09.TONotNullString() == "")
                    {
                        item.DOC_TYP_09_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_09_CHK = true;
                    }

                    if (item.DOC_TYP_10.TONotNullString() == "")
                    {
                        item.DOC_TYP_10_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_10_CHK = true;
                    }

                    if (item.DOC_TYP_11.TONotNullString() == "")
                    {
                        item.DOC_TYP_11_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_11_CHK = true;
                    }

                    if (item.DOC_TYP_12.TONotNullString() == "")
                    {
                        item.DOC_TYP_12_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_12_CHK = true;
                    }

                    if (item.DOC_TYP_13.TONotNullString() == "")
                    {
                        item.DOC_TYP_13_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_13_CHK = true;
                    }

                    if (item.DOC_TYP_14.TONotNullString() == "")
                    {
                        item.DOC_TYP_14_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_14_CHK = true;
                    }

                    if (item.DOC_TYP_15.TONotNullString() == "")
                    {
                        item.DOC_TYP_15_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_15_CHK = true;
                    }

                    if (item.DOC_TYP_16.TONotNullString() == "")
                    {
                        item.DOC_TYP_16_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_16_CHK = true;
                    }

                    if (item.DOC_TYP_17.TONotNullString() == "")
                    {
                        item.DOC_TYP_17_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_17_CHK = true;
                    }

                    if (item.DOC_TYP_18.TONotNullString() == "")
                    {
                        item.DOC_TYP_18_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_18_CHK = true;
                    }

                    if (item.DOC_TYP_19.TONotNullString() == "")
                    {
                        item.DOC_TYP_19_CHK = false;
                    }
                    else
                    {
                        item.DOC_TYP_19_CHK = true;
                    }

                    #endregion
                }


            }

            return result;
        }


        /// <summary>
        /// 取得危險性醫療儀器進口申請案件補件更新
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public int UpdateAddtionalDocApply_001034(Apply_001034ViewModel model)
        {
            int result = -1;
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            ShareDAO shareDao = new ShareDAO();
            Apply_FileModel fileModel = new Apply_FileModel();
            fileModel.APP_ID = model.APP_ID;
            fileList = this.GetRowList<Apply_FileModel>(fileModel).ToList();

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    int? fileCount = GetFileNo(model.APP_ID) + 1;
                    //Update Apply
                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();

                    apply.FLOW_CD = "3";
                    apply.ADDR_CODE = model.TAX_ORG_CITY_CODE.TONotNullString() != "" ? model.TAX_ORG_CITY_CODE : null;
                    apply.ADDR = model.TAX_ORG_CITY_TEXT.TONotNullString() != "" ? model.TAX_ORG_CITY_TEXT + model.TAX_ORG_CITY_DETAIL : null;
                    apply.CNT_TEL = model.TEL.TONotNullString() == "" ? null : model.TEL;
                    apply.FAX = model.FAX.TONotNullString() == "" ? null : model.FAX;
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyWhere.APP_ID = model.APP_ID;

                    result = this.Update(apply, applyWhere);

                    // Update 危險性醫療儀器進口申請作業案件
                    Apply_001034Model apply001034 = new Apply_001034Model();
                    Apply_001034Model apply001034Where = new Apply_001034Model();
                    apply001034Where.APP_ID = model.APP_ID;
                    apply001034.InjectFrom(model);
                    apply001034.TAX_ZIP_CODE = model.TAX_ORG_CITY_CODE.TONotNullString() != "" ? model.TAX_ORG_CITY_CODE : null;
                    apply001034.TAX_ORG_ADDR = model.TAX_ORG_CITY_TEXT.TONotNullString() != "" ? model.TAX_ORG_CITY_TEXT + model.TAX_ORG_CITY_DETAIL : null;
                    apply001034.TAX_ORG_TEL = model.TEL.TONotNullString() == "" ? null : model.TEL;
                    apply001034.TAX_ORG_FAX = model.FAX.TONotNullString() == "" ? null : model.FAX;
                    apply001034.TAX_ORG_EMAIL = model.MAIL;
                    apply001034.DATE_S = model.DATE_S_AC.TONotNullString() == "" ? null : HelperUtil.TransToDateTime(model.DATE_S_AC);
                    apply001034.DATE_E = model.DATE_E_AC.TONotNullString() == "" ? null : HelperUtil.TransToDateTime(model.DATE_E_AC);
                    apply001034.APP_USE = model.APP_USE_TEXT.TONotNullString() == "" ? null : model.APP_USE_TEXT;
                    apply001034.CONF_TYPE = model.CONF_TYPE_TEXT.TONotNullString() == "" ? null : model.CONF_TYPE_TEXT;
                    apply001034.UPD_TIME = DateTime.Now;
                    apply001034.UPD_FUN_CD = "WEB-APPLY";
                    apply001034.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    result = this.Update(apply001034, apply001034Where);

                    //檢附文件類型
                    foreach (var item in model.Goods)
                    {
                        Apply_001034_GoodsModel good = new Apply_001034_GoodsModel();
                        Apply_001034_GoodsModel goodWhere = new Apply_001034_GoodsModel();
                        goodWhere.APP_ID = model.APP_ID;
                        good.InjectFrom(item);

                        good.UPD_TIME = DateTime.Now;
                        good.UPD_FUN_CD = "WEB-APPLY";
                        good.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        result = base.Update(good, goodWhere);

                        Apply_FileModel file = new Apply_FileModel();
                        Apply_FileModel fileWhere = new Apply_FileModel();

                        #region update file ,value seq.:APP_ID,FILE_NO,BATCH_INDEX,SRC_NO

                        if (item.DOC_TYP_01_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_01_FILE != null)
                        {
                            fileWhere.APP_ID = item.DOC_TYP_01_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_01_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_01_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_01_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_01_FILE, (item.DOC_TYP_01_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_01_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_01_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_01_FILE.FileName;
                                file.SRC_NO = 1;
                                file.BATCH_INDEX = (item.DOC_TYP_01_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }
                        }

                        if (item.DOC_TYP_02_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_02_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_02_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_02_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_02_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_02_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_02_FILE, (item.DOC_TYP_02_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_02_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_02_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_02_FILE.FileName;
                                file.SRC_NO = 2;
                                file.BATCH_INDEX = (item.DOC_TYP_02_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_03_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_03_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_03_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_03_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_03_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_03_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_03_FILE, (item.DOC_TYP_03_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_03_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_03_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_03_FILE.FileName;
                                file.SRC_NO = 3;
                                file.BATCH_INDEX = (item.DOC_TYP_03_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_04_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_04_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_04_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_04_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_04_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_04_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_04_FILE, (item.DOC_TYP_04_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_04_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_04_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_04_FILE.FileName;
                                file.SRC_NO = 4;
                                file.BATCH_INDEX = (item.DOC_TYP_04_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_05_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_05_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_05_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_05_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_05_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_05_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_05_FILE, (item.DOC_TYP_05_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_05_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_05_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_05_FILE.FileName;
                                file.SRC_NO = 5;
                                file.BATCH_INDEX = (item.DOC_TYP_05_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_06_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_06_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_06_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_06_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_06_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_06_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_06_FILE, (item.DOC_TYP_06_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_06_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_06_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_06_FILE.FileName;
                                file.SRC_NO = 6;
                                file.BATCH_INDEX = (item.DOC_TYP_06_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_07_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_07_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_07_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_07_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_07_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_07_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_07_FILE, (item.DOC_TYP_07_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_07_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_07_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_07_FILE.FileName;
                                file.SRC_NO = 7;
                                file.BATCH_INDEX = (item.DOC_TYP_07_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_08_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_08_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_08_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_08_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_08_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_08_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_08_FILE, (item.DOC_TYP_08_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_08_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_08_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_08_FILE.FileName;
                                file.SRC_NO = 8;
                                file.BATCH_INDEX = (item.DOC_TYP_08_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_09_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_09_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_09_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_09_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_09_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_09_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_09_FILE, (item.DOC_TYP_09_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_09_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);

                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_09_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_09_FILE.FileName;
                                file.SRC_NO = 9;
                                file.BATCH_INDEX = (item.DOC_TYP_09_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_10_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_10_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_10_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_10_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_10_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_10_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_10_FILE, (item.DOC_TYP_10_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_10_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_10_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_10_FILE.FileName;
                                file.SRC_NO = 10;
                                file.BATCH_INDEX = (item.DOC_TYP_10_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }


                        }

                        if (item.DOC_TYP_11_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_11_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_11_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_11_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_11_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_11_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_11_FILE, (item.DOC_TYP_11_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_11_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_11_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_11_FILE.FileName;
                                file.SRC_NO = 11;
                                file.BATCH_INDEX = (item.DOC_TYP_11_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_12_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_12_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_12_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_12_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_12_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_12_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_12_FILE, (item.DOC_TYP_12_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_12_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_12_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_12_FILE.FileName;
                                file.SRC_NO = 12;
                                file.BATCH_INDEX = (item.DOC_TYP_12_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }
                        }

                        if (item.DOC_TYP_13_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_13_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_13_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_13_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_13_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_13_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_13_FILE, (item.DOC_TYP_13_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_13_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_13_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_13_FILE.FileName;
                                file.SRC_NO = 13;
                                file.BATCH_INDEX = (item.DOC_TYP_13_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_14_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_14_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_14_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_14_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_14_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_14_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_14_FILE, (item.DOC_TYP_14_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_14_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_14_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_14_FILE.FileName;
                                file.SRC_NO = 14;
                                file.BATCH_INDEX = (item.DOC_TYP_14_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }
                        }

                        if (item.DOC_TYP_15_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_15_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_15_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_15_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_15_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_15_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_15_FILE, (item.DOC_TYP_15_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_15_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_15_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_15_FILE.FileName;
                                file.SRC_NO = 15;
                                file.BATCH_INDEX = (item.DOC_TYP_15_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_16_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_16_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_16_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_16_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_16_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_16_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_16_FILE, (item.DOC_TYP_16_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_16_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_16_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_16_FILE.FileName;
                                file.SRC_NO = 16;
                                file.BATCH_INDEX = (item.DOC_TYP_16_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }
                        }

                        if (item.DOC_TYP_17_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_17_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_17_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_17_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_17_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_17_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_17_FILE, (item.DOC_TYP_17_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_17_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_17_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_17_FILE.FileName;
                                file.SRC_NO = 17;
                                file.BATCH_INDEX = (item.DOC_TYP_17_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }
                        }

                        if (item.DOC_TYP_18_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_18_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_18_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_18_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_18_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_18_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_18_FILE, (item.DOC_TYP_18_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_18_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_18_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_18_FILE.FileName;
                                file.SRC_NO = 18;
                                file.BATCH_INDEX = (item.DOC_TYP_18_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        if (item.DOC_TYP_19_FILE_SRC.TONotNullString() != "" && item.DOC_TYP_19_FILE != null)
                        {
                            file = new Apply_FileModel();
                            fileWhere = new Apply_FileModel();

                            fileWhere.APP_ID = item.DOC_TYP_19_FILE_SRC.Split(',')[0];
                            fileWhere.FILE_NO = (item.DOC_TYP_19_FILE_SRC.Split(',')[1]).TOInt32();
                            fileWhere.BATCH_INDEX = (item.DOC_TYP_19_FILE_SRC.Split(',')[2]).TOInt32();
                            fileWhere.SRC_NO = (item.DOC_TYP_19_FILE_SRC.Split(',')[3]).TOInt32();

                            if (IsFileExist(fileWhere))
                            {
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_19_FILE, (item.DOC_TYP_19_FILE_SRC.Split(',')[1]).TOInt32().ToString());
                                file.SRC_FILENAME = item.DOC_TYP_19_FILE.FileName;
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                result = this.Update(file, fileWhere);
                            }
                            else
                            {
                                file = new Apply_FileModel();
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = fileCount;
                                file.FILENAME = shareDao.PutFile("001034", item.DOC_TYP_19_FILE, fileCount.ToString());
                                file.SRC_FILENAME = item.DOC_TYP_19_FILE.FileName;
                                file.SRC_NO = 19;
                                file.BATCH_INDEX = (item.DOC_TYP_19_FILE_SRC.Split(',')[2]).TOInt32();
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";

                                result = this.Insert(file);
                                fileCount++;
                            }

                        }

                        #endregion
                    }

                    TblAPPLY_NOTICE notice = new TblAPPLY_NOTICE();
                    TblAPPLY_NOTICE noticeWhere = new TblAPPLY_NOTICE();

                    noticeWhere.APP_ID = model.APP_ID;
                    notice.ISADDYN = "Y";

                    result = base.Update(notice, noticeWhere);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = -1;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        private bool IsFileExist(Apply_FileModel file)
        {
            bool result = false;
            //value seq.:APP_ID,FILE_NO,BATCH_INDEX,SRC_NO
            if (fileList.Where(x => x.APP_ID == file.APP_ID && x.FILE_NO == file.FILE_NO
                && x.BATCH_INDEX == file.BATCH_INDEX && x.SRC_NO == file.SRC_NO).ToList().Count > 0)
            {
                result = true;
            }

            return result;
        }

        #endregion

        #region Apply_001036 專科護理師證書補(換)發

        /// <summary>
        /// 專科護理師證書補(換)發
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001036ViewModel QueryApply_001036(Apply_001036ViewModel parm)
        {
            Apply_001036ViewModel result = new Apply_001036ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"SELECT APP_ID,ACTION_TYPE,ISSUE_DATE,LIC_TYPE,LIC_CD,LIC_NUM,ACTION_RES,OTHER_RES,DEL_MK,
                                    DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,DIVISION,EMAIL
                             FROM APPLY_001036
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001036ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    _sql = @" SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME, PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK, PAY_RET_CD,
                            PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO, INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET, SESSION_KEY, AUTH_DATE,
                            AUTH_NO, SETTLE_DATE, OTHER, ROC_ID, CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                            FROM APPLY_PAY
                            WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.ApplyPay = conn.QueryFirst<APPLY_PAY>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,FILE_NO,SUBSTRING(FILENAME,16,LEN(FILENAME)) FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.File = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>().FirstOrDefault();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();

                result.APPLY_NAME = result.Apply.NAME;

                result.APPLY_PID = result.Apply.IDN;

                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                //核發日期
                result.ISSUE_DATE_AC = HelperUtil.DateTimeToString(result.ISSUE_DATE);

                // 電話
                string[] tel = result.Apply.TEL.Split('-');
                if (result.Apply.TEL.TONotNullString().Trim() != "")
                {
                    result.TEL_SEC = tel[0];
                    if (tel.ToCount() > 1)
                    {
                        result.TEL_NO = tel[1];

                        if (result.TEL_NO.Contains("#"))
                        {
                            result.TEL_NO = result.TEL_NO.Split('#')[0];
                        }

                        if (result.Apply.TEL.IndexOf('#') > 0)
                        {
                            result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                        }
                    }
                }

                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.Apply.ADDR_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                    switch (result.EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                ShareDAO shareDAO = new ShareDAO();
                if (shareDAO.CalculationDocDate("001007", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                {
                    result.IsNotice = "N";
                }
                else
                {
                    result.IsNotice = "Y";
                }

            }

            return result;
        }

        public bool RunCreditCardTranx(Apply_001036ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001036";
            conn = null;
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001036");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_METHOD", "C");
                    data.Put("PAY_CARD_IDN", model.CARD_IDN == null ? "" : model.CARD_IDN);
                    data.Put("PAY_A_FEEBK", "0");
                    data.Put("APP_FEE", model.PAY_A_FEE.ToString());
                    data.Put("PAY_ID", model.APP_ID);
                    data.Put("PAY_CLIENT_IP", model.CLIENT_IP);

                    Dictionary<string, string> pay = DataUtils.GetPayAccount(Convert.ToInt32(form["PAY_ACCOUNT"]));
                    data.Put("PAY_OID", pay["OID"]);
                    data.Put("PAY_SID", pay["SID"]);

                    #region 繳費
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001036");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();
                    apply.APP_ID = model.APP_ID;
                    apply.InjectFrom(UserInfo);
                    //apply.InjectFrom(model.Apply);                
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.MOBILE = model.MOBILE.TONotNullString() != "" ? model.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = "C";
                    apply.CARD_IDN = model.CARD_IDN;
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 55;
                    apply.PRO_UNIT_CD = 55;
                    apply.FLOW_CD = "1";
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.SRV_ID = "001036";
                    apply.SRC_SRV_ID = "001036";
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_EXT_DATE = this.GetNTFD("001036");
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    //this.Update(apply, applyWhere);
                    //this.Update2(apply, applyWhere, dict2);
                    Insert(apply);

                    Apply_001036Model apply001036 = new Apply_001036Model();
                    apply001036.APP_ID = model.APP_ID;
                    apply001036.DIVISION = model.DIVISION;
                    apply001036.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001036.ACTION_RES = model.ACTION_RES;
                    apply001036.OTHER_RES = model.OTHER_RES;
                    apply001036.ACTION_TYPE = model.ACTION_TYPE;
                    apply001036.LIC_CD = model.LIC_CD;
                    apply001036.LIC_TYPE = model.LIC_TYPE;
                    apply001036.LIC_NUM = model.LIC_NUM;
                    apply001036.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001036.ADD_TIME = DateTime.Now;
                    apply001036.ADD_FUN_CD = "WEB-APPLY";
                    apply001036.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001036.UPD_TIME = DateTime.Now;
                    apply001036.UPD_FUN_CD = "WEB-APPLY";
                    apply001036.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001036.DEL_MK = "N";
                    this.Insert(apply001036);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001036", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }
                    #endregion

                    if (model.ISEC.ToUpper() == "Y" && DateTime.Now >= Convert.ToDateTime(DataUtils.GetConfig("PAY_EC_SDATE")))
                    {
                        #region 聯合信用卡繳費中心
                        var ECmodel = new CreditHPPModel();
                        ECmodel.EncModel.MerchantID = DataUtils.GetConfig("PAY_EC_MERCHANTID");
                        ECmodel.EncModel.OrderID = "";
                        ECmodel.EncModel.TerminalID = DataUtils.GetConfig("PAY_EC_TRMINALID2");
                        ECmodel.EncModel.TransAmt = Convert.ToString(model.PAY_A_FEE);
                        ECmodel.EncModel.TransMode = "0";
                        ECmodel.EncModel.Template = "BOTH";
                        ECmodel.EncModel.CardholderName = "";
                        ECmodel.EncModel.CardholderEmailAddress = "";
                        ECmodel.EncModel.IDNUMBER = Convert.ToString(model.CARD_IDN); //持卡人身份證字號
                        ECmodel.EncModel.PrivateData = "ClientIP=" + model.CLIENT_IP + "&APPID=" + model.APP_ID + "&SRVID=" + serviceWhere.SRV_ID; //自訂資料
                        ECmodel.ECConnetModel.DomainName = DataUtils.GetConfig("PAY_EC_DOMAINNAME");
                        ECmodel.ECConnetModel.RequestURL = DataUtils.GetConfig("PAY_EC_REQUESTURL");
                        //*回應網址
                        ECmodel.EncModel.NotifyURL = DataUtils.GetConfig("PAY_EC_NOTIFYURL");
                        //聯合信用卡
                        ApiClient resEC = CardUtils.GetTransactionKeyEC(ECmodel);
                        if (resEC != null)
                        {
                            model.ErrorCode = resEC.getRESPONSECODE();
                            model.ErrorMessage = resEC.getRESPONSEMSG();
                            if (model.ErrorCode.Equals("00"))
                            {
                                //作業執行成功
                                logger.Debug("SessionTransactionKey: " + resEC.getKEY());

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001036";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = resEC.getKEY();
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                applyPay.PAY_BANK = "EC"; //聯合信用
                                applyPay.ECORDERID = resEC.getORDERID(); // EC datetime.tick
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                                model.SessionTransactionKey = resEC.getKEY();
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + model.ErrorCode + ":" + model.ErrorMessage + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }

                        #endregion
                    }
                    else
                    {
                        #region 我的E政府
                        SessionKeyResponse res = CardUtils.GetTransactionKey(data.GetItem(), pay);

                        if (res != null)
                        {
                            model.ErrorCode = res.ResultInfo;
                            model.ErrorMessage = action.GetPayCodeDesc(res.ResultInfo);
                            if (res.ResultInfo.Equals("0000"))
                            {
                                string sessionKey = res.SessionTransactionKey;
                                data.Put("PAY_SESSION_KEY", sessionKey);
                                logger.Debug("SessionTransactionKey: " + sessionKey);
                                model.SessionTransactionKey = sessionKey;

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001036";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = model.SessionTransactionKey;
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                this.Insert(applyPay);



                                BackApplyDAO backDao = new BackApplyDAO();
                                string subject = "專科護理師證書補(換)發，案件編號﹕" + model.APP_ID + " 申請通知";
                                string MailBody = "";
                                MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                                MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之專科護理師證書補(換)發案件<br/>";
                                MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001036/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                                MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                                MailBody += "衛生福利部護理及健康照護司敬上<br/><br/>";
                                MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                                //MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                                //MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                                //MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                                //MailBody += "115204 臺北市南港區忠孝東路六段488號";
                                backDao.SendMail(model.EMAIL, subject, MailBody);

                                tran.Commit();

                                result = true;
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + res.ResultInfo + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    model.ErrorCode = "-1";
                    model.ErrorMessage = "連接失敗";
                    model.TempMessage = "取得預約交易代碼失敗(-1)";
                    //throw;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool RunPayTranx(Apply_001036ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001036";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID("001036");

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001036");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }


                    ApplyModel apply = new ApplyModel();

                    apply.InjectFrom(UserInfo);
                    apply.APP_ID = model.APP_ID;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.SRV_ID = "001036";
                    apply.SRC_SRV_ID = "001036";
                    apply.APP_EXT_DATE = this.GetNTFD("001036");
                    apply.APP_TIME = HelperUtil.TransTwToDateTime(model.APPLY_DATE);
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;

                    apply.TEL = model.TEL_NO.TONotNullString() != "" && model.TEL_SEC.TONotNullString() != "" ?
                        (model.TEL_EXT.TONotNullString() != "" ? model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString() + "#" + model.TEL_EXT.TONotNullString() : model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString()) : "";
                    apply.MOBILE = model.MOBILE;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 55;
                    apply.PRO_UNIT_CD = 55;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);

                    Apply_001036Model apply001036 = new Apply_001036Model();
                    apply001036.APP_ID = model.APP_ID;
                    apply001036.DIVISION = model.DIVISION;
                    apply001036.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001036.ACTION_RES = model.ACTION_RES;
                    apply001036.OTHER_RES = model.OTHER_RES;
                    apply001036.ACTION_TYPE = model.ACTION_TYPE;
                    apply001036.LIC_CD = model.LIC_CD;
                    apply001036.LIC_TYPE = model.LIC_TYPE;
                    apply001036.LIC_NUM = model.LIC_NUM;
                    apply001036.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001036.ADD_TIME = DateTime.Now;
                    apply001036.ADD_FUN_CD = "WEB-APPLY";
                    apply001036.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001036.UPD_TIME = DateTime.Now;
                    apply001036.UPD_FUN_CD = "WEB-APPLY";
                    apply001036.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001036.DEL_MK = "N";
                    this.Insert(apply001036);

                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = model.APP_ID;
                    applyPay.PAY_ID = model.APP_ID;
                    apply.SRV_ID = "001036";
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = "WEB-APPLY";
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = "WEB-APPLY";
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001036", model.ATTACH_FILE, "1");
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "專科護理師證書補(換)發，案件編號﹕" + model.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之專科護理師證書補(換)發案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001036/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部護理及健康照護司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    //MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    //MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    //MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    //MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(model.EMAIL, subject, MailBody);

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool SaveAppDoc001036(Apply_001036ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;

                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001036");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));
                    if (model.Apply.ISMODIFY == "Y")
                    {

                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.NAME = model.APPLY_NAME;
                        apply.IDN = model.APPLY_PID;
                        apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL_NO.TONotNullString() != "" && model.TEL_SEC.TONotNullString() != "" ?
                        (model.TEL_EXT.TONotNullString() != "" ? model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString() + "#" + model.TEL_EXT.TONotNullString() : model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString()) : "";
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        apply.MOBILE = model.Apply.MOBILE;
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                        Apply_001036Model apply001036Where = new Apply_001036Model();
                        apply001036Where.APP_ID = model.APP_ID;
                        Apply_001036Model apply001036 = new Apply_001036Model();
                        apply001036.APP_ID = model.APP_ID;
                        apply001036.DIVISION = model.DIVISION;
                        apply001036.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                        apply001036.ACTION_RES = model.ACTION_RES;
                        apply001036.OTHER_RES = model.ACTION_RES.TONotNullString() == "E" ? model.OTHER_RES : "";
                        apply001036.ACTION_TYPE = model.ACTION_TYPE;
                        apply001036.LIC_CD = model.LIC_CD;
                        apply001036.LIC_TYPE = model.LIC_TYPE;
                        apply001036.LIC_NUM = model.LIC_NUM;
                        apply001036.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                        apply001036.UPD_TIME = DateTime.Now;
                        apply001036.UPD_FUN_CD = "WEB-APPLY";
                        apply001036.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply001036, apply001036Where);
                        this.Update2(apply001036, apply001036Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.APP_TIME = DateTime.Now;
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                    }

                    if (model.ATTACH_FILE != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.File.FILENAME;
                        fileWhere.FILE_NO = model.File.FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        model.File.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001036", model.ATTACH_FILE, "1");
                        model.File.FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        model.File.SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 1;
                        model.File.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001036", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.File.APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001036", model.ATTACH_FILE, "1");
                        //    model.File.FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                        //    model.File.SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    model.File.FILE_NO = 1;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}

                    }
                    else
                    {
                        if (model.File.FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.File.FILENAME;
                            fileWhere.FILE_NO = model.File.FILE_NO;

                            model.File = this.GetRow(fileWhere);
                        }

                    }

                    //Apply_Notice狀態更新
                    #region 案件通知(apply_notice)
                    TblAPPLY_NOTICE applyNotice = new TblAPPLY_NOTICE();
                    applyNotice.APP_ID = model.APP_ID;
                    applyNotice.ISADDYN = "Y";
                    TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
                    whereApplyNotice.APP_ID = model.APP_ID;
                    whereApplyNotice.ISADDYN = "N";

                    //base.Update(applyNotice, whereApplyNotice);
                    base.Update2(applyNotice, whereApplyNotice, dict2); //for log歷程顯示前置作業用
                    #endregion

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = false;
                    throw new Exception("SaveAppDoc001036 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        #endregion

        #region Apply_001037 醫事人員請領無懲戒紀錄證明申請書

        public bool RunCreditCardTranx(Apply_001037ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            conn = null;
            serviceWhere.SRV_ID = "001037";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {

                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001037");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_METHOD", "C");
                    data.Put("PAY_CARD_IDN", model.CARD_IDN == null ? "" : model.CARD_IDN);
                    data.Put("PAY_A_FEEBK", "0");
                    data.Put("APP_FEE", model.PAY_A_FEE.ToString());
                    data.Put("PAY_ID", model.APP_ID);
                    data.Put("PAY_CLIENT_IP", model.CLIENT_IP);

                    Dictionary<string, string> pay = DataUtils.GetPayAccount(Convert.ToInt32(form["PAY_ACCOUNT"]));
                    data.Put("PAY_OID", pay["OID"]);
                    data.Put("PAY_SID", pay["SID"]);

                    #region 繳費
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", serviceWhere.SRV_ID);
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();

                    apply.APP_ID = model.APP_ID;
                    apply.InjectFrom(UserInfo);
                    //apply.InjectFrom(model.Apply);
                    apply.MOBILE = model.MOBILE.TONotNullString();
                    apply.PAY_A_FEE = model.TOTAL;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = "C";
                    apply.CARD_IDN = model.CARD_IDN;
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.SRV_ID = "001037";
                    apply.SRC_SRV_ID = "001037";
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_EXT_DATE = this.GetNTFD("001037");
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    //this.Update(apply, applyWhere);
                    //this.Update2(apply, applyWhere, dict2);
                    Insert(apply);

                    Apply_001037Model apply001037 = new Apply_001037Model();
                    apply001037.APP_ID = model.APP_ID;
                    apply001037.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001037.LIC_CD = model.LIC_CD_TEXT;
                    apply001037.LIC_NUM = model.LIC_NUM;
                    apply001037.COPIES = model.COPIES;
                    apply001037.TOTAL = model.TOTAL;
                    apply001037.MAIL_REC = model.MAIL_REC;
                    apply001037.ADDR_CODE = model.MAIL_CITY_CODE;
                    apply001037.MAIL_ADDR = model.MAIL_CITY_TEXT + model.MAIL_CITY_DETAIL;
                    apply001037.MAIL_COUNTRY = model.MAIL_COUNTRY;
                    apply001037.REASON_1 = model.REASON_1;
                    apply001037.REASON_2 = model.REASON_2;
                    apply001037.REASON_3 = model.REASON_3;
                    apply001037.REASON_4 = model.REASON_4;
                    apply001037.REASON_5 = model.REASON_5;
                    apply001037.REASON_2_DESC = model.REASON_2_DESC;
                    apply001037.REASON_3_DESC = model.REASON_3_DESC;
                    apply001037.REASON_4_DESC = model.REASON_4_DESC;
                    apply001037.REASON_5_DESC = model.REASON_5_DESC;
                    apply001037.IS_MERGE_FILE = model.IS_MERGE_FILE;
                    apply001037.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001037.ADD_TIME = DateTime.Now;
                    apply001037.ADD_FUN_CD = "WEB-APPLY";
                    apply001037.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001037.UPD_TIME = DateTime.Now;
                    apply001037.UPD_FUN_CD = "WEB-APPLY";
                    apply001037.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001037.DEL_MK = "N";
                    this.Insert(apply001037);

                    if (model.FILE1 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE1, "1");
                        file.SRC_FILENAME = model.FILE1.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE2 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE2, "2");
                        file.SRC_FILENAME = model.FILE2.FileName;
                        file.FILE_NO = 2;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE3 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE3, "3");
                        file.SRC_FILENAME = model.FILE3.FileName;
                        file.FILE_NO = 3;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }
                    #endregion

                    if (model.ISEC.ToUpper() == "Y" && DateTime.Now >= Convert.ToDateTime(DataUtils.GetConfig("PAY_EC_SDATE")))
                    {
                        #region 聯合信用卡繳費中心
                        var ECmodel = new CreditHPPModel();
                        ECmodel.EncModel.MerchantID = DataUtils.GetConfig("PAY_EC_MERCHANTID");
                        ECmodel.EncModel.OrderID = "";
                        ECmodel.EncModel.TerminalID = DataUtils.GetConfig("PAY_EC_TRMINALID");
                        ECmodel.EncModel.TransAmt = Convert.ToString(model.PAY_A_FEE);
                        ECmodel.EncModel.TransMode = "0";
                        ECmodel.EncModel.Template = "BOTH";
                        ECmodel.EncModel.CardholderName = "";
                        ECmodel.EncModel.CardholderEmailAddress = "";
                        ECmodel.EncModel.IDNUMBER = Convert.ToString(model.CARD_IDN); //持卡人身份證字號
                        ECmodel.EncModel.PrivateData = "ClientIP=" + model.CLIENT_IP + "&APPID=" + model.APP_ID + "&SRVID=" + serviceWhere.SRV_ID; //自訂資料
                        ECmodel.ECConnetModel.DomainName = DataUtils.GetConfig("PAY_EC_DOMAINNAME");
                        ECmodel.ECConnetModel.RequestURL = DataUtils.GetConfig("PAY_EC_REQUESTURL");
                        //*回應網址
                        ECmodel.EncModel.NotifyURL = DataUtils.GetConfig("PAY_EC_NOTIFYURL");
                        //聯合信用卡
                        ApiClient resEC = CardUtils.GetTransactionKeyEC(ECmodel);
                        if (resEC != null)
                        {
                            model.ErrorCode = resEC.getRESPONSECODE();
                            model.ErrorMessage = resEC.getRESPONSEMSG();
                            if (model.ErrorCode.Equals("00"))
                            {
                                //作業執行成功
                                logger.Debug("SessionTransactionKey: " + resEC.getKEY());

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001037";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = resEC.getKEY();
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                applyPay.PAY_BANK = "EC"; //聯合信用
                                applyPay.ECORDERID = resEC.getORDERID(); // EC datetime.tick
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                                model.SessionTransactionKey = resEC.getKEY();
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + model.ErrorCode + ":" + model.ErrorMessage + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                    else
                    {
                        #region 我的E政府
                        SessionKeyResponse res = CardUtils.GetTransactionKey(data.GetItem(), pay);

                        if (res != null)
                        {
                            model.ErrorCode = res.ResultInfo;
                            model.ErrorMessage = action.GetPayCodeDesc(res.ResultInfo);
                            if (res.ResultInfo.Equals("0000"))
                            {
                                string sessionKey = res.SessionTransactionKey;
                                data.Put("PAY_SESSION_KEY", sessionKey);
                                logger.Debug("SessionTransactionKey: " + sessionKey);
                                model.SessionTransactionKey = sessionKey;

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001037";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = model.SessionTransactionKey;
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                this.Insert(applyPay);

                                BackApplyDAO backDao = new BackApplyDAO();
                                string subject = "醫事人員或公共衛生師請領無懲戒紀錄證明申請書，案件編號﹕" + model.APP_ID + " 申請通知";
                                string MailBody = "";
                                MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                                MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之醫事人員或公共衛生師請領無懲戒紀錄證明申請書案件<br/>";
                                MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001037/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                                MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                                MailBody += "衛生福利部醫事司敬上<br/><br/>";
                                MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                                MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                                MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                                MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                                MailBody += "115204 臺北市南港區忠孝東路六段488號";
                                backDao.SendMail(model.MAIL, subject, MailBody);

                                tran.Commit();
                                result = true;
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + res.ResultInfo + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    model.ErrorCode = "-1";
                    model.ErrorMessage = "連接失敗";
                    model.TempMessage = "取得預約交易代碼失敗(-1)";
                    //throw;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public bool RunPayTranx(Apply_001037ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001037";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID("001037");

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001037");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }


                    ApplyModel apply = new ApplyModel();

                    apply.InjectFrom(UserInfo);
                    apply.ENAME = model.Apply.ENAME;
                    apply.E_ALIAS_NAME = model.Apply.E_ALIAS_NAME;
                    apply.MOBILE = model.MOBILE;
                    apply.APP_ID = model.APP_ID;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.SRV_ID = "001037";
                    apply.SRC_SRV_ID = "001037";
                    apply.APP_EXT_DATE = this.GetNTFD("001037");
                    apply.APP_TIME = HelperUtil.TransTwToDateTime(model.APPLY_DATE);
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);

                    Apply_001037Model apply001037 = new Apply_001037Model();
                    apply001037.APP_ID = model.APP_ID;
                    apply001037.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    apply001037.LIC_CD = model.LIC_CD_TEXT;
                    apply001037.LIC_NUM = model.LIC_NUM;
                    apply001037.COPIES = model.COPIES;
                    apply001037.TOTAL = model.TOTAL;
                    apply001037.MAIL_REC = model.MAIL_REC;
                    apply001037.ADDR_CODE = model.MAIL_CITY_CODE;
                    apply001037.MAIL_ADDR = model.MAIL_CITY_TEXT + model.MAIL_CITY_DETAIL;
                    apply001037.MAIL_COUNTRY = model.MAIL_COUNTRY;
                    apply001037.REASON_1 = model.REASON_1;
                    apply001037.REASON_2 = model.REASON_2;
                    apply001037.REASON_3 = model.REASON_3;
                    apply001037.REASON_4 = model.REASON_4;
                    apply001037.REASON_5 = model.REASON_5;
                    apply001037.REASON_2_DESC = model.REASON_2_DESC;
                    apply001037.REASON_3_DESC = model.REASON_3_DESC;
                    apply001037.REASON_4_DESC = model.REASON_4_DESC;
                    apply001037.REASON_5_DESC = model.REASON_5_DESC;
                    apply001037.IS_MERGE_FILE = model.IS_MERGE_FILE;
                    apply001037.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001037.ADD_TIME = DateTime.Now;
                    apply001037.ADD_FUN_CD = "WEB-APPLY";
                    apply001037.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001037.UPD_TIME = DateTime.Now;
                    apply001037.UPD_FUN_CD = "WEB-APPLY";
                    apply001037.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001037.DEL_MK = "N";
                    this.Insert(apply001037);

                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = model.APP_ID;
                    applyPay.PAY_ID = model.APP_ID;
                    apply.SRV_ID = "001037";
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = "WEB-APPLY";
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = "WEB-APPLY";
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);

                    if (model.FILE1 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE1, "1");
                        file.SRC_FILENAME = model.FILE1.FileName;
                        file.FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE2 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE2, "2");
                        file.SRC_FILENAME = model.FILE2.FileName;
                        file.FILE_NO = 2;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    if (model.FILE3 != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE3, "3");
                        file.SRC_FILENAME = model.FILE3.FileName;
                        file.FILE_NO = 3;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "醫事人員或公共衛生師請領無懲戒紀錄證明申請書，案件編號﹕" + model.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之醫事人員或公共衛生師請領無懲戒紀錄證明申請書案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001037/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(model.MAIL, subject, MailBody);

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 醫事人員請領無懲戒紀錄證明申請書
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001037ViewModel QueryApply_001037(Apply_001037ViewModel parm)
        {
            string _sql = string.Empty;
            string _sqlNotict = string.Empty;
            string _sqlFile = string.Empty;
            Apply_001037ViewModel result = new Apply_001037ViewModel
            {
                Apply = new ApplyModel(),
                ApplyPay = new APPLY_PAY(),
                FileList = new List<Apply_FileModel>(),
                ApplyNoticeList = new List<TblAPPLY_NOTICE>()
            };
            //result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    _sql = @"SELECT APP_ID,LIC_CD,LIC_NUM,ISSUE_DATE,COPIES,TOTAL,MAIL_REC,MAIL_ADDR,MAIL_COUNTRY,
		                            REASON_1,REASON_2,REASON_2_DESC,REASON_3,REASON_3_DESC,REASON_4,REASON_4_DESC,REASON_5,REASON_5_DESC,ATTACH_1,ATTACH_2,
		                            DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,IS_MERGE_FILE,EMAIL,ADDR_CODE,
                                    (SELECT CODE_CD FROM CODE_CD WHERE CODE_KIND='F1_LICENSE_CD_1' AND CODE_CD=(SELECT CODE_PCD FROM CODE_CD WHERE CODE_KIND='F1_LICENSE_CD_1' AND CODE_CD=LIC_CD)) AS DIVISION
                              FROM APPLY_001037
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    //result = conn.QueryFirstOrDefault<Apply_001037ViewModel>(_sql, parameters);
                    var applyMain = conn.QueryFirstOrDefault<Apply_001037ViewModel>(_sql, parameters);
                    if (applyMain != null)
                    {
                        // 淺拷貝基本資料（避免整個覆蓋掉已初始化的子屬性）
                        result.APP_ID = applyMain.APP_ID;
                        result.LIC_CD = applyMain.LIC_CD;
                        result.LIC_NUM = applyMain.LIC_NUM;
                        result.ISSUE_DATE = applyMain.ISSUE_DATE;
                        result.COPIES = applyMain.COPIES;
                        result.TOTAL = applyMain.TOTAL;
                        result.MAIL_REC = applyMain.MAIL_REC;
                        result.MAIL_ADDR = applyMain.MAIL_ADDR;
                        result.MAIL_COUNTRY = applyMain.MAIL_COUNTRY;
                        result.REASON_1 = applyMain.REASON_1;
                        result.REASON_2 = applyMain.REASON_2;
                        result.REASON_2_DESC = applyMain.REASON_2_DESC;
                        result.REASON_3 = applyMain.REASON_3;
                        result.REASON_3_DESC = applyMain.REASON_3_DESC;
                        result.REASON_4 = applyMain.REASON_4;
                        result.REASON_4_DESC = applyMain.REASON_4_DESC;
                        result.REASON_5 = applyMain.REASON_5;
                        result.REASON_5_DESC = applyMain.REASON_5_DESC;
                        result.ATTACH_1 = applyMain.ATTACH_1;
                        result.ATTACH_2 = applyMain.ATTACH_2;
                        result.DEL_MK = applyMain.DEL_MK;
                        result.DEL_TIME = applyMain.DEL_TIME;
                        result.DEL_FUN_CD = applyMain.DEL_FUN_CD;
                        result.DEL_ACC = applyMain.DEL_ACC;
                        result.UPD_TIME = applyMain.UPD_TIME;
                        result.UPD_FUN_CD = applyMain.UPD_FUN_CD;
                        result.UPD_ACC = applyMain.UPD_ACC;
                        result.ADD_TIME = applyMain.ADD_TIME;
                        result.ADD_FUN_CD = applyMain.ADD_FUN_CD;
                        result.ADD_ACC = applyMain.ADD_ACC;
                        result.IS_MERGE_FILE = applyMain.IS_MERGE_FILE;
                        result.EMAIL = applyMain.EMAIL;
                        result.ADDR_CODE = applyMain.ADDR_CODE;
                        result.DIVISION = applyMain.DIVISION;
                    }

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY,NOTIBODY,E_ALIAS_NAME
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    var apply = conn.QueryFirstOrDefault<ApplyModel>(_sql, parameters);
                    if (apply != null) result.Apply = apply;
                    //result.Apply = conn.QueryFirstOrDefault<ApplyModel>(_sql, parameters);

                    _sql = @" SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME, PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK, PAY_RET_CD,
                              PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO, INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET, SESSION_KEY, AUTH_DATE,
                              AUTH_NO, SETTLE_DATE, OTHER, ROC_ID, CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                              FROM APPLY_PAY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    var pay = conn.QueryFirstOrDefault<APPLY_PAY>(_sql, parameters);
                    if (pay != null) result.ApplyPay = pay;
                    //result.ApplyPay = conn.QueryFirstOrDefault<APPLY_PAY>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sqlFile = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sqlFile += " AND APP_ID = @APP_ID";
                    //result.FileList = new List<Apply_FileModel>();
                    //result.FileList = conn.Query<Apply_FileModel>(_sqlFile, parameters).ToList<Apply_FileModel>();
                    result.FileList = conn.Query<Apply_FileModel>(_sqlFile, parameters)?.ToList() ?? new List<Apply_FileModel>();


                    _sqlNotict = @"SELECT APP_ID,Field,Field_NAME,ISADDYN,FREQUENCY,ADD_TIME,DEADLINE,NOTE,SRC_NO,BATCH_INDEX
                            FROM APPLY_NOTICE
                             WHERE 1 = 1 AND ISADDYN='N' ";
                    _sqlNotict += " AND APP_ID = @APP_ID";
                    //result.ApplyNoticeList = new List<TblAPPLY_NOTICE>();
                    //result.ApplyNoticeList = conn.Query<TblAPPLY_NOTICE>(_sqlNotict, parameters).ToList<TblAPPLY_NOTICE>();
                    logger.Warn(parameters);
                    logger.Warn(_sqlNotict);
                    logger.Warn("result is null :" + result);
                    if (conn == null)
                    {
                        logger.Warn("資料庫連線失敗（conn 為 null）");
                        throw new Exception("資料庫連線失敗（conn 為 null）");
                    }
                    result.ApplyNoticeList = conn.Query<TblAPPLY_NOTICE>(_sqlNotict, parameters)?.ToList() ?? new List<TblAPPLY_NOTICE>();


                    if (result != null)
                    {
                        //BackApplyDAO dao = new BackApplyDAO();

                        result.APPLY_PID = result.Apply.IDN;
                        result.APPLY_NAME = result.Apply.NAME;
                        result.MOBILE = result.Apply.MOBILE;

                        //申請日期
                        result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                        //預計完成日期
                        result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                        //核發日期
                        result.ISSUE_DATE_AC = HelperUtil.DateTimeToString(result.ISSUE_DATE);

                        // 電話
                        //string[] tel = result.Apply.TEL.Split('-');
                        //if (result.Apply.TEL.TONotNullString().Trim() != "")
                        //{
                        //    result.TEL_SEC = tel[0];
                        //    if (tel.ToCount() > 1)
                        //    {
                        //        result.TEL_NO = tel[1];

                        //        if (result.TEL_NO.Contains("#"))
                        //        {
                        //            result.TEL_NO = result.TEL_NO.Split('#')[0];
                        //        }

                        //        if (result.Apply.TEL.IndexOf('#') > 0)
                        //        {
                        //            result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                        //        }
                        //    }
                        //}
                        if (!string.IsNullOrWhiteSpace(result.Apply.TEL))
                        {
                            string[] telParts = result.Apply.TEL.Split(new[] { '-', '#' }, StringSplitOptions.RemoveEmptyEntries);
                            result.TEL_SEC = telParts.Length > 0 ? telParts[0] : "";
                            result.TEL_NO = telParts.Length > 1 ? telParts[1] : "";
                            result.TEL_EXT = result.Apply.TEL.Contains("#") ? result.Apply.TEL.Split('#')[1] : "";
                        }

                        //地址
                        TblZIPCODE zip = new TblZIPCODE();
                        zip.ZIP_CO = result.Apply.ADDR_CODE;
                        var address = this.GetRow(zip);
                        result.CITY_CODE = result.Apply.ADDR_CODE;
                        if (address != null)
                        {
                            result.CITY_TEXT = address.TOWNNM;
                            result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                        }

                        zip = new TblZIPCODE();
                        zip.ZIP_CO = result.ADDR_CODE;
                        var mailAddress = this.GetRow(zip);
                        result.MAIL_CITY_CODE = result.ADDR_CODE;
                        if (mailAddress != null)
                        {
                            result.MAIL_CITY_TEXT = mailAddress.TOWNNM;
                            result.MAIL_CITY_DETAIL = result.MAIL_ADDR.TONotNullString().Replace(mailAddress.CITYNM + mailAddress.TOWNNM, "");
                        }

                        //Mail
                        if (result.EMAIL.TONotNullString().Trim() != "")
                        {
                            result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                            result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                            switch (result.EMAIL.Split('@')[1])
                            {
                                case "gmail.com":
                                    result.DOMAINList = "1";
                                    break;
                                case "yahoo.com.tw":
                                    result.DOMAINList = "2";
                                    break;
                                case "outlook.com":
                                    result.DOMAINList = "3";
                                    break;
                                default:
                                    result.DOMAINList = "0";
                                    break;
                            }
                        }

                        result.NoticeList = "";
                        if (result.ApplyNoticeList.Count > 0)
                        {
                            foreach (var item in result.ApplyNoticeList)
                            {
                                if (result.NoticeList == "")
                                {
                                    result.NoticeList = item.Field;
                                }
                                else
                                {
                                    result.NoticeList += "," + item.Field;
                                }
                            }

                            result.FREQUENCY = result.ApplyNoticeList[0].FREQUENCY;

                        }


                        ShareDAO shareDAO = new ShareDAO();
                        if (shareDAO.CalculationDocDate("001037", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                        {
                            result.IsNotice = "N";
                        }
                        else
                        {
                            result.IsNotice = "Y";
                        }

                        if (result.FileList.Count <= 3)
                        {
                            int rowCount = 3 - result.FileList.Count;
                            if (rowCount > 0)
                            {
                                for (int i = 0; i < rowCount; i++)
                                {
                                    result.FileList.Add(new Apply_FileModel() { APP_ID = parm.APP_ID, FILENAME = "", FILE_NO = -1 });
                                }
                            }
                        }

                        result.FILE1_CHECK = "Y";
                        result.FILE2_CHECK = "Y";
                        result.FILE3_CHECK = "Y";

                    }
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }


        public bool SaveAppDoc001037(Apply_001037ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "001037");
            dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;


                    if (model.Apply.ISMODIFY == "Y")
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.IDN = model.APPLY_PID;
                        apply.NAME = model.APPLY_NAME;
                        apply.ENAME = model.Apply.ENAME;
                        apply.E_ALIAS_NAME = model.Apply.E_ALIAS_NAME;
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL.TONotNullString();
                        apply.MOBILE = model.MOBILE;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                        Apply_001037Model apply001037Where = new Apply_001037Model();
                        apply001037Where.APP_ID = model.APP_ID;
                        Apply_001037Model apply001037 = new Apply_001037Model();

                        apply001037.APP_ID = model.APP_ID;
                        apply001037.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                        apply001037.LIC_CD = model.LIC_CD_TEXT;
                        apply001037.LIC_NUM = model.LIC_NUM;
                        apply001037.COPIES = model.COPIES;
                        apply001037.TOTAL = model.TOTAL;
                        apply001037.MAIL_REC = model.MAIL_REC;
                        apply001037.ADDR_CODE = model.MAIL_CITY_CODE;
                        apply001037.MAIL_ADDR = model.MAIL_CITY_TEXT + model.MAIL_CITY_DETAIL;
                        apply001037.MAIL_COUNTRY = model.MAIL_COUNTRY;
                        apply001037.REASON_1 = model.REASON_1;
                        if (model.REASON_1 == "1")
                        {
                            apply001037.REASON_2 = model.REASON_2;
                            apply001037.REASON_3 = model.REASON_3;
                            apply001037.REASON_2_DESC = model.REASON_2_DESC;
                            apply001037.REASON_3_DESC = model.REASON_3_DESC;
                        }
                        else
                        {
                            apply001037.REASON_4 = model.REASON_4;
                            apply001037.REASON_5 = model.REASON_5;
                            apply001037.REASON_4_DESC = model.REASON_4_DESC;
                            apply001037.REASON_5_DESC = model.REASON_5_DESC;
                        }

                        apply001037.IS_MERGE_FILE = model.IS_MERGE_FILE;
                        apply001037.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                        apply001037.UPD_TIME = DateTime.Now;
                        apply001037.UPD_FUN_CD = "WEB-APPLY";
                        apply001037.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //this.Update(apply001037, apply001037Where);
                        this.Update2(apply001037, apply001037Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        //apply.APP_TIME = DateTime.Now; //申請日期不更新
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        //this.Update(apply, applyWhere);
                        this.Update2(apply, applyWhere, dict2);
                    }

                    TblAPPLY_NOTICE noticeWhere = new TblAPPLY_NOTICE();
                    noticeWhere.APP_ID = model.APP_ID;
                    noticeWhere.FREQUENCY = model.FREQUENCY;

                    TblAPPLY_NOTICE notice = new TblAPPLY_NOTICE();
                    notice.APP_ID = model.APP_ID;
                    notice.ISADDYN = "Y";
                    this.Update(notice, noticeWhere);


                    #region 檔案上傳

                    if (model.FILE1 != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.FileList[0].FILENAME;
                        fileWhere.FILE_NO = model.FileList[0].FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        model.FileList[0].APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE1, "1");
                        model.FileList[0].FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.FILE1.FileName;
                        model.FileList[0].SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 1;
                        model.FileList[0].FILE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.FileList[0].APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILE_NO = 1;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE1, "1");
                        //    model.FileList[0].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE1.FileName;
                        //    model.FileList[0].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.FileList[0].APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE1, "1");
                        //    model.FileList[0].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE1.FileName;
                        //    model.FileList[0].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 1;
                        //    model.FileList[0].FILE_NO = 1;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}
                    }
                    else
                    {
                        if (model.FileList[0].FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.FileList[0].FILENAME;
                            fileWhere.FILE_NO = model.FileList[0].FILE_NO;

                            model.FileList[0] = this.GetRow(fileWhere);
                        }

                    }

                    if (model.FILE2 != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.FileList[1].FILENAME;
                        fileWhere.FILE_NO = model.FileList[1].FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        model.FileList[1].APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE2, "2");
                        model.FileList[1].FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.FILE2.FileName;
                        model.FileList[1].SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 2;
                        model.FileList[1].FILE_NO = 2;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.FileList[1].APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILE_NO = 2;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE2, "2");
                        //    model.FileList[1].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE2.FileName;
                        //    model.FileList[1].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.FileList[1].APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE2, "2");
                        //    model.FileList[1].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE2.FileName;
                        //    model.FileList[1].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 2;
                        //    model.FileList[1].FILE_NO = 2;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}
                    }
                    else
                    {
                        if (model.FileList[1].FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.FileList[1].FILENAME;
                            fileWhere.FILE_NO = model.FileList[1].FILE_NO;

                            model.FileList[1] = this.GetRow(fileWhere);
                        }

                    }

                    if (model.FILE3 != null)
                    {
                        Apply_FileModel fileWhere = new Apply_FileModel();
                        fileWhere.APP_ID = model.APP_ID;
                        fileWhere.FILENAME = model.FileList[2].FILENAME;
                        fileWhere.FILE_NO = model.FileList[2].FILE_NO;

                        Apply_FileModel file = new Apply_FileModel();

                        file.APP_ID = model.APP_ID;
                        model.FileList[2].APP_ID = model.APP_ID;
                        file.FILENAME = shareDao.PutFile("001037", model.FILE3, "3");
                        model.FileList[2].FILENAME = file.FILENAME;
                        file.SRC_FILENAME = model.FILE3.FileName;
                        model.FileList[2].SRC_FILENAME = file.SRC_FILENAME;
                        file.FILE_NO = 3;
                        model.FileList[2].FILE_NO = 3;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        this.Insert(file);

                        //if (this.GetRow(fileWhere).APP_ID != null)
                        //{
                        //    model.FileList[2].APP_ID = model.APP_ID;
                        //    file.APP_ID = model.APP_ID;
                        //    file.FILE_NO = 3;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE3, "3");
                        //    model.FileList[2].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE3.FileName;
                        //    model.FileList[2].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";

                        //    this.Update(file, fileWhere);
                        //}
                        //else
                        //{
                        //    file.APP_ID = model.APP_ID;
                        //    model.FileList[2].APP_ID = model.APP_ID;
                        //    file.FILENAME = shareDao.PutFile("001037", model.FILE3, "3");
                        //    model.FileList[2].FILENAME = file.FILENAME;
                        //    file.SRC_FILENAME = model.FILE3.FileName;
                        //    model.FileList[2].SRC_FILENAME = file.SRC_FILENAME;
                        //    file.FILE_NO = 3;
                        //    model.FileList[2].FILE_NO = 3;
                        //    file.ADD_TIME = DateTime.Now;
                        //    file.ADD_FUN_CD = "WEB-APPLY";
                        //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.UPD_TIME = DateTime.Now;
                        //    file.UPD_FUN_CD = "WEB-APPLY";
                        //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        //    file.DEL_MK = "N";
                        //    this.Insert(file);
                        //}
                    }
                    else
                    {
                        if (model.FileList[2].FILENAME.TONotNullString() != "")
                        {
                            Apply_FileModel fileWhere = new Apply_FileModel();
                            fileWhere.APP_ID = model.APP_ID;
                            fileWhere.FILENAME = model.FileList[2].FILENAME;
                            fileWhere.FILE_NO = model.FileList[2].FILE_NO;

                            model.FileList[2] = this.GetRow(fileWhere);
                        }

                    }

                    #endregion

                    model.FILE1_CHECK = "Y";
                    model.FILE2_CHECK = "Y";
                    model.FILE3_CHECK = "Y";

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("SaveAppDoc001037 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        #endregion

        #region Apply_005001 產銷證明書

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply005001(Apply_005001FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "005001";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.IDN = "";
                    where.UNIT_CD = 7;
                    where.FLOW_CD = "1";
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.NAME = form.NAME;
                    where.CNT_NAME = form.CNT_NAME;
                    where.TEL = form.TEL;
                    if (form.FAX_BEFORE.TONotNullString().ToTrim() != "")
                    {
                        where.FAX = form.FAX_Extension.TONotNullString().ToTrim() == "" ? form.FAX_BEFORE + "-" + form.FAX_AFTER : form.FAX_BEFORE + "-" + form.FAX_AFTER + "#" + form.FAX_Extension;
                    }
                    where.APP_TIME = DateTime.Now;
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAYAMOUNT;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    //where.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    //where.ADDR = form.TAX_ORG_CITY_CODE + form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    base.Insert(where);
                    #endregion

                    #region Apply005001
                    Apply_005001Model apply005001 = new Apply_005001Model();
                    apply005001.InjectFrom(form);
                    apply005001.PC_SCALE_2E = form.PC_SCALE_1E;
                    apply005001.APP_ID = APP_ID;
                    apply005001.MF_CNT_TEL = form.TEL;
                    apply005001.MF_ADDR = form.TAX_ORG_CITY_CODE + form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    apply005001.LIC_CD = form.PL_CD;
                    apply005001.LIC_NUM = form.PL_Num;
                    apply005001.LIC_CD_E = form.PL_CD_E;
                    apply005001.LIC_NUM_E = form.PL_Num_E;
                    apply005001.ISSUE_DATE = Convert.ToDateTime(form.ISSUE_DATE);
                    apply005001.EXPIR_DATE = Convert.ToDateTime(form.EXPIR_DATE);
                    apply005001.MF_COPIES = form.PAYCOUNT.TOInt32();
                    apply005001.ADD_TIME = DateTime.Now;
                    apply005001.ADD_FUN_CD = "WEB-APPLY";
                    apply005001.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply005001.UPD_TIME = DateTime.Now;
                    apply005001.UPD_FUN_CD = "WEB-APPLY";
                    apply005001.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply005001.DEL_MK = "N";
                    apply005001.EMAIL = form.EMAIL;
                    if (!form.IS_EXPIR_DATE_CHECK)
                    {
                        apply005001.EXPIR_DATE = null;
                    }

                    if (!form.IS_DRUG_ABROAD_CHECK)
                    {
                        apply005001.DRUG_ABROAD_NAME = null;
                        apply005001.DRUG_ABROAD_NAME_E = null;
                    }

                    if (!form.IS_Concentrate_CHECK)
                    {
                        apply005001.PC_SCALE_1 = null;
                        apply005001.PC_SCALE_1E = null;
                        apply005001.PC_SCALE_2E = null;
                        apply005001.PC_SCALE_21 = null;
                        apply005001.PC_SCALE_22 = null;
                        apply005001.PC_SCALE_23 = null;
                        apply005001.PC_SCALE_24 = null;
                    }

                    base.Insert(apply005001);
                    #endregion

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAYAMOUNT;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;
                    //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";
                    pay.DEL_MK = "N";
                    base.Insert(pay);
                    #endregion

                    #region 附件檔
                    Apply_FileModel applyFile = new Apply_FileModel();
                    if (form.File_1 != null)
                    {
                        applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 1;
                        applyFile.FILENAME = dao.PutFile("005001", form.File_1, "1");
                        applyFile.SRC_FILENAME = form.File_1.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.File_2 != null)
                    {
                        applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 2;
                        applyFile.FILENAME = dao.PutFile("005001", form.File_2, "2");
                        applyFile.SRC_FILENAME = form.File_2.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.File_3 != null)
                    {
                        applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 3;
                        applyFile.FILENAME = dao.PutFile("005001", form.File_3, "3");
                        applyFile.SRC_FILENAME = form.File_3.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }
                    #endregion

                    #region apply005001_DI
                    form.DI.APP_ID = APP_ID;
                    foreach (var item in form.DI.GoodsList)
                    {
                        item.APP_ID = APP_ID;
                        item.ADD_TIME = DateTime.Now;
                        item.ADD_FUN_CD = "WEB-APPLY";
                        item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.UPD_TIME = DateTime.Now;
                        item.UPD_FUN_CD = "WEB-APPLY";
                        item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                    }
                    form.DI.SaveGoodsList("SRL_NO");
                    #endregion

                    #region apply005001_PC

                    if (form.IS_Concentrate_CHECK)
                    {
                        form.PC.APP_ID = APP_ID;
                        foreach (var item in form.PC.GoodsList)
                        {
                            item.APP_ID = APP_ID;
                            item.ADD_TIME = DateTime.Now;
                            item.ADD_FUN_CD = "WEB-APPLY";
                            item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.UPD_TIME = DateTime.Now;
                            item.UPD_FUN_CD = "WEB-APPLY";
                            item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.DEL_MK = "N";
                        }
                        form.PC.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    tran.Commit();
                    return APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply005001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 查詢
        /// </summary>
        /// <param name="app_id"></param>
        /// <returns></returns>
        public Apply_005001Form2Model QueryApply_005001(string app_id)
        {
            Apply_005001Form2Model result = new Apply_005001Form2Model();
            //附件檔
            DataTable file = QueryApplyFile_005001(app_id);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select APPLY.APP_ID,APPLY.NAME,APPLY.CNT_NAME,APPLY.TEL,APPLY.FAX,APPLY.PAY_A_FEE PAYAMOUNT,
                                           APPLY.FLOW_CD CODE_CD,APPLY.MOHW_CASE_NO,APPLY.APP_TIME,APPLY.APP_EXT_DATE,APPLY.PAY_A_FEE,
                                           APPLY.PAY_METHOD,

                                           APPLY_005001.MF_CNT_NAME,APPLY_005001.MF_CNT_NAME_E,APPLY_005001.MF_CNT_TEL,APPLY_005001.MF_ADDR,
                                           APPLY_005001.MF_ADDR_E,APPLY_005001.DRUG_NAME,APPLY_005001.DRUG_NAME_E,APPLY_005001.DRUG_ABROAD_NAME,
                                           APPLY_005001.DRUG_ABROAD_NAME_E,APPLY_005001.DOSAGE_FORM,APPLY_005001.DOSAGE_FORM_E,APPLY_005001.LIC_CD PL_CD,
                                           APPLY_005001.LIC_NUM PL_NUM,APPLY_005001.LIC_CD_E PL_CD_E,APPLY_005001.LIC_NUM_E PL_NUM_E,
                                           CONVERT(varchar,APPLY_005001.ISSUE_DATE,111) ISSUE_DATE,
                                           CONVERT(varchar,APPLY_005001.EXPIR_DATE,111) EXPIR_DATE,APPLY_005001.MF_CONT,
                                           APPLY_005001.MF_CONT_E,APPLY_005001.PC_SCALE_1,APPLY_005001.PC_SCALE_1E,APPLY_005001.PC_SCALE_21,
                                           APPLY_005001.PC_SCALE_22,APPLY_005001.PC_SCALE_23,APPLY_005001.PC_SCALE_24,APPLY_005001.PC_SCALE_2E,
                                           APPLY_005001.INDIOCATION,APPLY_005001.INDIOCATION_E,APPLY_005001.EFFICACY,APPLY_005001.EFFICACY_E,
                                           APPLY_005001.DRUG_ABROAD_CHECK,APPLY_005001.EXPIR_DATE_CHECK,APPLY_005001.Concentrate_CHECK,
                                           APPLY_005001.INDIOCATION_CHECK,APPLY_005001.EFFICACY_CHECK,APPLY_005001.EMAIL,
                                           APPLY_005001.MF_COPIES PAYCOUNT,

                                           ADMIN.NAME ADMIN_NAME
                                    from APPLY left join APPLY_005001 on APPLY.APP_ID = APPLY_005001.APP_ID
		                                       left join ADMIN on APPLY.PRO_ACC = ADMIN.ACC_NO
                                    where APPLY.APP_ID='" + app_id + "'";
                    result = conn.QueryFirst<Apply_005001Form2Model>(_sql);

                    //地址拆分
                    result.TAX_ORG_CITY_CODE = result.MF_ADDR.Substring(0, 5);
                    result.TAX_ORG_CITY_DETAIL = result.ADDR;
                    TblZIPCODE zip = new TblZIPCODE();
                    zip.ZIP_CO = result.MF_ADDR.Substring(0, 5);
                    var getnam = GetRow(zip);
                    if (getnam != null && result.MF_ADDR != null)
                    {
                        result.TAX_ORG_CITY_DETAIL = result.MF_ADDR.TONotNullString().Substring(5).Replace(getnam.CITYNM + getnam.TOWNNM, "");
                        result.TAX_ORG_CITY_TEXT = getnam.CITYNM + getnam.TOWNNM;
                    }
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (file != null)
            {
                if (file.Rows.Count > 0)
                {
                    result.FILE1_TEXT = file.Rows[0][0].ToString();
                    result.FILE2_TEXT = file.Rows[0][1].ToString();
                    result.FILE3_TEXT = file.Rows[0][2].ToString();
                }
            }

            return result;
        }

        /// <summary>
        /// 查詢
        /// </summary>
        /// <param name="app_id"></param>
        /// <returns></returns>
        public DataTable QueryApplyFile_005001(string app_id)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @file1 nvarchar(max),@file2 nvarchar(max),@file3 nvarchar(max);

                                    select @file1 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='1'

                                    select @file2 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='2'

                                    select @file3 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='3'

                                    select @file1 file1,@file2 file2,@file3 file3";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }


        /// <summary>
        /// 取得補件
        /// </summary>
        /// <param name="app_id"></param>
        /// <returns></returns>
        public Apply_005001Form2Model GetApplyNotice_005001(string app_id)
        {
            Apply_005001Form2Model result = new Apply_005001Form2Model();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                                    SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                                    FROM (
	                                        select Field,NOTE
	                                        from APPLY_NOTICE 
	                                        where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"' and ISADDYN='N')
	                                     ) T
                                    GROUP BY QUOTENAME(Field) 

                                    select @ColumnGroup =N'
                                                            SELECT *
                                                            FROM (
	                                                                select isnull(BATCH_INDEX,1) grp,Field,NOTE
	                                                                from APPLY_NOTICE 
	                                                                where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'' and ISADDYN=''N'')
                                                                 ) t 
                                                            PIVOT (
	                                                                MAX(NOTE) 
	                                                                FOR Field IN (' + @ColumnGroup + N')
                                                                   ) p;'

                                                            EXEC sp_executesql  @ColumnGroup";
                    result = conn.QueryFirst<Apply_005001Form2Model>(_sql);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 補件
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public string AppendApplyDoc005001(Apply_005001ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;

            ApplyModel whereApply = new ApplyModel();
            whereApply.APP_ID = model.FormBack.APP_ID;
            ApplyModel newApply = new ApplyModel();
            newApply.APP_ID = model.FormBack.APP_ID;

            Apply_005001Model whereApply005001 = new Apply_005001Model();
            whereApply005001.APP_ID = model.FormBack.APP_ID;
            Apply_005001Model newApply005001 = new Apply_005001Model();
            newApply005001.APP_ID = model.FormBack.APP_ID;
            newApply005001.PC_SCALE_2E = model.FormBack.PC_SCALE_1E;

            Apply_FileModel whereApplyFile1 = new Apply_FileModel();
            whereApplyFile1.APP_ID = model.FormBack.APP_ID;
            whereApplyFile1.FILE_NO = 1;
            Apply_FileModel newApplyFile1 = new Apply_FileModel();
            newApplyFile1.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel whereApplyFile2 = new Apply_FileModel();
            whereApplyFile2.APP_ID = model.FormBack.APP_ID;
            whereApplyFile2.FILE_NO = 2;
            Apply_FileModel newApplyFile2 = new Apply_FileModel();
            newApplyFile2.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel whereApplyFile3 = new Apply_FileModel();
            whereApplyFile3.APP_ID = model.FormBack.APP_ID;
            whereApplyFile3.FILE_NO = 3;
            Apply_FileModel newApplyFile3 = new Apply_FileModel();
            newApplyFile3.APP_ID = model.FormBack.APP_ID;

            newApply005001.InjectFrom(model.FormBack);
            if (model.FormBack.IS_Concentrate_CHECK) newApply005001.Concentrate_CHECK = "Y";
            if (model.FormBack.IS_EFFICACY_CHECK) newApply005001.EFFICACY_CHECK = "Y";
            if (model.FormBack.IS_INDIOCATION_CHECK) newApply005001.INDIOCATION_CHECK = "Y";
            if (model.FormBack.IS_EXPIR_DATE_CHECK) { newApply005001.EXPIR_DATE_CHECK = "Y"; newApply005001.EXPIR_DATE = Convert.ToDateTime(model.FormBack.EXPIR_DATE); }
            else { newApply005001.EXPIR_DATE = null; }
            if (model.FormBack.IS_DRUG_ABROAD_CHECK) newApply005001.DRUG_ABROAD_CHECK = "Y";
            newApply005001.LIC_CD = model.FormBack.PL_CD;
            newApply005001.LIC_NUM = model.FormBack.PL_Num;
            newApply005001.LIC_CD_E = model.FormBack.PL_CD_E;
            newApply005001.LIC_NUM_E = model.FormBack.PL_Num_E;
            newApply005001.ISSUE_DATE = Convert.ToDateTime(model.FormBack.ISSUE_DATE);

            newApply005001.MF_CNT_TEL = model.FormBack.TEL;
            newApply005001.MF_ADDR = model.FormBack.TAX_ORG_CITY_CODE + model.FormBack.TAX_ORG_CITY_TEXT + model.FormBack.TAX_ORG_CITY_DETAIL;

            //僅針對需補件欄位更新
            var t = model.Detail.GetType();
            PropertyInfo[] props = t.GetProperties();
            for (var i = 0; i < props.Length; i++)
            {
                if (props[i].GetValue(model.Detail) != null && (props[i].GetValue(model.Detail)).ToString() != "False" &&
                    (props[i].GetValue(model.Detail)).ToString() != "True"
                    && props[i].Name != "INGREDIENT_CONTENT"
                    && props[i].Name != "EXCIPIENT")
                {
                    ////地址(3欄位)
                    //if (props[i].Name == "TAX_ORG_CITY_CODE")
                    //{
                    //    newApply005001.MF_ADDR = model.FormBack.TAX_ORG_CITY_CODE + model.FormBack.TAX_ORG_CITY_TEXT +
                    //                             model.FormBack.TAX_ORG_CITY_DETAIL;
                    //}
                    ////檔案上傳處理
                    //else 
                    if (props[i].Name == "File_1_Name" || props[i].Name == "File_2_Name" || props[i].Name == "File_3_Name")
                    {
                        Apply_FileModel whereApplyFile = new Apply_FileModel();
                        whereApplyFile.APP_ID = model.FormBack.APP_ID;
                        whereApplyFile.FILE_NO = props[i].Name.Substring(5, 1).TOInt32();
                        if (base.GetRowList(whereApplyFile).Count > 0)
                        {
                            //update
                            if (props[i].Name == "File_1_Name")
                            {
                                newApplyFile1.FILENAME = model.FormBack.File_1 == null ? null : dao.PutFile("005001", model.FormBack.File_1, "1");
                                newApplyFile1.SRC_FILENAME = newApplyFile1.FILENAME == null ? null : model.FormBack.File_1.FileName;
                                newApplyFile1.FILE_NO = 1;
                                newApplyFile1.UPD_TIME = DateTime.Now;
                                newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                            else if (props[i].Name == "File_2_Name")
                            {
                                newApplyFile2.FILENAME = model.FormBack.File_2 == null ? null : dao.PutFile("005001", model.FormBack.File_2, "2");
                                newApplyFile2.SRC_FILENAME = newApplyFile2.FILENAME == null ? null : model.FormBack.File_2.FileName;
                                newApplyFile2.FILE_NO = 2;
                                newApplyFile2.UPD_TIME = DateTime.Now;
                                newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                            else if (props[i].Name == "File_3_Name")
                            {
                                newApplyFile3.FILENAME = model.FormBack.File_3 == null ? null : dao.PutFile("005001", model.FormBack.File_3, "3");
                                newApplyFile3.SRC_FILENAME = newApplyFile3.FILENAME == null ? null : model.FormBack.File_3.FileName;
                                newApplyFile3.FILE_NO = 3;
                                newApplyFile3.UPD_TIME = DateTime.Now;
                                newApplyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                        }
                        else
                        {
                            //insert
                            if (props[i].Name == "File_1_Name")
                            {
                                newApplyFile1.APP_ID = model.FormBack.APP_ID;
                                newApplyFile1.FILE_NO = 1;
                                newApplyFile1.FILENAME = model.FormBack.File_1 == null ? null : dao.PutFile("005001", model.FormBack.File_1, "1");
                                newApplyFile1.SRC_FILENAME = newApplyFile1.FILENAME == null ? null : model.FormBack.File_1.FileName;
                                newApplyFile1.UPD_TIME = DateTime.Now;
                                newApplyFile1.UPD_FUN_CD = "WEB-APPLY";
                                newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newApplyFile1.ADD_TIME = DateTime.Now;
                                newApplyFile1.ADD_FUN_CD = "WEB-APPLY";
                                newApplyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                            else if (props[i].Name == "File_2_Name")
                            {
                                newApplyFile2.APP_ID = model.FormBack.APP_ID;
                                newApplyFile2.FILE_NO = 2;
                                newApplyFile2.FILENAME = model.FormBack.File_2 == null ? null : dao.PutFile("005001", model.FormBack.File_2, "2");
                                newApplyFile2.SRC_FILENAME = newApplyFile2.FILENAME == null ? null : model.FormBack.File_2.FileName;
                                newApplyFile2.UPD_TIME = DateTime.Now;
                                newApplyFile2.UPD_FUN_CD = "WEB-APPLY";
                                newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newApplyFile2.ADD_TIME = DateTime.Now;
                                newApplyFile2.ADD_FUN_CD = "WEB-APPLY";
                                newApplyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                            else if (props[i].Name == "File_3_Name")
                            {
                                newApplyFile3.APP_ID = model.FormBack.APP_ID;
                                newApplyFile3.FILE_NO = 3;
                                newApplyFile3.FILENAME = model.FormBack.File_3 == null ? null : dao.PutFile("005001", model.FormBack.File_3, "3");
                                newApplyFile3.SRC_FILENAME = newApplyFile3.FILENAME == null ? null : model.FormBack.File_3.FileName;
                                newApplyFile3.UPD_TIME = DateTime.Now;
                                newApplyFile3.UPD_FUN_CD = "WEB-APPLY";
                                newApplyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newApplyFile3.ADD_TIME = DateTime.Now;
                                newApplyFile3.ADD_FUN_CD = "WEB-APPLY";
                                newApplyFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            }
                        }
                    }
                }

            }
            var result = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);
                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.FLOW_CD = "3";

                    string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
                    string s_SRV_ID = "005001";
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.FormBack.APP_ID);
                    dict2.Add("SRV_ID", s_SRV_ID);
                    dict2.Add("LastMODTIME", LastMODTIME);

                    base.Update2(newApply, whereApply, dict2);
                    base.Update2(newApply005001, whereApply005001, dict2);

                    if (newApplyFile1.UPD_TIME != null)
                    {
                        if (newApplyFile1.UPD_TIME == newApplyFile1.ADD_TIME)
                        {
                            base.Insert(newApplyFile1);
                        }
                        else
                        {
                            base.Update(newApplyFile1, whereApplyFile1);
                        }
                    }
                    if (newApplyFile2.UPD_TIME != null)
                    {
                        if (newApplyFile2.UPD_TIME == newApplyFile2.ADD_TIME)
                        {
                            base.Insert(newApplyFile2);
                        }
                        else
                        {
                            base.Update(newApplyFile2, whereApplyFile2);
                        }
                    }
                    if (newApplyFile3.UPD_TIME != null)
                    {
                        if (newApplyFile3.UPD_TIME == newApplyFile3.ADD_TIME)
                        {
                            base.Insert(newApplyFile3);
                        }
                        else
                        {
                            base.Update(newApplyFile3, whereApplyFile3);
                        }
                    }

                    if (!string.IsNullOrEmpty(model.Detail.INGREDIENT_CONTENT))
                    {
                        model.DI.APP_ID = model.FormBack.APP_ID;
                        foreach (var item in model.DI.GoodsList)
                        {
                            item.APP_ID = model.FormBack.APP_ID;
                            item.ADD_TIME = DateTime.Now;
                            item.ADD_FUN_CD = "WEB-APPLY";
                            item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.UPD_TIME = DateTime.Now;
                            item.UPD_FUN_CD = "WEB-APPLY";
                            item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.DEL_MK = "N";
                        }
                        model.DI.SaveGoodsList("SRL_NO");
                    }

                    if (!string.IsNullOrEmpty(model.Detail.EXCIPIENT))
                    {
                        if (model.FormBack.IS_Concentrate_CHECK)
                        {
                            model.PC.APP_ID = model.FormBack.APP_ID;
                            foreach (var item in model.PC.GoodsList)
                            {
                                item.APP_ID = model.FormBack.APP_ID;
                                item.ADD_TIME = DateTime.Now;
                                item.ADD_FUN_CD = "WEB-APPLY";
                                item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                item.UPD_TIME = DateTime.Now;
                                item.UPD_FUN_CD = "WEB-APPLY";
                                item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                item.DEL_MK = "N";
                            }
                            model.PC.SaveGoodsList("SRL_NO");
                        }
                    }


                    //Apply_Notice狀態更新
                    TblAPPLY_NOTICE applyNotice = new TblAPPLY_NOTICE();
                    applyNotice.APP_ID = model.FormBack.APP_ID;
                    applyNotice.ISADDYN = "Y";
                    TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
                    whereApplyNotice.APP_ID = model.FormBack.APP_ID;
                    base.Update(applyNotice, whereApplyNotice);

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FormBack.CODE_CD == "4")
                    {
                        newApply.FLOW_CD = "1";
                        newApply.APP_DISP_ACC = "";
                        newApply.APP_DISP_MK = "N";
                        newApply.PRO_ACC = "";
                        newApply.PRO_UNIT_CD = -1;
                        newApply.MOHW_CASE_NO = "";

                        base.Update(newApply, whereApply);
                    }
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    result = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public SALEAPI_Resp SortData005001(SALEAPI_Resp data)
        {
            DataTable result = new DataTable();
            //using (SqlConnection conn = DataUtils.GetConnection())
            //{
            //    try
            //    {
            //        string _sql = @"select DISTINCT (CITYNM + TOWNNM) CITY from ZIPCODE where ZIP_CO like '" + data.郵遞區號 + "%'";
            //        SqlCommand cmd = new SqlCommand(_sql, conn);
            //        SqlDataAdapter da = new SqlDataAdapter(cmd);
            //        da.Fill(result);
            //    }
            //    catch (Exception ex)
            //    {
            //        logger.Warn(ex.Message, ex);
            //        result = null;
            //    }
            //}

            //地址轉換
            //data.營業地址 = data.營業地址.Replace(result.Rows[0][0].ToString(), "");

            //發證日期(轉民國)
            if (!string.IsNullOrEmpty(data.發證日期))
            {
                if (data.發證日期.Length == 10)
                {
                    data.發證日期 = Convert.ToInt32(data.發證日期.Split('/')[0]) - 1911 + "/" +
                           data.發證日期.Split('/')[1] + "/" +
                           data.發證日期.Split('/')[2];
                }
            }

            //有效日期(轉民國)
            if (!string.IsNullOrEmpty(data.有效日期))
            {
                if (data.有效日期.Length == 10)
                {
                    data.有效日期 = Convert.ToInt32(data.有效日期.Split('/')[0]) - 1911 + "/" +
                           data.有效日期.Split('/')[1] + "/" +
                           data.有效日期.Split('/')[2];
                }

            }

            return data;
        }
        #endregion

        #region Apply_005002 外銷證明書
        public void AppendApply005002(Apply_005002ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            string CaseNum = "005002";
            var APP_ID = GetApp_ID(CaseNum);
            model.Apply.APP_ID = APP_ID;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);
                    DateTime now = DateTime.Now;

                    // 申請案件資料
                    var ap = model.Apply;
                    var apply = new ApplyModel(); //model.Apply;
                    apply.APP_ID = APP_ID;
                    apply.SRV_ID = CaseNum;
                    apply.SRC_SRV_ID = CaseNum;

                    apply.NAME = ap.NAME;
                    apply.CNT_NAME = ap.CNT_NAME;
                    apply.CNT_TEL = ap.CNT_TEL;
                    apply.IDN = "";
                    apply.TEL = ap.TEL;
                    apply.FAX = ap.FAX;

                    apply.UNIT_CD = 7;
                    apply.FLOW_CD = ap.FLOW_CD;
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_TIME = DateTime.Now;
                    apply.PAY_POINT = ap.PAY_POINT;
                    apply.PAY_METHOD = ap.PAY_METHOD;
                    apply.PAY_A_FEE = model.Detail.MF_COPIES * 1500;
                    apply.PAY_A_FEEBK = 0;
                    apply.PAY_A_PAID = 0;

                    apply.PAY_C_FEE = 0;
                    apply.PAY_C_FEEBK = 0;
                    apply.PAY_C_PAID = 0;
                    apply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(apply);

                    // 基本資料
                    var dtl = model.Detail;
                    dtl.APP_ID = APP_ID;
                    dtl.DEL_MK = "N";
                    dtl.UPD_TIME = now;
                    dtl.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    dtl.ADD_TIME = now;
                    dtl.ADD_FUN_CD = "WEB-APPLY";
                    dtl.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Insert(dtl);

                    // 繳費資料
                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = model.Detail.MF_COPIES * 1500;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;    //新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = apply.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";
                    base.Insert(pay);
                    #endregion

                    // 成份資料
                    int idxIng = 0;
                    foreach (var item in model.IngredientList)
                    {
                        item.APP_ID = APP_ID;
                        item.SRL_NO = ++idxIng;
                        item.ADD_TIME = now;
                        item.ADD_FUN_CD = "WEB-APPLY";
                        item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.UPD_TIME = now;
                        item.UPD_FUN_CD = "WEB-APPLY";
                        item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                        base.Insert(item);
                    }

                    // 賦型劑
                    int idxExc = 0;
                    foreach (var item in model.ExcipientList)
                    {
                        item.APP_ID = APP_ID;
                        item.SRL_NO = ++idxExc;
                        item.ADD_TIME = now;
                        item.ADD_FUN_CD = "WEB-APPLY";
                        item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.UPD_TIME = now;
                        item.UPD_FUN_CD = "WEB-APPLY";
                        item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                        base.Insert(item);
                    }

                    ShareDAO sdao = new ShareDAO();

                    if (model.ApplyFile_1 != null && !string.IsNullOrEmpty(model.ApplyFile_1.FILENAME))
                    {
                        // 外銷專用藥品許可證(正面)
                        Apply_FileModel file1 = new Apply_FileModel();
                        file1.APP_ID = APP_ID;
                        file1.FILE_NO = 1;
                        file1.SRC_FILENAME = null;
                        file1.FILENAME = model.ApplyFile_1.FILENAME;

                        file1.ADD_TIME = now;
                        file1.ADD_FUN_CD = "WEB-APPLY";
                        file1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file1.UPD_TIME = now;
                        file1.UPD_FUN_CD = "WEB-APPLY";
                        file1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file1.DEL_MK = "N";
                        base.Insert(file1);
                    }

                    if (model.ApplyFile_2 != null && !string.IsNullOrEmpty(model.ApplyFile_2.FILENAME))
                    {
                        // 外銷專用藥品許可證(反面)
                        Apply_FileModel file2 = new Apply_FileModel();
                        file2.APP_ID = APP_ID;
                        file2.FILE_NO = 2;
                        file2.SRC_FILENAME = null;
                        file2.FILENAME = model.ApplyFile_2.FILENAME;

                        file2.ADD_TIME = now;
                        file2.ADD_FUN_CD = "WEB-APPLY";
                        file2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file2.UPD_TIME = now;
                        file2.UPD_FUN_CD = "WEB-APPLY";
                        file2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file2.DEL_MK = "N";

                        base.Insert(file2);
                    }

                    if (model.ApplyFile_3 != null && !string.IsNullOrEmpty(model.ApplyFile_3.FILENAME))
                    {
                        // 處方之中藥材中英文對照表
                        Apply_FileModel file3 = new Apply_FileModel();
                        file3.APP_ID = APP_ID;
                        file3.FILE_NO = 3;
                        file3.SRC_FILENAME = null;
                        file3.FILENAME = model.ApplyFile_3.FILENAME;

                        file3.ADD_TIME = now;
                        file3.ADD_FUN_CD = "WEB-APPLY";
                        file3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file3.UPD_TIME = now;
                        file3.UPD_FUN_CD = "WEB-APPLY";
                        file3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        file3.DEL_MK = "N";
                        base.Insert(file3);
                    }

                    TblAPPLY_NOTICE notice = new TblAPPLY_NOTICE();
                    notice.APP_ID = APP_ID;
                    notice.Field = "APPLY_ADD_TIME";
                    notice.ISADDYN = "N";
                    notice.FREQUENCY = 1;
                    notice.ADD_TIME = now;
                    base.Insert(notice);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }

            }
        }

        public void UpdateApply005002(Apply_005002ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            string CaseNum = "005002";
            var APP_ID = model.Apply.APP_ID;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);
                    DateTime now = DateTime.Now;

                    ApplyModel currentApply = base.GetRow(new ApplyModel { APP_ID = model.Apply.APP_ID });

                    // 申請案件資料
                    var ap = model.Apply;
                    var apply = new ApplyModel();

                    switch (currentApply.FLOW_CD)
                    {
                        case "2":
                            apply.FLOW_CD = "3";
                            break;
                        case "4":
                            apply.FLOW_CD = "1";
                            apply.APP_DISP_ACC = "";
                            apply.APP_DISP_MK = "N";
                            apply.PRO_ACC = "";
                            apply.PRO_UNIT_CD = -1;
                            apply.MOHW_CASE_NO = "";
                            break;
                    }

                    apply.APP_ID = APP_ID;
                    apply.UNIT_CD = 7;
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    apply.UPD_TIME = now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Update(apply, new ApplyModel { APP_ID = APP_ID });

                    model.Apply.FLOW_CD = apply.FLOW_CD;

                    Dictionary<string, object> dict = new Dictionary<string, object>();
                    dict["APP_ID"] = APP_ID;
                    dict["SRV_ID"] = CaseNum;
                    dict["LastMODTIME"] = now.ToString("yyyyMMddHHmmss");

                    // 基本資料
                    var dtl = model.Detail;
                    dtl.APP_ID = APP_ID;
                    dtl.DEL_MK = "N";
                    dtl.UPD_TIME = now;
                    dtl.UPD_FUN_CD = "WEB-APPLY";
                    dtl.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Update2(dtl, new Apply_005002Model { APP_ID = APP_ID }, dict);

                    // 清除空值欄位
                    Dictionary<string, object> clearArg = new Dictionary<string, object>();
                    clearArg["APPID"] = APP_ID;
                    List<string> clearList = new List<string>();
                    if (!dtl.EXPIR_DATE.HasValue)
                    {
                        clearList.Add("EXPIR_DATE=NULL");
                    }
                    if (string.IsNullOrEmpty(dtl.EFFICACY))
                    {
                        clearList.Add("EFFICACY=NULL");
                    }
                    if (string.IsNullOrEmpty(dtl.EFFICACY_E))
                    {
                        clearList.Add("EFFICACY_E=NULL");
                    }
                    if (string.IsNullOrEmpty(dtl.INDIOCATION))
                    {
                        clearList.Add("INDIOCATION=NULL");
                    }
                    if (string.IsNullOrEmpty(dtl.INDIOCATION_E))
                    {
                        clearList.Add("INDIOCATION_E=NULL");
                    }

                    if (clearList.Count > 0)
                    {
                        string clearSql = string.Format("UPDATE Apply_005002 SET {0} WHERE APP_ID=@APPID ", string.Join(",", clearList));
                        base.Update(clearSql, clearArg);
                    }

                    // 繳費資料
                    #region 繳費資訊
                    //APPLY_PAY pay = new APPLY_PAY();
                    //pay.PAY_ID = APP_ID;
                    //pay.PAY_MONEY = dtl.MF_COPIES * 1500;
                    //pay.PAY_PROFEE = 0;
                    //pay.PAY_ACT_TIME = DateTime.Now;        //新增時間
                    //pay.PAY_EXT_TIME = model.Pay.PAY_EXT_TIME;    //繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;        //異動時間
                    //pay.PAY_METHOD = model.Pay.PAY_METHOD;
                    //pay.PAY_STATUS_MK = model.Pay.PAY_STATUS_MK;
                    //pay.UPD_TIME = DateTime.Now;
                    //pay.UPD_FUN_CD = "WEB-APPLY";
                    //pay.ADD_TIME = DateTime.Now;
                    //pay.ADD_FUN_CD = "WEB-APPLY";
                    //base.Update(pay, new APPLY_PAY { APP_ID = APP_ID });
                    #endregion

                    if (model.IngredientList != null)
                    {
                        base.Delete(new Apply_005002_DiModel { APP_ID = APP_ID });
                        int idx = 0;
                        // 成份資料
                        foreach (var item in model.IngredientList)
                        {
                            item.APP_ID = APP_ID;
                            item.SRL_NO = ++idx;
                            item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.ADD_FUN_CD = "WEB-APPLY";
                            item.ADD_TIME = now;
                            item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.UPD_FUN_CD = "WEB-APPLY";
                            item.UPD_TIME = now;
                            base.Insert(item);
                        }
                    }

                    if (model.ExcipientList != null)
                    {
                        base.Delete(new Apply_005002_PcModel { APP_ID = APP_ID });
                        int idx = 0;
                        // 賦型劑
                        foreach (var item in model.ExcipientList)
                        {
                            item.APP_ID = APP_ID;
                            item.SRL_NO = ++idx;
                            item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.ADD_FUN_CD = "WEB-APPLY";
                            item.ADD_TIME = now;
                            item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.UPD_FUN_CD = "WEB-APPLY";
                            item.UPD_TIME = now;
                            base.Insert(item);
                        }
                    }

                    ShareDAO sdao = new ShareDAO();

                    IList<Tuple<string, string, Apply_FileModel, Apply_FileModel>> logCollection
                        = new List<Tuple<string, string, Apply_FileModel, Apply_FileModel>>();

                    // 外銷專用藥品許可證(正面)
                    if (model.UploadFile_1 != null)
                    {
                        var where = new Apply_FileModel { APP_ID = APP_ID, FILE_NO = 1 };
                        var old = this.GetRow(where);
                        Apply_FileModel file1 = new Apply_FileModel();
                        if (old == null || old.APP_ID == null)
                        {
                            file1.APP_ID = APP_ID;
                            file1.FILE_NO = 1;
                            file1.FILENAME = sdao.PutFile("005002", model.UploadFile_1, "1");
                            file1.SRC_FILENAME = file1.FILENAME;
                            file1.UPD_TIME = now;
                            file1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file1.UPD_FUN_CD = "WEB-APPLY";
                            file1.ADD_TIME = now;
                            file1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file1.ADD_FUN_CD = "WEB-APPLY";
                            base.Insert(file1);
                        }
                        else
                        {
                            file1.APP_ID = APP_ID;
                            file1.FILE_NO = 1;
                            file1.FILENAME = sdao.PutFile("005002", model.UploadFile_1, "1");
                            file1.SRC_FILENAME = file1.FILENAME;
                            file1.UPD_TIME = now;
                            file1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file1.UPD_FUN_CD = "WEB-APPLY";
                            base.Update(file1, where);
                        }

                        var log = new Tuple<string, string, Apply_FileModel, Apply_FileModel>("FIEL_1", "外銷專用藥品許可證(正面)", file1, old);
                        logCollection.Add(log);
                    }

                    // 外銷專用藥品許可證(反面)
                    if (model.UploadFile_2 != null)
                    {
                        var where = new Apply_FileModel { APP_ID = APP_ID, FILE_NO = 2 };
                        var old = this.GetRow(where);
                        Apply_FileModel file2 = new Apply_FileModel();

                        if (old == null || old.APP_ID == null)
                        {
                            file2.APP_ID = APP_ID;
                            file2.FILE_NO = 2;
                            file2.FILENAME = sdao.PutFile("005002", model.UploadFile_2, "2");
                            file2.SRC_FILENAME = file2.FILENAME;
                            file2.UPD_TIME = now;
                            file2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file2.UPD_FUN_CD = "WEB-APPLY";
                            file2.ADD_TIME = now;
                            file2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file2.ADD_FUN_CD = "WEB-APPLY";
                            base.Insert(file2);
                        }
                        else
                        {
                            file2.APP_ID = APP_ID;
                            file2.FILE_NO = 2;
                            file2.FILENAME = sdao.PutFile("005002", model.UploadFile_2, "2");
                            file2.SRC_FILENAME = file2.FILENAME;
                            file2.UPD_TIME = now;
                            file2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file2.UPD_FUN_CD = "WEB-APPLY";
                            base.Update(file2, where);
                        }

                        var log = new Tuple<string, string, Apply_FileModel, Apply_FileModel>("FILE_2", "外銷專用藥品許可證(反面)", file2, old);
                        logCollection.Add(log);
                    }

                    // 處方之中藥材中英文對照表
                    if (model.UploadFile_3 != null)
                    {
                        var where = new Apply_FileModel { APP_ID = APP_ID, FILE_NO = 3 };
                        var old = this.GetRow(where);
                        Apply_FileModel file3 = new Apply_FileModel();

                        if (old == null || old.APP_ID == null)
                        {
                            file3.APP_ID = APP_ID;
                            file3.FILE_NO = 3;
                            file3.FILENAME = sdao.PutFile("005002", model.UploadFile_3, "3");
                            file3.SRC_FILENAME = file3.FILENAME;
                            file3.UPD_TIME = now;
                            file3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file3.UPD_FUN_CD = "WEB-APPLY";
                            file3.ADD_TIME = now;
                            file3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file3.ADD_FUN_CD = "WEB-APPLY";
                            base.Insert(file3);
                        }
                        else
                        {
                            file3.APP_ID = APP_ID;
                            file3.FILE_NO = 3;
                            file3.FILENAME = sdao.PutFile("005002", model.UploadFile_3, "3");
                            file3.SRC_FILENAME = file3.FILENAME;
                            file3.UPD_TIME = now;
                            file3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file3.UPD_FUN_CD = "WEB-APPLY";
                            base.Update(file3, where);
                        }

                        var log = new Tuple<string, string, Apply_FileModel, Apply_FileModel>("FILE_3", "處方之中藥材中英文對照表", file3, old);
                        logCollection.Add(log);
                    }

                    this.Add005002FileLog(logCollection, dict);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }

            }
        }

        public void Add005002FileLog(IList<Tuple<string, string, Apply_FileModel, Apply_FileModel>> logCollection, Dictionary<string, object> dict)
        {
            ClamMember UserInfo = SessionModel.Get().UserInfo.Member;

            IList<string> columnList = new List<string>();
            IList<string> columnNameList = new List<string>();
            IList<string> oldList = new List<string>();
            IList<string> newList = new List<string>();

            string sepe = "<|=|>";
            string sep = "<|s|>";

            if (logCollection.Count > 0)
            {
                foreach (var item in logCollection)
                {
                    columnList.Add(item.Item1);
                    columnNameList.Add(item.Item2);

                    try
                    {
                        newList.Add(item.Item1 + sepe + Path.GetFileName(item.Item3.FILENAME));
                    }
                    catch (Exception ex)
                    {
                        logger.Warn(ex.Message, ex);
                        logger.Debug("Add005002FileLog failed:" + ex.TONotNullString());
                        newList.Add(item.Item1 + sepe + "(無)");
                    }

                    try
                    {
                        oldList.Add(item.Item1 + sepe + Path.GetFileName(item.Item4.FILENAME));
                    }
                    catch (Exception ex)
                    {
                        logger.Warn(ex.Message, ex);
                        logger.Debug("Add005002FileLog failed:" + ex.TONotNullString());
                        oldList.Add(item.Item1 + sepe + "(無)");
                    }
                }

                string column = string.Join(sep, columnList);
                string columnName = string.Join(sep, columnNameList);
                string oldvalue = string.Join(sep, oldList);
                string newvalue = string.Join(sep, newList);

                DateTime now = DateTime.Now;
                var sysLog = new SYS_TRANS_LOG
                {
                    TRANSTIME = now.ToString("yyyy-MM-dd HH:mm:ss.fff"),
                    APP_ID = logCollection[0].Item3.APP_ID,
                    SRV_ID = "005002",
                    BEFOREVALUES = oldvalue,
                    AFTERVALUES = newvalue,
                    COLUMNAME = column,
                    COLUMNAMEC = columnName,
                    TARGETTABLE = "Apply_File",
                    TRANSTYPE = "Update",
                    CONDITIONS = string.Format("APP_ID={0}", logCollection[0].Item3.APP_ID),
                    ADD_ACC = UserInfo.ACC_NO.TONotNullString(),
                    ADD_FUN_CD = "WEB-APPLY",
                    ADD_TIME = now,
                    MODTIME = dict["LastMODTIME"].ToString(),
                    UPD_TIME = now,
                    UPD_FUN_CD = "WEB-APPLY",
                };

                base.ToggleProfiling(false);    // 取消寫log
                base.Insert(sysLog);
                base.ToggleProfiling(true);     // 開啟寫log
            }
        }

        /// <summary>
        /// 新收案通知信
        /// </summary>
        /// <param name="model"></param>
        public void SendMail_005002Notice(Apply_005002ViewModel model)
        {
            if (model.Apply.FLOW_CD == "1") // 新收案件
            {
                string MailBody = "<table align=\"left\" style=\"width:90%;\">";
                MailBody += " <tr><th align=\"left\">" + model.Apply.CNT_NAME + " 您好: </th></tr>";
                MailBody += " <tr><td>貴公司申請外銷證明書(案號：" + model.Apply.APP_ID + ")一案，「人民申請案線上申辦服務系統」已收件，尚待貴公司繳納規費，請提供申請者聯絡資訊、申請案類別、案件編號及規費金額等資料，連同欲繳納之匯票或現金，寄到「115204臺北市南港區忠孝東路六段488號 衛生福利部中醫藥司收」，敬請配合。</td></tr>";
                MailBody += " <tr><td><br /></td></tr>";
                MailBody += " <tr><td>衛生福利部 中醫藥司</td></tr>";
                MailBody += "</table>";

                this.SendMail_New(model.Apply.CNT_NAME, model.Detail.EMAIL.TONotNullString().Replace("@0", "@"), model.Apply.APP_ID, "外銷證明書", "005002", MailBody);
            }
        }

        /// <summary>
        /// 補件通知信
        /// </summary>
        /// <param name="model"></param>
        public void SendMail_005002Resend(Apply_005002ViewModel model)
        {
            string MailBody = "<table align=\"left\" style=\"width:90%;\">";
            MailBody += " <tr><th align=\"left\">" + model.Apply.CNT_NAME + " 您好: </th></tr>";
            MailBody += " <tr><td>您申請外銷證明書，已完成資料補件，將盡速辦理您的申辦案件，謝謝。</td></tr>";
            MailBody += " <tr><td><br /></td></tr>";
            MailBody += " <tr><td>衛生福利部 中醫藥司</td></tr>";
            MailBody += "</table>";

            // 補件收件, 審查中
            if (model.Apply.FLOW_CD == "1")
            {
                this.SendMail_Update(model.Apply.CNT_NAME, model.Detail.EMAIL.TONotNullString().Replace("@0", "@"), model.Apply.APP_ID, "外銷證明書", "005002", null, MailBody, false);
                this.SendMail_Proc(model.Apply.CNT_NAME, model.Detail.EMAIL.TONotNullString().Replace("@0", "@"), model.Apply.APP_ID + "補件完成", "外銷證明書", "005002", null);
            }
            else if (model.Apply.FLOW_CD == "3")
            {
                this.SendMail_Update(model.Apply.CNT_NAME, model.Detail.EMAIL.TONotNullString().Replace("@0", "@"), model.Apply.APP_ID, "外銷證明書", "005002", MailBody);
            }
        }

        #endregion

        #region Apply_005004 中藥GMP廠證明文件(中文)

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply005004(Apply_005004FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "005004";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 7;
                    where.FLOW_CD = "1";
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.IDN = form.IDN;
                    where.NAME = form.MF_CNT_NAME;
                    where.CNT_NAME = form.CNT_NAME;
                    where.CHR_NAME = form.CHR_NAME;
                    where.TEL = form.TEL;
                    where.FAX = form.FAX;
                    where.CNT_TEL = form.TEL;
                    where.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    where.ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    where.APP_TIME = DateTime.Now;
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);
                    #endregion

                    #region 案件
                    Apply_005004Model apply = new Apply_005004Model();
                    apply.APP_ID = APP_ID;
                    apply.MF_ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    apply.LIC_NUM = form.LIC_NUM;
                    apply.FRC_NUM = form.FRC_Num;
                    apply.ISSUE_DATE = Convert.ToDateTime(form.ISSUE_DATE);
                    apply.EXPIR_DATE = null;
                    apply.ATTACH_1 = null;
                    apply.COPIES = 1;
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.ATTACH_2 = form.File_1 == null ? null : dao.PutFile("005004", form.File_1, "2");
                    apply.ATTACH_3 = form.File_2 == null ? null : dao.PutFile("005004", form.File_2, "3");
                    apply.ATTACH_4 = form.File_3 == null ? null : dao.PutFile("005004", form.File_3, "4");
                    apply.APPLY_TYPE = form.APPLY_TYPE;
                    apply.COMP_NAME = form.NAME;
                    apply.EMAIL = form.EMAIL;
                    apply.PL_CD = form.PL_CD;
                    apply.PL_NUM = form.PL_Num;
                    apply.PP_NAME = form.PP_NAME;
                    apply.TRA_CHECK = form.TRA_CHECK;
                    apply.CON_CHECK = form.CON_CHECK;
                    apply.RADIOYN = form.RadioYN;
                    apply.MOHW_CASE_NO_SELF = form.MOHW_CASE_NO_SELF;
                    apply.DEL_MK = "N";
                    base.Insert(apply);


                    #endregion

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;
                    pay.DEL_MK = "N";
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";

                    base.Insert(pay);
                    #endregion

                    #region 附件檔
                    if (apply.ATTACH_2 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = APP_ID;
                        applyFile1.FILE_NO = 2;
                        applyFile1.FILENAME = apply.ATTACH_2;
                        applyFile1.SRC_FILENAME = form.File_1.FileName;
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.DEL_MK = "N";
                        base.Insert(applyFile1);
                    }

                    if (apply.ATTACH_3 != null)
                    {
                        Apply_FileModel applyFile2 = new Apply_FileModel();
                        applyFile2.APP_ID = APP_ID;
                        applyFile2.FILE_NO = 3;
                        applyFile2.FILENAME = apply.ATTACH_3;
                        applyFile2.SRC_FILENAME = form.File_2.FileName;
                        applyFile2.UPD_TIME = DateTime.Now;
                        applyFile2.UPD_FUN_CD = "WEB-APPLY";
                        applyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile2.ADD_TIME = DateTime.Now;
                        applyFile2.ADD_FUN_CD = "WEB-APPLY";
                        applyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile2.DEL_MK = "N";
                        base.Insert(applyFile2);
                    }

                    if (apply.ATTACH_4 != null)
                    {
                        Apply_FileModel applyFile3 = new Apply_FileModel();
                        applyFile3.APP_ID = APP_ID;
                        applyFile3.FILE_NO = 4;
                        applyFile3.FILENAME = apply.ATTACH_4;
                        applyFile3.SRC_FILENAME = form.File_3.FileName;
                        applyFile3.UPD_TIME = DateTime.Now;
                        applyFile3.UPD_FUN_CD = "WEB-APPLY";
                        applyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile3.ADD_TIME = DateTime.Now;
                        applyFile3.ADD_FUN_CD = "WEB-APPLY";
                        applyFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile3.DEL_MK = "N";
                        base.Insert(applyFile3);
                    }
                    #endregion

                    tran.Commit();
                    return APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply005004 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        public Apply_005004Form2Model QueryApply_005004(string app_id)
        {
            Apply_005004Form2Model result = new Apply_005004Form2Model();
            //附件檔
            DataTable file = QueryApplyFile_005004(app_id);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql =
                        @"select APPLY.APP_TIME,APPLY.APP_EXT_DATE,ADMIN.NAME ADMIN_NAME,APPLY.MOHW_CASE_NO,APPLY.APP_ID,APPLY_005004.COMP_NAME,
                                           APPLY.CNT_NAME,APPLY.TEL,APPLY.FAX,APPLY_005004.EMAIL,APPLY.APP_TIME,APPLY.APP_ID,APPLY_005004.APPLY_TYPE,
                                           APPLY_005004.LIC_NUM,APPLY.NAME,APPLY_005004.PL_CD,APPLY_005004.PL_NUM,APPLY.ADDR_CODE,APPLY.ADDR,
                                           APPLY.CHR_NAME,APPLY.IDN,APPLY_005004.PP_NAME,APPLY_005004.FRC_NUM,APPLY_005004.TRA_CHECK,
                                           APPLY_005004.CON_CHECK,convert(varchar,APPLY_005004.ISSUE_DATE,111) ISSUE_DATE,APPLY.PAY_METHOD,
                                           APPLY.PAY_A_FEE,APPLY_005004.RADIOYN,APPLY.FLOW_CD CODE_CD,APPLY_005004.MOHW_CASE_NO_SELF
                                    from APPLY left join APPLY_005004 on APPLY.APP_ID = APPLY_005004.APP_ID
		                                       left join ADMIN on APPLY.PRO_ACC = ADMIN.ACC_NO
                                    where APPLY.APP_ID='" + app_id + "'";
                    result = conn.QueryFirst<Apply_005004Form2Model>(_sql);

                    //分割地址
                    result.TAX_ORG_CITY_CODE = result.ADDR_CODE;
                    result.TAX_ORG_CITY_DETAIL = result.ADDR;
                    TblZIPCODE zip = new TblZIPCODE();
                    zip.ZIP_CO = result.ADDR_CODE;
                    var getnam = GetRow(zip);
                    if (getnam != null)
                    {
                        result.TAX_ORG_CITY_DETAIL = result.ADDR.TONotNullString().Replace(getnam.CITYNM + getnam.TOWNNM, "");
                        result.TAX_ORG_CITY_TEXT = getnam.CITYNM + getnam.TOWNNM;
                    }
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (file != null)
            {
                result.FILE2_TEXT = file.Rows[0][1].ToString();
                result.FILE3_TEXT = file.Rows[0][2].ToString();
                result.FILE4_TEXT = file.Rows[0][3].ToString();
            }

            return result;
        }

        public Apply_005004Form2Model GetApplyNotice_005004(string app_id)
        {
            Apply_005004Form2Model result = new Apply_005004Form2Model();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                                    SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                                    FROM (
	                                        select Field,NOTE
	                                        from APPLY_NOTICE 
	                                        where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"' and ISADDYN='N')
	                                     ) T
                                    GROUP BY QUOTENAME(Field) 

                                    select @ColumnGroup =N'
                                                            SELECT *
                                                            FROM (
	                                                                select isnull(BATCH_INDEX,1) grp,Field,NOTE
	                                                                from APPLY_NOTICE 
	                                                                where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'' and ISADDYN=''N'')
                                                                 ) t 
                                                            PIVOT (
	                                                                MAX(NOTE) 
	                                                                FOR Field IN (' + @ColumnGroup + N')
                                                                   ) p;'

                                                            EXEC sp_executesql  @ColumnGroup";
                    result = conn.QueryFirst<Apply_005004Form2Model>(_sql);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public DataTable QueryApplyFile_005004(string app_id)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @file1 nvarchar(max),@file2 nvarchar(max),@file3 nvarchar(max),@file4 nvarchar(max);

                                    select @file1 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='1'

                                    select @file2 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='2'

                                    select @file3 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='3'

                                    select @file4 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='4'

                                    select @file1 file1,@file2 file2,@file3 file3,@file4 file4";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public string AppendApplyDoc005004(Apply_005004ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;

            ApplyModel newApply = new ApplyModel();
            ApplyModel whereApply = new ApplyModel();
            var propsApply = newApply.GetType().GetProperties();
            newApply.APP_ID = model.FormBack.APP_ID;
            whereApply.APP_ID = model.FormBack.APP_ID;

            Apply_005004Model newApply005004 = new Apply_005004Model();
            Apply_005004Model whereApply005004 = new Apply_005004Model();
            var propsApply005004 = newApply005004.GetType().GetProperties();
            newApply005004.APP_ID = model.FormBack.APP_ID;
            whereApply005004.APP_ID = model.FormBack.APP_ID;
            newApply005004.InjectFrom(model.FormBack);
            if (model.Detail.TRA_CON_CHECK == null)
            {
                newApply005004.TRA_CHECK = null;
                newApply005004.CON_CHECK = null;
            }

            Apply_FileModel newFile2 = new Apply_FileModel();
            Apply_FileModel whereFile2 = new Apply_FileModel();
            newFile2.APP_ID = model.FormBack.APP_ID;
            whereFile2.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel newFile3 = new Apply_FileModel();
            Apply_FileModel whereFile3 = new Apply_FileModel();
            newFile3.APP_ID = model.FormBack.APP_ID;
            whereFile3.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel newFile4 = new Apply_FileModel();
            Apply_FileModel whereFile4 = new Apply_FileModel();
            newFile4.APP_ID = model.FormBack.APP_ID;
            whereFile4.APP_ID = model.FormBack.APP_ID;

            TblAPPLY_NOTICE newApplyNotice = new TblAPPLY_NOTICE();
            TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
            newApplyNotice.ISADDYN = "Y";
            whereApplyNotice.APP_ID = model.FormBack.APP_ID;
            newApplyNotice.APP_ID = model.FormBack.APP_ID;

            var t = model.Detail.GetType();
            PropertyInfo[] props = t.GetProperties();
            for (var i = 0; i < props.Length; i++)
            {
                if (props[i].GetValue(model.Detail) != null)
                {
                    //製造廠地址(3欄位)
                    if (props[i].Name == "TAX_ORG_CITY_CODE")
                    {
                        newApply.ADDR_CODE = model.FormBack.TAX_ORG_CITY_CODE;
                        newApply.ADDR = model.FormBack.TAX_ORG_CITY_TEXT + model.FormBack.TAX_ORG_CITY_DETAIL;
                        newApply.UPD_TIME = DateTime.Now;
                        newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        whereApply.APP_ID = model.FormBack.APP_ID;

                        newApply005004.MF_ADDR = model.FormBack.TAX_ORG_CITY_TEXT + model.FormBack.TAX_ORG_CITY_DETAIL;
                        newApply005004.UPD_TIME = DateTime.Now;
                        newApply005004.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        whereApply005004.APP_ID = model.FormBack.APP_ID;
                    }
                    //藥商許可執照字號(2欄位)
                    else if (props[i].Name == "PL_CD")
                    {
                        newApply005004.PL_CD = model.FormBack.PL_CD;
                        newApply005004.PL_NUM = model.FormBack.PL_Num;
                        newApply005004.UPD_TIME = DateTime.Now;
                        newApply005004.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        whereApply005004.APP_ID = model.FormBack.APP_ID;
                    }
                    //產品類別(2欄位)
                    else if (props[i].Name == "TRA_CON_CHECK")
                    {
                        newApply005004.CON_CHECK = model.FormBack.CON_CHECK;
                        newApply005004.TRA_CHECK = model.FormBack.TRA_CHECK;
                        newApply005004.UPD_TIME = DateTime.Now;
                        newApply005004.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        whereApply005004.APP_ID = model.FormBack.APP_ID;
                    }
                    //檔案上傳處理
                    else if (props[i].Name == "FILE2" || props[i].Name == "FILE3" || props[i].Name == "FILE4")
                    {
                        Apply_FileModel whereApplyFile = new Apply_FileModel();
                        whereApplyFile.APP_ID = model.FormBack.APP_ID;
                        whereApplyFile.FILE_NO = props[i].Name.Substring(4, 1).TOInt32();
                        if (base.GetRowList(whereApplyFile).Count > 0)
                        {
                            //update
                            if (props[i].Name == "FILE2")
                            {
                                whereFile2.APP_ID = model.FormBack.APP_ID;
                                whereFile2.FILE_NO = 2;
                                newFile2.APP_ID = model.FormBack.APP_ID;
                                newFile2.FILE_NO = 2;
                                newFile2.FILENAME = model.FormBack.newFILE2 == null ? null : dao.PutFile("005004", model.FormBack.newFILE2, "2");
                                newFile2.SRC_FILENAME = newFile2.FILENAME == null ? null : model.FormBack.newFILE2.FileName;
                                newFile2.UPD_TIME = DateTime.Now;

                                whereApply005004.APP_ID = model.FormBack.APP_ID;
                                newApply005004.ATTACH_2 = newFile2.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                            else if (props[i].Name == "FILE3")
                            {
                                whereFile3.APP_ID = model.FormBack.APP_ID;
                                whereFile3.FILE_NO = 3;
                                newFile3.APP_ID = model.FormBack.APP_ID;
                                newFile3.FILE_NO = 3;
                                newFile3.FILENAME = model.FormBack.newFILE3 == null ? null : dao.PutFile("005004", model.FormBack.newFILE3, "3");
                                newFile3.SRC_FILENAME = newFile3.FILENAME == null ? null : model.FormBack.newFILE3.FileName;
                                newFile3.UPD_TIME = DateTime.Now;

                                whereApply005004.APP_ID = model.FormBack.APP_ID;
                                newApply005004.ATTACH_3 = newFile3.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                            else if (props[i].Name == "FILE4")
                            {
                                whereFile4.APP_ID = model.FormBack.APP_ID;
                                whereFile4.FILE_NO = 4;
                                newFile4.APP_ID = model.FormBack.APP_ID;
                                newFile4.FILE_NO = 4;
                                newFile4.FILENAME = model.FormBack.newFILE4 == null ? null : dao.PutFile("005004", model.FormBack.newFILE4, "4");
                                newFile4.SRC_FILENAME = newFile4.FILENAME == null ? null : model.FormBack.newFILE4.FileName;
                                newFile4.UPD_TIME = DateTime.Now;

                                whereApply005004.APP_ID = model.FormBack.APP_ID;
                                newApply005004.ATTACH_4 = newFile4.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                        }
                        else
                        {
                            //insert
                            if (props[i].Name == "FILE2")
                            {
                                newFile2.APP_ID = model.FormBack.APP_ID;
                                newFile2.FILE_NO = 2;
                                newFile2.FILENAME = model.FormBack.newFILE2 == null ? null : dao.PutFile("005004", model.FormBack.newFILE2, "2");
                                newFile2.SRC_FILENAME = newFile2.FILENAME == null ? null : model.FormBack.newFILE2.FileName;
                                newFile2.UPD_TIME = DateTime.Now;
                                newFile2.UPD_FUN_CD = "WEB-APPLY";
                                newFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newFile2.ADD_TIME = DateTime.Now;
                                newFile2.ADD_FUN_CD = "WEB-APPLY";
                                newFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                newApply005004.ATTACH_2 = newFile2.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                            else if (props[i].Name == "FILE3")
                            {
                                newFile3.APP_ID = model.FormBack.APP_ID;
                                newFile3.FILE_NO = 3;
                                newFile3.FILENAME = model.FormBack.newFILE3 == null ? null : dao.PutFile("005004", model.FormBack.newFILE3, "3");
                                newFile3.SRC_FILENAME = newFile3.FILENAME == null ? null : model.FormBack.newFILE3.FileName;
                                newFile3.UPD_TIME = DateTime.Now;
                                newFile3.UPD_FUN_CD = "WEB-APPLY";
                                newFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newFile3.ADD_TIME = DateTime.Now;
                                newFile3.ADD_FUN_CD = "WEB-APPLY";
                                newFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                newApply005004.ATTACH_3 = newFile3.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                            else if (props[i].Name == "FILE4")
                            {
                                newFile4.APP_ID = model.FormBack.APP_ID;
                                newFile4.FILE_NO = 4;
                                newFile4.FILENAME = model.FormBack.newFILE4 == null ? null : dao.PutFile("005004", model.FormBack.newFILE4, "4");
                                newFile4.SRC_FILENAME = newFile4.FILENAME == null ? null : model.FormBack.newFILE4.FileName;
                                newFile4.UPD_TIME = DateTime.Now;
                                newFile4.UPD_FUN_CD = "WEB-APPLY";
                                newFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newFile4.ADD_TIME = DateTime.Now;
                                newFile4.ADD_FUN_CD = "WEB-APPLY";
                                newFile4.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                newApply005004.ATTACH_4 = newFile4.FILENAME;
                                newApply005004.UPD_TIME = DateTime.Now;
                            }
                        }
                    }
                    else
                    {
                        var value = props[i].GetValue(model.FormBack);
                        if (propsApply.Where(m => m.Name == props[i].Name).Count() > 0)
                        {
                            propsApply.Where(m => m.Name == props[i].Name).ToList()[0].SetValue(newApply, value);
                            newApply.UPD_TIME = DateTime.Now;
                            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                            whereApply.APP_ID = model.FormBack.APP_ID;
                        }
                        if (propsApply005004.Where(m => m.Name == props[i].Name).Count() > 0)
                        {
                            if (propsApply005004.Where(m => m.Name == props[i].Name).ToList()[0].PropertyType
                                    .ToString() == "System.Nullable`1[System.DateTime]")
                            {
                                value = Convert.ToDateTime(value);
                            }
                            propsApply005004.Where(m => m.Name == props[i].Name).ToList()[0].SetValue(newApply005004, value);
                            newApply005004.UPD_TIME = DateTime.Now;
                            newApply005004.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                            whereApply005004.APP_ID = model.FormBack.APP_ID;
                        }
                    }
                }
            }
            var result = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);

                    string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
                    string s_SRV_ID = "005004";
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.FormBack.APP_ID);
                    dict2.Add("SRV_ID", s_SRV_ID);
                    dict2.Add("LastMODTIME", LastMODTIME);


                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.FLOW_CD = "3";

                    base.Update2(newApply, whereApply, dict2);

                    newApply005004.UPD_TIME = DateTime.Now;
                    newApply005004.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Update2(newApply005004, whereApply005004, dict2);


                    if (newFile2.UPD_TIME != newFile2.ADD_TIME)
                    {
                        //update
                        newFile2.UPD_TIME = DateTime.Now;
                        newFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        base.Update(newFile2, whereFile2);
                    }
                    else
                    {
                        if (newFile2.UPD_TIME != null)
                        {
                            //insert
                            base.Insert(newFile2);
                        }
                    }

                    if (newFile3.UPD_TIME != newFile3.ADD_TIME)
                    {
                        //update
                        newFile3.UPD_TIME = DateTime.Now;
                        newFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        base.Update(newFile3, whereFile3);
                    }
                    else
                    {
                        if (newFile3.UPD_TIME != null)
                        {
                            //insert
                            base.Insert(newFile3);
                        }
                    }

                    if (newFile4.UPD_TIME != newFile4.ADD_TIME)
                    {
                        //update
                        newFile4.UPD_TIME = DateTime.Now;
                        newFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        base.Update(newFile4, whereFile4);
                    }
                    else
                    {
                        if (newFile4.UPD_TIME != null)
                        {
                            //insert
                            base.Insert(newFile4);
                        }
                    }

                    base.Update(newApplyNotice, whereApplyNotice);

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FormBack.CODE_CD == "4")
                    {
                        newApply.FLOW_CD = "1";
                        newApply.APP_DISP_ACC = "";
                        newApply.APP_DISP_MK = "N";
                        newApply.PRO_ACC = "";
                        newApply.PRO_UNIT_CD = -1;
                        newApply.MOHW_CASE_NO = "";

                        base.Update2(newApply, whereApply, dict2);
                    }
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public GMPAPI_Resp SortAddr(GMPAPI_Resp data)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select DISTINCT (CITYNM + TOWNNM) CITY from ZIPCODE where ZIP_CO like '" + data.郵遞區號 + "%'";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            //地址轉換
            data.營業地址 = data.營業地址.TONotNullString().Replace(result.Rows[0][0].TONotNullString(), "");

            ////查廠日期(轉民國)
            //if (!string.IsNullOrEmpty(data.查廠日期))
            //{
            //    data.查廠日期 = Convert.ToInt32(data.查廠日期.Split('/')[0]) - 1911 + "/" +
            //                data.查廠日期.Split('/')[1] + "/" +
            //                data.查廠日期.Split('/')[2];
            //}

            ////有效期限(轉民國)
            //if (!string.IsNullOrEmpty(data.有效期限))
            //{
            //    data.有效期限 = Convert.ToInt32(data.有效期限.Split('/')[0]) - 1911 + "/" +
            //                data.有效期限.Split('/')[1] + "/" +
            //                data.有效期限.Split('/')[2];
            //}

            return data;
        }
        #endregion

        #region Apply_005005 中藥GMP廠證明文件(英文)

        public string AppendApply005005(Apply_005005FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "005005";
            var APP_ID = GetApp_ID(CaseNum);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel apply = new ApplyModel();
                    apply.InjectFrom(form);
                    apply.APP_ID = APP_ID;
                    apply.SRV_ID = CaseNum;
                    apply.SRC_SRV_ID = CaseNum;
                    apply.UNIT_CD = 7;
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.IDN = form.LIC_NUM;//IDN不可為空，存製造廠許可編號
                    apply.NAME = form.NAME;
                    // apply.ENAME = form.MF_CNT_NAME;
                    apply.CNT_NAME = form.CNT_NAME;
                    apply.TEL = form.TEL;
                    if (form.FAX_BEFORE.TONotNullString().ToTrim() != "")
                    {
                        apply.FAX = form.FAX_Extension.TONotNullString().ToTrim() == "" ?
                        form.FAX_BEFORE.TONotNullString() + "-" + form.FAX_AFTER.TONotNullString() :
                        form.FAX_BEFORE.TONotNullString() + "-" + form.FAX_AFTER.TONotNullString() + "#" + form.FAX_Extension.TONotNullString();
                    }
                    apply.CNT_TEL = form.TEL;
                    apply.EADDR = form.MF_ADDR;
                    apply.APP_TIME = DateTime.Now;
                    apply.PAY_POINT = form.PAY_POINT;
                    apply.PAY_METHOD = form.PAY_METHOD;
                    apply.PAY_A_FEE = form.PAY_A_FEE * form.PAYCOUNT.TOInt32();
                    apply.PAY_A_FEEBK = 0;
                    apply.PAY_A_PAID = 0;
                    apply.PAY_C_FEE = 0;
                    apply.PAY_C_FEEBK = 0;
                    apply.PAY_C_PAID = 0;
                    apply.FLOW_CD = "1";
                    apply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(apply);
                    #endregion

                    #region Apply_005005
                    Apply_005005Model apply005005 = new Apply_005005Model();
                    apply005005.APP_ID = APP_ID;
                    apply005005.MF_ADDR = form.MF_ADDR;
                    apply005005.LIC_NUM = form.LIC_NUM;
                    apply005005.ISSUE_DATE = Convert.ToDateTime(form.ISSUE_DATE);
                    apply005005.EXPIR_DATE = Convert.ToDateTime(form.EXPIR_DATE);
                    apply005005.ATTACH_1 = form.File_1 == null ? null : dao.PutFile("005005", form.File_1, "1");
                    apply005005.COPIES = form.PAYCOUNT.TOInt32();
                    apply005005.UPD_TIME = DateTime.Now;
                    apply005005.UPD_FUN_CD = "WEB-APPLY";
                    apply005005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply005005.ADD_TIME = DateTime.Now;
                    apply005005.ADD_FUN_CD = "WEB-APPLY";
                    apply005005.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply005005.ATTACH_2 = form.File_2 == null ? null : dao.PutFile("005005", form.File_2, "2");
                    apply005005.COMP_NAME = form.NAME;
                    //EMAIL_ADDR == "0" 自訂EMAIL
                    apply005005.EMAIL = form.EMAIL;
                    apply005005.RADIOYN = form.RadioYN;
                    apply005005.MF_CNT_NAME = form.MF_CNT_NAME.TONotNullString();
                    base.Insert(apply005005);
                    #endregion

                    #region Apply_file
                    if (apply005005.ATTACH_1 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = APP_ID;
                        applyFile1.FILE_NO = 1;
                        applyFile1.FILENAME = apply005005.ATTACH_1;
                        applyFile1.SRC_FILENAME = form.File_1.FileName;
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.DEL_MK = "N";
                        base.Insert(applyFile1);
                    }

                    if (apply005005.ATTACH_2 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = APP_ID;
                        applyFile1.FILE_NO = 2;
                        applyFile1.FILENAME = apply005005.ATTACH_2;
                        applyFile1.SRC_FILENAME = form.File_2.FileName;
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.DEL_MK = "N";
                        base.Insert(applyFile1);
                    }
                    #endregion

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";
                    pay.DEL_MK = "N";
                    base.Insert(pay);
                    #endregion

                    #region 外銷國家拆分

                    var country = form.IMP_COUNTRY.Trim().Split(',');
                    for (var i = 0; i < country.Length; i++)
                    {
                        if (!string.IsNullOrEmpty(country[i].ToString()))
                        {
                            Apply_005005_IcModel apply005005IC = new Apply_005005_IcModel();
                            apply005005IC.APP_ID = APP_ID;
                            apply005005IC.SRL_NO = i + 1;
                            apply005005IC.IMP_COUNTRY = country[i];
                            apply005005IC.UPD_TIME = DateTime.Now;
                            apply005005IC.UPD_FUN_CD = "WEB-APPLY";
                            apply005005IC.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            apply005005IC.ADD_TIME = DateTime.Now;
                            apply005005IC.ADD_FUN_CD = "WEB-APPLY";
                            apply005005IC.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            apply005005IC.DEL_MK = "N";
                            base.Insert(apply005005IC);
                        }
                    }

                    #endregion

                    tran.Commit();
                    return APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply005005 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        public Apply_005005Form2Model QueryApply_005005(string app_id)
        {
            Apply_005005Form2Model result = new Apply_005005Form2Model();
            //附件檔
            DataTable file = QueryApplyFile_005005(app_id);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select APPLY.APP_TIME,APPLY.APP_EXT_DATE,APPLY.CNT_NAME,APPLY.TEL,APPLY.FAX,APPLY.APP_ID,
									       APPLY.MOHW_CASE_NO,APPLY.APP_TIME,APPLY.APP_ID,APPLY_005005.MF_CNT_NAME,APPLY.NAME,APPLY.ADDR_CODE,
										   APPLY.ADDR,APPLY.CHR_NAME,APPLY.IDN,APPLY.PAY_METHOD, APPLY.PAY_A_FEE,APPLY.FLOW_CD CODE_CD,
                                           APPLY.EADDR,
								           ADMIN.NAME ADMIN_NAME,
										   APPLY_005005.COMP_NAME,APPLY_005005.EMAIL,APPLY_005005.LIC_NUM,
                                           convert(varchar,APPLY_005005.ISSUE_DATE,111) ISSUE_DATE,
										   convert(varchar,APPLY_005005.EXPIR_DATE,111) EXPIR_DATE,APPLY_005005.RADIOYN,APPLY_005005.COPIES PAYCOUNT
                                    from APPLY left join APPLY_005005 on APPLY.APP_ID = APPLY_005005.APP_ID
		                                       left join ADMIN on APPLY.PRO_ACC = ADMIN.ACC_NO
                                    where APPLY.APP_ID='" + app_id + "'";
                    result = conn.QueryFirst<Apply_005005Form2Model>(_sql);
                    //繳費金額計算
                    result.PAYAMOUNT = Convert.ToInt32(result.PAYCOUNT) * 1500;
                    //電話分割
                    result.TEL_BEFORE = result.TEL.Split('-')[0];
                    var temp = result.TEL.Split('-')[1].Split('#');
                    result.TEL_AFTER = temp[0];
                    if (temp.Length > 1)
                    {
                        result.TEL_Extension = temp[1];
                    }
                    //傳真分割
                    if (!string.IsNullOrEmpty(result.FAX))
                    {
                        result.FAX_BEFORE = result.FAX.Split('-')[0];
                        temp = result.FAX.Split('-')[1].Split('#');
                        result.FAX_AFTER = temp[0];
                        if (temp.Length > 1)
                        {
                            result.FAX_Extension = temp[1];
                        }
                    }
                    //製造廠名稱
                    result.MF_CNT_NAME = result.MF_CNT_NAME;
                    //製造廠地址
                    result.MF_ADDR = result.EADDR;
                    //EMAIL拆分
                    temp = result.EMAIL.Split('@');
                    result.EMAIL_BEFORE = temp[0];
                    if (temp[1] == "gmail.com")
                    {
                        result.EMAIL_ADDR = "1";
                    }
                    else if (temp[1] == "yahoo.com.tw")
                    {
                        result.EMAIL_ADDR = "2";
                    }
                    else if (temp[1] == "outlook.com")
                    {
                        result.EMAIL_ADDR = "3";
                    }
                    else
                    {
                        result.EMAIL_ADDR = "0";
                        result.EMAIL_CUSTOM = temp[1];
                    }
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (file != null)
            {
                result.Name_File_1_TEXT = file.Rows[0][0].ToString();
                result.Name_File_2_TEXT = file.Rows[0][1].ToString();
            }

            result.IMP_COUNTRY = QueryApply005005(app_id);

            return result;
        }

        public Apply_005005Form2Model GetApplyNotice_005005(string app_id)
        {
            Apply_005005Form2Model result = new Apply_005005Form2Model();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                                    SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                                    FROM (
	                                        select Field,NOTE
	                                        from APPLY_NOTICE 
	                                        where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"' and ISADDYN='N')
	                                     ) T
                                    GROUP BY QUOTENAME(Field) 

                                    select @ColumnGroup =N'
                                                            SELECT *
                                                            FROM (
	                                                                select isnull(BATCH_INDEX,1) grp,Field,NOTE
	                                                                from APPLY_NOTICE 
	                                                                where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'' and ISADDYN=''N'')
                                                                 ) t 
                                                            PIVOT (
	                                                                MAX(NOTE) 
	                                                                FOR Field IN (' + @ColumnGroup + N')
                                                                   ) p;'

                                                            EXEC sp_executesql  @ColumnGroup";
                    result = conn.QueryFirst<Apply_005005Form2Model>(_sql);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public DataTable QueryApplyFile_005005(string app_id)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @file1 nvarchar(max),@file2 nvarchar(max),@file3 nvarchar(max),@file4 nvarchar(max);

                                    select @file1 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='1'

                                    select @file2 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='2'

                                    select @file1 file1,@file2 file2";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public string AppendApplyDoc005005(Apply_005005ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;

            ApplyModel newApply = new ApplyModel();
            ApplyModel whereApply = new ApplyModel();
            var propsApply = newApply.GetType().GetProperties();
            whereApply.APP_ID = model.FormBack.APP_ID;
            newApply.APP_ID = model.FormBack.APP_ID;

            Apply_005005Model newApply005005 = new Apply_005005Model();
            Apply_005005Model whereApply005005 = new Apply_005005Model();
            var propsApply005005 = newApply005005.GetType().GetProperties();
            newApply005005.APP_ID = model.FormBack.APP_ID;
            whereApply005005.APP_ID = model.FormBack.APP_ID;
            newApply005005.InjectFrom(model.FormBack);
            newApply005005.MF_CNT_NAME = model.FormBack.MF_CNT_NAME;

            Apply_005005_IcModel newApply005005IC = new Apply_005005_IcModel();
            Apply_005005_IcModel whereApply005005IC = new Apply_005005_IcModel();
            newApply005005IC.APP_ID = model.FormBack.APP_ID;
            whereApply005005IC.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel newFile1 = new Apply_FileModel();
            Apply_FileModel whereFile1 = new Apply_FileModel();
            newFile1.APP_ID = model.FormBack.APP_ID;
            whereFile1.APP_ID = model.FormBack.APP_ID;

            Apply_FileModel newFile2 = new Apply_FileModel();
            Apply_FileModel whereFile2 = new Apply_FileModel();
            newFile2.APP_ID = model.FormBack.APP_ID;
            whereFile2.APP_ID = model.FormBack.APP_ID;

            TblAPPLY_NOTICE newApplyNotice = new TblAPPLY_NOTICE();
            TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
            newApplyNotice.ISADDYN = "Y";
            whereApplyNotice.APP_ID = model.FormBack.APP_ID;
            newApplyNotice.APP_ID = model.FormBack.APP_ID;

            var t = model.Detail.GetType();
            PropertyInfo[] props = t.GetProperties();
            for (var i = 0; i < props.Length; i++)
            {
                if (props[i].GetValue(model.Detail) != null)
                {
                    //檔案上傳處理
                    if (props[i].Name == "Name_File_1" || props[i].Name == "Name_File_2")
                    {
                        Apply_FileModel whereApplyFile = new Apply_FileModel();
                        whereApplyFile.FILE_NO = Convert.ToInt32(props[i].Name.Split('_')[2]);
                        whereApplyFile.APP_ID = model.FormBack.APP_ID;
                        if (base.GetRowList(whereApplyFile).Count > 0)
                        {
                            //update
                            if (props[i].Name == "Name_File_1")
                            {
                                whereFile1.FILE_NO = 1;
                                newFile1.APP_ID = model.FormBack.APP_ID;
                                newFile1.FILE_NO = 1;
                                newFile1.FILENAME = model.FormBack.File_1 == null ? null : dao.PutFile("005005", model.FormBack.File_1, "1");
                                newFile1.SRC_FILENAME = newFile1.FILENAME == null ? null : model.FormBack.File_1.FileName;
                                newFile1.UPD_TIME = DateTime.Now;

                                newApply005005.ATTACH_1 = newFile1.FILENAME;
                            }
                            else if (props[i].Name == "Name_File_2")
                            {
                                whereFile2.FILE_NO = 2;
                                newFile2.APP_ID = model.FormBack.APP_ID;
                                newFile2.FILE_NO = 2;
                                newFile2.FILENAME = model.FormBack.File_2 == null ? null : dao.PutFile("005005", model.FormBack.File_2, "2");
                                newFile2.SRC_FILENAME = newFile2.FILENAME == null ? null : model.FormBack.File_2.FileName;
                                newFile2.UPD_TIME = DateTime.Now;

                                newApply005005.ATTACH_2 = newFile2.FILENAME;
                            }
                        }
                        else
                        {
                            //insert
                            if (props[i].Name == "Name_File_1")
                            {
                                newFile1.APP_ID = model.FormBack.APP_ID;
                                newFile1.FILE_NO = 1;
                                newFile1.FILENAME = model.FormBack.File_1 == null ? null : dao.PutFile("005005", model.FormBack.File_1, "1");
                                newFile1.SRC_FILENAME = newFile1.FILENAME == null ? null : model.FormBack.File_1.FileName;
                                newFile1.UPD_TIME = DateTime.Now;
                                newFile1.UPD_FUN_CD = "WEB-APPLY";
                                newFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newFile1.ADD_TIME = DateTime.Now;
                                newFile1.ADD_FUN_CD = "WEB-APPLY";
                                newFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                newApply005005.ATTACH_1 = newFile1.FILENAME;
                            }
                            else if (props[i].Name == "Name_File_2")
                            {
                                newFile2.APP_ID = model.FormBack.APP_ID;
                                newFile2.FILE_NO = 2;
                                newFile2.FILENAME = model.FormBack.File_2 == null ? null : dao.PutFile("005005", model.FormBack.File_2, "2");
                                newFile2.SRC_FILENAME = newFile2.FILENAME == null ? null : model.FormBack.File_2.FileName;
                                newFile2.UPD_TIME = DateTime.Now;
                                newFile2.UPD_FUN_CD = "WEB-APPLY";
                                newFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newFile2.ADD_TIME = DateTime.Now;
                                newFile2.ADD_FUN_CD = "WEB-APPLY";
                                newFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                newApply005005.ATTACH_2 = newFile2.FILENAME;
                            }
                        }
                    }
                    else
                    {
                        var value = props[i].GetValue(model.FormBack);
                        //if (props[i].Name == "MF_CNT_NAME")
                        //{
                        //    newApply.ENAME = value.ToString();
                        //}

                        if (props[i].Name == "MF_ADDR")
                        {
                            newApply.EADDR = value.ToString();
                        }

                        if (propsApply.Where(m => m.Name == props[i].Name).Count() > 0)
                        {
                            propsApply.Where(m => m.Name == props[i].Name).ToList()[0].SetValue(newApply, value);
                            newApply.UPD_TIME = DateTime.Now;
                            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        if (propsApply005005.Where(m => m.Name == props[i].Name).Count() > 0)
                        {
                            if (propsApply005005.Where(m => m.Name == props[i].Name).ToList()[0].PropertyType
                                    .ToString() == "System.Nullable`1[System.DateTime]")
                            {
                                value = Convert.ToDateTime(value);
                            }
                            propsApply005005.Where(m => m.Name == props[i].Name).ToList()[0].SetValue(newApply005005, value);
                            newApply005005.UPD_TIME = DateTime.Now;
                            newApply005005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                            whereApply005005.APP_ID = model.FormBack.APP_ID;
                        }
                    }
                }
            }
            var result = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);

                    string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
                    string s_SRV_ID = "005005";
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.FormBack.APP_ID);
                    dict2.Add("SRV_ID", s_SRV_ID);
                    dict2.Add("LastMODTIME", LastMODTIME);

                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.FLOW_CD = "3";
                    base.Update2(newApply, whereApply, dict2);

                    newApply005005.UPD_TIME = DateTime.Now;
                    newApply005005.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Update2(newApply005005, whereApply005005, dict2);

                    if (newFile1.UPD_TIME != newFile1.ADD_TIME)
                    {
                        //update
                        newFile1.UPD_TIME = DateTime.Now;
                        newFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        base.Update(newFile1, whereFile1);
                    }
                    else
                    {
                        if (newFile1.UPD_TIME != null)
                        {
                            //insert
                            base.Insert(newFile1);
                        }
                    }

                    if (newFile2.UPD_TIME != newFile2.ADD_TIME)
                    {
                        //update
                        newFile2.UPD_TIME = DateTime.Now;
                        newFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        base.Update(newFile2, whereFile2);
                    }
                    else
                    {
                        if (newFile2.UPD_TIME != null)
                        {
                            //insert
                            base.Insert(newFile2);
                        }
                    }

                    base.Update(newApplyNotice, whereApplyNotice);

                    //外銷國家處理
                    if (!string.IsNullOrEmpty(model.Detail.IMP_COUNTRY))
                    {
                        //將當前資料DEL_MK更新
                        newApply005005IC.APP_ID = model.FormBack.APP_ID;
                        newApply005005IC.DEL_MK = "Y";
                        newApply005005IC.DEL_TIME = DateTime.Now;
                        newApply005005IC.DEL_FUN_CD = "WEB-APPLY";
                        newApply005005IC.DEL_ACC = UserInfo.ACC_NO.TONotNullString();
                        whereApply005005IC.APP_ID = model.FormBack.APP_ID;

                        base.Update2(newApply005005IC, whereApply005005IC, dict2);

                        //建立新資料
                        var impSplit = model.FormBack.IMP_COUNTRY.Split(',');
                        for (var i = 0; i < impSplit.Length; i++)
                        {
                            newApply005005IC = new Apply_005005_IcModel();
                            newApply005005IC.APP_ID = model.FormBack.APP_ID;
                            newApply005005IC.SRL_NO = i + 1;
                            newApply005005IC.IMP_COUNTRY = impSplit[i];
                            newApply005005IC.UPD_TIME = DateTime.Now;
                            newApply005005IC.UPD_FUN_CD = "WEB-APPLY";
                            newApply005005IC.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            newApply005005IC.ADD_TIME = DateTime.Now;
                            newApply005005IC.ADD_FUN_CD = "WEB-APPLY";
                            newApply005005IC.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                            base.Insert(newApply005005IC);
                        }
                    }

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FormBack.CODE_CD == "4")
                    {
                        newApply.FLOW_CD = "1";
                        newApply.APP_DISP_ACC = "";
                        newApply.APP_DISP_MK = "N";
                        newApply.PRO_ACC = "";
                        newApply.PRO_UNIT_CD = -1;
                        newApply.MOHW_CASE_NO = "";

                        base.Update2(newApply, whereApply, dict2);
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public string QueryApply005005(string app_id)
        {
            DataTable result = new DataTable();
            var result_str = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"SELECT STUFF(
		                                    (SELECT ',' + IMP_COUNTRY 
		                                     FROM APPLY_005005_IC 
		                                     WHERE APP_ID='" + app_id + @"' AND DEL_MK='N'  
		                                     FOR XML PATH('')),1, 1, '') IMP_COUNTRY";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);

                    result_str = result.Rows[0][0].ToString();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                    result_str = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result_str;
        }

        public int GetNoticeCount(string app_id)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select count(*) 
                                    from APPLY_NOTICE 
                                    where APP_ID='" + app_id + @"' 
                                      and FREQUENCY=(select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + "')";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    //result = null;
                    //return ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Convert.ToInt32(result.Rows[0][0].ToString());
        }

        #endregion

        #region Apply_005013 少量自用中藥樣品申請

        public string AppendApply005013(Apply_005013FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "005013";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                try
                {
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);

                    #region Apply

                    ApplyModel NewApply = new ApplyModel();
                    NewApply.APP_ID = APP_ID;
                    NewApply.SRV_ID = CaseNum;
                    NewApply.SRC_SRV_ID = CaseNum;
                    NewApply.UNIT_CD = 7;
                    NewApply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    NewApply.IDN = form.IDN;
                    NewApply.NAME = form.NAME;
                    NewApply.TEL = form.TEL;
                    NewApply.MOBILE = form.MOBILE;
                    NewApply.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    NewApply.ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    NewApply.FLOW_CD = "1";
                    NewApply.PAY_POINT = "A";
                    NewApply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.APP_TIME = DateTime.Now;
                    NewApply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    NewApply.APP_TIME = DateTime.Now;
                    NewApply.ADD_TIME = DateTime.Now;
                    NewApply.ADD_FUN_CD = "WEB-APPLY";
                    NewApply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.UPD_TIME = DateTime.Now;
                    NewApply.UPD_FUN_CD = "WEB-APPLY";
                    NewApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.DEL_MK = "N";
                    NewApply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(NewApply);

                    #endregion

                    #region Apply_005013

                    APPLY_005013 NewApply005013 = new APPLY_005013();
                    NewApply005013.APP_ID = APP_ID;
                    NewApply005013.ORIGIN = form.ProductionCountry;
                    NewApply005013.ORIGIN_TEXT = form.ProductionCountry_TEXT;
                    NewApply005013.SELLER = form.SellerCountry;
                    NewApply005013.SELLER_TEXT = form.SellerCountry_TEXT;
                    NewApply005013.SHIPPINGPORT = form.ShippingPort;
                    NewApply005013.SHIPPINGPORT_TEXT = form.ShippingPort_TEXT;
                    NewApply005013.APP_TYPE = form.CSEE_TYPE;
                    NewApply005013.RADIOUSAGE = form.RADIOUSAGE;
                    NewApply005013.RADIOUSAGE_TEXT = form.RADIOUSAGE_TEXT;
                    NewApply005013.RADIOYN = form.RADIOYN;
                    NewApply005013.ADD_TIME = DateTime.Now;
                    NewApply005013.ADD_FUN_CD = "WEB-APPLY";
                    NewApply005013.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply005013.UPD_TIME = DateTime.Now;
                    NewApply005013.UPD_FUN_CD = "WEB-APPLY";
                    NewApply005013.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply005013.EMAIL = form.EMAIL;
                    NewApply005013.DEL_MK = "N";
                    base.Insert(NewApply005013);

                    #endregion

                    #region Apply_005013_ITEM1

                    foreach (var item in form.newApplyItem)
                    {
                        var item2 = form.ApplyItem2[item.ItemNum.TOInt32() - 1];

                        APPLY_005013_ITEM1 NewApplyItem1 = new APPLY_005013_ITEM1();
                        NewApplyItem1.APP_ID = APP_ID;
                        NewApplyItem1.ITEMNUM = item.ItemNum;
                        NewApplyItem1.COMMODITIES = item.Commodities.TONotNullString();
                        NewApplyItem1.COMMODMEMO = item.CommodMemo.TONotNullString();
                        NewApplyItem1.SPEC = item.Spec;
                        NewApplyItem1.QTY = item.Qty;
                        NewApplyItem1.UNIT = item.Unit;
                        NewApplyItem1.UNIT_TEXT = item.Unit_TEXT.Replace("::", "‖");
                        NewApplyItem1.ADD_TIME = DateTime.Now;
                        NewApplyItem1.ADD_FUN_CD = "WEB-APPLY";
                        NewApplyItem1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        NewApplyItem1.UPD_TIME = DateTime.Now;
                        NewApplyItem1.UPD_FUN_CD = "WEB-APPLY";
                        NewApplyItem1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        NewApplyItem1.DEL_MK = "N";
                        NewApplyItem1.PORCTYPE = item.PorcType.TONotNullString();
                        NewApplyItem1.COMMODTYPE = item.CommodType.TONotNullString();
                        NewApplyItem1.SPECQTY = item.SpecQty;
                        NewApplyItem1.SPECUNIT = item.SpecUnit;
                        NewApplyItem1.SPECUNIT_TEXT = item.SpecUnit_TEXT.Replace("::", "‖");
                        base.Insert(NewApplyItem1);
                        // 切結書
                        APPLY_005013_ITEM2 NewApplyItem2 = new APPLY_005013_ITEM2();
                        NewApplyItem2.APP_ID = APP_ID;
                        NewApplyItem2.ITEMNUM = item.ItemNum;
                        NewApplyItem2.ITEMNAME = item2.ItemName;
                        NewApplyItem2.USAGE = item2.Usage;
                        NewApplyItem2.ALLQTY = $"共{item2.ItemQty}{item2.ItemQtyUnit.Replace("::", "‖")}，每{item2.ItemQtyUnit2.Replace("::", "‖")}{item2.ItemSpecQty}{item2.ItemSpecQtyUnit.Replace("::", "‖")}";
                        NewApplyItem2.ADD_TIME = DateTime.Now;
                        NewApplyItem2.ADD_FUN_CD = "WEB-APPLY";
                        NewApplyItem2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        NewApplyItem2.UPD_TIME = DateTime.Now;
                        NewApplyItem2.UPD_FUN_CD = "WEB-APPLY";
                        NewApplyItem2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        NewApplyItem2.DEL_MK = "N";
                        NewApplyItem2.QTY = item.Qty;
                        NewApplyItem2.UNIT = item.Unit;
                        NewApplyItem2.SPECQTY = item.SpecQty;
                        NewApplyItem2.SPECUNIT = item.SpecUnit;
                        base.Insert(NewApplyItem2);
                    }

                    #endregion

                    #region Apply_File

                    if (form.File_1 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 1;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_1, "1");
                        applyFile.SRC_FILENAME = form.File_1.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.File_2 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 2;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_2, "2");
                        applyFile.SRC_FILENAME = form.File_2.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.File_3 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 3;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_3, "3");
                        applyFile.SRC_FILENAME = form.File_3.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.File_4 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 4;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_4, "4");
                        applyFile.SRC_FILENAME = form.File_4.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }
                    if (form.File_5 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 5;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_5, "5");
                        applyFile.SRC_FILENAME = form.File_5.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }
                    if (form.File_6 != null)
                    {
                        Apply_FileModel applyFile = new Apply_FileModel();
                        applyFile.APP_ID = APP_ID;
                        applyFile.FILE_NO = 6;
                        applyFile.FILENAME = dao.PutFile("005013", form.File_6, "6");
                        applyFile.SRC_FILENAME = form.File_6.FileName;
                        applyFile.UPD_TIME = DateTime.Now;
                        applyFile.UPD_FUN_CD = "WEB-APPLY";
                        applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.ADD_TIME = DateTime.Now;
                        applyFile.ADD_FUN_CD = "WEB-APPLY";
                        applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile.DEL_MK = "N";
                        base.Insert(applyFile);
                    }

                    if (form.ApplyFile.Count > 0)
                    {
                        for (int i = 0, j = 0; i < form.ApplyFile.Count; i++)
                        {
                            if (form.ApplyFile[i].File != null)
                            {
                                Apply_FileModel applyFile = new Apply_FileModel();
                                applyFile.APP_ID = APP_ID;
                                applyFile.FILE_NO = 7 + i;
                                applyFile.FILENAME = dao.PutFile("005013", form.ApplyFile[i].File, (7 + i).ToString());
                                applyFile.SRC_FILENAME = form.ApplyFile[i].FileName;
                                applyFile.SRC_NO = 1;
                                applyFile.BATCH_INDEX = j + 1;
                                applyFile.UPD_TIME = DateTime.Now;
                                applyFile.UPD_FUN_CD = "WEB-APPLY";
                                applyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyFile.ADD_TIME = DateTime.Now;
                                applyFile.ADD_FUN_CD = "WEB-APPLY";
                                applyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyFile.DEL_MK = "N";
                                j++;

                                base.Insert(applyFile);
                            }
                        }
                    }

                    #endregion

                    tran.Commit();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply005013 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        public Apply_005013Form2Model QueryApply_005013(string app_id)
        {
            Apply_005013Form2Model result = new Apply_005013Form2Model();
            //附件檔
            DataTable File = QueryApplyFile_005013(app_id);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select APPLY.APP_TIME,APPLY.APP_EXT_DATE,APPLY.APP_ID,APPLY.NAME,APPLY.IDN,APPLY.ADDR_CODE,APPLY.ADDR,
                                           APPLY.TEL,FLOW_CD CODE_CD,APPLY.MOBILE,

                                           ADMIN.NAME ADMIN_NAME,

	                                       APPLY_005013.APP_TYPE CSEE_TYPE,APPLY_005013.ORIGIN ProductionCountry,APPLY_005013.SELLER SellerCountry,
                                           APPLY_005013.SHIPPINGPORT,APPLY_005013.RADIOUSAGE,APPLY_005013.RADIOUSAGE_TEXT,APPLY_005013.RADIOYN,
                                           APPLY_005013.EMAIL

                                    from apply left join APPLY_005013 on apply.APP_ID = apply_005013.APP_ID
	                                           left join ADMIN on APPLY.PRO_ACC = ADMIN.ACC_NO
                                    where apply.APP_ID='" + app_id + "'";
                    result = conn.QueryFirst<Apply_005013Form2Model>(_sql);

                    //分割地址
                    result.TAX_ORG_CITY_CODE = result.ADDR_CODE;
                    result.TAX_ORG_CITY_DETAIL = result.ADDR;
                    TblZIPCODE zip = new TblZIPCODE();
                    zip.ZIP_CO = result.ADDR_CODE;
                    var getnam = GetRow(zip);
                    if (getnam != null)
                    {
                        result.TAX_ORG_CITY_DETAIL = result.ADDR.TONotNullString().Replace(getnam.CITYNM + getnam.TOWNNM, "");
                        result.TAX_ORG_CITY_TEXT = getnam.CITYNM + getnam.TOWNNM;
                    }
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            result.FormApply005013Item1 = QueryApply_005013_Item1(app_id);
            result.FormApply005013Item2 = QueryApply_005013_Item2(app_id);
            if (File != null)
            {
                if (File.Rows.Count > 0)
                {
                    result.File_1_TEXT = File.Rows[0][0].ToString();
                    result.File_2_TEXT = File.Rows[0][1].ToString();
                    result.File_3_TEXT = File.Rows[0][2].ToString();
                    result.File_4_TEXT = File.Rows[0][3].ToString();
                    result.File_5_TEXT = File.Rows[0][4].ToString();
                    result.File_6_TEXT = File.Rows[0][5].ToString();
                }
            }

            result.FormFile = QueryApplyFileList_005013(app_id);

            return result;
        }

        public Apply_005013Form2Model GetApplyNotice_005013(string app_id)
        {
            Apply_005013Form2Model result = new Apply_005013Form2Model();
            DataTable dtTemp = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    //抓取非動態補件欄位
                    string _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                                    SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                                    FROM (
	                                        select Field,NOTE
	                                        from APPLY_NOTICE 
	                                        where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"') and ISADDYN='N' and BATCH_INDEX is null
	                                     ) T
                                    GROUP BY QUOTENAME(Field) 

                                    select @ColumnGroup =N'
                                                            SELECT *
                                                            FROM (
	                                                                select isnull(BATCH_INDEX,1) grp,Field,NOTE
	                                                                from APPLY_NOTICE 
	                                                                where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'') and ISADDYN=''N'' and BATCH_INDEX is null
                                                                 ) t 
                                                            PIVOT (
	                                                                MAX(NOTE) 
	                                                                FOR Field IN (' + @ColumnGroup + N')
                                                                   ) p;'

                                                            EXEC sp_executesql  @ColumnGroup";
                    try
                    {
                        result = conn.QueryFirst<Apply_005013Form2Model>(_sql);
                    }
                    catch (Exception ex)
                    {
                        logger.Error("GetApplyNotice_005013 failed:" + ex.TONotNullString());
                    }


                    //抓取ApplyItem動態補件欄位
                    _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                             SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                             FROM (
	                                 select Field,NOTE
	                                 from APPLY_NOTICE 
	                                 where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"') and ISADDYN='N' and BATCH_INDEX is not null and SRC_NO='1'
	                              ) T
                             GROUP BY QUOTENAME(Field) 

                             select @ColumnGroup =N'
                                                     SELECT *
                                                     FROM (
	                                                         select isnull(BATCH_INDEX,1) ItemNum,Field,NOTE
	                                                         from APPLY_NOTICE 
	                                                         where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'') and ISADDYN=''N'' and BATCH_INDEX is not null and SRC_NO=''1''
                                                          ) t 
                                                     PIVOT (
	                                                         MAX(NOTE) 
	                                                         FOR Field IN (' + @ColumnGroup + N')
                                                            ) p;'

                                                     EXEC sp_executesql  @ColumnGroup";
                    try
                    {
                        result.FormApply005013Item1 = conn.Query<ApplyItemModel>(_sql).ToList();
                    }
                    catch (Exception ex)
                    {
                        logger.Error("GetApplyNotice_005013 failed:" + ex.TONotNullString());
                    }

                    //抓取ApplyItem2動態補件欄位
                    _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                             SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                             FROM (
	                                 select Field,NOTE
	                                 from APPLY_NOTICE 
	                                 where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"') and ISADDYN='N' and BATCH_INDEX is not null and SRC_NO='2'
	                              ) T
                             GROUP BY QUOTENAME(Field) 

                             select @ColumnGroup =N'
                                                     SELECT *
                                                     FROM (
	                                                         select isnull(BATCH_INDEX,1) ItemNum,Field,NOTE
	                                                         from APPLY_NOTICE 
	                                                         where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'') and ISADDYN=''N'' and BATCH_INDEX is not null and SRC_NO=''2''
                                                          ) t 
                                                     PIVOT (
	                                                         MAX(NOTE) 
	                                                         FOR Field IN (' + @ColumnGroup + N')
                                                            ) p;'

                                                     EXEC sp_executesql  @ColumnGroup";
                    try
                    {
                        result.FormApply005013Item2 = conn.Query<ApplyItem2Model>(_sql).ToList();
                    }
                    catch (Exception ex)
                    {
                        logger.Error("GetApplyNotice_005013 failed:" + ex.TONotNullString());
                    }

                    //抓取ApplyFile動態補件欄位
                    _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                             SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                             FROM (
	                                 select Field,NOTE
	                                 from APPLY_NOTICE 
	                                 where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"') and ISADDYN='N' and BATCH_INDEX is not null and SRC_NO='3'
	                              ) T
                             GROUP BY QUOTENAME(Field) 

                             select @ColumnGroup =N'
                                                     SELECT *
                                                     FROM (
	                                                         select isnull(BATCH_INDEX,1) ItemNum,Field,NOTE
	                                                         from APPLY_NOTICE 
	                                                         where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'') and ISADDYN=''N'' and BATCH_INDEX is not null and SRC_NO=''3''
                                                          ) t 
                                                     PIVOT (
	                                                         MAX(NOTE) 
	                                                         FOR Field IN (' + @ColumnGroup + N')
                                                            ) p;'

                                                     EXEC sp_executesql  @ColumnGroup";
                    try
                    {
                        result.FormFile = conn.Query<ApplyFileItem4Model>(_sql).ToList();
                    }
                    catch (Exception ex)
                    {
                        logger.Error("GetApplyNotice_005013 failed:" + ex.TONotNullString());
                    }
                }
                catch (Exception ex)
                {
                    logger.Error("GetApplyNotice_005013 failed:" + ex.TONotNullString());
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        public DataTable QueryApplyFile_005013(string app_id)
        {
            DataTable result = new DataTable();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"DECLARE @file1 nvarchar(max),@file2 nvarchar(max),@file3 nvarchar(max),@file4 nvarchar(max),@file5 nvarchar(max),@file6 nvarchar(max)

                                    select @file1 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='1'

                                    select @file2 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='2'

									select @file3 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='3'

									select @file4 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='4'

									select @file5 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='5'

									select @file6 = isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO='6'

                                    select @file1 file1,@file2 file2,@file3 file3,@file4 file4,@file5 file5,@file6 file6";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(result);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        public IList<ApplyItemModel> QueryApply_005013_Item1(string app_id)
        {
            APPLY_005013_ITEM1 where = new APPLY_005013_ITEM1();
            where.APP_ID = app_id;
            var temp = base.GetRowList<APPLY_005013_ITEM1>(where);
            IList<ApplyItemModel> result = new List<ApplyItemModel>();

            foreach (var item in temp)
            {
                ApplyItemModel newItem = new ApplyItemModel();
                newItem.ItemNum = item.ITEMNUM;
                newItem.Commodities = item.COMMODITIES;
                newItem.CommodMemo = item.COMMODMEMO;
                newItem.Spec = item.SPEC;
                newItem.Qty = item.QTY;
                newItem.Unit = item.UNIT;
                newItem.Unit_TEXT = item.UNIT_TEXT;
                newItem.PorcType = item.PORCTYPE;
                newItem.CommodType = item.COMMODTYPE;
                newItem.SpecQty = item.SPECQTY;
                newItem.SpecUnit = item.SPECUNIT;
                newItem.SpecUnit_TEXT = item.SPECUNIT_TEXT;
                result.Add(newItem);
            }

            return result;
        }

        public IList<ApplyItem2Model> QueryApply_005013_Item2(string app_id)
        {
            ShareDAO dbo = new ShareDAO();
            APPLY_005013_ITEM2 where = new APPLY_005013_ITEM2();
            where.APP_ID = app_id;
            var temp = base.GetRowList<APPLY_005013_ITEM2>(where);
            IList<ApplyItem2Model> result = new List<ApplyItem2Model>();

            foreach (var item in temp)
            {
                ApplyItem2Model newItem = new ApplyItem2Model();
                newItem.ItemNum = item.ITEMNUM;
                newItem.ItemName = item.ITEMNAME;
                newItem.Usage = item.USAGE;
                newItem.AllQty = item.ALLQTY;
                newItem.ItemQty = item.QTY;
                newItem.ItemQtyUnit = dbo.Getvw_PACK(item.UNIT);
                newItem.ItemQtyUnit2 = newItem.ItemQtyUnit;
                newItem.UNIT = item.UNIT;
                newItem.ItemSpecQty = item.SPECQTY;
                newItem.ItemSpecQtyUnit = dbo.Getvw_PACK_UNIT(item.SPECUNIT);
                newItem.SPECUNIT = item.SPECUNIT;
                result.Add(newItem);
            }

            return result;
        }

        public IList<ApplyFileItem4Model> QueryApplyFileList_005013(string app_id)
        {
            DataTable dt = new DataTable();
            IList<ApplyFileItem4Model> result = new List<ApplyFileItem4Model>();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    string _sql = @"select isnull(null,SUBSTRING(FILENAME,16,len(FILENAME))) + ',' + convert(varchar,APP_ID) + ',' + convert(varchar,FILE_NO) + ',' + isnull(convert(varchar,SRC_NO),'0')+ ','+isnull(convert(varchar,BATCH_INDEX),'0') file7 
                                    from APPLY_FILE where APP_ID='" + app_id + @"' and FILE_NO > 6
									order by convert(int,BATCH_INDEX)";
                    SqlCommand cmd = new SqlCommand(_sql, conn);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    da.Fill(dt);
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    dt = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (dt != null)
            {
                if (dt.Rows.Count > 0)
                {
                    for (var i = 0; i < dt.Rows.Count; i++)
                    {
                        ApplyFileItem4Model newItem = new ApplyFileItem4Model();
                        newItem.FileName_TEXT = dt.Rows[i][0].ToString();

                        result.Add(newItem);
                    }
                }
            }

            return result;
        }
        /// <summary>
        /// 005013 補件儲存
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public string AppendApplyDoc005013(Apply_005013ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;

            ApplyModel newApply = new ApplyModel();
            ApplyModel whereApply = new ApplyModel();
            var propsApply = newApply.GetType().GetProperties();
            whereApply.APP_ID = model.FormBack.APP_ID;
            newApply.APP_ID = model.FormBack.APP_ID;
            newApply.ADD_TIME = null;
            newApply.APP_TIME = null;

            APPLY_005013 newApply005013 = new APPLY_005013();
            APPLY_005013 whereApply005013 = new APPLY_005013();
            var propsApply005013 = newApply005013.GetType().GetProperties();
            whereApply005013.APP_ID = model.FormBack.APP_ID;
            newApply005013.InjectFrom(model.FormBack);
            newApply005013.APP_ID = model.FormBack.APP_ID;
            newApply005013.EMAIL = null;
            newApply005013.ADD_TIME = null;
            newApply005013.ORIGIN = model.FormBack.ProductionCountry;
            newApply005013.ORIGIN_TEXT = model.FormBack.ProductionCountry_TEXT;
            newApply005013.SELLER = model.FormBack.SellerCountry;
            newApply005013.SELLER_TEXT = model.FormBack.SellerCountry_TEXT;
            newApply005013.SHIPPINGPORT = model.FormBack.ShippingPort;
            newApply005013.SHIPPINGPORT_TEXT = model.FormBack.ShippingPort_TEXT;
            newApply005013.APP_TYPE = model.FormBack.CSEE_TYPE;
            newApply005013.RADIOUSAGE = model.FormBack.RADIOUSAGE;
            newApply005013.RADIOUSAGE_TEXT = model.FormBack.RADIOUSAGE_TEXT;
            newApply005013.RADIOYN = model.FormBack.RADIOYN;

            Apply_FileModel newApplyFile1 = new Apply_FileModel();
            Apply_FileModel whereApplyFile1 = new Apply_FileModel();
            newApplyFile1.APP_ID = model.FormBack.APP_ID;
            whereApplyFile1.APP_ID = model.FormBack.APP_ID;
            whereApplyFile1.FILE_NO = 1;

            Apply_FileModel newApplyFile2 = new Apply_FileModel();
            Apply_FileModel whereApplyFile2 = new Apply_FileModel();
            newApplyFile2.APP_ID = model.FormBack.APP_ID;
            whereApplyFile2.APP_ID = model.FormBack.APP_ID;
            whereApplyFile2.FILE_NO = 2;

            Apply_FileModel newApplyFile3 = new Apply_FileModel();
            Apply_FileModel whereApplyFile3 = new Apply_FileModel();
            newApplyFile3.APP_ID = model.FormBack.APP_ID;
            whereApplyFile3.APP_ID = model.FormBack.APP_ID;
            whereApplyFile3.FILE_NO = 3;

            Apply_FileModel newApplyFile4 = new Apply_FileModel();
            Apply_FileModel whereApplyFile4 = new Apply_FileModel();
            newApplyFile4.APP_ID = model.FormBack.APP_ID;
            whereApplyFile4.APP_ID = model.FormBack.APP_ID;
            whereApplyFile4.FILE_NO = 4;

            Apply_FileModel newApplyFile5 = new Apply_FileModel();
            Apply_FileModel whereApplyFile5 = new Apply_FileModel();
            newApplyFile5.APP_ID = model.FormBack.APP_ID;
            whereApplyFile5.APP_ID = model.FormBack.APP_ID;
            whereApplyFile5.FILE_NO = 5;

            Apply_FileModel newApplyFile6 = new Apply_FileModel();
            Apply_FileModel whereApplyFile6 = new Apply_FileModel();
            newApplyFile6.APP_ID = model.FormBack.APP_ID;
            whereApplyFile6.APP_ID = model.FormBack.APP_ID;
            whereApplyFile6.FILE_NO = 6;

            newApply.UPD_TIME = DateTime.Now;
            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
            newApply005013.UPD_TIME = DateTime.Now;
            newApply005013.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

            //僅針對需補件欄位更新
            var t = model.Detail.GetType();
            PropertyInfo[] props = t.GetProperties();
            for (var i = 0; i < props.Length; i++)
            {
                if (props[i].PropertyType.IsGenericType && props[i].PropertyType.GetGenericTypeDefinition() == typeof(IList<>))
                {
                    //另外處理
                }
                else
                {
                    if (props[i].GetValue(model.Detail) != null && (props[i].GetValue(model.Detail)).ToString() != "False" && (props[i].GetValue(model.Detail)).ToString() != "True")
                    {
                        //地址(3欄位)
                        if (props[i].Name == "ADDR")
                        {
                            newApply.ADDR_CODE = model.FormBack.TAX_ORG_CITY_CODE;
                            newApply.ADDR = model.FormBack.TAX_ORG_CITY_TEXT + model.FormBack.TAX_ORG_CITY_DETAIL;
                            newApply.UPD_TIME = DateTime.Now;
                            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        //電話(3欄位)
                        else if (props[i].Name == "TEL")
                        {
                            newApply.TEL = model.FormBack.TEL_BEFORE + "-" + model.FormBack.TEL_AFTER + (string.IsNullOrEmpty(model.FormBack.TEL_Extension) ? "" : "#" + model.FormBack.TEL_Extension);
                            newApply.UPD_TIME = DateTime.Now;
                            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        //行動電話
                        else if (props[i].Name == "MOBILE")
                        {
                            newApply.MOBILE = model.FormBack.MOBILE;
                            newApply.UPD_TIME = DateTime.Now;
                            newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        //檔案上傳處理
                        else if (props[i].Name == "File_1_Name" || props[i].Name == "File_2_Name" || props[i].Name == "File_3_Name" || props[i].Name == "File_4_Name" || props[i].Name == "File_5_Name" || props[i].Name == "File_6_Name")
                        {
                            Apply_FileModel whereApplyFile = new Apply_FileModel();
                            whereApplyFile.APP_ID = model.FormBack.APP_ID;
                            whereApplyFile.FILE_NO = props[i].Name.Substring(4, 1).TOInt32();
                            if (base.GetRowList(whereApplyFile).Count > 0)
                            {
                                //update
                                if (props[i].Name == "File_1_Name")
                                {
                                    newApplyFile1.FILENAME = model.FormBack.newFile_1 == null ? null : dao.PutFile("005013", model.FormBack.newFile_1, "1");
                                    newApplyFile1.SRC_FILENAME = newApplyFile1.FILENAME == null ? null : model.FormBack.newFile_1.FileName;
                                    newApplyFile1.UPD_TIME = DateTime.Now;
                                    newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_2_Name")
                                {
                                    newApplyFile2.FILENAME = model.FormBack.newFile_2 == null ? null : dao.PutFile("005013", model.FormBack.newFile_2, "2");
                                    newApplyFile2.SRC_FILENAME = newApplyFile2.FILENAME == null ? null : model.FormBack.newFile_2.FileName;
                                    newApplyFile2.UPD_TIME = DateTime.Now;
                                    newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_3_Name")
                                {
                                    newApplyFile3.FILENAME = model.FormBack.newFile_3 == null ? null : dao.PutFile("005013", model.FormBack.newFile_3, "3");
                                    newApplyFile3.SRC_FILENAME = newApplyFile3.FILENAME == null ? null : model.FormBack.newFile_3.FileName;
                                    newApplyFile3.UPD_TIME = DateTime.Now;
                                    newApplyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_4_Name")
                                {
                                    newApplyFile4.FILENAME = model.FormBack.newFile_4 == null ? null : dao.PutFile("005013", model.FormBack.newFile_4, "4");
                                    newApplyFile4.SRC_FILENAME = newApplyFile4.FILENAME == null ? null : model.FormBack.newFile_4.FileName;
                                    newApplyFile4.UPD_TIME = DateTime.Now;
                                    newApplyFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_5_Name")
                                {
                                    newApplyFile5.FILENAME = model.FormBack.newFile_5 == null ? null : dao.PutFile("005013", model.FormBack.newFile_5, "5");
                                    newApplyFile5.SRC_FILENAME = newApplyFile5.FILENAME == null ? null : model.FormBack.newFile_5.FileName;
                                    newApplyFile5.UPD_TIME = DateTime.Now;
                                    newApplyFile5.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_6_Name")
                                {
                                    newApplyFile6.FILENAME = model.FormBack.newFile_6 == null ? null : dao.PutFile("005013", model.FormBack.newFile_6, "6");
                                    newApplyFile6.SRC_FILENAME = newApplyFile6.FILENAME == null ? null : model.FormBack.newFile_6.FileName;
                                    newApplyFile6.UPD_TIME = DateTime.Now;
                                    newApplyFile6.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                            }
                            else
                            {
                                //insert
                                if (props[i].Name == "File_1_Name")
                                {
                                    newApplyFile1.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile1.FILE_NO = 1;
                                    newApplyFile1.FILENAME = model.FormBack.newFile_1 == null ? null : dao.PutFile("005013", model.FormBack.newFile_1, "1");
                                    newApplyFile1.SRC_FILENAME = newApplyFile1.FILENAME == null ? null : model.FormBack.newFile_1.FileName;
                                    newApplyFile1.UPD_TIME = DateTime.Now;
                                    newApplyFile1.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile1.ADD_TIME = DateTime.Now;
                                    newApplyFile1.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_2_Name")
                                {
                                    newApplyFile2.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile2.FILE_NO = 2;
                                    newApplyFile2.FILENAME = model.FormBack.newFile_2 == null ? null : dao.PutFile("005013", model.FormBack.newFile_2, "2");
                                    newApplyFile2.SRC_FILENAME = newApplyFile2.FILENAME == null ? null : model.FormBack.newFile_2.FileName;
                                    newApplyFile2.UPD_TIME = DateTime.Now;
                                    newApplyFile2.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile2.ADD_TIME = DateTime.Now;
                                    newApplyFile2.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_3_Name")
                                {
                                    newApplyFile3.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile3.FILE_NO = 3;
                                    newApplyFile3.FILENAME = model.FormBack.newFile_3 == null ? null : dao.PutFile("005013", model.FormBack.newFile_3, "3");
                                    newApplyFile3.SRC_FILENAME = newApplyFile3.FILENAME == null ? null : model.FormBack.newFile_3.FileName;
                                    newApplyFile3.UPD_TIME = DateTime.Now;
                                    newApplyFile3.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile3.ADD_TIME = DateTime.Now;
                                    newApplyFile3.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_4_Name")
                                {
                                    newApplyFile4.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile4.FILE_NO = 4;
                                    newApplyFile4.FILENAME = model.FormBack.newFile_4 == null ? null : dao.PutFile("005013", model.FormBack.newFile_4, "4");
                                    newApplyFile4.SRC_FILENAME = newApplyFile4.FILENAME == null ? null : model.FormBack.newFile_4.FileName;
                                    newApplyFile4.UPD_TIME = DateTime.Now;
                                    newApplyFile4.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile4.ADD_TIME = DateTime.Now;
                                    newApplyFile4.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile4.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_5_Name")
                                {
                                    newApplyFile5.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile5.FILE_NO = 5;
                                    newApplyFile5.FILENAME = model.FormBack.newFile_5 == null ? null : dao.PutFile("005013", model.FormBack.newFile_5, "5");
                                    newApplyFile5.SRC_FILENAME = newApplyFile5.FILENAME == null ? null : model.FormBack.newFile_5.FileName;
                                    newApplyFile5.UPD_TIME = DateTime.Now;
                                    newApplyFile5.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile5.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile5.ADD_TIME = DateTime.Now;
                                    newApplyFile5.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile5.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                                else if (props[i].Name == "File_6_Name")
                                {
                                    newApplyFile6.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile6.FILE_NO = 6;
                                    newApplyFile6.FILENAME = model.FormBack.newFile_6 == null ? null : dao.PutFile("005013", model.FormBack.newFile_6, "6");
                                    newApplyFile6.SRC_FILENAME = newApplyFile6.FILENAME == null ? null : model.FormBack.newFile_6.FileName;
                                    newApplyFile6.UPD_TIME = DateTime.Now;
                                    newApplyFile6.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile6.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile6.ADD_TIME = DateTime.Now;
                                    newApplyFile6.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile6.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                }
                            }
                        }
                    }
                }
            }
            var result = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);

                    string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
                    string s_SRV_ID = "005013";
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.FormBack.APP_ID);
                    dict2.Add("SRV_ID", s_SRV_ID);
                    dict2.Add("LastMODTIME", LastMODTIME);

                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.FLOW_CD = "3";

                    base.Update2(newApply, whereApply, dict2);
                    base.Update2(newApply005013, whereApply005013, dict2);

                    if (newApplyFile1.UPD_TIME != null)
                    {
                        if (newApplyFile1.UPD_TIME == newApplyFile1.ADD_TIME)
                        {
                            base.Insert(newApplyFile1);
                        }
                        else
                        {
                            base.Update(newApplyFile1, whereApplyFile1);
                        }
                    }
                    if (newApplyFile2.UPD_TIME != null)
                    {
                        if (newApplyFile2.UPD_TIME == newApplyFile2.ADD_TIME)
                        {
                            base.Insert(newApplyFile2);
                        }
                        else
                        {
                            base.Update(newApplyFile2, whereApplyFile2);
                        }
                    }
                    if (newApplyFile3.UPD_TIME != null)
                    {
                        if (newApplyFile3.UPD_TIME == newApplyFile3.ADD_TIME)
                        {
                            base.Insert(newApplyFile3);
                        }
                        else
                        {
                            base.Update(newApplyFile3, whereApplyFile3);
                        }
                    }
                    if (newApplyFile4.UPD_TIME != null)
                    {
                        if (newApplyFile4.UPD_TIME == newApplyFile4.ADD_TIME)
                        {
                            base.Insert(newApplyFile4);
                        }
                        else
                        {
                            base.Update(newApplyFile4, whereApplyFile4);
                        }
                    }
                    if (newApplyFile5.UPD_TIME != null)
                    {
                        if (newApplyFile5.UPD_TIME == newApplyFile5.ADD_TIME)
                        {
                            base.Insert(newApplyFile5);
                        }
                        else
                        {
                            base.Update(newApplyFile5, whereApplyFile5);
                        }
                    }
                    if (newApplyFile6.UPD_TIME != null)
                    {
                        if (newApplyFile6.UPD_TIME == newApplyFile6.ADD_TIME)
                        {
                            base.Insert(newApplyFile6);
                        }
                        else
                        {
                            base.Update(newApplyFile6, whereApplyFile6);
                        }
                    }

                    //動態欄位更新(ApplyItem)
                    if (model.Detail.FormApply005013Item1 != null)
                    {
                        foreach (var item in model.FormBack.FormApply005013Item1)
                        {
                            APPLY_005013_ITEM1 whereApplyItem1 = new APPLY_005013_ITEM1();
                            APPLY_005013_ITEM1 newApplyItem1 = new APPLY_005013_ITEM1();
                            whereApplyItem1.APP_ID = model.FormBack.APP_ID;
                            whereApplyItem1.ITEMNUM = item.ItemNum;
                            newApplyItem1.APP_ID = model.FormBack.APP_ID;
                            newApplyItem1.COMMODITIES = item.Commodities;
                            newApplyItem1.COMMODMEMO = item.CommodMemo;
                            newApplyItem1.QTY = item.Qty;
                            newApplyItem1.SPEC = item.Spec;
                            newApplyItem1.UNIT = item.Unit;
                            newApplyItem1.UNIT_TEXT = item.Unit_TEXT.TONotNullString().Replace("::", "||");
                            newApplyItem1.UPD_TIME = DateTime.Now;
                            newApplyItem1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            newApplyItem1.COMMODTYPE = item.CommodType;
                            newApplyItem1.PORCTYPE = item.PorcType;
                            newApplyItem1.SPECQTY = item.SpecQty;
                            newApplyItem1.SPECUNIT = item.SpecUnit;
                            newApplyItem1.SPECUNIT_TEXT = item.SpecUnit_TEXT.TONotNullString().Replace("::", "||");

                            base.Update2(newApplyItem1, whereApplyItem1, dict2);

                            var item2 = model.FormBack.FormApply005013Item2[Convert.ToInt32(item.ItemNum) - 1];

                            APPLY_005013_ITEM2 whereApplyItem2 = new APPLY_005013_ITEM2();
                            APPLY_005013_ITEM2 newApplyItem2 = new APPLY_005013_ITEM2();
                            whereApplyItem2.APP_ID = model.FormBack.APP_ID;
                            whereApplyItem2.ITEMNUM = item.ItemNum;
                            newApplyItem2.APP_ID = model.FormBack.APP_ID;
                            newApplyItem2.ALLQTY = $"共{item2.ItemQty}{item2.ItemQtyUnit.Replace("::", "||")}，每{item2.ItemQtyUnit2.Replace("::", "||")}{item2.ItemSpecQty}{item2.ItemSpecQtyUnit.Replace("::", "||")}";
                            newApplyItem2.ITEMNAME = item2.ItemName;
                            newApplyItem2.USAGE = item2.Usage;
                            newApplyItem2.UPD_TIME = DateTime.Now;
                            newApplyItem2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            newApplyItem2.QTY = item.Qty;
                            newApplyItem2.UNIT = item.Unit;
                            newApplyItem2.SPECQTY = item.SpecQty;
                            newApplyItem2.SPECUNIT = item.SpecUnit;

                            base.Update2(newApplyItem2, whereApplyItem2, dict2);
                        }
                    }

                    //動態欄位更新(ApplyFile)
                    if (model.Detail.FormFile.ToCount() > 0)
                    {
                        var w = 7;
                        var q = 1;
                        var p = 1;
                        foreach (var item in model.FormFile)
                        {
                            Apply_FileModel whereApplyFile = new Apply_FileModel();
                            Apply_FileModel newApplyFile = new Apply_FileModel();
                            whereApplyFile.APP_ID = model.FormBack.APP_ID;
                            whereApplyFile.FILE_NO = w;
                            whereApplyFile.SRC_NO = p;
                            whereApplyFile.BATCH_INDEX = q;
                            var filedata = GetRow(whereApplyFile);
                            if (filedata.APP_ID == null)
                            {
                                if (item.newFile != null)
                                {
                                    newApplyFile.APP_ID = model.FormBack.APP_ID;
                                    newApplyFile.FILE_NO = w;
                                    newApplyFile.SRC_NO = p;
                                    newApplyFile.BATCH_INDEX = q;
                                    newApplyFile.FILENAME = dao.PutFile("011003", item.newFile, w.ToString());
                                    newApplyFile.SRC_FILENAME = item.FileName_TEXT;
                                    newApplyFile.ADD_TIME = DateTime.Now;
                                    newApplyFile.ADD_FUN_CD = "WEB-APPLY";
                                    newApplyFile.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile.UPD_TIME = DateTime.Now;
                                    newApplyFile.UPD_FUN_CD = "WEB-APPLY";
                                    newApplyFile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newApplyFile.DEL_MK = "N";

                                    base.Insert(newApplyFile);
                                }
                            }
                            else
                            {
                                if (item.newFile != null)
                                {
                                    Apply_FileModel newfile = new Apply_FileModel();
                                    newfile.InjectFrom(filedata);
                                    newApplyFile.FILE_NO = w;
                                    newApplyFile.SRC_NO = p;
                                    newApplyFile.BATCH_INDEX = q;
                                    newfile.APP_ID = model.FormBack.APP_ID;
                                    newfile.FILENAME = dao.PutFile("011003", item.newFile, w.ToString());
                                    newfile.SRC_FILENAME = item.FileName_TEXT;
                                    newfile.UPD_TIME = DateTime.Now;
                                    newfile.UPD_FUN_CD = "WEB-APPLY";
                                    newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    base.Update(newfile, whereApplyFile);
                                }
                            }
                            w++;
                            q++;
                        }
                    }

                    //Apply_Notice狀態更新
                    TblAPPLY_NOTICE applyNotice = new TblAPPLY_NOTICE();
                    applyNotice.APP_ID = model.FormBack.APP_ID;
                    applyNotice.ISADDYN = "Y";
                    TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
                    whereApplyNotice.APP_ID = model.FormBack.APP_ID;

                    base.Update(applyNotice, whereApplyNotice);

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FormBack.CODE_CD == "4")
                    {
                        newApply.FLOW_CD = "1";
                        newApply.APP_DISP_ACC = "";
                        newApply.APP_DISP_MK = "N";
                        newApply.PRO_ACC = "";
                        newApply.PRO_UNIT_CD = -1;
                        newApply.MOHW_CASE_NO = "";

                        base.Update2(newApply, whereApply, dict2);
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }
        #endregion

        #region Apply_005014 貨品進口專案申請
        /// <summary>
        /// 貨品進口專案申請
        /// </summary>
        /// <param name="model"></param>
        public void AppendApply005014(Apply_005014ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            var CaseNum = "005014";
            var APP_ID = GetApp_ID(CaseNum);
            model.Apply.APP_ID = APP_ID;
            ClamMember UserInfo = sm.UserInfo.Member;

            ShareDAO shareDao = new ShareDAO();
            IList<Tuple<string, string>> filenameList = new List<Tuple<string, string>>();
            if (model.UploadFiles != null)
            {
                for (int i = 0; i < model.UploadFiles.Count; i++)
                {
                    // 上傳實體檔案
                    var file = model.UploadFiles[i];
                    if (file != null)
                    {
                        string filename = shareDao.PutFile("005014", file, string.Format("{0:00}", i));
                        filenameList.Add(new Tuple<string, string>(filename, file.ContentType));
                    }
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);

                    ApplyModel NewApply = new ApplyModel();
                    NewApply.APP_ID = APP_ID;
                    NewApply.SRV_ID = CaseNum;
                    NewApply.SRC_SRV_ID = CaseNum;
                    NewApply.UNIT_CD = 7;
                    NewApply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    NewApply.IDN = model.Apply.IDN;
                    NewApply.NAME = model.Apply.NAME;
                    NewApply.CNT_NAME = model.Apply.CNT_NAME;
                    NewApply.CNT_TEL = model.Apply.CNT_TEL;
                    NewApply.MOBILE = model.Apply.MOBILE;
                    NewApply.TEL = model.Apply.TEL;
                    NewApply.ADDR_CODE = model.Apply.ADDR_CODE;
                    NewApply.ADDR = model.Apply.ADDR;
                    NewApply.FLOW_CD = model.Apply.FLOW_CD;
                    NewApply.PAY_POINT = "A";
                    NewApply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.APP_TIME = DateTime.Now;
                    NewApply.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    NewApply.APP_TIME = DateTime.Now;
                    NewApply.ADD_TIME = DateTime.Now;
                    NewApply.ADD_FUN_CD = "WEB-APPLY";
                    NewApply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.UPD_TIME = DateTime.Now;
                    NewApply.UPD_FUN_CD = "WEB-APPLY";
                    NewApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    NewApply.DEL_MK = "N";
                    NewApply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(NewApply);

                    Apply_005014 apply005014 = new Apply_005014();
                    apply005014.InjectFrom(model.Detail);
                    apply005014.APP_ID = APP_ID;
                    //apply005014.AFF2_AMOUNT = $"{model.Detail.AFF2_AMOUNT_NAME};{model.Detail.AFF2_AMOUNT}";

                    base.Insert(apply005014);

                    Apply_005014_REMARK apply005014Remark = new Apply_005014_REMARK();
                    apply005014Remark.InjectFrom(model.Detail.Remark);
                    apply005014Remark.APP_ID = APP_ID;
                    base.Insert(apply005014Remark);

                    var itemNum = 0;
                    // 申請項目
                    if (model.ApplyItems != null && model.ApplyItems.Count > 0)
                    {
                        itemNum = model.ApplyItems.Count;
                        for (int i = 0; i < model.ApplyItems.Count; i++)
                        {
                            var apritem = model.ApplyItems[i];
                            apritem.APP_ID = APP_ID;
                            apritem.ITEM = i + 1;
                            Apply_005014_Item item = (Apply_005014_Item)new Apply_005014_Item().InjectFrom(apritem);
                            base.Insert(item);
                        }
                    }
                    if (model.ApplyItems2 != null && model.ApplyItems2.Count > 0)
                    {
                        for (int i = 0; i < model.ApplyItems2.Count; i++)
                        {
                            var apritem = model.ApplyItems2[i];
                            apritem.APP_ID = APP_ID;
                            apritem.ITEM = itemNum + i + 1;
                            Apply_005014_Item item = (Apply_005014_Item)new Apply_005014_Item().InjectFrom(apritem);
                            base.Insert(item);
                        }
                    }

                    // 儲存上傳檔案資料
                    if (filenameList != null && filenameList.Count > 0)
                    {
                        DateTime now = DateTime.Now;
                        for (int i = 0; i < filenameList.Count; i++)
                        {
                            string filename = filenameList[i].Item1;
                            string mime = filenameList[i].Item2;

                            // 儲存檔案 
                            Apply_005014_FILE file014 = new Apply_005014_FILE();
                            file014.APP_ID = APP_ID;
                            file014.SRV_ID = CaseNum;
                            file014.FILE_ID = (i + 1).ToString();
                            file014.FILE_URL = filename;
                            file014.FILE_NAME = filename;
                            file014.MIME = mime;
                            file014.CREATE_DATE = now;
                            file014.DEL_MK = "N";

                            base.Insert(file014);
                        }
                    }
                    else
                    {
                        // 未上傳檔案
                        string filename = "__NONE__";
                        string mime = "empty";

                        // 儲存檔案 
                        Apply_005014_FILE file014 = new Apply_005014_FILE();
                        file014.APP_ID = APP_ID;
                        file014.SRV_ID = CaseNum;
                        file014.FILE_ID = "1";
                        file014.FILE_URL = filename;
                        file014.FILE_NAME = filename;
                        file014.MIME = mime;
                        file014.CREATE_DATE = DateTime.Now;
                        file014.DEL_MK = "N";

                        base.Insert(file014);
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 前台補件
        /// </summary>
        /// <param name="model"></param>
        public void Update_Apply005014Front(Apply_005014ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            var CaseNum = "005014";
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);

                    var apy = model.Apply;
                    ApplyModel apply = base.GetRow(new ApplyModel { APP_ID = model.Apply.APP_ID });
                    apply.FLOW_CD = apy.FLOW_CD;
                    apply.UPD_TIME = DateTime.Now;
                    apply.TEL = apy.TEL;
                    apply.CNT_NAME = apy.CNT_NAME;
                    apply.CNT_TEL = apy.CNT_TEL;
                    apply.NAME = apy.NAME;
                    apply.IDN = apy.IDN;
                    apply.MOBILE = apy.MOBILE;
                    apply.ADDR = apy.ADDR;
                    apply.ADDR_CODE = apy.ADDR_CODE;
                    apply.FLOW_CD = model.Apply.FLOW_CD;
                    apply.UPD_TIME = DateTime.Now;
                    base.Update(apply, new ApplyModel { APP_ID = model.Apply.APP_ID });

                    Dictionary<string, object> dict = new Dictionary<string, object>();
                    dict["APP_ID"] = model.Apply.APP_ID;
                    dict["SRV_ID"] = CaseNum;
                    dict["LastMODTIME"] = DateTime.Now.ToString("yyyyMMddHHmmss");

                    Apply_005014 apply005014 = new Apply_005014();
                    apply005014.InjectFrom(model.Detail);
                    //apply005014.AFF2_AMOUNT = $"{model.Detail.AFF2_AMOUNT_NAME};{model.Detail.AFF2_AMOUNT}";
                    base.Update2(apply005014, new Apply_005014 { APP_ID = model.Apply.APP_ID }, dict);

                    Apply_005014_REMARK apply005014Remark = new Apply_005014_REMARK();
                    apply005014Remark.InjectFrom(model.Detail.Remark);
                    apply005014Remark.APP_ID = model.Apply.APP_ID;
                    if (model.Detail.Remark.checkboxR1)
                    {
                        // 備註1 中藥用 清空 非中藥材用途
                        if (model.Detail.Remark.REMARK1_ITEM2 == "1")
                        {
                            apply005014Remark.REMARK1_ITEM2_COMMENT = string.Empty;
                        }
                    }
                    else
                    {
                        // 取消 勾選 備註1
                        apply005014Remark.REMARK1_ITEM1_COMMENT = string.Empty;
                        apply005014Remark.REMARK2 = string.Empty;
                        apply005014Remark.REMARK1_ITEM2_COMMENT = string.Empty;
                    }
                    if (model.Detail.Remark.checkboxR3)
                    {
                        // 備註3 
                        if (model.Detail.Remark.REMARK3_2 == "1")
                        {
                            //食品 REMARK3_2_COMMENT
                            apply005014Remark.REMARK3_3_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_4_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_5_COMMENT = string.Empty;
                        }
                        else if (model.Detail.Remark.REMARK3_2 == "2")
                        {
                            // 研發 REMARK3_3_COMMENT
                            apply005014Remark.REMARK3_2_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_4_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_5_COMMENT = string.Empty;
                        }
                        else if (model.Detail.Remark.REMARK3_2 == "3")
                        {
                            // 試製 REMARK3_4_COMMENT
                            apply005014Remark.REMARK3_2_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_3_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_5_COMMENT = string.Empty;
                        }
                        else if (model.Detail.Remark.REMARK3_2 == "4")
                        {
                            // 其他 REMARK3_5_COMMENT
                            apply005014Remark.REMARK3_2_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_3_COMMENT = string.Empty;
                            apply005014Remark.REMARK3_4_COMMENT = string.Empty;
                        }
                    }
                    else
                    {
                        // 取消 勾選 備註3
                        apply005014Remark.REMARK3_2 = string.Empty;
                        apply005014Remark.REMARK3_2_COMMENT = string.Empty;
                        apply005014Remark.REMARK3_3_COMMENT = string.Empty;
                        apply005014Remark.REMARK3_4_COMMENT = string.Empty;
                        apply005014Remark.REMARK3_5_COMMENT = string.Empty;
                    }

                    base.Update2(apply005014Remark, new Apply_005014_REMARK { APP_ID = model.Apply.APP_ID }, dict);

                    //申請項目全刪全增
                    Apply_005014_Item itemWhere = new Apply_005014_Item();
                    itemWhere.APP_ID = model.Apply.APP_ID;
                    base.Delete<Apply_005014_Item>(itemWhere);

                    var itemNum = 0;
                    // 申請項目
                    if (model.ApplyItems != null && model.ApplyItems.Count > 0)
                    {
                        for (int i = 0; i < model.ApplyItems.Count; i++)
                        {
                            var apritem = model.ApplyItems[i];
                            apritem.APP_ID = model.Apply.APP_ID;
                            apritem.ITEM = i + 1;
                            itemNum = apritem.ITEM.TOInt32();
                            Apply_005014_Item item = (Apply_005014_Item)new Apply_005014_Item().InjectFrom(apritem);
                            base.Insert<Apply_005014_Item>(item);
                        }
                    }
                    if (model.ApplyItems2 != null && model.ApplyItems2.Count > 0)
                    {
                        for (int i = 0; i < model.ApplyItems2.Count; i++)
                        {
                            var apritem = model.ApplyItems2[i];
                            apritem.APP_ID = model.Apply.APP_ID;
                            apritem.ITEM = itemNum + i + 1;
                            itemNum = apritem.ITEM.TOInt32();
                            Apply_005014_Item item = (Apply_005014_Item)new Apply_005014_Item().InjectFrom(apritem);
                            base.Insert<Apply_005014_Item>(item);
                        }
                    }

                    // 儲存上傳檔案資料
                    ShareDAO shareDao = new ShareDAO();
                    if (model.FileList != null && model.FileList.Count > 0)
                    {
                        DateTime now = DateTime.Now;
                        for (int i = 0; i < model.FileList.Count; i++)
                        {
                            var item = model.FileList[i];
                            if (!string.IsNullOrEmpty(item.FILE_E) && item.PostFile != null)  // 須補件
                            {
                                string fileUrl = shareDao.PutFile("005014", item.PostFile, string.Format("{0:00}", i + 1));
                                // 儲存檔案 
                                Apply_005014_FILE file014 = new Apply_005014_FILE();
                                file014.APP_ID = model.Apply.APP_ID;
                                file014.SRV_ID = CaseNum;
                                file014.FILE_NAME = fileUrl;
                                file014.FILE_URL = fileUrl;
                                file014.FILE_ID = (i + 1).ToString();
                                file014.MIME = item.PostFile.ContentType;
                                file014.CREATE_DATE = now;
                                file014.DEL_MK = "N";

                                base.Update(file014, new Apply_005014_FILE { APP_ID = model.Apply.APP_ID, FILE_ID = (i + 1).ToString() });
                            }
                        }
                    }
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        public void InsertApply_005014Notice(ES.Areas.BACKMIN.Models.Apply_005014ViewModel model)
        {
            if (model.ApplyNoticeList != null)
            {
                using (SqlConnection conn = DataUtils.GetConnection())
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    try
                    {
                        this.Tran(conn, tran);

                        string querySql = @"SELECT CONVERT(VARCHAR, ISNULL(MAX(FREQUENCY), 0)) FROM APPLY_NOTICE WHERE APP_ID=@APP_ID";
                        Dictionary<string, object> arg = new Dictionary<string, object>();
                        arg["APP_ID"] = model.Apply.APP_ID;
                        string maxval = base.GetSingleValue(querySql, arg);
                        int val = System.Convert.ToInt32(maxval);

                        val++;
                        foreach (var n in model.ApplyNoticeList)
                        {
                            n.FREQUENCY = val;
                            base.Insert(n);
                        }
                        tran.Commit();
                    }
                    catch (Exception ex)
                    {
                        logger.Error("InsertApply_005014Notice failed:" + ex.TONotNullString());
                        tran.Rollback();
                    }
                    finally
                    {
                        conn.Close();
                        conn.Dispose();
                    }
                }
            }
        }

        public void SendMail_005014(Apply_005014ViewModel model)
        {
            string MailBody = "<table align=\"left\" style=\"width:90%;\">";
            MailBody += " <tr><th align=\"left\">敬啟者:</th></tr>";
            MailBody += " <tr><td>貴公司申請貨品進口專案申請(案號：" + model.Apply.APP_ID + ")一案，「人民申請案線上申辦服務系統」已完成系統資料填答及上傳程序，將儘速辦理您的申請案件，謝謝。</td></tr>";
            MailBody += " <tr><td><br /></td></tr>";
            MailBody += " <tr><td>衛生福利部 中醫藥司</td></tr>";
            MailBody += "</table>";

            this.SendMail_New(model.Apply.NAME, model.Detail.EMAIL.TONotNullString().Replace("@0", "@"), model.Apply.APP_ID, "貨品進口專案申請", "005014", MailBody);
        }

        #endregion

        #region Apply_005003 WHO格式之產銷證明書(英文) 

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply005003(Apply_005003FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UsrMember = sm.UserInfo.Member;
            string s_SRV_ID = "005003";
            string s_FUN_CD1 = "WEB-APPLY";

            string APP_ID = GetApp_ID(s_SRV_ID);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);

                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.IDN = "";
                    where.UNIT_CD = 7;//7:中醫藥司	
                    where.FLOW_CD = "1";//新增案件
                    where.ACC_NO = UsrMember.ACC_NO.TONotNullString();
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.NAME = form.NAME;
                    where.CNT_NAME = form.CNT_NAME;
                    where.TEL = form.TEL_2.TONotNullString().ToTrim() == "" ? form.TEL_0 + "-" + form.TEL_1 : form.TEL_0 + "-" + form.TEL_1 + "#" + form.TEL_2;
                    where.FAX = form.FAX_2.TONotNullString().ToTrim() == "" ? form.FAX_0 + "-" + form.FAX_1 : form.FAX_0 + "-" + form.FAX_1 + "#" + form.FAX_2;
                    //where.FAX = form.FAX;
                    where.APP_TIME = DateTime.Now;
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAYAMOUNT;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);

                    //where.PRO_UNIT_CD = 7;//7:中醫藥司	
                    where.ADDR_CODE = UsrMember.TOWN_CD;
                    where.ADDR = UsrMember.ADDR;
                    where.IDN = UsrMember.IDN.TONotNullString();
                    where.LOGIN_TYPE = UsrMember.CARD_TYPE.TONotNullString();
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);
                    #endregion

                    #region Apply005003
                    Apply_005003Model app = new Apply_005003Model();
                    app.InjectFrom(form);
                    app.APP_ID = APP_ID;
                    app.COPIES = form.PAYCOUNT.TOInt32();
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = s_FUN_CD1;
                    app.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = s_FUN_CD1;
                    app.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    app.FILE_LICF = "1";
                    app.FILE_LICB = "2";
                    app.FILE_CHART = "3";

                    //if (app.F) newApply005001.Concentrate_CHECK = "Y";
                    base.Insert(app);
                    #endregion

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAYAMOUNT;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;
                    // pay.PAY_EXT_TIME = DateTime.Now;
                    pay.PAY_INC_TIME = DateTime.Now;
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);

                    #endregion

                    #region 上傳附件檔
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app.FILE_LICF, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_LICF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_LICF, app.FILE_LICF);
                        file.SRC_FILENAME = form.FILE_LICF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_LICB, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_LICB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_LICB, app.FILE_LICB);
                        file.SRC_FILENAME = form.FILE_LICB_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_CHART, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_CHART.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_CHART, app.FILE_CHART);
                        file.SRC_FILENAME = form.FILE_CHART_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        base.Insert(file);
                    }
                    #endregion

                    #region APPLY_005003_F11 (save)
                    form.F11.APP_ID = APP_ID;
                    foreach (var item in form.F11.GoodsList)
                    {
                        item.APP_ID = APP_ID;
                        item.ADD_TIME = DateTime.Now;
                        item.ADD_FUN_CD = s_FUN_CD1;
                        item.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        item.UPD_TIME = DateTime.Now;
                        item.UPD_FUN_CD = s_FUN_CD1;
                        item.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                    }
                    form.F11.SaveGoodsList("SRL_NO");
                    #endregion

                    #region APPLY_005003_IC
                    //使用逗號分隔
                    List<string> list_IC = null;
                    if (form.MF_ADDR != null) { list_IC = form.MF_ADDR.ToSplit('.').FirstOrDefault().ToSplit(',').ToList(); }
                    int irow = 0;
                    foreach (string str_COUNTRY in list_IC)
                    {
                        irow += 1;
                        Apply_005003_IcModel item = new Apply_005003_IcViewModel();
                        item.APP_ID = APP_ID;
                        item.SRL_NO = irow;
                        item.IMP_COUNTRY = str_COUNTRY ?? "";
                        item.DEL_MK = "N";
                        item.ADD_TIME = DateTime.Now;
                        item.ADD_FUN_CD = s_FUN_CD1;
                        item.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        item.UPD_TIME = DateTime.Now;
                        item.UPD_FUN_CD = s_FUN_CD1;
                        item.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        base.Insert(item);
                    }
                    //form.F11.SaveGoodsList("SRL_NO");
                    #endregion   

                    tran.Commit();
                    return APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply005003 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 查詢
        /// </summary>
        /// <param name="app_id"></param>
        /// <returns></returns>
        public Apply_005003AppDocModel QueryApply_005003(string app_id)
        {
            Apply_005003AppDocModel result = new Apply_005003AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object> { { "@APP_ID", app_id } };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select m.APP_ID,m.NAME,m.CNT_NAME,m.TEL,m.FAX
    ,m.PAY_A_FEE PAYAMOUNT
    ,m.FLOW_CD CODE_CD
    ,m.MOHW_CASE_NO,m.APP_TIME,m.APP_EXT_DATE,m.PAY_A_FEE
    ,m.PAY_METHOD

    ,m2.COPIES PAYCOUNT
    ,m2.EMAIL
    ,m2.MF_ADDR ,m2.F_1,m2.F_1_2,m2.F_1_3 ,m2.F_2A_1_NUM
    ,m2.F_2A_1_DATE
    ,m2.F_2A_2,m2.F_2A_3,m2.F_2A_4,m2.F_2A_5
    ,m2.F_2A_6_NAME,m2.F_2A_6_ADDR ,m2.F_2B_1_NAME,m2.F_2B_2_ADDR
    ,m2.F_2B_2,m2.F_2B_3 ,m2.F_2A_3_1_NAME ,m2.F_2A_3_2_ADDR
    ,m2.F_2A_3_3_REMARKS ,m2.F_3_0,m2.F_3_1,m2.F_3_2,m2.F_3_3
    ,m2.F_4 ,m2.COPIES,m2.ATTACH_1 
    ,m2.F_1_DF ,m2.F_1_1 ,m2.F_2A_6
    ,m2.F_2B_3_REMARKS ,m2.F_2A_1_WORD ,m2.F_2A_2_COMM,m2.F_2A_2_ADDR
    ,m2.MERGEYN
    /* ,m2.FILE_LICF,m2.FILE_LICB,m2.FILE_CHART*/

    ,aa.NAME ADMIN_NAME
    FROM APPLY m
    JOIN APPLY_005003 m2 on m2.APP_ID =m.APP_ID 
    LEFT JOIN ADMIN aa on aa.ACC_NO = m.PRO_ACC 
    WHERE m.APP_ID= @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_005003AppDocModel>(_sql, parameters);
                conn.Close();
                conn.Dispose();
            }
            return result;
        }

        /// <summary>
        /// 檔案查詢
        /// </summary>
        /// <param name="APP_ID"></param>
        /// <returns></returns>
        public Apply_005003AppDocModel GetFile_005003(string APP_ID)
        {
            Apply_005003AppDocModel result = new Apply_005003AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object> { { "@APP_ID", APP_ID } };
            DynamicParameters parameters = new DynamicParameters(dictionary);
            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_LICF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_LICB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_CHART_TEXT
    FROM APPLY app 
    where 1=1 
    and app.APP_ID = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_005003AppDocModel>(_sql, parameters);
                //result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }
            return result;
        }

        /// <summary>
        /// 歷程查詢
        /// </summary>
        /// <param name="app_id"></param>
        /// <returns></returns>
        public Apply_005003AppDocModel GetApplyNotice_005003(string app_id)
        {
            Apply_005003AppDocModel result = new Apply_005003AppDocModel();
            try
            {
                string _sql = @"DECLARE @ColumnGroup NVARCHAR(MAX), @PivotSQL NVARCHAR(MAX) 

                                    SELECT  @ColumnGroup=COALESCE(@ColumnGroup + ',' ,'' ) + QUOTENAME(Field) 
                                    FROM (
	                                        select Field,NOTE
	                                        from APPLY_NOTICE 
	                                        where APP_ID='" + app_id + @"' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID='" + app_id + @"' and ISADDYN='N')
	                                     ) T
                                    GROUP BY QUOTENAME(Field) 

                                    select @ColumnGroup =N'
                                                            SELECT *
                                                            FROM (
	                                                                select isnull(BATCH_INDEX,1) grp,Field,NOTE
	                                                                from APPLY_NOTICE 
	                                                                where APP_ID=''" + app_id + @"'' and FREQUENCY = (select max(FREQUENCY) from APPLY_NOTICE where APP_ID=''" + app_id + @"'' and ISADDYN=''N'')
                                                                 ) t 
                                                            PIVOT (
	                                                                MAX(NOTE) 
	                                                                FOR Field IN (' + @ColumnGroup + N')
                                                                   ) p;'

                                                            EXEC sp_executesql  @ColumnGroup";

                using (SqlConnection conn = DataUtils.GetConnection())
                {
                    conn.Open();
                    result = conn.QueryFirst<Apply_005003AppDocModel>(_sql);
                    conn.Close();
                    conn.Dispose();
                }
            }
            catch (Exception ex)
            {
                logger.Warn(ex.Message, ex);
                result = null;
            }
            return result;
        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public string AppendApplyDoc005003(Apply_005003ViewModel model)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = model.FormBack.APP_ID;

            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "005003";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            int iSRC_NO = 2; //補件由2開始

            //取得補件件數
            TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
            an.APP_ID = model.APP_ID;
            an.ISADDYN = "N"; //未補件送出
            IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
            // 只取回最後一次補件的次數
            var newandaata = from a in andatalist
                             orderby a.FREQUENCY descending
                             select a;
            // 取得補件次數 
            iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);
            var result = string.Empty;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);
                    ApplyModel whereApply = new ApplyModel();
                    whereApply.APP_ID = model.APP_ID;
                    ApplyModel newApply = new ApplyModel();
                    newApply.APP_ID = model.APP_ID;
                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_FUN_CD = s_FUN_CD1;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.FLOW_CD = "3";
                    Update2(newApply, whereApply, dict2);

                    Apply_005003Model app_SN_where = new Apply_005003Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    Apply_005003Model app_SN_data = new Apply_005003Model();
                    app_SN_data.InjectFrom(model.FormBack);
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(app_SN_data, app_SN_where, dict2);

                    if (!model.FormBack.FILE_LICF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FormBack.FILE_LICF, "1");
                        var FileList = file.FILENAME.ToSplit('\\');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FormBack.FILE_LICB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FormBack.FILE_LICB, "2");
                        var FileList = file.FILENAME.ToSplit('\\');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FormBack.FILE_CHART.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FormBack.FILE_CHART, "3");
                        var FileList = file.FILENAME.ToSplit('\\');
                        var FileName = FileList[FileList.ToCount() - 1];
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!string.IsNullOrEmpty(model.Detail.F11_CONTENT))
                    {
                        model.F11.APP_ID = model.FormBack.APP_ID;
                        foreach (var item in model.F11.GoodsList)
                        {
                            item.APP_ID = model.FormBack.APP_ID;
                            item.ADD_TIME = DateTime.Now;
                            item.ADD_FUN_CD = "WEB-APPLY";
                            item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.UPD_TIME = DateTime.Now;
                            item.UPD_FUN_CD = "WEB-APPLY";
                            item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            item.DEL_MK = "N";
                        }
                        model.F11.SaveGoodsList("SRL_NO");
                    }

                    //Apply_Notice狀態更新
                    TblAPPLY_NOTICE ANwhere = new TblAPPLY_NOTICE();
                    ANwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE ANdata = new TblAPPLY_NOTICE();
                    ANdata.APP_ID = model.APP_ID;
                    ANdata.ISADDYN = "Y";
                    Update2(ANdata, ANwhere, dict2);

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FormBack.CODE_CD == "4")
                    {
                        newApply.FLOW_CD = "1";
                        newApply.APP_DISP_ACC = "";
                        newApply.APP_DISP_MK = "N";
                        newApply.PRO_ACC = "";
                        newApply.PRO_UNIT_CD = -1;
                        newApply.MOHW_CASE_NO = "";
                        Update2(newApply, whereApply, dict2);
                    }
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    result = ex.ToString();
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        /// <summary>
        /// 更新案件-補件儲存
        /// </summary>
        /// <returns></returns>
        public string UpdateApply005003(Apply_005003AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string s_FUN_CD1 = "WEB-APPLY";
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "005003";

            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0;
            int iSRC_NO = 2; //補件由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                this.Tran(conn, tran);
                try
                {
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);

                    //TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    //an.APP_ID = model.APP_ID;
                    //an.ISADDYN = "N";
                    //var getan = GetRowList(an);
                    //var getan = 1;
                    //if (!string.IsNullOrEmpty(model.MAILBODY)) { getan = model.MAILBODY.splitHTML("<tr/>").ToCount(); }
                    //Count = getan - 1;

                    //更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update2(andata, anwhere, dict2);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = model.TEL;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    //appdata.UNIT_CD = 8; //社會救助及社工司-UNIT
                    appdata.FLOW_CD = "3";//1:新案收件3:補件收件
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(appdata, appwhere, dict2);
                    //儲存
                    //Update(appdata, appwhere);

                    Apply_005003Model app_SN_where = new Apply_005003Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_005003Model app_SN_data = new Apply_005003Model();
                    app_SN_data.InjectFrom(model);
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //app_SN_data.DEL_MK = "N";
                    app_SN_data.FILE_LICF = "1";
                    app_SN_data.FILE_LICB = "2";
                    app_SN_data.FILE_CHART = "3";
                    //儲存
                    //Update(app_SN_data, app_SN_where);
                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_LICF, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_LICF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_LICF, "1");
                        file.SRC_FILENAME = model.FILE_LICF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_LICB, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_LICB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_LICB, "2");
                        file.SRC_FILENAME = model.FILE_LICB_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_CHART, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_CHART.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_CHART, "3");
                        file.SRC_FILENAME = model.FILE_CHART_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }
                    #endregion

                    //Apply_Notice狀態更新
                    TblAPPLY_NOTICE ANwhere = new TblAPPLY_NOTICE();
                    ANwhere.APP_ID = model.APP_ID;

                    TblAPPLY_NOTICE ANdata = new TblAPPLY_NOTICE();
                    ANdata.APP_ID = model.APP_ID;
                    ANdata.ISADDYN = "Y";
                    Update2(ANdata, ANwhere, dict2);

                    //CODE_CD=4 申請案補件中 : 補件完成後須重新分案
                    if (model.FLOW_CD == "4")
                    {
                        appdata.FLOW_CD = "1";
                        appdata.APP_DISP_ACC = "";
                        appdata.APP_DISP_MK = "N";
                        appdata.PRO_ACC = "";
                        appdata.PRO_UNIT_CD = -1;
                        appdata.MOHW_CASE_NO = "";
                        Update2(appdata, appwhere, dict2);
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply005003 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }

        /// <summary>
        /// 介接
        /// </summary>
        /// <param name="data"></param>
        /// <returns></returns>
        public SALEAPI_Resp SortData005003(SALEAPI_Resp data)
        {
            DataTable result = new DataTable();
            //using (SqlConnection conn = DataUtils.GetConnection())
            //{
            //    try
            //    {
            //        string _sql = @"select DISTINCT (CITYNM + TOWNNM) CITY from ZIPCODE where ZIP_CO like '" + data.郵遞區號 + "%'";
            //        SqlCommand cmd = new SqlCommand(_sql, conn);
            //        SqlDataAdapter da = new SqlDataAdapter(cmd);
            //        da.Fill(result);
            //    }
            //    catch (Exception ex)
            //    {
            //        logger.Warn(ex.Message, ex);
            //        result = null;
            //    }
            //}

            //地址轉換
            //data.營業地址 = data.營業地址.Replace(result.Rows[0][0].ToString(), "");

            ////發證日期(轉民國)
            //if (!string.IsNullOrEmpty(data.發證日期))
            //{
            //    data.發證日期 = Convert.ToInt32(data.發證日期.Split('/')[0]) - 1911 + "/" +
            //                data.發證日期.Split('/')[1] + "/" +
            //                data.發證日期.Split('/')[2];
            //}

            //有效日期(轉民國)
            if (!string.IsNullOrEmpty(data.有效日期))
            {
                data.有效日期 = Convert.ToInt32(data.有效日期.Split('/')[0]) - 1911 + "/" +
                            data.有效日期.Split('/')[1] + "/" +
                            data.有效日期.Split('/')[2];
            }

            return data;
        }
        #endregion

        #region Apply_001039 醫師赴國外訓練英文保證函

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply001039(Apply_001039FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "001039";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.MOBILE = form.CONTACT_MOBILE.TONotNullString() != "" ? form.CONTACT_MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    where.UNIT_CD = 4;
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.IDN = form.PID;
                    where.SEX_CD = form.GENDER;
                    where.NAME = form.CNAME;
                    where.ENAME = form.ENAME;
                    where.BIRTHDAY = HelperUtil.TransToDateTime(form.BIRTHDAY_STR);
                    where.CNT_NAME = form.CONTACT_NAME;
                    where.CNT_TEL = form.CONTACT_TEL_0 + "-" + form.CONTACT_TEL_1 +
                                    (string.IsNullOrEmpty(form.CONTACT_TEL_2) ? "" : "#" + form.CONTACT_TEL_2);
                    where.APP_TIME = DateTime.Now;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.FLOW_CD = "1"; //新案收件
                    where.PAY_POINT = "A"; //不需要繳費
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    //// Insert 案件
                    Apply_001039Model apply = new Apply_001039Model();
                    apply.APP_ID = APP_ID;
                    apply.APPLY_DATE = DateTime.Now;
                    apply.CNAME = form.CNAME;
                    apply.PID = form.PID;
                    apply.ENAME = form.ENAME;
                    apply.GENDER = form.GENDER;
                    apply.ECFMG = form.ECFMG;
                    apply.BIRTHDAY = HelperUtil.TransToDateTime(form.BIRTHDAY_STR);
                    apply.HOSPITAL_DIVISION = form.HOSPITAL_DIVISION;
                    apply.COUNTRY = form.COUNTRY;
                    apply.CAUSE = form.CAUSE;
                    apply.MAIL_ADDRESS = form.MAIL_ADDRESS;
                    apply.CONTACT_NAME = form.CONTACT_NAME;
                    //apply.CONTACT_TEL = form.CONTACT_TEL_0.TONotNullString() + "-" + form.CONTACT_TEL_1.TONotNullString() + (form.CONTACT_TEL_2.TONotNullString() == "" ? "" : "#" + form.CONTACT_TEL_2.TONotNullString());
                    //apply.CONTACT_TEL_EXT = form.CONTACT_TEL_2;
                    apply.CONTACT_MOBILE = form.CONTACT_MOBILE;
                    apply.CONTACT_FAX = form.CONTACT_FAX_0.TONotNullString() + "-" + form.CONTACT_FAX_1.TONotNullString() + (form.CONTACT_FAX_2.TONotNullString() == "" ? "" : "#" + form.CONTACT_FAX_2.TONotNullString());
                    apply.CONTACT_FAX_EXT = form.CONTACT_FAX_2;
                    switch (form.E_MAIL_2)
                    {
                        case "1":
                            form.E_MAIL_2 = "@gmail.com";
                            break;
                        case "2":
                            form.E_MAIL_2 = "@yahoo.com.tw";
                            break;
                        case "3":
                            form.E_MAIL_2 = "@outlook.com";
                            break;
                        default:
                            form.E_MAIL_2 = "@" + form.E_MAIL_3;
                            break;
                    }
                    apply.E_MAIL = form.E_MAIL_1 + form.E_MAIL_2;
                    apply.IS_MERGE_FILE = form.IS_MERGE_FILE;
                    apply.ATTH1 = form.ATTH1;
                    apply.ATTH2 = form.ATTH2;
                    apply.ATTH3 = form.ATTH3;
                    apply.ATTH4 = form.ATTH4;
                    apply.ATTH5 = form.ATTH5;
                    apply.ATTH6 = form.ATTH6;
                    apply.ATTH7 = form.ATTH7;
                    apply.ATTH8 = form.ATTH8;
                    apply.ATTH9 = form.ATTH9;

                    base.Insert(apply);

                    //儲存上傳檔案
                    if (form.FILE0 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = APP_ID;
                        applyFile1.FILE_NO = 1;
                        applyFile1.FILENAME = dao.PutFile("001039", form.FILE0, "1");
                        applyFile1.SRC_FILENAME = form.FILE0_TEXT;
                        applyFile1.SRC_NO = 1;
                        applyFile1.DEL_MK = "N";
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile1);
                    }

                    if (form.FILE1 != null)
                    {
                        Apply_FileModel applyFile2 = new Apply_FileModel();
                        applyFile2.APP_ID = APP_ID;
                        applyFile2.FILE_NO = 2;
                        applyFile2.FILENAME = dao.PutFile("001039", form.FILE1, "2");
                        applyFile2.SRC_FILENAME = form.FILE1_TEXT;
                        applyFile2.SRC_NO = 2;
                        applyFile2.DEL_MK = "N";
                        applyFile2.ADD_TIME = DateTime.Now;
                        applyFile2.UPD_TIME = DateTime.Now;
                        applyFile2.UPD_FUN_CD = "WEB-APPLY";
                        applyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile2.ADD_TIME = DateTime.Now;
                        applyFile2.ADD_FUN_CD = "WEB-APPLY";
                        applyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile2);
                    }

                    if (form.FILE2 != null)
                    {
                        Apply_FileModel applyFile3 = new Apply_FileModel();
                        applyFile3.APP_ID = APP_ID;
                        applyFile3.FILE_NO = 3;
                        applyFile3.FILENAME = dao.PutFile("001039", form.FILE2, "3");
                        applyFile3.SRC_FILENAME = form.FILE2_TEXT;
                        applyFile3.SRC_NO = 3;
                        applyFile3.DEL_MK = "N";
                        applyFile3.ADD_TIME = DateTime.Now;
                        applyFile3.UPD_TIME = DateTime.Now;
                        applyFile3.UPD_FUN_CD = "WEB-APPLY";
                        applyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile3.ADD_TIME = DateTime.Now;
                        applyFile3.ADD_FUN_CD = "WEB-APPLY";
                        applyFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile3);
                    }

                    if (form.FILE3 != null)
                    {
                        Apply_FileModel applyFile4 = new Apply_FileModel();
                        applyFile4.APP_ID = APP_ID;
                        applyFile4.FILE_NO = 4;
                        applyFile4.FILENAME = dao.PutFile("001039", form.FILE3, "4");
                        applyFile4.SRC_FILENAME = form.FILE3_TEXT;
                        applyFile4.SRC_NO = 4;
                        applyFile4.DEL_MK = "N";
                        applyFile4.ADD_TIME = DateTime.Now;
                        applyFile4.UPD_TIME = DateTime.Now;
                        applyFile4.UPD_FUN_CD = "WEB-APPLY";
                        applyFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile4.ADD_TIME = DateTime.Now;
                        applyFile4.ADD_FUN_CD = "WEB-APPLY";
                        applyFile4.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile4);
                    }

                    if (form.FILE4 != null)
                    {
                        Apply_FileModel applyFile5 = new Apply_FileModel();
                        applyFile5.APP_ID = APP_ID;
                        applyFile5.FILE_NO = 5;
                        applyFile5.FILENAME = dao.PutFile("001039", form.FILE4, "5");
                        applyFile5.SRC_FILENAME = form.FILE4_TEXT;
                        applyFile5.SRC_NO = 5;
                        applyFile5.DEL_MK = "N";
                        applyFile5.ADD_TIME = DateTime.Now;
                        applyFile5.UPD_TIME = DateTime.Now;
                        applyFile5.UPD_FUN_CD = "WEB-APPLY";
                        applyFile5.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile5.ADD_TIME = DateTime.Now;
                        applyFile5.ADD_FUN_CD = "WEB-APPLY";
                        applyFile5.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile5);
                    }

                    if (form.FILE5 != null)
                    {
                        Apply_FileModel applyFile6 = new Apply_FileModel();
                        applyFile6.APP_ID = APP_ID;
                        applyFile6.FILE_NO = 6;
                        applyFile6.FILENAME = dao.PutFile("001039", form.FILE5, "6");
                        applyFile6.SRC_FILENAME = form.FILE5_TEXT;
                        applyFile6.SRC_NO = 6;
                        applyFile6.DEL_MK = "N";
                        applyFile6.ADD_TIME = DateTime.Now;
                        applyFile6.UPD_TIME = DateTime.Now;
                        applyFile6.UPD_FUN_CD = "WEB-APPLY";
                        applyFile6.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile6.ADD_TIME = DateTime.Now;
                        applyFile6.ADD_FUN_CD = "WEB-APPLY";
                        applyFile6.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile6);
                    }

                    if (form.FILE6 != null)
                    {
                        Apply_FileModel applyFile7 = new Apply_FileModel();
                        applyFile7.APP_ID = APP_ID;
                        applyFile7.FILE_NO = 7;
                        applyFile7.FILENAME = dao.PutFile("001039", form.FILE6, "7");
                        applyFile7.SRC_FILENAME = form.FILE6_TEXT;
                        applyFile7.SRC_NO = 7;
                        applyFile7.DEL_MK = "N";
                        applyFile7.ADD_TIME = DateTime.Now;
                        applyFile7.UPD_TIME = DateTime.Now;
                        applyFile7.UPD_FUN_CD = "WEB-APPLY";
                        applyFile7.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile7.ADD_TIME = DateTime.Now;
                        applyFile7.ADD_FUN_CD = "WEB-APPLY";
                        applyFile7.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile7);
                    }

                    if (form.FILE7 != null)
                    {
                        Apply_FileModel applyFile8 = new Apply_FileModel();
                        applyFile8.APP_ID = APP_ID;
                        applyFile8.FILE_NO = 8;
                        applyFile8.FILENAME = dao.PutFile("001039", form.FILE7, "8");
                        applyFile8.SRC_FILENAME = form.FILE7_TEXT;
                        applyFile8.SRC_NO = 8;
                        applyFile8.DEL_MK = "N";
                        applyFile8.ADD_TIME = DateTime.Now;
                        applyFile8.UPD_TIME = DateTime.Now;
                        applyFile8.UPD_FUN_CD = "WEB-APPLY";
                        applyFile8.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile8.ADD_TIME = DateTime.Now;
                        applyFile8.ADD_FUN_CD = "WEB-APPLY";
                        applyFile8.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile8);
                    }

                    if (form.FILE8 != null)
                    {
                        Apply_FileModel applyFile9 = new Apply_FileModel();
                        applyFile9.APP_ID = APP_ID;
                        applyFile9.FILE_NO = 9;
                        applyFile9.FILENAME = dao.PutFile("001039", form.FILE8, "9");
                        applyFile9.SRC_FILENAME = form.FILE8_TEXT;
                        applyFile9.SRC_NO = 9;
                        applyFile9.DEL_MK = "N";
                        applyFile9.ADD_TIME = DateTime.Now;
                        applyFile9.UPD_TIME = DateTime.Now;
                        applyFile9.UPD_FUN_CD = "WEB-APPLY";
                        applyFile9.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile9.ADD_TIME = DateTime.Now;
                        applyFile9.ADD_FUN_CD = "WEB-APPLY";
                        applyFile9.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile9);
                    }

                    if (form.FILE9 != null)
                    {
                        Apply_FileModel applyFile10 = new Apply_FileModel();
                        applyFile10.APP_ID = APP_ID;
                        applyFile10.FILE_NO = 10;
                        applyFile10.FILENAME = dao.PutFile("001039", form.FILE9, "10");
                        applyFile10.SRC_FILENAME = form.FILE9_TEXT;
                        applyFile10.SRC_NO = 10;
                        applyFile10.DEL_MK = "N";
                        applyFile10.ADD_TIME = DateTime.Now;
                        applyFile10.UPD_TIME = DateTime.Now;
                        applyFile10.UPD_FUN_CD = "WEB-APPLY";
                        applyFile10.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile10.ADD_TIME = DateTime.Now;
                        applyFile10.ADD_FUN_CD = "WEB-APPLY";
                        applyFile10.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile10);
                    }

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "醫師赴國外訓練英文保證函申請，案件編號﹕" + APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += form.CNAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + form.APPLY_DATE_STR.Substring(0, 3) + "年" + form.APPLY_DATE_STR.Substring(4, 2) + "月" + form.APPLY_DATE_STR.Substring(7, 2) + "日申辦之醫師赴國外訓練英文保證函申請<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001039/AppDoc?APP_ID=" + APP_ID + "'>" + APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(form.E_MAIL_1 + form.E_MAIL_2, subject, MailBody);

                    tran.Commit();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply001039 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001039AppDocModel GetFile_001039(string APP_ID)
        {
            var result = new Apply_001039AppDocModel();


            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select 
                                (SUBSTRING(fl1.FILENAME, 16,len(fl1.FILENAME))+','+ convert(varchar,fl1.APP_ID)+','+convert(varchar,fl1.FILE_NO)+','+isnull(convert(varchar,fl1.SRC_NO),'0')) as File0_TEXT,
                                (SUBSTRING(fl2.FILENAME, 16,len(fl2.FILENAME))+','+ convert(varchar,fl2.APP_ID)+','+convert(varchar,fl2.FILE_NO)+','+isnull(convert(varchar,fl2.SRC_NO),'0')) as File1_TEXT,
                                (SUBSTRING(fl3.FILENAME, 16,len(fl3.FILENAME))+','+ convert(varchar,fl3.APP_ID)+','+convert(varchar,fl3.FILE_NO)+','+isnull(convert(varchar,fl3.SRC_NO),'0')) as File2_TEXT,
                                (SUBSTRING(fl4.FILENAME, 16,len(fl4.FILENAME))+','+ convert(varchar,fl4.APP_ID)+','+convert(varchar,fl4.FILE_NO)+','+isnull(convert(varchar,fl4.SRC_NO),'0')) as File3_TEXT,     
								(SUBSTRING(fl5.FILENAME, 16,len(fl5.FILENAME))+','+ convert(varchar,fl5.APP_ID)+','+convert(varchar,fl5.FILE_NO)+','+isnull(convert(varchar,fl5.SRC_NO),'0')) as File4_TEXT,  
								(SUBSTRING(fl6.FILENAME, 16,len(fl6.FILENAME))+','+ convert(varchar,fl6.APP_ID)+','+convert(varchar,fl6.FILE_NO)+','+isnull(convert(varchar,fl6.SRC_NO),'0')) as File5_TEXT,  
								(SUBSTRING(fl7.FILENAME, 16,len(fl7.FILENAME))+','+ convert(varchar,fl7.APP_ID)+','+convert(varchar,fl7.FILE_NO)+','+isnull(convert(varchar,fl7.SRC_NO),'0')) as File6_TEXT,  
								(SUBSTRING(fl8.FILENAME, 16,len(fl8.FILENAME))+','+ convert(varchar,fl8.APP_ID)+','+convert(varchar,fl8.FILE_NO)+','+isnull(convert(varchar,fl8.SRC_NO),'0')) as File7_TEXT,  
							    (SUBSTRING(fl9.FILENAME, 16,len(fl9.FILENAME))+','+ convert(varchar,fl9.APP_ID)+','+convert(varchar,fl9.FILE_NO)+','+isnull(convert(varchar,fl9.SRC_NO),'0')) as File8_TEXT,
                                (SUBSTRING(fl10.FILENAME, 16,len(fl10.FILENAME))+','+ convert(varchar,fl10.APP_ID)+','+convert(varchar,fl10.FILE_NO)+','+isnull(convert(varchar,fl10.SRC_NO),'0')) as File9_TEXT
                                from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '2' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl2 on app.APP_ID = fl2.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '3' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl3 on app.APP_ID = fl3.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '4' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl4 on app.APP_ID = fl4.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '5' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl5 on app.APP_ID = fl5.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '6' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl6 on app.APP_ID = fl6.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '7' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl7 on app.APP_ID = fl7.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '8' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl8 on app.APP_ID = fl8.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '9' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl9 on app.APP_ID = fl9.APP_ID";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '10' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl10 on app.APP_ID = fl10.APP_ID";
                _sql += " where 1 = 1";
                _sql += " and app.app_id = '" + APP_ID + "'";

                try
                {
                    result = conn.QueryFirst<Apply_001039AppDocModel>(_sql);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 案件補件儲存
        /// </summary>
        /// <returns></returns>
        public string UpdateApply001039(Apply_001039AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001039");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    // 取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N";
                    var getan = GetRowList(an);
                    Count = getan.ToCount();

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.APP_ID = model.APP_ID;
                    appdata.APP_TIME = null;
                    appdata.IDN = model.PID;
                    appdata.SEX_CD = model.GENDER;
                    appdata.NAME = model.CNAME;
                    appdata.ENAME = model.ENAME;
                    appdata.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_STR);
                    appdata.CNT_NAME = model.CONTACT_NAME;
                    if (!string.IsNullOrEmpty(model.CONTACT_TEL_0) && !string.IsNullOrEmpty(model.CONTACT_TEL_1))
                    {
                        appdata.CNT_TEL = !string.IsNullOrEmpty(model.CONTACT_TEL_2) ? model.CONTACT_TEL_0.TONotNullString() + "-" + model.CONTACT_TEL_1.TONotNullString() + "#" + model.CONTACT_TEL_2.TONotNullString() : model.CONTACT_TEL_0.TONotNullString() + "-" + model.CONTACT_TEL_1.TONotNullString();
                    }
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    appdata.FLOW_CD = "3"; //補件收件
                    //Update(appdata, appwhere);
                    Update2(appdata, appwhere, dict2);
                    Apply_001039Model where001039 = new Apply_001039Model();
                    where001039.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_001039Model data001039 = new Apply_001039Model();
                    data001039.InjectFrom(model);
                    data001039.APP_ID = model.APP_ID;
                    data001039.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_STR);
                    //if (!string.IsNullOrEmpty(model.CONTACT_TEL_0) && !string.IsNullOrEmpty(model.CONTACT_TEL_1))
                    //{
                    //    data001039.CONTACT_TEL = !string.IsNullOrEmpty(model.CONTACT_TEL_2) ? model.CONTACT_TEL_0.TONotNullString() + "-" + model.CONTACT_TEL_1.TONotNullString() + "#" + model.CONTACT_TEL_2.TONotNullString() : model.CONTACT_TEL_0.TONotNullString() + "-" + model.CONTACT_TEL_1.TONotNullString();
                    //    data001039.CONTACT_TEL_EXT = model.CONTACT_TEL_2;
                    //}
                    if (!string.IsNullOrEmpty(model.CONTACT_FAX_0) && !string.IsNullOrEmpty(model.CONTACT_FAX_1))
                    {
                        data001039.CONTACT_FAX = !string.IsNullOrEmpty(model.CONTACT_FAX_2) ? model.CONTACT_FAX_0.TONotNullString() + "-" + model.CONTACT_FAX_1.TONotNullString() + "#" + model.CONTACT_FAX_2.TONotNullString() : model.CONTACT_FAX_0.TONotNullString() + "-" + model.CONTACT_FAX_1.TONotNullString();
                        data001039.CONTACT_FAX_EXT = model.CONTACT_FAX_2;
                    }
                    switch (model.E_MAIL_2)
                    {
                        case "1":
                            model.E_MAIL_2 = "@gmail.com";
                            break;
                        case "2":
                            model.E_MAIL_2 = "@yahoo.com.tw";
                            break;
                        case "3":
                            model.E_MAIL_2 = "@outlook.com";
                            break;
                        default:
                            model.E_MAIL_2 = "@" + model.E_MAIL_3;
                            break;
                    }
                    data001039.E_MAIL = model.E_MAIL_1 + model.E_MAIL_2;
                    data001039.IS_MERGE_FILE = model.IS_MERGE_FILE;
                    data001039.ATTH1 = model.FILE0_TEXT;
                    data001039.ATTH2 = model.FILE1_TEXT;
                    data001039.ATTH3 = model.FILE2_TEXT;
                    data001039.ATTH4 = model.FILE3_TEXT;
                    data001039.ATTH5 = model.FILE4_TEXT;
                    data001039.ATTH6 = model.FILE5_TEXT;
                    data001039.ATTH7 = model.FILE6_TEXT;
                    data001039.ATTH8 = model.FILE7_TEXT;
                    data001039.ATTH9 = model.FILE8_TEXT;
                    data001039.ATTH10 = model.FILE9_TEXT;
                    //Update(data001039, where001039);
                    Update2(data001039, where001039, dict2);
                    #region 檔案上傳

                    //更新上傳檔案
                    if (model.FILE0 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = model.APP_ID;
                        applyFile1.FILE_NO = 1;
                        applyFile1.FILENAME = dao.PutFile("001039", model.FILE0, "1");
                        applyFile1.SRC_FILENAME = model.FILE0_TEXT;
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.DEL_MK = "N";
                        Insert(applyFile1);
                    }

                    if (model.FILE1 != null)
                    {
                        Apply_FileModel applyFile2 = new Apply_FileModel();
                        applyFile2.APP_ID = model.APP_ID;
                        applyFile2.FILE_NO = 2;
                        applyFile2.FILENAME = dao.PutFile("001039", model.FILE1, "2");
                        applyFile2.SRC_FILENAME = model.FILE1_TEXT;
                        applyFile2.ADD_TIME = DateTime.Now;
                        applyFile2.ADD_FUN_CD = "WEB-APPLY";
                        applyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile2.UPD_TIME = DateTime.Now;
                        applyFile2.UPD_FUN_CD = "WEB-APPLY";
                        applyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile2.DEL_MK = "N";
                        Insert(applyFile2);
                    }

                    if (model.FILE2 != null)
                    {
                        Apply_FileModel applyFile3 = new Apply_FileModel();
                        applyFile3.APP_ID = model.APP_ID;
                        applyFile3.FILE_NO = 3;
                        applyFile3.FILENAME = dao.PutFile("001039", model.FILE2, "3");
                        applyFile3.SRC_FILENAME = model.FILE2_TEXT;
                        applyFile3.ADD_TIME = DateTime.Now;
                        applyFile3.ADD_FUN_CD = "WEB-APPLY";
                        applyFile3.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile3.UPD_TIME = DateTime.Now;
                        applyFile3.UPD_FUN_CD = "WEB-APPLY";
                        applyFile3.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile3.DEL_MK = "N";
                        Insert(applyFile3);
                    }

                    if (model.FILE3 != null)
                    {
                        Apply_FileModel applyFile4 = new Apply_FileModel();
                        applyFile4.APP_ID = model.APP_ID;
                        applyFile4.FILE_NO = 4;
                        applyFile4.FILENAME = dao.PutFile("001039", model.FILE3, "4");
                        applyFile4.SRC_FILENAME = model.FILE3_TEXT;
                        applyFile4.ADD_TIME = DateTime.Now;
                        applyFile4.ADD_FUN_CD = "WEB-APPLY";
                        applyFile4.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile4.UPD_TIME = DateTime.Now;
                        applyFile4.UPD_FUN_CD = "WEB-APPLY";
                        applyFile4.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile4.DEL_MK = "N";
                        Insert(applyFile4);
                    }

                    if (model.FILE4 != null)
                    {
                        Apply_FileModel applyFile5 = new Apply_FileModel();
                        applyFile5.APP_ID = model.APP_ID;
                        applyFile5.FILE_NO = 5;
                        applyFile5.FILENAME = dao.PutFile("001039", model.FILE4, "5");
                        applyFile5.SRC_FILENAME = model.FILE4_TEXT;
                        applyFile5.ADD_TIME = DateTime.Now;
                        applyFile5.ADD_FUN_CD = "WEB-APPLY";
                        applyFile5.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile5.UPD_TIME = DateTime.Now;
                        applyFile5.UPD_FUN_CD = "WEB-APPLY";
                        applyFile5.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile5.DEL_MK = "N";
                        Insert(applyFile5);
                    }

                    if (model.FILE5 != null)
                    {
                        Apply_FileModel applyFile6 = new Apply_FileModel();
                        applyFile6.APP_ID = model.APP_ID;
                        applyFile6.FILE_NO = 6;
                        applyFile6.FILENAME = dao.PutFile("001039", model.FILE5, "6");
                        applyFile6.SRC_FILENAME = model.FILE5_TEXT;
                        applyFile6.ADD_TIME = DateTime.Now;
                        applyFile6.ADD_FUN_CD = "WEB-APPLY";
                        applyFile6.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile6.UPD_TIME = DateTime.Now;
                        applyFile6.UPD_FUN_CD = "WEB-APPLY";
                        applyFile6.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile6.DEL_MK = "N";
                        Insert(applyFile6);
                    }

                    if (model.FILE6 != null)
                    {
                        Apply_FileModel applyFile7 = new Apply_FileModel();
                        applyFile7.APP_ID = model.APP_ID;
                        applyFile7.FILE_NO = 7;
                        applyFile7.FILENAME = dao.PutFile("001039", model.FILE6, "7");
                        applyFile7.SRC_FILENAME = model.FILE6_TEXT;
                        applyFile7.ADD_TIME = DateTime.Now;
                        applyFile7.ADD_FUN_CD = "WEB-APPLY";
                        applyFile7.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile7.UPD_TIME = DateTime.Now;
                        applyFile7.UPD_FUN_CD = "WEB-APPLY";
                        applyFile7.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile7.DEL_MK = "N";
                        Insert(applyFile7);
                    }

                    if (model.FILE7 != null)
                    {
                        Apply_FileModel applyFile8 = new Apply_FileModel();
                        applyFile8.APP_ID = model.APP_ID;
                        applyFile8.FILE_NO = 8;
                        applyFile8.FILENAME = dao.PutFile("001039", model.FILE7, "8");
                        applyFile8.SRC_FILENAME = model.FILE7_TEXT;
                        applyFile8.ADD_TIME = DateTime.Now;
                        applyFile8.ADD_FUN_CD = "WEB-APPLY";
                        applyFile8.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile8.UPD_TIME = DateTime.Now;
                        applyFile8.UPD_FUN_CD = "WEB-APPLY";
                        applyFile8.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile8.DEL_MK = "N";
                        Insert(applyFile8);
                    }

                    if (model.FILE8 != null)
                    {
                        Apply_FileModel applyFile9 = new Apply_FileModel();
                        applyFile9.APP_ID = model.APP_ID;
                        applyFile9.FILE_NO = 9;
                        applyFile9.FILENAME = dao.PutFile("001039", model.FILE8, "9");
                        applyFile9.SRC_FILENAME = model.FILE8_TEXT;
                        applyFile9.ADD_TIME = DateTime.Now;
                        applyFile9.ADD_FUN_CD = "WEB-APPLY";
                        applyFile9.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile9.UPD_TIME = DateTime.Now;
                        applyFile9.UPD_FUN_CD = "WEB-APPLY";
                        applyFile9.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile9.DEL_MK = "N";
                        Insert(applyFile9);
                    }

                    if (model.FILE9 != null)
                    {
                        Apply_FileModel applyFile10 = new Apply_FileModel();
                        applyFile10.APP_ID = model.APP_ID;
                        applyFile10.FILE_NO = 10;
                        applyFile10.FILENAME = dao.PutFile("001039", model.FILE9, "10");
                        applyFile10.SRC_FILENAME = model.FILE9_TEXT;
                        applyFile10.ADD_TIME = DateTime.Now;
                        applyFile10.ADD_FUN_CD = "WEB-APPLY";
                        applyFile10.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile10.UPD_TIME = DateTime.Now;
                        applyFile10.UPD_FUN_CD = "WEB-APPLY";
                        applyFile10.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile10.DEL_MK = "N";
                        Insert(applyFile10);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply001039 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }

        #endregion

        #region Apply_011004 社工師證書核發（英文）

        public string ChkApply011004(Apply_011004FormModel form)
        {
            string Msg = "";
            if (string.IsNullOrWhiteSpace(form.MOBILE) && string.IsNullOrWhiteSpace(form.H_TEL) && string.IsNullOrWhiteSpace(form.C_TEL))
            {
                Msg += "電話(公)、電話(宅)、行動電話請擇一填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.FILE_0_TEXT))
            {
                Msg += "請上傳附件\n";
            }
            if (!string.IsNullOrEmpty(form.FILE_0_TEXT))
            {
                logger.Debug("Apply_011004.FileName:" + form.FILE_0_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_0_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply011004(Apply_011004FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011004";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;// 社救司
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.BIRTHDAY = HelperUtil.TransToDateTime(form.BIRTHDAY_STR);
                    where.CNT_TEL = form.C_TEL;
                    where.MOBILE = form.MOBILE;
                    where.APP_TIME = DateTime.Now;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011004");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011004");
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.FLOW_CD = "1"; //新案收件
                    where.PAY_POINT = "A"; //不需要繳費
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    //// Insert 案件
                    TblAPPLY_011004 apply = new TblAPPLY_011004();
                    apply.InjectFrom(form);
                    apply.APP_ID = APP_ID;
                    apply.EMAIL = form.EMAIL;
                    apply.C_TEL = form.C_TEL;
                    apply.H_TEL = form.H_TEL;
                    apply.MOBILE = form.MOBILE;
                    apply.C_ZIP = form.C_ZIPCODE;
                    apply.C_ADDR = form.C_ADDR;
                    apply.APPLY_FOR = form.APPLY_FOR;
                    apply.APPLY_NUM = form.APPLY_NUM;
                    apply.YEAR = form.TYEAR;
                    apply.TYPE = form.TYPE;
                    apply.FILE_NAME = form.FILE_0_TEXT;
                    apply.IS_MERGE = "N";
                    base.Insert(apply);

                    #region 繳費資訊
                    //APPLY_PAY appay = new APPLY_PAY();
                    //appay.APP_ID = APP_ID;
                    //appay.PAY_ID = APP_ID;
                    //appay.PAY_MONEY = 0;
                    //appay.PAY_PROFEE = 0;
                    //appay.PAY_ACT_TIME = DateTime.Now;
                    //appay.PAY_STATUS_MK = "N";
                    //appay.UPD_TIME = DateTime.Now;
                    //appay.UPD_FUN_CD = "WEB-APPLY";
                    //appay.UPD_ACC = form.IDN;
                    //appay.ADD_TIME = DateTime.Now;
                    //appay.ADD_FUN_CD = "WEB-APPLY";
                    //appay.ADD_ACC = form.IDN;
                    //base.Insert(appay);
                    #endregion

                    //儲存上傳檔案
                    if (form.FILE_0 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = APP_ID;
                        applyFile1.FILE_NO = 1;
                        applyFile1.FILENAME = dao.PutFile("011004", form.FILE_0, "1");
                        applyFile1.SRC_FILENAME = form.FILE_0_TEXT;
                        applyFile1.SRC_NO = 1;
                        applyFile1.DEL_MK = "N";
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Insert(applyFile1);
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011004 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011004AppDocModel GetFile_011004(string APP_ID)
        {
            var result = new Apply_011004AppDocModel();
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select 
                                (SUBSTRING(FILENAME,16,len(fl1.FILENAME))+','+ convert(varchar,fl1.APP_ID)+','+convert(varchar,fl1.FILE_NO)+','+isnull(convert(varchar,fl1.SRC_NO),'0')) as FILE_0_TEXT
                                from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = '" + APP_ID + "' order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += "   where 1 = 1";
                _sql += "and app.app_id = '" + APP_ID + "'";
                try
                {
                    result = conn.QueryFirst<Apply_011004AppDocModel>(_sql);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return result;
        }

        /// <summary>
        /// 案件補件儲存
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011004(Apply_011004AppDocModel model)
        {
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "011004");
            dict2.Add("LastMODTIME", LastMODTIME);
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // 取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N";
                    var getan = GetRowList(an);
                    Count = getan.ToCount();

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    #region UpdateApply
                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.CNT_TEL = model.C_TEL.TONotNullString();
                    appdata.MOBILE = model.MOBILE.TONotNullString();
                    appdata.APP_ID = model.APP_ID;
                    appdata.IDN = model.IDN;
                    appdata.SEX_CD = model.SEX_CD;
                    appdata.NAME = model.NAME;
                    appdata.ENAME = model.ENAME;
                    appdata.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_STR);
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    appdata.FLOW_CD = "3"; //補件收件
                    //Update(appdata, appwhere);
                    base.Update2(appdata, appwhere, dict2);

                    TblAPPLY_011004 where011004 = new TblAPPLY_011004();
                    where011004.APP_ID = model.APP_ID;
                    // Update 案件
                    TblAPPLY_011004 data011004 = new TblAPPLY_011004();
                    data011004.InjectFrom(model);
                    data011004.APP_ID = model.APP_ID;
                    data011004.EMAIL = model.EMAIL;
                    data011004.C_TEL = model.C_TEL.TONotNullString();
                    data011004.H_TEL = model.H_TEL.TONotNullString();
                    data011004.MOBILE = model.MOBILE.TONotNullString();
                    data011004.C_ZIP = model.C_ZIPCODE;
                    data011004.C_ADDR = model.C_ADDR;
                    data011004.APPLY_FOR = model.APPLY_FOR;
                    data011004.APPLY_NUM = model.APPLY_NUM;
                    data011004.YEAR = model.YEAR;
                    data011004.TYPE = model.TYPE;
                    data011004.IS_MERGE = model.IS_MERGE;
                    data011004.FILE_NAME = model.FILE_0_TEXT;

                    //Update(data011004, where011004);
                    base.Update2(data011004, where011004, dict2);
                    #endregion

                    #region 檔案上傳

                    //更新上傳檔案
                    if (model.FILE_0 != null)
                    {
                        Apply_FileModel applyFile1 = new Apply_FileModel();
                        applyFile1.APP_ID = model.APP_ID;
                        applyFile1.FILE_NO = 1;
                        applyFile1.FILENAME = dao.PutFile("011004", model.FILE_0, "1");
                        applyFile1.SRC_FILENAME = model.FILE_0_TEXT;
                        applyFile1.ADD_TIME = DateTime.Now;
                        applyFile1.ADD_FUN_CD = "WEB-APPLY";
                        applyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.UPD_TIME = DateTime.Now;
                        applyFile1.UPD_FUN_CD = "WEB-APPLY";
                        applyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        applyFile1.DEL_MK = "N";
                        Insert(applyFile1);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011004 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }

        #endregion

        #region Apply_011003 社會工作實務經驗年資審查線上申辦

        public string ChkApply011003(Apply_011003FormModel form)
        {
            string Msg = "";

            System.Text.RegularExpressions.Regex reg = new System.Text.RegularExpressions.Regex(@"^[A-Za-z0-9\.\-\,\s\(\)\'\:\：]+$");
            System.Text.RegularExpressions.Regex reg1 = new System.Text.RegularExpressions.Regex(@"^[0-9\.]+$");
            System.Text.RegularExpressions.Regex reg2 = new System.Text.RegularExpressions.Regex(@"^[0-9]+$");
            System.Text.RegularExpressions.Regex reg3 = new System.Text.RegularExpressions.Regex(@"^([\w\.\-]+)@([\w\-]+)((\.(\w){2,10})+)$");
            System.Text.RegularExpressions.Regex reg4 = new System.Text.RegularExpressions.Regex(@"^[\u4e00-\u9fa5]+$");
            System.Text.RegularExpressions.Regex reg5 = new System.Text.RegularExpressions.Regex(@"^[0-9\-\#]+$");
            System.Text.RegularExpressions.Regex reg6 = new System.Text.RegularExpressions.Regex(@"^[0-9\-]+$");
            TblZIPCODE zip = new TblZIPCODE();
            zip.ZIP_CO = form.ADDR;
            var zipdata = GetRow(zip);
            if (zipdata.ZIP_CO == null)
            {
                Msg = "請輸入正確的郵遞區號 \r\n";
            }
            if (!CheckUtils.IsIdentity(form.IDN))
            {
                Msg += "請輸入正確的國民身分證統一編號 \r\n";
            }
            var TEL = form.TEL.TONotNullString() + form.TEL_0.TONotNullString() + form.TEL_1.TONotNullString().ToTrim();
            var FAX = form.FAX.TONotNullString() + form.FAX_0.TONotNullString() + form.FAX_1.TONotNullString().ToTrim();
            var MOBILE = form.MOBILE.TONotNullString().ToTrim();

            if (TEL.TONotNullString().ToTrim() == "" && FAX.TONotNullString().ToTrim() == "" && MOBILE.TONotNullString().ToTrim() == "")
            {
                Msg += "電話與行動電話請擇一填寫；電話(公)與電話(宅)請擇一填寫 \r\n";
            }
            if (TEL.TONotNullString().ToTrim() != "")
            {
                if (!reg2.IsMatch(TEL.TONotNullString().ToTrim()))
                {
                    Msg += "電話(公)請以數字填寫。\r\n";
                }
            }
            if (FAX.TONotNullString().ToTrim() != "")
            {
                if (!reg2.IsMatch(FAX.TONotNullString().ToTrim()))
                {
                    Msg += "電話(宅)請以數字填寫。\r\n";
                }
            }
            // 範例 0912-234567
            if (MOBILE.TONotNullString().ToTrim() != "")
            {
                if (!reg6.IsMatch(MOBILE.TONotNullString().ToTrim()))
                {
                    Msg += "行動電話請以數字填寫。\r\n";
                }
            }
            if (form.SCHOOL.ToTrim() == "0")
            {
                Msg += "請輸入正確的學歷-學校名稱 \r\n";
            }
            if (form.OFFICE.ToTrim() == "0")
            {
                Msg += "請輸入正確的學歷-系(組)所名稱 \r\n";
            }

            //佐證文件檢核
            for (var i = 0; i < form.SRVLIST.Count; i++)
            {
                if (string.IsNullOrEmpty(form.SRVLIST[i].SRV_NAM))
                {
                    Msg += "服務經歷序號" + (i + 1) + " 服務經歷-服務單位名稱 為必填欄位 \r\n";
                }

                if (string.IsNullOrEmpty(form.SRVLIST[i].SRV_TITLE))
                {
                    Msg += "服務經歷序號" + (i + 1) + " 服務經歷-職稱 為必填欄位 \r\n";
                }

                if (string.IsNullOrEmpty(form.SRVLIST[i].SRV_SYEAR))
                {
                    Msg += "服務經歷序號" + (i + 1) + " 服務經歷-服務年資(起) 為必填欄位 \r\n";
                }

                if (string.IsNullOrEmpty(form.SRVLIST[i].SRV_EYEAR))
                {
                    Msg += "服務經歷序號" + (i + 1) + " 服務經歷-服務年資(迄) 為必填欄位 \r\n";
                }

                if (string.IsNullOrEmpty(form.SRVLIST[i].FILE_PICRGB_TEXT))
                {
                    Msg += "服務經歷序號" + (i + 1) + " 服務證明正本彩色檔 為必填欄位 \r\n";
                }
            }
            if ((!string.IsNullOrEmpty(form.NOTICEDAY_YEAR) && string.IsNullOrEmpty(form.NOTICEDAY_MONTH)) || (string.IsNullOrEmpty(form.NOTICEDAY_YEAR) && !string.IsNullOrEmpty(form.NOTICEDAY_MONTH)))
            {
                Msg += "請選擇完整考試通知書-通知年月 ! \r\n";
            }

            //服務經歷檢核(皆須上傳檔案)
            if (form.MERGEYN == "Y")
            {
                //合併時至少上傳一筆資料
            }
            else
            {
                if (string.IsNullOrEmpty(form.FILE_FIDC_TEXT))
                {
                    Msg += "請上傳國民身分證正面影本 ! \r\n";
                }

                if (string.IsNullOrEmpty(form.FILE_BIDC_TEXT))
                {
                    Msg += "請上傳國民身分證背面影本 ! \r\n";
                }

                if (string.IsNullOrEmpty(form.FILE_PIC_TEXT))
                {
                    Msg += "請上傳最近一年內半身脫帽照片一張 ! \r\n";
                }
                switch (form.EDUCATION)
                {
                    case "1":
                        if (string.IsNullOrEmpty(form.FILE_GRAD_TEXT))
                        {
                            Msg += "請上傳中華民國一百零二年起，經考選部依「專技人員社會工作師考試應考資格第五條審議通過並公告名單」所列學校之畢業證書影本 ! \r\n";
                        }
                        break;
                    case "2":
                        if (string.IsNullOrEmpty(form.FILE_NOTI_TEXT))
                        {
                            Msg += "請上傳非考選部公告之學校系所(報考專門職業及技術人員高等考試社會工作師考試之考試通知書影本)! \r\n";
                        }
                        if (string.IsNullOrEmpty(form.FILE_NOTI2_TEXT))
                        {
                            Msg += "請上傳非考選部公告之學校系所(畢業證書影本) ! \r\n";
                        }
                        if (string.IsNullOrEmpty(form.FILE_NOTI3_TEXT))
                        {
                            Msg += "請上傳非考選部公告之學校系所(學分證明) ! \r\n";
                        }
                        if (string.IsNullOrEmpty(form.FILE_NOTI4_TEXT))
                        {
                            Msg += "請上傳非考選部公告之學校系所(實習證明) ! \r\n";
                        }
                        break;
                    case "3":
                        if (string.IsNullOrEmpty(form.FILE_GRADOFF_TEXT))
                        {
                            Msg += "請上傳經教育部承認之國外專科以上社會工作相關科、系、組、所、學位學程畢業證書影本 ! \r\n";
                        }
                        break;
                }


                if (form.ISMEET == "2")
                {
                    if (string.IsNullOrEmpty(form.FILE_FONSRV_TEXT))
                    {
                        Msg += "請上傳國外社會工作師資格證明文件 ! \r\n";
                    }
                }

                if (form.ISMEET == "3")
                {
                    if (string.IsNullOrEmpty(form.FILE_SCHOOL_TEXT))
                    {
                        Msg += "請上傳公立或依法立案之私立專科以上學校教學之證明文件 ! \r\n";
                    }
                }


            }

            if (!string.IsNullOrEmpty(form.FILE_BIDC_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_BIDC_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_BIDC_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_DOMICILE_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_DOMICILE_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_DOMICILE_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_FIDC_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_FIDC_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_FIDC_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_FONSRV_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_FONSRV_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_FONSRV_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_GRADOFF_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_GRADOFF_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_GRADOFF_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_GRAD_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_GRAD_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_GRAD_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_NOTI2_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_NOTI2_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_NOTI2_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_NOTI3_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_NOTI3_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_NOTI3_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_NOTI4_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_NOTI4_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_NOTI4_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_NOTI_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_NOTI_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_NOTI_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_OTHER_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_OTHER_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_OTHER_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_PIC_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_PIC_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_PIC_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }
            if (!string.IsNullOrEmpty(form.FILE_SCHOOL_TEXT))
            {
                logger.Debug("Apply_011003.FileName:" + form.FILE_SCHOOL_TEXT);
                // 允許的附檔名（全小寫）
                var validExts = new[] { "pdf", "jpg", "jpeg", "bmp", "png", "gif", "tif", "zip", "doc", "docx", "odt", "odf", "ods", "xls", "xlsx", "ppt", "pptx" };
                // 取得副檔名並轉小寫
                var ext = form.FILE_SCHOOL_TEXT.ToSplit(".").LastOrDefault().ToLower();
                if (!validExts.Contains(ext))
                {
                    Msg += "不支援的檔案格式";
                }
            }

            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply011003(Apply_011003FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011003";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.ADDR_CODE = form.ADDR_CODE;
                    where.ADDR = form.ADDR_TEXT + form.ADDR_DETAIL;
                    where.TEL = form.TEL_1.TONotNullString() != "" ? form.TEL + "-" + form.TEL_0 + "#" + form.TEL_1 : form.TEL + "-" + form.TEL_0;
                    where.FAX = null;
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011003");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011003");
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    #region 檔案上傳

                    var FILE_FIDC = "";
                    var FILE_BIDC = "";
                    var FILE_PIC = "";
                    var FILE_GRAD = "";
                    var FILE_NOTI = "";
                    var FILE_NOTI2 = "";
                    var FILE_NOTI3 = "";
                    var FILE_NOTI4 = "";
                    var FILE_GRADOFF = "";
                    var FILE_FONSRV = "";
                    var FILE_SCHOOL = "";
                    var FILE_DOMICILE = "";
                    var FILE_OTHER = "";

                    if (!form.FILE_FIDC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_FIDC, "1");
                        FILE_FIDC = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_FIDC_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_BIDC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_BIDC, "2");
                        FILE_FIDC = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_BIDC_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_PIC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_PIC, "3");
                        FILE_PIC = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_PIC_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_GRAD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_GRAD, "4");
                        FILE_GRAD = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_GRAD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_NOTI.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 5;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_NOTI, "5");
                        FILE_NOTI = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_NOTI_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_NOTI2.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 12;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_NOTI2, "12");
                        FILE_NOTI2 = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_NOTI2_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_NOTI3.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 13;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_NOTI3, "13");
                        FILE_NOTI3 = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_NOTI3_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_NOTI4.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 14;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_NOTI4, "14");
                        FILE_NOTI4 = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_NOTI4_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_GRADOFF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 6;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_GRADOFF, "6");
                        FILE_GRADOFF = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_GRADOFF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_FONSRV.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 7;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_FONSRV, "7");
                        FILE_FONSRV = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_FONSRV_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_SCHOOL.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 8;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_SCHOOL, "8");
                        FILE_SCHOOL = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_SCHOOL_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_DOMICILE.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 9;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_DOMICILE, "9");
                        FILE_DOMICILE = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_DOMICILE_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    if (!form.FILE_OTHER.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 10;
                        file.SRC_NO = 0;
                        file.FILENAME = dao.PutFile("011003", form.FILE_OTHER, "10");
                        FILE_OTHER = file.FILENAME.Split('\\')[3].ToString();
                        file.SRC_FILENAME = form.FILE_OTHER_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    #endregion

                    // Insert 案件
                    APPLY_011003 app = new APPLY_011003();
                    app.InjectFrom(form);
                    app.APP_ID = APP_ID;
                    app.ISMEET = form.ISMEET;
                    app.NAME = form.NAME;
                    app.BIRTHDAY = HelperUtil.TransTwToDateTime(form.BIRTHDAY);
                    app.IDN = form.IDN;
                    app.SEX_CD = form.SEX_CD;
                    app.TEL = form.TEL_1.TONotNullString() != "" ? form.TEL + "-" + form.TEL_0 + "#" + form.TEL_1 : form.TEL + "-" + form.TEL_0;
                    if (form.FAX.TONotNullString() != "")
                    {
                        app.FAX = form.FAX_1.TONotNullString() != "" ? form.FAX + "-" + form.FAX_0 + "#" + form.FAX_1 : form.FAX + "-" + form.FAX_0;
                    }
                    app.MOBILE = form.MOBILE;
                    app.ADDR_CODE = null;
                    app.ADDR = null;
                    //app.ADDR_CODE = form.ADDR;
                    //app.ADDR = form.ADDR_TEXT + form.ADDR_DETAIL;
                    switch (form.MAIL_0.TONotNullString())
                    {
                        case "0":
                            app.MAIL = form.MAIL + "@" + form.MAIL_1;
                            break;
                        case "1":
                            app.MAIL = form.MAIL + "@gmail.com";
                            break;
                        case "2":
                            app.MAIL = form.MAIL + "@yahoo.com.tw";
                            break;
                        case "3":
                            app.MAIL = form.MAIL + "@outlook.com";
                            break;
                    }
                    app.EDUCATION = form.EDUCATION;
                    app.SCHOOL = form.SCHOOL;
                    app.OFFICE = form.OFFICE;
                    if (!string.IsNullOrEmpty(form.NOTICEDAY_YEAR))
                    {
                        app.NOTICEDAY = form.NOTICEDAY_YEAR.TONotNullString() + form.NOTICEDAY_MONTH.TONotNullString().PadLeft(2, '0');
                    }
                    app.GRADUATION = form.GRADUATION + form.GRADUATION_MONTH.PadLeft(2, '0');
                    app.MERGEYN = form.MERGEYN;
                    app.FILE_FIDC = string.IsNullOrEmpty(FILE_FIDC) ? null : FILE_FIDC;
                    app.FILE_BIDC = string.IsNullOrEmpty(FILE_BIDC) ? null : FILE_BIDC;
                    app.FILE_PIC = string.IsNullOrEmpty(FILE_PIC) ? null : FILE_PIC;
                    app.FILE_GRAD = string.IsNullOrEmpty(FILE_GRAD) ? null : FILE_GRAD;
                    app.FILE_NOTI = string.IsNullOrEmpty(FILE_NOTI) ? null : FILE_NOTI;
                    app.FILE_NOTI2 = string.IsNullOrEmpty(FILE_NOTI2) ? null : FILE_NOTI2;
                    app.FILE_NOTI3 = string.IsNullOrEmpty(FILE_NOTI3) ? null : FILE_NOTI3;
                    app.FILE_NOTI4 = string.IsNullOrEmpty(FILE_NOTI4) ? null : FILE_NOTI4;
                    app.FILE_GRADOFF = string.IsNullOrEmpty(FILE_GRADOFF) ? null : FILE_GRADOFF;
                    app.FILE_FONSRV = string.IsNullOrEmpty(FILE_FONSRV) ? null : FILE_FONSRV;
                    app.FILE_DOMICILE = string.IsNullOrEmpty(FILE_DOMICILE) ? null : FILE_DOMICILE;
                    app.FILE_SCHOOL = string.IsNullOrEmpty(FILE_SCHOOL) ? null : FILE_SCHOOL;
                    app.FILE_OTHER = string.IsNullOrEmpty(FILE_OTHER) ? null : FILE_OTHER;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    base.Insert(app);

                    #region 服務經歷
                    var cnt = 1;
                    var extcnt = 1;

                    foreach (var item in form.SRVLIST)
                    {
                        #region 檔案上傳

                        var FILE_PICRGB = "";
                        var FILE_SRVPROVE = "";
                        var FILE_LABOR = "";
                        var FILE_LEGAL = "";
                        var FILE_CHARTER = "";

                        if (!item.FILE_PICRGB.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 1;
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_PICRGB, cnt.ToString());
                            FILE_PICRGB = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_PICRGB_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }

                        cnt++;

                        if (!item.FILE_SRVPROVE.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 2;
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_SRVPROVE, cnt.ToString());
                            FILE_SRVPROVE = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_SRVPROVE_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }

                        cnt++;

                        if (!item.FILE_LABOR.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 3;
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_LABOR, cnt.ToString());
                            FILE_LABOR = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_LABOR_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }

                        cnt++;

                        if (!item.FILE_LEGAL.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 4;
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_LEGAL, cnt.ToString());
                            FILE_LEGAL = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_LEGAL_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }

                        cnt++;

                        if (!item.FILE_CHARTER.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 5;
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_CHARTER, cnt.ToString());
                            FILE_CHARTER = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_CHARTER_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        cnt++;
                        extcnt++;
                        #endregion

                        APPLY_011003_SRVLST appsrv = new APPLY_011003_SRVLST();
                        appsrv.SEQ_NO = item.SEQ_NO;
                        appsrv.APP_ID = APP_ID;
                        appsrv.SRV_NAM = item.SRV_NAM;
                        appsrv.SRV_TITLE = item.SRV_TITLE;
                        appsrv.SRV_SYEAR = HelperUtil.TransTwToDateTime(item.SRV_SYEAR);
                        appsrv.SRV_EYEAR = HelperUtil.TransTwToDateTime(item.SRV_EYEAR);
                        appsrv.FILE_PICRGB = string.IsNullOrEmpty(FILE_PICRGB) ? null : FILE_PICRGB;
                        appsrv.FILE_SRVPROVE = string.IsNullOrEmpty(FILE_SRVPROVE) ? null : FILE_SRVPROVE;
                        appsrv.FILE_LABOR = string.IsNullOrEmpty(FILE_LABOR) ? null : FILE_LABOR;
                        appsrv.FILE_LEGAL = string.IsNullOrEmpty(FILE_LEGAL) ? null : FILE_LEGAL;
                        appsrv.FILE_CHARTER = string.IsNullOrEmpty(FILE_CHARTER) ? null : FILE_CHARTER;
                        appsrv.SRVLST_DEMAND_1 = item.SRVLST_DEMAND_1_TEXT.TONotNullString() != "" ? "1" : "0";
                        appsrv.SRVLST_DEMAND_1_TEXT = item.SRVLST_DEMAND_1_TEXT;
                        appsrv.SRVLST_DEMAND_2 = item.SRVLST_DEMAND_2_TEXT.TONotNullString() != "" ? "1" : "0";
                        appsrv.SRVLST_DEMAND_2_TEXT = item.SRVLST_DEMAND_2_TEXT;
                        appsrv.ADD_TIME = DateTime.Now;
                        appsrv.ADD_FUN_CD = "WEB-APPLY";
                        appsrv.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        appsrv.UPD_TIME = DateTime.Now;
                        appsrv.UPD_FUN_CD = "WEB-APPLY";
                        appsrv.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        appsrv.DEL_MK = "N";
                        base.Insert(appsrv);
                    }

                    #endregion

                    tran.Commit();
                    return APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011003 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011003FormModel GetDetail011003(string APP_ID)
        {
            var result = new Apply_011003FormModel();

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"select convert(varchar,app.APP_TIME, 111)APP_TIME,app.APP_EXT_DATE,ad.NAME as PRO_NAM,app.MOHW_CASE_NO,
                                      a03.APP_ID,a03.ISMEET,a03.NAME,convert(varchar,a03.BIRTHDAY, 111)BIRTHDAY,
                                      a03.IDN,a03.SEX_CD,app.TEL,a03.FAX,a03.MOBILE,app.ADDR,app.ADDR_CODE,a03.MAIL,a03.EDUCATION,
                                      a03.SCHOOL,a03.OFFICE,a03.GRADUATION,a03.FILE_FIDC AS FILE_FIDC_TEXT,a03.FILE_BIDC AS FILE_BIDC_TEXT,a03.FILE_PIC AS FILE_PIC_TEXT,
                                      a03.FILE_GRAD AS FILE_GRAD_TEXT,a03.FILE_NOTI AS FILE_NOTI_TEXT,a03.FILE_GRADOFF AS FILE_GRADOFF_TEXT,
                                      a03.FILE_FONSRV AS FILE_FONSRV_TEXT,a03.FILE_SCHOOL AS FILE_SCHOOL_TEXT,
                                      a03.FILE_DOMICILE AS FILE_DOMICILE_TEXT,a03.FILE_OTHER AS FILE_OTHER_TEXT,
                                      app.FLOW_CD,a03.MERGEYN,app.MAILBODY, a03.NOTICEDAY,a03.FILE_NOTI2 AS FILE_NOTI2_TEXT,a03.FILE_NOTI3 AS FILE_NOTI3_TEXT,a03.FILE_NOTI4 AS FILE_NOTI4_TEXT
                                      from APPLY_011003 a03
                                      join APPLY app on a03.APP_ID = app.APP_ID
                                      left join ADMIN ad on app.PRO_ACC = ad.ACC_NO
                                      where 1 = 1";
                _sql += "and a03.app_id = '" + APP_ID + "'";

                string _srvlistsql = @"SELECT APP_ID,SRV_NAM,SRV_TITLE,CONVERT(varchar, SRV_SYEAR, 111) SRV_SYEAR,CONVERT(varchar, SRV_EYEAR, 111) SRV_EYEAR,FILE_PICRGB as FILE_PICRGB_TEXT
                                       ,FILE_SRVPROVE as FILE_SRVPROVE_TEXT,FILE_LABOR as FILE_LABOR_TEXT,CONVERT(BIT,SRVLST_DEMAND_1) as SRVLST_DEMAND_1,SRVLST_DEMAND_1_TEXT
                                       ,FILE_LEGAL as FILE_LEGAL_TEXT,CONVERT(BIT,SRVLST_DEMAND_2) as SRVLST_DEMAND_2,SRVLST_DEMAND_2_TEXT,FILE_CHARTER as FILE_CHARTER_TEXT,SEQ_NO
                                       FROM APPLY_011003_SRVLST
                                       where 1 = 1";
                _srvlistsql += " and app_id = '" + APP_ID + "'";

                string _filesql = @"select af.*,a03.*,case a03.SRVLST_DEMAND_1 when '0' then '否' when '1' then '是' end as SRVLST_DEMAND_1,
                                           case a03.SRVLST_DEMAND_2 when '0' then '否' when '1' then '是' end as SRVLST_DEMAND_2
                                    from APPLY_FILE af
                                    left join APPLY_011003_SRVLST a03 on a03.APP_ID = af.APP_ID
                                    where 1 = 1 ";
                _filesql += "and af.app_id = '" + APP_ID + "'";

                try
                {
                    result = conn.Query<Apply_011003FormModel>(_sql).FirstOrDefault();
                    result.FILE = conn.Query<Apply_011003FILEModel>(_filesql).ToList();
                    result.SRVLIST = conn.Query<Apply_011003SRVLSTModel>(_srvlistsql).ToList();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 補件案件
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011003(Apply_011003FormModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011003";
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
                    string s_SRV_ID = "011003";
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", s_SRV_ID);
                    dict2.Add("LastMODTIME", LastMODTIME);

                    // 取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N";
                    var getan = GetRowList(an);
                    Count = getan.ToCount();

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(model);
                    where.ADDR_CODE = model.ADDR_CODE;
                    where.ADDR = model.ADDR_TEXT + model.ADDR_DETAIL;
                    where.TEL = model.TEL;
                    //where.TEL = model.TEL_1.TONotNullString() != "" ? model.TEL + "-" + model.TEL_0 + "#" + model.TEL_1 : model.TEL + "-" + model.TEL_0;
                    where.FAX = null;
                    where.APP_ID = model.APP_ID;
                    where.UNIT_CD = 8;
                    //where.APP_TIME = DateTime.Now;
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.FLOW_CD = "3";

                    base.Update2(where, appwhere, dict2);

                    APPLY_011003 whereapp = new APPLY_011003();
                    whereapp.APP_ID = model.APP_ID;
                    // Insert 案件
                    APPLY_011003 app = new APPLY_011003();
                    app.InjectFrom(model);
                    app.APP_ID = model.APP_ID;
                    app.ISMEET = model.ISMEET;
                    //app.NAME = model.NAME;
                    //app.BIRTHDAY = HelperUtil.TransTwToDateTime(model.BIRTHDAY);
                    //app.IDN = model.IDN;
                    app.SEX_CD = model.SEX_CD;
                    //app.TEL = null;
                    app.TEL = model.TEL;
                    if (model.FAX.TONotNullString() != "")
                    {
                        app.FAX = model.FAX;
                        //app.FAX = model.FAX_1.TONotNullString() != "" ? model.FAX + "-" + model.FAX_0 + "#" + model.FAX_1 : model.FAX + "-" + model.FAX_0;
                    }
                    app.MOBILE = model.MOBILE;
                    //app.ADDR_CODE = model.ADDR_CODE;
                    //app.ADDR = model.ADDR_TEXT + model.ADDR_DETAIL;
                    app.ADDR_CODE = null;
                    app.ADDR = null;
                    switch (model.MAIL_0.TONotNullString())
                    {
                        case "0":
                            app.MAIL = model.MAIL + "@" + model.MAIL_1;
                            break;
                        case "1":
                            app.MAIL = model.MAIL + "@gmail.com";
                            break;
                        case "2":
                            app.MAIL = model.MAIL + "@yahoo.com.tw";
                            break;
                        case "3":
                            app.MAIL = model.MAIL + "@outlook.com";
                            break;
                    }
                    app.EDUCATION = model.EDUCATION;
                    app.SCHOOL = model.SCHOOL;
                    app.OFFICE = model.OFFICE;
                    app.GRADUATION = model.GRADUATION + model.GRADUATION_MONTH.PadLeft(2, '0');
                    if (model.NOTICEDAY_YEAR.TONotNullString() != "" && model.NOTICEDAY_MONTH.TONotNullString() != "")
                    {
                        app.NOTICEDAY = model.NOTICEDAY_YEAR + model.NOTICEDAY_MONTH.PadLeft(2, '0');
                    }
                    else
                    {
                        app.NOTICEDAY = null;
                    }
                    app.MERGEYN = model.MERGEYN;
                    app.FILE_FIDC = model.FILE_FIDC_TEXT;
                    app.FILE_BIDC = model.FILE_BIDC_TEXT;
                    app.FILE_PIC = model.FILE_PIC_TEXT;
                    app.FILE_GRAD = model.FILE_GRAD_TEXT;
                    app.FILE_NOTI = model.FILE_NOTI_TEXT;
                    app.FILE_NOTI2 = model.FILE_NOTI2_TEXT;
                    app.FILE_NOTI3 = model.FILE_NOTI3_TEXT;
                    app.FILE_NOTI4 = model.FILE_NOTI4_TEXT;
                    app.FILE_GRADOFF = model.FILE_GRADOFF_TEXT;
                    app.FILE_FONSRV = model.FILE_FONSRV_TEXT;
                    app.FILE_DOMICILE = model.FILE_DOMICILE_TEXT;
                    app.FILE_SCHOOL = model.FILE_SCHOOL_TEXT;
                    app.FILE_OTHER = model.FILE_OTHER_TEXT;
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    base.Update2(app, whereapp, dict2);

                    #region 檔案上傳

                    if (!model.FILE_FIDC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 1;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_FIDC, "1");
                            file.SRC_FILENAME = model.FILE_FIDC_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 1;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_FIDC, "1");
                            newfile.SRC_FILENAME = model.FILE_FIDC_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_BIDC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 2;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_BIDC, "2");
                            file.SRC_FILENAME = model.FILE_BIDC_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 2;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_BIDC, "2");
                            newfile.SRC_FILENAME = model.FILE_BIDC_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_PIC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 3;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_PIC, "3");
                            file.SRC_FILENAME = model.FILE_PIC_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 3;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_PIC, "3");
                            newfile.SRC_FILENAME = model.FILE_PIC_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_GRAD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 4;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 4;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_GRAD, "4");
                            file.SRC_FILENAME = model.FILE_GRAD_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 4;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_GRAD, "4");
                            newfile.SRC_FILENAME = model.FILE_GRAD_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_NOTI.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 5;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 5;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_NOTI, "5");
                            file.SRC_FILENAME = model.FILE_NOTI_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 5;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_NOTI, "5");
                            newfile.SRC_FILENAME = model.FILE_NOTI_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }
                    if (!model.FILE_NOTI2.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 12;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 12;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_NOTI2, "12");
                            file.SRC_FILENAME = model.FILE_NOTI2_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 12;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_NOTI2, "12");
                            newfile.SRC_FILENAME = model.FILE_NOTI2_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }
                    if (!model.FILE_NOTI3.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 13;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 13;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_NOTI3, "13");
                            file.SRC_FILENAME = model.FILE_NOTI3_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 13;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_NOTI3, "13");
                            newfile.SRC_FILENAME = model.FILE_NOTI3_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }
                    if (!model.FILE_NOTI4.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 14;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 14;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_NOTI4, "14");
                            file.SRC_FILENAME = model.FILE_NOTI4_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 14;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_NOTI4, "14");
                            newfile.SRC_FILENAME = model.FILE_NOTI4_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }
                    if (!model.FILE_GRADOFF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 6;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 6;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_GRADOFF, "6");
                            file.SRC_FILENAME = model.FILE_GRADOFF_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 6;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_GRADOFF, "6");
                            newfile.SRC_FILENAME = model.FILE_GRADOFF_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_FONSRV.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 7;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 7;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_FONSRV, "7");
                            file.SRC_FILENAME = model.FILE_FONSRV_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 7;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_FONSRV, "7");
                            newfile.SRC_FILENAME = model.FILE_FONSRV_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_SCHOOL.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 8;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 8;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_SCHOOL, "8");
                            file.SRC_FILENAME = model.FILE_SCHOOL_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 8;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_SCHOOL, "8");
                            newfile.SRC_FILENAME = model.FILE_SCHOOL_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_DOMICILE.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 9;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 9;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_DOMICILE, "9");
                            file.SRC_FILENAME = model.FILE_DOMICILE_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 9;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_DOMICILE, "9");
                            newfile.SRC_FILENAME = model.FILE_DOMICILE_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    if (!model.FILE_OTHER.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 10;
                        file.SRC_NO = 0;
                        var filedata = GetRow(file);
                        if (filedata.APP_ID == null)
                        {
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 10;
                            file.SRC_NO = 0;
                            file.FILENAME = dao.PutFile("011003", model.FILE_OTHER, "10");
                            file.SRC_FILENAME = model.FILE_OTHER_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";

                            base.Insert(file);
                        }
                        else
                        {
                            Apply_FileModel newfile = new Apply_FileModel();
                            newfile.InjectFrom(filedata);
                            newfile.FILE_NO = 10;
                            newfile.APP_ID = model.APP_ID;
                            newfile.FILENAME = dao.PutFile("011003", model.FILE_OTHER, "10");
                            newfile.SRC_FILENAME = model.FILE_OTHER_TEXT;
                            newfile.UPD_TIME = DateTime.Now;
                            newfile.UPD_FUN_CD = "WEB-APPLY";
                            newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            base.Update(newfile, file);
                        }
                    }

                    #endregion

                    #region 服務經歷
                    var cnt = 1;
                    var extcnt = 1;
                    var FILE_PICRGB = "";
                    var FILE_SRVPROVE = "";
                    var FILE_LABOR = "";
                    var FILE_LEGAL = "";
                    var FILE_CHARTER = "";

                    foreach (var item in model.SRVLIST)
                    {
                        #region 檔案上傳



                        if (!item.FILE_PICRGB.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 1;
                            var filedata = GetRow(file);
                            if (filedata.APP_ID == null)
                            {
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = cnt;
                                file.SRC_NO = 1;
                                file.BATCH_INDEX = extcnt;
                                var FILENAME = dao.PutFile("011003", item.FILE_PICRGB, cnt.ToString());
                                file.FILENAME = FILENAME;
                                FILE_PICRGB = FILENAME;
                                file.SRC_FILENAME = item.FILE_PICRGB_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Insert(file);
                            }
                            else
                            {
                                Apply_FileModel newfile = new Apply_FileModel();
                                newfile.InjectFrom(filedata);
                                newfile.FILE_NO = cnt;
                                newfile.SRC_NO = 1;
                                newfile.APP_ID = model.APP_ID;
                                var FILENAME = dao.PutFile("011003", item.FILE_PICRGB, cnt.ToString());
                                newfile.FILENAME = FILENAME;
                                FILE_PICRGB = FILENAME;
                                newfile.SRC_FILENAME = item.FILE_PICRGB_TEXT;
                                newfile.UPD_TIME = DateTime.Now;
                                newfile.UPD_FUN_CD = "WEB-APPLY";
                                newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Update(newfile, file);
                            }
                        }

                        cnt++;

                        if (!item.FILE_SRVPROVE.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 2;
                            var filedata = GetRow(file);
                            if (filedata.APP_ID == null)
                            {
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = cnt;
                                file.SRC_NO = 2;
                                file.BATCH_INDEX = extcnt;
                                var FILENAME = dao.PutFile("011003", item.FILE_SRVPROVE, cnt.ToString());
                                file.FILENAME = FILENAME;
                                FILE_SRVPROVE = FILENAME;
                                file.SRC_FILENAME = item.FILE_SRVPROVE_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Insert(file);
                            }
                            else
                            {
                                Apply_FileModel newfile = new Apply_FileModel();
                                newfile.InjectFrom(filedata);
                                newfile.FILE_NO = cnt;
                                newfile.SRC_NO = 2;
                                newfile.APP_ID = model.APP_ID;
                                var FILENAME = dao.PutFile("011003", item.FILE_SRVPROVE, cnt.ToString());
                                newfile.FILENAME = FILENAME;
                                FILE_SRVPROVE = FILENAME;
                                newfile.SRC_FILENAME = item.FILE_SRVPROVE_TEXT;
                                newfile.UPD_TIME = DateTime.Now;
                                newfile.UPD_FUN_CD = "WEB-APPLY";
                                newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Update(newfile, file);
                            }
                        }

                        cnt++;

                        if (!item.FILE_LABOR.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 3;
                            var filedata = GetRow(file);
                            if (filedata.APP_ID == null)
                            {
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = cnt;
                                file.SRC_NO = 3;
                                file.BATCH_INDEX = extcnt;
                                var FILENAME = dao.PutFile("011003", item.FILE_LABOR, cnt.ToString());
                                file.FILENAME = FILENAME;
                                FILE_LABOR = FILENAME;
                                file.SRC_FILENAME = item.FILE_LABOR_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Insert(file);
                            }
                            else
                            {
                                Apply_FileModel newfile = new Apply_FileModel();
                                newfile.InjectFrom(filedata);
                                newfile.FILE_NO = cnt;
                                newfile.SRC_NO = 3;
                                newfile.APP_ID = model.APP_ID;
                                var FILENAME = dao.PutFile("011003", item.FILE_LABOR, cnt.ToString());
                                newfile.FILENAME = FILENAME;
                                FILE_LABOR = FILENAME;
                                newfile.SRC_FILENAME = item.FILE_LABOR_TEXT;
                                newfile.UPD_TIME = DateTime.Now;
                                newfile.UPD_FUN_CD = "WEB-APPLY";
                                newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Update(newfile, file);
                            }
                        }

                        cnt++;

                        if (!item.FILE_LEGAL.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 4;
                            var filedata = GetRow(file);
                            if (filedata.APP_ID == null)
                            {
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = cnt;
                                file.SRC_NO = 4;
                                file.BATCH_INDEX = extcnt;
                                var FILENAME = dao.PutFile("011003", item.FILE_LEGAL, cnt.ToString());
                                file.FILENAME = FILENAME;
                                FILE_LEGAL = FILENAME;
                                file.SRC_FILENAME = item.FILE_LEGAL_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Insert(file);
                            }
                            else
                            {
                                Apply_FileModel newfile = new Apply_FileModel();
                                newfile.InjectFrom(filedata);
                                newfile.FILE_NO = cnt;
                                newfile.SRC_NO = 4;
                                newfile.APP_ID = model.APP_ID;
                                var FILENAME = dao.PutFile("011003", item.FILE_LEGAL, cnt.ToString());
                                newfile.FILENAME = FILENAME;
                                FILE_LEGAL = FILENAME;
                                newfile.SRC_FILENAME = item.FILE_LEGAL_TEXT;
                                newfile.UPD_TIME = DateTime.Now;
                                newfile.UPD_FUN_CD = "WEB-APPLY";
                                newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Update(newfile, file);
                            }
                        }

                        cnt++;

                        if (!item.FILE_CHARTER.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = cnt;
                            file.SRC_NO = 5;
                            var filedata = GetRow(file);
                            if (filedata.APP_ID == null)
                            {
                                file.APP_ID = model.APP_ID;
                                file.FILE_NO = cnt;
                                file.SRC_NO = 5;
                                file.BATCH_INDEX = extcnt;
                                var FILENAME = dao.PutFile("011003", item.FILE_CHARTER, cnt.ToString());
                                file.FILENAME = FILENAME;
                                FILE_CHARTER = FILENAME;
                                file.SRC_FILENAME = item.FILE_CHARTER_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Insert(file);
                            }
                            else
                            {
                                Apply_FileModel newfile = new Apply_FileModel();
                                newfile.InjectFrom(filedata);
                                newfile.FILE_NO = cnt;
                                newfile.SRC_NO = 5;
                                newfile.APP_ID = model.APP_ID;
                                var FILENAME = dao.PutFile("011003", item.FILE_CHARTER, cnt.ToString());
                                newfile.FILENAME = FILENAME;
                                FILE_CHARTER = FILENAME;
                                newfile.SRC_FILENAME = item.FILE_CHARTER_TEXT;
                                newfile.UPD_TIME = DateTime.Now;
                                newfile.UPD_FUN_CD = "WEB-APPLY";
                                newfile.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                base.Update(newfile, file);
                            }
                        }

                        cnt++;
                        extcnt++;
                        #endregion

                        APPLY_011003_SRVLST appsrvwhere = new APPLY_011003_SRVLST();
                        appsrvwhere.SEQ_NO = item.SEQ_NO;
                        appsrvwhere.APP_ID = model.APP_ID;

                        APPLY_011003_SRVLST appsrv = new APPLY_011003_SRVLST();
                        appsrv.SEQ_NO = item.SEQ_NO;
                        appsrv.APP_ID = model.APP_ID;
                        appsrv.SRV_NAM = item.SRV_NAM;
                        appsrv.SRV_TITLE = item.SRV_TITLE;
                        appsrv.SRV_SYEAR = HelperUtil.TransTwToDateTime(item.SRV_SYEAR);
                        appsrv.SRV_EYEAR = HelperUtil.TransTwToDateTime(item.SRV_EYEAR);
                        appsrv.FILE_PICRGB = FILE_PICRGB;
                        appsrv.FILE_SRVPROVE = FILE_SRVPROVE;
                        appsrv.FILE_LABOR = FILE_LABOR;
                        appsrv.FILE_LEGAL = FILE_LEGAL;
                        appsrv.FILE_CHARTER = FILE_CHARTER;
                        appsrv.SRVLST_DEMAND_1 = item.SRVLST_DEMAND_1_TEXT.TONotNullString() != "" ? "1" : "0";
                        appsrv.SRVLST_DEMAND_1_TEXT = item.SRVLST_DEMAND_1_TEXT;
                        appsrv.SRVLST_DEMAND_2 = item.SRVLST_DEMAND_2_TEXT.TONotNullString() != "" ? "1" : "0";
                        appsrv.SRVLST_DEMAND_2_TEXT = item.SRVLST_DEMAND_2_TEXT;
                        appsrv.UPD_TIME = DateTime.Now;
                        appsrv.UPD_FUN_CD = "WEB-APPLY";
                        appsrv.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Update2(appsrv, appsrvwhere, dict2);
                    }

                    #endregion                   

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011003 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();
        }

        #endregion

        #region Apply_011006 專科社會工作師證書換發（更名）

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011006(Apply_011006FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "011006";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo("011006");
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.ADDR_CODE = form.ADDR_CODE;
                    where.ADDR = form.ADDR;
                    var HTEL = form.H_TEL_1.TONotNullString().ToTrim() != "" ? form.H_TEL_2.TONotNullString().ToTrim() != "" ? form.H_TEL_0.TONotNullString() + "-" + form.H_TEL_1.TONotNullString() + "#" + form.H_TEL_2.TONotNullString() : form.H_TEL_0.TONotNullString() + "-" + form.H_TEL_1.TONotNullString() : "";
                    var WTEL = form.W_TEL_1.TONotNullString().ToTrim() != "" ? form.W_TEL_2.TONotNullString().ToTrim() != "" ? form.W_TEL_0.TONotNullString() + "-" + form.W_TEL_1.TONotNullString() + "#" + form.W_TEL_2.TONotNullString() : form.W_TEL_0.TONotNullString() + "-" + form.W_TEL_1.TONotNullString() : "";
                    var MOBILE = form.MOBILE.TONotNullString();
                    if (HTEL.TONotNullString() != "") where.TEL = HTEL.TONotNullString();
                    else if (WTEL.TONotNullString() != "") where.TEL = WTEL.TONotNullString();
                    else where.TEL = MOBILE.TONotNullString();
                    where.MOBILE = MOBILE;
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 8;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("011006");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("011006");
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_011006Model app = new Apply_011006Model();
                    app.InjectFrom(form);
                    app.H_TEL = HTEL;
                    app.W_TEL = WTEL;
                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.EMAIL = form.EMAIL;
                    app.PRACTICE_PLACE = form.PRACTICE_PLACE;
                    app.SPECIALIST_TYPE = form.SPECIALIST_TYPE;
                    app.TEST_YEAR = form.TEST_YEAR;
                    app.H_EQUAL = form.H_EQUAL;
                    app.MERGEYN = form.MERGEYN;
                    app.APPLY_TYPE = form.APPLY_TYPE;
                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";
                    app.FILE_IDNF = "1";
                    app.FILE_IDNB = "2";
                    app.FILE_PHOTO = "3";
                    app.FILE_HOUSEHOLD = "4";
                    base.Insert(app);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    //pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = "WEB-APPLY";
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = "WEB-APPLY";

                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳

                    if (!form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011006", form.FILE_IDNF, "1");
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011006", form.FILE_IDNB, "2");
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011006", form.FILE_PHOTO, "3");
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    if (!form.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011006", form.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = form.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011006 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011006AppDocModel GetFile_011006(string APP_ID)
        {
            var result = new Apply_011006AppDocModel();
            ShareDAO dao = new ShareDAO();
            var file1 = dao.GetFileGridList(APP_ID, "1", "N").FirstOrDefault();
            var file2 = dao.GetFileGridList(APP_ID, "2", "N").FirstOrDefault();
            var file3 = dao.GetFileGridList(APP_ID, "3", "N").FirstOrDefault();
            var file4 = dao.GetFileGridList(APP_ID, "4", "N").FirstOrDefault();
            result.FILE_IDNF_TEXT = file1 != null ? file1.FILE_NAME_TEXT : string.Empty;
            result.FILE_IDNB_TEXT = file2 != null ? file2.FILE_NAME_TEXT : string.Empty;
            result.FILE_PHOTO_TEXT = file3 != null ? file3.FILE_NAME_TEXT : string.Empty;
            result.FILE_HOUSEHOLD_TEXT = file4 != null ? file4.FILE_NAME_TEXT : string.Empty;

            result.APP_ID = APP_ID;
            return result;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011006(Apply_011006AppDocModel model)
        {
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", "011006");
            dict2.Add("LastMODTIME", LastMODTIME);
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var Count = 0;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    var HTEL = model.H_TEL_1.TONotNullString().ToTrim() != "" ? model.H_TEL_2.TONotNullString().ToTrim() != "" ? model.H_TEL_0.TONotNullString() + "-" + model.H_TEL_1.TONotNullString() + "#" + model.H_TEL_2.TONotNullString() : model.H_TEL_0.TONotNullString() + "-" + model.H_TEL_1.TONotNullString() : "";
                    var WTEL = model.W_TEL_1.TONotNullString().ToTrim() != "" ? model.W_TEL_2.TONotNullString().ToTrim() != "" ? model.W_TEL_0.TONotNullString() + "-" + model.W_TEL_1.TONotNullString() + "#" + model.W_TEL_2.TONotNullString() : model.W_TEL_0.TONotNullString() + "-" + model.W_TEL_1.TONotNullString() : "";

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = HTEL;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8;
                    appdata.FLOW_CD = "3";
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = "WEB-APPLY";
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //Update(appdata, appwhere);
                    base.Update2(appdata, appwhere, dict2);

                    Apply_011006Model app011002where = new Apply_011006Model();
                    app011002where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011006Model app011002data = new Apply_011006Model();
                    app011002data.InjectFrom(model);
                    app011002data.H_TEL = HTEL;
                    app011002data.W_TEL = WTEL;
                    app011002data.APP_ID = model.APP_ID;
                    app011002data.UPD_TIME = DateTime.Now;
                    app011002data.UPD_FUN_CD = "WEB-APPLY";
                    app011002data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app011002data.DEL_MK = "N";
                    app011002data.FILE_IDNF = "1";
                    app011002data.FILE_IDNB = "2";
                    app011002data.FILE_PHOTO = "3";
                    app011002data.FILE_HOUSEHOLD = "4";

                    //Update(app011002data, app011002where);
                    base.Update2(app011002data, app011002where, dict2);

                    #region 檔案上傳

                    if (!model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile("011006", model.FILE_IDNF, "1");
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile("011006", model.FILE_IDNB, "2");
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile("011006", model.FILE_PHOTO, "3");
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile("011006", model.FILE_HOUSEHOLD, "4");
                        file.SRC_FILENAME = model.FILE_HOUSEHOLD_TEXT;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011006 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();
        }
        #endregion

        #region Apply_001038 生殖細胞及胚胎輸入輸出申請作業 

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply001038(Apply_001038FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "001038";
            var APP_ID = GetApp_ID(CaseNum);
            form.APP_ID = APP_ID;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.APP_EXT_DATE = this.GetNTFD("001038");
                    where.ADDR_CODE = UserInfo.TOWN_CD.TONotNullString();
                    where.ADDR = UserInfo.ADDR.TONotNullString();
                    where.EADDR = UserInfo.EADDR.TONotNullString();
                    where.TEL = form.TAX_ORG_TEL.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 4;
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_DISP_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);
                    #endregion

                    #region 001038案件(委託人)
                    // Insert 案件
                    Apply_001038Model app = new Apply_001038Model();
                    app.InjectFrom(form);
                    app.SELL_ADDR = form.SELL_ADDR.TONotNullString();
                    app.APP_ID = APP_ID;
                    app.USE_MARK = form.Dest_USE_MARK.TONotNullString();
                    app.DEST_STATE_ID = form.Dest_DEST_STATE_ID;
                    app.SELL_STATE_ID = form.Sell_SELL_STATE_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    base.Insert(app);
                    #endregion

                    #region 輸出/輸入
                    if (form.IM_EXPORT == "0")
                    {
                        Apply_001038_DEST model = new Apply_001038_DEST();
                        model.APP_ID = APP_ID;
                        model.A_DATE = form.Dest_A_DATE;
                        model.B_DATE = form.Dest_B_DATE;
                        model.C_DATE = form.Dest_C_DATE;
                        foreach (var item in model.GetType().GetProperties())
                        {
                            var tt = form.GetType().GetProperties().Where(m => m.Name == "Dest_" + item.Name).ToList();
                            if (tt.ToCount() > 0)
                            {
                                var ttobj = tt.FirstOrDefault();
                                var tttyp = ttobj.PropertyType.Name;
                                if (tttyp.ToLower() == "string")
                                {
                                    var ttval = ttobj.GetValue(form).TONotNullString();
                                    item.SetValue(model, ttval);
                                }
                            }
                        }

                        base.Insert(model);
                    }
                    if (form.IM_EXPORT == "1")
                    {
                        Apply_001038_SELL model = new Apply_001038_SELL();
                        model.APP_ID = APP_ID;
                        model.A_DATE = form.Sell_A_DATE;
                        model.B_DATE = form.Sell_B_DATE;
                        model.C_DATE = form.Sell_C_DATE;
                        foreach (var item in model.GetType().GetProperties())
                        {
                            var tt = form.GetType().GetProperties().Where(m => m.Name == "Sell_" + item.Name).ToList();
                            if (tt.ToCount() > 0)
                            {
                                var ttobj = tt.FirstOrDefault();
                                var tttyp = ttobj.PropertyType.Name;
                                if (tttyp.ToLower() == "string")
                                {
                                    var ttval = ttobj.GetValue(form).TONotNullString();
                                    item.SetValue(model, ttval);
                                }
                            }
                        }

                        base.Insert(model);
                    }
                    #endregion

                    #region 貨品資料
                    form.GOODS.APP_ID = APP_ID;
                    foreach (var item in form.GOODS.GoodsList)
                    {
                        item.APP_ID = APP_ID;
                        item.ADD_TIME = DateTime.Now;
                        item.ADD_FUN_CD = "WEB-APPLY";
                        item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.UPD_TIME = DateTime.Now;
                        item.UPD_FUN_CD = "WEB-APPLY";
                        item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                    }
                    form.GOODS.SaveGoodsList("SRL_NO");
                    #endregion

                    #region 檔案上傳
                    for (var k = 1; k <= 6; k++)
                    {
                        var kNo = k.TONotNullString().PadLeft(2, '0');
                        var fileNo = form.GetType().GetProperties().Where(m => m.Name == "DOC_FILE_" + kNo + "_FILENAME");
                        if (fileNo.ToCount() > 0)
                        {
                            var fileObj = fileNo.FirstOrDefault();
                            var fileVal = fileObj.GetValue(form);
                            if (!fileVal.TONotNullString().Equals(""))
                            {
                                Apply_FileModel file = new Apply_FileModel();
                                file.APP_ID = APP_ID;
                                file.FILE_NO = k;
                                file.FILENAME = fileVal.TONotNullString();
                                var FileList = file.FILENAME.ToSplit('/');
                                var FileName = FileList[FileList.ToCount() - 1];
                                file.SRC_FILENAME = FileName;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";
                                base.Insert(file);
                            }
                        }
                    }

                    #endregion

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "生殖細胞及胚胎輸入輸出，案件編號﹕" + form.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += UserInfo.NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + (Convert.ToInt32(DateTime.Now.ToString("yyyy")) - 1911).ToString() + "年" + DateTime.Now.ToString("yyyyMMdd").Substring(4, 2) + "月" + DateTime.Now.ToString("yyyyMMdd").Substring(6, 2) + "日申辦之生殖細胞及胚胎輸入輸出案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001038/AppDoc?APP_ID=" + form.APP_ID + "'>" + form.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部國民健康署敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(UserInfo.MAIL, subject, MailBody);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply001038 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }
        #endregion

        #region Apply_001035 非感染性人體器官、組織及細胞進出口申請作業
        /// <summary>
        /// 檢核
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        public string Check001035(Apply_001035FormModel form)
        {
            // 英文數字 符號
            System.Text.RegularExpressions.Regex reg = new System.Text.RegularExpressions.Regex(@"^[A-Za-z0-9\.\-\,\s\(\)]+$");
            // 數字+'.'
            System.Text.RegularExpressions.Regex reg1 = new System.Text.RegularExpressions.Regex(@"^[0-9\.]+$");
            // 數字
            System.Text.RegularExpressions.Regex reg2 = new System.Text.RegularExpressions.Regex(@"^[0-9]+$");
            // mail
            System.Text.RegularExpressions.Regex reg3 = new System.Text.RegularExpressions.Regex(@"^([\w\.\-]+)@([\w\-]+)((\.(\w){2,10})+)$");
            // 中文
            System.Text.RegularExpressions.Regex reg4 = new System.Text.RegularExpressions.Regex(@"^[\u4e00-\u9fa5]+$");
            // 市話
            System.Text.RegularExpressions.Regex reg5 = new System.Text.RegularExpressions.Regex(@"^[0-9\-\#]+$");
            // 英文 . & 空白
            System.Text.RegularExpressions.Regex reg6 = new System.Text.RegularExpressions.Regex(@"^[A-Za-z\.\&\s]+$");
            var ErrMsg = string.Empty;
            if (string.IsNullOrWhiteSpace(form.TAX_ORG_EADDR) && string.IsNullOrWhiteSpace(form.TAX_ORG_ADDR))
            {
                ErrMsg += "委託人聯絡地址中文或英文是必要項\n";
            }
            if (string.IsNullOrWhiteSpace(form.TAX_ORG_NAME) && string.IsNullOrWhiteSpace(form.TAX_ORG_ENAME))
            {
                ErrMsg += "姓名/公司名稱中文或英文是必要項\n";
            }
            if (!string.IsNullOrWhiteSpace(form.TAX_ORG_EMAIL))
            {
                if (!reg3.IsMatch(form.TAX_ORG_EMAIL))
                {
                    ErrMsg += "E-MAIL格式不正確\n";
                }
            }
            if (form.DATE_S != null && form.DATE_E != null)
            {
                if (form.DATE_S > form.DATE_E)
                {
                    ErrMsg += "起始日期不得大於終止日期\n";
                }
            }
            if (!string.IsNullOrWhiteSpace(form.Dest_SELL_NAME))
            {
                if (!reg6.IsMatch(form.Dest_SELL_NAME))
                {
                    ErrMsg += "賣方英文名稱僅可輸入英文\n";
                }
            }
            if (!string.IsNullOrWhiteSpace(form.Dest_SELL_ADDR))
            {
                if (!reg.IsMatch(form.Dest_SELL_ADDR))
                {
                    ErrMsg += "賣方英文地址僅可輸入英文、數字、符號\n";
                }
            }
            if (!string.IsNullOrWhiteSpace(form.Sell_SELL_NAME))
            {
                if (!reg6.IsMatch(form.Sell_SELL_NAME))
                {
                    ErrMsg += "買方英文名稱僅可輸入英文\n";
                }
            }
            if (!string.IsNullOrWhiteSpace(form.Sell_SELL_ADDR))
            {
                if (!reg.IsMatch(form.Sell_SELL_ADDR))
                {
                    ErrMsg += "買方英文地址僅可輸入英文、數字、符號\n";
                }
            }
            if (form.GOODS == null || form.GOODS.GoodsList == null)
            {
                ErrMsg += "請輸入貨品資料\n";
            }
            else if (form.GOODS != null && form.GOODS.GoodsList != null && form.GOODS.GoodsList.Count == 0)
            {
                ErrMsg += "請輸入貨品資料\n";
            }
            else
            {
                var i = 1;
                foreach (var item in form.GOODS.GoodsList)
                {
                    if (string.IsNullOrWhiteSpace(item.GOODS_TYPE_ID))
                    {
                        ErrMsg += $"請輸入第{i}項貨品類別(規格)\n";
                    }
                    if (string.IsNullOrWhiteSpace(item.GOODS_NAME))
                    {
                        ErrMsg += $"請輸入第{i}項貨品名稱\n";
                    }
                    if (string.IsNullOrWhiteSpace(item.APPLY_CNT.ToString()))
                    {
                        ErrMsg += $"請輸入第{i}項申請數量\n";
                    }
                    //if (string.IsNullOrWhiteSpace(item.GOODS_SPEC_1))
                    //{
                    //    ErrMsg += $"請輸入第{i}項單位 \n";
                    //}
                    if (string.IsNullOrWhiteSpace(item.GOODS_MODEL))
                    {
                        ErrMsg += $"請輸入第{i}項型號 \n";
                    }
                    if (string.IsNullOrWhiteSpace(item.GOODS_DESC))
                    {
                        ErrMsg += $"請輸入第{i}項貨品輔助描述\n";
                    }
                    if (string.IsNullOrWhiteSpace(item.GOODS_UNIT_ID))
                    {
                        ErrMsg += $"請輸入第{i}項單位\n";
                    }
                    if (string.IsNullOrWhiteSpace(item.GOODS_SPEC_2))
                    {
                        ErrMsg += $"請輸入第{i}項每單位容量\n";
                    }
                    if (string.IsNullOrWhiteSpace(item.GOODS_BRAND))
                    {
                        ErrMsg += $"請輸入第{i}項牌名\n";
                    }
                    i++;
                }
            }
            return ErrMsg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply001035(Apply_001035FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "001035";
            var APP_ID = GetApp_ID(CaseNum);
            form.APP_ID = APP_ID;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.MOBILE = UserInfo.MOBILE.TONotNullString();
                    where.APP_EXT_DATE = this.GetNTFD("001035");
                    where.ADDR_CODE = form.TAX_ORG_ZIP;
                    where.ADDR = form.TAX_ORG_ADDR;
                    where.TEL = form.TAX_ORG_TEL.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 4;
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_DISP_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);
                    #endregion

                    #region 001035案件(委託人)
                    // Insert 案件
                    Apply_001035Model app = new Apply_001035Model();
                    app.InjectFrom(form);
                    app.APP_ID = APP_ID;
                    app.DEST_STATE_ID = form.Dest_DEST_STATE_ID;
                    app.SELL_STATE_ID = form.Sell_SELL_STATE_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";
                    #endregion

                    #region 進口/出口
                    if (form.IM_EXPORT == "0")
                    {
                        foreach (var item in app.GetType().GetProperties())
                        {
                            var tt = form.GetType().GetProperties().Where(m => m.Name == "Dest_" + item.Name).ToList();
                            if (tt.ToCount() > 0)
                            {
                                var ttobj = tt.FirstOrDefault();
                                var tttyp = ttobj.PropertyType.Name;
                                if (tttyp.ToLower() == "string")
                                {
                                    var ttval = ttobj.GetValue(form).TONotNullString();
                                    item.SetValue(app, ttval);
                                }
                            }
                        }
                    }
                    if (form.IM_EXPORT == "1")
                    {
                        foreach (var item in app.GetType().GetProperties())
                        {
                            var tt = form.GetType().GetProperties().Where(m => m.Name == "Sell_" + item.Name).ToList();
                            if (tt.ToCount() > 0)
                            {
                                var ttobj = tt.FirstOrDefault();
                                var tttyp = ttobj.PropertyType.Name;
                                if (tttyp.ToLower() == "string")
                                {
                                    var ttval = ttobj.GetValue(form).TONotNullString();
                                    item.SetValue(app, ttval);
                                }
                            }
                        }
                    }
                    #endregion

                    base.Insert(app);

                    #region 貨品資料
                    form.GOODS.APP_ID = APP_ID;
                    foreach (var item in form.GOODS.GoodsList)
                    {
                        item.APP_ID = APP_ID;
                        item.ADD_TIME = DateTime.Now;
                        item.ADD_FUN_CD = "WEB-APPLY";
                        item.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.UPD_TIME = DateTime.Now;
                        item.UPD_FUN_CD = "WEB-APPLY";
                        item.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        item.DEL_MK = "N";
                    }
                    form.GOODS.SaveGoodsList("SRL_NO");
                    #endregion

                    #region 檔案上傳
                    for (var k = 1; k <= 23; k++)
                    {
                        var kNo = k.TONotNullString().PadLeft(2, '0');
                        var fileNo = form.GetType().GetProperties().Where(m => m.Name == "DOC_FILE_" + kNo + "_FILENAME");
                        if (fileNo.ToCount() > 0)
                        {
                            var fileObj = fileNo.FirstOrDefault();
                            var fileVal = fileObj.GetValue(form);
                            if (!fileVal.TONotNullString().Equals(""))
                            {
                                Apply_FileModel file = new Apply_FileModel();
                                file.APP_ID = APP_ID;
                                file.FILE_NO = k;
                                file.FILENAME = fileVal.TONotNullString();
                                var FileList = file.FILENAME.ToSplit('/');
                                var FileName = FileList[FileList.ToCount() - 1];
                                file.SRC_FILENAME = FileName;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";
                                base.Insert(file);
                            }
                        }
                    }

                    #endregion

                    //var today = HelperUtil.DateTimeToTwString(DateTime.Now);
                    //BackApplyDAO backDao = new BackApplyDAO();
                    //string subject = "非感染性人體器官、組織及細胞進出口，案件編號﹕" + APP_ID + " 申請通知";
                    //string MailBody = "";
                    //string url = ConfigModel.NoticeMailUrl;
                    //MailBody += UserInfo.NAME + "，您好:<br/><br/>";
                    //MailBody += "您於民國" + today.Substring(0, 3) + "年" + today.Substring(4, 2) + "月" + today.Substring(7, 2) + "日申辦之非感染性人體器官、組織及細胞進出口申請作業<br/>";
                    //MailBody += "申請編號：<a href='" + url + "/Apply_001035/AppDoc?APP_ID=" + APP_ID + "'>" + APP_ID + "</a><br/>現在進度為'新收案件'<br/>";
                    //MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    //MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    //MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    //MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    //MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    //MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    //MailBody += "115204 臺北市南港區忠孝東路六段488號";

                    //backDao.SendMail(string.IsNullOrWhiteSpace(form.TAX_ORG_EMAIL) ? sm.UserInfo.Member.MAIL : form.TAX_ORG_EMAIL, subject, MailBody);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply001035 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }
        #endregion

        #region Apply_007001 信用卡線上捐款
        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply007001(Apply_007001FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel se = SessionModel.Get();
            var APP_ID = GetApp_ID(form.SRV_ID_DONATE);
            var paydt = dao.getPayInfo("007001");
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料                  
                    where.APP_ID = APP_ID;
                    where.SRV_ID = form.SRV_ID_DONATE;
                    where.SRC_SRV_ID = form.SRV_ID_DONATE;
                    where.UNIT_CD = 10;//醫事司 /社救司 unit_scd =10
                    where.ACC_NO = form.IDN;
                    where.IDN = form.IDN;
                    where.SEX_CD = form.IDN.Substring(2, 1) == "1" ? "M" : "F";
                    where.BIRTHDAY = form.BIRTHDAY;
                    where.NAME = form.DONOR_NAME;
                    where.TEL = form.DONOR_TEL;
                    where.MOBILE = form.MOBILE;
                    where.ADDR_CODE = form.ADDR_CODE;
                    where.ADDR = form.ADDR;
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = "";
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = "";
                    where.DEL_MK = "N";
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.AMOUNT.TOInt32();
                    if (form.PAY_METHOD == "S")
                    {
                        where.PAY_A_FEEBK = Int32.Parse(DataUtils.GetConfig("PAY_STORE_FEE"));
                    }
                    else
                    {
                        where.PAY_A_FEEBK = 0;
                    }
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "01";
                    where.APP_DISP_MK = "Y";
                    where.PRO_UNIT_CD = 10;
                    where.LOGIN_TYPE = se.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_007001Model app = new Apply_007001Model();
                    app.APP_ID = APP_ID;
                    app.REF_MEM_MK = form.REF_MEM_MK == false ? "N" : "Y";
                    app.DONOR_NAME = form.DONOR_NAME;
                    app.DONOR_IDN = form.DONOR_IDN;
                    app.PUBLIC_MK = form.PUBLIC_MK;
                    app.DONOR_MAIL = form.DONOR_MAIL;
                    app.DONOR_TEL = form.DONOR_TEL;
                    app.AMOUNT = form.AMOUNT.TOInt32();
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = form.IDN;
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = form.IDN;
                    app.DEL_MK = "N";

                    base.Insert(app);

                    // Insert 收據抬頭
                    Apply_007001_DataModel app_data = new Apply_007001_DataModel();
                    app_data.APP_ID = APP_ID;
                    app_data.REC_MK = form.REC_TITLE_CD == "" ? "N" : "Y";
                    app_data.REC_TITLE_CD = form.REC_TITLE_CD == "1" ? "1" : "2";
                    app_data.REC_TITLE = form.REC_TITLE;
                    app_data.REC_ADDR_1 = form.ADDR_CODE;
                    app_data.REC_ADDR_2 = form.ADDR;
                    app_data.DEL_MK = "N";
                    app_data.ADD_TIME = DateTime.Now;
                    app_data.ADD_FUN_CD = "WEB-APPLY";
                    app_data.ADD_ACC = form.IDN;
                    app_data.UPD_TIME = DateTime.Now;
                    app_data.UPD_FUN_CD = "WEB-APPLY";
                    app_data.UPD_ACC = form.IDN;
                    base.Insert(app_data);

                    #region 繳費資訊
                    // Insert 繳費資訊
                    APPLY_PAY pay_data = new APPLY_PAY();
                    pay_data.APP_ID = APP_ID;
                    pay_data.PAY_ID = APP_ID;
                    //pay_data.PAY_ID = PayUtils.GetVirtualAccount(APP_ID, 0);
                    pay_data.PAY_MONEY = form.AMOUNT.TOInt32();
                    if (form.PAY_METHOD == "S")
                    {
                        pay_data.PAY_PROFEE = Int32.Parse(DataUtils.GetConfig("PAY_STORE_FEE"));
                    }
                    else
                    {
                        pay_data.PAY_PROFEE = 0;
                    }
                    pay_data.PAY_ACT_TIME = DateTime.Now;
                    pay_data.PAY_METHOD = form.PAY_METHOD;
                    pay_data.PAY_STATUS_MK = "N";
                    pay_data.SESSION_KEY = APP_ID;
                    pay_data.CLIENT_IP = form.PayModel.ClientIp;
                    // 繳費後寫入
                    pay_data.PAY_EXT_TIME = null;
                    pay_data.PAY_INC_TIME = null;
                    pay_data.HOST_TIME = null;
                    pay_data.AUTH_DATE = null;
                    pay_data.AUTH_NO = null;
                    pay_data.ROC_ID = null;
                    pay_data.DEL_MK = "N";
                    pay_data.ADD_TIME = DateTime.Now;
                    pay_data.ADD_FUN_CD = "WEB-APPLY";
                    pay_data.ADD_ACC = form.IDN;
                    pay_data.UPD_TIME = DateTime.Now;
                    pay_data.UPD_FUN_CD = "WEB-APPLY";
                    pay_data.UPD_ACC = form.IDN;
                    base.Insert(pay_data);
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply007001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }
        /// <summary>
        /// 列印超商條碼單
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public byte[] ExportPayDonatePDF(string id)
        {
            Dictionary<string, object> data = null;
            byte[] result;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                FormAction action = new FormAction(conn);
                data = action.GetApplyDonateData(id);
                conn.Close();
                conn.Dispose();
            }

            Dictionary<string, string> dict = new Dictionary<string, string>();

            dict.Add("VirtualAccount", (string)data["SESSION_KEY"]);
            dict.Add("Fee", (Int32.Parse(data["PAY_A_FEE"].ToString()) + Int32.Parse(DataUtils.GetConfig("PAY_STORE_FEE"))).ToString());
            dict.Add("Name", data["NAME"].ToString());
            dict.Add("ServiceName", data["SRV_NAME"].ToString());
            dict.Add("ApplyId", data["APP_ID"].ToString());
            dict.Add("PayDeadline", ((DateTime)data["PAY_DEADLINE"]).ToString("yyyy/MM/dd"));

            DateTime dt = (DateTime)data["PAY_DEADLINE"];

            string[] b1 = PayUtils.GetStore(dt, dict["VirtualAccount"], Int32.Parse(dict["Fee"]));
            string[] b2 = PayUtils.GetPost(dt, dict["VirtualAccount"], Int32.Parse(dict["Fee"]));

            dict.Add("Store1", b1[0]);
            dict.Add("Store2", b1[1]);
            dict.Add("Store3", b1[2]);

            dict.Add("Post1", b2[0]);
            dict.Add("Post2", b2[1]);
            dict.Add("Post3", b2[2]);

            result = PayUtils.GetPDF(dict);

            return result;
        }
        /// <summary>
        /// 紀錄LinePayApi結果
        /// </summary>
        /// <param name="result"></param>
        /// <param name="model"></param>
        public void InsertLinePayResponseData(LinePayResponseViewModel result, Apply_007001FormModel model)
        {
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    TblAPIRESULT_DONATE iData = new TblAPIRESULT_DONATE();
                    iData.APP_ID = model.APP_ID;
                    iData.AMOUNT = model.AMOUNT.TOInt32();
                    iData.ADD_TIME = DateTime.Now;
                    iData.ADD_FUN_CD = "WEB-APPLY";
                    iData.ADD_ACC = model.IDN;
                    iData.PAYMENTACCESSTOKEN = result.info.paymentAccessToken;
                    iData.PAYMENTURLAPP = result.info.paymentUrl.app;
                    iData.PAYMENTURLWEB = result.info.paymentUrl.web;
                    iData.RETURNCODE = result.returnCode;
                    iData.RETURNMESSAGE = result.returnMessage;
                    iData.TRANSACTIONID = result.info.transactionId.TONotNullString();
                    base.Insert(iData);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("InsertLinePayResponseData failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }
        /// <summary>
        /// LinePay api成功捐款，回寫原資料表
        /// </summary>
        /// <param name="result"></param>
        /// <param name="model"></param>
        public void UpdateApply007001LinePay(LinePayResponseViewModel result, Apply_007001FormModel model)
        {
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    APPLY_PAY where = new APPLY_PAY();
                    where.APP_ID = model.APP_ID;
                    APPLY_PAY iData = new APPLY_PAY();
                    iData.APP_ID = model.APP_ID;
                    iData.PAY_EXT_TIME = DateTime.Now;
                    iData.PAY_INC_TIME = DateTime.Now;
                    iData.PAY_STATUS_MK = "Y";
                    iData.HOST_TIME = DateTime.Now;
                    iData.AUTH_DATE = DateTime.Now;
                    iData.AUTH_NO = result.info.transactionId.ToString();
                    iData.ROC_ID = model.IDN;
                    iData.UPD_TIME = DateTime.Now;
                    iData.UPD_FUN_CD = "WEB-APPLY";
                    iData.UPD_ACC = model.IDN;

                    base.Update(iData, where);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply007001LinePay failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }
        /// <summary>
        /// 中信信用卡或WebAtm api紀錄
        /// </summary>
        /// <param name="result"></param>
        /// <param name="model"></param>
        public void InsertCreditResponseData(Decrypt result, Apply_007001FormModel model)
        {
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    TblAPIRESULT_CREDIT cData = new TblAPIRESULT_CREDIT();
                    cData.APP_ID = result.OrderNo;
                    cData.AuthAmt = result.AuthAmt;
                    cData.AuthCode = result.AuthCode;
                    cData.AuthResURL = result.AuthResURL;
                    cData.AwardedPoint = result.AwardedPoint;
                    cData.CardNo = result.CardNo;
                    cData.CardNumber = result.CardNumber;
                    cData.EInovice = result.EInvoice;
                    cData.EncRes = result.EncRes;
                    cData.ErrCode = result.ErrCode;
                    cData.ErrDesc = result.ErrDesc;
                    cData.Last4digitPAN = result.Last4digitPAN;
                    cData.LastError = result.LastError.TONotNullString();
                    cData.NumberOfPay = result.NumberOfPay;
                    cData.OffsetAmt = result.OffsetAmt;
                    cData.OrderNo = result.OrderNo;
                    cData.OriginalAmt = result.OriginalAmt;
                    //cData.PidResult = "";
                    cData.PointBalance = result.PointBalance;
                    cData.ProdCode = result.ProdCode;
                    cData.Status = result.Status;
                    cData.txType = result.Option;
                    cData.UtilizedPoint = result.UtilizedPoint;
                    cData.XID = result.XID;
                    cData.ADD_TIME = DateTime.Now;
                    cData.ADD_FUN_CD = "WEB-APPLY";
                    cData.ADD_ACC = "";
                    cData.WebATMAcct = result.WebATMAcct;
                    cData.FeeCharge = result.FeeCharge;
                    cData.PayerBankId = result.PayerBankId;
                    base.Insert(cData);
                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("InsertCreditResponseData failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }
        /// <summary>
        /// 中信信用卡或WebAtm api成功捐款，回寫原資料表
        /// </summary>
        /// <param name="result"></param>
        /// <param name="model"></param>
        public void UpdateApply007001Credit(Decrypt result, Apply_007001FormModel model)
        {
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    APPLY_PAY where = new APPLY_PAY();
                    where.APP_ID = result.OrderNo;
                    APPLY_PAY iData = new APPLY_PAY();
                    iData.APP_ID = result.OrderNo;
                    iData.PAY_EXT_TIME = DateTime.Now;
                    iData.PAY_INC_TIME = DateTime.Now;
                    iData.PAY_STATUS_MK = "Y";
                    iData.HOST_TIME = DateTime.Now;
                    iData.AUTH_DATE = DateTime.Now;
                    iData.AUTH_NO = result.AuthCode;
                    iData.CARD_NO = result.CardNo;
                    //iData.ROC_ID = model.IDN;
                    iData.UPD_TIME = DateTime.Now;
                    iData.UPD_FUN_CD = "WEB-APPLY";
                    iData.UPD_ACC = "";

                    base.Update(iData, where);

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply007001Credit failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }
        #endregion

        #region Apply_010001 檔案應用申請

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply010001(Apply_010001FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "010001";
            var APP_ID = GetApp_ID(CaseNum);
            form.APP_ID = APP_ID;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.APP_EXT_DATE = this.GetNTFD("010001");
                    where.ADDR_CODE = form.ADDR;
                    where.ADDR = form.ADDR_ADDR;
                    where.TEL = form.TEL.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 69;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("010001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("010001");
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // CheckBox 另存
                    var CHECKNO_ITEMS_SP = form.CHECKNO_ITEMS.ToSplit(',');
                    TblAPPLY_010001_CHK ack = new TblAPPLY_010001_CHK();
                    foreach (var item in CHECKNO_ITEMS_SP)
                    {
                        ack = new TblAPPLY_010001_CHK();
                        ack.APP_ID = APP_ID;
                        ack.TYPE = "0";
                        ack.CHECKNO = item;
                        ack.SEQ_NO = 0;
                        ack.NOTE = form.CHECKNO_NOTE.TONotNullString();

                        base.Insert(ack);
                    }

                    #endregion

                    #region 010001案件
                    // Insert 案件
                    TblAPPLY_010001 app = new TblAPPLY_010001();
                    app.InjectFrom(form);
                    app.FILE_01 = form.NPIN_FILE_01_FILENAME;
                    app.FILE_02 = form.LPIN_FILE_02_FILENAME;
                    app.ADDR_CODE = form.ADDR;
                    app.ADDR = form.ADDR_ADDR;
                    app.AE_RELATION = form.NPIN_AE_RELATION.TONotNullString();
                    app.E_IDN = form.NPIN_E_IDN.TONotNullString();
                    app.E_MAIL = form.NPIN_E_MAIL.TONotNullString();
                    app.E_NAME = form.NPIN_E_NAME.TONotNullString();
                    app.E_TEL = form.NPIN_E_TEL.TONotNullString();
                    app.E_ADDR_CODE = form.NPIN_E_ADDR.TONotNullString();
                    app.E_ADDR = form.NPIN_E_ADDR_ADDR.TONotNullString();
                    app.E_BIRTHDAY = form.E_BIRTHDAY;
                    app.E_UNIT_ADDR_CODE = form.LPIN_E_UNIT_ADDR.TONotNullString();
                    app.E_UNIT_ADDR = form.LPIN_E_UNIT_ADDR_ADDR.TONotNullString();
                    app.E_UNIT_NAME = form.LPIN_E_UNIT_NAME.TONotNullString();
                    app.CHECK_FLAG = "N";
                    app.APP_ID = APP_ID;
                    app.APP_UNIT = 69;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    base.Insert(app);

                    #endregion

                    #region 申請檔案
                    var cnt = 1;
                    TblAPPLY_010001_APPFIL apl = new TblAPPLY_010001_APPFIL();
                    foreach (var item in form.APPFIL.GoodsList)
                    {
                        apl = new TblAPPLY_010001_APPFIL();
                        apl.APP_ID = APP_ID;
                        apl.SEQ_NO = cnt;
                        apl.NUMCNT = item.NUMCNT;
                        apl.FILENUM = item.FILENUM;
                        apl.FILENAME = item.FILENAME;
                        apl.ADD_TIME = DateTime.Now;
                        apl.ADD_FUN_CD = "WEB-APPLY";
                        apl.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.UPD_TIME = DateTime.Now;
                        apl.UPD_FUN_CD = "WEB-APPLY";
                        apl.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.DEL_MK = "N";

                        base.Insert(apl);

                        var CHECKNO_SP = item.CHECKNO_Lst.ToSplit(',');

                        foreach (var sp in CHECKNO_SP)
                        {
                            ack = new TblAPPLY_010001_CHK();
                            ack.APP_ID = APP_ID;
                            ack.TYPE = "1";
                            ack.CHECKNO = sp;
                            ack.SEQ_NO = cnt;

                            base.Insert(ack);
                        }

                        cnt++;
                    }

                    #endregion

                    #region 檔案上傳

                    if (!string.IsNullOrEmpty(form.NPIN_FILE_01_FILENAME))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = form.NPIN_FILE_01_FILENAME;
                        file.SRC_FILENAME = form.NPIN_FILE_01_FILENAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (!string.IsNullOrEmpty(form.LPIN_FILE_02_FILENAME))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = form.LPIN_FILE_02_FILENAME;
                        file.SRC_FILENAME = form.LPIN_FILE_02_FILENAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply010001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public void UpdateApply010001(Apply_010001DocModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", form.APP_ID);
            dict2.Add("SRV_ID", "010001");
            dict2.Add("LastMODTIME", LastMODTIME);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    var uploadFileName = "";
                    var uploadFileNo = 0;
                    TblAPPLY_010001_CHK whereCHK010001 = new TblAPPLY_010001_CHK();
                    whereCHK010001.APP_ID = form.APP_ID;
                    TblAPPLY_010001_CHK dataCHK010001 = new TblAPPLY_010001_CHK();
                    dataCHK010001.APP_ID = form.APP_ID;

                    #region APPLY_NOTICE

                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = form.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    #endregion

                    #region APPLY

                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = form.APP_ID;

                    ApplyModel where = new ApplyModel();
                    where.InjectFrom(form);
                    where.TEL = form.TEL;
                    where.APP_ID = form.APP_ID;
                    where.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    //where.ADDR = form.TAX_ORG_CITY_TEXT + form.TAX_ORG_CITY_DETAIL;
                    where.ADDR = form.TAX_ORG_CITY_DETAIL;
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.FLOW_CD = "3";

                    //base.Update(where, appwhere);
                    base.Update2(where, appwhere, dict2);
                    #endregion

                    #region APPLY_010001

                    TblAPPLY_010001 app010001where = new TblAPPLY_010001();
                    app010001where.APP_ID = form.APP_ID;

                    TblAPPLY_010001 app010001data = new TblAPPLY_010001();
                    app010001data.APP_ID = app010001data.APP_ID;
                    app010001data.APP_ROLE = form.APP_ROLE;
                    app010001data.NAME = form.NAME;
                    app010001data.BIRTHDAY = Convert.ToDateTime(form.BIRTHDAY_AD);
                    app010001data.IDN = form.IDN;
                    app010001data.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    app010001data.ADDR = form.TAX_ORG_CITY_DETAIL;
                    app010001data.TEL = form.TEL;
                    app010001data.MAIL = form.MAIL;
                    if (form.APP_ROLE == "1")
                    {
                        app010001data.A_AGENT = form.A_AGENT;
                        if (form.A_AGENT == "0")
                        {
                            app010001data.E_NAME = form.E_NAME;
                            app010001data.AE_RELATION = form.AE_RELATION;
                            app010001data.E_BIRTHDAY = Convert.ToDateTime(form.E_BIRTHDAY_AD);
                            app010001data.E_IDN = form.E_IDN;
                            app010001data.E_ADDR_CODE = form.E_TAX_ORG_CITY_CODE;
                            app010001data.E_ADDR = form.E_TAX_ORG_CITY_DETAIL;
                            app010001data.E_TEL = form.E_TEL;
                            app010001data.E_MAIL = form.E_MAIL;
                            if (form.newFILE_01 != null)
                            {
                                app010001data.FILE_01 = dao.PutFile("010001", form.newFILE_01, "1").Replace("\\", "/");
                                uploadFileName = app010001data.FILE_01;
                                uploadFileNo = 1;
                            }
                        }

                        if (form.A_AGENT == "1")
                        {
                            app010001data.E_UNIT_NAME = form.E_UNIT_NAME;
                            app010001data.E_UNIT_ADDR_CODE = form.E_UNIT_TAX_ORG_CITY_CODE;
                            app010001data.E_UNIT_ADDR = form.E_UNIT_TAX_ORG_CITY_DETAIL;
                            if (form.newFILE_02 != null)
                            {
                                app010001data.FILE_02 = dao.PutFile("010001", form.newFILE_02, "2").Replace("\\", "/");
                                uploadFileName = app010001data.FILE_02;
                                uploadFileNo = 2;
                            }
                        }
                    }

                    app010001data.APP_REASON = form.APP_REASON;
                    app010001data.UPD_TIME = DateTime.Now;
                    app010001data.UPD_FUN_CD = "WEB-APPLY";
                    app010001data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //base.Update(app010001data, app010001where);
                    base.Update2(app010001data, app010001where, dict2);
                    #endregion

                    #region APPLY_010001_APPFIL
                    TblAPPLY_010001_APPFIL whereAppFIL = new TblAPPLY_010001_APPFIL();
                    whereAppFIL.APP_ID = form.APP_ID;
                    base.Delete(whereAppFIL);

                    whereCHK010001.TYPE = "1";
                    base.Delete(whereCHK010001);

                    TblAPPLY_010001_APPFIL apl = new TblAPPLY_010001_APPFIL();
                    foreach (var item in form.APPFIL.GoodsList)
                    {
                        apl = new TblAPPLY_010001_APPFIL();
                        apl.APP_ID = form.APP_ID;
                        apl.SEQ_NO = item.SEQ_NO;
                        apl.NUMCNT = item.NUMCNT;
                        apl.FILENUM = item.FILENUM;
                        apl.FILENAME = item.FILENAME;
                        apl.ADD_TIME = DateTime.Now;
                        apl.ADD_FUN_CD = "WEB-APPLY";
                        apl.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.UPD_TIME = DateTime.Now;
                        apl.UPD_FUN_CD = "WEB-APPLY";
                        apl.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.DEL_MK = "N";

                        base.Insert(apl);

                        var CHECKNO_SP = item.CHECKNO_Lst.ToSplit(',');

                        foreach (var itemSP in CHECKNO_SP)
                        {
                            dataCHK010001.TYPE = "1";
                            dataCHK010001.CHECKNO = itemSP;
                            dataCHK010001.SEQ_NO = item.SEQ_NO;

                            base.Insert(dataCHK010001);
                        }
                    }


                    #endregion

                    #region APPLY_010001_CHK

                    whereCHK010001.TYPE = "0";
                    base.Delete(whereCHK010001);

                    var itemList = form.CHECK_NO_LIST.Split(',');

                    for (var i = 0; i < itemList.Length; i++)
                    {
                        dataCHK010001.TYPE = "0";
                        dataCHK010001.SEQ_NO = 0;
                        dataCHK010001.NOTE = form.CHECK_NO_NOTE;
                        dataCHK010001.CHECKNO = itemList[i];

                        base.Insert(dataCHK010001);
                    }

                    #endregion

                    #region APPLY_FILE
                    if (!string.IsNullOrWhiteSpace(uploadFileName))
                    {
                        Apply_FileModel whereFile = new Apply_FileModel();
                        whereFile.APP_ID = form.APP_ID;

                        Apply_FileModel newData = new Apply_FileModel();
                        newData.APP_ID = form.APP_ID;
                        newData.FILENAME = uploadFileName;
                        newData.SRC_FILENAME = uploadFileName;
                        newData.FILE_NO = uploadFileNo;
                        newData.UPD_TIME = DateTime.Now;
                        newData.UPD_FUN_CD = "WEB-APPLY";
                        newData.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Update(newData, whereFile);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply010001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        #endregion

        #region Apply_012001 檔案應用申請

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply012001(Apply_012001FormModel form)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "012001";
            var APP_ID = GetApp_ID(CaseNum);
            form.APP_ID = APP_ID;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    #region Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UserInfo);
                    where.APP_EXT_DATE = this.GetNTFD("012001");
                    where.ADDR_CODE = form.ADDR;
                    where.ADDR = form.ADDR_ADDR;
                    where.TEL = form.TEL.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 52;
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("012001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("012001");
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.PAY_POINT = "A";
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // CheckBox 另存
                    var CHECKNO_ITEMS_SP = form.CHECKNO_ITEMS.ToSplit(',');
                    TblAPPLY_012001_CHK ack = new TblAPPLY_012001_CHK();
                    foreach (var item in CHECKNO_ITEMS_SP)
                    {
                        ack = new TblAPPLY_012001_CHK();
                        ack.APP_ID = APP_ID;
                        ack.TYPE = "0";
                        ack.CHECKNO = item;
                        ack.SEQ_NO = 0;
                        ack.NOTE = form.CHECKNO_NOTE.TONotNullString();

                        base.Insert(ack);
                    }

                    #endregion

                    #region 012001案件
                    // Insert 案件
                    TblAPPLY_012001 app = new TblAPPLY_012001();
                    app.InjectFrom(form);
                    app.FILE_01 = form.NPIN_FILE_01_FILENAME;
                    app.FILE_02 = form.LPIN_FILE_02_FILENAME;
                    app.ADDR_CODE = form.ADDR;
                    app.ADDR = form.ADDR_ADDR;
                    app.AE_RELATION = form.NPIN_AE_RELATION.TONotNullString();
                    app.E_IDN = form.NPIN_E_IDN.TONotNullString();
                    app.E_MAIL = form.NPIN_E_MAIL.TONotNullString();
                    app.E_NAME = form.NPIN_E_NAME.TONotNullString();
                    app.E_TEL = form.NPIN_E_TEL.TONotNullString();
                    app.E_ADDR_CODE = form.NPIN_E_ADDR.TONotNullString();
                    app.E_ADDR = form.NPIN_E_ADDR_ADDR.TONotNullString();
                    app.E_BIRTHDAY = form.E_BIRTHDAY;
                    app.E_UNIT_ADDR_CODE = form.LPIN_E_UNIT_ADDR.TONotNullString();
                    app.E_UNIT_ADDR = form.LPIN_E_UNIT_ADDR_ADDR.TONotNullString();
                    app.E_UNIT_NAME = form.LPIN_E_UNIT_NAME.TONotNullString();
                    app.CHECK_FLAG = "N";
                    app.APP_ID = APP_ID;
                    app.APP_UNIT = 69;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = "WEB-APPLY";
                    app.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = "WEB-APPLY";
                    app.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    base.Insert(app);

                    #endregion

                    #region 申請檔案
                    var cnt = 1;
                    TblAPPLY_012001_APPFIL apl = new TblAPPLY_012001_APPFIL();
                    foreach (var item in form.APPFIL.GoodsList)
                    {
                        apl = new TblAPPLY_012001_APPFIL();
                        apl.APP_ID = APP_ID;
                        apl.SEQ_NO = cnt;
                        apl.NUMCNT = item.NUMCNT;
                        apl.FILENUM = item.FILENUM;
                        apl.FILENAME = item.FILENAME;
                        apl.ADD_TIME = DateTime.Now;
                        apl.ADD_FUN_CD = "WEB-APPLY";
                        apl.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.UPD_TIME = DateTime.Now;
                        apl.UPD_FUN_CD = "WEB-APPLY";
                        apl.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.DEL_MK = "N";

                        base.Insert(apl);

                        var CHECKNO_SP = item.CHECKNO_Lst.ToSplit(',');

                        foreach (var sp in CHECKNO_SP)
                        {
                            ack = new TblAPPLY_012001_CHK();
                            ack.APP_ID = APP_ID;
                            ack.TYPE = "1";
                            ack.CHECKNO = sp;
                            ack.SEQ_NO = cnt;

                            base.Insert(ack);
                        }

                        cnt++;
                    }

                    #endregion

                    #region 檔案上傳

                    if (!string.IsNullOrEmpty(form.NPIN_FILE_01_FILENAME))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = form.NPIN_FILE_01_FILENAME;
                        file.SRC_FILENAME = form.NPIN_FILE_01_FILENAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    if (!string.IsNullOrEmpty(form.LPIN_FILE_02_FILENAME))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = form.LPIN_FILE_02_FILENAME;
                        file.SRC_FILENAME = form.LPIN_FILE_02_FILENAME;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = "WEB-APPLY";
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = "WEB-APPLY";
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply012001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public void UpdateApply012001(Apply_012001DocModel form)
        {
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", form.APP_ID);
            dict2.Add("SRV_ID", "012001");
            dict2.Add("LastMODTIME", LastMODTIME);
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    var uploadFileName = "";
                    var uploadFileNo = 0;
                    TblAPPLY_012001_CHK whereCHK012001 = new TblAPPLY_012001_CHK();
                    whereCHK012001.APP_ID = form.APP_ID;
                    TblAPPLY_012001_CHK dataCHK012001 = new TblAPPLY_012001_CHK();
                    dataCHK012001.APP_ID = form.APP_ID;

                    #region APPLY_NOTICE

                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = form.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update(andata, anwhere);

                    #endregion

                    #region APPLY

                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = form.APP_ID;

                    ApplyModel where = new ApplyModel();
                    where.InjectFrom(form);
                    where.TEL = form.TEL;
                    where.APP_ID = form.APP_ID;
                    where.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    where.ADDR = form.TAX_ORG_CITY_DETAIL;
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.FLOW_CD = "3";

                    //base.Update(where, appwhere);
                    base.Update2(where, appwhere, dict2);
                    #endregion

                    #region APPLY_012001

                    TblAPPLY_012001 app012001where = new TblAPPLY_012001();
                    app012001where.APP_ID = form.APP_ID;

                    TblAPPLY_012001 app012001data = new TblAPPLY_012001();
                    app012001data.APP_ID = form.APP_ID;
                    app012001data.APP_ROLE = form.APP_ROLE;
                    app012001data.A_AGENT = form.A_AGENT;
                    app012001data.NAME = form.NAME;
                    app012001data.BIRTHDAY = Convert.ToDateTime(form.BIRTHDAY_AD);
                    app012001data.IDN = form.IDN;
                    app012001data.ADDR_CODE = form.TAX_ORG_CITY_CODE;
                    app012001data.ADDR = form.TAX_ORG_CITY_DETAIL;
                    app012001data.TEL = form.TEL;
                    app012001data.MAIL = form.MAIL;
                    if (form.APP_ROLE == "1")
                    {
                        app012001data.A_AGENT = form.A_AGENT;
                        if (form.A_AGENT == "0")
                        {
                            app012001data.E_NAME = form.E_NAME;
                            app012001data.AE_RELATION = form.AE_RELATION;
                            app012001data.E_BIRTHDAY = Convert.ToDateTime(form.E_BIRTHDAY_AD);
                            app012001data.E_IDN = form.E_IDN;
                            app012001data.E_ADDR_CODE = form.E_TAX_ORG_CITY_CODE;
                            app012001data.E_ADDR = form.E_TAX_ORG_CITY_DETAIL;
                            app012001data.E_TEL = form.E_TEL;
                            app012001data.E_MAIL = form.E_MAIL;
                            if (form.newFILE_01 != null)
                            {
                                app012001data.FILE_01 = dao.PutFile("012001", form.newFILE_01, "1").Replace("\\", "/");
                                uploadFileName = app012001data.FILE_01;
                                uploadFileNo = 1;
                            }
                        }
                        if (form.A_AGENT == "1")
                        {
                            app012001data.E_UNIT_NAME = form.E_UNIT_NAME;
                            app012001data.E_UNIT_ADDR_CODE = form.E_UNIT_TAX_ORG_CITY_CODE;
                            app012001data.E_UNIT_ADDR = form.E_UNIT_TAX_ORG_CITY_DETAIL;
                            if (form.newFILE_02 != null)
                            {
                                app012001data.FILE_02 = dao.PutFile("010001", form.newFILE_02, "2").Replace("\\", "/");
                                uploadFileName = app012001data.FILE_02;
                                uploadFileNo = 2;
                            }
                        }
                    }
                    //base.Update(app012001data, app012001where);
                    base.Update2(app012001data, app012001where, dict2);
                    #endregion

                    #region APPLY_012001_APPFIL
                    TblAPPLY_012001_APPFIL whereAppFIL = new TblAPPLY_012001_APPFIL();
                    whereAppFIL.APP_ID = form.APP_ID;
                    base.Delete(whereAppFIL);

                    whereCHK012001.TYPE = "1";
                    base.Delete(whereCHK012001);

                    TblAPPLY_012001_APPFIL apl = new TblAPPLY_012001_APPFIL();
                    foreach (var item in form.APPFIL.GoodsList)
                    {
                        apl = new TblAPPLY_012001_APPFIL();
                        apl.APP_ID = form.APP_ID;
                        apl.SEQ_NO = item.SEQ_NO;
                        apl.NUMCNT = item.NUMCNT;
                        apl.FILENUM = item.FILENUM;
                        apl.FILENAME = item.FILENAME;
                        apl.ADD_TIME = DateTime.Now;
                        apl.ADD_FUN_CD = "WEB-APPLY";
                        apl.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.UPD_TIME = DateTime.Now;
                        apl.UPD_FUN_CD = "WEB-APPLY";
                        apl.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        apl.DEL_MK = "N";

                        base.Insert(apl);

                        var CHECKNO_SP = item.CHECKNO_Lst.ToSplit(',');

                        foreach (var itemSP in CHECKNO_SP)
                        {
                            dataCHK012001.TYPE = "1";
                            dataCHK012001.CHECKNO = itemSP;
                            dataCHK012001.SEQ_NO = item.SEQ_NO;

                            base.Insert(dataCHK012001);
                        }
                    }


                    #endregion

                    #region APPLY_012001_CHK

                    whereCHK012001.TYPE = "0";
                    base.Delete(whereCHK012001);

                    var itemList = form.CHECK_NO_LIST.Split(',');

                    for (var i = 0; i < itemList.Length; i++)
                    {
                        dataCHK012001.TYPE = "0";
                        dataCHK012001.SEQ_NO = 0;
                        dataCHK012001.NOTE = form.CHECK_NO_NOTE;
                        dataCHK012001.CHECKNO = itemList[i];

                        base.Insert(dataCHK012001);
                    }

                    #endregion

                    #region APPLY_FILE
                    if (!string.IsNullOrWhiteSpace(uploadFileName))
                    {
                        Apply_FileModel whereFile = new Apply_FileModel();
                        whereFile.APP_ID = form.APP_ID;

                        Apply_FileModel newData = new Apply_FileModel();
                        newData.APP_ID = form.APP_ID;
                        newData.FILENAME = uploadFileName;
                        newData.SRC_FILENAME = uploadFileName;
                        newData.FILE_NO = uploadFileNo;
                        newData.UPD_TIME = DateTime.Now;
                        newData.UPD_FUN_CD = "WEB-APPLY";
                        newData.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                        base.Update(newData, whereFile);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply012001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        #endregion

        #region Apply_011007 社工師證書核發（中文）

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011007(Apply_011007FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UsrMember = sm.UserInfo.Member;
            string s_SRV_ID = "011007";
            string s_FUN_CD1 = "WEB-APPLY";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo(s_SRV_ID);
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    //申請時費用-APP_FEE
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    //付款方式-PAY_METHOD
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    //繳費時機點-A:不需繳費/B:/C:/D:審核後繳費-PAY_POINT
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UsrMember);

                    //where.ADDR_CODE = form.ADDR_CODE;
                    //where.ADDR = form.ADDR;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    string HTEL = "";
                    if (form.H_TEL_0.TONotNullString() != "" && form.H_TEL_1.TONotNullString() != "")
                    {
                        HTEL = form.H_TEL_0.TONotNullString() + "-" + form.H_TEL_1.TONotNullString();
                        if (form.H_TEL_2.TONotNullString() != "")
                        {
                            HTEL += "#" + form.H_TEL_2.TONotNullString();
                        }
                    }
                    string WTEL = "";
                    if (form.W_TEL_0.TONotNullString() != "" && form.W_TEL_1.TONotNullString() != "")
                    {
                        WTEL = form.W_TEL_0.TONotNullString() + "-" + form.W_TEL_1.TONotNullString();
                        if (form.W_TEL_2.TONotNullString() != "")
                        {
                            WTEL += "#" + form.W_TEL_2.TONotNullString();
                        }
                    }
                    string MOBILE = form.MOBILE.TONotNullString();

                    where.SEX_CD = form.SEX_CD;
                    where.TEL = (HTEL.TONotNullString() != "") ? HTEL.TONotNullString() : ((WTEL.TONotNullString() != "") ? WTEL.TONotNullString() : MOBILE.TONotNullString());
                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.UNIT_CD = 8; //社會救助及社工司-UNIT
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId(s_SRV_ID);
                    where.PRO_UNIT_CD = GetServiceFixUnitCd(s_SRV_ID);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1"; //1:新案收件3:補件收件
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_011007Model app_SN_data = new Apply_011007Model();
                    app_SN_data.InjectFrom(form);

                    app_SN_data.APPLY_DATE = form.APPLY_DATE;
                    app_SN_data.EMAIL = form.EMAIL;
                    app_SN_data.W_TEL = WTEL;
                    app_SN_data.H_TEL = HTEL;
                    app_SN_data.MOBILE = MOBILE;

                    app_SN_data.C_ZIPCODE = form.C_ZIPCODE;
                    app_SN_data.C_ADDR = form.C_ADDR;
                    app_SN_data.H_ZIPCODE = form.H_ZIPCODE;
                    app_SN_data.H_ADDR = form.H_ADDR;
                    app_SN_data.H_EQUAL = form.H_EQUAL;

                    app_SN_data.TEST_YEAR = form.TEST_YEAR;
                    app_SN_data.TEST_CATEGORY = form.TEST_CATEGORY;
                    app_SN_data.MERGEYN = form.MERGEYN;

                    app_SN_data.APP_ID = APP_ID;
                    app_SN_data.ADD_TIME = DateTime.Now;
                    app_SN_data.ADD_FUN_CD = s_FUN_CD1;
                    app_SN_data.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app_SN_data.DEL_MK = "N";

                    app_SN_data.FILE_IDNF = "1";
                    app_SN_data.FILE_IDNB = "2";
                    app_SN_data.FILE_PHOTO = "3";
                    app_SN_data.FILE_PASSCOPY = "4";
                    base.Insert(app_SN_data);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNF, app_SN_data.FILE_IDNF);
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNB, app_SN_data.FILE_IDNB);
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 3;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PHOTO, app_SN_data.FILE_PHOTO);
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 4;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PASSCOPY, app_SN_data.FILE_PASSCOPY);
                        file.SRC_FILENAME = form.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = 1; //(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011007 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011007AppDocModel GetFile_011007(string APP_ID)
        {
            Apply_011007AppDocModel result = new Apply_011007AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_PHOTO_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_PASSCOPY_TEXT
    FROM APPLY app 
    where 1=1 
    and app.APP_ID = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011007AppDocModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 更新案件-補件儲存
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011007(Apply_011007AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string s_FUN_CD1 = "WEB-APPLY";
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "011007";
            //增加歷程，需要下列參數
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0;
            int iSRC_NO = 2; //補件由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);

                    //TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    //an.APP_ID = model.APP_ID;
                    //an.ISADDYN = "N";
                    //var getan = GetRowList(an);
                    //var getan = 1;
                    //if (!string.IsNullOrEmpty(model.MAILBODY)) { getan = model.MAILBODY.splitHTML("<tr/>").ToCount(); }
                    //Count = getan - 1;

                    string HTEL = "";
                    if (model.H_TEL_0.TONotNullString() != "" && model.H_TEL_1.TONotNullString() != "")
                    {
                        HTEL = model.H_TEL_0.TONotNullString() + "-" + model.H_TEL_1.TONotNullString();
                        if (model.H_TEL_2.TONotNullString() != "")
                        {
                            HTEL += "#" + model.H_TEL_2.TONotNullString();
                        }
                    }
                    string WTEL = "";
                    if (model.W_TEL_0.TONotNullString() != "" && model.W_TEL_1.TONotNullString() != "")
                    {
                        WTEL = model.W_TEL_0.TONotNullString() + "-" + model.W_TEL_1.TONotNullString();
                        if (model.W_TEL_2.TONotNullString() != "")
                        {
                            WTEL += "#" + model.W_TEL_2.TONotNullString();
                        }
                    }
                    string MOBILE = model.MOBILE.TONotNullString();

                    //更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update2(andata, anwhere, dict2);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = (HTEL.TONotNullString() != "") ? HTEL.TONotNullString() : ((WTEL.TONotNullString() != "") ? WTEL.TONotNullString() : MOBILE.TONotNullString());
                    appdata.MOBILE = MOBILE;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8; //社會救助及社工司-UNIT
                    appdata.FLOW_CD = "3";//1:新案收件3:補件收件
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(appdata, appwhere, dict2);
                    //儲存
                    //Update(appdata, appwhere);

                    Apply_011007Model app_SN_where = new Apply_011007Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011007Model app_SN_data = new Apply_011007Model();
                    app_SN_data.InjectFrom(model);
                    app_SN_data.W_TEL = WTEL;
                    app_SN_data.H_TEL = HTEL;
                    app_SN_data.MOBILE = MOBILE;
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //app_SN_data.DEL_MK = "N";
                    app_SN_data.FILE_IDNF = "1";
                    app_SN_data.FILE_IDNB = "2";
                    app_SN_data.FILE_PHOTO = "3";
                    app_SN_data.FILE_PASSCOPY = "4";
                    //儲存
                    //Update(app_SN_data, app_SN_where);
                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNF, app_SN_data.FILE_IDNF);
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNB, app_SN_data.FILE_IDNB);
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PHOTO, app_SN_data.FILE_PHOTO);
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PASSCOPY, app_SN_data.FILE_PASSCOPY);
                        file.SRC_FILENAME = model.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011007 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }
        #endregion

        #region Apply_011008 社工師證書換發（更名或汙損） （1:更名或2:汙損）

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011008(Apply_011008FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UsrMember = sm.UserInfo.Member;

            string s_SRV_ID = "011008";
            string s_FUN_CD1 = "WEB-APPLY";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo(s_SRV_ID);
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    //申請時費用-APP_FEE
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    //付款方式
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    //繳費時機點-A:不需繳費/B:/C:/D:審核後繳費
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UsrMember);

                    //where.ADDR_CODE = form.ADDR_CODE;
                    //where.ADDR = form.ADDR;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    string htel2 = form.H_TEL_2.TONotNullString() == "" ? "" : $"#{form.H_TEL_2.TONotNullString()}";
                    string wtel2 = form.W_TEL_2.TONotNullString() == "" ? "" : $"#{form.W_TEL_2.TONotNullString()}";
                    string HTEL = form.H_TEL_0.TONotNullString() == "" ? "" : $"{form.H_TEL_0.TONotNullString()}-{form.H_TEL_1.TONotNullString()}{htel2}";
                    string WTEL = form.W_TEL_0.TONotNullString() == "" ? "" : $"{form.W_TEL_0.TONotNullString()}-{form.W_TEL_1.TONotNullString()}{wtel2}";
                    string MOBILE = form.MOBILE.TONotNullString();

                    where.SEX_CD = form.SEX_CD;
                    where.TEL = (HTEL.TONotNullString() != "") ? HTEL.TONotNullString() : ((WTEL.TONotNullString() != "") ? WTEL.TONotNullString() : MOBILE.TONotNullString());
                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.UNIT_CD = 8; //社會救助及社工司-UNIT
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId(s_SRV_ID);
                    where.PRO_UNIT_CD = GetServiceFixUnitCd(s_SRV_ID);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1";
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_011008Model app = new Apply_011008Model();
                    app.InjectFrom(form);

                    app.APPLY_TYPE = form.APPLY_TYPE;
                    app.CHG_NAME = form.CHG_NAME;

                    app.APPLY_DATE = form.APPLY_DATE;
                    app.EMAIL = form.EMAIL;
                    app.W_TEL = WTEL;
                    app.H_TEL = HTEL;
                    app.MOBILE = MOBILE;

                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.H_ADDR = form.H_ADDR;
                    app.H_EQUAL = form.H_EQUAL;

                    app.TEST_YEAR = form.TEST_YEAR;
                    app.TEST_CATEGORY = form.TEST_CATEGORY;
                    app.MERGEYN = form.MERGEYN;

                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = s_FUN_CD1;
                    app.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = s_FUN_CD1;
                    app.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    app.FILE_IDNF = "1";
                    app.FILE_IDNB = "2";
                    app.FILE_PHOTO = "3";
                    app.FILE_PASSCOPY = "4";
                    app.FILE_HOUSEHOLD = "5";
                    base.Insert(app);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間-交易時間
                    pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNF, app.FILE_IDNF);
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNB, app.FILE_IDNB);
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PHOTO, app.FILE_PHOTO);
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PASSCOPY, app.FILE_PASSCOPY);
                        file.SRC_FILENAME = form.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_HOUSEHOLD, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_HOUSEHOLD, app.FILE_HOUSEHOLD);
                        file.SRC_FILENAME = form.FILE_HOUSEHOLD_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011008 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011008AppDocModel GetFile_011008(string APP_ID)
        {
            Apply_011008AppDocModel result = new Apply_011008AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_PHOTO_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_PASSCOPY_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'5') FILE_HOUSEHOLD_TEXT
    FROM APPLY app 
    where 1=1 
    and app.app_id = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011008AppDocModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011008DetailModel GetDetailFile_011008(string APP_ID)
        {
            Apply_011008DetailModel result = new Apply_011008DetailModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_PHOTO_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_PASSCOPY_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'5') FILE_HOUSEHOLD_TEXT
    FROM APPLY app 
    where 1=1 
    and app.app_id = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011008DetailModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011008(Apply_011008AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "011008";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0; //補件數
            int iSRC_NO = 2; //補件序號由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update2(andata, anwhere, dict2);
                    string htel2 = model.H_TEL_2.TONotNullString() == "" ? "" : $"#{model.H_TEL_2.TONotNullString()}";
                    string wtel2 = model.W_TEL_2.TONotNullString() == "" ? "" : $"#{model.W_TEL_2.TONotNullString()}";
                    string HTEL = model.H_TEL_0.TONotNullString() == "" ? "" : $"{model.H_TEL_0.TONotNullString()}-{model.H_TEL_1.TONotNullString()}{htel2}";
                    string WTEL = model.W_TEL_0.TONotNullString() == "" ? "" : $"{model.W_TEL_0.TONotNullString()}-{model.W_TEL_1.TONotNullString()}{wtel2}";
                    string MOBILE = model.MOBILE.TONotNullString();

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.TEL = (HTEL.TONotNullString() != "") ? HTEL.TONotNullString() : ((WTEL.TONotNullString() != "") ? WTEL.TONotNullString() : MOBILE.TONotNullString());
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8;
                    appdata.FLOW_CD = "3";
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(appdata, appwhere, dict2);

                    Apply_011008Model app_SN_where = new Apply_011008Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011008Model app_SN_data = new Apply_011008Model();
                    app_SN_data.InjectFrom(model);
                    app_SN_data.H_TEL = HTEL;
                    app_SN_data.W_TEL = WTEL;
                    app_SN_data.MOBILE = MOBILE;
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //app_SN_data.DEL_MK = "N";
                    app_SN_data.FILE_IDNF = "1";
                    app_SN_data.FILE_IDNB = "2";
                    app_SN_data.FILE_PHOTO = "3";
                    app_SN_data.FILE_PASSCOPY = "4";
                    app_SN_data.FILE_HOUSEHOLD = "5";
                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);
                    //儲存
                    //Update(app_SN_data, app_SN_where);

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNF, app_SN_data.FILE_IDNF);
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNB, app_SN_data.FILE_IDNB);
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PHOTO, app_SN_data.FILE_PHOTO);
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PASSCOPY, app_SN_data.FILE_PASSCOPY);
                        file.SRC_FILENAME = model.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_HOUSEHOLD, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_HOUSEHOLD.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_HOUSEHOLD, app_SN_data.FILE_HOUSEHOLD);
                        file.SRC_FILENAME = model.FILE_HOUSEHOLD_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011008 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }
        #endregion

        #region Apply_011009 (衛福部)社工師證書補發（遺失）

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011009(Apply_011009FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UsrMember = sm.UserInfo.Member;
            string s_SRV_ID = "011009";
            string s_FUN_CD1 = "WEB-APPLY";
            // var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo(s_SRV_ID);
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    //申請時費用-APP_FEE
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    //付款方式-PAY_METHOD
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    //繳費時機點-A:不需繳費/B:/C:/D:審核後繳費-PAY_POINT
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UsrMember);

                    //where.ADDR_CODE = form.ADDR_CODE;
                    //where.ADDR = form.ADDR;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    string HTEL = $"{form.H_TEL_0.TONotNullString()}-{form.H_TEL_1.TONotNullString()}#{form.H_TEL_2.TONotNullString()}";
                    string WTEL = $"{form.W_TEL_0.TONotNullString()}-{form.W_TEL_1.TONotNullString()}#{form.W_TEL_2.TONotNullString()}";
                    string MOBILE = form.MOBILE.TONotNullString();

                    //if (HTEL.TONotNullString() != "") where.TEL = HTEL.TONotNullString();
                    //else if (WTEL.TONotNullString() != "") where.TEL = WTEL.TONotNullString();
                    //else where.TEL = MOBILE.TONotNullString();

                    where.SEX_CD = form.SEX_CD;
                    where.TEL = (HTEL.TONotNullString() != "") ? HTEL.TONotNullString() : ((WTEL.TONotNullString() != "") ? WTEL.TONotNullString() : MOBILE.TONotNullString());
                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.UNIT_CD = 8; //社會救助及社工司-UNIT
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId(s_SRV_ID);
                    where.PRO_UNIT_CD = GetServiceFixUnitCd(s_SRV_ID);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1"; //1:新案收件3:補件收件
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_011009Model app = new Apply_011009Model();
                    app.InjectFrom(form);

                    app.APPLY_DATE = form.APPLY_DATE;
                    app.EMAIL = form.EMAIL;
                    app.W_TEL = WTEL;
                    app.H_TEL = HTEL;
                    app.MOBILE = MOBILE;

                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.H_ADDR = form.H_ADDR;
                    app.H_EQUAL = form.H_EQUAL;

                    app.TEST_YEAR = form.TEST_YEAR;
                    app.TEST_CATEGORY = form.TEST_CATEGORY;
                    app.MERGEYN = form.MERGEYN;

                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = s_FUN_CD1;
                    app.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = s_FUN_CD1;
                    app.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    app.FILE_IDNF = "1";
                    app.FILE_IDNB = "2";
                    app.FILE_PHOTO = "3";
                    app.FILE_PASSCOPY = "4";
                    base.Insert(app);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNF, app.FILE_IDNF);
                        file.SRC_FILENAME = form.FILE_IDNF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDNB, app.FILE_IDNB);
                        file.SRC_FILENAME = form.FILE_IDNB_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PHOTO, app.FILE_PHOTO);
                        file.SRC_FILENAME = form.FILE_PHOTO_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PASSCOPY, app.FILE_PASSCOPY);
                        file.SRC_FILENAME = form.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply011009 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011009AppDocModel GetFile_011009(string APP_ID)
        {
            Apply_011009AppDocModel result = new Apply_011009AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_PHOTO_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_PASSCOPY_TEXT
    FROM APPLY app 
    where 1=1 
    and app.APP_ID = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011009AppDocModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011009DetailModel GetDetailFile_011009(string APP_ID)
        {
            Apply_011009DetailModel result = new Apply_011009DetailModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_PHOTO_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_PASSCOPY_TEXT
    FROM APPLY app 
    where 1=1 
    and app.app_id = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011009DetailModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011009(Apply_011009AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "011009";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0; //補件數
            int iSRC_NO = 2; //補件序號由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);

                    // 取得補件件數
                    //TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    //an.APP_ID = model.APP_ID;
                    //an.ISADDYN = "N";
                    //var getan = GetRowList(an);
                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update2(andata, anwhere, dict2);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    var HTEL = $"{model.H_TEL_0.TONotNullString()}-{model.H_TEL_1.TONotNullString()}";
                    var WTEL = $"{model.W_TEL_0.TONotNullString()}-{model.W_TEL_1.TONotNullString()}";
                    HTEL = string.IsNullOrWhiteSpace(model.H_TEL_2.TONotNullString()) ? HTEL : HTEL + "#" + model.H_TEL_2.TONotNullString();
                    WTEL = string.IsNullOrWhiteSpace(model.W_TEL_2.TONotNullString()) ? WTEL : WTEL + "#" + model.W_TEL_2.TONotNullString();
                    var MOBILE = model.MOBILE.TONotNullString();
                    if (HTEL.TONotNullString() != "") appdata.TEL = HTEL.TONotNullString();
                    else if (WTEL.TONotNullString() != "") appdata.TEL = WTEL.TONotNullString();
                    else appdata.TEL = MOBILE.TONotNullString();
                    appdata.MOBILE = MOBILE;
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8; //社會救助及社工司-UNIT
                    appdata.FLOW_CD = "3";//1:新案收件3:補件收件
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(appdata, appwhere, dict2);

                    Apply_011009Model app_SN_where = new Apply_011009Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011009Model app_SN_data = new Apply_011009Model();
                    app_SN_data.InjectFrom(model);
                    app_SN_data.H_TEL = HTEL;
                    app_SN_data.W_TEL = WTEL;
                    app_SN_data.MOBILE = MOBILE;
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //app_SN_data.DEL_MK = "N";
                    app_SN_data.FILE_IDNF = "1";
                    app_SN_data.FILE_IDNB = "2";
                    app_SN_data.FILE_PHOTO = "3";
                    app_SN_data.FILE_PASSCOPY = "4";
                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);
                    //儲存
                    //Update(app_SN_data, app_SN_where);

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNF, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNF, app_SN_data.FILE_IDNF);
                        file.SRC_FILENAME = model.FILE_IDNF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDNB, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDNB, app_SN_data.FILE_IDNB);
                        file.SRC_FILENAME = model.FILE_IDNB_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PHOTO, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PHOTO.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PHOTO, app_SN_data.FILE_PHOTO);
                        file.SRC_FILENAME = model.FILE_PHOTO_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_PASSCOPY, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_PASSCOPY.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PASSCOPY, app_SN_data.FILE_PASSCOPY);
                        file.SRC_FILENAME = model.FILE_PASSCOPY_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011009 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }
        #endregion

        #region Apply_001008 醫事人員請領英文證明書
        /// <summary>
        /// 信卡繳費
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public bool RunCreditCardTranx(Apply_001008FormModel model)
        {
            bool result = false;
            string srvID = "001008";
            string srvName = "醫事人員或公共衛生師請領英文證明書";
            string appID = model.APP_ID;
            string funCD = "WEB-APPLY";
            int index = 1;

            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            conn = null;
            serviceWhere.SRV_ID = srvID;
            service = this.GetRow<TblSERVICE>(serviceWhere);

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase(srvID);
                    MapUtils data = new MapUtils();

                    data.Put("PAY_METHOD", "C");
                    data.Put("PAY_CARD_IDN", model.CARD_IDN == null ? "" : model.CARD_IDN);
                    data.Put("PAY_A_FEEBK", "0");
                    data.Put("APP_FEE", model.PAY_A_FEE.ToString());
                    data.Put("PAY_ID", appID);
                    data.Put("PAY_CLIENT_IP", model.CLIENT_IP);

                    Dictionary<string, string> pay = DataUtils.GetPayAccount(Convert.ToInt32(form["PAY_ACCOUNT"]));
                    data.Put("PAY_OID", pay["OID"]);
                    data.Put("PAY_SID", pay["SID"]);

                    #region 繳費

                    #region 案件主檔資料(update apply)
                    ApplyModel apply = new ApplyModel();
                    ApplyModel applyWhere = new ApplyModel();
                    apply.APP_ID = appID;
                    apply.InjectFrom(UserInfo);
                    //apply.InjectFrom(model);                
                    apply.IDN = model.IDN;
                    apply.NAME = model.NAME;
                    apply.ADDR_CODE = model.ADDR_ZIP;
                    apply.ADDR = model.ADDR_ZIP_DETAIL;
                    apply.TEL = model.TEL;
                    apply.MOBILE = model.MOBILE;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = "C";
                    apply.CARD_IDN = model.CARD_IDN;
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = funCD;
                    apply.SRV_ID = "001008";
                    apply.SRC_SRV_ID = "001008";
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.IDN = UserInfo.IDN;
                    apply.APP_EXT_DATE = this.GetNTFD("001008");
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    //this.Update(apply, applyWhere);
                    Insert(apply);

                    #endregion

                    #region 醫事人員請領英文證明書(insert apply_001008)
                    //insert Apply_001008
                    Apply_001008Model apply001008 = new Apply_001008Model();
                    apply001008.APP_ID = appID;
                    apply001008.ENAME_ALIAS = model.ENAME_ALIAS;
                    apply001008.COPIES = this.GetCopies_001008(model);
                    apply001008.TOTAL_MEM = Int32.Parse(model.TOTAL_MEM);
                    apply001008.REMARK = model.REMARK;
                    apply001008.EMAIL = model.EMAIL;
                    apply001008.ADD_TIME = DateTime.Now;
                    apply001008.ADD_FUN_CD = funCD;
                    apply001008.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001008.UPD_TIME = DateTime.Now;
                    apply001008.UPD_FUN_CD = funCD;
                    apply001008.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001008.DEL_MK = "N";
                    this.Insert(apply001008);
                    #endregion

                    #region 醫事人員請領英文證明書_醫事人員證書(apply_001008_me)
                    model.ME.APP_ID = model.APP_ID;

                    if (model.ME.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_MeModel ME = null;
                        foreach (var item in model.ME.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.ME_LIC_TYPE)
                            && !string.IsNullOrWhiteSpace(item.ME_LIC_NUM)
                            && !string.IsNullOrWhiteSpace(item.ME_ISSUE_DATE_AD)
                            && item.ME_COPIES != null
                            && !string.IsNullOrWhiteSpace(item.ME_TYPE_CD))
                            {
                                ME = new Apply_001008_MeModel();
                                ME.InjectFrom(item);

                                ME.APP_ID = appID;
                                ME.SRL_NO = index;
                                ME.ME_ISSUE_DATE = HelperUtil.TransToDateTime(item.ME_ISSUE_DATE_AD);
                                ME.ADD_TIME = DateTime.Now;
                                ME.ADD_FUN_CD = funCD;
                                ME.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ME.UPD_TIME = DateTime.Now;
                                ME.UPD_FUN_CD = funCD;
                                ME.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ME.DEL_MK = "N";

                                base.Insert(ME);
                                index++;
                            }
                        }

                        //model.ME.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_醫事人員證書(apply_001008_pr)
                    model.PR.APP_ID = appID;

                    if (model.PR.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_PrModel PR = null;
                        foreach (var item in model.PR.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.PR_LIC_TYPE)
                            && !string.IsNullOrWhiteSpace(item.PR_LIC_NUM)
                            && !string.IsNullOrWhiteSpace(item.PR_ISSUE_DATE_AD)
                            && !string.IsNullOrWhiteSpace(item.PR_EF_DATE_S_AD)
                            && !string.IsNullOrWhiteSpace(item.PR_EF_DATE_E_AD)
                            && item.PR_COPIES != null
                            && !string.IsNullOrWhiteSpace(item.PR_TYPE_CD))
                            {
                                PR = new Apply_001008_PrModel();
                                PR.InjectFrom(item);

                                PR.APP_ID = model.APP_ID;
                                PR.SRL_NO = index;
                                PR.PR_ISSUE_DATE = HelperUtil.TransToDateTime(item.PR_ISSUE_DATE_AD);
                                PR.PR_EF_DATE_S = HelperUtil.TransToDateTime(item.PR_EF_DATE_S_AD);
                                PR.PR_EF_DATE_E = HelperUtil.TransToDateTime(item.PR_EF_DATE_E_AD);
                                PR.ADD_TIME = DateTime.Now;
                                PR.ADD_FUN_CD = funCD;
                                PR.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                PR.UPD_TIME = DateTime.Now;
                                PR.UPD_FUN_CD = funCD;
                                PR.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                PR.DEL_MK = "N";

                                base.Insert(PR);
                                index++;
                            }
                        }

                        //model.PR.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_國內地址(apply_001008_trans)
                    model.TRANS.APP_ID = model.APP_ID;

                    if (model.TRANS.GoodsList != null)
                    {
                        Apply_001008_TransModel newTrans = null;
                        index = 1;
                        foreach (var item in model.TRANS.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANS_ZIP_ADDR) && !string.IsNullOrWhiteSpace(item.TRANS_ZIP_DETAIL) && item.TRANS_COPIES != null)
                            {
                                newTrans = new Apply_001008_TransModel();

                                newTrans.APP_ID = appID;
                                newTrans.SRL_NO = index;
                                newTrans.TRANS_ZIP = item.TRANS_ZIP;
                                newTrans.TRANS_ADDR = item.TRANS_ZIP_DETAIL;
                                newTrans.TRANS_COPIES = item.TRANS_COPIES;
                                newTrans.ADD_TIME = DateTime.Now;
                                newTrans.ADD_FUN_CD = funCD;
                                newTrans.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.UPD_TIME = DateTime.Now;
                                newTrans.UPD_FUN_CD = funCD;
                                newTrans.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.DEL_MK = "N";

                                base.Insert(newTrans);
                                index++;
                            }
                        }

                        //model.TRANS.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_國外地址(apply_001008_transf)
                    model.TRANSF.APP_ID = appID;

                    if (model.TRANSF.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_TransFModel newTransF = null;
                        foreach (var item in model.TRANSF.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANSF_ADDR) && item.TRANSF_COPIES != null)
                            {
                                newTransF = new Apply_001008_TransFModel();

                                newTransF.APP_ID = appID;
                                newTransF.SRL_NO = index;
                                newTransF.TRANSF_ADDR = item.TRANSF_ADDR;
                                newTransF.TRANSF_UNITNAME = item.TRANSF_UNITNAME;//20201221 add 醫事人員請領英文證明書 - 001008 - (前台)申辦案件的國外寄送地址區塊增加一個機構名稱的欄位
                                newTransF.TRANSF_COPIES = item.TRANSF_COPIES;
                                newTransF.ADD_TIME = DateTime.Now;
                                newTransF.ADD_FUN_CD = funCD;
                                newTransF.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.UPD_TIME = DateTime.Now;
                                newTransF.UPD_FUN_CD = funCD;
                                newTransF.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.DEL_MK = "N";

                                base.Insert(newTransF);
                                index++;
                            }
                        }

                        //model.TRANSF.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 檔案上傳(apply_file)
                    //繳費紀錄照片或pdf檔案
                    if (model.FILE_PAYRECORD != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = appID;
                        file.FILE_NO = 1;
                        //file.FILENAME = model.FILE_PAYRECORD_FILENAME;
                        //file.FILENAME = shareDao.PutFile(srvID, model.FILE_PAYRECORD, "1");
                        file.FILENAME = model.FILE_PAYRECORD_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                        //var FileList = file.FILENAME.ToSplit('/');
                        //var FileName = FileList[FileList.ToCount() - 1];
                        var FileName = model.FILE_PAYRECORD.FileName;
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = 1;
                        file.NOTICE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = funCD;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = funCD;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    //護照影本電子檔
                    if (model.FILE_PASSPORT != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = appID;
                        file.FILE_NO = 2;
                        //file.FILENAME = model.FILE_PASSPORT_FILENAME;
                        //file.FILENAME = shareDao.PutFile(srvID, model.FILE_PASSPORT, "2");
                        file.FILENAME = model.FILE_PASSPORT_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                        //var FileList = file.FILENAME.ToSplit('/');
                        //var FileName = FileList[FileList.ToCount() - 1];
                        var FileName = model.FILE_PASSPORT.FileName;
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = 1;
                        file.NOTICE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = funCD;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = funCD;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_附檔(apply_001008_ath)
                    if (model.ATHs != null)
                    {
                        Apply_001008_AthModel ath = null;
                        int fileCount = 1;
                        foreach (var item in model.ATHs)
                        {
                            if (item.FILE_1 != null)
                            {
                                ath = new Apply_001008_AthModel();
                                ath.APP_ID = appID;
                                ath.SRL_NO = fileCount;
                                //ath.ATH_UP = shareDao.PutFile(srvID, appID, item.FILE_1, fileCount.ToString(), "_ATH_UP_");
                                ath.ATH_UP = item.FILE_1_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                                ath.SRC_FILENAME = item.FILE_1.FileName;
                                ath.NOTICE_NO = 1;
                                ath.ADD_TIME = DateTime.Now;
                                ath.ADD_FUN_CD = funCD;
                                ath.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ath.UPD_TIME = DateTime.Now;
                                ath.UPD_FUN_CD = funCD;
                                ath.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ath.DEL_MK = "N";

                                base.Insert(ath);
                                fileCount++;
                            }
                        }
                    }
                    #endregion

                    #endregion

                    if (model.ISEC.ToUpper() == "Y" && DateTime.Now >= Convert.ToDateTime(DataUtils.GetConfig("PAY_EC_SDATE")))
                    {
                        #region 聯合信用卡繳費中心
                        var ECmodel = new CreditHPPModel();
                        ECmodel.EncModel.MerchantID = DataUtils.GetConfig("PAY_EC_MERCHANTID");
                        ECmodel.EncModel.OrderID = "";
                        ECmodel.EncModel.TerminalID = DataUtils.GetConfig("PAY_EC_TRMINALID");
                        ECmodel.EncModel.TransAmt = Convert.ToString(model.PAY_A_FEE);
                        ECmodel.EncModel.TransMode = "0";
                        ECmodel.EncModel.Template = "BOTH";
                        ECmodel.EncModel.CardholderName = "";
                        ECmodel.EncModel.CardholderEmailAddress = "";
                        ECmodel.EncModel.IDNUMBER = Convert.ToString(model.CARD_IDN); //持卡人身份證字號
                        ECmodel.EncModel.PrivateData = "ClientIP=" + model.CLIENT_IP + "&APPID=" + model.APP_ID + "&SRVID=" + serviceWhere.SRV_ID; //自訂資料
                        ECmodel.ECConnetModel.DomainName = DataUtils.GetConfig("PAY_EC_DOMAINNAME");
                        ECmodel.ECConnetModel.RequestURL = DataUtils.GetConfig("PAY_EC_REQUESTURL");
                        //*回應網址
                        ECmodel.EncModel.NotifyURL = DataUtils.GetConfig("PAY_EC_NOTIFYURL");
                        //聯合信用卡
                        ApiClient resEC = CardUtils.GetTransactionKeyEC(ECmodel);
                        if (resEC != null)
                        {
                            model.ErrorCode = resEC.getRESPONSECODE();
                            model.ErrorMessage = resEC.getRESPONSEMSG();
                            if (model.ErrorCode.Equals("00"))
                            {
                                //作業執行成功
                                logger.Debug("SessionTransactionKey: " + resEC.getKEY());

                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = "001008";
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = resEC.getKEY();
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = "WEB-APPLY";
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = "WEB-APPLY";
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                applyPay.PAY_BANK = "EC"; //聯合信用
                                applyPay.ECORDERID = resEC.getORDERID(); // EC datetime.tick
                                this.Insert(applyPay);

                                tran.Commit();
                                result = true;
                                model.SessionTransactionKey = resEC.getKEY();
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + model.ErrorCode + ":" + model.ErrorMessage + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }
                    else
                    {
                        #region 我的E政府
                        SessionKeyResponse res = CardUtils.GetTransactionKey(data.GetItem(), pay);
                        if (res != null)
                        {
                            model.ErrorCode = res.ResultInfo;
                            model.ErrorMessage = action.GetPayCodeDesc(res.ResultInfo);
                            logger.Debug($"SessionKeyResponse:{model.ErrorCode}:{model.ErrorMessage},APP_ID:{model.APP_ID}");

                            if (res.ResultInfo.Equals("0000"))
                            {
                                string sessionKey = res.SessionTransactionKey;
                                data.Put("PAY_SESSION_KEY", sessionKey);
                                logger.Debug("SessionTransactionKey: " + sessionKey);
                                model.SessionTransactionKey = sessionKey;

                                //inser apply_pay
                                #region 繳費資料 insert apply_pay
                                APPLY_PAY applyPay = new APPLY_PAY();
                                applyPay.APP_ID = model.APP_ID;
                                applyPay.OID = data.GetItem()["PAY_OID"];   // 機關代碼
                                applyPay.SID = data.GetItem()["PAY_SID"];   // 服務代碼
                                applyPay.PAY_ID = model.APP_ID;
                                apply.SRV_ID = srvID;
                                applyPay.PAY_METHOD = "C";
                                applyPay.PAY_STATUS_MK = "N";
                                applyPay.PAY_MONEY = model.PAY_A_FEE;
                                applyPay.PAY_PROFEE = 0;
                                applyPay.SESSION_KEY = model.SessionTransactionKey;
                                applyPay.PAY_ACT_TIME = DateTime.Now;
                                //applyPay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                                //applyPay.PAY_INC_TIME = DateTime.Now;//異動時間
                                applyPay.CLIENT_IP = model.CLIENT_IP;
                                applyPay.ADD_TIME = DateTime.Now;
                                applyPay.ADD_FUN_CD = funCD;
                                applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.UPD_TIME = DateTime.Now;
                                applyPay.UPD_FUN_CD = funCD;
                                applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                applyPay.DEL_MK = "N";
                                this.Insert(applyPay);
                                #endregion

                                #region 寄發通知信(to申請者)
                                BackApplyDAO backDao = new BackApplyDAO();
                                string appTimeY = "";
                                string appTimeM = "";
                                string appTimeD = "";
                                string appTime = HelperUtil.TransToTwYear(model.APPLY_DATE);
                                if (!string.IsNullOrEmpty(appTime))
                                {
                                    appTimeY = appTime.Substring(0, 3);
                                    appTimeM = appTime.Substring(4, 2);
                                    appTimeD = appTime.Substring(7, 2);
                                }

                                //查詢網站網址
                                string webUrl = HttpContext.Current.Request.Url.AbsoluteUri;
                                Uri uri = new Uri(webUrl);
                                string webDomain = uri.Scheme + Uri.SchemeDelimiter + uri.Host + (uri.IsDefaultPort ? "" : ":" + uri.Port);
                                string appDocUrl = string.Format("{0}/Apply_{1}/AppDoc?APP_ID={2}", webDomain, srvID, appID);

                                string subject = string.Format("{0}申請作業，案件編號﹕{1} 申請通知", srvName, appID);
                                string MailBody = "";
                                MailBody = string.Format(@"{0}，您好:<br/><br/>
                                您於民國{1}年{2}月{3}日申辦之{4}案件<br/>
                                申請編號：<a href='{5}'>{6}</a>現在進度為'新收案件'<br/>
                                特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>
                                衛生福利部醫事司敬上<br/><br/>
                                PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>
                                ※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>
                                115209 臺北市南港區昆陽街161-2號<br><br>
                                ※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>
                                115204 臺北市南港區忠孝東路六段488號",
                                        model.NAME, appTimeY, appTimeM, appTimeD,
                                        srvName, appDocUrl, appID);
                                backDao.SendMail(model.EMAIL, subject, MailBody);
                                #endregion

                                tran.Commit();
                                result = true;
                            }
                            else
                            {
                                tran.Rollback();
                                model.TempMessage = "取得預約交易代碼失敗(" + res.ResultInfo + ")";
                            }
                        }
                        else
                        {
                            tran.Rollback();
                            model.ErrorCode = "-1";
                            model.ErrorMessage = "連接失敗";
                            model.TempMessage = "取得預約交易代碼失敗(-1)";
                        }
                        #endregion
                    }

                }
                catch (Exception ex)
                {
                    logger.Error(ex.Message, ex);
                    tran.Rollback();
                    model.ErrorCode = "-1";
                    model.ErrorMessage = "連接失敗";
                    model.TempMessage = "取得預約交易代碼失敗(-1)";
                    logger.Error(ex.Message, ex);
                    //throw;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 非信用卡繳費
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public bool RunPayTranx(Apply_001008FormModel model)
        {
            bool result = false;
            string srvID = "001008";
            string srvName = "醫事人員或公共衛生師請領英文證明書";
            string funCD = "WEB-APPLY";
            int index = 1;

            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = srvID;
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID(srvID); //取得案件編號
            string appID = model.APP_ID;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase(srvID);

                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }


                    #region 案件主檔資料(insert apply)
                    ApplyModel apply = new ApplyModel();
                    apply.APP_ID = appID;
                    apply.SRV_ID = srvID;
                    apply.SRC_SRV_ID = srvID;
                    apply.UNIT_CD = 4;
                    apply.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    apply.IDN = model.IDN;
                    apply.NAME = model.NAME;
                    apply.SEX_CD = UserInfo.SEX_CD;
                    apply.BIRTHDAY = UserInfo.BIRTHDAY;
                    apply.ENAME = model.ENAME;
                    apply.E_ALIAS_NAME = model.ENAME_ALIAS;
                    apply.APP_EXT_DATE = this.GetNTFD(srvID);
                    apply.APP_TIME = HelperUtil.TransToDateTime(model.APPLY_DATE);
                    apply.ADDR_CODE = model.ADDR_ZIP;
                    apply.ADDR = model.ADDR_ZIP_DETAIL;
                    apply.TEL = model.TEL;
                    apply.MOBILE = model.MOBILE;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    //apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_FEEBK = Int32.Parse(data.Get("PAY_A_FEEBK"));
                    apply.PAY_A_PAID = 0;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = funCD;
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = funCD;
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.DEL_MK = "N";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);
                    #endregion

                    #region 醫事人員請領英文證明書(apply_001008)
                    Apply_001008Model apply001008 = new Apply_001008Model();
                    apply001008.APP_ID = appID;
                    apply001008.ENAME_ALIAS = model.ENAME_ALIAS;
                    apply001008.COPIES = this.GetCopies_001008(model);
                    apply001008.TOTAL_MEM = Int32.Parse(model.TOTAL_MEM);
                    apply001008.REMARK = model.REMARK;
                    apply001008.EMAIL = model.EMAIL;
                    apply001008.MERGEYN = model.MERGEYN;
                    apply001008.ADD_TIME = DateTime.Now;
                    apply001008.ADD_FUN_CD = funCD;
                    apply001008.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001008.UPD_TIME = DateTime.Now;
                    apply001008.UPD_FUN_CD = funCD;
                    apply001008.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001008.DEL_MK = "N";
                    this.Insert(apply001008);
                    #endregion

                    #region 醫事人員請領英文證明書_醫事人員證書(apply_001008_me)
                    model.ME.APP_ID = model.APP_ID;

                    if (model.ME.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_MeModel ME = null;
                        foreach (var item in model.ME.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.ME_LIC_TYPE)
                                && !string.IsNullOrWhiteSpace(item.ME_LIC_NUM)
                                && !string.IsNullOrWhiteSpace(item.ME_ISSUE_DATE_AD)
                                && item.ME_COPIES != null
                                && !string.IsNullOrWhiteSpace(item.ME_TYPE_CD))
                            {
                                ME = new Apply_001008_MeModel();
                                ME.InjectFrom(item);

                                ME.APP_ID = appID;
                                ME.SRL_NO = index;
                                ME.ME_ISSUE_DATE = HelperUtil.TransToDateTime(item.ME_ISSUE_DATE_AD);
                                ME.ADD_TIME = DateTime.Now;
                                ME.ADD_FUN_CD = funCD;
                                ME.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ME.UPD_TIME = DateTime.Now;
                                ME.UPD_FUN_CD = funCD;
                                ME.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ME.DEL_MK = "N";

                                base.Insert(ME);
                                index++;
                            }
                        }

                        //model.ME.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_醫事人員證書(apply_001008_pr)
                    model.PR.APP_ID = appID;

                    if (model.PR.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_PrModel PR = null;
                        foreach (var item in model.PR.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.PR_LIC_TYPE)
                                && !string.IsNullOrWhiteSpace(item.PR_LIC_NUM)
                                && !string.IsNullOrWhiteSpace(item.PR_ISSUE_DATE_AD)
                                && !string.IsNullOrWhiteSpace(item.PR_EF_DATE_S_AD)
                                && !string.IsNullOrWhiteSpace(item.PR_EF_DATE_E_AD)
                                && item.PR_COPIES != null
                                && !string.IsNullOrWhiteSpace(item.PR_TYPE_CD))
                            {
                                PR = new Apply_001008_PrModel();
                                PR.InjectFrom(item);

                                PR.APP_ID = model.APP_ID;
                                PR.SRL_NO = index;
                                PR.PR_ISSUE_DATE = HelperUtil.TransToDateTime(item.PR_ISSUE_DATE_AD);
                                PR.PR_EF_DATE_S = HelperUtil.TransToDateTime(item.PR_EF_DATE_S_AD);
                                PR.PR_EF_DATE_E = HelperUtil.TransToDateTime(item.PR_EF_DATE_E_AD);
                                PR.ADD_TIME = DateTime.Now;
                                PR.ADD_FUN_CD = funCD;
                                PR.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                PR.UPD_TIME = DateTime.Now;
                                PR.UPD_FUN_CD = funCD;
                                PR.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                PR.DEL_MK = "N";

                                base.Insert(PR);
                                index++;
                            }
                        }

                        //model.PR.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_國內地址(apply_001008_trans)
                    model.TRANS.APP_ID = model.APP_ID;

                    if (model.TRANS.GoodsList != null)
                    {
                        Apply_001008_TransModel newTrans = null;
                        index = 1;
                        foreach (var item in model.TRANS.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANS_ZIP_ADDR) && !string.IsNullOrWhiteSpace(item.TRANS_ZIP_DETAIL) && item.TRANS_COPIES != null)
                            {
                                newTrans = new Apply_001008_TransModel();

                                newTrans.APP_ID = appID;
                                newTrans.SRL_NO = index;
                                newTrans.TRANS_ZIP = item.TRANS_ZIP;
                                newTrans.TRANS_ADDR = item.TRANS_ZIP_DETAIL;
                                newTrans.TRANS_COPIES = item.TRANS_COPIES;
                                newTrans.ADD_TIME = DateTime.Now;
                                newTrans.ADD_FUN_CD = funCD;
                                newTrans.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.UPD_TIME = DateTime.Now;
                                newTrans.UPD_FUN_CD = funCD;
                                newTrans.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.DEL_MK = "N";

                                base.Insert(newTrans);
                                index++;
                            }
                        }

                        //model.TRANS.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 醫事人員請領英文證明書_國外地址(apply_001008_transf)
                    model.TRANSF.APP_ID = appID;

                    if (model.TRANSF.GoodsList != null)
                    {
                        index = 1;
                        Apply_001008_TransFModel newTransF = null;
                        foreach (var item in model.TRANSF.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANSF_ADDR) && item.TRANSF_COPIES != null)
                            {
                                newTransF = new Apply_001008_TransFModel();

                                newTransF.APP_ID = appID;
                                newTransF.SRL_NO = index;
                                newTransF.TRANSF_ADDR = item.TRANSF_ADDR;
                                newTransF.TRANSF_UNITNAME = item.TRANSF_UNITNAME; //20201221 add 醫事人員請領英文證明書 - 001008 - (前台)申辦案件的國外寄送地址區塊增加一個機構名稱的欄位
                                newTransF.TRANSF_COPIES = item.TRANSF_COPIES;
                                newTransF.ADD_TIME = DateTime.Now;
                                newTransF.ADD_FUN_CD = funCD;
                                newTransF.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.UPD_TIME = DateTime.Now;
                                newTransF.UPD_FUN_CD = funCD;
                                newTransF.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.DEL_MK = "N";

                                base.Insert(newTransF);
                                index++;
                            }
                        }

                        //model.TRANSF.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 申請案件繳費交易明細(apply_pay)
                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = appID;
                    applyPay.PAY_ID = appID;
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    //applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.PAY_PROFEE = Int32.Parse(data.Get("PAY_A_FEEBK"));
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = funCD;
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = funCD;
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);
                    #endregion

                    #region 檔案上傳（apply_file）
                    //繳費紀錄照片或pdf檔案
                    if (model.FILE_PAYRECORD != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = appID;
                        file.FILE_NO = 1;
                        //file.FILENAME = model.FILE_PAYRECORD_FILENAME;
                        //file.FILENAME = shareDao.PutFile(srvID, model.FILE_PAYRECORD, "1");
                        file.FILENAME = model.FILE_PAYRECORD_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                        //var FileList = file.FILENAME.ToSplit('/');
                        //var FileName = FileList[FileList.ToCount() - 1];
                        var FileName = model.FILE_PAYRECORD.FileName;
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = 1;
                        file.NOTICE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = funCD;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = funCD;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }

                    //護照影本電子檔
                    if (model.FILE_PASSPORT != null)
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = appID;
                        file.FILE_NO = 2;
                        //file.FILENAME = model.FILE_PASSPORT_FILENAME;
                        //file.FILENAME = shareDao.PutFile(srvID, model.FILE_PASSPORT, "2");
                        file.FILENAME = model.FILE_PASSPORT_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                        //var FileList = file.FILENAME.ToSplit('/');
                        //var FileName = FileList[FileList.ToCount() - 1];
                        var FileName = model.FILE_PASSPORT.FileName;
                        file.SRC_FILENAME = FileName;
                        file.SRC_NO = 1;
                        file.NOTICE_NO = 1;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = funCD;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = funCD;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";

                        base.Insert(file);
                    }
                    #endregion

                    #region 醫事人員/專科中文證書電子檔(apply_001008_ath)
                    if (model.ATHs != null)
                    {
                        Apply_001008_AthModel ath = null;
                        int fileCount = 1;
                        foreach (var item in model.ATHs)
                        {
                            if (item.FILE_1 != null)
                            {
                                ath = new Apply_001008_AthModel();
                                ath.APP_ID = appID;
                                ath.SRL_NO = fileCount;
                                //ath.ATH_UP = shareDao.PutFile(srvID, appID, item.FILE_1, fileCount.ToString(), "_ATH_UP_");
                                ath.ATH_UP = item.FILE_1_TEXT.Replace("/", "\\"); //20201118 改附件存檔作法：為了預覽頁可以檢視下載非圖檔附件，改成在申請表填寫送出到預覽頁的過程時就先存實體檔，取得附件更名後的資料先改成抓hidden

                                ath.SRC_FILENAME = item.FILE_1.FileName;
                                ath.NOTICE_NO = 1;
                                ath.ADD_TIME = DateTime.Now;
                                ath.ADD_FUN_CD = funCD;
                                ath.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ath.UPD_TIME = DateTime.Now;
                                ath.UPD_FUN_CD = funCD;
                                ath.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                ath.DEL_MK = "N";

                                base.Insert(ath);
                                fileCount++;
                            }
                        }
                    }
                    #endregion

                    #region 寄發通知信(to申請者)
                    BackApplyDAO backDao = new BackApplyDAO();
                    string appTimeY = "";
                    string appTimeM = "";
                    string appTimeD = "";
                    string appTime = HelperUtil.TransToTwYear(model.APPLY_DATE);
                    if (!string.IsNullOrEmpty(appTime))
                    {
                        appTimeY = appTime.Substring(0, 3);
                        appTimeM = appTime.Substring(4, 2);
                        appTimeD = appTime.Substring(7, 2);
                    }

                    //查詢網站網址
                    string webUrl = HttpContext.Current.Request.Url.AbsoluteUri;
                    Uri uri = new Uri(webUrl);
                    string webDomain = uri.Scheme + Uri.SchemeDelimiter + uri.Host + (uri.IsDefaultPort ? "" : ":" + uri.Port);
                    string appDocUrl = string.Format("{0}/Apply_{1}/AppDoc?APP_ID={2}", webDomain, srvID, appID);

                    string subject = string.Format("{0}申請作業，案件編號﹕{1} 申請通知", srvName, appID);
                    string MailBody = "";
                    MailBody = string.Format(@"{0}，您好:<br/><br/>
                                您於民國{1}年{2}月{3}日申辦之{4}案件<br/>
                                申請編號：<a href='{5}'>{6}</a>現在進度為'新收案件'<br/>
                                特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>
                                衛生福利部醫事司敬上<br/><br/>
                                PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>
                                ※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>
                                115209 臺北市南港區昆陽街161-2號<br><br>
                                ※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>
                                115204 臺北市南港區忠孝東路六段488號",
                            model.NAME, appTimeY, appTimeM, appTimeD,
                            srvName, appDocUrl, appID);
                    backDao.SendMail(model.EMAIL, subject, MailBody);
                    #endregion

                    tran.Commit();
                    //tran.Rollback();
                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    //throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 取得總申請份數
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public int GetCopies_001008(Apply_001008FormModel model)
        {
            int ret = 0;
            bool blMergeFlag = false;

            //醫事人員證書
            if (model.ME != null && model.ME.GoodsList != null)
            {
                foreach (var item in model.ME.GoodsList)
                {
                    if (item.ME_COPIES != null)
                    {
                        if (item.ME_TYPE_CD == "2")
                        {
                            //整併一張(只加總第一筆填的份數)
                            if (!blMergeFlag)
                            {
                                blMergeFlag = true;
                                ret += item.ME_COPIES.TOInt32();
                            }
                        }
                        else
                        {
                            //分別開立
                            ret += item.ME_COPIES.TOInt32();
                        }
                    }
                }
            }

            //專科證書
            if (model.PR != null && model.PR.GoodsList != null)
            {
                foreach (var item in model.PR.GoodsList)
                {
                    if (item.PR_COPIES != null)
                    {
                        if (item.PR_TYPE_CD == "2")
                        {
                            //整併一張
                            if (!blMergeFlag)
                            {
                                blMergeFlag = true;
                                ret += item.PR_COPIES.TOInt32();
                            }
                        }
                        else
                        {
                            //分別開立
                            ret += item.PR_COPIES.TOInt32();
                        }
                    }
                }
            }

            return ret;
        }

        /// <summary>
        /// 取上傳附件檔(apply_file)
        /// </summary>
        /// <param name="APP_ID"></param>
        /// <returns></returns>
        public Apply_001008FileModel GetFile_001008(string APP_ID)
        {
            var result = new Apply_001008FileModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                string _sql = @"select
                case when isnull(fl1.filename,'')='' then 'N' else 'Y' end HAS_OFILE_PAYRECORD,
                case when isnull(fl2.filename,'')='' then 'N' else 'Y' end HAS_OFILE_PAYPASSPORT,
                concat(isnull(reverse(substring(reverse(fl1.filename),1,charindex('\',reverse(fl1.filename)) - 1)),''),',',fl1.APP_ID,',',cast(fl1.FILE_NO as varchar),',',isnull(cast(fl1.SRC_NO as varchar),'0')) as FILE_PAYRECORD_TEXT,
                concat(isnull(reverse(substring(reverse(fl2.filename),1,charindex('\',reverse(fl2.filename)) - 1)),''),',',fl2.APP_ID,',',cast(fl2.FILE_NO as varchar),',',isnull(cast(fl2.SRC_NO as varchar),'0')) as FILE_PASSPORT_TEXT
                from apply app";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '1' and APP_ID = @APP_ID order by ADD_TIME desc)as fl1 on app.APP_ID = fl1.APP_ID ";
                _sql += " left join (select top 1 * from APPLY_FILE where FILE_NO = '2' and APP_ID = @APP_ID order by ADD_TIME desc)as fl2 on app.APP_ID = fl2.APP_ID ";
                _sql += "where 1 = 1";
                _sql += "and app.APP_ID = @APP_ID ";

                try
                {
                    result = conn.QueryFirst<Apply_001008FileModel>(_sql, parameters);
                    result.APP_ID = APP_ID;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        ///// <summary>
        ///// 取得佐證證明文件資料
        ///// </summary>
        ///// <param name="APP_ID"></param>
        ///// <returns></returns>
        //public IList<Apply_FileModel> GetFile_001008(string APP_ID)
        //{
        //    IList<Apply_FileModel> result = new List<Apply_FileModel>();

        //    Dictionary<string, object> dictionary = new Dictionary<string, object>
        //    {
        //        { "@APP_ID",APP_ID }
        //    };
        //    DynamicParameters parameters = new DynamicParameters(dictionary);

        //    using (SqlConnection conn = DataUtils.GetConnection())
        //    {
        //        string _sql = @"
        //        select isnull(reverse(substring(reverse(filename),1,charindex('\',reverse(filename)) - 1)),'') + ',' + isnull(app_id,'') + ',' + isnull(cast(file_no as varchar),'') + ',0' as FILENAME,FILE_NO
        //        from apply_file 
        //        where app_id=@APP_ID
        //        order by file_no 
        //        ";

        //        try
        //        {
        //            result = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>();
        //        }
        //        catch (Exception ex)
        //        {
        //            logger.Warn("GetFile_001008 ex:" + ex.Message, ex);
        //            result = null;
        //        }
        //    }

        //    return result;
        //}

        /// <summary>
        /// 取得醫事人員/專科證明書電子檔資料
        /// </summary>
        /// <param name="APP_ID"></param>
        /// <returns></returns>
        public IList<Apply_001008_AthViewModel> GetAthFile_001008(string APP_ID)
        {
            IList<Apply_001008_AthViewModel> result = new List<Apply_001008_AthViewModel>();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
            {
                { "@APP_ID",APP_ID }
            };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                //string _sql = @"
                //select isnull(reverse(substring(reverse(ath_up),1,charindex('\',reverse(ath_up)) - 1)),'') + ',' + isnull(app_id,'') + ',' + isnull(cast(srl_no as varchar),'') + ',0' as FILE_1_TEXT
                //from apply_001008_ath 
                //where app_id=@APP_ID
                //order by srl_no 
                //";
                string _sql = @"
                            WITH MAXATH AS (
                                SELECT APP_ID,SRL_NO,MAX(NOTICE_NO) MAX_NOTICE_NO
                                FROM APPLY_001008_ATH 
                                WHERE APP_ID=@APP_ID
                                GROUP BY APP_ID,SRL_NO 
                            )
                            SELECT 
                            A.SRL_NO,A.ATH_UP,
                            CASE WHEN ISNULL(A.ATH_UP,'')='' THEN 'N' ELSE 'Y' END HAS_OFILE,
                            CONCAT(ISNULL(REVERSE(SUBSTRING(REVERSE(A.ATH_UP),1,CHARINDEX('\',REVERSE(A.ATH_UP)) - 1)),''),',',ISNULL(A.APP_ID,'') ,',' , ISNULL(CAST(A.SRL_NO AS VARCHAR),'') ,',',isnull(CAST(A.SRC_NO AS VARCHAR),'1')) AS FILE_1_TEXT
                            FROM APPLY_001008_ATH A
                            JOIN MAXATH B ON A.APP_ID=B.APP_ID AND A.SRL_NO=B.SRL_NO AND A.NOTICE_NO=B.MAX_NOTICE_NO
                            WHERE 1=1 
                            ORDER BY A.APP_ID,A.SRL_NO 
                            ";
                try
                {
                    result = conn.Query<Apply_001008_AthViewModel>(_sql, parameters).ToList<Apply_001008_AthViewModel>();
                }
                catch (Exception ex)
                {
                    logger.Warn("GetAthFile_001008 ex:" + ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 取得補件通知資料
        /// </summary>
        /// <param name="APP_ID"></param>
        /// <returns></returns>
        public IList<TblAPPLY_NOTICE> GetNotice_001008(string APP_ID)
        {
            IList<TblAPPLY_NOTICE> result = new List<TblAPPLY_NOTICE>();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
            {
                { "@APP_ID",APP_ID }
            };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                string _sql = @"
                            SELECT APP_ID,Field,Field_NAME,ISADDYN,FREQUENCY,ADD_TIME,DEADLINE,NOTE,SRC_NO,BATCH_INDEX
                            FROM APPLY_NOTICE
                            WHERE 1 = 1 ";
                _sql += " AND APP_ID = @APP_ID AND ISADDYN='N' ";

                try
                {
                    result = conn.Query<TblAPPLY_NOTICE>(_sql, parameters).ToList<TblAPPLY_NOTICE>();
                }
                catch (Exception ex)
                {
                    logger.Warn("GetNotice_001008 ex:" + ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }

        /// <summary>
        /// 補件儲存
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public bool SaveAppDoc001008(Apply_001008FormModel model)
        {
            bool result = false;

            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            string APP_ID = model.APP_ID;
            string[] updFieldAry = null;
            string FUN_CD = "WEB-APPLY";
            int index = 1;
            string s_SRV_ID = "001008";
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");

            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);


            if (!string.IsNullOrWhiteSpace(model.FieldStr))
            {
                updFieldAry = model.FieldStr.Split(',');
            }

            //申請案主檔
            ApplyModel whereApply = new ApplyModel();
            whereApply.APP_ID = APP_ID;
            ApplyModel newApply = new ApplyModel();
            newApply.APP_ID = APP_ID;

            //醫事人員請領英文證明書
            Apply_001008Model whereApply001008 = new Apply_001008Model();
            whereApply001008.APP_ID = APP_ID;
            Apply_001008Model newApply001008 = new Apply_001008Model();
            newApply001008.APP_ID = APP_ID;

            //繳費紀錄照片或pdf檔案
            Apply_FileModel whereApplyFile1 = new Apply_FileModel();
            whereApplyFile1.APP_ID = APP_ID;
            whereApplyFile1.FILE_NO = 1;
            Apply_FileModel newApplyFile1 = new Apply_FileModel();
            newApplyFile1.APP_ID = APP_ID;

            //護照影本電子檔
            Apply_FileModel whereApplyFile2 = new Apply_FileModel();
            whereApplyFile2.APP_ID = APP_ID;
            whereApplyFile2.FILE_NO = 2;
            Apply_FileModel newApplyFile2 = new Apply_FileModel();
            newApplyFile2.APP_ID = APP_ID;

            // 取得補件紀錄
            TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
            anwhere.APP_ID = model.APP_ID;
            var andata = base.GetRowList(anwhere);

            // 只取回最後一次補件的次數
            var newandaata = from a in andata
                             orderby a.FREQUENCY descending
                             select a;

            // 取得已補件次數☆☆
            int times = newandaata.ToCount() == 0 ? 0 : newandaata.FirstOrDefault().FREQUENCY.TOInt32();

            IList<Apply_001008_AthModel> athFileList = null;
            Apply_001008_AthModel athWhere = new Apply_001008_AthModel();

            bool blUpdApply = false; //補件註記-其它
            bool blUpdAth = false; //補件註記-中文證書電子檔
            bool blUpdPayRec = false;
            bool blUpdPassPort = false;
            bool blIsNewPayRec = false;
            bool blIsNewPayPassPort = false;

            //針對補件項目進行更新
            foreach (var updField in updFieldAry)
            {
                if (updField == "FILE_0" || updField.IndexOf("ALL_") >= 0)
                {
                    //繳費紀錄照片或pdf檔案
                    if (!blUpdPayRec && model.FILE_PAYRECORD != null)
                    {
                        blUpdPayRec = true;

                        Apply_FileModel whereApplyFile = new Apply_FileModel();
                        whereApplyFile.APP_ID = APP_ID;
                        whereApplyFile.FILE_NO = 1;
                        IList<Apply_FileModel> fileList = base.GetRowList(whereApplyFile);

                        newApplyFile1.APP_ID = APP_ID;
                        newApplyFile1.FILE_NO = 1;
                        //newApplyFile1.SRC_NO = (times + 1);
                        newApplyFile1.NOTICE_NO = (times + 1);
                        newApplyFile1.FILENAME = dao.PutFile("001008", model.FILE_PAYRECORD, "1");
                        newApplyFile1.SRC_FILENAME = model.FILE_PAYRECORD.FileName;
                        newApplyFile1.DEL_MK = "N";

                        if (fileList != null && fileList.Count() > 0)
                        {
                            newApplyFile1.APP_ID = APP_ID;
                            newApplyFile1.UPD_TIME = DateTime.Now;
                            newApplyFile1.UPD_FUN_CD = FUN_CD;
                            newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        else
                        {
                            blIsNewPayRec = true;
                            newApplyFile1.ADD_TIME = DateTime.Now;
                            newApplyFile1.ADD_FUN_CD = FUN_CD;
                            newApplyFile1.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            newApplyFile1.UPD_TIME = DateTime.Now;
                            newApplyFile1.UPD_FUN_CD = FUN_CD;
                            newApplyFile1.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                    }
                }

                if (updField == "FILE_1" || updField.IndexOf("ALL_") >= 0)
                {
                    //護照影本電子檔
                    if (!blUpdPassPort && model.FILE_PASSPORT != null)
                    {
                        blUpdPassPort = true;

                        Apply_FileModel whereApplyFile = new Apply_FileModel();
                        whereApplyFile.APP_ID = APP_ID;
                        whereApplyFile.FILE_NO = 2;
                        IList<Apply_FileModel> fileList = base.GetRowList(whereApplyFile);

                        newApplyFile2.FILE_NO = 2;
                        //newApplyFile2.SRC_NO = (times + 1);
                        newApplyFile2.NOTICE_NO = (times + 1);
                        newApplyFile2.FILENAME = dao.PutFile("001008", model.FILE_PASSPORT, "2");
                        newApplyFile2.SRC_FILENAME = model.FILE_PASSPORT.FileName;
                        newApplyFile2.DEL_MK = "N";

                        if (fileList != null || fileList.Count() > 0)
                        {
                            newApplyFile2.UPD_TIME = DateTime.Now;
                            newApplyFile2.UPD_FUN_CD = FUN_CD;
                            newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                        else
                        {
                            blIsNewPayPassPort = true;
                            newApplyFile2.APP_ID = APP_ID;
                            newApplyFile2.ADD_TIME = DateTime.Now;
                            newApplyFile2.ADD_FUN_CD = FUN_CD;
                            newApplyFile2.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            newApplyFile2.UPD_TIME = DateTime.Now;
                            newApplyFile2.UPD_FUN_CD = FUN_CD;
                            newApplyFile2.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        }
                    }
                }

                if (updField == "FILE_2" || updField.IndexOf("ALL_") >= 0)
                {
                    if (!blUpdAth)
                    {
                        blUpdAth = true;

                        athWhere.APP_ID = APP_ID;
                        athFileList = dao.GetRowList(athWhere);
                    }
                }

                if (updField.IndexOf("ALL_") >= 0) { blUpdApply = true; }

            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    conn.Open();
                    SqlTransaction tran = conn.BeginTransaction();
                    this.Tran(conn, tran);

                    #region 補件更新-繳費紀錄照片或pdf檔案(apply_file)
                    if (blUpdPayRec)
                    {
                        if (blIsNewPayRec)
                        {
                            base.Insert(newApplyFile1);
                        }
                        else
                        {
                            base.Update(newApplyFile1, whereApplyFile1);
                        }
                    }
                    #endregion

                    #region 補件更新-護照影本電子檔(apply_file)
                    if (blUpdPassPort)
                    {
                        if (blIsNewPayPassPort)
                        {
                            base.Insert(newApplyFile2);
                        }
                        else
                        {
                            base.Update(newApplyFile2, whereApplyFile2);
                        }
                    }
                    #endregion

                    #region 補件更新-醫事人員/專科中文證書電子檔(apply_001008_ath)
                    Apply_001008_AthModel newAth = null;
                    Apply_001008_AthModel athwhere = null;

                    if (model.ATHs != null)
                    {
                        foreach (var athItem in model.ATHs)
                        {
                            if (athItem.FILE_1 != null)
                            {
                                newAth = new Apply_001008_AthModel();

                                newAth.APP_ID = APP_ID;
                                newAth.SRL_NO = athItem.SRL_NO;
                                newAth.NOTICE_NO = (times + 1);
                                //newAth.ATH_UP = dao.PutFile("001008", APP_ID, athItem.FILE_1, athItem.SRL_NO.ToString(), "_ATH_UP_");
                                newAth.ATH_UP = dao.PutFile("001008", "", athItem.FILE_1, athItem.SRL_NO.ToString(), "_ATH_UP_");
                                newAth.SRC_FILENAME = athItem.FILE_1.FileName;
                                newAth.DEL_MK = "N";

                                if (athFileList.Where(m => m.SRL_NO == athItem.SRL_NO).Count() == 0)
                                {
                                    newAth.UPD_TIME = DateTime.Now;
                                    newAth.UPD_FUN_CD = FUN_CD;
                                    newAth.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                    newAth.ADD_TIME = DateTime.Now;
                                    newAth.ADD_FUN_CD = FUN_CD;
                                    newAth.ADD_ACC = UserInfo.ACC_NO.TONotNullString();

                                    base.Insert(newAth);
                                }
                                else
                                {
                                    athwhere = new Apply_001008_AthModel();
                                    athwhere.APP_ID = APP_ID;
                                    athwhere.SRL_NO = athItem.SRL_NO;

                                    newAth.UPD_TIME = DateTime.Now;
                                    newAth.UPD_FUN_CD = FUN_CD;
                                    newAth.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                                    base.Update(newAth, athwhere);
                                }
                            }
                        }
                    }


                    //if (athFileList != null)
                    //{
                    //    for (int i = 0; i < athFileList.Count(); i++)
                    //    {
                    //        if (model.ATHs[i].FILE_1 != null)
                    //        {
                    //            athWhere.APP_ID = APP_ID;
                    //            athWhere.SRL_NO = athFileList[i].SRL_NO;

                    //            newAth = new Apply_001008_AthModel();
                    //            newAth.APP_ID = APP_ID;
                    //            newAth.SRL_NO = i + 1;
                    //            newAth.ATH_UP = dao.PutFile("001008", APP_ID, model.ATHs[i].FILE_1, (i+1).ToString(), "_ATH_UP_");
                    //            newAth.SRC_FILENAME = model.ATHs[i].FILE_1.FileName;
                    //            newAth.SRC_NO = (times + 1);
                    //            newAth.UPD_TIME = DateTime.Now;
                    //            newAth.UPD_FUN_CD = FUN_CD;
                    //            newAth.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //            newAth.ADD_TIME = DateTime.Now;
                    //            newAth.ADD_FUN_CD = FUN_CD;
                    //            newAth.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //            newAth.DEL_MK = "N";

                    //            base.Insert(newAth);
                    //        }
                    //    }
                    //}
                    #endregion

                    #region 補件更新-案件主檔(apply, apply_001008)
                    if (blUpdApply)
                    {
                        newApply.ENAME = model.ENAME;
                        //newApply.E_ALIAS_NAME = (string.IsNullOrWhiteSpace(model.ENAME_ALIAS) ? "" : model.ENAME_ALIAS);//補清空非必填欄位
                        newApply.ADDR_CODE = model.ADDR_ZIP;
                        newApply.ADDR = model.ADDR_ZIP_DETAIL;
                        newApply.TEL = (string.IsNullOrWhiteSpace(model.TEL) ? "" : model.TEL); // 20201221 補清空非必填欄位
                        newApply.MOBILE = model.MOBILE;

                        newApply001008.ENAME_ALIAS = (string.IsNullOrWhiteSpace(model.ENAME_ALIAS) ? "" : model.ENAME_ALIAS);//補清空非必填欄位
                        newApply001008.EMAIL = model.EMAIL;
                        newApply001008.REMARK = (string.IsNullOrWhiteSpace(model.REMARK) ? "" : model.REMARK);//補清空非必填欄位
                        newApply001008.MERGEYN = model.MERGEYN;
                        newApply001008.UPD_TIME = DateTime.Now;
                        newApply001008.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        newApply001008.UPD_FUN_CD = FUN_CD;
                        //base.Update(newApply001008, whereApply001008);
                        base.Update2(newApply001008, whereApply001008, dict2); //for log歷程顯示前置作業用
                    }

                    newApply.UPD_TIME = DateTime.Now;
                    newApply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    newApply.UPD_FUN_CD = FUN_CD;
                    newApply.FLOW_CD = "3"; //註記補件收件
                    //base.Update(newApply, whereApply);
                    base.Update2(newApply, whereApply, dict2); //for log歷程顯示前置作業用
                    #endregion

                    #region 補件更新-醫事人員請領英文證明書_國內地址(apply_001008_trans)
                    if (blUpdApply && model.TRANS != null && model.TRANS.GoodsList != null)
                    {
                        Apply_001008_TransModel oldTransWhere = new Apply_001008_TransModel { APP_ID = APP_ID };
                        Apply_001008_TransModel newTrans = null;
                        //先刪除後新增
                        base.Delete(oldTransWhere);

                        model.TRANS.APP_ID = APP_ID;

                        foreach (var item in model.TRANS.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANS_ZIP_ADDR) && !string.IsNullOrWhiteSpace(item.TRANS_ZIP_DETAIL) && item.TRANS_COPIES != null)
                            {
                                newTrans = new Apply_001008_TransModel();
                                newTrans.APP_ID = APP_ID;
                                newTrans.SRL_NO = index;
                                newTrans.TRANS_ZIP = item.TRANS_ZIP;
                                newTrans.TRANS_ADDR = item.TRANS_ZIP_DETAIL;
                                newTrans.TRANS_COPIES = item.TRANS_COPIES;
                                newTrans.ADD_TIME = DateTime.Now;
                                newTrans.ADD_FUN_CD = FUN_CD;
                                newTrans.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.UPD_TIME = DateTime.Now;
                                newTrans.UPD_FUN_CD = FUN_CD;
                                newTrans.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTrans.DEL_MK = "N";

                                base.Insert(newTrans);
                                index++;
                            }
                        }

                        //model.TRANS.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    #region 補件更新-醫事人員請領英文證明書_國外地址(apply_001008_transf)
                    if (blUpdApply && model.TRANSF != null && model.TRANSF.GoodsList != null)
                    {
                        Apply_001008_TransFModel oldTransFWhere = new Apply_001008_TransFModel { APP_ID = APP_ID };
                        Apply_001008_TransFModel newTransF = null;
                        //先刪除後新增
                        base.Delete(oldTransFWhere);

                        model.TRANSF.APP_ID = APP_ID;
                        index = 1;
                        foreach (var item in model.TRANSF.GoodsList)
                        {
                            if (!string.IsNullOrWhiteSpace(item.TRANSF_ADDR) && item.TRANSF_COPIES != null)
                            {
                                newTransF = new Apply_001008_TransFModel();

                                newTransF.APP_ID = APP_ID;
                                newTransF.SRL_NO = index;
                                newTransF.TRANSF_ADDR = item.TRANSF_ADDR;
                                newTransF.TRANSF_UNITNAME = item.TRANSF_UNITNAME; //20201221 add [MOHES-890]醫事人員請領英文證明書-001008-(前台)申辦案件的國外寄送地址區塊增加一個機構名稱的欄位
                                newTransF.TRANSF_COPIES = item.TRANSF_COPIES;
                                newTransF.ADD_TIME = DateTime.Now;
                                newTransF.ADD_FUN_CD = FUN_CD;
                                newTransF.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.UPD_TIME = DateTime.Now;
                                newTransF.UPD_FUN_CD = FUN_CD;
                                newTransF.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                newTransF.DEL_MK = "N";

                                base.Insert(newTransF);
                                index++;
                            }
                        }

                        //model.TRANS.SaveGoodsList("SRL_NO");
                    }
                    #endregion

                    //Apply_Notice狀態更新
                    #region 案件通知(apply_notice)
                    TblAPPLY_NOTICE applyNotice = new TblAPPLY_NOTICE();
                    applyNotice.APP_ID = APP_ID;
                    applyNotice.ISADDYN = "Y";
                    TblAPPLY_NOTICE whereApplyNotice = new TblAPPLY_NOTICE();
                    whereApplyNotice.APP_ID = APP_ID;
                    whereApplyNotice.ISADDYN = "N";

                    //base.Update(applyNotice, whereApplyNotice);
                    base.Update2(applyNotice, whereApplyNotice, dict2); //for log歷程顯示前置作業用
                    #endregion

                    tran.Commit();
                    //tran.Rollback();
                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn("SaveAppDoc001008 ex:" + ex.Message, ex);
                    result = false;
                    tran.Rollback();

                    throw ex;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }
        #endregion

        #region Apply_010002 低收入戶及中低收入戶之體外受精（俗稱試管嬰兒）補助方案

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply010002(Apply_010002FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UsrMember = sm.UserInfo.Member;
            string s_SRV_ID = "010002";
            string s_FUN_CD1 = "WEB-APPLY";
            //var APP_ID = GetApp_ID(CaseNum);
            var paydt = dao.getPayInfo(s_SRV_ID);
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    // 申請時費用-APP_FEE
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    // 付款方式-PAY_METHOD /B/C/D/S/T/0/NULL/空
                    // B:臨櫃(現金) /C:信用卡/D:匯(支)票/S:超商/T:劃撥
                    form.PAY_METHOD = null;//paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    // 繳費時機點-A:不需繳費/B:/C:/D:審核後繳費-PAY_POINT
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UsrMember);

                    //where.ADDR_CODE = form.ADDR_CODE;
                    //where.ADDR = form.ADDR;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    //if (HTEL.TONotNullString() != "") where.TEL = HTEL.TONotNullString();
                    //else if (WTEL.TONotNullString() != "") where.TEL = WTEL.TONotNullString();
                    //else where.TEL = MOBILE.TONotNullString();

                    where.SEX_CD = form.SEX_CD;
                    where.TEL = (form.TEL.TONotNullString() != "") ? form.TEL.TONotNullString() : form.MOBILE.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.UNIT_CD = 69; //8 社會救助及社工司-UNIT //69 國民健康署
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId(s_SRV_ID);
                    where.PRO_UNIT_CD = GetServiceFixUnitCd(s_SRV_ID);

                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = (("Y".Equals(form.MYDATA_GET1)) ? "Y" : "N"); //(MYDATA_GET-預設為刪除資訊)

                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1"; //1:新案收件3:補件收件
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);


                    // Insert 案件 Apply_010002
                    Apply_010002Model app = new Apply_010002Model();
                    app.InjectFrom(form);

                    app.APPLY_DATE = form.APPLY_DATE;
                    app.EMAIL = form.EMAIL;

                    app.C_ZIPCODE = form.C_ZIPCODE;
                    app.C_ADDR = form.C_ADDR;
                    app.H_ZIPCODE = form.H_ZIPCODE;
                    app.H_ADDR = form.H_ADDR;
                    app.H_EQUAL = form.H_EQUAL;

                    app.MERGEYN = form.MERGEYN;

                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = s_FUN_CD1;
                    app.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = s_FUN_CD1;
                    app.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    app.FILE_IDCNF = "1";
                    app.FILE_IDCNB = "2";
                    app.FILE_DISEASE = "3";
                    app.FILE_LOWREC = "4";
                    base.Insert(app);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDCNF, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDCNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDCNF, app.FILE_IDCNF);
                        file.SRC_FILENAME = form.FILE_IDCNF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_IDCNB, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_IDCNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_IDCNB, app.FILE_IDCNB);
                        file.SRC_FILENAME = form.FILE_IDCNB_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_DISEASE, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_DISEASE.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_DISEASE, app.FILE_DISEASE);
                        file.SRC_FILENAME = form.FILE_DISEASE_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app.FILE_LOWREC, out i_NO);
                    if (flag_FILE_NO_OK && !form.FILE_LOWREC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_LOWREC, app.FILE_LOWREC);
                        file.SRC_FILENAME = form.FILE_LOWREC_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply010002 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_010002AppDocModel GetFile_010002(string APP_ID)
        {
            Apply_010002AppDocModel result = new Apply_010002AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object> { { "@APP_ID", APP_ID } };
            DynamicParameters parameters = new DynamicParameters(dictionary);
            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_IDCNF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_IDCNB_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_DISEASE_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_LOWREC_TEXT
    FROM APPLY app 
    where 1=1 
    and app.APP_ID = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_010002AppDocModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }
            return result;
        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public string UpdateApply010002(Apply_010002AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "010002";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0; //補件數
            int iSRC_NO = 2;  //補件由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);

                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    //Update(andata, anwhere);
                    Update2(andata, anwhere, dict2);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    //appdata.TEL = model.TEL_0.TONotNullString() != "" && model.TEL_1.TONotNullString() != "" ?
                    //    (model.TEL_2.TONotNullString() != "" ? model.TEL_0.TONotNullString() + "-" + model.TEL_1.TONotNullString() + "#" + model.TEL_2.TONotNullString() : model.TEL_0.TONotNullString() + "-" + model.TEL_1.TONotNullString()) : "";
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8; //社會救助及社工司-UNIT
                    appdata.FLOW_CD = "3";//1:新案收件3:補件收件
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //Update(appdata, appwhere);
                    Update2(appdata, appwhere, dict2);

                    Apply_010002Model app_SN_where = new Apply_010002Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_010002Model app_SN_data = new Apply_010002Model();
                    app_SN_data.InjectFrom(model);
                    switch (model.SPEMAIL_1.TONotNullString())
                    {
                        case "0":
                            app_SN_data.SPEMAIL = model.SPEMAIL_0 + "@" + model.SPEMAIL_2;
                            break;
                        case "1":
                            app_SN_data.SPEMAIL = model.SPEMAIL_0 + "@gmail.com";
                            break;
                        case "2":
                            app_SN_data.SPEMAIL = model.SPEMAIL_0 + "@yahoo.com.tw";
                            break;
                        case "3":
                            app_SN_data.SPEMAIL = model.SPEMAIL_0 + "@outlook.com";
                            break;
                    }
                    app_SN_data.TEL = model.TEL_0.TONotNullString() != "" && model.TEL_1.TONotNullString() != "" ?
                        (model.TEL_2.TONotNullString() != "" ? model.TEL_0.TONotNullString() + "-" + model.TEL_1.TONotNullString() + "#" + model.TEL_2.TONotNullString() : model.TEL_0.TONotNullString() + "-" + model.TEL_1.TONotNullString()) : "";
                    app_SN_data.SPTEL = model.SPTEL_0.TONotNullString() != "" && model.SPTEL_1.TONotNullString() != "" ?
                        (model.SPTEL_2.TONotNullString() != "" ? model.SPTEL_0.TONotNullString() + "-" + model.SPTEL_1.TONotNullString() + "#" + model.SPTEL_2.TONotNullString() : model.SPTEL_0.TONotNullString() + "-" + model.SPTEL_1.TONotNullString()) : "";
                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //app_SN_data.DEL_MK = "N";
                    app_SN_data.FILE_IDCNF = "1";
                    app_SN_data.FILE_IDCNB = "2";
                    app_SN_data.FILE_DISEASE = "3";
                    app_SN_data.FILE_LOWREC = "4";
                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);
                    //儲存
                    //Update(app_SN_data, app_SN_where);

                    #region 檔案上傳
                    int i_NO = 0;//轉換檔案數字
                    bool flag_FILE_NO_OK = false; //是否為有效數字

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDCNF, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDCNF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDCNF, app_SN_data.FILE_IDCNF);
                        file.SRC_FILENAME = model.FILE_IDCNF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_IDCNB, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_IDCNB.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_IDCNB, app_SN_data.FILE_IDCNB);
                        file.SRC_FILENAME = model.FILE_IDCNB_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_DISEASE, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_DISEASE.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_DISEASE, app_SN_data.FILE_DISEASE);
                        file.SRC_FILENAME = model.FILE_DISEASE_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    flag_FILE_NO_OK = int.TryParse(app_SN_data.FILE_LOWREC, out i_NO);
                    if (flag_FILE_NO_OK && !model.FILE_LOWREC.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = i_NO;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_LOWREC, app_SN_data.FILE_LOWREC);
                        file.SRC_FILENAME = model.FILE_LOWREC_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply010002 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }

        /// <summary>
        /// 更新 MyData 資料
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public void UpdateApply010002MyData(Apply_010002Model model)
        {
            SessionModel sm = SessionModel.Get();
            string accNo = "SYSTEM";
            if (sm != null && sm.UserInfo != null && sm.UserInfo.Member != null)
            {
                ClamMember UserInfo = sm.UserInfo.Member;
                accNo = UserInfo.ACC_NO.TONotNullString();
            }

            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "010002";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            if (!string.IsNullOrEmpty(model.MYDATA_RTN_CODE) && !string.IsNullOrEmpty(model.MYDATA_RTN_CODE_DESC))
            {
                //非200-OK
                //.在 MyData 畫面，點擊「不同意傳送」按鈕 或2.申請人在 MyData 中途關閉網頁
                //(1).前台後台的案件進度狀態由「新收案件」變更為「退件」。
                //(2).後台 將此案件歸入在「已結案」。
                string s_FLOW_CD = string.Empty;
                //有返回值 (flag_MyData_Return: true)
                bool flag_MyData_Return = false;
                if (model.MYDATA_RTN_CODE.Length > 0 && model.MYDATA_RTN_CODE_DESC.Length > 0)
                {
                    //有返回值
                    flag_MyData_Return = true;
                    //8:退件 - SELECT CODE_CD AS CODE,CODE_DESC AS TEXT FROM CODE_CD WHERE DEL_MK = 'N' AND CODE_PCD =10 AND CODE_KIND = 'F_CASE_STATUS' ORDER BY SEQ_NO 
                    if (!"200".Equals(model.MYDATA_RTN_CODE)) { s_FLOW_CD = "8"; }
                }

                if (this.conn == null) { this.conn = DataUtils.GetConnection(); }
                if (!string.IsNullOrEmpty(s_FLOW_CD))
                {
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    appdata.APP_ID = model.APP_ID;
                    appdata.FLOW_CD = s_FLOW_CD;
                    appdata.DEL_MK = "N"; //(MYDATA_GET-預設為刪除資訊)
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = accNo;
                    if (this.conn.State == ConnectionState.Closed) { this.conn.Open(); }
                    this.Update(appdata, appwhere); //紀錄log
                }
                else if (flag_MyData_Return)
                {
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    appdata.APP_ID = model.APP_ID;
                    appdata.DEL_MK = "N"; //(MYDATA_GET-預設為刪除資訊)
                    if (this.conn.State == ConnectionState.Closed) { this.conn.Open(); }
                    this.Update(appdata, appwhere); //紀錄log
                }
            }

            Apply_010002Model app_SN_where = new Apply_010002Model();
            app_SN_where.APP_ID = model.APP_ID;
            Apply_010002Model app_SN_data = new Apply_010002Model();
            // Update 案件 (取得資料)
            app_SN_data.InjectFrom(model);

            app_SN_data.APP_ID = model.APP_ID;
            app_SN_data.UPD_TIME = DateTime.Now;
            app_SN_data.UPD_FUN_CD = s_FUN_CD1;
            app_SN_data.UPD_ACC = accNo;

            //儲存異動前後
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    base.conn = conn;
                    conn.Open();
                    Update2(app_SN_data, app_SN_where, dict2);
                }
                catch (Exception ex)
                {
                    logger.Error("UpdateApply010002MyData: " + ex.Message, ex);
                    throw new Exception("UpdateApply010002MyData: " + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            };
        }

        /// <summary>
        /// 儲存 MyData /service/data 的結果
        /// <para>因為會由背景 Worker Thread 呼叫執行，SessionModel 不存在，
        /// 無法使用 BaseAction 的 Update2 功能，改為直接執行SQL指令</para>
        /// </summary>
        /// <param name="model"></param>
        public void UpdateApply010002MyDataResult(Apply_010002Model model)
        {
            SessionModel sm = SessionModel.Get();
            string accNo = "SYSTEM";
            if (sm != null && sm.UserInfo != null && sm.UserInfo.Member != null)
            {
                ClamMember UserInfo = sm.UserInfo.Member;
                accNo = UserInfo.ACC_NO.TONotNullString();
            }

            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "010002";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            Apply_010002Model app_SN_where = new Apply_010002Model();
            app_SN_where.APP_ID = model.APP_ID;
            // Update 案件
            Apply_010002Model app_SN_data = new Apply_010002Model();
            app_SN_data.InjectFrom(model);
            app_SN_data.APP_ID = model.APP_ID;
            app_SN_data.UPD_TIME = DateTime.Now;
            app_SN_data.UPD_FUN_CD = s_FUN_CD1;
            app_SN_data.UPD_ACC = accNo;

            //儲存異動前後
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {
                    base.conn = conn;
                    conn.Open();

                    string sql = "Update APPLY_010002 Set " +
                        "MYDATA_TX_TIME=@MYDATA_TX_TIME, " +
                        "MYDATA_IDCN=@MYDATA_IDCN, " +
                        "MYDATA_LOWREC=@MYDATA_LOWREC, " +
                        "MYDATA_TX_RESULT_MSG=@MYDATA_TX_RESULT_MSG " +
                        "Where APP_ID=@APP_ID";

                    SqlCommand sCmd = new SqlCommand(sql, conn);
                    sCmd.Parameters.Clear();
                    sCmd.Parameters.Add("MYDATA_TX_TIME", SqlDbType.DateTime).Value = model.MYDATA_TX_TIME;
                    sCmd.Parameters.Add("MYDATA_IDCN", SqlDbType.VarChar).Value = model.MYDATA_IDCN;
                    sCmd.Parameters.Add("MYDATA_LOWREC", SqlDbType.VarChar).Value = model.MYDATA_LOWREC;
                    sCmd.Parameters.Add("MYDATA_TX_RESULT_MSG", SqlDbType.VarChar).Value = model.MYDATA_TX_RESULT_MSG;
                    sCmd.Parameters.Add("APP_ID", SqlDbType.VarChar).Value = model.APP_ID;

                    if (sCmd.ExecuteNonQuery() != 1)
                    {
                        throw new Exception("資料(APP_ID=" + model.APP_ID + ")更新失敗(影響筆數不為1)");
                    }
                }
                catch (Exception ex)
                {
                    logger.Error("UpdateApply010002MyDataResult: " + ex.Message, ex);
                    throw new Exception("UpdateApply010002MyDataResult: " + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            };
        }
        #endregion

        #region Apply_001010
        public bool RunPayTranx(Apply_001010ViewModel model)
        {
            bool result = false;
            TblSERVICE service = new TblSERVICE();
            TblSERVICE serviceWhere = new TblSERVICE();
            serviceWhere.SRV_ID = "001010";
            service = this.GetRow<TblSERVICE>(serviceWhere);
            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            model.APP_ID = GetApp_ID("001010");

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    FormAction action = new FormAction(conn, tran);
                    Dictionary<string, string> form = action.GetFormBase("001010");
                    MapUtils data = new MapUtils();

                    data.Put("PAY_A_FEEBK", model.PAY_METHOD.Equals("S") ? DataUtils.GetConfig("PAY_STORE_FEE") : "0");
                    data.Put("APP_FEE", (model.PAY_A_FEE + Int32.Parse(data.Get("PAY_A_FEEBK"))).ToString());

                    if (model.PAY_METHOD.Equals("S"))
                    {
                        string stordId = action.GetPayStoreSerial(DateTime.Now.ToString("yyyyMM"));
                        data.Put("PAY_SESSION_KEY", PayUtils.GetVirtualAccount(stordId, Int32.Parse(data.Get("APP_FEE"))));
                        logger.Debug("stordId: " + stordId);
                        model.SessionTransactionKey = data.GetItem()["PAY_SESSION_KEY"];
                    }

                    ApplyModel apply = new ApplyModel();
                    apply.InjectFrom(UserInfo);
                    apply.MOBILE = model.MOBILE.TONotNullString() != "" ? model.MOBILE.TONotNullString() : UserInfo.MOBILE.TONotNullString();
                    apply.APP_ID = model.APP_ID;
                    apply.IDN = model.APPLY_PID;
                    apply.NAME = model.APPLY_NAME;
                    apply.SRV_ID = "001010";
                    apply.SRC_SRV_ID = "001010";
                    apply.APP_EXT_DATE = this.GetNTFD("001010");
                    apply.ADDR_CODE = model.CITY_CODE;
                    apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                    apply.TEL = model.TEL;
                    apply.PAY_A_FEE = model.PAY_A_FEE;
                    apply.PAY_POINT = service.PAY_POINT;
                    apply.PAY_METHOD = model.PAY_METHOD;
                    apply.PAY_A_FEEBK = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    apply.PAY_A_PAID = 0;
                    apply.UNIT_CD = 4;
                    apply.PRO_UNIT_CD = 4;
                    apply.FLOW_CD = "1";
                    apply.APP_TIME = DateTime.Now;
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    this.Insert(apply);

                    Apply_001010Model apply001010 = new Apply_001010Model();
                    apply001010.APP_ID = model.APP_ID;
                    apply001010.DIVISION = model.DIVISION;
                    apply001010.ISSUE_DEPT = model.ISSUE_DEPT;
                    apply001010.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                    //apply001010.ACTION_RES = model.ACTION_RES;
                    //apply001010.OTHER_RES = model.OTHER_RES;
                    //apply001010.ACTION_TYPE = model.ACTION_TYPE;
                    apply001010.COPIES = model.COPIES;
                    apply001010.TOTAL_MEM = model.TOTAL_MEM;
                    apply001010.LIC_CD = model.LIC_CD;
                    apply001010.LIC_TYPE = model.LIC_TYPE;
                    apply001010.LIC_NUM = model.LIC_NUM;
                    apply001010.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                    apply001010.ADD_TIME = DateTime.Now;
                    apply001010.ADD_FUN_CD = "WEB-APPLY";
                    apply001010.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001010.UPD_TIME = DateTime.Now;
                    apply001010.UPD_FUN_CD = "WEB-APPLY";
                    apply001010.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply001010.DEL_MK = "N";
                    this.Insert(apply001010);

                    APPLY_PAY applyPay = new APPLY_PAY();
                    applyPay.APP_ID = model.APP_ID;
                    applyPay.PAY_ID = model.APP_ID;
                    apply.SRV_ID = "001010";
                    applyPay.PAY_METHOD = model.PAY_METHOD;
                    applyPay.PAY_STATUS_MK = "N";
                    applyPay.PAY_MONEY = model.PAY_A_FEE;
                    applyPay.PAY_PROFEE = DataUtils.GetConfig("PAY_STORE_FEE").TOInt32();
                    applyPay.SESSION_KEY = model.SessionTransactionKey;
                    applyPay.PAY_ACT_TIME = DateTime.Now;
                    applyPay.CLIENT_IP = model.CLIENT_IP;
                    applyPay.ADD_TIME = DateTime.Now;
                    applyPay.ADD_FUN_CD = "WEB-APPLY";
                    applyPay.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.UPD_TIME = DateTime.Now;
                    applyPay.UPD_FUN_CD = "WEB-APPLY";
                    applyPay.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    applyPay.DEL_MK = "N";
                    this.Insert(applyPay);

                    //if (model.ATTACH_FILE != null)
                    //{
                    //    Apply_FileModel file = new Apply_FileModel();
                    //    file.APP_ID = model.APP_ID;
                    //    file.FILENAME = shareDao.PutFile("001010", model.ATTACH_FILE, "1");
                    //    file.SRC_FILENAME = model.ATTACH_FILE.FileName;
                    //    file.FILE_NO = 1;
                    //    file.ADD_TIME = DateTime.Now;
                    //    file.ADD_FUN_CD = "WEB-APPLY";
                    //    file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //    file.UPD_TIME = DateTime.Now;
                    //    file.UPD_FUN_CD = "WEB-APPLY";
                    //    file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    //    file.DEL_MK = "N";
                    //    this.Insert(file);
                    //}

                    BackApplyDAO backDao = new BackApplyDAO();
                    string subject = "醫事人員或公共衛生師證書影本申請書，案件編號﹕" + model.APP_ID + " 申請通知";
                    string MailBody = "";
                    MailBody += model.APPLY_NAME + "，您好:<br/><br/>";
                    MailBody += "您於民國" + model.APPLY_DATE.Substring(0, 3) + "年" + model.APPLY_DATE.Substring(4, 2) + "月" + model.APPLY_DATE.Substring(7, 2) + "日申辦之醫事人員或公共衛生師證書影本申請書案件<br/>";
                    MailBody += "申請編號：<a href='" + ConfigModel.NoticeMailUrl + "/Apply_001010/AppDoc?APP_ID=" + model.APP_ID + "'>" + model.APP_ID + "</a>現在進度為'新收案件'<br/>";
                    MailBody += "特此通知。感謝您使用衛生福利部線上申辦系統<br/><br/>";
                    MailBody += "衛生福利部醫事司敬上<br/><br/>";
                    MailBody += "PS.本郵件係系統自動發信，請勿直接回信；如有問題，請逕向本部相關業務單位洽詢。<br><br>";
                    MailBody += "※非移植目的承辦單位：食品藥物管理署藥品及新興生技藥品組(02)2787-8000<br>";
                    MailBody += "115209 臺北市南港區昆陽街161-2號<br><br>";
                    MailBody += "※移植目的承辦單位：衛生福利部醫事司(02)8590-6666<br>";
                    MailBody += "115204 臺北市南港區忠孝東路六段488號";
                    backDao.SendMail(model.MAIL, subject, MailBody);

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("RunPayTranx failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }


        /// <summary>
        /// 取得醫事人員證書補(換)發
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_001010ViewModel QueryApply_001010(Apply_001010ViewModel parm)
        {
            Apply_001010ViewModel result = new Apply_001010ViewModel();
            result.Apply = new ApplyModel();

            var dictionary = new Dictionary<string, object>
            {
                { "@APP_ID", parm.APP_ID }
            };
            var parameters = new DynamicParameters(dictionary);

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                try
                {

                    string _sql = @"SELECT APP_ID,ISSUE_DEPT,ISSUE_DATE,LIC_TYPE,LIC_CD,LIC_NUM,DEL_MK,DEL_TIME,DEL_FUN_CD,COPIES,TOTAL_MEM,
                                    DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,EMAIL,DIVISION
                             FROM APPLY_001010
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result = conn.QueryFirst<Apply_001010ViewModel>(_sql, parameters);

                    _sql = @"SELECT APP_ID,SRV_ID,SRC_SRV_ID,UNIT_CD,ACC_NO,IDN,SEX_CD,BIRTHDAY,NAME,ENAME,CNT_NAME,CNT_ENAME,CHR_NAME,CHR_ENAME,TEL,FAX,CNT_TEL,
	                              ADDR_CODE,ADDR,EADDR,CARD_IDN,APP_TIME,PAY_POINT,PAY_METHOD,PAY_BACK_MK,PAY_BACK_DATE,PAY_A_FEE,PAY_A_FEEBK,PAY_A_PAID,PAY_C_FEE,
	                              PAY_C_FEEBK,PAY_C_PAID,CHK_MK,ATM_VNO,API_MK,PRINT_MK,TRANS_ID,MOHW_CASE_NO,FLOW_CD,TO_MIS_MK,TO_ARCHIVE_MK,APP_STR_DATE,APP_EXT_DATE,
	                              APP_ACT_DATE,APP_DEFER_MK,APP_DEFER_TIME_S,APP_DEFER_TIME_E,APP_DEFER_DAYS,APP_DEFER_TIMES,APP_DISP_ACC,APP_DISP_MK,PRO_ACC,PRO_UNIT_CD,
	                              CLOSE_MK,APP_GRADE,APP_GRADE_TIME,APP_GRADE_LOG,NOTIFY_COUNT,NOTIFY_TYPE,CASE_BACK_MK,CASE_BACK_TIME,DIGITAL,LOGIN_TYPE,DEL_MK,DEL_TIME,
	                              DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,MARITAL_CD,CERT_SN,MOBILE,ISMODIFY,NOTICE_NOTE,MAILBODY
                              FROM APPLY
                              WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.Apply = conn.QueryFirst<ApplyModel>(_sql, parameters);

                    _sql = @" SELECT APP_ID, PAY_ID, PAY_MONEY, PAY_PROFEE, PAY_ACT_TIME, PAY_EXT_TIME, PAY_INC_TIME, PAY_METHOD, PAY_STATUS_MK, PAY_RET_CD,
                            PAY_RET_MSG, BATCH_NO, APPROVAL_CD, PAY_RET_NO, INVOICE_NO, PAY_DESC, CARD_NO, HOST_TIME, TRANS_RET, SESSION_KEY, AUTH_DATE,
                            AUTH_NO, SETTLE_DATE, OTHER, ROC_ID, CLIENT_IP, OID, SID, DEL_MK, DEL_TIME, DEL_FUN_CD, DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                            FROM APPLY_PAY
                            WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.ApplyPay = conn.QueryFirst<APPLY_PAY>(_sql, parameters);

                    //dictionary = new Dictionary<string, object>
                    //{
                    //    { "@ACC_NO", result.Apply.PRO_ACC }
                    //};
                    //parameters = new DynamicParameters(dictionary);

                    //_sql = @"SELECT ACC_NO, UNIT_CD, ADMIN_SCOPE, ADMIN_LEVEL, NAME, TEL, MAIL, AD_OU, SSO_KEY, IDN, LEVEL_UPD_TIME, DEL_MK, DEL_TIME, DEL_FUN_CD,
                    //            DEL_ACC, UPD_TIME, UPD_FUN_CD, UPD_ACC, ADD_TIME, ADD_FUN_CD, ADD_ACC
                    //            FROM ADMIN
                    //        WHERE 1=1";
                    //_sql += " AND ACC_NO = @ACC_NO";
                    //result.Admin = conn.QueryFirst<AdminModel>(_sql, parameters);

                    dictionary = new Dictionary<string, object>
                    {
                         { "@APP_ID", parm.APP_ID }
                    };
                    parameters = new DynamicParameters(dictionary);

                    _sql = @"SELECT APP_ID,FILE_NO,FILENAME,SRC_FILENAME,DEL_MK,DEL_TIME,DEL_FUN_CD,DEL_ACC,UPD_TIME,UPD_FUN_CD,UPD_ACC,ADD_TIME,ADD_FUN_CD,ADD_ACC,SRC_NO,BATCH_INDEX
                              FROM APPLY_FILE
                             WHERE 1 = 1";
                    _sql += " AND APP_ID = @APP_ID";
                    result.File = conn.Query<Apply_FileModel>(_sql, parameters).ToList<Apply_FileModel>().FirstOrDefault();

                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    result = null;
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            if (result != null)
            {
                BackApplyDAO dao = new BackApplyDAO();

                result.APPLY_NAME = result.Apply.NAME;

                result.APPLY_PID = result.Apply.IDN;

                //申請日期
                result.APPLY_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_TIME);

                //預計完成日期
                result.APP_EXT_DATE = HelperUtil.DateTimeToTwString(result.Apply.APP_EXT_DATE);

                //生日
                result.BIRTHDAY_AC = HelperUtil.DateTimeToString(result.Apply.BIRTHDAY);

                //核發日期
                result.ISSUE_DATE_AC = HelperUtil.DateTimeToString(result.ISSUE_DATE);

                // 電話
                if (result.Apply.TEL.TONotNullString() != "")
                {
                    string[] tel = result.Apply.TEL.Split('-');
                    if (result.Apply.TEL.TONotNullString().Trim() != "")
                    {
                        result.TEL_SEC = tel[0];
                        if (tel.ToCount() > 1)
                        {
                            result.TEL_NO = tel[1];

                            if (result.TEL_NO.Contains("#"))
                            {
                                result.TEL_NO = result.TEL_NO.Split('#')[0];
                            }

                            if (result.Apply.TEL.IndexOf('#') > 0)
                            {
                                result.TEL_EXT = result.Apply.TEL.Split('#')[1];
                            }
                        }

                    }
                }


                //地址
                TblZIPCODE zip = new TblZIPCODE();
                zip.ZIP_CO = result.Apply.ADDR_CODE;
                var address = dao.GetRow(zip);
                result.CITY_CODE = result.Apply.ADDR_CODE;
                if (address != null)
                {
                    result.CITY_TEXT = address.TOWNNM;
                    result.CITY_DETAIL = result.Apply.ADDR.TONotNullString().Replace(address.CITYNM + address.TOWNNM, "");
                }

                //Mail
                if (result.EMAIL.TONotNullString().Trim() != "")
                {
                    result.MAIL_ACCOUNT = result.EMAIL.Split('@')[0];
                    result.MAIL_DOMAIN = result.EMAIL.Split('@')[1];

                    switch (result.EMAIL.Split('@')[1])
                    {
                        case "gmail.com":
                            result.DOMAINList = "1";
                            break;
                        case "yahoo.com.tw":
                            result.DOMAINList = "2";
                            break;
                        case "outlook.com":
                            result.DOMAINList = "3";
                            break;
                        default:
                            result.DOMAINList = "0";
                            break;
                    }
                }

                ShareDAO shareDAO = new ShareDAO();
                if (shareDAO.CalculationDocDate("001007", parm.APP_ID) && result.Apply.FLOW_CD == "2")
                {
                    result.IsNotice = "N";
                }
                else
                {
                    result.IsNotice = "Y";
                }

            }

            return result;
        }


        public bool SaveAppDoc001010(Apply_001010ViewModel model)
        {
            bool result = false;

            ShareDAO shareDao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();
                try
                {
                    this.Tran(conn, tran);
                    model.APP_ID = model.Apply.APP_ID;
                    //增加歷程，需要下列參數
                    Dictionary<string, object> dict2 = new Dictionary<string, object>();
                    dict2.Add("APP_ID", model.APP_ID);
                    dict2.Add("SRV_ID", "001010");
                    dict2.Add("LastMODTIME", DateTime.Now.ToString("yyyyMMddHHmmss"));

                    if (model.Apply.ISMODIFY == "Y")
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.NAME = model.APPLY_NAME;
                        apply.IDN = model.APPLY_PID;
                        apply.BIRTHDAY = HelperUtil.TransToDateTime(model.BIRTHDAY_AC);
                        apply.ADDR_CODE = model.CITY_CODE;
                        apply.ADDR = model.CITY_TEXT + model.CITY_DETAIL;
                        apply.TEL = model.TEL_SEC.TONotNullString() != "" && model.TEL_NO.TONotNullString() != "" ?
                            (model.TEL_EXT.TONotNullString() != "" ? model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString() + "#" + model.TEL_EXT.TONotNullString() : model.TEL_SEC.TONotNullString() + "-" + model.TEL_NO.TONotNullString()) : "";
                        apply.MOBILE = model.MOBILE;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        this.Update2(apply, applyWhere, dict2);

                        Apply_001010Model apply001010Where = new Apply_001010Model();
                        apply001010Where.APP_ID = model.APP_ID;
                        Apply_001010Model apply001010 = new Apply_001010Model();
                        apply001010.APP_ID = model.APP_ID;
                        apply001010.DIVISION = model.DIVISION;
                        apply001010.EMAIL = model.MAIL_ACCOUNT + "@" + model.MAIL_DOMAIN.TONotNullString().Replace("@", "");
                        apply001010.LIC_CD = model.LIC_CD;
                        apply001010.LIC_TYPE = model.LIC_TYPE;
                        apply001010.LIC_NUM = model.LIC_NUM;
                        apply001010.ISSUE_DATE = HelperUtil.TransToDateTime(model.ISSUE_DATE_AC);
                        apply001010.ISSUE_DEPT = model.ISSUE_DEPT;
                        apply001010.UPD_TIME = DateTime.Now;
                        apply001010.UPD_FUN_CD = "WEB-APPLY";
                        apply001010.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        this.Update2(apply001010, apply001010Where, dict2);
                    }
                    else
                    {
                        ApplyModel applyWhere = new ApplyModel();
                        applyWhere.APP_ID = model.APP_ID;
                        ApplyModel apply = new ApplyModel();

                        apply.APP_ID = model.APP_ID;
                        apply.FLOW_CD = "3";
                        apply.ISMODIFY = "A";
                        apply.APP_TIME = DateTime.Now;
                        apply.ADD_TIME = DateTime.Now;
                        apply.ADD_FUN_CD = "WEB-APPLY";
                        apply.UPD_TIME = DateTime.Now;
                        apply.UPD_FUN_CD = "WEB-APPLY";
                        this.Update2(apply, applyWhere, dict2);
                    }

                    tran.Commit();

                    result = true;
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    result = false;
                    throw new Exception("SaveAppDoc001010 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }

            return result;
        }
        #endregion

        #region Apply_011010 全國社會工作專業人員選拔推薦

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public void AppendApply011010(Apply_011010FormModel form, string APP_ID)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UsrMember = sm.UserInfo.Member;
            string s_SRV_ID = "011010";
            string s_FUN_CD1 = "WEB-APPLY";
            var paydt = dao.getPayInfo(s_SRV_ID);
            if (paydt != null)
            {
                if (paydt.Rows.Count > 0)
                {
                    //申請時費用-APP_FEE
                    form.PAY_A_FEE = paydt.Rows[0]["APP_FEE"].TOInt32();
                    //付款方式-PAY_METHOD
                    form.PAY_METHOD = paydt.Rows[0]["PAY_METHOD"].TONotNullString();
                    //繳費時機點-A:不需繳費/B:/C:/D:審核後繳費-PAY_POINT
                    form.PAY_POINT = paydt.Rows[0]["PAY_POINT"].TONotNullString();
                }
            }

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(UsrMember);

                    where.SEX_CD = form.SEX_CD;
                    where.TEL = form.MOBILE.TONotNullString();
                    where.APP_ID = APP_ID;
                    where.SRV_ID = s_SRV_ID;
                    where.SRC_SRV_ID = s_SRV_ID;
                    where.UNIT_CD = 8; //社會救助及社工司-UNIT
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId(s_SRV_ID);
                    where.PRO_UNIT_CD = GetServiceFixUnitCd(s_SRV_ID);
                    where.APP_TIME = DateTime.Now;
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = s_FUN_CD1;
                    where.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = s_FUN_CD1;
                    where.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.APP_EXT_DATE = this.GetNTFD(s_SRV_ID);
                    where.PAY_POINT = form.PAY_POINT;
                    where.PAY_METHOD = form.PAY_METHOD;
                    where.PAY_A_FEE = form.PAY_A_FEE;
                    where.PAY_A_FEEBK = 0;
                    where.PAY_A_PAID = 0;
                    where.PAY_C_FEE = 0;
                    where.PAY_C_FEEBK = 0;
                    where.PAY_C_PAID = 0;
                    where.FLOW_CD = "1"; //1:新案收件3:補件收件
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    Apply_011010Model app = new Apply_011010Model();
                    //app.InjectFrom(form);

                    app.UNIT_TYPE = form.UNIT_TYPE;
                    app.UNIT_SUBTYPE = form.UNIT_SUBTYPE;
                    app.UNIT_NAME = form.UNIT_NAME;
                    app.UNIT_DEPART = form.UNIT_DEPART;
                    app.UNIT_TITLE = form.UNIT_TITLE;
                    app.UNIT_CNAME = form.UNIT_CNAME;
                    app.UNIT_TEL = form.UNIT_TEL;
                    app.UNIT_EMAIL = form.EMAIL;
                    app.CNT_TYPE = form.CNT_TYPE;
                    //app.CNT_A = Convert.ToString(Convert.ToInt32(form.CNT_A));
                    //app.CNT_B = Convert.ToString(Convert.ToInt32(form.CNT_B));
                    //app.CNT_C = Convert.ToString(Convert.ToInt32(form.CNT_A) + Convert.ToInt32(form.CNT_B));
                    app.CNT_D = Convert.ToString(Convert.ToInt32(form.CNT_D));
                    app.CNT_E = Convert.ToString(Convert.ToInt32(form.CNT_E));
                    app.CNT_F = Convert.ToString(Convert.ToInt32(form.CNT_F));
                    app.CNT_G = Convert.ToString(Convert.ToInt32(form.CNT_G));
                    app.CNT_H = Convert.ToString(Convert.ToInt32(form.CNT_H));
                    app.MERGEYN = form.MERGEYN;

                    app.APP_ID = APP_ID;
                    app.ADD_TIME = DateTime.Now;
                    app.ADD_FUN_CD = s_FUN_CD1;
                    app.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.UPD_TIME = DateTime.Now;
                    app.UPD_FUN_CD = s_FUN_CD1;
                    app.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                    app.DEL_MK = "N";

                    base.Insert(app);

                    #region 繳費資訊
                    APPLY_PAY pay = new APPLY_PAY();
                    pay.APP_ID = APP_ID;
                    pay.PAY_ID = APP_ID;
                    pay.PAY_MONEY = form.PAY_A_FEE;
                    pay.PAY_PROFEE = 0;
                    pay.PAY_ACT_TIME = DateTime.Now;//新增時間
                    //pay.PAY_EXT_TIME = DateTime.Now;//繳費時間
                    pay.PAY_INC_TIME = DateTime.Now;//異動時間
                    pay.PAY_METHOD = form.PAY_METHOD;
                    pay.PAY_STATUS_MK = "N";
                    pay.UPD_TIME = DateTime.Now;
                    pay.UPD_FUN_CD = s_FUN_CD1;
                    pay.ADD_TIME = DateTime.Now;
                    pay.ADD_FUN_CD = s_FUN_CD1;
                    base.Insert(pay);
                    #endregion

                    #region 檔案上傳

                    if (!form.FILE_EXCEL.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_EXCEL, "1");
                        file.SRC_FILENAME = form.FILE_EXCEL_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    if (!form.FILE_PDF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile(s_SRV_ID, form.FILE_PDF, "2");
                        file.SRC_FILENAME = form.FILE_PDF_TEXT;
                        file.SRC_NO = 1;//(第1次新增)
                        file.NOTICE_NO = 1;//(第1次新增)
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        base.Insert(file);
                    }
                    #endregion

                    #region 推薦表(PDF檔)
                    var extcnt = 1;
                    foreach (var item in form.SRVLIST)
                    {
                        var FILE_3 = "";
                        if (!item.FILE_3.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 3; //推薦表(PDF檔)
                            file.SRC_NO = 1; //(第1次新增)
                            file.BATCH_INDEX = extcnt;
                            file.FILENAME = dao.PutFile("011003", item.FILE_3, "3");
                            FILE_3 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_3_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UsrMember.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UsrMember.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                            extcnt++;
                        }
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();
                    throw new Exception("AppendApply011010 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011010AppDocModel GetFile_011010(string APP_ID)
        {
            Apply_011010AppDocModel result = new Apply_011010AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"select app.APP_ID,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_EXCEL_TEXT,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_PDF_TEXT
                            ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_3_TEXT
                            FROM APPLY app 
                            where 1=1 ";
            _sql += " and app.app_id = '" + APP_ID + "'";

            string _files = "SELECT AF.* ";
            _files += "FROM APPLY_FILE AF ";
            _files += "JOIN ( ";
            _files += "    SELECT BATCH_INDEX, MAX(NOTICE_NO) AS MaxNoticeNo ";
            _files += "    FROM APPLY_FILE ";
            _files += "    WHERE ISNULL(BATCH_INDEX,'0') > '0' ";
            _files += "      AND APP_ID ='" + APP_ID + "'";
            _files += "    GROUP BY BATCH_INDEX ";
            _files += ") T ";
            _files += "  ON AF.BATCH_INDEX = T.BATCH_INDEX ";
            _files += " AND AF.NOTICE_NO = T.MaxNoticeNo ";
            _files += "WHERE 1=1 ";
            _files += " and AF.APP_ID ='" + APP_ID + "'";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.Query<Apply_011010AppDocModel>(_sql).FirstOrDefault();
                result.FILE = conn.Query<Apply_011010FILEModel>(_files).ToList();
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_011010DetailModel GetDetailFile_011010(string APP_ID)
        {
            Apply_011010DetailModel result = new Apply_011010DetailModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"
    select app.APP_ID
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_EXCEL_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_PDF_TEXT
    ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_3_TEXT
    FROM APPLY app 
    where 1=1 
    and app.app_id = @APP_ID";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.QueryFirst<Apply_011010DetailModel>(_sql, parameters);
                result.APP_ID = APP_ID;
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        /// <summary>
        /// 補件存檔
        /// </summary>
        /// <returns></returns>
        public string UpdateApply011010(Apply_011010AppDocModel model)
        {
            ShareDAO dao = new ShareDAO();
            SessionModel sm = SessionModel.Get();
            ClamMember UserInfo = sm.UserInfo.Member;
            string LastMODTIME = DateTime.Now.ToString("yyyyMMddHHmmss");
            string s_SRV_ID = "011010";
            string s_FUN_CD1 = "WEB-APPLY";
            Dictionary<string, object> dict2 = new Dictionary<string, object>();
            dict2.Add("APP_ID", model.APP_ID);
            dict2.Add("SRV_ID", s_SRV_ID);
            dict2.Add("LastMODTIME", LastMODTIME);

            //var APP_ID = GetApp_ID(CaseNum);
            int Count = 0; //補件數
            int iSRC_NO = 2; //補件序號由2開始
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    //取得補件件數
                    TblAPPLY_NOTICE an = new TblAPPLY_NOTICE();
                    an.APP_ID = model.APP_ID;
                    an.ISADDYN = "N"; //未補件送出
                    IList<TblAPPLY_NOTICE> andatalist = GetRowList(an);
                    // 只取回最後一次補件的次數
                    var newandaata = from a in andatalist
                                     orderby a.FREQUENCY descending
                                     select a;
                    // 取得補件次數 
                    iSRC_NO = newandaata.ToCount() == 0 ? 2 : (newandaata.FirstOrDefault().FREQUENCY.TOInt32() + 1);
                    var getan = 1;
                    if (!string.IsNullOrEmpty(model.MAILBODY))
                    {
                        getan = model.MAILBODY.splitHTML("<tr/>").ToCount();
                    }
                    Count = getan - 1;

                    // 更新補件欄位
                    TblAPPLY_NOTICE anwhere = new TblAPPLY_NOTICE();
                    anwhere.APP_ID = model.APP_ID;
                    TblAPPLY_NOTICE andata = new TblAPPLY_NOTICE();
                    andata.ISADDYN = "Y";
                    Update2(andata, anwhere, dict2);

                    // Update Apply
                    ApplyModel appwhere = new ApplyModel();
                    appwhere.APP_ID = model.APP_ID;
                    ApplyModel appdata = new ApplyModel();
                    // 帶入基本資料
                    appdata.InjectFrom(model);

                    var MOBILE = model.MOBILE.TONotNullString();
                    appdata.TEL = MOBILE.TONotNullString();
                    appdata.MOBILE = MOBILE;
                    appdata.ADDR_CODE = model.ADDR_CODE;
                    appdata.ADDR = model.ADDR;
                    appdata.APP_ID = model.APP_ID;
                    //appdata.SRV_ID = CaseNum;
                    //appdata.SRC_SRV_ID = CaseNum;
                    appdata.UNIT_CD = 8; //社會救助及社工司-UNIT
                    appdata.FLOW_CD = "3";//1:新案收件3:補件收件
                    appdata.UPD_TIME = DateTime.Now;
                    appdata.UPD_FUN_CD = s_FUN_CD1;
                    appdata.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    Update2(appdata, appwhere, dict2);

                    Apply_011010Model app_SN_where = new Apply_011010Model();
                    app_SN_where.APP_ID = model.APP_ID;
                    // Update 案件
                    Apply_011010Model app_SN_data = new Apply_011010Model();
                    app_SN_data.InjectFrom(model);

                    app_SN_data.APP_ID = model.APP_ID;
                    app_SN_data.UPD_TIME = DateTime.Now;
                    app_SN_data.UPD_FUN_CD = s_FUN_CD1;
                    app_SN_data.UPD_ACC = UserInfo.ACC_NO.TONotNullString();

                    //儲存異動前後
                    Update2(app_SN_data, app_SN_where, dict2);
                    //儲存
                    //Update(app_SN_data, app_SN_where);

                    #region 檔案上傳
                    if (!model.FILE_EXCEL.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 1;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_EXCEL, "1");
                        file.SRC_FILENAME = model.FILE_EXCEL_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }

                    if (!model.FILE_PDF.TONotNullString().Equals(""))
                    {
                        Apply_FileModel file = new Apply_FileModel();
                        file.APP_ID = model.APP_ID;
                        file.FILE_NO = 2;
                        file.FILENAME = dao.PutFile(s_SRV_ID, model.FILE_PDF, "2");
                        file.SRC_FILENAME = model.FILE_PDF_TEXT;
                        file.SRC_NO = iSRC_NO;
                        file.NOTICE_NO = iSRC_NO;
                        file.ADD_TIME = DateTime.Now;
                        file.ADD_FUN_CD = s_FUN_CD1;
                        file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.UPD_TIME = DateTime.Now;
                        file.UPD_FUN_CD = s_FUN_CD1;
                        file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                        file.DEL_MK = "N";
                        Insert(file);
                    }
                    #endregion

                    #region 推薦表(PDF檔)
                    var extcnt = 1;
                    foreach (var item in model.SRVLIST)
                    {
                        var FILE_3 = "";
                        if (!item.FILE_3.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = model.APP_ID;
                            file.FILE_NO = 3; //推薦表(PDF檔)
                            file.FILENAME = dao.PutFile("011003", item.FILE_3, "3");
                            FILE_3 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = item.FILE_3_TEXT;
                            file.SRC_NO = iSRC_NO;
                            file.NOTICE_NO = iSRC_NO;
                            file.BATCH_INDEX = extcnt;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                        extcnt++;
                    }
                    #endregion

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("UpdateApply011010 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return Count.TONotNullString();

        }
        #endregion

        #region Apply_040001 衛生福利部訴願案件

        public string ChkApply040001(Apply_040001FormModel form)
        {
            string Msg = "";
            if (string.IsNullOrEmpty(form.EMAIL))
            {
                Msg += "訴願人E-MAIL請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.MOBILE) && string.IsNullOrWhiteSpace(form.H_TEL))
            {
                Msg += "電話、行動電話請擇一填寫\n";
            }
            //if (string.IsNullOrWhiteSpace(form.ORG_NAME))
            //{
            //    Msg += "原行政處分機關請填寫\n";
            //}
            //if (string.IsNullOrWhiteSpace(form.ORG_MEMO))
            //{
            //    Msg += "訴願請求請填寫\n";
            //}
            //if (string.IsNullOrWhiteSpace(form.ORG_FACT))
            //{
            //    Msg += "事實與理由請填寫\n";
            //}
            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply040001(Apply_040001FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "040001";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 74;// 法規會
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.BIRTHDAY = HelperUtil.TransToDateTime(form.BIRTHDAY_STR);
                    where.CNT_TEL = form.H_TEL;
                    where.MOBILE = form.MOBILE;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    where.APP_TIME = DateTime.Now;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("040001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("040001");
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.FLOW_CD = "1"; //新案收件
                    where.PAY_POINT = "A"; //不需要繳費
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    //// Insert 案件
                    TblAPPLY_040001 apply = new TblAPPLY_040001();
                    apply.InjectFrom(form);
                    apply.APP_ID = APP_ID;
                    apply.EMAIL = form.EMAIL;
                    apply.CHR_BIRTH = HelperUtil.TransToDateTime(form.CHR_BIRTH_STR);
                    apply.CHR_MOBILE = form.CHR_MOBILE;
                    apply.CHR_ADDR_CODE = form.CHR_ZIPCODE;
                    apply.R_BIRTH = HelperUtil.TransToDateTime(form.R_BIRTH_STR);
                    apply.R_MOBILE = form.R_MOBILE;
                    apply.R_ADDR_CODE = form.R_ZIPCODE;
                    apply.ORG_NAME = form.ORG_NAME;
                    apply.ORG_DATE = HelperUtil.TransToDateTime(form.ORG_DATE);
                    apply.ORG_MEMO = form.ORG_MEMO;
                    apply.ORG_FACT = form.ORG_FACT;
                    base.Insert(apply);

                    //儲存上傳檔案
                    if (form.SRVLIST != null && form.SRVLIST.Count > 0)
                    {
                        var i = 1;
                        foreach (var item in form.SRVLIST)
                        {
                            var FILE_1 = "";
                            if (!item.FILE_1.TONotNullString().Equals(""))
                            {
                                Apply_FileModel file = new Apply_FileModel();
                                file.APP_ID = APP_ID;
                                file.FILE_NO = i;
                                file.SRC_NO = 1; //(第1次新增)
                                file.FILENAME = dao.PutFile("040001", item.FILE_1, i.ToString());
                                FILE_1 = file.FILENAME.Split('\\')[3].ToString();
                                file.SRC_FILENAME = item.FILE_1_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";
                                base.Insert(file);

                                i++;
                            }
                        }
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply040001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_040001AppDocModel GetFile_040001(string APP_ID)
        {
            Apply_040001AppDocModel result = new Apply_040001AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"select app.APP_ID,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_1_TEXT 
                            FROM APPLY app 
                            where 1=1 ";
            _sql += " and app.app_id = '" + APP_ID + "'";

            string _files = @"SELECT *
                                       FROM APPLY_FILE
                                       where 1 = 1  ";
            _files += " and app_id ='" + APP_ID + "'";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.Query<Apply_040001AppDocModel>(_sql).FirstOrDefault();
                result.FILE = conn.Query<Apply_040001FILEModel>(_files).ToList();
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        #endregion

        #region Apply_041001 全民健康保險爭議案件(權益案件及特約管理案件)線上申辦

        public string ChkApply041001(Apply_041001FormModel form)
        {
            string Msg = "";
            if (string.IsNullOrEmpty(form.EMAIL))
            {
                Msg += "申請人E-MAIL請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.MOBILE) && string.IsNullOrWhiteSpace(form.H_TEL))
            {
                Msg += "申請人電話、行動電話請擇一填寫\n";
            }
            if (form.KIND1 == "N" && form.KIND2 == "N" && form.KIND3 == "N")
            {
                Msg += "衛生福利部中央健康保險署核定文件請勾選\n";
            }
            if (string.IsNullOrWhiteSpace(form.KNOW_MEMO))
            {
                Msg += "請求事項請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.KNOW_FACT))
            {
                Msg += "事實及理由(請以條例方式，簡要敘明)請填寫\n";
            }
            if (string.IsNullOrEmpty(form.FILE_2_TEXT))
            {
                Msg += "衛生福利部中央健康保險署核定文件請上傳\n";
            }
            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply041001(Apply_041001FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "041001";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 75;//爭審會
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.BIRTHDAY = form.BIRTHDAY;
                    where.CNT_TEL = form.H_TEL;
                    where.MOBILE = form.MOBILE;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    where.APP_TIME = DateTime.Now;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("041001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("041001");
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.FLOW_CD = "1"; //新案收件
                    where.PAY_POINT = "A"; //不需要繳費
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    // Insert 案件
                    TblAPPLY_041001 apply = new TblAPPLY_041001();
                    apply.InjectFrom(form);
                    apply.APP_ID = APP_ID;
                    apply.EMAIL = form.EMAIL;
                    apply.R_MOBILE = form.R_MOBILE;
                    apply.R_ADDR_CODE = form.R_ZIPCODE;
                    apply.LIC_DATE = HelperUtil.TransToDateTime(form.LIC_DATE_STR);
                    apply.KIND1 = form.KIND1_CHK ? "Y" : "N";
                    apply.KIND2 = form.KIND2_CHK ? "Y" : "N";
                    apply.KIND3 = form.KIND3_CHK ? "Y" : "N";
                    apply.KNOW_DATE = HelperUtil.TransToDateTime(form.KNOW_DATE_STR);
                    apply.ADD_TIME = DateTime.Now;
                    apply.ADD_FUN_CD = "WEB-APPLY";
                    apply.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    apply.UPD_TIME = DateTime.Now;
                    apply.UPD_FUN_CD = "WEB-APPLY";
                    apply.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    base.Insert(apply);

                    //儲存上傳檔案
                    if (form.FILE_1 != null)
                    {
                        var FILE_1 = "";
                        if (!form.FILE_1.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 1;
                            file.SRC_NO = 1; //(第1次新增)
                            file.FILENAME = dao.PutFile("041001", form.FILE_1, "1");
                            FILE_1 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = form.FILE_1_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                    }
                    if (form.FILE_2 != null)
                    {
                        var FILE_2 = "";
                        if (!form.FILE_2.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 2;
                            file.SRC_NO = 1; //(第1次新增)
                            file.FILENAME = dao.PutFile("041001", form.FILE_2, "2");
                            FILE_2 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = form.FILE_2_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                    }
                    if (form.FILE_3 != null)
                    {
                        var FILE_3 = "";
                        if (!form.FILE_3.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 3;
                            file.SRC_NO = 1; //(第1次新增)
                            file.FILENAME = dao.PutFile("041001", form.FILE_3, "3");
                            FILE_3 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = form.FILE_3_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                    }
                    if (form.FILE_4 != null)
                    {
                        var FILE_4 = "";
                        if (!form.FILE_4.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 4;
                            file.SRC_NO = 1; //(第1次新增)
                            file.FILENAME = dao.PutFile("041001", form.FILE_4, "4");
                            FILE_4 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = form.FILE_4_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                    }
                    if (form.SRVLIST != null && form.SRVLIST.Count > 0)
                    {
                        var i = 5;
                        foreach (var item in form.SRVLIST)
                        {
                            var FILE_5 = "";
                            if (!item.FILE_5.TONotNullString().Equals(""))
                            {
                                Apply_FileModel file = new Apply_FileModel();
                                file.APP_ID = APP_ID;
                                file.FILE_NO = i;
                                file.SRC_NO = 1; //(第1次新增)
                                file.FILENAME = dao.PutFile("041001", item.FILE_5, i.ToString());
                                FILE_5 = file.FILENAME.Split('\\')[3].ToString();
                                file.SRC_FILENAME = item.FILE_5_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";
                                base.Insert(file);

                                i++;
                            }
                        }
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply041001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_041001AppDocModel GetFile_041001(string APP_ID)
        {
            Apply_041001AppDocModel result = new Apply_041001AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"select app.APP_ID
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_1_TEXT 
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_2_TEXT 
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_3_TEXT
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_4_TEXT
                            FROM APPLY app 
                            where 1=1 ";
            _sql += " and app.app_id = '" + APP_ID + "'";

            string _files = @"SELECT *
                                       FROM APPLY_FILE
                                       where 1 = 1  ";
            _files += " and app_id ='" + APP_ID + "'";
            _files += " and file_no >4 ";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.Query<Apply_041001AppDocModel>(_sql).FirstOrDefault();
                result.FILE = conn.Query<Apply_041001FILEModel>(_files).ToList();
                conn.Close();
                conn.Dispose();
            }

            return result;
        }
        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_041001AppDocModel GetFile_041001ForDoc(string APP_ID)
        {
            Apply_041001AppDocModel result = new Apply_041001AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"select app.APP_ID
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_1_TEXT 
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'2') FILE_2_TEXT
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'3') FILE_3_TEXT
                                ,dbo.FN_FILE_TEXT(app.APP_ID ,'4') FILE_4_TEXT
                            FROM APPLY app 
                            where 1=1 ";
            _sql += " and app.app_id = '" + APP_ID + "'";

            string _files = @"SELECT *
                                       FROM APPLY_FILE
                                       where 1 = 1  ";
            _files += " and app_id ='" + APP_ID + "'";
            //_files += " and file_no >2 ";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.Query<Apply_041001AppDocModel>(_sql).FirstOrDefault();
                result.FILE = conn.Query<Apply_041001FILEModel>(_files).ToList();
                conn.Close();
                conn.Dispose();
            }

            return result;
        }
        #endregion

        #region Apply_006001 國民年金爭議審議線上申辦書

        public string ChkApply006001(Apply_006001FormModel form)
        {
            string Msg = "";
            if (string.IsNullOrWhiteSpace(form.C_ADDR))
            {
                Msg += "申請人詳細地址 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.MOBILE) && string.IsNullOrWhiteSpace(form.H_TEL))
            {
                Msg += "申請人電話、行動電話請擇一填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.R_NAME))
            {
                Msg += "被保險人姓名 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.R_BIRTH_STR))
            {
                Msg += "被保險人出生年月日 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.R_IDN))
            {
                Msg += "被保險人身分證統一編號 請填寫\n";
            }
            //if (string.IsNullOrWhiteSpace(form.R_TEL) && string.IsNullOrWhiteSpace(form.R_MOBILE))
            //{
            //    Msg += "被保險人電話、行動電話請擇一填寫\n";
            //}
            if (string.IsNullOrWhiteSpace(form.R_ADDR))
            {
                Msg += "被保險人詳細地址 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.LIC_NUM) && string.IsNullOrWhiteSpace(form.PAY_NUM))
            {
                Msg += "不服勞保局核定文件請填寫\n";
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(form.LIC_NUM))
                {
                    if (string.IsNullOrEmpty(form.LIC_DATE_STR))
                    {
                        Msg += "核定文件文號日期 請填寫\n";
                    }
                    if (string.IsNullOrWhiteSpace(form.LIC_CD))
                    {
                        Msg += "核定文件字 請填寫\n";
                    }
                    //if (string.IsNullOrWhiteSpace(form.LIC_NUM))
                    //{
                    //    Msg += "核定文件號 請填寫\n";
                    //}
                }
                if (!string.IsNullOrWhiteSpace(form.PAY_NUM))
                {
                    if (string.IsNullOrWhiteSpace(form.PAY_YEAR))
                    {
                        Msg += "繳款單年度 請填寫\n";
                    }
                    if (string.IsNullOrWhiteSpace(form.PAY_MONTH))
                    {
                        Msg += "繳款單月份 請填寫\n";
                    }
                    //if (string.IsNullOrWhiteSpace(form.PAY_NUM))
                    //{
                    //    Msg += "繳款單文號 請填寫\n";
                    //}
                }
            }
            if (string.IsNullOrWhiteSpace(form.KNOW_DATE_STR))
            {
                Msg += "收受或知悉核定文件日期 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.KNOW_MEMO))
            {
                Msg += "請求事項 請填寫\n";
            }
            if (string.IsNullOrWhiteSpace(form.KNOW_FACT))
            {
                Msg += "事實及理由 請填寫\n";
            }
            return Msg;
        }

        /// <summary>
        /// 新增案件
        /// </summary>
        /// <returns></returns>
        public string AppendApply006001(Apply_006001FormModel form)
        {
            SessionModel sm = SessionModel.Get();
            ShareDAO dao = new ShareDAO();
            ClamMember UserInfo = sm.UserInfo.Member;
            var CaseNum = "006001";
            var APP_ID = GetApp_ID(CaseNum);
            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                SqlTransaction tran = conn.BeginTransaction();

                try
                {
                    this.Tran(conn, tran);
                    // Insert Apply
                    ApplyModel where = new ApplyModel();
                    // 帶入基本資料
                    where.InjectFrom(form);
                    where.APP_ID = APP_ID;
                    where.SRV_ID = CaseNum;
                    where.SRC_SRV_ID = CaseNum;
                    where.UNIT_CD = 61;// 國監會
                    where.ACC_NO = UserInfo.ACC_NO.TONotNullString();
                    where.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.BIRTHDAY = HelperUtil.TransTwToDateTime(form.BIRTHDAY_STR);
                    where.CNT_TEL = form.H_TEL;
                    where.MOBILE = form.MOBILE;
                    where.ADDR_CODE = form.C_ZIPCODE;
                    where.ADDR = form.C_ADDR;
                    where.APP_TIME = DateTime.Now;
                    where.APP_EXT_DATE = this.GetNTFD(CaseNum);
                    where.ADD_TIME = DateTime.Now;
                    where.ADD_FUN_CD = "WEB-APPLY";
                    where.UPD_TIME = DateTime.Now;
                    where.UPD_FUN_CD = "WEB-APPLY";
                    where.APP_DISP_MK = "Y"; //分文處理
                    where.PRO_ACC = GetServicePageMakerId("006001");
                    where.PRO_UNIT_CD = GetServiceFixUnitCd("006001");
                    where.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                    where.DEL_MK = "N";
                    where.FLOW_CD = "1"; //新案收件
                    where.PAY_POINT = "A"; //不需要繳費
                    where.LOGIN_TYPE = sm.UserInfo.LoginAuth;
                    base.Insert(where);

                    //// Insert 案件
                    TblAPPLY_006001 apply = new TblAPPLY_006001();
                    apply.InjectFrom(form);
                    apply.APP_ID = APP_ID;
                    apply.EMAIL = form.EMAIL;
                    apply.ISSAME = form.ISSAME;
                    apply.R_NAME = form.R_NAME;
                    if (form.ISSAME == "Y")
                    {
                        apply.R_BIRTH = HelperUtil.TransTwToDateTime(form.R_BIRTH_STR);
                    }
                    else
                    {
                        apply.R_BIRTH = HelperUtil.TransToDateTime(form.R_BIRTH_STR);
                    }
                    apply.R_IDN = form.R_IDN;
                    apply.R_ADDR_CODE = form.R_ZIPCODE;
                    apply.R_ADDR = form.R_ADDR;
                    apply.R_MOBILE = form.R_MOBILE;
                    apply.R_TEL = form.R_TEL;
                    if (form.KIND1_CHK)
                    {
                        apply.KINDTYPE = "1,";
                    }
                    if (form.KIND2_CHK)
                    {
                        apply.KINDTYPE += "2,";
                    }
                    apply.LIC_DATE = HelperUtil.TransToDateTime(form.LIC_DATE_STR);
                    apply.LIC_CD = form.LIC_CD;
                    apply.LIC_NUM = form.LIC_NUM;
                    apply.PAY_YEAR = form.PAY_YEAR;
                    apply.PAY_MONTH = form.PAY_MONTH;
                    apply.PAY_NUM = form.PAY_NUM;
                    apply.KNOW_DATE = HelperUtil.TransToDateTime(form.KNOW_DATE_STR);
                    apply.KNOW_MEMO = form.KNOW_MEMO;
                    apply.KNOW_FACT = form.KNOW_FACT;
                    base.Insert(apply);

                    //儲存上傳檔案
                    if (form.FILE_1 != null)
                    {
                        var FILE_1 = "";
                        if (!form.FILE_1.TONotNullString().Equals(""))
                        {
                            Apply_FileModel file = new Apply_FileModel();
                            file.APP_ID = APP_ID;
                            file.FILE_NO = 1;
                            file.SRC_NO = 1; //(第1次新增)
                            file.FILENAME = dao.PutFile("006001", form.FILE_1, "1");
                            FILE_1 = file.FILENAME.Split('\\')[3].ToString();
                            file.SRC_FILENAME = form.FILE_1_TEXT;
                            file.ADD_TIME = DateTime.Now;
                            file.ADD_FUN_CD = "WEB-APPLY";
                            file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.UPD_TIME = DateTime.Now;
                            file.UPD_FUN_CD = "WEB-APPLY";
                            file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                            file.DEL_MK = "N";
                            base.Insert(file);
                        }
                    }
                    //儲存上傳檔案
                    if (form.SRVLIST != null && form.SRVLIST.Count > 0)
                    {
                        var i = 2;
                        foreach (var item in form.SRVLIST)
                        {
                            var FILE_1 = "";
                            if (!item.FILE_2.TONotNullString().Equals(""))
                            {
                                Apply_FileModel file = new Apply_FileModel();
                                file.APP_ID = APP_ID;
                                file.FILE_NO = i;
                                file.SRC_NO = 1; //(第1次新增)
                                file.FILENAME = dao.PutFile("006001", item.FILE_2, i.ToString());
                                FILE_1 = file.FILENAME.Split('\\')[3].ToString();
                                file.SRC_FILENAME = item.FILE_2_TEXT;
                                file.ADD_TIME = DateTime.Now;
                                file.ADD_FUN_CD = "WEB-APPLY";
                                file.ADD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.UPD_TIME = DateTime.Now;
                                file.UPD_FUN_CD = "WEB-APPLY";
                                file.UPD_ACC = UserInfo.ACC_NO.TONotNullString();
                                file.DEL_MK = "N";
                                base.Insert(file);

                                i++;
                            }
                        }
                    }

                    tran.Commit();
                }
                catch (Exception ex)
                {
                    logger.Warn(ex.Message, ex);
                    tran.Rollback();

                    throw new Exception("AppendApply006001 failed:" + ex.Message, ex);
                }
                finally
                {
                    conn.Close();
                    conn.Dispose();
                }
            }
            return APP_ID;
        }

        /// <summary>
        /// 取檔案
        /// </summary>
        /// <param name="parm"></param>
        /// <returns></returns>
        public Apply_006001AppDocModel GetFile_006001(string APP_ID)
        {
            Apply_006001AppDocModel result = new Apply_006001AppDocModel();

            Dictionary<string, object> dictionary = new Dictionary<string, object>
                    {
                        { "@APP_ID",APP_ID }
                    };
            DynamicParameters parameters = new DynamicParameters(dictionary);

            string _sql = @"select app.APP_ID,dbo.FN_FILE_TEXT(app.APP_ID ,'1') FILE_1_TEXT 
                            FROM APPLY app 
                            where 1=1 ";
            _sql += " and app.app_id = '" + APP_ID + "'";

            string _files = @"SELECT *
                                       FROM APPLY_FILE
                                       where 1 = 1  ";
            _files += " and app_id ='" + APP_ID + "'";

            using (SqlConnection conn = DataUtils.GetConnection())
            {
                conn.Open();
                result = conn.Query<Apply_006001AppDocModel>(_sql).FirstOrDefault();
                result.FILE = conn.Query<Apply_006001FILEModel>(_files).ToList();
                conn.Close();
                conn.Dispose();
            }

            return result;
        }

        #endregion
    }
}
